commit 439d9a294c7df4d45b133e42edb3521901628daa
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Tue Jul 30 09:42:29 2013 +1200

    Make use of a change to netlib.tcp that clarifies error conditions for flush and close.
    
    Should fix #144.

diff --git a/libmproxy/proxy.py b/libmproxy/proxy.py
index ae5cd7d3..b1a5f084 100644
--- a/libmproxy/proxy.py
+++ b/libmproxy/proxy.py
@@ -85,12 +85,9 @@ class ServerConnection(tcp.TCPClient):
         if self.connection:
             try:
                 self.wfile.flush()
-            except IOError, tcp.NetLibDisconnect: # pragma: no cover
-                pass
-            try:
-                self.connection.close()
-            except IOError:
+            except tcp.NetLibDisconnect: # pragma: no cover
                 pass
+            self.connection.close()
 
 
 
diff --git a/test/test_proxy.py b/test/test_proxy.py
index 5828d077..c5640d8a 100644
--- a/test/test_proxy.py
+++ b/test/test_proxy.py
@@ -56,7 +56,7 @@ class TestServerConnection:
         sc = proxy.ServerConnection(proxy.ProxyConfig(), "http", self.d.IFACE, self.d.port, "host.com")
         sc.connect()
         sc.connection = mock.Mock()
-        sc.connection.close = mock.Mock(side_effect=IOError)
+        sc.connection.flush = mock.Mock(side_effect=tcp.NetLibDisconnect)
         sc.terminate()
 
 
