commit 1f4d031a60606fce2fd7118267a724c7f931d886
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Fri Feb 12 21:42:02 2016 +0100

    improve snapshot upload

diff --git a/.appveyor.yml b/.appveyor.yml
index 689ad5e5..64a5c882 100644
--- a/.appveyor.yml
+++ b/.appveyor.yml
@@ -1,11 +1,17 @@
 version: '{build}'
-shallow_clone: true
 build: off  # Not a C# project
 environment:
   matrix:
     - PYTHON: "C:\\Python27"
   PATH: "%APPDATA%\\Python\\Scripts;C:\\Python27;C:\\Python27\\Scripts;%PATH%"
-  PYINSTALLER_VERSION: "git+https://github.com/pyinstaller/pyinstaller.git"
+  SNAPSHOT_HOST:
+    secure: NeTo57s2rJhCd/mjKHetXVxCFd3uhr8txnjnAXD1tUI=
+  SNAPSHOT_PORT:
+    secure: TiJPtg60/edYTH8RnoBErg==
+  SNAPSHOT_USER:
+    secure: 6yBwmO5gv4vAwoFYII8qjQ==
+  SNAPSHOT_PASS:
+    secure: LPjrtFrWxYhOVGXzfPRV1GjtZE/wHoKq9m/PI6hSalfysUK5p2DxTG9uHlb4Q9qV
 install:
   - "pip install --user -U pip setuptools"
   - "pip install --user --src .. -r requirements.txt"
@@ -14,22 +20,14 @@ test_script:
   - "py.test -s --cov libmproxy --timeout 30"
 cache:
   - C:\Users\appveyor\AppData\Local\pip\cache
-after_test:
-  - |
+deploy_script:
+  ps: |
+    if($Env:APPVEYOR_REPO_BRANCH -match "master") {
     git clone https://github.com/mitmproxy/release.git ..\release
     pip install -e ..\release
-    python ..\release\rtool.py -p netlib -p mitmproxy bdist
-  - ps: Get-ChildItem ..\release\dist\*.zip | ForEach { Push-AppveyorArtifact $_.FullName -FileName $_.Name }
-deploy:
-- provider: FTP
-  host: 46.101.230.67:2222
-  protocol: sftp
-  username: travis
-  password:
-    secure: +Ousom/XDCLx9+bUjr1mRKepgIzLdqP+clMpoAiPXUysZCDGxODD/7ij4z8GJ3AF
-  folder: snapshots
-  on:
-    branch: master
+    python ..\release\rtool.py bdist
+    python ..\release\rtool.py upload-snapshot --bdist
+    }
 notifications:
 - provider: Slack
   incoming_webhook: https://hooks.slack.com/services/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
diff --git a/.travis.yml b/.travis.yml
index 8ea3ed32..3335a95a 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -70,14 +70,10 @@ after_success:
   - |
     if [[ $TRAVIS_OS_NAME == "osx" && $TRAVIS_BRANCH == "master" && $TRAVIS_PULL_REQUEST == "false" ]]
     then
-        brew install curl --with-libssh2
         git clone https://github.com/mitmproxy/release.git ../release
         pip install -e ../release
-        python ../release/rtool.py -p netlib -p mitmproxy bdist
-        for f in ../release/dist/*
-        do
-          $(brew --prefix curl)/bin/curl -u $SNAPSHOT_AUTH --hostpubmd5 $SNAPSHOT_PUBKEY --retry 5 -T $f sftp://$SNAPSHOT_HOST/
-        done
+        python ../release/rtool.py bdist
+        python ../release/rtool.py upload-snapshot --sdist --bdist --wheel
     fi
 
 notifications:
diff --git a/MANIFEST.in b/MANIFEST.in
index eb921d43..bd612fd2 100644
--- a/MANIFEST.in
+++ b/MANIFEST.in
@@ -1,8 +1,7 @@
 include mitmproxy mitmdump mitmweb
 include LICENSE CHANGELOG CONTRIBUTORS CONTRIBUTING.md README.rst
 graft examples
+graft libmproxy
 graft test
 prune test/tools
-prune docs
-graft libmproxy
-recursive-exclude * *.pyc *.pyo *.swo *.swp
+recursive-exclude * *.pyc *.pyo *.swo *.swp *.map
