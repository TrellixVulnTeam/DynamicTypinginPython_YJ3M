commit 764724748bf27466594be9755914ff25d52a66c5
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Mon Feb 27 15:59:29 2012 +1300

    Fix cert generation harder.

diff --git a/libmproxy/utils.py b/libmproxy/utils.py
index 474f7844..8e2097eb 100644
--- a/libmproxy/utils.py
+++ b/libmproxy/utils.py
@@ -296,7 +296,7 @@ def dummy_cert(certdir, ca, commonname, sans):
 
     ss = []
     for i, v in enumerate(sans):
-        ss.append("DNS.%s = %s"%(i, v))
+        ss.append("DNS.%s = %s"%(i+1, v))
     ss = "\n".join(ss)
 
     f = open(confpath, "w")
@@ -338,7 +338,7 @@ def dummy_cert(certdir, ca, commonname, sans):
             "-CA", ca,
             "-CAcreateserial",
             "-extfile", confpath,
-            "-extensions", "v3_cert",
+            "-extensions", "v3_cert_req",
         ]
         ret = subprocess.call(
             cmd,
diff --git a/test/test_utils.py b/test/test_utils.py
index 116abfe1..9ad0f006 100644
--- a/test/test_utils.py
+++ b/test/test_utils.py
@@ -147,12 +147,14 @@ class udummy_cert(libpry.AutoTree):
         cacert = os.path.join(d, "foo/cert.cnf")
         assert utils.dummy_ca(cacert)
         p = utils.dummy_cert(
-            os.path.join(d, "foo"),
+            #os.path.join(d, "foo"),
+            "/tmp",
             cacert,
             "foo.com",
             ["one.com", "two.com", "*.three.com"]
         )
         assert os.path.exists(p)
+
         # Short-circuit
         assert utils.dummy_cert(
             os.path.join(d, "foo"),
