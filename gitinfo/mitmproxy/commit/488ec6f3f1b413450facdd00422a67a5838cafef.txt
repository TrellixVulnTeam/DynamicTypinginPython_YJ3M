commit 488ec6f3f1b413450facdd00422a67a5838cafef
Author: Thomas Kriechbaumer <thomas@kriechbaumer.name>
Date:   Wed Dec 13 09:45:40 2017 +0100

    fix #2664

diff --git a/test/mitmproxy/net/test_tcp.py b/test/mitmproxy/net/test_tcp.py
index 3e27929d..e9084be4 100644
--- a/test/mitmproxy/net/test_tcp.py
+++ b/test/mitmproxy/net/test_tcp.py
@@ -1,4 +1,5 @@
 from io import BytesIO
+import re
 import queue
 import time
 import socket
@@ -95,7 +96,13 @@ class TestServerBind(tservers.ServerTestBase):
     class handler(tcp.BaseHandler):
 
         def handle(self):
-            self.wfile.write(str(self.connection.getpeername()).encode())
+            # We may get an ipv4-mapped ipv6 address here, e.g. ::ffff:127.0.0.1.
+            # Those still appear as "127.0.0.1" in the table, so we need to strip the prefix.
+            peername = self.connection.getpeername()
+            address = re.sub("^::ffff:(?=\d+.\d+.\d+.\d+$)", "", peername[0])
+            port = peername[1]
+
+            self.wfile.write(str((address, port)).encode())
             self.wfile.flush()
 
     def test_bind(self):
