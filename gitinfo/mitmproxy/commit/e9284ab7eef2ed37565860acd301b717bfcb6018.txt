commit e9284ab7eef2ed37565860acd301b717bfcb6018
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Fri Oct 14 01:22:30 2016 -0700

    add regression test for #1605

diff --git a/test/mitmproxy/console/test_master.py b/test/mitmproxy/console/test_master.py
index 8388a6bd..e57846ae 100644
--- a/test/mitmproxy/console/test_master.py
+++ b/test/mitmproxy/console/test_master.py
@@ -122,3 +122,16 @@ class TestMaster(mastertest.MasterTest):
         for i in (1, 2, 3):
             self.dummy_cycle(m, 1, b"")
             assert len(m.state.flows) == i
+
+    def test_intercept(self):
+        """regression test for https://github.com/mitmproxy/mitmproxy/issues/1605"""
+        m = self.mkmaster(intercept="~b bar")
+        f = tutils.tflow(req=netlib.tutils.treq(content=b"foo"))
+        m.request(f)
+        assert not m.state.flows[0].intercepted
+        f = tutils.tflow(req=netlib.tutils.treq(content=b"bar"))
+        m.request(f)
+        assert m.state.flows[1].intercepted
+        f = tutils.tflow(resp=netlib.tutils.tresp(content=b"bar"))
+        m.request(f)
+        assert m.state.flows[2].intercepted
