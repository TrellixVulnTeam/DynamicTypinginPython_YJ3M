commit 10a6d4fbe5a910b75813edc1bf8f22eec3b8bf3c
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Sun Aug 3 02:01:40 2014 +0200

    fix #317

diff --git a/libmproxy/proxy/server.py b/libmproxy/proxy/server.py
index 50f01bdc..c817b3b5 100644
--- a/libmproxy/proxy/server.py
+++ b/libmproxy/proxy/server.py
@@ -238,12 +238,12 @@ class ConnectionHandler:
         else:
             host = self.server_conn.address.host
             sans = []
-            if not self.config.no_upstream_cert and self.server_conn.ssl_established:
+            if self.server_conn.ssl_established and (not self.config.no_upstream_cert):
                 upstream_cert = self.server_conn.cert
                 if upstream_cert.cn:
                     host = upstream_cert.cn.decode("utf8").encode("idna")
                 sans = upstream_cert.altnames
-            elif self.config.no_upstream_cert and self.sni:
+            elif self.sni:
                 sans = [self.sni]
 
             ret = self.config.certstore.get_cert(host, sans)
