commit 3eea7f12162804dcf472740209ac340f7b6c4ba9
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Thu Nov 26 14:59:54 2015 +0100

    script reloader: minor fixes

diff --git a/libmproxy/script/reloader.py b/libmproxy/script/reloader.py
index b867238f..26691fa3 100644
--- a/libmproxy/script/reloader.py
+++ b/libmproxy/script/reloader.py
@@ -6,6 +6,8 @@ _observers = {}
 
 
 def watch(script, callback):
+    if script in _observers:
+        raise RuntimeError("Script already observed")
     script_dir = os.path.dirname(os.path.abspath(script.args[0]))
     event_handler = _ScriptModificationHandler(callback)
     observer = Observer()
@@ -18,6 +20,7 @@ def unwatch(script):
     observer = _observers.pop(script, None)
     if observer:
         observer.stop()
+        observer.join()
 
 
 class _ScriptModificationHandler(PatternMatchingEventHandler):
