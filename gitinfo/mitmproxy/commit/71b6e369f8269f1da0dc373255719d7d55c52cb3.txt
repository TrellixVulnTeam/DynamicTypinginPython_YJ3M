commit 71b6e369f8269f1da0dc373255719d7d55c52cb3
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Mon Jun 6 22:42:11 2016 -0700

    change content views: escape in raw mode, show utf8 in json

diff --git a/mitmproxy/contentviews.py b/mitmproxy/contentviews.py
index 28c57f06..efdf678f 100644
--- a/mitmproxy/contentviews.py
+++ b/mitmproxy/contentviews.py
@@ -62,11 +62,21 @@ KEY_MAX = 30
 
 
 def pretty_json(s):
+    # type: (bytes) -> bytes
     try:
         p = json.loads(s)
     except ValueError:
         return None
-    return json.dumps(p, sort_keys=True, indent=4)
+    pretty = json.dumps(p, sort_keys=True, indent=4, ensure_ascii=False)
+    if isinstance(pretty, six.text_type):
+        # json.dumps _may_ decide to return unicode, if the JSON object is not ascii.
+        # Nonetheless, this function is expected to return bytes. We first try to utf8-encode
+        # back to bytes, and if that fails, we deliver the escaped version as a last resort.
+        try:
+            return pretty.encode("utf8", "strict")
+        except UnicodeError:
+            return json.dumps(p, sort_keys=True, indent=4, ensure_ascii=True)
+    return pretty
 
 
 def format_dict(d):
@@ -153,7 +163,7 @@ class ViewRaw(View):
     content_types = []
 
     def __call__(self, data, **metadata):
-        return "Raw", format_text(data)
+        return "Raw", format_text(strutils.bytes_to_escaped_str(data))
 
 
 class ViewHex(View):
