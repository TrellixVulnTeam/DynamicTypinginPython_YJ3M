commit ca7ca8ec248d2a213622a9d2dca1a192f65365c2
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Sun Jul 17 11:06:29 2016 +1200

    The "handled" flag on responses should not persist across calls

diff --git a/mitmproxy/controller.py b/mitmproxy/controller.py
index 54d75e6b..070ec862 100644
--- a/mitmproxy/controller.py
+++ b/mitmproxy/controller.py
@@ -220,6 +220,12 @@ def handler(f):
 
         if handling and not message.reply.acked and not message.reply.taken:
             message.reply.ack()
+
+        # Reset the handled flag - it's common for us to feed the same object
+        # through handlers repeatedly, so we don't want this to persist across
+        # calls.
+        if message.reply.handled:
+            message.reply.handled = False
         return ret
     # Mark this function as a handler wrapper
     wrapper.__dict__["__handler"] = True
