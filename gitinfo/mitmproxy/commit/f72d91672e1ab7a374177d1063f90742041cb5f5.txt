commit f72d91672e1ab7a374177d1063f90742041cb5f5
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Wed Mar 7 21:22:33 2018 +1300

    release: build wheel

diff --git a/.travis.yml b/.travis.yml
index 23910601..66a4f61e 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -26,7 +26,7 @@ matrix:
       env: TOXENV=py35
       dist: precise
     - python: 3.6
-      env: TOXENV=py36 BDIST=1
+      env: TOXENV=py36 BDIST=1 WHEEL=1
     - python: 3.6
       env: TOXENV=individual_coverage
     - language: node_js
diff --git a/release/ci.py b/release/ci.py
index 18209dfd..a7ecfae5 100755
--- a/release/ci.py
+++ b/release/ci.py
@@ -148,6 +148,16 @@ def build():
 
     os.makedirs(DIST_DIR, exist_ok=True)
 
+    if "WHEEL" in os.environ:
+        print("Building wheel...")
+        subprocess.check_call(
+            [
+                "python",
+                "setup.py", "-q", "bdist_wheel",
+                "--dist-dir", "release/dist",
+            ]
+        )
+
     for bdist, tools in sorted(BDISTS.items()):
         with Archive(join(DIST_DIR, archive_name(bdist))) as archive:
             for tool in tools:
diff --git a/tox.ini b/tox.ini
index 0033b8e8..c9a575da 100644
--- a/tox.ini
+++ b/tox.ini
@@ -32,21 +32,8 @@ deps =
 commands =
   python test/individual_coverage.py
 
-[testenv:wheel]
-recreate = True
-deps =
-commands =
-  python setup.py -q bdist_wheel --dist-dir release/dist
-  pip install {posargs} release/dist/mitmproxy-{env:VERSION:}-py3-none-any.whl
-  # skip `mitmproxy --version` if SKIP_MITMPROXY is defined.
-  {env:SKIP_MITMPROXY:mitmproxy --version}
-  mitmdump --version
-  mitmweb --version
-  pathod --version
-  pathoc --version
-
 [testenv:cibuild]
-passenv = TRAVIS_TAG TRAVIS_BRANCH AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY APPVEYOR_REPO_TAG_NAME APPVEYOR_REPO_TAG APPVEYOR_REPO_BRANCH RTOOL_KEY
+passenv = TRAVIS_TAG TRAVIS_BRANCH AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY APPVEYOR_REPO_TAG_NAME APPVEYOR_REPO_TAG APPVEYOR_REPO_BRANCH RTOOL_KEY WHEEL
 deps =
   -rrequirements.txt
   pyinstaller==3.3.1
