commit 8f0ebb405d898623f02d22e99505ba944884f398
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Tue Jul 24 23:38:41 2012 +1200

    Hide "go" button if crafting is off. Use configured crafting anchor point.

diff --git a/libpathod/app.py b/libpathod/app.py
index 6478964c..79c0fc71 100644
--- a/libpathod/app.py
+++ b/libpathod/app.py
@@ -28,6 +28,8 @@ def api():
 
 def render(s, **kwargs):
     kwargs["noapi"] = app.config["pathod"].noapi
+    kwargs["nocraft"] = app.config["pathod"].nocraft
+    kwargs["craftanchor"] = app.config["pathod"].craftanchor
     return render_template(s, **kwargs)
 
 
@@ -87,13 +89,13 @@ def response_preview():
     except rparse.ParseException, v:
         args["syntaxerror"] = str(v)
         args["marked"] = v.marked()
-        return render("preview_response.html", **args)
+        return render("response_preview.html", **args)
 
     s = cStringIO.StringIO()
     r.preview_safe()
     r.serve(s, check=app.config["pathod"].check_size)
     args["output"] = utils.escape_unprintables(s.getvalue())
-    return render("preview_response.html", **args)
+    return render("response_preview.html", **args)
 
 
 @app.route('/request_preview')
@@ -110,10 +112,10 @@ def request_preview():
     except rparse.ParseException, v:
         args["syntaxerror"] = str(v)
         args["marked"] = v.marked()
-        return render("preview_request.html", **args)
+        return render("request_preview.html", **args)
 
     s = cStringIO.StringIO()
     r.preview_safe()
     r.serve(s, check=app.config["pathod"].check_size, host="example.com")
     args["output"] = utils.escape_unprintables(s.getvalue())
-    return render("preview_request.html", **args)
+    return render("request_preview.html", **args)
diff --git a/libpathod/rparse.py b/libpathod/rparse.py
index d60a78d3..96817304 100644
--- a/libpathod/rparse.py
+++ b/libpathod/rparse.py
@@ -434,7 +434,7 @@ class DisconnectAt:
     @classmethod
     def expr(klass):
         e = pp.Literal("d").suppress()
-        e = e + pp.MatchFirst(
+        e += e + pp.MatchFirst(
                     [
                         v_integer,
                         pp.Literal("r")
diff --git a/libpathod/templates/preview_request.html b/libpathod/templates/request_preview.html
similarity index 100%
rename from libpathod/templates/preview_request.html
rename to libpathod/templates/request_preview.html
diff --git a/libpathod/templates/preview_response.html b/libpathod/templates/response_preview.html
similarity index 100%
rename from libpathod/templates/preview_response.html
rename to libpathod/templates/response_preview.html
diff --git a/libpathod/templates/response_previewform.html b/libpathod/templates/response_previewform.html
index 74b25ce1..d98a72f7 100644
--- a/libpathod/templates/response_previewform.html
+++ b/libpathod/templates/response_previewform.html
@@ -1,12 +1,16 @@
 <form class="form-inline" method="GET" action="/response_preview">
     <input id="spec" name="spec" class="input-medium search-query" value="{{spec}}">
     <input type="submit" class="btn" value="preview">
-    <a href="#" id="submitspec" class="btn">go</a>
+    {% if not nocraft %}
+    <a href="#" id="submitspec" class="btn">go to</a>
+    {% endif %}
 </form>
 <script>
     $(function(){
+        {% if not nocraft %}
         $("#submitspec").click(function(){
-            document.location = "/p/" + $("#spec").val()
+            document.location = "{{craftanchor}}" + $("#spec").val()
         });
+        {% endif %}
     });
 </script>
