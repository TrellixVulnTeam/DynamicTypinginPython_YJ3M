commit b5416895f5157d0191c3967850be576450ec2d7d
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Sat Jul 23 11:38:45 2016 +1200

    script: convert test recorder to an addon class

diff --git a/test/mitmproxy/builtins/test_script.py b/test/mitmproxy/builtins/test_script.py
index 3f07b576..826d2a91 100644
--- a/test/mitmproxy/builtins/test_script.py
+++ b/test/mitmproxy/builtins/test_script.py
@@ -48,7 +48,7 @@ def test_load_script():
             "data/addonscripts/recorder.py"
         ), []
     )
-    assert ns.configure
+    assert ns.start
 
 
 class TestScript(mastertest.MasterTest):
diff --git a/test/mitmproxy/data/addonscripts/recorder.py b/test/mitmproxy/data/addonscripts/recorder.py
index b6ac8d89..890e6f4e 100644
--- a/test/mitmproxy/data/addonscripts/recorder.py
+++ b/test/mitmproxy/data/addonscripts/recorder.py
@@ -2,24 +2,24 @@ from mitmproxy import controller
 from mitmproxy import ctx
 import sys
 
-call_log = []
 
-if len(sys.argv) > 1:
-    name = sys.argv[1]
-else:
-    name = "solo"
+class CallLogger:
+    call_log = []
 
-# Keep a log of all possible event calls
-evts = list(controller.Events) + ["configure"]
-for i in evts:
-    def mkprox():
-        evt = i
+    def __init__(self, name = "solo"):
+        self.name = name
 
-        def prox(*args, **kwargs):
-            lg = (name, evt, args, kwargs)
-            if evt != "log":
-                ctx.log.info(str(lg))
-            call_log.append(lg)
-            ctx.log.debug("%s %s" % (name, evt))
-        return prox
-    globals()[i] = mkprox()
+    def __getattr__(self, attr):
+        if attr in controller.Events:
+            def prox(*args, **kwargs):
+                lg = (self.name, attr, args, kwargs)
+                if attr != "log":
+                    ctx.log.info(str(lg))
+                self.call_log.append(lg)
+                ctx.log.debug("%s %s" % (self.name, attr))
+            return prox
+        raise AttributeError
+
+
+def start():
+    return CallLogger(*sys.argv[1:])
