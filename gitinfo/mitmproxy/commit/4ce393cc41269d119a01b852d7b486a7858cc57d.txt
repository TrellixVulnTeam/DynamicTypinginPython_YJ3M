commit 4ce393cc41269d119a01b852d7b486a7858cc57d
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Sat Mar 12 15:14:25 2011 +1300

    Unit tests for cmdline.py

diff --git a/libmproxy/cmdline.py b/libmproxy/cmdline.py
index 789cfaec..58dbadad 100644
--- a/libmproxy/cmdline.py
+++ b/libmproxy/cmdline.py
@@ -7,7 +7,7 @@ def get_common_options(options):
     if options.stickycookie_all:
         stickycookie = ".*"
     elif options.stickycookie_filt:
-        stickycookie = stickycookie_filt
+        stickycookie = options.stickycookie_filt
     return dict(
         verbosity = options.verbose,
         wfile = options.wfile,
diff --git a/test/test_cmdline.py b/test/test_cmdline.py
new file mode 100644
index 00000000..799e0e24
--- /dev/null
+++ b/test/test_cmdline.py
@@ -0,0 +1,29 @@
+import optparse
+import libpry
+from libmproxy import cmdline
+
+
+class uAll(libpry.AutoTree):
+    def test_common(self):
+        parser = optparse.OptionParser()
+        cmdline.common_options(parser)
+        opts, args = parser.parse_args(args=[])
+
+        assert cmdline.get_common_options(opts)
+
+        opts.stickycookie_all = True
+        v = cmdline.get_common_options(opts)
+        assert v["stickycookie"] == ".*"
+
+        opts.stickycookie_all = False
+        opts.stickycookie_filt = "foo"
+        v = cmdline.get_common_options(opts)
+        assert v["stickycookie"] == "foo"
+
+
+
+
+tests = [
+    uAll()
+]
+
