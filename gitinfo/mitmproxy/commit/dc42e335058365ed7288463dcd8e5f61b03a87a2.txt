commit dc42e335058365ed7288463dcd8e5f61b03a87a2
Author: Thomas Kriechbaumer <thomas@kriechbaumer.name>
Date:   Wed Jul 22 13:04:14 2015 +0200

    fix bugs

diff --git a/libpathod/pathod.py b/libpathod/pathod.py
index 6f07ecc5..5c813cc5 100644
--- a/libpathod/pathod.py
+++ b/libpathod/pathod.py
@@ -85,7 +85,7 @@ class PathodHandler(tcp.BaseHandler):
         self.use_http2 = False
         self.http2_framedump = http2_framedump
 
-    def _handle_sni(self, connection):
+    def handle_sni(self, connection):
         self.sni = connection.get_servername()
 
     def http_serve_crafted(self, crafted, logctx):
@@ -132,8 +132,8 @@ class PathodHandler(tcp.BaseHandler):
             if isinstance(req, http.EmptyRequest):
                 return None, None
 
-            if isinstance(req, http.ConnectRequest):
-                return self.protocol.handle_http_connect([req.host, req.port, req.path], lg)
+            if req.method == 'CONNECT':
+                return self.protocol.handle_http_connect([req.host, req.port, req.httpversion], lg)
 
             method = req.method
             path = req.path
@@ -239,7 +239,7 @@ class PathodHandler(tcp.BaseHandler):
                 self.convert_to_ssl(
                     cert,
                     key,
-                    handle_sni=self._handle_sni,
+                    handle_sni=self.handle_sni,
                     request_client_cert=self.server.ssloptions.request_client_cert,
                     cipher_list=self.server.ssloptions.ciphers,
                     method=self.server.ssloptions.ssl_version,
diff --git a/libpathod/protocols/http.py b/libpathod/protocols/http.py
index 439e0ba9..82595126 100644
--- a/libpathod/protocols/http.py
+++ b/libpathod/protocols/http.py
@@ -56,7 +56,7 @@ class HTTPProtocol:
                 self.pathod_handler.convert_to_ssl(
                     cert,
                     key,
-                    handle_sni=self.pathod_handler._handle_sni,
+                    handle_sni=self.pathod_handler.handle_sni,
                     request_client_cert=self.pathod_handler.server.ssloptions.request_client_cert,
                     cipher_list=self.pathod_handler.server.ssloptions.ciphers,
                     method=self.pathod_handler.server.ssloptions.ssl_version,
