commit 141ade5ae10d7a6c1ae687f9c320fdee8df035fa
Author: peter-way <2475625231@qq.com>
Date:   Mon Apr 15 08:43:52 2019 +0800

    Use 'host_header' instead of 'host', when calculating 'HTTPRequest' hash in transparent mode.

diff --git a/mitmproxy/addons/serverplayback.py b/mitmproxy/addons/serverplayback.py
index 51ba60b4..29f2ef5d 100644
--- a/mitmproxy/addons/serverplayback.py
+++ b/mitmproxy/addons/serverplayback.py
@@ -128,7 +128,10 @@ class ServerPlayback:
                 key.append(str(r.raw_content))
 
         if not ctx.options.server_replay_ignore_host:
-            key.append(r.host)
+            if ctx.options.mode == "transparent":
+                key.append(r.host_header)
+            else:
+                key.append(r.host)
 
         filtered = []
         ignore_params = ctx.options.server_replay_ignore_params or []
