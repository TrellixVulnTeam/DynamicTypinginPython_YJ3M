commit 1df78f75c5ceb368ca9ba9d1b01e17af21cab892
Author: Marcelo Glezer <mg@tekii.com.ar>
Date:   Tue Feb 10 17:18:23 2015 -0300

    set sni to None when no server_conn is None

diff --git a/libmproxy/protocol/http.py b/libmproxy/protocol/http.py
index 2f858a7c..79a4bf74 100644
--- a/libmproxy/protocol/http.py
+++ b/libmproxy/protocol/http.py
@@ -1457,9 +1457,11 @@ class RequestReplayThread(threading.Thread):
                     server = ServerConnection(server_address)
                     server.connect()
                     if r.scheme == "https":
-                        server.establish_ssl(self.config.clientcerts, sni=self.flow.server_conn.sni)
+                        sni = None
+                        if self.flow.server_conn:
+                            sni = self.flow.server_conn.sni
+                        server.establish_ssl(self.config.clientcerts, sni=sni)
                     r.form_out = "relative"
-
                 server.send(r.assemble())
                 self.flow.server_conn = server
                 self.flow.response = HTTPResponse.from_stream(server.rfile, r.method,
