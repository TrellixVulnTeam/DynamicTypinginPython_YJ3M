commit d5532319c1fef4b10146f8643f9a02a7f948d446
Author: Aldo Cortesi <aldo@nullcube.com>
Date:   Sat Jun 4 16:29:54 2016 +1200

    Basic ConsoleMaster tests, based on mastertester

diff --git a/mitmproxy/console/master.py b/mitmproxy/console/master.py
index 63692ec0..5fd51f4b 100644
--- a/mitmproxy/console/master.py
+++ b/mitmproxy/console/master.py
@@ -206,7 +206,8 @@ class Options(object):
         "nopop",
         "palette",
         "palette_transparent",
-        "no_mouse"
+        "no_mouse",
+        "outfile",
     ]
 
     def __init__(self, **kwargs):
@@ -225,11 +226,13 @@ class ConsoleMaster(flow.FlowMaster):
         self.stream_path = None
         self.options = options
 
-        for i in options.replacements:
-            self.replacehooks.add(*i)
+        if options.replacements:
+            for i in options.replacements:
+                self.replacehooks.add(*i)
 
-        for i in options.setheaders:
-            self.setheaders.add(*i)
+        if options.setheaders:
+            for i in options.setheaders:
+                self.setheaders.add(*i)
 
         r = self.set_intercept(options.intercept)
         if r:
diff --git a/test/mitmproxy/console/test_console.py b/test/mitmproxy/console/test_master.py
similarity index 87%
rename from test/mitmproxy/console/test_console.py
rename to test/mitmproxy/console/test_master.py
index 52d2c49a..33261c28 100644
--- a/test/mitmproxy/console/test_console.py
+++ b/test/mitmproxy/console/test_master.py
@@ -4,7 +4,7 @@ import netlib.tutils
 from mitmproxy import console
 from mitmproxy.console import common
 
-from .. import tutils
+from .. import tutils, mastertest
 
 
 class TestConsoleState:
@@ -108,3 +108,15 @@ def test_format_keyvals():
 
 def test_options():
     assert console.master.Options(kill=True)
+
+
+class TestMaster(mastertest.MasterTest):
+    def mkmaster(self, filt, **options):
+        o = console.master.Options(filtstr=filt, **options)
+        return console.master.ConsoleMaster(None, o)
+
+    def test_basic(self):
+        m = self.mkmaster(None)
+        for i in (1, 2, 3):
+            self.dummy_cycle(m, 1, "")
+            assert len(m.state.flows) == i
