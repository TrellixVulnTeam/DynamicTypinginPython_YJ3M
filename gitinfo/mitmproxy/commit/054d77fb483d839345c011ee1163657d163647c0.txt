commit 054d77fb483d839345c011ee1163657d163647c0
Author: JustAnotherArchivist <JustAnotherArchivist@users.noreply.github.com>
Date:   Fri Jun 19 15:14:28 2020 +0000

    Verify that we're in the correct repository when extracting dev version information
    
    Fixes #3987

diff --git a/mitmproxy/version.py b/mitmproxy/version.py
index 82368296..f14eb697 100644
--- a/mitmproxy/version.py
+++ b/mitmproxy/version.py
@@ -20,6 +20,13 @@ def get_dev_version() -> str:
 
     here = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
     try:
+        # Check that we're in the mitmproxy repository: https://github.com/mitmproxy/mitmproxy/issues/3987
+        subprocess.run(
+            ['git', 'cat-file', '-t', 'cb0e3287090786fad566feb67ac07b8ef361b2c3'],
+            stdout=subprocess.DEVNULL,
+            stderr=subprocess.DEVNULL,
+            cwd=here,
+            check=True)
         git_describe = subprocess.check_output(
             ['git', 'describe', '--tags', '--long'],
             stderr=subprocess.STDOUT,
