commit 77868434e7dcaf42a7b48f3c81e04d1a7e993240
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Wed Sep 21 22:41:23 2016 -0700

    fix tests

diff --git a/mitmproxy/protocol/http.py b/mitmproxy/protocol/http.py
index c26c3d8f..894ae465 100644
--- a/mitmproxy/protocol/http.py
+++ b/mitmproxy/protocol/http.py
@@ -8,13 +8,14 @@ import time
 import traceback
 from mitmproxy import exceptions
 from mitmproxy import models
-from mitmproxy import protocol
+from mitmproxy.protocol import base
+from mitmproxy.protocol import websockets as pwebsockets
 from netlib import http
 from netlib import tcp
 from netlib import websockets
 
 
-class _HttpTransmissionLayer(protocol.base.Layer):
+class _HttpTransmissionLayer(base.Layer):
 
     def read_request(self):
         raise NotImplementedError()
@@ -79,7 +80,7 @@ class ConnectServerConnection(object):
         __nonzero__ = __bool__
 
 
-class UpstreamConnectLayer(protocol.base.Layer):
+class UpstreamConnectLayer(base.Layer):
 
     def __init__(self, ctx, connect_request):
         super(UpstreamConnectLayer, self).__init__(ctx)
@@ -119,7 +120,7 @@ class UpstreamConnectLayer(protocol.base.Layer):
         self.server_conn.address = address
 
 
-class HttpLayer(protocol.base.Layer):
+class HttpLayer(base.Layer):
 
     def __init__(self, ctx, mode):
         super(HttpLayer, self).__init__(ctx)
@@ -449,7 +450,7 @@ class HttpLayer(protocol.base.Layer):
             )
 
         if is_websockets and self.config.options.websockets:
-            layer = protocol.WebSocketsLayer(self, flow)
+            layer = pwebsockets.WebSocketsLayer(self, flow)
         else:
             layer = self.ctx.next_layer(self)
 
diff --git a/test/mitmproxy/protocol/test_websockets.py b/test/mitmproxy/protocol/test_websockets.py
index e7e2684f..e2361d89 100644
--- a/test/mitmproxy/protocol/test_websockets.py
+++ b/test/mitmproxy/protocol/test_websockets.py
@@ -65,7 +65,8 @@ class _WebSocketsTestBase(object):
         opts = options.Options(
             listen_port=0,
             no_upstream_cert=False,
-            ssl_insecure=True
+            ssl_insecure=True,
+            websockets=True,
         )
         opts.cadir = os.path.join(tempfile.gettempdir(), "mitmproxy")
         return opts
