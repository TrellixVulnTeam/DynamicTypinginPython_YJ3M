commit ed91e19e0be45720b942cfdad7e53076b5ac6543
Author: Eli Shvartsman <eli@shvar.com>
Date:   Tue Apr 29 12:41:59 2014 +0300

    Update server.py
    
    We should ask for upstream cert only if there is:
    1) no no_upstream_cert option specified
    2) ssl connection to server is established

diff --git a/libmproxy/proxy/server.py b/libmproxy/proxy/server.py
index 2252f674..c5b99fee 100644
--- a/libmproxy/proxy/server.py
+++ b/libmproxy/proxy/server.py
@@ -226,7 +226,7 @@ class ConnectionHandler:
         else:
             host = self.server_conn.address.host
             sans = []
-            if not self.config.no_upstream_cert or not self.server_conn.ssl_established:
+            if not self.config.no_upstream_cert and self.server_conn.ssl_established:
                 upstream_cert = self.server_conn.cert
                 if upstream_cert.cn:
                     host = upstream_cert.cn.decode("utf8").encode("idna")
