commit 010b921a93b2c7e3d6b26ca0db4538a56d7c8fb0
Author: Marcelo Glezer <mg@tekii.com.ar>
Date:   Thu Feb 12 13:41:58 2015 -0300

    added sni and ssl_established=true in ServerConnection. removed check for None value of server_conn in http.py

diff --git a/libmproxy/flow.py b/libmproxy/flow.py
index 3c5ac1fe..14497964 100644
--- a/libmproxy/flow.py
+++ b/libmproxy/flow.py
@@ -777,7 +777,9 @@ class FlowMaster(controller.Master):
                 address=dict(address=(host, port), use_ipv6=False),
                 state=[],
                 source_address=None, #source_address=dict(address=(host, port), use_ipv6=False),
-                cert=None
+                cert=None,
+                sni=host,
+                ssl_established=True
             ))
         f = http.HTTPFlow(c,s);
         headers = ODictCaseless()
diff --git a/libmproxy/protocol/http.py b/libmproxy/protocol/http.py
index 79a4bf74..046d0b42 100644
--- a/libmproxy/protocol/http.py
+++ b/libmproxy/protocol/http.py
@@ -1457,10 +1457,7 @@ class RequestReplayThread(threading.Thread):
                     server = ServerConnection(server_address)
                     server.connect()
                     if r.scheme == "https":
-                        sni = None
-                        if self.flow.server_conn:
-                            sni = self.flow.server_conn.sni
-                        server.establish_ssl(self.config.clientcerts, sni=sni)
+                        server.establish_ssl(self.config.clientcerts, sni=self.flow.server_conn.sni)
                     r.form_out = "relative"
                 server.send(r.assemble())
                 self.flow.server_conn = server
