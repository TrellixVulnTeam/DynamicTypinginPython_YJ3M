commit f5a6499b15df194c5d3e96fa22d010d534b42b1e
Author: Aldo Cortesi <aldo@corte.si>
Date:   Sat Jun 16 10:59:24 2018 +1200

    Simpler addon clear mechanism
    
    This should improve test robustness

diff --git a/mitmproxy/addonmanager.py b/mitmproxy/addonmanager.py
index 0b559293..645f3a93 100644
--- a/mitmproxy/addonmanager.py
+++ b/mitmproxy/addonmanager.py
@@ -123,9 +123,10 @@ class AddonManager:
         """
             Remove all addons.
         """
-        for i in self.chain:
-            self.remove(i)
+        for a in self.chain:
+            self.invoke_addon(a, "done")
         self.lookup = {}
+        self.chain = []
 
     def get(self, name):
         """
