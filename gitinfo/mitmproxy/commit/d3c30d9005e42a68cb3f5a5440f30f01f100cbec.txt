commit d3c30d9005e42a68cb3f5a5440f30f01f100cbec
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Wed May 11 16:34:18 2016 -0600

    fix tests, don't double-add error'd flows

diff --git a/mitmproxy/flow.py b/mitmproxy/flow.py
index 1d05d4bb..77ed8747 100644
--- a/mitmproxy/flow.py
+++ b/mitmproxy/flow.py
@@ -1116,8 +1116,6 @@ class FlowMaster(controller.ServerMaster):
         flow.reply()
 
     def handle_tcp_error(self, flow):
-        if self.stream:
-            self.stream.add(flow)
         self.add_event("Error in TCP connection to {}: {}".format(
             repr(flow.server_conn.address),
             flow.error
diff --git a/test/mitmproxy/tservers.py b/test/mitmproxy/tservers.py
index c9d68cfd..a1e9c713 100644
--- a/test/mitmproxy/tservers.py
+++ b/test/mitmproxy/tservers.py
@@ -161,7 +161,9 @@ class HTTPProxyTest(ProxyTestBase):
             q = "get:'/p/%s'" % spec
         else:
             q = "get:'%s/p/%s'" % (self.server.urlbase, spec)
-        return p.request(q)
+        resp = p.request(q)
+        p.close()
+        return resp
 
     def app(self, page):
         if self.ssl:
