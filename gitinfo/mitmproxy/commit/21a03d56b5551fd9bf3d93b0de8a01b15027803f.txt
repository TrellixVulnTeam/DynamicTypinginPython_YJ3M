commit 21a03d56b5551fd9bf3d93b0de8a01b15027803f
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Tue Nov 22 17:02:37 2016 +0100

    don't set an empty ALPN, refs #1772

diff --git a/mitmproxy/proxy/protocol/tls.py b/mitmproxy/proxy/protocol/tls.py
index 1cb9b3c2..82c9d096 100644
--- a/mitmproxy/proxy/protocol/tls.py
+++ b/mitmproxy/proxy/protocol/tls.py
@@ -503,7 +503,7 @@ class TlsLayer(base.Layer):
                 if alpn and b"h2" in alpn and not self.config.options.http2:
                     alpn.remove(b"h2")
 
-            if self.client_conn.ssl_established:
+            if self.client_conn.ssl_established and self.client_conn.connection.get_alpn_proto_negotiated():
                 # If the client has already negotiated an ALP, then force the
                 # server to use the same. This can only happen if the host gets
                 # changed after the initial connection was established. E.g.:
