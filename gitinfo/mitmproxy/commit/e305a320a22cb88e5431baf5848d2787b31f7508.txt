commit e305a320a22cb88e5431baf5848d2787b31f7508
Author: Thomas Kriechbaumer <thomas@kriechbaumer.name>
Date:   Fri May 11 11:58:01 2018 +0200

    fix tcp example

diff --git a/examples/complex/tcp_message.py b/examples/complex/tcp_message.py
index 634e2a9f..b1311d08 100644
--- a/examples/complex/tcp_message.py
+++ b/examples/complex/tcp_message.py
@@ -6,23 +6,22 @@ tcp_message Inline Script Hook API Demonstration
 * prints various details for each packet.
 
 example cmdline invocation:
-mitmdump -T --host --tcp ".*" -q -s examples/tcp_message.py
+mitmdump --rawtcp --tcp-host ".*" -s examples/complex/tcp_message.py
 """
 from mitmproxy.utils import strutils
 from mitmproxy import ctx
+from mitmproxy import tcp
 
 
-def tcp_message(tcp_msg):
-    modified_msg = tcp_msg.message.replace("foo", "bar")
-
-    is_modified = False if modified_msg == tcp_msg.message else True
-    tcp_msg.message = modified_msg
+def tcp_message(flow: tcp.TCPFlow):
+    message = flow.messages[-1]
+    old_content = message.content
+    message.content = old_content.replace(b"foo", b"bar")
 
     ctx.log.info(
-        "[tcp_message{}] from {} {} to {} {}:\r\n{}".format(
-            " (modified)" if is_modified else "",
-            "client" if tcp_msg.sender == tcp_msg.client_conn else "server",
-            tcp_msg.sender.address,
-            "server" if tcp_msg.receiver == tcp_msg.server_conn else "client",
-            tcp_msg.receiver.address, strutils.bytes_to_escaped_str(tcp_msg.message))
+        "[tcp_message{}] from {} to {}:\n{}".format(
+            " (modified)" if message.content != old_content else "",
+            "client" if message.from_client else "server",
+            "server" if message.from_client else "client",
+            strutils.bytes_to_escaped_str(message.content))
     )
