commit c7425f42db5f2bf300afc01d29e5a6fb2b2dfb2b
Author: Maximilian Hils <git@maximilianhils.com>
Date:   Fri Jul 18 23:04:24 2014 +0200

    if no_upstream_cert is set, include SNI value als SubjectAltName, fix #291

diff --git a/libmproxy/proxy/server.py b/libmproxy/proxy/server.py
index 741e5f93..72228f16 100644
--- a/libmproxy/proxy/server.py
+++ b/libmproxy/proxy/server.py
@@ -237,6 +237,8 @@ class ConnectionHandler:
                 if upstream_cert.cn:
                     host = upstream_cert.cn.decode("utf8").encode("idna")
                 sans = upstream_cert.altnames
+            elif self.config.no_upstream_cert and self.sni:
+                sans = [self.sni]
 
             ret = self.config.certstore.get_cert(host, sans)
             if not ret:
