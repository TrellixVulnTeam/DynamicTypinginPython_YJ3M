commit cc6aa1f54201aa0634da8a4fa4fafca36609a9c3
Author: Thomas Kriechbaumer <thomas@kriechbaumer.name>
Date:   Tue Nov 29 23:47:19 2016 +0100

    websocket: update close handshake tests

diff --git a/test/mitmproxy/protocol/test_websocket.py b/test/mitmproxy/protocol/test_websocket.py
index e1c3e49a..e42250e0 100644
--- a/test/mitmproxy/protocol/test_websocket.py
+++ b/test/mitmproxy/protocol/test_websocket.py
@@ -276,6 +276,7 @@ class TestClose(_WebSocketTest):
     def handle_websockets(cls, rfile, wfile):
         frame = websockets.Frame.from_file(rfile)
         wfile.write(bytes(frame))
+        wfile.write(bytes(websockets.Frame(fin=1, opcode=websockets.OPCODE.CLOSE)))
         wfile.flush()
 
         with pytest.raises(exceptions.TcpDisconnect):
@@ -287,6 +288,7 @@ class TestClose(_WebSocketTest):
         client.wfile.write(bytes(websockets.Frame(fin=1, opcode=websockets.OPCODE.CLOSE)))
         client.wfile.flush()
 
+        websockets.Frame.from_file(client.rfile)
         with pytest.raises(exceptions.TcpDisconnect):
             websockets.Frame.from_file(client.rfile)
 
@@ -296,6 +298,7 @@ class TestClose(_WebSocketTest):
         client.wfile.write(bytes(websockets.Frame(fin=1, opcode=websockets.OPCODE.CLOSE, payload=b'\00\42')))
         client.wfile.flush()
 
+        websockets.Frame.from_file(client.rfile)
         with pytest.raises(exceptions.TcpDisconnect):
             websockets.Frame.from_file(client.rfile)
 
@@ -305,6 +308,7 @@ class TestClose(_WebSocketTest):
         client.wfile.write(bytes(websockets.Frame(fin=1, opcode=websockets.OPCODE.CLOSE, payload=b'\00\42foobar')))
         client.wfile.flush()
 
+        websockets.Frame.from_file(client.rfile)
         with pytest.raises(exceptions.TcpDisconnect):
             websockets.Frame.from_file(client.rfile)
 
