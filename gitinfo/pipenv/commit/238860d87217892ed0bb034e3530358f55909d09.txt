commit 238860d87217892ed0bb034e3530358f55909d09
Author: Dan Ryan <dan@danryan.co>
Date:   Mon Apr 9 14:33:31 2018 -0400

    Fixes #1002, #1939
    
    Signed-off-by: Dan Ryan <dan@danryan.co>

diff --git a/HISTORY.txt b/HISTORY.txt
index 1ef0cdac..082775b8 100644
--- a/HISTORY.txt
+++ b/HISTORY.txt
@@ -3,7 +3,8 @@
  - Ensure lock hash does not change based on injected env vars.
  - Fix bug in detecting .venv at project root when in subdirectories.
  - Parse quoting in [scripts] section correctly + clearer run errors.
- - Fix bug resolving & locking markers correctly 
+ - Fix bug resolving & locking markers correctly
+ - Bugfix for allow_global with new resolver fixes.
 11.9.0:
  - Vastly improve markers capabilities.
  - Support for environment variables in Pipfiles.
diff --git a/pipenv/core.py b/pipenv/core.py
index 5fa05917..52132607 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -1065,6 +1065,7 @@ def do_lock(
         project=project,
         clear=clear,
         pre=pre,
+        allow_global=system,
     )
     # Add develop dependencies to lockfile.
     for dep in results:
@@ -1124,6 +1125,7 @@ def do_lock(
         project=project,
         clear=False,
         pre=pre,
+        allow_global=system,
     )
     # Add default dependencies to lockfile.
     for dep in results:
diff --git a/pipenv/resolver.py b/pipenv/resolver.py
index 300acf20..c04a6b3c 100644
--- a/pipenv/resolver.py
+++ b/pipenv/resolver.py
@@ -24,6 +24,7 @@ def main():
     do_pre = '--pre' in ' '.join(sys.argv)
     do_clear = '--clear' in ' '.join(sys.argv)
     is_debug = '--debug' in ' '.join(sys.argv)
+    system = '--system' in ' '.join(sys.argv)
     new_sys_argv = []
     for v in sys.argv:
         if v.startswith('--'):
@@ -51,7 +52,7 @@ def main():
                 del packages[i]
     project = pipenv.core.project
 
-    def resolve(packages, pre, sources, verbose, clear):
+    def resolve(packages, pre, sources, verbose, clear, system):
         import pipenv.utils
         return pipenv.utils.resolve_deps(
             packages,
@@ -61,6 +62,7 @@ def main():
             sources=sources,
             clear=clear,
             verbose=verbose,
+            allow_global=system,
         )
 
     results = resolve(
@@ -69,6 +71,7 @@ def main():
         sources=project.sources,
         verbose=is_verbose,
         clear=do_clear,
+        system=system,
     )
     print('RESULTS:')
     if results:
diff --git a/pipenv/utils.py b/pipenv/utils.py
index 80db89d4..58bbbe27 100644
--- a/pipenv/utils.py
+++ b/pipenv/utils.py
@@ -372,18 +372,19 @@ def actually_resolve_reps(
 
 
 def venv_resolve_deps(
-    deps, which, project, pre=False, verbose=False, clear=False
+    deps, which, project, pre=False, verbose=False, clear=False, allow_global=False
 ):
     from . import resolver
     import json
 
     resolver = escape_grouped_arguments(resolver.__file__.rstrip('co'))
-    cmd = '{0} {1} {2} {3} {4}'.format(
+    cmd = '{0} {1} {2} {3} {4} {5}'.format(
         escape_grouped_arguments(which('python')),
         resolver,
         '--pre' if pre else '',
         '--verbose' if verbose else '',
         '--clear' if clear else '',
+        '--system' if allow_global else '',
     )
     os.environ['PIPENV_PACKAGES'] = '\n'.join(deps)
     c = delegator.run(cmd, block=True)
