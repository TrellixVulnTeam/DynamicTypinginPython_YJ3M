commit 1384a25a38d54ce3041fda297e295d5d07fd932f
Author: frostming <frostming@tencent.com>
Date:   Tue May 14 09:54:18 2019 +0800

    make check unused work

diff --git a/pipenv/core.py b/pipenv/core.py
index 76ce7e8b..9e190343 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -242,7 +242,7 @@ def import_from_code(path="."):
 
     rs = []
     try:
-        for r in pipreqs.get_all_imports(path):
+        for r in pipreqs.get_all_imports(path, encoding="utf-8"):
             if r not in BAD_PACKAGES:
                 rs.append(r)
         pkg_names = pipreqs.get_pkg_names(rs)
@@ -2534,8 +2534,8 @@ def do_check(
     if not args:
         args = []
     if unused:
-        deps_required = [k for k in project.packages.keys()]
-        deps_needed = import_from_code(unused)
+        deps_required = [k.lower() for k in project.packages.keys()]
+        deps_needed = [k.lower() for k in import_from_code(unused)]
         for dep in deps_needed:
             try:
                 deps_required.remove(dep)
diff --git a/tests/integration/test_cli.py b/tests/integration/test_cli.py
index a38883e0..ae1b13dd 100644
--- a/tests/integration/test_cli.py
+++ b/tests/integration/test_cli.py
@@ -47,7 +47,7 @@ def test_pipenv_site_packages(PipenvInstance):
         c = p.pipenv('--python python --site-packages')
         assert c.return_code == 0
         assert 'Making site-packages available' in c.err
-        
+
         # no-global-site-packages.txt under stdlib dir should not exist.
         c = p.pipenv('run python -c "import sysconfig; print(sysconfig.get_path(\'stdlib\'))"')
         assert c.return_code == 0
@@ -215,20 +215,21 @@ def test_install_parse_error(PipenvInstance, pypi):
 @pytest.mark.code
 @pytest.mark.check
 @pytest.mark.unused
-@pytest.mark.skip(reason="non-deterministic")
 def test_check_unused(PipenvInstance, pypi):
     with PipenvInstance(chdir=True, pypi=pypi) as p:
         with open('__init__.py', 'w') as f:
             contents = """
 import tablib
 import records
+import flask
             """.strip()
             f.write(contents)
         p.pipenv('install requests')
         p.pipenv('install tablib')
-        p.pipenv('install records')
+        p.pipenv('install flask')
 
-        assert all(pkg in p.pipfile['packages'] for pkg in ['requests', 'tablib', 'records'])
+        assert all(pkg in p.pipfile['packages'] for pkg in ['requests', 'tablib', 'flask'])
 
         c = p.pipenv('check --unused .')
         assert 'tablib' not in c.out
+        assert 'flask' not in c.out
