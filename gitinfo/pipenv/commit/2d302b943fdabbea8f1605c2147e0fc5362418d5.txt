commit 2d302b943fdabbea8f1605c2147e0fc5362418d5
Author: Tzu-ping Chung <uranusjr@gmail.com>
Date:   Fri Jun 15 08:34:14 2018 +0800

    Clean up some dict retrieval code
    
    I *think* the previous code could get an exception in certain edge cases?
    I don't know, but this looks more straightforward and safer.

diff --git a/pipenv/core.py b/pipenv/core.py
index cdc1ff75..784d8f01 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -1115,10 +1115,20 @@ def do_lock(
             normalized = pep423_name(dep['name'])
             if not hasattr(dep, 'keys') or not hasattr(dep['name'], 'keys'):
                 continue
-            is_top_level = dep['name'] in vcs_lockfile or normalized in vcs_lockfile
-            lockfile_key = next(k for k in [dep['name'], normalized] if k in vcs_lockfile)
-            lockfile_entry = vcs_lockfile[lockfile_key] if is_top_level else None
-            dep_lockfile = clean_resolved_dep(dep, is_top_level=is_top_level, pipfile_entry=lockfile_entry)
+            is_top_level = (
+                dep['name'] in vcs_lockfile or
+                normalized in vcs_lockfile
+            )
+            if is_top_level:
+                try:
+                    lockfile_entry = vcs_lockfile[dep['name']]
+                except KeyError:
+                    lockfile_entry = vcs_lockfile[normalized]
+            else:
+                lockfile_entry = None
+            dep_lockfile = clean_resolved_dep(
+                dep, is_top_level=is_top_level, pipfile_entry=lockfile_entry,
+            )
             vcs_lockfile.update(dep_lockfile)
         lockfile[settings['lockfile_key']].update(vcs_lockfile)
 
