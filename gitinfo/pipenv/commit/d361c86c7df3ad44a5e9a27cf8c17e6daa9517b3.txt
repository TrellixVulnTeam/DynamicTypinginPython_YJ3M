commit d361c86c7df3ad44a5e9a27cf8c17e6daa9517b3
Author: Dan Ryan <dan@danryan.co>
Date:   Tue Mar 12 22:18:35 2019 -0400

    Update azure pipeline scripts
    
    Signed-off-by: Dan Ryan <dan@danryan.co>
    
    Update azure builds
    
    Signed-off-by: Dan Ryan <dan@danryan.co>
    
    Update azure pipeline windows code
    
    Signed-off-by: Dan Ryan <dan@danryan.co>
    
    Update python executable search for windows
    
    Signed-off-by: Dan Ryan <dan@danryan.co>
    
    Fix variable reference
    
    Signed-off-by: Dan Ryan <dan@danryan.co>
    
    Set virtual env variable on windows
    
    Signed-off-by: Dan Ryan <dan@danryan.co>
    
    globally install pipenv on windows
    
    Signed-off-by: Dan Ryan <dan@danryan.co>

diff --git a/.azure-pipelines/jobs/run-tests-windows.yml b/.azure-pipelines/jobs/run-tests-windows.yml
index 6b6f86fa..161247e3 100644
--- a/.azure-pipelines/jobs/run-tests-windows.yml
+++ b/.azure-pipelines/jobs/run-tests-windows.yml
@@ -4,6 +4,10 @@ steps:
   inputs:
     versionSpec: '$(python.version)'
     architecture: '$(python.architecture)'
+    addToPath: true
+
+- script: |
+    echo '##vso[task.setvariable variable=PIPENV_DEFAULT_PYTHON_VERSION]$(python.version)'
 
 - template: ../steps/install-dependencies.yml
 
diff --git a/.azure-pipelines/jobs/run-tests.yml b/.azure-pipelines/jobs/run-tests.yml
index 2602cba6..c83e62a0 100644
--- a/.azure-pipelines/jobs/run-tests.yml
+++ b/.azure-pipelines/jobs/run-tests.yml
@@ -4,23 +4,14 @@ steps:
   inputs:
     versionSpec: '$(python.version)'
     architecture: '$(python.architecture)'
+    addToPath: true
+
+- script: |
+      echo '##vso[task.setvariable variable=PIPENV_DEFAULT_PYTHON_VERSION]$(python.version)'
 
 - template: ../steps/install-dependencies.yml
 
-- bash: |
-    mkdir -p "$AGENT_HOMEDIRECTORY/.virtualenvs"
-    mkdir -p "$WORKON_HOME"
-    pip install certifi
-    export GIT_SSL_CAINFO="$(python -m certifi)"
-    export LANG="C.UTF-8"
-    export PIP_PROCESS_DEPENDENCY_LINKS="1"
-    echo "Path $PATH"
-    echo "Installing Pipenv…"
-    pip install -e "$(pwd)[test]" --upgrade
-    pipenv install --deploy --dev
-    pipenv run pip install -e "$(pwd)[test]" --upgrade
-    echo pipenv --venv && echo pipenv --py && echo pipenv run python --version
-  displayName: Make Virtualenv
+- template: ../steps/create-virtualenv-linux.yml
 
 - script: |
     # Fix Git SSL errors
diff --git a/.azure-pipelines/steps/create-virtualenv-linux.yml b/.azure-pipelines/steps/create-virtualenv-linux.yml
new file mode 100644
index 00000000..e5389376
--- /dev/null
+++ b/.azure-pipelines/steps/create-virtualenv-linux.yml
@@ -0,0 +1,14 @@
+steps:
+- bash: |
+    mkdir -p "$AGENT_HOMEDIRECTORY/.virtualenvs"
+    mkdir -p "$WORKON_HOME"
+    pip install certifi
+    export GIT_SSL_CAINFO="$(python -m certifi)"
+    export LANG="C.UTF-8"
+    export PIP_PROCESS_DEPENDENCY_LINKS="1"
+    echo "Path $PATH"
+    echo "Installing Pipenv…"
+    pipenv install --deploy --dev
+    pipenv run pip install -e "$(pwd)[test]" --upgrade
+    echo pipenv --venv && echo pipenv --py && echo pipenv run python --version
+  displayName: Make Virtualenv
diff --git a/.azure-pipelines/steps/create-virtualenv.yml b/.azure-pipelines/steps/create-virtualenv.yml
index 60ade40b..14f0a0e8 100644
--- a/.azure-pipelines/steps/create-virtualenv.yml
+++ b/.azure-pipelines/steps/create-virtualenv.yml
@@ -1,6 +1,14 @@
 steps:
+- powershell: |
+    Write-Host "##vso[task.setvariable variable=PY_EXE]"(py -"$PIPENV_DEFAULT_PYTHON_VERSION" -c 'import sys; print(sys.executable)')
+
 - script: |
-    virtualenv D:\.venv
-    D:\.venv\Scripts\pip.exe install -e .[test] && D:\.venv\Scripts\pipenv install --dev && D:\.venv\Scripts\pipenv run pip install -e .[test]
+    echo "Python exe: "$(PY_EXE)
+    virtualenv --python=$(PY_EXE) D:\.venv
+    echo "##vso[task.setvariable variable=VIRTUAL_ENV]"$(PY_EXE)
+    python -m pip install -e .[test] --upgrade
+    D:\.venv\Scripts\pip.exe install -e .[test] --upgrade
+    D:\.venv\Scripts\pipenv install --dev
+    D:\.venv\Scripts\pipenv run pip install -e .[test]
     echo D:\.venv\Scripts\pipenv --venv && echo D:\.venv\Scripts\pipenv --py && echo D:\.venv\Scripts\pipenv run python --version
   displayName: Make Virtualenv
diff --git a/.azure-pipelines/steps/install-dependencies.yml b/.azure-pipelines/steps/install-dependencies.yml
index 16b3d6b8..fd0da841 100644
--- a/.azure-pipelines/steps/install-dependencies.yml
+++ b/.azure-pipelines/steps/install-dependencies.yml
@@ -1,3 +1,3 @@
 steps:
-- script: 'python -m pip install --upgrade pip && python -m pip install -e .[test]'
+- script: 'python -m pip install --upgrade pip setuptools wheel && python -m pip install -e .[test] --upgrade'
   displayName: Upgrade Pip & Install Pipenv
