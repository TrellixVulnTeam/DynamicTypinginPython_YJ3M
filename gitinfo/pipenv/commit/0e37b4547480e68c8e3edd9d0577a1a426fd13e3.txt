commit 0e37b4547480e68c8e3edd9d0577a1a426fd13e3
Author: Dan Ryan <dan.ryan@xyleminc.com>
Date:   Sat Jun 16 03:37:14 2018 -0400

    Make `PIPENV_VIRTUALENV` global
    
    - Fixes #2273
    - Hopefully for real this time
    
    Signed-off-by: Dan Ryan <dan.ryan@xyleminc.com>

diff --git a/pipenv/core.py b/pipenv/core.py
index 3758dfb4..67a61438 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -1321,7 +1321,8 @@ def do_init(
     if not project.lockfile_exists and not skip_lock:
         # Unless we're in a virtualenv not managed by pipenv, abort if we're
         # using the system's python.
-        if (system or allow_global) and not PIPENV_VIRTUALENV:
+        global PIPENV_VIRTUALENV
+        if (system or allow_global) and not (PIPENV_VIRTUALENV):
             click.echo(
                 '{0}: --system is intended to be used for Pipfile installation, '
                 'not installation of specific packages. Aborting.'.format(
@@ -1793,7 +1794,8 @@ def do_install(
         keep_outdated = project.settings.get('keep_outdated')
     remote = requirements and is_valid_url(requirements)
     # Warn and exit if --system is used without a pipfile.
-    if system and package_name and not PIPENV_VIRTUALENV:
+    global PIPENV_VIRTUALENV
+    if (system or allow_global) and not (PIPENV_VIRTUALENV):
         click.echo(
             '{0}: --system is intended to be used for Pipfile installation, '
             'not installation of specific packages. Aborting.'.format(
