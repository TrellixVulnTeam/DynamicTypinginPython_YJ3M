commit aa70ddb24450235262b3554e95313a963c8f9031
Author: Dan Ryan <dan@danryan.co>
Date:   Mon May 27 19:40:37 2019 -0400

    fix queue implementation
    
    Signed-off-by: Dan Ryan <dan@danryan.co>

diff --git a/pipenv/core.py b/pipenv/core.py
index 5f6af131..5e7673e8 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -751,9 +751,11 @@ def batch_install(deps_list, procs, failed_deps_queue,
                 use_pep517=not failed,
             )
             c.dep = dep
+            if dep.is_vcs or dep.editable:
+                c.block()
 
             procs.put(c)
-            if procs.full():
+            if procs.full() or procs.qsize() == len(deps_list):
                 _cleanup_procs(procs, failed_deps_queue, retry=retry)
 
 
@@ -2500,6 +2502,8 @@ def do_run(command, args, three=None, python=False, pypi_mirror=None):
     previous_pipenv_active_value = os.environ.get("PIPENV_ACTIVE")
     os.environ["PIPENV_ACTIVE"] = vistir.misc.fs_str("1")
 
+    os.environ.pop("PIP_SHIMS_BASE_MODULE", None)
+
     try:
         script = project.build_script(command, args)
         cmd_string = ' '.join([script.command] + script.args)
