commit 520e9be5b0a8d621cf4a08e58675b98c0363ca80
Author: Dan Ryan <dan.ryan@canonical.com>
Date:   Thu Apr 9 18:58:40 2020 -0400

    adjust virtualenv installation order
    
    - Fix azure pipelines script
    
    Signed-off-by: Dan Ryan <dan.ryan@canonical.com>

diff --git a/.azure-pipelines/steps/run-tests-windows.yml b/.azure-pipelines/steps/run-tests-windows.yml
index 275beeeb..34c4f772 100644
--- a/.azure-pipelines/steps/run-tests-windows.yml
+++ b/.azure-pipelines/steps/run-tests-windows.yml
@@ -43,7 +43,7 @@ steps:
     parameters:
       python_version: ${{ parameters.python_version }}
 
-  - shell: |
+  - script: |
       git submodule sync
       git submodule update --init --recursive
       pipenv run pytest -ra -n 4 --junit-xml=junit/test-results.xml tests/
diff --git a/.github/workflows/ci.yaml b/.github/workflows/ci.yaml
index 8070b0fc..b9f641a8 100644
--- a/.github/workflows/ci.yaml
+++ b/.github/workflows/ci.yaml
@@ -27,7 +27,7 @@ jobs:
 
     - name: Install latest pip, setuptools, wheel
       run: |
-        python -m pip install --upgrade pip setuptools wheel virtualenv --upgrade-strategy=eager
+        python -m pip install --upgrade pip setuptools wheel --upgrade-strategy=eager
     - name: Install dependencies
       env:
         PIPENV_DEFAULT_PYTHON_VERSION: ${{ matrix.python-version }}
@@ -37,8 +37,8 @@ jobs:
       run: |
         git submodule sync
         git submodule update --init --recursive
-        python -m pip install -e . --upgrade
         python -m pip install "virtualenv<20"
+        python -m pip install -e . --upgrade
         pipenv install --deploy --dev --python=${{ steps.python-path.outputs.path }}
     - name: Run tests
       env:
diff --git a/pipenv/core.py b/pipenv/core.py
index 7f4b9134..fffbfb6b 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -768,7 +768,7 @@ def batch_install(deps_list, procs, failed_deps_queue,
                 pypi_mirror=pypi_mirror,
                 trusted_hosts=trusted_hosts,
                 extra_indexes=extra_indexes,
-                use_pep517=True,
+                use_pep517=not failed,
             )
             c.dep = dep
             # if dep.is_vcs or dep.editable:
