commit dbb3603a05a35277a44f1317ba717f1780bf05e9
Author: jxltom <jxltom@gmail.com>
Date:   Mon Dec 3 09:27:23 2018 +0800

    Fix a bug where activated virtualenv is not being used in pipenv run

diff --git a/pipenv/core.py b/pipenv/core.py
index cb7ce9e2..818d0beb 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -2315,14 +2315,19 @@ def do_run(command, args, three=None, python=False, pypi_mirror=None):
         three=three, python=python, validate=False, pypi_mirror=pypi_mirror,
     )
 
-    # Set an environment variable, so we know we're in the environment.
-    os.environ["PIPENV_ACTIVE"] = vistir.misc.fs_str("1")
-
-    os.environ.pop("PIP_SHIMS_BASE_MODULE", None)
     load_dot_env()
 
     # Activate virtualenv under the current interpreter's environment
     inline_activate_virtual_environment()
+
+    # Set an environment variable, so we know we're in the environment.
+    # Only set PIPENV_ACTIVE after finishing reading virtualenv_location
+    # such as in inline_activate_virtual_environment
+    # otherwise its value will be changed
+    os.environ["PIPENV_ACTIVE"] = vistir.misc.fs_str("1")
+
+    os.environ.pop("PIP_SHIMS_BASE_MODULE", None)
+    
     try:
         script = project.build_script(command, args)
     except ScriptEmptyError:
