commit 478e4c5f37047fa0fd3be26939381735459d484f
Author: Dan Ryan <dan.ryan@canonical.com>
Date:   Tue Apr 21 00:39:40 2020 -0400

    add debugging for flaky markers test
    
    - Don't retry vcs installs without pep517 builds
    
    Signed-off-by: Dan Ryan <dan.ryan@canonical.com>

diff --git a/pipenv/core.py b/pipenv/core.py
index 65e95e05..2df9867c 100644
--- a/pipenv/core.py
+++ b/pipenv/core.py
@@ -756,6 +756,9 @@ def batch_install(deps_list, procs, failed_deps_queue,
                     del os.environ["PYTHONHOME"]
             if "GIT_CONFIG" in os.environ and dep.is_vcs:
                 del os.environ["GIT_CONFIG"]
+            use_pep517 = True
+            if failed and not dep.is_vcs:
+                use_pep517 = False
 
             c = pip_install(
                 dep,
@@ -768,7 +771,7 @@ def batch_install(deps_list, procs, failed_deps_queue,
                 pypi_mirror=pypi_mirror,
                 trusted_hosts=trusted_hosts,
                 extra_indexes=extra_indexes,
-                use_pep517=not failed,
+                use_pep517=use_pep517,
             )
             c.dep = dep
             # if dep.is_vcs or dep.editable:
diff --git a/tests/integration/test_install_markers.py b/tests/integration/test_install_markers.py
index c7553952..93126dbd 100644
--- a/tests/integration/test_install_markers.py
+++ b/tests/integration/test_install_markers.py
@@ -1,6 +1,7 @@
 # -*- coding: utf-8 -*-
 from __future__ import absolute_import, print_function
 import os
+import sys
 
 import pytest
 
@@ -140,13 +141,17 @@ def test_resolver_unique_markers(PipenvInstance):
     This verifies that we clean that successfully.
     """
     with PipenvInstance(chdir=True) as p:
-        c = p.pipenv('install vcrpy==2.0.1')
+        c = p.pipenv('install vcrpy==2.0.1 --verbose')
         assert c.return_code == 0
-        c = p.pipenv('lock')
+        print(c.out, file=sys.stderr)
+        print(c.err, file=sys.stderr)
+        c = p.pipenv('lock --verbose')
+        print(c.out, file=sys.stderr)
+        print(c.err, file=sys.stderr)
         assert c.return_code == 0
         assert 'yarl' in p.lockfile['default']
         yarl = p.lockfile['default']['yarl']
-        assert 'markers' in yarl
+        assert 'markers' in yarl, os.listdir(os.path.expanduser(os.environ.get("PIPENV_CACHE_DIR", "~/.cache/pipenv")))
         # Two possible marker sets are ok here
         assert yarl['markers'] in [
             "python_version in '3.4, 3.5, 3.6'",
