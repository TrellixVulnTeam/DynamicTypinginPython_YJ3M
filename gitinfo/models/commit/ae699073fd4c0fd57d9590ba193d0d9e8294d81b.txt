commit ae699073fd4c0fd57d9590ba193d0d9e8294d81b
Author: Yuefeng Zhou <yuefengz@google.com>
Date:   Wed Feb 13 20:27:55 2019 -0800

    Workarond for memory issue in eager mode. (#6197)
    
    * Workarond for memory issue in eager mode.
    
    * Add a TODO
    
    * Fix typo
    
    * Address comments
    
    * remove patch which appear hacky.
    
    * fix typo

diff --git a/official/resnet/keras/keras_imagenet_benchmark.py b/official/resnet/keras/keras_imagenet_benchmark.py
index 21d8b8cb..b06f854c 100644
--- a/official/resnet/keras/keras_imagenet_benchmark.py
+++ b/official/resnet/keras/keras_imagenet_benchmark.py
@@ -157,6 +157,23 @@ class Resnet50KerasBenchmarkBase(keras_benchmark.KerasBenchmark):
     FLAGS.batch_size = 128 * 8  # 8 GPUs
     self._run_and_report_benchmark()
 
+  def benchmark_8_gpu_bfc_allocator(self):
+    self._setup()
+
+    FLAGS.num_gpus = 8
+    FLAGS.enable_eager = True
+    FLAGS.distribution_strategy = 'default'
+    FLAGS.model_dir = self._get_model_dir('benchmark_8_gpu')
+    FLAGS.batch_size = 128 * 8  # 8 GPUs
+    # Use BFC allocator with limited memory on CPU as a workaround for memory
+    # spikes in eager mode.
+    # TODO(yuefengz): get rid of this test once we fix the memory issue.
+    os.environ['TF_CPU_ALLOCATOR_USE_BFC'] = 'true'
+    os.environ['TF_CPU_BFC_MEM_LIMIT_IN_MB'] = '100000'
+    self._run_and_report_benchmark()
+    del os.environ['TF_CPU_ALLOCATOR_USE_BFC']
+    del os.environ['TF_CPU_BFC_MEM_LIMIT_IN_MB']
+
   def benchmark_graph_8_gpu(self):
     self._setup()
 
