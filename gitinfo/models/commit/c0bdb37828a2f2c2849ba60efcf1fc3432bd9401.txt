commit c0bdb37828a2f2c2849ba60efcf1fc3432bd9401
Author: A. Unique TensorFlower <gardener@tensorflow.org>
Date:   Thu Dec 5 16:08:38 2019 -0800

    Using better version of l2 loss to avoid reshape, concat and split ops.
    Also adding support for CTL mode in the borg file.
    
    PiperOrigin-RevId: 284075404

diff --git a/official/vision/image_classification/resnet_ctl_imagenet_main.py b/official/vision/image_classification/resnet_ctl_imagenet_main.py
index 65409baf..4002c949 100644
--- a/official/vision/image_classification/resnet_ctl_imagenet_main.py
+++ b/official/vision/image_classification/resnet_ctl_imagenet_main.py
@@ -274,13 +274,12 @@ def run(flags_obj):
         num_replicas = tf.distribute.get_strategy().num_replicas_in_sync
 
         if flags_obj.single_l2_loss_op:
-          filtered_variables = [
-              tf.reshape(v, (-1,))
+          l2_loss = resnet_model.L2_WEIGHT_DECAY * 2 * tf.add_n([
+              tf.nn.l2_loss(v)
               for v in trainable_variables
               if 'bn' not in v.name
-          ]
-          l2_loss = resnet_model.L2_WEIGHT_DECAY * 2 * tf.nn.l2_loss(
-              tf.concat(filtered_variables, axis=0))
+          ])
+
           loss += (l2_loss / num_replicas)
         else:
           loss += (tf.reduce_sum(model.losses) / num_replicas)
