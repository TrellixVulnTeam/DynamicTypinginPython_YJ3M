commit ef6cb209dcc568b892d4c8fe9130366eba73de94
Author: George Sterpu <george.sterpu@gmail.com>
Date:   Mon Jan 27 17:26:09 2020 +0000

    Update beam_search.py

diff --git a/official/transformer/v2/beam_search.py b/official/transformer/v2/beam_search.py
index c0854bde..c88a8514 100644
--- a/official/transformer/v2/beam_search.py
+++ b/official/transformer/v2/beam_search.py
@@ -30,9 +30,13 @@ class SequenceBeamSearchV2(v1.SequenceBeamSearch):
     """Beam search for sequences with highest scores."""
     state, state_shapes = self._create_initial_state(initial_ids, initial_cache)
 
-    finished_state = tf.while_loop(
-        self._continue_search, self._search_step, loop_vars=[state],
-        shape_invariants=[state_shapes], parallel_iterations=1, back_prop=False)
+    finished_state = tf.nest.map_structure(
+      tf.stop_gradient,
+      tf.while_loop(self._continue_search,
+                    self._search_step,
+                    loop_vars=[state],
+                    shape_invariants=[state_shapes],
+                    parallel_iterations=1))
     finished_state = finished_state[0]
 
     alive_seq = finished_state[_StateKeys.ALIVE_SEQ]
