commit fda7e6dc28abc296e178ecf7958458462a7e126c
Author: Andrew M. Dai <adai@google.com>
Date:   Wed Oct 18 15:28:44 2017 -0700

    Fix frequent deadlocks caused by summaries not depending on the save_state ops.
    
    PiperOrigin-RevId: 172665358

diff --git a/research/adversarial_text/graphs.py b/research/adversarial_text/graphs.py
index 9f417435..d0230752 100644
--- a/research/adversarial_text/graphs.py
+++ b/research/adversarial_text/graphs.py
@@ -189,11 +189,10 @@ class VatxtModel(object):
     tf.summary.scalar('adversarial_loss', adv_loss)
 
     total_loss = loss + adv_loss
-    tf.summary.scalar('total_classification_loss', total_loss)
 
     with tf.control_dependencies([inputs.save_state(next_state)]):
       total_loss = tf.identity(total_loss)
-
+      tf.summary.scalar('total_classification_loss', total_loss)
     return total_loss
 
   def language_model_graph(self, compute_loss=True):
@@ -419,12 +418,12 @@ class VatxtBidirModel(VatxtModel):
     tf.summary.scalar('adversarial_loss', adv_loss)
 
     total_loss = loss + adv_loss
-    tf.summary.scalar('total_classification_loss', total_loss)
+
 
     saves = [inp.save_state(state) for (inp, state) in zip(inputs, next_states)]
     with tf.control_dependencies(saves):
       total_loss = tf.identity(total_loss)
-
+      tf.summary.scalar('total_classification_loss', total_loss)
     return total_loss
 
   def language_model_graph(self, compute_loss=True):
