commit 5856878daad3e34752d221c153a90918c5ba050f
Author: Reed <reedwm@google.com>
Date:   Wed Sep 5 10:47:37 2018 -0700

    Fix crash caused by race in the async process. (#5250)
    
    When constructing the evaluation records, data_async_generation.py would copy the records into the final directory. The main process would wait until the eval records existed. However, the main process would sometimes read the eval records before they were fully copied, causing a DataLossError.

diff --git a/official/recommendation/data_async_generation.py b/official/recommendation/data_async_generation.py
index b176b9cb..30432bb5 100644
--- a/official/recommendation/data_async_generation.py
+++ b/official/recommendation/data_async_generation.py
@@ -329,8 +329,7 @@ def _construct_eval_record(cache_paths, eval_batch_size):
           items=items[i, :]
       )
       writer.write(batch_bytes)
-  tf.gfile.Copy(intermediate_fpath, dest_fpath)
-  tf.gfile.Remove(intermediate_fpath)
+  tf.gfile.Rename(intermediate_fpath, dest_fpath)
   log_msg("Eval TFRecords file successfully constructed.")
 
 
