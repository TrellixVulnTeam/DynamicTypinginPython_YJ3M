commit 29c1d5cb5d283c649a5bc30dce53b8e4875d01d3
Author: Matt Martz <matt@sivel.net>
Date:   Thu Jan 18 09:28:25 2018 -0600

    Ensure that the become password is written on py3 in the ssh connection plugin. Fixes #34727

diff --git a/lib/ansible/plugins/connection/ssh.py b/lib/ansible/plugins/connection/ssh.py
index a0bec34ac3..008f2ebfe9 100644
--- a/lib/ansible/plugins/connection/ssh.py
+++ b/lib/ansible/plugins/connection/ssh.py
@@ -780,6 +780,9 @@ class Connection(ConnectionBase):
                     if self._flags['become_prompt']:
                         display.debug('Sending become_pass in response to prompt')
                         stdin.write(to_bytes(self._play_context.become_pass) + b'\n')
+                        # On python3 stdin is a BufferedWriter, and we don't have a guarantee
+                        # that the write will happen without a flush
+                        stdin.flush()
                         self._flags['become_prompt'] = False
                         state += 1
                     elif self._flags['become_success']:
diff --git a/test/units/plugins/connection/test_ssh.py b/test/units/plugins/connection/test_ssh.py
index 0bb5c19cc5..5ec1d05c0b 100644
--- a/test/units/plugins/connection/test_ssh.py
+++ b/test/units/plugins/connection/test_ssh.py
@@ -459,6 +459,7 @@ class TestSSHConnectionRun(object):
         self.mock_selector.get_map.side_effect = lambda: True
 
         return_code, b_stdout, b_stderr = self.conn._run("ssh", "this is input data")
+        self.mock_popen_res.stdin.flush.assert_called_once_with()
         assert return_code == 0
         assert b_stdout == b'abc'
         assert b_stderr == b'123'
