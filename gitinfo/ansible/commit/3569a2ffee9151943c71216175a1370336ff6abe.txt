commit 3569a2ffee9151943c71216175a1370336ff6abe
Author: Alek Storm <alek.storm@gmail.com>
Date:   Mon Jul 29 14:33:32 2013 -0700

    Handle AnsibleUndefinedVariable's raised from lookup plugins like jinja2 UndefinedError's

diff --git a/lib/ansible/utils/template.py b/lib/ansible/utils/template.py
index b18a9c968e..157af0ec9b 100644
--- a/lib/ansible/utils/template.py
+++ b/lib/ansible/utils/template.py
@@ -511,7 +511,7 @@ def template_from_string(basedir, data, vars, fail_on_undefined=False):
 
         res = jinja2.utils.concat(t.root_render_func(t.new_context(_jinja2_vars(basedir, vars, t.globals, fail_on_undefined), shared=True)))
         return res
-    except jinja2.exceptions.UndefinedError:
+    except (jinja2.exceptions.UndefinedError, errors.AnsibleUndefinedVariable):
         if fail_on_undefined:
             raise
         else:
