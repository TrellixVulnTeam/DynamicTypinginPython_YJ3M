commit fd954a9c5c05c7149eb23271529ff070f2b1f9dc
Author: James Cassell <code@james.cassell.me>
Date:   Tue Feb 4 14:40:09 2020 -0500

    wait_for_connection: also retry interpreter discovery (#67040)
    
    self._discovered_interpreter_key is None unless a previous iteration
    has attempted discovery.  In that case, force re-discovery, as the
    previous attempt certainly failed.

diff --git a/changelogs/fragments/wait_for_connection-interpreter-discovery-retry.yaml b/changelogs/fragments/wait_for_connection-interpreter-discovery-retry.yaml
new file mode 100644
index 0000000000..446edd24f1
--- /dev/null
+++ b/changelogs/fragments/wait_for_connection-interpreter-discovery-retry.yaml
@@ -0,0 +1,4 @@
+---
+bugfixes:
+- wait_for_connection - with pipelining enabled, interpreter discovery would
+  fail if the first connection attempt was not successful
diff --git a/lib/ansible/plugins/action/wait_for_connection.py b/lib/ansible/plugins/action/wait_for_connection.py
index fbf4e98fa2..8c5b3bea1a 100644
--- a/lib/ansible/plugins/action/wait_for_connection.py
+++ b/lib/ansible/plugins/action/wait_for_connection.py
@@ -79,6 +79,9 @@ class ActionModule(ActionBase):
         def ping_module_test(connect_timeout):
             ''' Test ping module, if available '''
             display.vvv("wait_for_connection: attempting ping module test")
+            # re-run interpreter discovery if we ran it in the first iteration
+            if self._discovered_interpreter_key:
+                task_vars['ansible_facts'].pop(self._discovered_interpreter_key, None)
             # call connection reset between runs if it's there
             try:
                 self._connection.reset()
