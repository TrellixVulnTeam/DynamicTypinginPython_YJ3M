commit fb7bfa61a9e472ecf80da350001400373e7e75e4
Author: Michael DeHaan <michael.dehaan@gmail.com>
Date:   Fri May 3 10:18:55 2013 -0400

    Fix SELinux context on atomic_move

diff --git a/lib/ansible/module_common.py b/lib/ansible/module_common.py
index 2f88cb6328..c735836350 100644
--- a/lib/ansible/module_common.py
+++ b/lib/ansible/module_common.py
@@ -298,7 +298,7 @@ class AnsibleModule(object):
         context = ret[1].split(':')
         return context
 
-    def selinux_context(self, path):
+    def selinux_context(self, path)
         context = self.selinux_initial_context()
         if not HAVE_SELINUX or not self.selinux_enabled():
             return context
@@ -810,6 +810,7 @@ class AnsibleModule(object):
     def atomic_move(self, src, dest):
         '''atomically move src to dest, copying attributes from dest, returns true on success'''
         rc = False
+        context = None
         if os.path.exists(dest):
             st = os.stat(dest)
             os.chmod(src, st.st_mode & 07777)
@@ -840,6 +841,9 @@ class AnsibleModule(object):
             if self.selinux_enabled():
                 self.set_context_if_different(tmp_dest, context, False)
             os.rename(tmp_dest, dest)
+            if self.selinux_enabled():
+                # rename might not preserve context
+                self.set_context_if_different(tmp_dest, context, False)
             rc = True
         except (shutil.Error, OSError, IOError), e:
             cleanup()
