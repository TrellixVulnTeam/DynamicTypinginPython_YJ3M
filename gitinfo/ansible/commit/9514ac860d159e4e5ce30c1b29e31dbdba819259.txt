commit 9514ac860d159e4e5ce30c1b29e31dbdba819259
Author: Rene Moser <mail@renemoser.net>
Date:   Tue Sep 22 16:17:21 2015 +0200

    cloudstack: more integration tests

diff --git a/test/integration/roles/test_cs_account/tasks/main.yml b/test/integration/roles/test_cs_account/tasks/main.yml
index af7a54f52b..0061c66639 100644
--- a/test/integration/roles/test_cs_account/tasks/main.yml
+++ b/test/integration/roles/test_cs_account/tasks/main.yml
@@ -224,3 +224,117 @@
     that:
     - acc|success
     - not acc|changed
+
+- name: test create user disabled account
+  cs_account:
+    name: "{{ cs_resource_prefix }}_user"
+    username: "{{ cs_resource_prefix }}_username"
+    password: "{{ cs_resource_prefix }}_password"
+    last_name: "{{ cs_resource_prefix }}_last_name"
+    first_name: "{{ cs_resource_prefix }}_first_name"
+    email: "{{ cs_resource_prefix }}@example.com"
+    network_domain: "{{ cs_resource_prefix }}.local"
+    state: disabled
+  register: acc
+- name: verify results of create disabled account
+  assert:
+    that:
+    - acc|success
+    - acc|changed
+    - acc.name == "{{ cs_resource_prefix }}_user"
+    - acc.network_domain == "{{ cs_resource_prefix }}.local"
+    - acc.account_type == "user"
+    - acc.state == "disabled"
+    - acc.domain == "ROOT"
+
+- name: test remove disabled user account
+  cs_account:
+    name: "{{ cs_resource_prefix }}_user"
+    state: absent
+  register: acc
+- name: verify results of remove disabled user account
+  assert:
+    that:
+    - acc|success
+    - acc|changed
+    - acc.name == "{{ cs_resource_prefix }}_user"
+    - acc.network_domain == "{{ cs_resource_prefix }}.local"
+    - acc.account_type == "user"
+    - acc.state == "disabled"
+    - acc.domain == "ROOT"
+
+- name: test create user locked account
+  cs_account:
+    name: "{{ cs_resource_prefix }}_user"
+    username: "{{ cs_resource_prefix }}_username"
+    password: "{{ cs_resource_prefix }}_password"
+    last_name: "{{ cs_resource_prefix }}_last_name"
+    first_name: "{{ cs_resource_prefix }}_first_name"
+    email: "{{ cs_resource_prefix }}@example.com"
+    network_domain: "{{ cs_resource_prefix }}.local"
+    state: locked
+  register: acc
+- name: verify results of create locked account
+  assert:
+    that:
+    - acc|success
+    - acc|changed
+    - acc.name == "{{ cs_resource_prefix }}_user"
+    - acc.network_domain == "{{ cs_resource_prefix }}.local"
+    - acc.account_type == "user"
+    - acc.state == "locked"
+    - acc.domain == "ROOT"
+
+- name: test remove locked user account
+  cs_account:
+    name: "{{ cs_resource_prefix }}_user"
+    state: absent
+  register: acc
+- name: verify results of remove locked user account
+  assert:
+    that:
+    - acc|success
+    - acc|changed
+    - acc.name == "{{ cs_resource_prefix }}_user"
+    - acc.network_domain == "{{ cs_resource_prefix }}.local"
+    - acc.account_type == "user"
+    - acc.state == "locked"
+    - acc.domain == "ROOT"
+
+- name: test create user unlocked/enabled account
+  cs_account:
+    name: "{{ cs_resource_prefix }}_user"
+    username: "{{ cs_resource_prefix }}_username"
+    password: "{{ cs_resource_prefix }}_password"
+    last_name: "{{ cs_resource_prefix }}_last_name"
+    first_name: "{{ cs_resource_prefix }}_first_name"
+    email: "{{ cs_resource_prefix }}@example.com"
+    network_domain: "{{ cs_resource_prefix }}.local"
+    state: unlocked
+  register: acc
+- name: verify results of create unlocked/enabled account
+  assert:
+    that:
+    - acc|success
+    - acc|changed
+    - acc.name == "{{ cs_resource_prefix }}_user"
+    - acc.network_domain == "{{ cs_resource_prefix }}.local"
+    - acc.account_type == "user"
+    - acc.state == "enabled"
+    - acc.domain == "ROOT"
+
+- name: test remove unlocked/enabled user account
+  cs_account:
+    name: "{{ cs_resource_prefix }}_user"
+    state: absent
+  register: acc
+- name: verify results of remove unlocked/enabled user account
+  assert:
+    that:
+    - acc|success
+    - acc|changed
+    - acc.name == "{{ cs_resource_prefix }}_user"
+    - acc.network_domain == "{{ cs_resource_prefix }}.local"
+    - acc.account_type == "user"
+    - acc.state == "enabled"
+    - acc.domain == "ROOT"
diff --git a/test/integration/roles/test_cs_instance/tasks/main.yml b/test/integration/roles/test_cs_instance/tasks/main.yml
index a457a3c710..d1a67e1781 100644
--- a/test/integration/roles/test_cs_instance/tasks/main.yml
+++ b/test/integration/roles/test_cs_instance/tasks/main.yml
@@ -1,6 +1,6 @@
 ---
 - include: setup.yml
 - include: present.yml
-#- include: tags.yml
+- include: tags.yml
 - include: absent.yml
 - include: cleanup.yml
diff --git a/test/integration/roles/test_cs_instance/tasks/tags.yml b/test/integration/roles/test_cs_instance/tasks/tags.yml
index a86158df0f..50836384b2 100644
--- a/test/integration/roles/test_cs_instance/tasks/tags.yml
+++ b/test/integration/roles/test_cs_instance/tasks/tags.yml
@@ -2,6 +2,8 @@
 - name: test add tags to instance
   cs_instance:
     name: "{{ cs_resource_prefix }}-vm-{{ instance_number }}"
+    template: "{{ test_cs_instance_template }}"
+    service_offering: "{{ test_cs_instance_offering_1 }}"
     tags:
      - { key: "{{ cs_resource_prefix }}-tag1", value: "{{ cs_resource_prefix }}-value1" }
      - { key: "{{ cs_resource_prefix }}-tag2", value: "{{ cs_resource_prefix }}-value2" }
@@ -12,11 +14,10 @@
     - instance|success
     - instance|changed
     - instance.tags|length == 2
-    - instance.tags[0]['key'] == "{{ cs_resource_prefix }}-tag1"
-    - instance.tags[1]['key'] == "{{ cs_resource_prefix }}-tag2"
-    - instance.tags[0]['value'] == "{{ cs_resource_prefix }}-value1"
-    - instance.tags[1]['value'] == "{{ cs_resource_prefix }}-value2"
-
+    - "instance.tags[0]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag1' ]"
+    - "instance.tags[1]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag1' ]"
+    - "instance.tags[0]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value1' ]"
+    - "instance.tags[1]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value1' ]"
 
 - name: test tags to instance idempotence
   cs_instance:
@@ -31,10 +32,10 @@
     - instance|success
     - not instance|changed
     - instance.tags|length == 2
-    - instance.tags[0]['key'] == "{{ cs_resource_prefix }}-tag1"
-    - instance.tags[1]['key'] == "{{ cs_resource_prefix }}-tag2"
-    - instance.tags[0]['value'] == "{{ cs_resource_prefix }}-value1"
-    - instance.tags[1]['value'] == "{{ cs_resource_prefix }}-value2"
+    - "instance.tags[0]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag1' ]"
+    - "instance.tags[1]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag1' ]"
+    - "instance.tags[0]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value1' ]"
+    - "instance.tags[1]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value1' ]"
 
 - name: test change tags of instance
   cs_instance:
@@ -47,12 +48,12 @@
   assert:
     that:
     - instance|success
-    - not instance|changed
+    - instance|changed
     - instance.tags|length == 2
-    - instance.tags[0]['key'] == "{{ cs_resource_prefix }}-tag1"
-    - instance.tags[1]['key'] == "{{ cs_resource_prefix }}-tag3"
-    - instance.tags[0]['value'] == "{{ cs_resource_prefix }}-value1"
-    - instance.tags[1]['value'] == "{{ cs_resource_prefix }}-value3"
+    - "instance.tags[0]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag3' ]"
+    - "instance.tags[1]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag3' ]"
+    - "instance.tags[0]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value3' ]"
+    - "instance.tags[1]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value3' ]"
 
 - name: test not touch tags of instance if no param tags
   cs_instance:
@@ -64,10 +65,10 @@
     - instance|success
     - not instance|changed
     - instance.tags|length == 2
-    - instance.tags[0]['key'] == "{{ cs_resource_prefix }}-tag1"
-    - instance.tags[1]['key'] == "{{ cs_resource_prefix }}-tag3"
-    - instance.tags[0]['value'] == "{{ cs_resource_prefix }}-value1"
-    - instance.tags[1]['value'] == "{{ cs_resource_prefix }}-value3"
+    - "instance.tags[0]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag3' ]"
+    - "instance.tags[1]['key'] in [ '{{ cs_resource_prefix }}-tag2', '{{ cs_resource_prefix }}-tag3' ]"
+    - "instance.tags[0]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value3' ]"
+    - "instance.tags[1]['value'] in [ '{{ cs_resource_prefix }}-value2', '{{ cs_resource_prefix }}-value3' ]"
 
 - name: test remove tags
   cs_instance:
@@ -78,5 +79,5 @@
   assert:
     that:
     - instance|success
-    - not instance|changed
+    - instance|changed
     - instance.tags|length == 0
diff --git a/test/integration/roles/test_cs_user/tasks/main.yml b/test/integration/roles/test_cs_user/tasks/main.yml
index c5aaed8d58..e88612bc21 100644
--- a/test/integration/roles/test_cs_user/tasks/main.yml
+++ b/test/integration/roles/test_cs_user/tasks/main.yml
@@ -232,10 +232,10 @@
     - user.state == "enabled"
     - user.domain == "ROOT"
 
-- name: test enable user idempotence
+- name: test enable user idempotence using unlocked
   cs_user:
     username: "{{ cs_resource_prefix }}_user"
-    state: enabled
+    state: unlocked
   register: user
 - name: verify results of enable user idempotence
   assert:
@@ -274,3 +274,123 @@
     that:
     - user|success
     - not user|changed
+
+- name: test create locked user
+  cs_user:
+    username: "{{ cs_resource_prefix }}_user"
+    password: "{{ cs_resource_prefix }}_password"
+    last_name: "{{ cs_resource_prefix }}_last_name"
+    first_name: "{{ cs_resource_prefix }}_first_name"
+    email: "{{ cs_resource_prefix }}@example.com"
+    account: "admin"
+    state: locked
+  register: user
+- name: verify results of create locked user
+  assert:
+    that:
+    - user|success
+    - user|changed
+    - user.username == "{{ cs_resource_prefix }}_user"
+    - user.first_name == "{{ cs_resource_prefix }}_first_name"
+    - user.last_name == "{{ cs_resource_prefix }}_last_name"
+    - user.email == "{{ cs_resource_prefix }}@example.com"
+    - user.account_type == "root_admin"
+    - user.account == "admin"
+    - user.state == "locked"
+    - user.domain == "ROOT"
+
+- name: test remove locked user
+  cs_user:
+    username: "{{ cs_resource_prefix }}_user"
+    state: absent
+  register: user
+- name: verify results of remove locked user
+  assert:
+    that:
+    - user|success
+    - user|changed
+    - user.username == "{{ cs_resource_prefix }}_user"
+    - user.account_type == "root_admin"
+    - user.account == "admin"
+    - user.state == "locked"
+    - user.domain == "ROOT"
+
+- name: test create disabled user
+  cs_user:
+    username: "{{ cs_resource_prefix }}_user"
+    password: "{{ cs_resource_prefix }}_password"
+    last_name: "{{ cs_resource_prefix }}_last_name"
+    first_name: "{{ cs_resource_prefix }}_first_name"
+    email: "{{ cs_resource_prefix }}@example.com"
+    account: "admin"
+    state: disabled
+  register: user
+- name: verify results of create disabled user
+  assert:
+    that:
+    - user|success
+    - user|changed
+    - user.username == "{{ cs_resource_prefix }}_user"
+    - user.first_name == "{{ cs_resource_prefix }}_first_name"
+    - user.last_name == "{{ cs_resource_prefix }}_last_name"
+    - user.email == "{{ cs_resource_prefix }}@example.com"
+    - user.account_type == "root_admin"
+    - user.account == "admin"
+    - user.state == "disabled"
+    - user.domain == "ROOT"
+
+- name: test remove disabled user
+  cs_user:
+    username: "{{ cs_resource_prefix }}_user"
+    state: absent
+  register: user
+- name: verify results of remove disabled user
+  assert:
+    that:
+    - user|success
+    - user|changed
+    - user.username == "{{ cs_resource_prefix }}_user"
+    - user.account_type == "root_admin"
+    - user.account == "admin"
+    - user.state == "disabled"
+    - user.domain == "ROOT"
+
+- name: test create enabled user
+  cs_user:
+    username: "{{ cs_resource_prefix }}_user"
+    password: "{{ cs_resource_prefix }}_password"
+    last_name: "{{ cs_resource_prefix }}_last_name"
+    first_name: "{{ cs_resource_prefix }}_first_name"
+    email: "{{ cs_resource_prefix }}@example.com"
+    account: "admin"
+    state: enabled
+  register: user
+- name: verify results of create enabled user
+  assert:
+    that:
+    - user|success
+    - user|changed
+    - user.username == "{{ cs_resource_prefix }}_user"
+    - user.first_name == "{{ cs_resource_prefix }}_first_name"
+    - user.last_name == "{{ cs_resource_prefix }}_last_name"
+    - user.email == "{{ cs_resource_prefix }}@example.com"
+    - user.account_type == "root_admin"
+    - user.account == "admin"
+    - user.state == "enabled"
+    - user.domain == "ROOT"
+
+- name: test remove enabled user
+  cs_user:
+    username: "{{ cs_resource_prefix }}_user"
+    state: absent
+  register: user
+- name: verify results of remove enabled user
+  assert:
+    that:
+    - user|success
+    - user|changed
+    - user.username == "{{ cs_resource_prefix }}_user"
+    - user.account_type == "root_admin"
+    - user.account == "admin"
+    - user.state == "enabled"
+    - user.domain == "ROOT"
