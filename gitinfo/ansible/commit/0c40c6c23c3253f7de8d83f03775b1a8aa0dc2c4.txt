commit 0c40c6c23c3253f7de8d83f03775b1a8aa0dc2c4
Author: James Cammarata <jimi@sngx.net>
Date:   Fri Oct 3 13:30:47 2014 -0500

    Fix order of resolving dependent role variables from vars files
    
    Also adds a new class to the test_var_precedence test to check for
    this type of error in the future.
    
    Fixes #9178

diff --git a/lib/ansible/playbook/play.py b/lib/ansible/playbook/play.py
index ad57ebd9df..ca53bc029e 100644
--- a/lib/ansible/playbook/play.py
+++ b/lib/ansible/playbook/play.py
@@ -287,7 +287,8 @@ class Play(object):
                         if os.path.isfile(vars):
                             vars_data = utils.parse_yaml_from_file(vars, vault_password=self.vault_password)
                             if vars_data:
-                                dep_vars = utils.combine_vars(vars_data, dep_vars)
+                                #dep_vars = utils.combine_vars(vars_data, dep_vars)
+                                dep_vars = utils.combine_vars(dep_vars, vars_data)
                         defaults = self._resolve_main(utils.path_dwim(self.basedir, os.path.join(dep_path, 'defaults')))
                         dep_defaults_data = {}
                         if os.path.isfile(defaults):
diff --git a/test/integration/roles/test_var_precedence_dep/defaults/main.yml b/test/integration/roles/test_var_precedence_dep/defaults/main.yml
new file mode 100644
index 0000000000..dda4224c35
--- /dev/null
+++ b/test/integration/roles/test_var_precedence_dep/defaults/main.yml
@@ -0,0 +1,5 @@
+---
+# should be overridden by vars_files in the main play
+vars_files_var: "BAD!"
+# should be seen in role1 (no override)
+defaults_file_var_role1: "defaults_file_var_role1"
diff --git a/test/integration/roles/test_var_precedence_dep/tasks/main.yml b/test/integration/roles/test_var_precedence_dep/tasks/main.yml
new file mode 100644
index 0000000000..2f8e17096b
--- /dev/null
+++ b/test/integration/roles/test_var_precedence_dep/tasks/main.yml
@@ -0,0 +1,14 @@
+- debug: var=extra_var
+- debug: var=param_var
+- debug: var=vars_var
+- debug: var=vars_files_var
+- debug: var=vars_files_var_role
+- debug: var=defaults_file_var_role1
+- assert:
+    that:
+      - 'extra_var == "extra_var"'
+      - 'param_var == "param_var_role1"'
+      - 'vars_var == "vars_var"'
+      - 'vars_files_var == "vars_files_var"'
+      - 'vars_files_var_role == "vars_files_var_dep"'
+      - 'defaults_file_var_role1 == "defaults_file_var_role1"'
diff --git a/test/integration/roles/test_var_precedence_dep/vars/main.yml b/test/integration/roles/test_var_precedence_dep/vars/main.yml
new file mode 100644
index 0000000000..a69efad537
--- /dev/null
+++ b/test/integration/roles/test_var_precedence_dep/vars/main.yml
@@ -0,0 +1,4 @@
+---
+# should override the global vars_files_var since it's local to the role
+# but will be set to the value in the last role included which defines it
+vars_files_var_role: "vars_files_var_dep"
diff --git a/test/integration/roles/test_var_precedence_role1/meta/main.yml b/test/integration/roles/test_var_precedence_role1/meta/main.yml
new file mode 100644
index 0000000000..c8b410b59c
--- /dev/null
+++ b/test/integration/roles/test_var_precedence_role1/meta/main.yml
@@ -0,0 +1,2 @@
+dependencies:
+  - test_var_precedence_dep
