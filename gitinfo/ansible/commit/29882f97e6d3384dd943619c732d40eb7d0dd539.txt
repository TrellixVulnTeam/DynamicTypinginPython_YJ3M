commit 29882f97e6d3384dd943619c732d40eb7d0dd539
Author: Fabian Arrotin <fabian.arrotin@arrfab.net>
Date:   Tue Nov 6 22:49:33 2012 +0100

    Fixed the way dom0/domU xen role is defined in the setup module

diff --git a/library/setup b/library/setup
index 24a0985a1b..480964e9c6 100755
--- a/library/setup
+++ b/library/setup
@@ -711,11 +711,12 @@ class LinuxVirtual(Virtual):
     def get_virtual_facts(self):
         if os.path.exists("/proc/xen"):
             self.facts['virtualization_type'] = 'xen'
+            self.facts['virtualization_role'] = 'guest'
             if os.path.exists('/proc/xen/capabilities'):
-                self.facts['virtualization_role'] = 'host'
-            else:
-                self.facts['virtualization_role'] = 'guest'
-
+                for line in open('/proc/xen/capabilities'):
+                    if "control_d" in line:
+                        self.facts['virtualization_role'] = 'host'
+                    
         elif os.path.exists('/proc/vz'):
             self.facts['virtualization_type'] = 'openvz'
             if os.path.exists('/proc/vz/version'):
