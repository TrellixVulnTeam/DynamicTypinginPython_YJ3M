commit 0cc23de7763756e8fcb65be9d2f694d54d4fb5fd
Author: Rene Moser <mail@renemoser.net>
Date:   Thu Feb 14 23:44:50 2019 +0100

    cloudstack: test: ensure network is implemented (#52204)
    
    In ACS 4.12, it is no longer possbile to acquire IPs to a (...) network
    not already in implemented state.
    
    With deployment of a VM instance, we enforce the implementation of the
    network. Also see https://github.com/apache/cloudstack/commit/323f791efca6f1d5b8bb63573d9e385c97c427e1

diff --git a/test/integration/targets/cs_firewall/tasks/main.yml b/test/integration/targets/cs_firewall/tasks/main.yml
index 67fe13ff11..a6ab572503 100644
--- a/test/integration/targets/cs_firewall/tasks/main.yml
+++ b/test/integration/targets/cs_firewall/tasks/main.yml
@@ -11,6 +11,23 @@
     that:
     - net is successful
 
+- name: setup instance to get network in implementation state
+  cs_instance:
+    name: "{{ cs_resource_prefix }}-vm-cs-firewall"
+    template: "{{ cs_common_template }}"
+    service_offering: "{{ cs_common_service_offering }}"
+    zone: "{{ cs_common_zone_adv }}"
+    networks:
+      - "{{ net.name }}"
+  register: instance
+  until: instance is success
+  retries: 10
+  delay: 5
+- name: verify instance setup
+  assert:
+    that:
+    - instance is successful
+
 - name: public ip address setup
   cs_ip_address:
     network: ansible test
@@ -444,6 +461,17 @@
     - fw is successful
     - fw is not changed
 
+- name: cleanup instance
+  cs_instance:
+    name: "{{ cs_resource_prefix }}-vm-cs-firewall"
+    zone: "{{ cs_common_zone_adv }}"
+    state: expunged
+  register: instance
+- name: verify instance cleanup
+  assert:
+    that:
+    - instance is successful
+
 - name: network cleanup
   cs_network:
     name: "{{ cs_firewall_network }}"
diff --git a/test/integration/targets/cs_ip_address/tasks/network.yml b/test/integration/targets/cs_ip_address/tasks/network.yml
index f6c707e51c..94fe8f05fc 100644
--- a/test/integration/targets/cs_ip_address/tasks/network.yml
+++ b/test/integration/targets/cs_ip_address/tasks/network.yml
@@ -17,6 +17,23 @@
     that:
     - base_network is successful
 
+- name: setup instance to get network in implementation state
+  cs_instance:
+    name: "{{ cs_resource_prefix }}-vm-cs-ip-address"
+    template: "{{ cs_common_template }}"
+    service_offering: "{{ cs_common_service_offering }}"
+    zone: "{{ cs_common_zone_adv }}"
+    networks:
+      - "{{ base_network.name }}"
+  register: instance
+  until: instance is success
+  retries: 10
+  delay: 5
+- name: verify instance setup
+  assert:
+    that:
+    - instance is successful
+
 - name: setup clean ip_address with tags
   cs_ip_address:
     state: absent
@@ -205,6 +222,17 @@
     - ip_address is successful
     - ip_address is not changed
 
+- name: cleanup instance
+  cs_instance:
+    name: "{{ cs_resource_prefix }}-vm-cs-ip-address"
+    zone: "{{ cs_common_zone_adv }}"
+    state: expunged
+  register: instance
+- name: verify instance cleanup
+  assert:
+    that:
+    - instance is successful
+
 - name: clean the test network
   cs_network:
     name: ipaddr_test_network
