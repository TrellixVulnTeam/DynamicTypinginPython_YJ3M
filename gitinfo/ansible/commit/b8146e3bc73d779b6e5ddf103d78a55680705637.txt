commit b8146e3bc73d779b6e5ddf103d78a55680705637
Author: James Tanner <tanner.jc@gmail.com>
Date:   Mon Nov 25 10:57:10 2013 -0500

    Fixes #4979 Check for the correct context when inside the inventory_hostnames plugin

diff --git a/lib/ansible/runner/lookup_plugins/inventory_hostnames.py b/lib/ansible/runner/lookup_plugins/inventory_hostnames.py
index 6880887d84..98523e1398 100644
--- a/lib/ansible/runner/lookup_plugins/inventory_hostnames.py
+++ b/lib/ansible/runner/lookup_plugins/inventory_hostnames.py
@@ -34,7 +34,10 @@ class LookupModule(object):
 
     def __init__(self, basedir=None, **kwargs):
         self.basedir = basedir
-        self.host_list = kwargs['runner'].inventory.host_list
+        if 'runner' in kwargs:
+            self.host_list = kwargs['runner'].inventory.host_list
+        else:
+            raise errors.AnsibleError("inventory_hostnames must be used as a loop. Example: \"with_inventory_hostnames: \'all\'\"")
 
     def run(self, terms, inject=None, **kwargs):
         terms = utils.listify_lookup_plugin_terms(terms, self.basedir, inject) 
