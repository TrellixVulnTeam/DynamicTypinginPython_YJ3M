commit a44ea2d1b7c1be234a898c1edf204602943564d5
Author: Toshio Kuratomi <a.badger@gmail.com>
Date:   Mon Sep 15 12:34:16 2014 -0700

    Do not keep a new file if we fail to set its attributes.

diff --git a/library/files/file b/library/files/file
index 82f4d5016d..8bfd94dd98 100644
--- a/library/files/file
+++ b/library/files/file
@@ -331,8 +331,16 @@ def main():
                     module.fail_json(path=path, msg='Error while touching existing target: %s' % str(e))
             else:
                 module.fail_json(msg='Cannot touch other than files and directories')
-
-            module.set_fs_attributes_if_different(file_args, True)
+            try:
+                module.set_fs_attributes_if_different(file_args, True)
+            except SystemExit as e:
+                if e.code:
+                    # We take this to mean that fail_json() was called from
+                    # somewhere in basic.py
+                    if prev_state == 'absent':
+                        # If we just created the file we can safely remove it
+                        os.remove(path)
+                raise e
 
         module.exit_json(dest=path, changed=True)
 
