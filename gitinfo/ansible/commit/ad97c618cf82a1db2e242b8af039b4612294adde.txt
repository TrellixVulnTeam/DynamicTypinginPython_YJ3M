commit ad97c618cf82a1db2e242b8af039b4612294adde
Author: James Cammarata <jimi@sngx.net>
Date:   Wed Jun 4 15:20:59 2014 -0500

    Add support for relative paths in the file lookup plugin for roles
    
    Fixes #7628

diff --git a/lib/ansible/runner/lookup_plugins/file.py b/lib/ansible/runner/lookup_plugins/file.py
index d5291c2267..70bae6653a 100644
--- a/lib/ansible/runner/lookup_plugins/file.py
+++ b/lib/ansible/runner/lookup_plugins/file.py
@@ -35,11 +35,25 @@ class LookupModule(object):
             terms = [ terms ]
 
         for term in terms:
-            path = utils.path_dwim(self.basedir, term)
-            if not os.path.exists(path):
-                raise errors.AnsibleError("%s does not exist" % path)
-
-            ret.append(codecs.open(path, encoding="utf8").read().rstrip())
-
+            basedir_path  = utils.path_dwim(self.basedir, term)
+            relative_path = None
+            playbook_path = None
+
+            # Special handling of the file lookup, used primarily when the
+            # lookup is done from a role. If the file isn't found in the
+            # basedir of the current file, use dwim_relative to look in the
+            # role/files/ directory, and finally the playbook directory
+            # itself (which will be relative to the current working dir)
+            if '_original_file' in inject:
+                relative_path = utils.path_dwim_relative(inject['_original_file'], 'files', term, self.basedir, check=False)
+            if 'playbook_dir' in inject:
+                playbook_path = os.path.join(inject['playbook_dir'], term)
+
+            for path in (basedir_path, relative_path, playbook_path):
+                if path and os.path.exists(path):
+                    ret.append(codecs.open(path, encoding="utf8").read().rstrip())
+                    break
+            else:
+                raise errors.AnsibleError("could not locate file in lookup: %s" % term)
 
         return ret
