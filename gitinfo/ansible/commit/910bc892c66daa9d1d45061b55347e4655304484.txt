commit 910bc892c66daa9d1d45061b55347e4655304484
Author: Sloane Hertel <shertel@redhat.com>
Date:   Thu May 3 07:48:29 2018 -0400

    ec2_ami: Properly delete snapshots (#39606)

diff --git a/lib/ansible/modules/cloud/amazon/ec2_ami.py b/lib/ansible/modules/cloud/amazon/ec2_ami.py
index 1b03ccd108..84c30a9667 100644
--- a/lib/ansible/modules/cloud/amazon/ec2_ami.py
+++ b/lib/ansible/modules/cloud/amazon/ec2_ami.py
@@ -496,7 +496,7 @@ def deregister_image(module, connection):
     snapshots = []
     if 'BlockDeviceMappings' in image:
         for mapping in image.get('BlockDeviceMappings'):
-            snapshot_id = mapping.get('SnapshotId')
+            snapshot_id = mapping.get('Ebs', {}).get('SnapshotId')
             if snapshot_id is not None:
                 snapshots.append(snapshot_id)
 
diff --git a/test/integration/targets/ec2_ami/tasks/main.yml b/test/integration/targets/ec2_ami/tasks/main.yml
index 66b73eb17c..921417ca2d 100644
--- a/test/integration/targets/ec2_ami/tasks/main.yml
+++ b/test/integration/targets/ec2_ami/tasks/main.yml
@@ -158,6 +158,7 @@
         that:
           - "result.changed"
           - "'image_id' not in result"
+          - "result.snapshots_deleted"
 
     # ============================================================
 
