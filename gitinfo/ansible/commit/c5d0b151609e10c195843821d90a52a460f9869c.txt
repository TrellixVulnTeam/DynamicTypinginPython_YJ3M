commit c5d0b151609e10c195843821d90a52a460f9869c
Author: Nathaniel Case <this.is@nathanielca.se>
Date:   Fri Jan 5 17:01:45 2018 -0500

    Fixes nxos_l2_interface tests (#34514)
    
    * Update nxos tests that got missed in the first pass
    
    * Add setup for setting interfaces to layer2

diff --git a/test/integration/targets/nxos_command/tests/common/negative.yaml b/test/integration/targets/nxos_command/tests/common/negative.yaml
index b41b83256d..fdc2aa54b6 100644
--- a/test/integration/targets/nxos_command/tests/common/negative.yaml
+++ b/test/integration/targets/nxos_command/tests/common/negative.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/negative.yaml"
+- debug: msg="START connection={{ ansible_connection }}/negative.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: run 11 commands
   nxos_command:
@@ -24,4 +26,4 @@
       - result.failed
 
 
-- debug: msg="END {{ connection.transport }}/negative.yaml"
+- debug: msg="END connection={{ ansible_connection }}/negative.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/backup.yaml b/test/integration/targets/nxos_config/tests/common/backup.yaml
index 04325b64fb..15340fd6d4 100644
--- a/test/integration/targets/nxos_config/tests/common/backup.yaml
+++ b/test/integration/targets/nxos_config/tests/common/backup.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/backup.yaml"
+- debug: msg="START connection={{ ansible_connection }}/backup.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 # Select interface for test
 - set_fact: intname="{{ nxos_int1 }}"
@@ -54,4 +56,4 @@
     that:
       - "backup_files.files is defined"
 
-- debug: msg="END {{ connection.transport }}/backup.yaml"
+- debug: msg="END connection={{ ansible_connection }}/backup.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/defaults.yaml b/test/integration/targets/nxos_config/tests/common/defaults.yaml
index f6df4f7404..d5fd8872a2 100644
--- a/test/integration/targets/nxos_config/tests/common/defaults.yaml
+++ b/test/integration/targets/nxos_config/tests/common/defaults.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/defaults.yaml"
+- debug: msg="START connection={{ ansible_connection }}/defaults.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 # Select interface for test
 - set_fact: intname="{{ nxos_int1 }}"
@@ -50,4 +52,4 @@
       - "result.changed == false"
       - "result.updates is not defined"
 
-- debug: msg="END {{ connection.transport }}/defaults.yaml"
+- debug: msg="END connection={{ ansible_connection }}/defaults.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/save.yaml b/test/integration/targets/nxos_config/tests/common/save.yaml
index bada8d4bf8..3df6c03f33 100644
--- a/test/integration/targets/nxos_config/tests/common/save.yaml
+++ b/test/integration/targets/nxos_config/tests/common/save.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/save.yaml"
+- debug: msg="START connection={{ ansible_connection }}/save.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 # Select interface for test
 - set_fact: intname="{{ nxos_int1 }}"
@@ -36,4 +38,4 @@
     that:
       - "result.changed == true"
 
-- debug: msg="END {{ connection.transport }}/save.yaml"
+- debug: msg="END connection={{ ansible_connection }}/save.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/src_basic.yaml b/test/integration/targets/nxos_config/tests/common/src_basic.yaml
index c1fcea7239..6d9693a045 100644
--- a/test/integration/targets/nxos_config/tests/common/src_basic.yaml
+++ b/test/integration/targets/nxos_config/tests/common/src_basic.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/src_basic.yaml"
+- debug: msg="START connection={{ ansible_connection }}/src_basic.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 # Select interface for test
 - set_fact: intname="{{ nxos_int1 }}"
@@ -48,4 +50,4 @@
 # https://github.com/ansible/ansible-modules-core/issues/4807
       - "result.updates is not defined"
 
-- debug: msg="END {{ connection.transport }}/src_basic.yaml"
+- debug: msg="END connection={{ ansible_connection }}/src_basic.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/src_invalid.yaml b/test/integration/targets/nxos_config/tests/common/src_invalid.yaml
index e7400e5789..850444136c 100644
--- a/test/integration/targets/nxos_config/tests/common/src_invalid.yaml
+++ b/test/integration/targets/nxos_config/tests/common/src_invalid.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/src_invalid.yaml"
+- debug: msg="START connection={{ ansible_connection }}/src_invalid.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 
 # Defend https://github.com/ansible/ansible-modules-core/issues/4797
@@ -16,4 +18,4 @@
       - "result.failed == true"
       - "result.msg == 'path specified in src not found'"
 
-- debug: msg="END {{ connection.transport }}/src_invalid.yaml"
+- debug: msg="END connection={{ ansible_connection }}/src_invalid.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/src_match_none.yaml b/test/integration/targets/nxos_config/tests/common/src_match_none.yaml
index b3843ad70a..070826ebb5 100644
--- a/test/integration/targets/nxos_config/tests/common/src_match_none.yaml
+++ b/test/integration/targets/nxos_config/tests/common/src_match_none.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/src_match_none.yaml"
+- debug: msg="START connection={{ ansible_connection }}/src_match_none.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 # Select interface for test
 - set_fact: intname="{{ nxos_int1 }}"
@@ -50,4 +52,4 @@
       - "result.changed == false"
       - "result.updates is not defined"
 
-- debug: msg="END {{ connection.transport }}/src_match_none.yaml"
+- debug: msg="END connection={{ ansible_connection }}/src_match_none.yaml"
diff --git a/test/integration/targets/nxos_config/tests/common/sublevel_block.yaml b/test/integration/targets/nxos_config/tests/common/sublevel_block.yaml
index 9cdd4fc48d..c70e8f51eb 100644
--- a/test/integration/targets/nxos_config/tests/common/sublevel_block.yaml
+++ b/test/integration/targets/nxos_config/tests/common/sublevel_block.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg='START {{ connection.transport }}/sublevel_block.yaml'
+- debug: msg='START connection={{ ansible_connection }}/sublevel_block.yaml'
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -54,4 +56,4 @@
     provider: "{{ connection }}"
     match: none
 
-- debug: msg='END {{ connection.transport }}/sublevel_block.yaml'
+- debug: msg='END connection={{ ansible_connection }}/sublevel_block.yaml'
diff --git a/test/integration/targets/nxos_config/tests/common/toplevel.yaml b/test/integration/targets/nxos_config/tests/common/toplevel.yaml
index ac5c1fbb23..44ba913ac5 100644
--- a/test/integration/targets/nxos_config/tests/common/toplevel.yaml
+++ b/test/integration/targets/nxos_config/tests/common/toplevel.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg='START {{ connection.transport }}/toplevel.yaml'
+- debug: msg='START connection={{ ansible_connection }}/toplevel.yaml'
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -34,4 +36,4 @@
     provider: "{{ connection }}"
     match: none
 
-- debug: msg='END {{ connection.transport }}/toplevel.yaml'
+- debug: msg='END connection={{ ansible_connection }}/toplevel.yaml'
diff --git a/test/integration/targets/nxos_config/tests/common/toplevel_nonidempotent.yaml b/test/integration/targets/nxos_config/tests/common/toplevel_nonidempotent.yaml
index 3bd8a4172b..73010acd21 100644
--- a/test/integration/targets/nxos_config/tests/common/toplevel_nonidempotent.yaml
+++ b/test/integration/targets/nxos_config/tests/common/toplevel_nonidempotent.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/nonidempotent.yaml"
+- debug: msg="START connection={{ ansible_connection }}/nonidempotent.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -36,4 +38,4 @@
     provider: "{{ connection }}"
     match: none
 
-- debug: msg="END {{ connection.transport }}/nonidempotent.yaml"
+- debug: msg="END connection={{ ansible_connection }}/nonidempotent.yaml"
diff --git a/test/integration/targets/nxos_facts/tests/common/all_facts.yaml b/test/integration/targets/nxos_facts/tests/common/all_facts.yaml
index 60939abab7..fdc0df2a2d 100644
--- a/test/integration/targets/nxos_facts/tests/common/all_facts.yaml
+++ b/test/integration/targets/nxos_facts/tests/common/all_facts.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/all_facts.yaml"
+- debug: msg="START connection={{ ansible_connection }}/all_facts.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 
 - name: test getting all facts
@@ -33,4 +35,4 @@
       - "result.ansible_facts.ansible_net_memfree_mb > 1"
       - "result.ansible_facts.ansible_net_memtotal_mb > 1"
 
-- debug: msg="END {{ connection.transport }}/all_facts.yaml"
+- debug: msg="END connection={{ ansible_connection }}/all_facts.yaml"
diff --git a/test/integration/targets/nxos_facts/tests/common/default_facts.yaml b/test/integration/targets/nxos_facts/tests/common/default_facts.yaml
index 45a94accef..7864856452 100644
--- a/test/integration/targets/nxos_facts/tests/common/default_facts.yaml
+++ b/test/integration/targets/nxos_facts/tests/common/default_facts.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/default_facts.yaml"
+- debug: msg="START connection={{ ansible_connection }}/default_facts.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 
 - name: test getting default facts
diff --git a/test/integration/targets/nxos_facts/tests/common/invalid_subset.yaml b/test/integration/targets/nxos_facts/tests/common/invalid_subset.yaml
index 93d0131d9b..bfb2d25134 100644
--- a/test/integration/targets/nxos_facts/tests/common/invalid_subset.yaml
+++ b/test/integration/targets/nxos_facts/tests/common/invalid_subset.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/invalid_subset.yaml"
+- debug: msg="START connection={{ ansible_connection }}/invalid_subset.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 
 - name: test invalid subset (foobar)
@@ -45,4 +47,4 @@
 
 
 
-- debug: msg="END {{ connection.transport }}/invalid_subset.yaml"
+- debug: msg="END connection={{ ansible_connection }}/invalid_subset.yaml"
diff --git a/test/integration/targets/nxos_facts/tests/common/not_hardware.yaml b/test/integration/targets/nxos_facts/tests/common/not_hardware.yaml
index 66dd0b1e78..a3070adb0f 100644
--- a/test/integration/targets/nxos_facts/tests/common/not_hardware.yaml
+++ b/test/integration/targets/nxos_facts/tests/common/not_hardware.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/not_hardware_facts.yaml"
+- debug: msg="START connection={{ ansible_connection }}/not_hardware_facts.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 
 - name: test not hardware
@@ -29,4 +31,4 @@
       # ... and not present
       - "result.ansible_facts.ansible_net_filesystems is not defined"
 
-- debug: msg="END {{ connection.transport }}/not_hardware_facts.yaml"
+- debug: msg="END connection={{ ansible_connection }}/not_hardware_facts.yaml"
diff --git a/test/integration/targets/nxos_feature/tests/common/configure.yaml b/test/integration/targets/nxos_feature/tests/common/configure.yaml
index edc4dd1858..add9763c76 100644
--- a/test/integration/targets/nxos_feature/tests/common/configure.yaml
+++ b/test/integration/targets/nxos_feature/tests/common/configure.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/configure.yaml"
+- debug: msg="START connection={{ ansible_connection }}/configure.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -57,4 +59,4 @@
     match: none
     provider: "{{ connection }}"
 
-- debug: msg="END {{ connection.transport }}/configure.yaml"
+- debug: msg="END connection={{ ansible_connection }}/configure.yaml"
diff --git a/test/integration/targets/nxos_feature/tests/common/invalid.yaml b/test/integration/targets/nxos_feature/tests/common/invalid.yaml
index dbdf6d3f41..a3915b2462 100644
--- a/test/integration/targets/nxos_feature/tests/common/invalid.yaml
+++ b/test/integration/targets/nxos_feature/tests/common/invalid.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/invalid.yaml"
+- debug: msg="START connection={{ ansible_connection }}/invalid.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: configure invalid feature name
   nxos_feature:
@@ -12,4 +14,4 @@
     that:
       - result.failed == true
 
-- debug: msg="END {{ connection.transport }}/invalid.yaml"
+- debug: msg="END connection={{ ansible_connection }}/invalid.yaml"
diff --git a/test/integration/targets/nxos_interface/tests/common/set_state_absent.yaml b/test/integration/targets/nxos_interface/tests/common/set_state_absent.yaml
index cdfba9d1e2..3eb1307863 100644
--- a/test/integration/targets/nxos_interface/tests/common/set_state_absent.yaml
+++ b/test/integration/targets/nxos_interface/tests/common/set_state_absent.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/set_state_absent.yaml"
+- debug: msg="START connection={{ ansible_connection }}/set_state_absent.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -29,4 +31,4 @@
     that:
       - "result.changed == false"
 
-- debug: msg="END {{ connection.transport }}/set_state_absent.yaml"
+- debug: msg="END connection={{ ansible_connection }}/set_state_absent.yaml"
diff --git a/test/integration/targets/nxos_interface/tests/common/set_state_present.yaml b/test/integration/targets/nxos_interface/tests/common/set_state_present.yaml
index 017518d562..986146597d 100644
--- a/test/integration/targets/nxos_interface/tests/common/set_state_present.yaml
+++ b/test/integration/targets/nxos_interface/tests/common/set_state_present.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/set_state_present.yaml"
+- debug: msg="START connection={{ ansible_connection }}/set_state_present.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -32,4 +34,4 @@
     that:
       - "result.changed == false"
 
-- debug: msg="END {{ connection.transport }}/set_state_present.yaml"
+- debug: msg="END connection={{ ansible_connection }}/set_state_present.yaml"
diff --git a/test/integration/targets/nxos_l2_interface/tasks/nxapi.yaml b/test/integration/targets/nxos_l2_interface/tasks/nxapi.yaml
index 378db2f016..68e96a2942 100644
--- a/test/integration/targets/nxos_l2_interface/tasks/nxapi.yaml
+++ b/test/integration/targets/nxos_l2_interface/tasks/nxapi.yaml
@@ -3,12 +3,14 @@
   find:
     paths: "{{ role_path }}/tests/common"
     patterns: "{{ testcase }}.yaml"
+  connection: local
   register: test_cases
 
 - name: collect nxapi test cases
   find:
     paths: "{{ role_path }}/tests/nxapi"
     patterns: "{{ testcase }}.yaml"
+  connection: local
   register: nxapi_cases
 
 - set_fact:
@@ -18,8 +20,8 @@
 - name: set test_items
   set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
 
-- name: run test case
-  include: "{{ test_case_to_run }} connection={{ nxapi }}"
+- name: run test cases (connection=local)
+  include: "{{ test_case_to_run }} ansible_connection=local connection={{ nxapi }}"
   with_items: "{{ test_items }}"
   loop_control:
     loop_var: test_case_to_run
diff --git a/test/integration/targets/nxos_l2_interface/tests/common/agg.yaml b/test/integration/targets/nxos_l2_interface/tests/common/agg.yaml
index 76620ddc0c..36b4ff7dc2 100644
--- a/test/integration/targets/nxos_l2_interface/tests/common/agg.yaml
+++ b/test/integration/targets/nxos_l2_interface/tests/common/agg.yaml
@@ -12,6 +12,13 @@
     vlan_range: "6,15"
     provider: "{{ connection }}"
 
+- name: Setup - Ensure interfaces are layer2
+  nxos_interface:
+    aggregate:
+      - { name: "{{ intname1 }}" }
+      - { name: "{{ intname2 }}" }
+    mode: layer2
+
 - name: Setup - Remove interface aggregate before testing
   nxos_l2_interface:
     aggregate:
diff --git a/test/integration/targets/nxos_l2_interface/tests/common/sanity.yaml b/test/integration/targets/nxos_l2_interface/tests/common/sanity.yaml
index f821dd79b6..243c035ba3 100644
--- a/test/integration/targets/nxos_l2_interface/tests/common/sanity.yaml
+++ b/test/integration/targets/nxos_l2_interface/tests/common/sanity.yaml
@@ -16,6 +16,11 @@
     provider: "{{ connection }}"
   ignore_errors: yes
 
+- name: Setup - Ensure interface is layer2
+  nxos_interface:
+    interface: "{{ intname }}"
+    mode: layer2
+
 - name: "Setup vlans"
   nxos_vlan:
     vlan_range: "5-10,20"
diff --git a/test/integration/targets/nxos_mtu/tests/common/set_mtu.yaml b/test/integration/targets/nxos_mtu/tests/common/set_mtu.yaml
index e944babe43..c8240e1c82 100644
--- a/test/integration/targets/nxos_mtu/tests/common/set_mtu.yaml
+++ b/test/integration/targets/nxos_mtu/tests/common/set_mtu.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/set_mtu.yaml"
+- debug: msg="START connection={{ ansible_connection }}/set_mtu.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - set_fact: testint="{{ nxos_int1 }}"
 
@@ -65,4 +67,4 @@
     match: none
     provider: "{{ connection }}"
 
-- debug: msg="END {{ connection.transport }}/set_mtu.yaml"
+- debug: msg="END connection={{ ansible_connection }}/set_mtu.yaml"
diff --git a/test/integration/targets/nxos_mtu/tests/common/set_sysmtu.yaml b/test/integration/targets/nxos_mtu/tests/common/set_sysmtu.yaml
index 2788106b37..d16ab8255b 100644
--- a/test/integration/targets/nxos_mtu/tests/common/set_sysmtu.yaml
+++ b/test/integration/targets/nxos_mtu/tests/common/set_sysmtu.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/sysmtu.yaml"
+- debug: msg="START connection={{ ansible_connection }}/sysmtu.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -55,4 +57,4 @@
     match: none
     provider: "{{ connection }}"
 
-- debug: msg="END {{ connection.transport }}/sysmtu.yaml"
+- debug: msg="END connection={{ ansible_connection }}/sysmtu.yaml"
diff --git a/test/integration/targets/nxos_pim_rp_address/tests/common/configure.yaml b/test/integration/targets/nxos_pim_rp_address/tests/common/configure.yaml
index d9d9b0230b..f7d746abd4 100644
--- a/test/integration/targets/nxos_pim_rp_address/tests/common/configure.yaml
+++ b/test/integration/targets/nxos_pim_rp_address/tests/common/configure.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }} nxos_pim_rp_address sanity"
+- debug: msg="START connection={{ ansible_connection }} nxos_pim_rp_address sanity"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - set_fact: bidir="false" 
   when: platform is search('N3K')
@@ -127,4 +129,4 @@
     - name: "Disable feature PIM"
       nxos_feature: *disable_feature
 
-- debug: msg="END {{ connection.transport }} nxos_pim_rp_address sanity"
+- debug: msg="END connection={{ ansible_connection }} nxos_pim_rp_address sanity"
diff --git a/test/integration/targets/nxos_system/tests/common/set_hostname.yaml b/test/integration/targets/nxos_system/tests/common/set_hostname.yaml
index 902452c169..a5d5eafab7 100644
--- a/test/integration/targets/nxos_system/tests/common/set_hostname.yaml
+++ b/test/integration/targets/nxos_system/tests/common/set_hostname.yaml
@@ -1,5 +1,7 @@
 ---
-- debug: msg="START {{ connection.transport }}/set_hostname.yaml"
+- debug: msg="START connection={{ ansible_connection }}/set_hostname.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
 
 - name: setup
   nxos_config:
@@ -33,4 +35,4 @@
     match: none
     provider: "{{ connection }}"
 
-- debug: msg="END {{ connection.transport }}/set_hostname.yaml"
+- debug: msg="END connection={{ ansible_connection }}/set_hostname.yaml"
