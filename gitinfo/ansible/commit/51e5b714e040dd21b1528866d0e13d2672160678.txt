commit 51e5b714e040dd21b1528866d0e13d2672160678
Author: Matt Clay <matt@mystile.com>
Date:   Mon Jan 13 13:09:33 2020 -0800

    Add test constraint for setuptools. (#66426)
    
    * Add test constraint for setuptools.
    
    * Update pip test to work on centos6 container.

diff --git a/changelogs/fragments/ansible-test-setuptools-constraint.yml b/changelogs/fragments/ansible-test-setuptools-constraint.yml
new file mode 100644
index 0000000000..8fb0d0551f
--- /dev/null
+++ b/changelogs/fragments/ansible-test-setuptools-constraint.yml
@@ -0,0 +1,2 @@
+bugfixes:
+    - ansible-test no longer tries to install ``setuptools`` 45+ on Python 2.x since those versions are unsupported
diff --git a/test/integration/targets/inventory_kubevirt_conformance/constraints.txt b/test/integration/targets/inventory_kubevirt_conformance/constraints.txt
new file mode 100644
index 0000000000..c44f44e9de
--- /dev/null
+++ b/test/integration/targets/inventory_kubevirt_conformance/constraints.txt
@@ -0,0 +1 @@
+setuptools < 45 ; python_version <= '2.7' # setuptools 45 and later require python 3.5 or later
diff --git a/test/integration/targets/inventory_kubevirt_conformance/runme.sh b/test/integration/targets/inventory_kubevirt_conformance/runme.sh
index 390f80cb54..47e0fb7162 100755
--- a/test/integration/targets/inventory_kubevirt_conformance/runme.sh
+++ b/test/integration/targets/inventory_kubevirt_conformance/runme.sh
@@ -9,7 +9,7 @@ fi
 set -eux
 
 source virtualenv.sh
-pip install openshift
+pip install openshift -c constraints.txt
 
 ./server.py &
 
diff --git a/test/integration/targets/pip/tasks/pip.yml b/test/integration/targets/pip/tasks/pip.yml
index 3dd451a630..19bd5d8138 100644
--- a/test/integration/targets/pip/tasks/pip.yml
+++ b/test/integration/targets/pip/tasks/pip.yml
@@ -496,7 +496,11 @@
 
   - name: install distribute in the virtualenv
     pip:
-      name: distribute
+      # using -c for constraints is not supported as long as tests are executed using the centos6 container
+      # since the pip version in the venv is not upgraded and is too old (6.0.8)
+      name:
+        - distribute
+        - setuptools<45  # setuptools 45 and later require python 3.5 or later
       virtualenv: "{{ output_dir }}/pipenv"
       state: present
 
diff --git a/test/lib/ansible_test/_data/requirements/constraints.txt b/test/lib/ansible_test/_data/requirements/constraints.txt
index 4d8d4e58c4..09225c32b3 100644
--- a/test/lib/ansible_test/_data/requirements/constraints.txt
+++ b/test/lib/ansible_test/_data/requirements/constraints.txt
@@ -37,6 +37,7 @@ lxml < 4.3.0 ; python_version < '2.7' # lxml 4.3.0 and later require python 2.7
 pyvmomi < 6.0.0 ; python_version < '2.7' # pyvmomi 6.0.0 and later require python 2.7 or later
 pyone == 1.1.9 # newer versions do not pass current integration tests
 botocore >= 1.10.0 # adds support for the following AWS services: secretsmanager, fms, and acm-pca
+setuptools < 45 ; python_version <= '2.7' # setuptools 45 and later require python 3.5 or later
 
 # freeze pylint and its requirements for consistent test results
 astroid == 2.2.5
