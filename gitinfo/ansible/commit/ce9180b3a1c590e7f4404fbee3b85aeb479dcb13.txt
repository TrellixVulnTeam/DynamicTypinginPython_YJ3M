commit ce9180b3a1c590e7f4404fbee3b85aeb479dcb13
Author: Peter Sprygada <privateip@users.noreply.github.com>
Date:   Sun Feb 19 17:37:16 2017 -0500

    roll up of vyos action fixes (#21642)
    
    * check cli context is not in config mode
    * add display messages for more details

diff --git a/lib/ansible/plugins/action/vyos.py b/lib/ansible/plugins/action/vyos.py
index 8a7aefc158..86e476a026 100644
--- a/lib/ansible/plugins/action/vyos.py
+++ b/lib/ansible/plugins/action/vyos.py
@@ -62,19 +62,24 @@ class ActionModule(_ActionModule):
         connection = self._shared_loader_obj.connection_loader.get('persistent', pc, sys.stdin)
 
         socket_path = self._get_socket_path(pc)
+        display.vvvv('socket_path: %s' % socket_path, pc.remote_addr)
+
         if not os.path.exists(socket_path):
             # start the connection if it isn't started
             rc, out, err = connection.exec_command('open_shell()')
             if rc != 0:
                 return {'failed': True, 'msg': 'unable to connect to control socket'}
+        else:
+            # make sure we are in the right cli context which should be
+            # enable mode and not config module
+            rc, out, err = connection.exec_command('prompt()')
+            while str(out).strip().endswith('#'):
+                display.debug('wrong context, sending exit to device', self._play_context.remote_addr)
+                connection.exec_command('exit')
+                rc, out, err = connection.exec_command('prompt()')
 
         task_vars['ansible_socket'] = socket_path
 
-        result = super(ActionModule, self).run(tmp, task_vars)
-
-        display.vvv('closing cli shell', self._play_context.remote_addr)
-        connection.exec_command('close_shell()')
-
         return super(ActionModule, self).run(tmp, task_vars)
 
     def _get_socket_path(self, play_context):
