commit e61c2799ff13b703b3a0d66f39004f46e4709b63
Author: Jordan Borean <jborean93@gmail.com>
Date:   Wed Oct 4 12:42:27 2017 +1100

    win_become: move error handling to Ansible outside of shell (#31227)
    
    * win_become: move error handling to Ansible outside of shell
    
    * trimmed the output so double newlines don't get set
    
    * added test for non-zero exit code
    
    * missed issue URL on test
    
    * changed exit to SetShouldExit

diff --git a/lib/ansible/plugins/shell/powershell.py b/lib/ansible/plugins/shell/powershell.py
index 1856973881..2787e9f61e 100644
--- a/lib/ansible/plugins/shell/powershell.py
+++ b/lib/ansible/plugins/shell/powershell.py
@@ -801,15 +801,8 @@ Function Run($payload) {
         # FUTURE: decode CLIXML stderr output (and other streams?)
 
         $rc = [Ansible.Shell.NativeProcessUtil]::GetProcessExitCode($pi.hProcess)
-
-        If ($rc -eq 0) {
-            $str_stdout
-            $str_stderr
-        }
-        Else {
-            Throw "failed, rc was $rc, stderr was $str_stderr, stdout was $str_stdout"
-        }
-
+        [Console]::Out.WriteLine($str_stdout.Trim())
+        [Console]::Error.WriteLine($str_stderr.Trim())
     }
     Catch {
         $excep = $_
@@ -818,7 +811,7 @@ Function Run($payload) {
     Finally {
         Remove-Item $temp -ErrorAction SilentlyContinue
     }
-
+    $host.SetShouldExit($rc)
 }
 
 '''  # end become_wrapper
diff --git a/test/integration/targets/win_become/tasks/main.yml b/test/integration/targets/win_become/tasks/main.yml
index 24f2eb0fbe..ef6c737145 100644
--- a/test/integration/targets/win_become/tasks/main.yml
+++ b/test/integration/targets/win_become/tasks/main.yml
@@ -70,6 +70,10 @@
       assert:
         that:
         - whoami_out.stdout_lines[0].endswith(become_test_username)
+  
+  - name: test with module that will return non-zero exit code (https://github.com/ansible/ansible/issues/30468)
+    vars: *become_vars
+    setup:
 
 # FUTURE: test raw + script become behavior once they're running under the exec wrapper again
 # FUTURE: add standalone playbook tests to include password prompting and play become keywords
