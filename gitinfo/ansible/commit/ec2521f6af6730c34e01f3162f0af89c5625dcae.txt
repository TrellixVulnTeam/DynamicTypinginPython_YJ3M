commit ec2521f6af6730c34e01f3162f0af89c5625dcae
Author: Alberto Murillo <alberto.murillo.silva@intel.com>
Date:   Sat Nov 26 16:55:38 2016 -0600

    Fix ssh plugin to correctly fetch files when using scp (#18614)
    
    Fetch module uses fetch_file() from plugin/connection/ssh.py to
    retrieve files from the remote hosts which in turns uses
    _file_transport_command(self, in_path, out_path, sftp_action) being
    sftp_action = 'get'
    
    When using scp rather than sftp, sftp_action variable is not used
    and the scp command is formed in a way that the file is always
    sent to the remote machine
    
    This patch fixes _file_transport_command() to correctly form the scp
    swaping src and dest if sftp_action is 'get'
    
    Bug introduced at 8e47b9b
    Fixes #18603
    
    Signed-off-by: Alberto Murillo Silva <alberto.murillo.silva@intel.com>

diff --git a/lib/ansible/plugins/connection/ssh.py b/lib/ansible/plugins/connection/ssh.py
index 62d1bdedf8..36b3e2610b 100644
--- a/lib/ansible/plugins/connection/ssh.py
+++ b/lib/ansible/plugins/connection/ssh.py
@@ -628,7 +628,10 @@ class Connection(ConnectionBase):
                 cmd = self._build_command('sftp', to_bytes(host))
                 in_data = u"{0} {1} {2}\n".format(sftp_action, shlex_quote(in_path), shlex_quote(out_path))
             elif method == 'scp':
-                cmd = self._build_command('scp', in_path, u'{0}:{1}'.format(host, shlex_quote(out_path)))
+                if sftp_action == 'get':
+                    cmd = self._build_command('scp', u'{0}:{1}'.format(host, shlex_quote(out_path)), in_path)
+                else:
+                    cmd = self._build_command('scp', in_path, u'{0}:{1}'.format(host, shlex_quote(out_path)))
                 in_data = None
 
             in_data = to_bytes(in_data, nonstring='passthru')
