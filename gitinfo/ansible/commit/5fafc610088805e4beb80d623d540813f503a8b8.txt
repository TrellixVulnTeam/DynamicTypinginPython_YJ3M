commit 5fafc610088805e4beb80d623d540813f503a8b8
Author: James Tanner <tanner.jc@gmail.com>
Date:   Tue Feb 4 13:31:22 2014 -0500

    Fixes 5870 Template delegate hostname earlier in the process

diff --git a/lib/ansible/runner/__init__.py b/lib/ansible/runner/__init__.py
index 2caffa72c1..b97c7f9496 100644
--- a/lib/ansible/runner/__init__.py
+++ b/lib/ansible/runner/__init__.py
@@ -304,7 +304,10 @@ class Runner(object):
        
         delegate = {}
 
-        delegate['host'] = host
+        # allow ansible_ssh_host to be templated
+        delegate['host'] = template.template(self.basedir, host, 
+                                remote_inject, fail_on_undefined=True)
+
         delegate['inject'] = remote_inject.copy()
 
         # set any interpreters
@@ -324,10 +327,6 @@ class Runner(object):
         # get the real ssh_address for the delegate        
         delegate['ssh_host'] = this_info.get('ansible_ssh_host', delegate['host'])
 
-        # allow ansible_ssh_host to be templated
-        delegate['host'] = template.template(self.basedir, this_host, 
-                                delegate['inject'], fail_on_undefined=True)
-
         delegate['port'] = this_info.get('ansible_ssh_port', port)
         delegate['user'] = self._compute_delegate_user(this_host, delegate['inject'])
         delegate['pass'] = this_info.get('ansible_ssh_pass', password)
