commit 42731ec73f349ead70b4f62b3d9eec4250bc1ffa
Author: Martin Krizek <martin.krizek@gmail.com>
Date:   Tue Mar 12 18:41:26 2019 +0100

    yum: fix disable_excludes in repoquery fallback (#53552)
    
    Fixes #53134

diff --git a/lib/ansible/modules/packaging/os/yum.py b/lib/ansible/modules/packaging/os/yum.py
index 52d33f275e..f765538a14 100644
--- a/lib/ansible/modules/packaging/os/yum.py
+++ b/lib/ansible/modules/packaging/os/yum.py
@@ -1555,6 +1555,23 @@ class YumModule(YumDnf):
                         if self.installroot != '/':
                             repoquery.extend(['--installroot', self.installroot])
 
+                        if self.disable_excludes:
+                            # repoquery does not support --disableexcludes,
+                            # so make a temp copy of yum.conf and get rid of the 'exclude=' line there
+                            try:
+                                with open('/etc/yum.conf', 'r') as f:
+                                    content = f.readlines()
+
+                                tmp_conf_file = tempfile.NamedTemporaryFile(dir=self.module.tmpdir, delete=False)
+                                self.module.add_cleanup_file(tmp_conf_file.name)
+
+                                tmp_conf_file.writelines([c for c in content if not c.startswith("exclude=")])
+                                tmp_conf_file.close()
+                            except Exception as e:
+                                self.module.fail_json(msg="Failure setting up repoquery: %s" % to_native(e))
+
+                            repoquery.extend(['-c', tmp_conf_file.name])
+
             results = self.ensure(repoquery)
             if repoquery:
                 results['msg'] = '%s %s' % (
