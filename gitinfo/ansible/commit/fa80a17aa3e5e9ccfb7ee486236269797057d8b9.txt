commit fa80a17aa3e5e9ccfb7ee486236269797057d8b9
Author: James Cammarata <jimi@sngx.net>
Date:   Tue Oct 1 16:50:32 2013 -0500

    Make recv_data less greedy so it doesn't eat other packets

diff --git a/lib/ansible/runner/connection_plugins/accelerate.py b/lib/ansible/runner/connection_plugins/accelerate.py
index 9e37802ee7..413f85e606 100644
--- a/lib/ansible/runner/connection_plugins/accelerate.py
+++ b/lib/ansible/runner/connection_plugins/accelerate.py
@@ -138,7 +138,7 @@ class Connection(object):
         try:
             vvvv("%s: in recv_data(), waiting for the header" % self.host)
             while len(data) < header_len:
-                d = self.conn.recv(1024)
+                d = self.conn.recv(header_len - len(data))
                 if not d:
                     vvvv("%s: received nothing, bailing out" % self.host)
                     return None
@@ -148,7 +148,7 @@ class Connection(object):
             data = data[header_len:]
             vvvv("%s: data received so far (expecting %d): %d" % (self.host,data_len,len(data)))
             while len(data) < data_len:
-                d = self.conn.recv(1024)
+                d = self.conn.recv(data_len - len(data))
                 if not d:
                     vvvv("%s: received nothing, bailing out" % self.host)
                     return None
diff --git a/library/utilities/accelerate b/library/utilities/accelerate
index 420d78bdbe..0cc29dc595 100644
--- a/library/utilities/accelerate
+++ b/library/utilities/accelerate
@@ -198,7 +198,7 @@ class ThreadedTCPRequestHandler(SocketServer.BaseRequestHandler):
         data = b""
         vvvv("in recv_data(), waiting for the header")
         while len(data) < header_len:
-            d = self.request.recv(1024)
+            d = self.request.recv(header_len - len(data))
             if not d:
                 vvv("received nothing, bailing out")
                 return None
@@ -208,7 +208,7 @@ class ThreadedTCPRequestHandler(SocketServer.BaseRequestHandler):
         data = data[header_len:]
         vvvv("data received so far (expecting %d): %d" % (data_len,len(data)))
         while len(data) < data_len:
-            d = self.request.recv(1024)
+            d = self.request.recv(data_len - len(data))
             if not d:
                 vvv("received nothing, bailing out")
                 return None
