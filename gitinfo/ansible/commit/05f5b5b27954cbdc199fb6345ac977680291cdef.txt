commit 05f5b5b27954cbdc199fb6345ac977680291cdef
Author: Juha Litola <juha.litola@iki.fi>
Date:   Fri Jan 25 13:29:39 2013 +0200

    Fixed add_key stalling indefinitely, and test code leaking into production setting

diff --git a/library/apt_key b/library/apt_key
index dcc4d12717..8e521a4751 100644
--- a/library/apt_key
+++ b/library/apt_key
@@ -105,7 +105,7 @@ def download_key(url):
 
 
 def add_key(key):
-    return call("apt-key add -", shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)
+    p = Popen("apt-key add -", shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)
     (_, _) = p.communicate(key)
 
     return p.returncode == 0
@@ -163,12 +163,12 @@ if 'ANSIBLE_TEST_APT_KEY' in environ:
         return extra
 
 
-if environ.get('ANSIBLE_TEST_APT_KEY') == 'none':
-    def key_present(key_id):
-        return False
-else:
-    def key_present(key_id):
-        return key_id == environ['ANSIBLE_TEST_APT_KEY']
+    if environ.get('ANSIBLE_TEST_APT_KEY') == 'none':
+        def key_present(key_id):
+            return False
+    else:
+        def key_present(key_id):
+            return key_id == environ['ANSIBLE_TEST_APT_KEY']
 
 
 def main():
