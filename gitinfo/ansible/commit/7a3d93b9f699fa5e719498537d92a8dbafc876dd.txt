commit 7a3d93b9f699fa5e719498537d92a8dbafc876dd
Author: John R Barker <john@johnrbarker.com>
Date:   Wed Oct 19 17:38:56 2016 +0100

    Run validate-modules from ansible/ansible@devel (#5257)
    
    * Run validate-modules from devel
    
    Use a clean dir for checkout
    
    typo
    
    Correct path
    
    validate-modules requires mock and voluptuous==0.8.8
    
    typo
    
    Ensure script is running
    
    Remove testing debug
    
    Install Ansible only once
    
    Install ansible and validate_modules requirements
    
    Now that we no longer pip install Ansible we need to manually install
    it's dependencies
    
    Debug
    
    Dependencies are listed in ansible/ansible
    
    debug
    
    submodules
    
    typo
    
    typo
    
    working
    
    * Matt's feedback
    
    * Use mktemp to checkout and delete directory after running
    
    * Single quotes

diff --git a/lib/ansible/modules/test/utils/shippable/sanity.sh b/lib/ansible/modules/test/utils/shippable/sanity.sh
index cc0830faec..84dab4c54b 100755
--- a/lib/ansible/modules/test/utils/shippable/sanity.sh
+++ b/lib/ansible/modules/test/utils/shippable/sanity.sh
@@ -6,6 +6,14 @@ install_deps="${INSTALL_DEPS:-}"
 
 cd "${source_root}"
 
+# FIXME REPOMERGE: No need to checkout ansible
+build_dir=$(mktemp -d)
+trap 'rm -rf "{$build_dir}"' EXIT
+
+git clone "https://github.com/ansible/ansible.git" "${build_dir}" --recursive
+source "${build_dir}/hacking/env-setup"
+# REPOMERGE: END
+
 if [ "${install_deps}" != "" ]; then
     add-apt-repository ppa:fkrull/deadsnakes
     apt-add-repository 'deb http://archive.ubuntu.com/ubuntu trusty-backports universe'
@@ -13,10 +21,14 @@ if [ "${install_deps}" != "" ]; then
 
     apt-get install -qq shellcheck python2.4
 
-    pip install git+https://github.com/ansible/ansible.git@devel#egg=ansible
-    pip install git+https://github.com/sivel/ansible-testing.git#egg=ansible_testing
+    # Install dependencies for ansible and validate_modules
+    pip install -r "${build_dir}/test/utils/shippable/sanity-requirements.txt" --upgrade
+    pip list
+
 fi
 
+validate_modules="${build_dir}/test/sanity/validate-modules/validate-modules"
+
 python2.4 -m compileall -fq   -i                    "test/utils/shippable/sanity-test-python24.txt"
 python2.4 -m compileall -fq   -x "($(printf %s "$(< "test/utils/shippable/sanity-skip-python24.txt"))" | tr '\n' '|')" .
 python2.6 -m compileall -fq .
@@ -24,7 +36,7 @@ python2.7 -m compileall -fq .
 python3.5 -m compileall -fq . -x "($(printf %s "$(< "test/utils/shippable/sanity-skip-python3.txt"))"  | tr '\n' '|')"
 
 ANSIBLE_DEPRECATION_WARNINGS=false \
-    ansible-validate-modules --exclude '/utilities/|/shippable(/|$)' .
+    "${validate_modules}" --exclude '/utilities/|/shippable(/|$)' .
 
 shellcheck \
     test/utils/shippable/*.sh
