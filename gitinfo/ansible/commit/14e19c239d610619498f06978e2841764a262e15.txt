commit 14e19c239d610619498f06978e2841764a262e15
Author: James Cammarata <jimi@sngx.net>
Date:   Wed Dec 9 14:51:43 2015 -0500

    Make on_file_diff callback item-aware

diff --git a/lib/ansible/plugins/callback/__init__.py b/lib/ansible/plugins/callback/__init__.py
index 03eb58d99d..b8a48943f2 100644
--- a/lib/ansible/plugins/callback/__init__.py
+++ b/lib/ansible/plugins/callback/__init__.py
@@ -59,6 +59,10 @@ class CallbackBase:
             version = getattr(self, 'CALLBACK_VERSION', '1.0')
             self._display.vvvv('Loaded callback %s of type %s, v%s' % (name, ctype, version))
 
+    def _copy_result(self, result):
+        ''' helper for callbacks, so they don't all have to include deepcopy '''
+        return deepcopy(result)
+
     def _dump_results(self, result, indent=None, sort_keys=True, keep_invocation=False):
         if result.get('_ansible_no_log', False):
             return json.dumps(dict(censored="the output has been hidden due to the fact that 'no_log: true' was specified for this result"))
@@ -126,7 +130,7 @@ class CallbackBase:
 
     def _process_items(self, result):
         for res in result._result['results']:
-            newres = deepcopy(result)
+            newres = self._copy_result(result)
             res['item'] = self._get_item(res)
             newres._result = res
             if 'failed' in res and res['failed']:
diff --git a/lib/ansible/plugins/callback/default.py b/lib/ansible/plugins/callback/default.py
index 3175bf3e53..1f37f4b975 100644
--- a/lib/ansible/plugins/callback/default.py
+++ b/lib/ansible/plugins/callback/default.py
@@ -134,7 +134,14 @@ class CallbackModule(CallbackBase):
         self._display.banner(msg)
 
     def v2_on_file_diff(self, result):
-        if 'diff' in result._result and result._result['diff']:
+        if result._task.loop and 'results' in result._result:
+            for res in result._result['results']:
+                newres = self._copy_result(result)
+                res['item'] = self._get_item(res)
+                newres._result = res
+
+                self.v2_on_file_diff(newres)
+        elif 'diff' in result._result and result._result['diff']:
             self._display.display(self._get_diff(result._result['diff']))
 
     def v2_playbook_item_on_ok(self, result):
diff --git a/lib/ansible/plugins/callback/skippy.py b/lib/ansible/plugins/callback/skippy.py
index 15b7d3387c..495943417f 100644
--- a/lib/ansible/plugins/callback/skippy.py
+++ b/lib/ansible/plugins/callback/skippy.py
@@ -123,7 +123,14 @@ class CallbackModule(CallbackBase):
         self._display.banner(msg)
 
     def v2_on_file_diff(self, result):
-        if 'diff' in result._result and result._result['diff']:
+        if result._task.loop and 'results' in result._result:
+            for res in result._result['results']:
+                newres = self._copy_result(result)
+                res['item'] = self._get_item(res)
+                newres._result = res
+
+                self.v2_on_file_diff(newres)
+        elif 'diff' in result._result and result._result['diff']:
             self._display.display(self._get_diff(result._result['diff']))
 
     def v2_playbook_item_on_ok(self, result):
diff --git a/lib/ansible/plugins/strategy/__init__.py b/lib/ansible/plugins/strategy/__init__.py
index 732a9293d2..15636b580d 100644
--- a/lib/ansible/plugins/strategy/__init__.py
+++ b/lib/ansible/plugins/strategy/__init__.py
@@ -221,7 +221,7 @@ class StrategyBase:
                                 self._tqm._stats.increment('changed', host.name)
                             self._tqm.send_callback('v2_runner_on_ok', task_result)
 
-                        if self._diff and 'diff' in task_result._result:
+                        if self._diff:
                             self._tqm.send_callback('v2_on_file_diff', task_result)
 
                     self._pending_results -= 1
