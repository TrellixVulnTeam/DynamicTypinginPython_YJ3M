commit 3922b6cc93af716636bd5fada454b1799192e21a
Author: Martin Krizek <martin.krizek@gmail.com>
Date:   Tue Apr 17 10:17:29 2018 +0200

    apt: integration tests for #31577 (#38586)

diff --git a/test/integration/targets/apt/tasks/repo.yml b/test/integration/targets/apt/tasks/repo.yml
index d38f8f6759..af2613e2db 100644
--- a/test/integration/targets/apt/tasks/repo.yml
+++ b/test/integration/targets/apt/tasks/repo.yml
@@ -141,6 +141,44 @@
       that:
         - "autoclean_result is not changed"
 
+  # https://github.com/ansible/ansible/issues/30638
+  - name: Fail to install foo=1.0.1 since foo is not installed and only_upgrade is set
+    apt:
+      name: foo=1.0.1
+      state: installed
+      only_upgrade: yes
+      allow_unauthenticated: yes
+    ignore_errors: yes
+    register: apt_result
+
+  - name: Check that foo was not upgraded
+    assert:
+      that:
+        - "apt_result is not changed"
+
+  - apt:
+      name: foo=1.0.0
+      allow_unauthenticated: yes
+
+  - name: Upgrade foo to 1.0.1
+    apt:
+      name: foo=1.0.1
+      state: installed
+      only_upgrade: yes
+      allow_unauthenticated: yes
+    register: apt_result
+
+  - name: Check install with dpkg
+    shell: dpkg-query -l foo
+    register: dpkg_result
+
+  - name: Check if install was successful
+    assert:
+      that:
+        - "apt_result is success"
+        - "dpkg_result is success"
+        - "'1.0.1' in dpkg_result.stdout"
+
   always:
     - name: Clean up
       apt:
