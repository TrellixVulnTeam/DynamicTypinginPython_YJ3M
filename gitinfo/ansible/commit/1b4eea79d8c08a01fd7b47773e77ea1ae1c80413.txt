commit 1b4eea79d8c08a01fd7b47773e77ea1ae1c80413
Author: Hans-Joachim Kliemeck <h0nIg@users.noreply.github.com>
Date:   Thu Oct 27 11:56:08 2016 +0200

    win_nssm: set application directory on change of application binary (#3267)

diff --git a/lib/ansible/modules/extras/windows/win_nssm.ps1 b/lib/ansible/modules/extras/windows/win_nssm.ps1
index 2c7db8dfa7..3ea4a211c3 100644
--- a/lib/ansible/modules/extras/windows/win_nssm.ps1
+++ b/lib/ansible/modules/extras/windows/win_nssm.ps1
@@ -95,6 +95,9 @@ Function Nssm-Install
     {
         Throw "Error installing service ""$name"". No application was supplied."
     }
+    If (-Not (Test-Path -Path $application -PathType Leaf)) {
+        Throw "$application does not exist on the host"
+    }
 
     if (!(Service-Exists -name $name))
     {
@@ -138,6 +141,21 @@ Function Nssm-Install
             $result.changed = $true
         }
      }
+
+     if ($result.changed)
+     {
+        $applicationPath = (Get-Item $application).DirectoryName
+        $cmd = "nssm set ""$name"" AppDirectory $applicationPath"
+
+        $results = invoke-expression $cmd
+
+        if ($LastExitCode -ne 0)
+        {
+            Set-Attr $result "nssm_error_cmd" $cmd
+            Set-Attr $result "nssm_error_log" "$results"
+            Throw "Error installing service ""$name"""
+        }
+     }
 }
 
 Function ParseAppParameters()
