commit 00ead98595577f110165d2c87c6c5c38c27b4b74
Author: Andrew Klychkov <aaklychkov@mail.ru>
Date:   Tue Jun 2 18:52:12 2020 +0300

    systemd: should fail in check_mode when service not found on host (#68136)
    
    * systemd: should fail in check_mode when service not found on host

diff --git a/changelogs/fragments/68136-systemd_should_fail_in_check_mode_when_service_not_found.yml b/changelogs/fragments/68136-systemd_should_fail_in_check_mode_when_service_not_found.yml
new file mode 100644
index 0000000000..eee15151f4
--- /dev/null
+++ b/changelogs/fragments/68136-systemd_should_fail_in_check_mode_when_service_not_found.yml
@@ -0,0 +1,2 @@
+bugfixes:
+- systemd - the module should fail in check_mode when service not found on host (https://github.com/ansible/ansible/pull/68136).
diff --git a/lib/ansible/module_utils/service.py b/lib/ansible/module_utils/service.py
index 9b0c65310a..3e57b0217b 100644
--- a/lib/ansible/module_utils/service.py
+++ b/lib/ansible/module_utils/service.py
@@ -114,10 +114,7 @@ def fail_if_missing(module, found, service, msg=''):
     :kw msg: extra info to append to error/success msg when missing
     '''
     if not found:
-        if module.check_mode:
-            module.exit_json(msg="Service %s not found on %s, assuming it will exist on full run" % (service, msg), changed=True)
-        else:
-            module.fail_json(msg='Could not find the requested service %s: %s' % (service, msg))
+        module.fail_json(msg='Could not find the requested service %s: %s' % (service, msg))
 
 
 def fork_process():
diff --git a/test/integration/targets/service/tasks/tests.yml b/test/integration/targets/service/tasks/tests.yml
index fd66918b07..de66bf5ca7 100644
--- a/test/integration/targets/service/tasks/tests.yml
+++ b/test/integration/targets/service/tasks/tests.yml
@@ -194,3 +194,32 @@
     that:
       - "remove_result.path == '/usr/sbin/ansible_test_service'"
       - "remove_result.state == 'absent'"
+
+- name: the module must fail when a service is not found
+  service:
+    name: 'nonexisting'
+    state: stopped
+  register: result
+  ignore_errors: yes
+  when: ansible_distribution != 'FreeBSD'
+
+- assert:
+    that:
+      - result is failed
+      - result is search("Could not find the requested service nonexisting")
+  when: ansible_distribution != 'FreeBSD'
+
+- name: the module must fail in check_mode as well when a service is not found
+  service:
+    name: 'nonexisting'
+    state: stopped
+  register: result
+  check_mode: yes
+  ignore_errors: yes
+  when: ansible_distribution != 'FreeBSD'
+
+- assert:
+    that:
+      - result is failed
+      - result is search("Could not find the requested service nonexisting")
+  when: ansible_distribution != 'FreeBSD'
diff --git a/test/integration/targets/systemd/defaults/main.yml b/test/integration/targets/systemd/defaults/main.yml
new file mode 100644
index 0000000000..33063b86d9
--- /dev/null
+++ b/test/integration/targets/systemd/defaults/main.yml
@@ -0,0 +1 @@
+fake_service: nonexisting
diff --git a/test/integration/targets/systemd/tasks/main.yml b/test/integration/targets/systemd/tasks/main.yml
index a3078540ec..282988b356 100644
--- a/test/integration/targets/systemd/tasks/main.yml
+++ b/test/integration/targets/systemd/tasks/main.yml
@@ -47,4 +47,29 @@
               - 'not systemd_test0.changed'
               - 'systemd_test0.state == "started"'
 
+    - name: the module must fail when a service is not found
+      systemd:
+          name: '{{ fake_service }}'
+          state: stopped
+      register: result
+      ignore_errors: yes
+
+    - assert:
+          that:
+              - result is failed
+              - result is search("Could not find the requested service {{ fake_service }}")
+
+    - name: the module must fail in check_mode as well when a service is not found
+      systemd:
+          name: '{{ fake_service }}'
+          state: stopped
+      register: result
+      check_mode: yes
+      ignore_errors: yes
+
+    - assert:
+          that:
+              - result is failed
+              - result is search("Could not find the requested service {{ fake_service }}")
+
   when: 'systemctl_check.rc == 0'
