commit 654d2d3f60f3ff12f5dc7a3aea1a31d48a3ccaff
Author: Vyronas Tsingaras <vtsingaras@it.auth.gr>
Date:   Fri Jun 19 13:04:19 2015 +0300

    This enable one to find a datastore with no config_target supplied
    
    Signed-off-by: Vyronas Tsingaras <vtsingaras@it.auth.gr>

diff --git a/lib/ansible/modules/cloud/vmware/vsphere_guest.py b/lib/ansible/modules/cloud/vmware/vsphere_guest.py
index 2f38511521..f90513abb3 100644
--- a/lib/ansible/modules/cloud/vmware/vsphere_guest.py
+++ b/lib/ansible/modules/cloud/vmware/vsphere_guest.py
@@ -410,13 +410,21 @@ def add_nic(module, s, nfmor, config, devices, nic_type="vmxnet3", network_name=
 def find_datastore(module, s, datastore, config_target):
     # Verify the datastore exists and put it in brackets if it does.
     ds = None
-    for d in config_target.Datastore:
-        if (d.Datastore.Accessible and
-            (datastore and d.Datastore.Name == datastore)
-                or (not datastore)):
-            ds = d.Datastore.Datastore
-            datastore = d.Datastore.Name
-            break
+    if config_target:
+        for d in config_target.Datastore:
+            if (d.Datastore.Accessible and
+                (datastore and d.Datastore.Name == datastore)
+                    or (not datastore)):
+                ds = d.Datastore.Datastore
+                datastore = d.Datastore.Name
+                break
+    else:
+        for ds_mor, ds_name in server.get_datastores().items():
+            ds_props = VIProperty(s, ds_mor)
+            if (ds_props.summary.accessible and (datastore and ds_name == datastore)
+                    or (not datastore)):
+                ds = ds_mor
+                datastore = ds_name
     if not ds:
         s.disconnect()
         module.fail_json(msg="Datastore: %s does not appear to exist" %
