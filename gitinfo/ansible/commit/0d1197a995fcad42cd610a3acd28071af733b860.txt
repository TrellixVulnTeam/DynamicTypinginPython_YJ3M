commit 0d1197a995fcad42cd610a3acd28071af733b860
Author: Chris Church <chris@ninemoreminutes.com>
Date:   Thu Aug 28 01:42:22 2014 -0400

    Replace Get-FileHash with MD5 code that works on PowerShell 3.

diff --git a/lib/ansible/runner/shell_plugins/powershell.py b/lib/ansible/runner/shell_plugins/powershell.py
index be005aa7af..7254df6f7e 100644
--- a/lib/ansible/runner/shell_plugins/powershell.py
+++ b/lib/ansible/runner/shell_plugins/powershell.py
@@ -89,7 +89,10 @@ class ShellModule(object):
         script = '''
             If (Test-Path -PathType Leaf "%(path)s")
             {
-                (Get-FileHash -Path "%(path)s" -Algorithm MD5).Hash.ToLower();
+                $sp = new-object -TypeName System.Security.Cryptography.MD5CryptoServiceProvider;
+                $fp = [System.IO.File]::Open("%(path)s", [System.IO.Filemode]::Open, [System.IO.FileAccess]::Read);
+                [System.BitConverter]::ToString($sp.ComputeHash($fp)).Replace("-", "").ToLower();
+                $fp.Dispose();
             }
             ElseIf (Test-Path -PathType Container "%(path)s")
             {
diff --git a/library/windows/win_stat.ps1 b/library/windows/win_stat.ps1
index f60bc577ec..4e4c55b2aa 100644
--- a/library/windows/win_stat.ps1
+++ b/library/windows/win_stat.ps1
@@ -34,27 +34,30 @@ $result = New-Object psobject @{
 
 If (Test-Path $path)
 {
-   Set-Attr $result.stat "exists" $TRUE;
-   $info = Get-Item $path;
-   If ($info.Directory) # Only files have the .Directory attribute.
-   {
-      Set-Attr $result.stat "isdir" $FALSE;
-      Set-Attr $result.stat "size" $info.Length;
-   }
-   Else
-   {
-      Set-Attr $result.stat "isdir" $TRUE;
-   }
+    Set-Attr $result.stat "exists" $TRUE;
+    $info = Get-Item $path;
+    If ($info.Directory) # Only files have the .Directory attribute.
+    {
+        Set-Attr $result.stat "isdir" $FALSE;
+        Set-Attr $result.stat "size" $info.Length;
+    }
+    Else
+    {
+        Set-Attr $result.stat "isdir" $TRUE;
+    }
 }
 Else
 {
-   Set-Attr $result.stat "exists" $FALSE;
+    Set-Attr $result.stat "exists" $FALSE;
 }
 
 If ($get_md5 -and $result.stat.exists -and -not $result.stat.isdir)
 {
-   $path_md5 = (Get-FileHash -Path $path -Algorithm MD5).Hash.ToLower();
-   Set-Attr $result.stat "md5" $path_md5;
+    $sp = new-object -TypeName System.Security.Cryptography.MD5CryptoServiceProvider;
+    $fp = [System.IO.File]::Open($path, [System.IO.Filemode]::Open, [System.IO.FileAccess]::Read);
+    $hash = [System.BitConverter]::ToString($sp.ComputeHash($fp)).Replace("-", "").ToLower();
+    $fp.Dispose();
+    Set-Attr $result.stat "md5" $hash;
 }
 
 Exit-Json $result;
