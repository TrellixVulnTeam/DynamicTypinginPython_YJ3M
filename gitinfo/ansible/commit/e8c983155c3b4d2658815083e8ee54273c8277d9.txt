commit e8c983155c3b4d2658815083e8ee54273c8277d9
Author: ftntcorecse <43451990+ftntcorecse@users.noreply.github.com>
Date:   Wed Feb 27 10:38:28 2019 -0500

    FortiManager Plugin Module Conversion: fmgr_secprof_profile_group (#52772)
    
    * Auto Commit for: fmgr_secprof_profile_group
    
    * Auto Commit for: fmgr_secprof_profile_group

diff --git a/lib/ansible/modules/network/fortimanager/fmgr_secprof_profile_group.py b/lib/ansible/modules/network/fortimanager/fmgr_secprof_profile_group.py
index 591d481b5e..a40556e209 100644
--- a/lib/ansible/modules/network/fortimanager/fmgr_secprof_profile_group.py
+++ b/lib/ansible/modules/network/fortimanager/fmgr_secprof_profile_group.py
@@ -27,6 +27,8 @@ DOCUMENTATION = '''
 ---
 module: fmgr_secprof_profile_group
 version_added: "2.8"
+notes:
+    - Full Documentation at U(https://ftnt-ansible-docs.readthedocs.io/en/latest/).
 author:
     - Luke Weighall (@lweighall)
     - Andrew Welsh (@Ghilli3)
@@ -42,21 +44,6 @@ options:
     required: false
     default: root
 
-  host:
-    description:
-      - The FortiManager's address.
-    required: true
-
-  username:
-    description:
-      - The username associated with the account.
-    required: true
-
-  password:
-    description:
-      - The password associated with the username account.
-    required: true
-
   mode:
     description:
       - Sets one of three modes for managing the object.
@@ -161,17 +148,11 @@ options:
 EXAMPLES = '''
   - name: DELETE Profile
     fmgr_secprof_profile_group:
-      host: "{{inventory_hostname}}"
-      username: "{{ username }}"
-      password: "{{ password }}"
       name: "Ansible_TEST_Profile_Group"
       mode: "delete"
 
   - name: CREATE Profile
     fmgr_secprof_profile_group:
-      host: "{{inventory_hostname}}"
-      username: "{{ username }}"
-      password: "{{ password }}"
       name: "Ansible_TEST_Profile_Group"
       mode: "set"
       av_profile: "Ansible_AV_Profile"
@@ -186,23 +167,30 @@ api_result:
 """
 
 from ansible.module_utils.basic import AnsibleModule, env_fallback
-from ansible.module_utils.network.fortimanager.fortimanager import AnsibleFortiManager
+from ansible.module_utils.connection import Connection
+from ansible.module_utils.network.fortimanager.fortimanager import FortiManagerHandler
+from ansible.module_utils.network.fortimanager.common import FMGBaseException
+from ansible.module_utils.network.fortimanager.common import FMGRCommon
+from ansible.module_utils.network.fortimanager.common import FMGRMethods
+from ansible.module_utils.network.fortimanager.common import DEFAULT_RESULT_OBJ
+from ansible.module_utils.network.fortimanager.common import FAIL_SOCKET_MSG
+from ansible.module_utils.network.fortimanager.common import prepare_dict
+from ansible.module_utils.network.fortimanager.common import scrub_dict
 
-# check for pyFMG lib
-try:
-    from pyFMG.fortimgr import FortiManager
-    HAS_PYFMGR = True
-except ImportError:
-    HAS_PYFMGR = False
 
 ###############
 # START METHODS
 ###############
 
 
-def fmgr_firewall_profile_group_addsetdelete(fmg, paramgram):
+def fmgr_firewall_profile_group_modify(fmgr, paramgram):
     """
-    fmgr_firewall_profile_group -- Your Description here, bruh
+    :param fmgr: The fmgr object instance from fortimanager.py
+    :type fmgr: class object
+    :param paramgram: The formatted dictionary of options to process
+    :type paramgram: dict
+    :return: The response from the FortiManager
+    :rtype: dict
     """
 
     mode = paramgram["mode"]
@@ -210,12 +198,12 @@ def fmgr_firewall_profile_group_addsetdelete(fmg, paramgram):
     url = ""
     datagram = {}
 
-    response = (-100000, {"msg": "Illegal or malformed paramgram discovered. System Exception"})
+    response = DEFAULT_RESULT_OBJ
 
     # EVAL THE MODE PARAMETER FOR SET OR ADD
     if mode in ['set', 'add', 'update']:
         url = '/pm/config/adom/{adom}/obj/firewall/profile-group'.format(adom=adom)
-        datagram = fmgr_del_none(fmgr_prepare_dict(paramgram))
+        datagram = scrub_dict(prepare_dict(paramgram))
 
     # EVAL THE MODE PARAMETER FOR DELETE
     elif mode == "delete":
@@ -223,128 +211,11 @@ def fmgr_firewall_profile_group_addsetdelete(fmg, paramgram):
         url = '/pm/config/adom/{adom}/obj/firewall/profile-group/{name}'.format(adom=adom, name=paramgram["name"])
         datagram = {}
 
-    # IF MODE = SET -- USE THE 'SET' API CALL MODE
-    if mode == "set":
-        response = fmg.set(url, datagram)
-    # IF MODE = UPDATE -- USER THE 'UPDATE' API CALL MODE
-    elif mode == "update":
-        response = fmg.update(url, datagram)
-    # IF MODE = ADD  -- USE THE 'ADD' API CALL MODE
-    elif mode == "add":
-        response = fmg.add(url, datagram)
-    # IF MODE = DELETE  -- USE THE DELETE URL AND API CALL MODE
-    elif mode == "delete":
-        response = fmg.delete(url, datagram)
+    response = fmgr.process_request(url, datagram, paramgram["mode"])
 
     return response
 
 
-# ADDITIONAL COMMON FUNCTIONS
-# FUNCTION/METHOD FOR LOGGING OUT AND ANALYZING ERROR CODES
-def fmgr_logout(fmg, module, msg="NULL", results=(), good_codes=(0,), logout_on_fail=True, logout_on_success=False):
-    """
-    THIS METHOD CONTROLS THE LOGOUT AND ERROR REPORTING AFTER AN METHOD OR FUNCTION RUNS
-    """
-
-    # VALIDATION ERROR (NO RESULTS, JUST AN EXIT)
-    if msg != "NULL" and len(results) == 0:
-        try:
-            fmg.logout()
-        except BaseException:
-            pass
-        module.fail_json(msg=msg)
-
-    # SUBMISSION ERROR
-    if len(results) > 0:
-        if msg == "NULL":
-            try:
-                msg = results[1]['status']['message']
-            except BaseException:
-                msg = "No status message returned from pyFMG. Possible that this was a GET with a tuple result."
-
-            if results[0] not in good_codes:
-                if logout_on_fail:
-                    fmg.logout()
-                    module.fail_json(msg=msg, **results[1])
-                else:
-                    return msg
-            else:
-                if logout_on_success:
-                    fmg.logout()
-                    module.exit_json(msg=msg, **results[1])
-                else:
-                    return msg
-
-
-# FUNCTION/METHOD FOR CONVERTING CIDR TO A NETMASK
-# DID NOT USE IP ADDRESS MODULE TO KEEP INCLUDES TO A MINIMUM
-def fmgr_cidr_to_netmask(cidr):
-    cidr = int(cidr)
-    mask = (0xffffffff >> (32 - cidr)) << (32 - cidr)
-    return(str((0xff000000 & mask) >> 24) + '.' +
-           str((0x00ff0000 & mask) >> 16) + '.' +
-           str((0x0000ff00 & mask) >> 8) + '.' +
-           str((0x000000ff & mask)))
-
-
-# utility function: removing keys wih value of None, nothing in playbook for that key
-def fmgr_del_none(obj):
-    if isinstance(obj, dict):
-        return type(obj)((fmgr_del_none(k), fmgr_del_none(v))
-                         for k, v in obj.items() if k is not None and (v is not None and not fmgr_is_empty_dict(v)))
-    else:
-        return obj
-
-
-# utility function: remove keys that are need for the logic but the FMG API won't accept them
-def fmgr_prepare_dict(obj):
-    list_of_elems = ["mode", "adom", "host", "username", "password"]
-    if isinstance(obj, dict):
-        obj = dict((key, fmgr_prepare_dict(value)) for (key, value) in obj.items() if key not in list_of_elems)
-    return obj
-
-
-def fmgr_is_empty_dict(obj):
-    return_val = False
-    if isinstance(obj, dict):
-        if len(obj) > 0:
-            for k, v in obj.items():
-                if isinstance(v, dict):
-                    if len(v) == 0:
-                        return_val = True
-                    elif len(v) > 0:
-                        for k1, v1 in v.items():
-                            if v1 is None:
-                                return_val = True
-                            elif v1 is not None:
-                                return_val = False
-                                return return_val
-                elif v is None:
-                    return_val = True
-                elif v is not None:
-                    return_val = False
-                    return return_val
-        elif len(obj) == 0:
-            return_val = True
-
-    return return_val
-
-
-def fmgr_split_comma_strings_into_lists(obj):
-    if isinstance(obj, dict):
-        if len(obj) > 0:
-            for k, v in obj.items():
-                if isinstance(v, str):
-                    new_list = list()
-                    if "," in v:
-                        new_items = v.split(",")
-                        for item in new_items:
-                            new_list.append(item.strip())
-                        obj[k] = new_list
-
-    return obj
-
-
 #############
 # END METHODS
 #############
@@ -353,9 +224,6 @@ def fmgr_split_comma_strings_into_lists(obj):
 def main():
     argument_spec = dict(
         adom=dict(type="str", default="root"),
-        host=dict(required=True, type="str"),
-        password=dict(fallback=(env_fallback, ["ANSIBLE_NET_PASSWORD"]), no_log=True, required=True),
-        username=dict(fallback=(env_fallback, ["ANSIBLE_NET_USERNAME"]), no_log=True, required=True),
         mode=dict(choices=["add", "set", "delete", "update"], type="str", default="add"),
 
         webfilter_profile=dict(required=False, type="str"),
@@ -376,8 +244,7 @@ def main():
 
     )
 
-    module = AnsibleModule(argument_spec, supports_check_mode=False)
-
+    module = AnsibleModule(argument_spec=argument_spec, supports_check_mode=False, )
     # MODULE PARAMGRAM
     paramgram = {
         "mode": module.params["mode"],
@@ -399,31 +266,26 @@ def main():
         "application-list": module.params["application_list"],
 
     }
+    module.paramgram = paramgram
+    fmgr = None
+    if module._socket_path:
+        connection = Connection(module._socket_path)
+        fmgr = FortiManagerHandler(connection, module)
+        fmgr.tools = FMGRCommon()
+    else:
+        module.fail_json(**FAIL_SOCKET_MSG)
 
-    # CHECK IF THE HOST/USERNAME/PW EXISTS, AND IF IT DOES, LOGIN.
-    host = module.params["host"]
-    password = module.params["password"]
-    username = module.params["username"]
-    if host is None or username is None or password is None:
-        module.fail_json(msg="Host and username and password are required")
-
-    # CHECK IF LOGIN FAILED
-    fmg = AnsibleFortiManager(module, module.params["host"], module.params["username"], module.params["password"])
-
-    response = fmg.login()
-    if response[1]['status']['code'] != 0:
-        module.fail_json(msg="Connection to FortiManager Failed")
+    results = DEFAULT_RESULT_OBJ
 
-    results = fmgr_firewall_profile_group_addsetdelete(fmg, paramgram)
-    if results[0] != 0:
-        fmgr_logout(fmg, module, results=results, good_codes=[0])
+    try:
+        results = fmgr_firewall_profile_group_modify(fmgr, paramgram)
+        fmgr.govern_response(module=module, results=results,
+                             ansible_facts=fmgr.construct_ansible_facts(results, module.params, paramgram))
 
-    fmg.logout()
+    except Exception as err:
+        raise FMGBaseException(err)
 
-    if results is not None:
-        return module.exit_json(**results[1])
-    else:
-        return module.exit_json(msg="No results were returned from the API call.")
+    return module.exit_json(**results[1])
 
 
 if __name__ == "__main__":
diff --git a/test/units/modules/network/fortimanager/fixtures/test_fmgr_secprof_profile_group.json b/test/units/modules/network/fortimanager/fixtures/test_fmgr_secprof_profile_group.json
index d9e7abd464..63ce11a537 100644
--- a/test/units/modules/network/fortimanager/fixtures/test_fmgr_secprof_profile_group.json
+++ b/test/units/modules/network/fortimanager/fixtures/test_fmgr_secprof_profile_group.json
@@ -1,62 +1,68 @@
 {
-   "fmgr_firewall_profile_group_addsetdelete": [
-      {
-         "paramgram_used": {
-            "ssl-ssh-profile": null, 
-            "waf-profile": null, 
-            "adom": "root", 
-            "webfilter-profile": null, 
-            "profile-protocol-options": null, 
-            "application-list": null, 
-            "icap-profile": null, 
-            "voip-profile": null, 
-            "ips-sensor": null, 
-            "dnsfilter-profile": null, 
-            "av-profile": null, 
-            "spamfilter-profile": null, 
-            "dlp-sensor": null, 
-            "mode": "delete", 
-            "ssh-filter-profile": null, 
-            "mms-profile": null, 
-            "name": "Ansible_TEST_Profile_Group"
-         }, 
-         "raw_response": {
-            "status": {
-               "message": "OK", 
-               "code": 0
-            }, 
-            "url": "/pm/config/adom/root/obj/firewall/profile-group/Ansible_TEST_Profile_Group"
-         }, 
-         "post_method": "delete"
-      }, 
-      {
-         "raw_response": {
-            "status": {
-               "message": "OK", 
-               "code": 0
-            }, 
-            "url": "/pm/config/adom/root/obj/firewall/profile-group"
-         }, 
-         "paramgram_used": {
-            "ssl-ssh-profile": null, 
-            "application-list": null, 
-            "waf-profile": null, 
-            "adom": "root", 
-            "webfilter-profile": null, 
-            "ips-sensor": null, 
-            "spamfilter-profile": null, 
-            "icap-profile": null, 
-            "dnsfilter-profile": null, 
-            "name": "Ansible_TEST_Profile_Group", 
-            "voip-profile": null, 
-            "av-profile": "Ansible_AV_Profile", 
-            "mode": "set", 
-            "dlp-sensor": null, 
-            "mms-profile": null, 
-            "ssh-filter-profile": null, 
-            "profile-protocol-options": "default"
-         }, 
-         "post_method": "set"
-      }
-   ]
+    "fmgr_firewall_profile_group_modify": [
+        {
+            "paramgram_used": {
+                "ssl-ssh-profile": null,
+                "waf-profile": null,
+                "adom": "root",
+                "webfilter-profile": null,
+                "profile-protocol-options": null,
+                "application-list": null,
+                "icap-profile": null,
+                "voip-profile": null,
+                "ips-sensor": null,
+                "dnsfilter-profile": null,
+                "av-profile": null,
+                "spamfilter-profile": null,
+                "dlp-sensor": null,
+                "mode": "delete",
+                "ssh-filter-profile": null,
+                "mms-profile": null,
+                "name": "Ansible_TEST_Profile_Group"
+            },
+            "datagram_sent": {},
+            "raw_response": {
+                "status": {
+                    "message": "Object does not exist",
+                    "code": -3
+                },
+                "url": "/pm/config/adom/root/obj/firewall/profile-group/Ansible_TEST_Profile_Group"
+            },
+            "post_method": "delete"
+        },
+        {
+            "raw_response": {
+                "status": {
+                    "message": "datasrc invalid. object: firewall profile-group av-profile Ansible_TEST_Profile_Group. detail: Ansible_AV_Profile. solution: data not exist",
+                    "code": -10131
+                },
+                "url": "/pm/config/adom/root/obj/firewall/profile-group"
+            },
+            "datagram_sent": {
+                "av-profile": "Ansible_AV_Profile",
+                "profile-protocol-options": "default",
+                "name": "Ansible_TEST_Profile_Group"
+            },
+            "paramgram_used": {
+                "ssl-ssh-profile": null,
+                "application-list": null,
+                "waf-profile": null,
+                "adom": "root",
+                "webfilter-profile": null,
+                "ips-sensor": null,
+                "spamfilter-profile": null,
+                "icap-profile": null,
+                "dnsfilter-profile": null,
+                "name": "Ansible_TEST_Profile_Group",
+                "voip-profile": null,
+                "av-profile": "Ansible_AV_Profile",
+                "mode": "set",
+                "dlp-sensor": null,
+                "mms-profile": null,
+                "ssh-filter-profile": null,
+                "profile-protocol-options": "default"
+            },
+            "post_method": "set"
+        }
+    ]
 }
diff --git a/test/units/modules/network/fortimanager/test_fmgr_secprof_profile_group.py b/test/units/modules/network/fortimanager/test_fmgr_secprof_profile_group.py
index 4002a8504f..d549cec5b9 100644
--- a/test/units/modules/network/fortimanager/test_fmgr_secprof_profile_group.py
+++ b/test/units/modules/network/fortimanager/test_fmgr_secprof_profile_group.py
@@ -19,7 +19,7 @@ __metaclass__ = type
 
 import os
 import json
-from pyFMG.fortimgr import FortiManager
+from ansible.module_utils.network.fortimanager.fortimanager import FortiManagerHandler
 import pytest
 
 try:
@@ -27,8 +27,6 @@ try:
 except ImportError:
     pytest.skip("Could not load required modules for testing", allow_module_level=True)
 
-fmg_instance = FortiManager("1.1.1.1", "admin", "")
-
 
 def load_fixtures():
     fixture_path = os.path.join(os.path.dirname(__file__), 'fixtures') + "/{filename}.json".format(
@@ -41,14 +39,30 @@ def load_fixtures():
     return [fixture_data]
 
 
+@pytest.fixture(autouse=True)
+def module_mock(mocker):
+    connection_class_mock = mocker.patch('ansible.module_utils.basic.AnsibleModule')
+    return connection_class_mock
+
+
+@pytest.fixture(autouse=True)
+def connection_mock(mocker):
+    connection_class_mock = mocker.patch('ansible.modules.network.fortimanager.fmgr_secprof_profile_group.Connection')
+    return connection_class_mock
+
+
 @pytest.fixture(scope="function", params=load_fixtures())
 def fixture_data(request):
     func_name = request.function.__name__.replace("test_", "")
     return request.param.get(func_name, None)
 
 
-def test_fmgr_firewall_profile_group_addsetdelete(fixture_data, mocker):
-    mocker.patch("pyFMG.fortimgr.FortiManager._post_request", side_effect=fixture_data)
+fmg_instance = FortiManagerHandler(connection_mock, module_mock)
+
+
+def test_fmgr_firewall_profile_group_modify(fixture_data, mocker):
+    mocker.patch("ansible.module_utils.network.fortimanager.fortimanager.FortiManagerHandler.process_request",
+                 side_effect=fixture_data)
     #  Fixture sets used:###########################
 
     ##################################################
@@ -91,10 +105,8 @@ def test_fmgr_firewall_profile_group_addsetdelete(fixture_data, mocker):
     ##################################################
 
     # Test using fixture 1 #
-    output = fmgr_secprof_profile_group.fmgr_firewall_profile_group_addsetdelete(fmg_instance,
-                                                                                 fixture_data[0]['paramgram_used'])
-    assert output['raw_response']['status']['code'] == 0
+    output = fmgr_secprof_profile_group.fmgr_firewall_profile_group_modify(fmg_instance, fixture_data[0]['paramgram_used'])
+    assert output['raw_response']['status']['code'] == -3
     # Test using fixture 2 #
-    output = fmgr_secprof_profile_group.fmgr_firewall_profile_group_addsetdelete(fmg_instance,
-                                                                                 fixture_data[1]['paramgram_used'])
-    assert output['raw_response']['status']['code'] == 0
+    output = fmgr_secprof_profile_group.fmgr_firewall_profile_group_modify(fmg_instance, fixture_data[1]['paramgram_used'])
+    assert output['raw_response']['status']['code'] == -10131
