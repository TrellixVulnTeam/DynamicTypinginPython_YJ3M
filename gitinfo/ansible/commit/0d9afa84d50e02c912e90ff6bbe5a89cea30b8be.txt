commit 0d9afa84d50e02c912e90ff6bbe5a89cea30b8be
Author: Toshio Kuratomi <a.badger@gmail.com>
Date:   Wed Nov 30 20:46:37 2016 -0800

    ssh-keyscan can fail to find keys for a host.
    
    When it does, we need to fail otherwise other code will fail later.
    
    Fixes #18676

diff --git a/lib/ansible/module_utils/known_hosts.py b/lib/ansible/module_utils/known_hosts.py
index 09d08b20ef..de074551f8 100644
--- a/lib/ansible/module_utils/known_hosts.py
+++ b/lib/ansible/module_utils/known_hosts.py
@@ -187,6 +187,9 @@ def add_host_key(module, fqdn, key_type="rsa", create_dir=False):
     this_cmd = "%s -t %s %s" % (keyscan_cmd, key_type, fqdn)
 
     rc, out, err = module.run_command(this_cmd)
+    # ssh-keyscan gives a 0 exit code and prints nothins on timeout
+    if rc != 0 or not out:
+        module.fail_json(msg='failed to get the hostkey for %s' % fqdn)
     module.append_to_file(user_host_file, out)
 
     return rc, out, err
