commit 0129fb0a44080d324d110c3d5c5223ab2aa138b2
Author: Nils Steinger <git@n-st.de>
Date:   Sat Dec 5 15:28:37 2015 +0100

    Remove duplicates from host list *before* caching it
    
    Ansible previously added hosts to the host list multiple times for commands
    like `ansible -i 'localhost,' -c local -m ping 'localhost,localhost'
    --list-hosts`.
    8d5f36a fixed the obvious error, but still added the un-deduplicated list to a
    cache, so all future invocations of get_hosts() would retrieve a
    non-deduplicated list.
    This caused problems down the line: For some reason, Ansible only ever
    schedules "flush_handlers" tasks (instead of scheduling any actual tasks from
    the playbook) for hosts that are contained in the host lists multiple times.
    This probably happens because the host states are stored in a dictionary
    indexed by the hostnames, so duplicate hostname would cause the state to be
    overwritten by subsequent invocations of â€¦ something.

diff --git a/lib/ansible/inventory/__init__.py b/lib/ansible/inventory/__init__.py
index 59a3c37bf9..14cd169265 100644
--- a/lib/ansible/inventory/__init__.py
+++ b/lib/ansible/inventory/__init__.py
@@ -195,8 +195,8 @@ class Inventory(object):
             if self._restriction is not None:
                 hosts = [ h for h in hosts if h in self._restriction ]
 
-        HOSTS_PATTERNS_CACHE[pattern_hash] = hosts[:]
-        return list(set(hosts))
+        HOSTS_PATTERNS_CACHE[pattern_hash] = list(set(hosts))
+        return HOSTS_PATTERNS_CACHE[pattern_hash][:]
 
     @classmethod
     def split_host_pattern(cls, pattern):
