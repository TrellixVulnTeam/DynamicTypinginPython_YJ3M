commit d89d2432fd77ec1bdb08c0e5280d107b500f55c0
Author: Cristian Ciupitu <cristian.ciupitu@yahoo.com>
Date:   Fri Mar 28 22:47:46 2014 +0200

    Bugfix for gc_storage and s3
    
    Make keysum return None if not key_check (this case wasn't covered).

diff --git a/library/cloud/gc_storage b/library/cloud/gc_storage
index 4bbf9eabae..8696f8e965 100644
--- a/library/cloud/gc_storage
+++ b/library/cloud/gc_storage
@@ -152,11 +152,12 @@ def key_check(module, gs, bucket, obj):
 def keysum(module, gs, bucket, obj):
     bucket = gs.lookup(bucket)
     key_check = bucket.get_key(obj)
-    if key_check:
-        md5_remote = key_check.etag[1:-1]
-        etag_multipart = '-' in md5_remote # Check for multipart, etag is not md5
-        if etag_multipart is True:
-            module.fail_json(msg="Files uploaded with multipart of gs are not supported with checksum, unable to compute checksum.")
+    if not key_check:
+        return None
+    md5_remote = key_check.etag[1:-1]
+    etag_multipart = '-' in md5_remote # Check for multipart, etag is not md5
+    if etag_multipart is True:
+        module.fail_json(msg="Files uploaded with multipart of gs are not supported with checksum, unable to compute checksum.")
     return md5_remote
 
 def bucket_check(module, gs, bucket):
diff --git a/library/cloud/s3 b/library/cloud/s3
index aaa2e0f4ff..715c0e00ab 100644
--- a/library/cloud/s3
+++ b/library/cloud/s3
@@ -145,11 +145,12 @@ def key_check(module, s3, bucket, obj):
 def keysum(module, s3, bucket, obj):
     bucket = s3.lookup(bucket)
     key_check = bucket.get_key(obj)
-    if key_check:
-        md5_remote = key_check.etag[1:-1]
-        etag_multipart = '-' in md5_remote # Check for multipart, etag is not md5
-        if etag_multipart is True:
-            module.fail_json(msg="Files uploaded with multipart of s3 are not supported with checksum, unable to compute checksum.")
+    if not key_check:
+        return None
+    md5_remote = key_check.etag[1:-1]
+    etag_multipart = '-' in md5_remote # Check for multipart, etag is not md5
+    if etag_multipart is True:
+        module.fail_json(msg="Files uploaded with multipart of s3 are not supported with checksum, unable to compute checksum.")
     return md5_remote
 
 def bucket_check(module, s3, bucket):
