commit 2dd430d9c0a2d3538a901fe21ee8ef6aef44c5b3
Author: Marco Vito Moscaritolo <marco@mavimo.org>
Date:   Wed Sep 5 14:06:47 2012 +0300

    Add support to removes control param
    
    Execute action only if specified file using param removes exist (execute reverse control of creates).
    
    Some usage eg.:
    
    ```yaml
    - name: enable apache2 default websites
      action: command /usr/sbin/a2ensite $item
    creates=/etc/apache2/sites-enabled/$item
      with_items:
        - default
        - default-ssl
    
    - name: disable apache2 default websites
      action: command /usr/sbin/a2dissite $item
    removes=/etc/apache2/sites-enabled/$item
      with_items:
        - default
        - default-ssl
    ```

diff --git a/library/command b/library/command
index e83d6e5cc8..585ebabd7b 100755
--- a/library/command
+++ b/library/command
@@ -114,6 +114,21 @@ class CommandModule(AnsibleModule):
                         rc=0
                     )
                 args = args.replace(x,'')
+            elif x.startswith("removes="):
+                # do not run the command if the line contains removes=filename
+                # and the filename do not exists.  This allows idempotence
+                # of command executions.
+                (k,v) = x.split("=",1)
+                if not os.path.exists(v):
+                    self.exit_json(
+                        cmd=args,
+                        stdout="skipped, since %s do not exists" % v,
+                        skipped=True,
+                        changed=False,
+                        stderr=False,
+                        rc=0
+                    )
+                args = args.replace(x,'')
             elif x.startswith("chdir="):
                 (k,v) = x.split("=", 1)
                 v = os.path.expanduser(v)
