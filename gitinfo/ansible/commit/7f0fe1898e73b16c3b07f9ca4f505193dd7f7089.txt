commit 7f0fe1898e73b16c3b07f9ca4f505193dd7f7089
Author: Abhijeet Kasurde <akasurde@redhat.com>
Date:   Mon Jul 16 19:46:46 2018 +0530

    urls: handle incorrect parsing of https_proxy env (#41472)
    
    If user exports https_proxy without scheme, then generic_urlparse
    fails to parse SCHEME and HOSTNAME from https_proxy variable.
    This fix raises ProxyError is generic_urlparse API fails to parse
    either of them.
    
    Fixes: #25421
    
    Signed-off-by: Abhijeet Kasurde <akasurde@redhat.com>

diff --git a/lib/ansible/module_utils/urls.py b/lib/ansible/module_utils/urls.py
index 3631ab0004..6f6508500c 100644
--- a/lib/ansible/module_utils/urls.py
+++ b/lib/ansible/module_utils/urls.py
@@ -734,7 +734,12 @@ class SSLValidationHandler(urllib_request.BaseHandler):
             if https_proxy:
                 proxy_parts = generic_urlparse(urlparse(https_proxy))
                 port = proxy_parts.get('port') or 443
-                s = socket.create_connection((proxy_parts.get('hostname'), port))
+                proxy_hostname = proxy_parts.get('hostname', None)
+                if proxy_hostname is None or proxy_parts.get('scheme') == '':
+                    raise ProxyError("Failed to parse https_proxy environment variable."
+                                     " Please make sure you export https proxy as 'https_proxy=<SCHEME>://<IP_ADDRESS>:<PORT>'")
+
+                s = socket.create_connection((proxy_hostname, port))
                 if proxy_parts.get('scheme') == 'http':
                     s.sendall(to_bytes(self.CONNECT_COMMAND % (self.hostname, self.port), errors='surrogate_or_strict'))
                     if proxy_parts.get('username'):
