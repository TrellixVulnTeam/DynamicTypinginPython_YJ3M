commit c402325085c129ce289c73a808d8d6ac68df096d
Author: James Cammarata <jimi@sngx.net>
Date:   Thu Dec 10 13:10:17 2015 -0500

    Fixing up docker integration tests a bit

diff --git a/test/integration/roles/test_docker/tasks/docker-tests.yml b/test/integration/roles/test_docker/tasks/docker-tests.yml
index 33ffe6c70c..14e23f72dd 100644
--- a/test/integration/roles/test_docker/tasks/docker-tests.yml
+++ b/test/integration/roles/test_docker/tasks/docker-tests.yml
@@ -8,7 +8,6 @@
     image: busybox
     state: present
     pull: missing
-    docker_api_version: "1.14"
 
 - name: Run a small script in busybox
   docker:
@@ -17,22 +16,12 @@
     pull: always
     command: "nc -l -p 2000 -e xargs -n1 echo hello"
     detach: True
-    docker_api_version: "1.14"
-
-- name: Get the docker container id
-  shell: "docker ps | grep busybox | awk '{ print $1 }'"
-  register: container_id
 
 - name: Get the docker container ip
-  shell: "docker inspect {{ container_id.stdout_lines[0] }} | grep IPAddress | awk -F '\"' '{ print $4 }'"
-  register: container_ip
-
-- name: Pause a few moments because docker is not reliable
-  pause:
-    seconds: 40
+  set_fact: container_ip="{{docker_containers[0].NetworkSettings.IPAddress}}"
 
 - name: Try to access the server
-  shell: "echo 'world' | nc {{ container_ip.stdout_lines[0] }} 2000"
+  shell: "echo 'world' | nc {{ container_ip }} 2000"
   register: docker_output
 
 - name: check that the script ran
@@ -49,22 +38,12 @@
       TEST: hello
     command: '/bin/sh -c "nc -l -p 2000 -e xargs -n1 echo $TEST"'
     detach: True
-    docker_api_version: "1.14"
-
-- name: Get the docker container id
-  shell: "docker ps | grep busybox | awk '{ print $1 }'"
-  register: container_id
 
 - name: Get the docker container ip
-  shell: "docker inspect {{ container_id.stdout_lines[0] }} | grep IPAddress | awk -F '\"' '{ print $4 }'"
-  register: container_ip
-
-- name: Pause a few moments because docker is not reliable
-  pause:
-    seconds: 40
+  set_fact: container_ip="{{docker_containers[0].NetworkSettings.IPAddress}}"
 
 - name: Try to access the server
-  shell: "echo 'world' | nc {{ container_ip.stdout_lines[0] }} 2000"
+  shell: "echo 'world' | nc {{ container_ip }} 2000"
   register: docker_output
 
 - name: check that the script ran
@@ -73,7 +52,7 @@
       - "'hello world' in docker_output.stdout_lines"
 
 - name: Remove containers
-  shell: "docker rm $(docker ps -aq)"
+  shell: "docker rm -f $(docker ps -aq)"
 
 - name: Remove all images from the local docker
   shell: "docker rmi -f $(docker images -q)"
diff --git a/test/integration/roles/test_docker/tasks/registry-tests.yml b/test/integration/roles/test_docker/tasks/registry-tests.yml
index 57b4d25277..1ef330da5f 100644
--- a/test/integration/roles/test_docker/tasks/registry-tests.yml
+++ b/test/integration/roles/test_docker/tasks/registry-tests.yml
@@ -19,11 +19,8 @@
 - name: Push docker image into the private registry
   command: "docker push localhost:5000/mine"
 
-- name: Remove containers
-  shell: "docker rm $(docker ps -aq)"
-
 - name: Remove all images from the local docker
-  shell: "docker rmi -f $(docker images -q)"
+  shell: "docker rmi -f {{image_id.stdout_lines[0]}}"
 
 - name: Get number of images in docker
   command: "docker images"
@@ -41,7 +38,6 @@
     state: present
     pull: missing
     insecure_registry: True
-    docker_api_version: "1.14"
 
 - name: Run a small script in the new image
   docker:
@@ -51,7 +47,6 @@
     command: "nc -l -p 2000 -e xargs -n1 echo hello"
     detach: True
     insecure_registry: True
-    docker_api_version: "1.14"
 
 - name: Get the docker container id
   shell: "docker ps | grep mine | awk '{ print $1 }'"
@@ -76,8 +71,9 @@
 
 
 - name: Remove containers
-  shell: "docker rm $(docker ps -aq)"
+  shell: "docker rm -f $(docker ps -aq)"
 
+- shell: docker images -q
 - name: Remove all images from the local docker
   shell: "docker rmi -f $(docker images -q)"
 
@@ -157,7 +153,6 @@
     state: running
     command: "nc -l -p 2000 -e xargs -n1 echo hello"
     detach: True
-    docker_api_version: "1.14"
 
 - name: Get the docker container id
   shell: "docker ps | grep mine | awk '{ print $1 }'"
