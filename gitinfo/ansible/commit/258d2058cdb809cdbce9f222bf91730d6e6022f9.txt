commit 258d2058cdb809cdbce9f222bf91730d6e6022f9
Author: Ricardo Carrillo Cruz <ricardo.carrillo.cruz@gmail.com>
Date:   Tue Jul 18 00:17:15 2017 +0200

    Remove enable EAPI from prepare_eos_tests (#26910)
    
    Enabling EAPI is not common on CLI *and* EAPI tests, therefore
    enabling it should be put at the eapi.yaml task level.

diff --git a/test/integration/targets/eos_banner/tasks/eapi.yaml b/test/integration/targets/eos_banner/tasks/eapi.yaml
index 994d1a7c7d..eeb4dfce84 100644
--- a/test/integration/targets/eos_banner/tasks/eapi.yaml
+++ b/test/integration/targets/eos_banner/tasks/eapi.yaml
@@ -10,12 +10,11 @@
 
 - name: enable eapi
   eos_eapi:
-    enable_http: yes
-    enable_https: yes
-    enable_local_http: yes
+    http: yes
+    https: yes
+    local_http: no
     enable_socket: yes
     provider: "{{ cli }}"
-#    authorize: yes
 
 - name: run test case
   include: "{{ test_case_to_run }}"
@@ -25,9 +24,4 @@
 
 - name: disable eapi
   eos_eapi:
-    enable_http: no
-    enable_https: no
-    enable_local_http: no
-    enable_socket: no
-    provider: "{{ cli }}"
-#    authorize: yes
+    state: stopped
diff --git a/test/integration/targets/eos_command/tasks/eapi.yaml b/test/integration/targets/eos_command/tasks/eapi.yaml
index 068881ab1b..45ad3433a7 100644
--- a/test/integration/targets/eos_command/tasks/eapi.yaml
+++ b/test/integration/targets/eos_command/tasks/eapi.yaml
@@ -8,8 +8,20 @@
 - name: set test_items
   set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
 
+- name: enable eapi
+  eos_eapi:
+    http: yes
+    https: yes
+    local_http: no
+    enable_socket: yes
+    provider: "{{ cli }}"
+
 - name: run test case
   include: "{{ test_case_to_run }}"
   with_items: "{{ test_items }}"
   loop_control:
     loop_var: test_case_to_run
+
+- name: disable eapi
+  eos_eapi:
+    state: stopped
diff --git a/test/integration/targets/eos_config/tasks/eapi.yaml b/test/integration/targets/eos_config/tasks/eapi.yaml
index 068881ab1b..5bf31b8ced 100644
--- a/test/integration/targets/eos_config/tasks/eapi.yaml
+++ b/test/integration/targets/eos_config/tasks/eapi.yaml
@@ -8,8 +8,20 @@
 - name: set test_items
   set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
 
+- name: enable eapi
+  eos_eapi:
+    http: yes
+    https: yes
+    local_http: no
+    socket: yes
+    provider: "{{ cli }}"
+
 - name: run test case
   include: "{{ test_case_to_run }}"
   with_items: "{{ test_items }}"
   loop_control:
     loop_var: test_case_to_run
+
+- name: disable eapi
+  eos_eapi:
+    state: stopped
diff --git a/test/integration/targets/eos_facts/tasks/eapi.yaml b/test/integration/targets/eos_facts/tasks/eapi.yaml
index 068881ab1b..45ad3433a7 100644
--- a/test/integration/targets/eos_facts/tasks/eapi.yaml
+++ b/test/integration/targets/eos_facts/tasks/eapi.yaml
@@ -8,8 +8,20 @@
 - name: set test_items
   set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
 
+- name: enable eapi
+  eos_eapi:
+    http: yes
+    https: yes
+    local_http: no
+    enable_socket: yes
+    provider: "{{ cli }}"
+
 - name: run test case
   include: "{{ test_case_to_run }}"
   with_items: "{{ test_items }}"
   loop_control:
     loop_var: test_case_to_run
+
+- name: disable eapi
+  eos_eapi:
+    state: stopped
diff --git a/test/integration/targets/eos_system/tasks/eapi.yaml b/test/integration/targets/eos_system/tasks/eapi.yaml
index f39b09baef..eeb4dfce84 100644
--- a/test/integration/targets/eos_system/tasks/eapi.yaml
+++ b/test/integration/targets/eos_system/tasks/eapi.yaml
@@ -10,9 +10,9 @@
 
 - name: enable eapi
   eos_eapi:
-    enable_http: yes
-    enable_https: yes
-    enable_local_http: yes
+    http: yes
+    https: yes
+    local_http: no
     enable_socket: yes
     provider: "{{ cli }}"
 
@@ -24,8 +24,4 @@
 
 - name: disable eapi
   eos_eapi:
-    enable_http: no
-    enable_https: no
-    enable_local_http: no
-    enable_socket: no
-    provider: "{{ cli }}"
+    state: stopped
diff --git a/test/integration/targets/eos_template/tasks/eapi.yaml b/test/integration/targets/eos_template/tasks/eapi.yaml
index 068881ab1b..45ad3433a7 100644
--- a/test/integration/targets/eos_template/tasks/eapi.yaml
+++ b/test/integration/targets/eos_template/tasks/eapi.yaml
@@ -8,8 +8,20 @@
 - name: set test_items
   set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
 
+- name: enable eapi
+  eos_eapi:
+    http: yes
+    https: yes
+    local_http: no
+    enable_socket: yes
+    provider: "{{ cli }}"
+
 - name: run test case
   include: "{{ test_case_to_run }}"
   with_items: "{{ test_items }}"
   loop_control:
     loop_var: test_case_to_run
+
+- name: disable eapi
+  eos_eapi:
+    state: stopped
diff --git a/test/integration/targets/eos_user/tasks/eapi.yaml b/test/integration/targets/eos_user/tasks/eapi.yaml
index 068881ab1b..45ad3433a7 100644
--- a/test/integration/targets/eos_user/tasks/eapi.yaml
+++ b/test/integration/targets/eos_user/tasks/eapi.yaml
@@ -8,8 +8,20 @@
 - name: set test_items
   set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
 
+- name: enable eapi
+  eos_eapi:
+    http: yes
+    https: yes
+    local_http: no
+    enable_socket: yes
+    provider: "{{ cli }}"
+
 - name: run test case
   include: "{{ test_case_to_run }}"
   with_items: "{{ test_items }}"
   loop_control:
     loop_var: test_case_to_run
+
+- name: disable eapi
+  eos_eapi:
+    state: stopped
diff --git a/test/integration/targets/eos_vrf/tasks/eapi.yaml b/test/integration/targets/eos_vrf/tasks/eapi.yaml
deleted file mode 100644
index 994d1a7c7d..0000000000
--- a/test/integration/targets/eos_vrf/tasks/eapi.yaml
+++ /dev/null
@@ -1,33 +0,0 @@
----
-- name: collect all eapi test cases
-  find:
-    paths: "{{ role_path }}/tests/eapi"
-    patterns: "{{ testcase }}.yaml"
-  register: test_cases
-
-- name: set test_items
-  set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}" #"
-
-- name: enable eapi
-  eos_eapi:
-    enable_http: yes
-    enable_https: yes
-    enable_local_http: yes
-    enable_socket: yes
-    provider: "{{ cli }}"
-#    authorize: yes
-
-- name: run test case
-  include: "{{ test_case_to_run }}"
-  with_items: "{{ test_items }}"
-  loop_control:
-    loop_var: test_case_to_run
-
-- name: disable eapi
-  eos_eapi:
-    enable_http: no
-    enable_https: no
-    enable_local_http: no
-    enable_socket: no
-    provider: "{{ cli }}"
-#    authorize: yes
diff --git a/test/integration/targets/eos_vrf/tasks/main.yaml b/test/integration/targets/eos_vrf/tasks/main.yaml
index 970e74171e..415c99d8b1 100644
--- a/test/integration/targets/eos_vrf/tasks/main.yaml
+++ b/test/integration/targets/eos_vrf/tasks/main.yaml
@@ -1,3 +1,2 @@
 ---
 - { include: cli.yaml, tags: ['cli'] }
-- { include: eapi.yaml, tags: ['eapi'] }
diff --git a/test/integration/targets/prepare_eos_tests/tasks/main.yml b/test/integration/targets/prepare_eos_tests/tasks/main.yml
index b84e4d57cb..f2bbc5c409 100644
--- a/test/integration/targets/prepare_eos_tests/tasks/main.yml
+++ b/test/integration/targets/prepare_eos_tests/tasks/main.yml
@@ -1,13 +1,3 @@
-- name: enable cli on remote device
-  eos_eapi:
-    enable_http: yes
-    enable_https: yes
-    enable_local_http: yes
-    enable_socket: yes
-    provider: "{{ cli }}"
-  register: eos_eapi_output
-  connection: local
-
 - name: Enable Ethernet1 interface and disable switchport
   eos_config:
     lines:
