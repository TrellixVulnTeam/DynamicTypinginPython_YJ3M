commit cc867481092160dc6f36dbbaa233e9f40941e504
Author: tottoto <tottotodev@gmail.com>
Date:   Sun Feb 16 02:39:05 2020 +0900

    Fix url handling in lxd_container and lxd_profile module (#66097)
    
    * Fix url handling in lxd_container module
    
    * Fix url handling in lxd_profile module

diff --git a/changelogs/fragments/lxd_container_url.yaml b/changelogs/fragments/lxd_container_url.yaml
new file mode 100644
index 0000000000..77953c6606
--- /dev/null
+++ b/changelogs/fragments/lxd_container_url.yaml
@@ -0,0 +1,2 @@
+bugfixes:
+  - Fixes the url handling in lxd_container module that url cannot be specified in lxd environment created by snap.
diff --git a/changelogs/fragments/lxd_profile_url.yaml b/changelogs/fragments/lxd_profile_url.yaml
new file mode 100644
index 0000000000..1a598e052d
--- /dev/null
+++ b/changelogs/fragments/lxd_profile_url.yaml
@@ -0,0 +1,2 @@
+bugfixes:
+  - Fixes the url handling in lxd_profile module that url cannot be specified in lxd environment created by snap.
diff --git a/lib/ansible/modules/cloud/lxd/lxd_container.py b/lib/ansible/modules/cloud/lxd/lxd_container.py
index fd82d99b78..a75767e244 100644
--- a/lib/ansible/modules/cloud/lxd/lxd_container.py
+++ b/lib/ansible/modules/cloud/lxd/lxd_container.py
@@ -300,6 +300,9 @@ ANSIBLE_LXD_STATES = {
     'Frozen': 'frozen',
 }
 
+# ANSIBLE_LXD_DEFAULT_URL is a default value of the lxd endpoint
+ANSIBLE_LXD_DEFAULT_URL = 'unix:/var/lib/lxd/unix.socket'
+
 # CONFIG_PARAMS is a list of config attribute names.
 CONFIG_PARAMS = [
     'architecture', 'config', 'devices', 'ephemeral', 'profiles', 'source'
@@ -329,7 +332,9 @@ class LXDContainerManagement(object):
         self.debug = self.module._verbosity >= 4
 
         try:
-            if os.path.exists(self.module.params['snap_url'].replace('unix:', '')):
+            if self.module.params['url'] != ANSIBLE_LXD_DEFAULT_URL:
+                self.url = self.module.params['url']
+            elif os.path.exists(self.module.params['snap_url'].replace('unix:', '')):
                 self.url = self.module.params['snap_url']
             else:
                 self.url = self.module.params['url']
@@ -623,7 +628,7 @@ def main():
             ),
             url=dict(
                 type='str',
-                default='unix:/var/lib/lxd/unix.socket'
+                default=ANSIBLE_LXD_DEFAULT_URL
             ),
             snap_url=dict(
                 type='str',
diff --git a/lib/ansible/modules/cloud/lxd/lxd_profile.py b/lib/ansible/modules/cloud/lxd/lxd_profile.py
index 06e7f93143..033fb39d43 100644
--- a/lib/ansible/modules/cloud/lxd/lxd_profile.py
+++ b/lib/ansible/modules/cloud/lxd/lxd_profile.py
@@ -182,6 +182,8 @@ import os
 from ansible.module_utils.basic import AnsibleModule
 from ansible.module_utils.lxd import LXDClient, LXDClientException
 
+# ANSIBLE_LXD_DEFAULT_URL is a default value of the lxd endpoint
+ANSIBLE_LXD_DEFAULT_URL = 'unix:/var/lib/lxd/unix.socket'
 
 # PROFILE_STATES is a list for states supported
 PROFILES_STATES = [
@@ -212,7 +214,9 @@ class LXDProfileManagement(object):
         self.debug = self.module._verbosity >= 4
 
         try:
-            if os.path.exists(self.module.params['snap_url'].replace('unix:', '')):
+            if self.module.params['url'] != ANSIBLE_LXD_DEFAULT_URL:
+                self.url = self.module.params['url']
+            elif os.path.exists(self.module.params['snap_url'].replace('unix:', '')):
                 self.url = self.module.params['snap_url']
             else:
                 self.url = self.module.params['url']
@@ -366,7 +370,7 @@ def main():
             ),
             url=dict(
                 type='str',
-                default='unix:/var/lib/lxd/unix.socket'
+                default=ANSIBLE_LXD_DEFAULT_URL
             ),
             snap_url=dict(
                 type='str',
