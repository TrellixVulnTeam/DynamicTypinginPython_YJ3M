commit aa034f4fcfd074cd6a9a950f8fe65bb76b08fbf0
Author: Toshio Kuratomi <a.badger@gmail.com>
Date:   Thu Nov 5 10:52:37 2015 -0800

    Add unit tests for issue #12976

diff --git a/test/units/executor/test_task_executor.py b/test/units/executor/test_task_executor.py
index 88ef1bcdab..0c868fef4b 100644
--- a/test/units/executor/test_task_executor.py
+++ b/test/units/executor/test_task_executor.py
@@ -186,7 +186,7 @@ class TestTaskExecutor(unittest.TestCase):
         mock_shared_loader = None
 
         new_stdin = None
-        job_vars = dict()
+        job_vars = dict(pkg_mgr='yum')
 
         te = TaskExecutor(
             host = mock_host,
@@ -206,6 +206,23 @@ class TestTaskExecutor(unittest.TestCase):
         new_items = te._squash_items(items=items, variables=job_vars)
         self.assertEqual(new_items, [['a','c']])
 
+        mock_task.action = '{{pkg_mgr}}'
+        new_items = te._squash_items(items=items, variables=job_vars)
+        self.assertEqual(new_items, [['a', 'c']])
+
+        # Smoketests -- these won't optimize but make sure that they don't
+        # traceback either
+        mock_task.action = '{{unknown}}'
+        new_items = te._squash_items(items=items, variables=job_vars)
+        self.assertEqual(new_items, ['a', 'b', 'c'])
+
+        items = [dict(name='a', state='present'),
+                dict(name='b', state='present'),
+                dict(name='c', state='present')]
+        mock_task.action = 'yum'
+        new_items = te._squash_items(items=items, variables=job_vars)
+        self.assertEqual(new_items, items)
+
     def test_task_executor_execute(self):
         fake_loader = DictDataLoader({})
 
