commit d0105108355389902ed0dd156a170bc20abd6cd2
Author: Paul Belanger <pabelanger@redhat.com>
Date:   Fri Jun 21 14:07:25 2019 -0400

    Remove more usage of pause with junos tests (#58153)
    
    This removes more potential race conditions with junos testing.
    
    Signed-off-by: Paul Belanger <pabelanger@redhat.com>

diff --git a/test/integration/targets/junos_netconf/tests/cli/changeport.yaml b/test/integration/targets/junos_netconf/tests/cli/changeport.yaml
index 528380f8d7..d939a7b13e 100644
--- a/test/integration/targets/junos_netconf/tests/cli/changeport.yaml
+++ b/test/integration/targets/junos_netconf/tests/cli/changeport.yaml
@@ -81,9 +81,15 @@
     that:
       - "result.changed == true"
 
-- name: wait for netconf server to come up
-  pause:
-    seconds: 10
+- name: wait for netconf port tcp/12345 to be closed
+  wait_for:
+    host: "{{ hostvars[item].ansible_host }}"
+    port: 12345
+    state: stopped
+  with_inventory_hostnames: junos
+
+- name: Reset ansible connections
+  meta: reset_connection
 
 - name: Ensure we can NOT communicate over non-default port
   include: "{{ role_path }}/tests/utils/junos_command.yaml ansible_connection=netconf ansible_port=12345 is_ignore_errors=true"
diff --git a/test/integration/targets/junos_netconf/tests/cli/netconf.yaml b/test/integration/targets/junos_netconf/tests/cli/netconf.yaml
index 2fdf677dea..eb3db8dcb5 100644
--- a/test/integration/targets/junos_netconf/tests/cli/netconf.yaml
+++ b/test/integration/targets/junos_netconf/tests/cli/netconf.yaml
@@ -38,9 +38,14 @@
     that:
       - "result.changed == true"
 
-- name: wait for persistent socket to timeout
-  pause:
-    seconds: 120
+- name: wait for netconf port tcp/830 to be open
+  wait_for:
+    host: "{{ hostvars[item].ansible_host }}"
+    port: 830
+  with_inventory_hostnames: junos
+
+- name: Reset ansible connections
+  meta: reset_connection
 
 - name: Ensure we can communicate over netconf
   include: "{{ role_path }}/tests/utils/junos_command.yaml ansible_connection=netconf ansible_port=830 is_ignore_errors=false"
@@ -91,9 +96,15 @@
     that:
       - "result.changed == true"
 
-- name: wait for netconf server to come up
-  pause:
-    seconds: 10
+- name: wait for netconf port tcp/830 to be closed
+  wait_for:
+    host: "{{ hostvars[item].ansible_host }}"
+    port: 830
+    state: stopped
+  with_inventory_hostnames: junos
+
+- name: Reset ansible connections
+  meta: reset_connection
 
 - name: Ensure we can NOT talk via netconf
   include: "{{ role_path }}/tests/utils/junos_command.yaml ansible_connection=netconf ansible_port=830 is_ignore_errors=true"
