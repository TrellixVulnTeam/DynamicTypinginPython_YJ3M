commit fcf7f03398536b1ee0e205783c851121899d8f13
Author: RomanDolejsi <roman.dolejsi@apksoft.eu>
Date:   Tue Jul 29 10:46:32 2014 +0200

    file: prevent replace failure when overwriting empty directory with hard/link (force=yes)

diff --git a/library/files/file b/library/files/file
index ea47811656..eb5cb089f9 100644
--- a/library/files/file
+++ b/library/files/file
@@ -233,6 +233,8 @@ def main():
                 # try to replace atomically
                 tmppath = '/'.join([os.path.dirname(path), ".%s.%s.tmp" % (os.getpid(),time.time())])
                 try:
+                    if prev_state == 'directory' and (state == 'hard' or state == 'link'):
+                        os.rmdir(path)
                     if state == 'hard':
                         os.link(src,tmppath)
                     else:
