commit 3c3cf50e7a1efd936dc027d90078c74802793a2d
Author: Matt Clay <matt@mystile.com>
Date:   Tue Jan 28 19:31:08 2020 -0800

    Fix ansible-test coverage of ansible-connection.

diff --git a/changelogs/fragments/ansible-test-coverage-ansible-connection.yml b/changelogs/fragments/ansible-test-coverage-ansible-connection.yml
new file mode 100644
index 0000000000..efbaa55ca0
--- /dev/null
+++ b/changelogs/fragments/ansible-test-coverage-ansible-connection.yml
@@ -0,0 +1,2 @@
+bugfixes:
+    - ansible-test once again properly collects code coverage for ``ansible-connection``
diff --git a/test/lib/ansible_test/_internal/ansible_util.py b/test/lib/ansible_test/_internal/ansible_util.py
index 309f2678b8..74781a9405 100644
--- a/test/lib/ansible_test/_internal/ansible_util.py
+++ b/test/lib/ansible_test/_internal/ansible_util.py
@@ -27,6 +27,7 @@ from .util_common import (
 )
 
 from .config import (
+    IntegrationConfig,
     PosixIntegrationConfig,
     EnvironmentConfig,
     CommonConfig,
@@ -75,6 +76,14 @@ def ansible_environment(args, color=True, ansible_config=None):
         PATH=path,
     )
 
+    if isinstance(args, IntegrationConfig) and args.coverage:
+        # standard path injection is not effective for ansible-connection, instead the location must be configured
+        # ansible-connection only requires the injector for code coverage
+        # the correct python interpreter is already selected using the sys.executable used to invoke ansible
+        ansible.update(dict(
+            ANSIBLE_CONNECTION_PATH=os.path.join(ANSIBLE_TEST_DATA_ROOT, 'injector', 'ansible-connection'),
+        ))
+
     if isinstance(args, PosixIntegrationConfig):
         ansible.update(dict(
             ANSIBLE_PYTHON_INTERPRETER='/set/ansible_python_interpreter/in/inventory',  # force tests to set ansible_python_interpreter in inventory
