commit 1bda7cc200d5bd1054d1bcb3b1986afe80b30dbd
Author: Toshio Kuratomi <a.badger@gmail.com>
Date:   Thu May 28 15:35:45 2015 -0700

    Test that uri module validates certs

diff --git a/test/integration/roles/test_uri/tasks/main.yml b/test/integration/roles/test_uri/tasks/main.yml
index 66e01ae8e5..da4bf65574 100644
--- a/test/integration/roles/test_uri/tasks/main.yml
+++ b/test/integration/roles/test_uri/tasks/main.yml
@@ -91,3 +91,38 @@
   with_together:
     - fail_checksum.results
     - fail.results
+
+- name: test https fetch to a site with mismatched hostname and certificate
+  uri:
+    url: "https://kennethreitz.org/"
+    dest: "{{ output_dir }}/shouldnotexist.html"
+  ignore_errors: True
+  register: result
+
+- stat:
+    path: "{{ output_dir }}/shouldnotexist.html"
+  register: stat_result
+
+- name: Assert that the file was not downloaded
+  assert:
+    that:
+      - "result.failed == true"
+      - "'certificate does not match ' in result.msg"
+      - "stat_result.stat.exists == false"
+
+- name: test https fetch to a site with mismatched hostname and certificate and validate_certs=no
+  get_url:
+    url: "https://kennethreitz.org/"
+    dest: "{{ output_dir }}/kreitz.html"
+    validate_certs: no
+  register: result
+
+- stat:
+    path: "{{ output_dir }}/kreitz.html"
+  register: stat_result
+
+- name: Assert that the file was not downloaded
+  assert:
+    that:
+      - "result.failed == false"
+      - "stat_result.stat.exists == true"
