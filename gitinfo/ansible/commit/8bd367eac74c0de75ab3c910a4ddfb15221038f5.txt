commit 8bd367eac74c0de75ab3c910a4ddfb15221038f5
Author: Tagir Bakirov <tagir.bakirov@iqser.com>
Date:   Fri Mar 13 11:07:13 2015 +0100

    added 'absent' option to supervisorctl

diff --git a/lib/ansible/modules/web_infrastructure/supervisorctl.py b/lib/ansible/modules/web_infrastructure/supervisorctl.py
index 6d9f726c33..43fa95467f 100644
--- a/lib/ansible/modules/web_infrastructure/supervisorctl.py
+++ b/lib/ansible/modules/web_infrastructure/supervisorctl.py
@@ -64,7 +64,7 @@ options:
       - The desired state of program/group.
     required: true
     default: null
-    choices: [ "present", "started", "stopped", "restarted" ]
+    choices: [ "present", "started", "stopped", "restarted", "absent" ]
   supervisorctl_path:
     description:
       - path to supervisorctl executable
@@ -103,7 +103,7 @@ def main():
         username=dict(required=False),
         password=dict(required=False),
         supervisorctl_path=dict(required=False),
-        state=dict(required=True, choices=['present', 'started', 'restarted', 'stopped'])
+        state=dict(required=True, choices=['present', 'started', 'restarted', 'stopped', 'absent'])
     )
 
     module = AnsibleModule(argument_spec=arg_spec, supports_check_mode=True)
@@ -203,6 +203,19 @@ def main():
     if not processes:
          module.fail_json(name=name, msg="ERROR (no such process)")
 
+    if state == 'absent':
+        if len(processes) == 0:
+            module.exit_json(changed=False, name=name, state=state)
+
+        if module.check_mode:
+            module.exit_json(changed=True)
+        run_supervisorctl('reread', check_rc=True)
+        rc, out, err = run_supervisorctl('remove', name)
+        if '%s: removed process group' % name in out:
+            module.exit_json(changed=True, name=name, state=state)
+        else:
+            module.fail_json(msg=out, name=name, state=state)
+
     if state == 'present':
         if len(processes) > 0:
             module.exit_json(changed=False, name=name, state=state)
