commit f6ecdf0b871e413df416437be5bd226b445f676e
Author: Matt Martz <matt@sivel.net>
Date:   Tue Oct 23 11:18:21 2018 -0500

    Handle sets differently than lists in wrap_var. Fixes #47372 (#47510)

diff --git a/changelogs/fragments/unsafe-set-wrap.yaml b/changelogs/fragments/unsafe-set-wrap.yaml
new file mode 100644
index 0000000000..5e3a491632
--- /dev/null
+++ b/changelogs/fragments/unsafe-set-wrap.yaml
@@ -0,0 +1,2 @@
+bugfixes:
+- unsafe - Add special casing to sets, to support wrapping elements of sets correctly in Python 3 (https://github.com/ansible/ansible/issues/47372)
diff --git a/lib/ansible/utils/unsafe_proxy.py b/lib/ansible/utils/unsafe_proxy.py
index a1fce63fa4..2a180e6d4a 100644
--- a/lib/ansible/utils/unsafe_proxy.py
+++ b/lib/ansible/utils/unsafe_proxy.py
@@ -95,11 +95,17 @@ def _wrap_list(v):
     return v
 
 
+def _wrap_set(v):
+    return set(item if item is None else wrap_var(item) for item in v)
+
+
 def wrap_var(v):
     if isinstance(v, Mapping):
         v = _wrap_dict(v)
-    elif isinstance(v, (MutableSequence, Set)):
+    elif isinstance(v, MutableSequence):
         v = _wrap_list(v)
+    elif isinstance(v, Set):
+        v = _wrap_set(v)
     elif v is not None and not isinstance(v, AnsibleUnsafe):
         v = UnsafeProxy(v)
     return v
diff --git a/test/integration/targets/loops/tasks/main.yml b/test/integration/targets/loops/tasks/main.yml
index 8cdd612aaa..c3a169f542 100644
--- a/test/integration/targets/loops/tasks/main.yml
+++ b/test/integration/targets/loops/tasks/main.yml
@@ -258,3 +258,13 @@
   loop: []
   register: literal_empty_list
   failed_when: literal_empty_list is not skipped
+
+# https://github.com/ansible/ansible/issues/47372
+- name: Loop unsafe list
+  debug:
+    var: item
+  with_items: "{{ things|list|unique }}"
+  vars:
+    things:
+      - !unsafe foo
+      - !unsafe bar
