commit 354aa8d602e95037ce647675a6fc47fa9196304f
Author: Matt Martz <matt@sivel.net>
Date:   Mon Apr 16 16:46:47 2018 -0500

    Skip self._parent on dynamic, defer to grandparent for attr lookup (#38827)
    
    * Skip self._parent on dynamic, defer to grandparent for attr lookup
    
    * Revert _inheritable
    
    * Add tests for include inheritance from static blocks
    
    Fixes #38037 #36194

diff --git a/lib/ansible/playbook/base.py b/lib/ansible/playbook/base.py
index 9662e913b5..d007dc0932 100644
--- a/lib/ansible/playbook/base.py
+++ b/lib/ansible/playbook/base.py
@@ -174,8 +174,6 @@ class Base(with_metaclass(BaseMeta, object)):
         'su', 'su_user', 'su_pass', 'su_exe', 'su_flags',
     ]
 
-    _inheritable = True
-
     def __init__(self):
 
         # initialize the data loader and variable manager, which will be provided
diff --git a/lib/ansible/playbook/block.py b/lib/ansible/playbook/block.py
index d8a0087fcb..9bbe888385 100644
--- a/lib/ansible/playbook/block.py
+++ b/lib/ansible/playbook/block.py
@@ -298,13 +298,20 @@ class Block(Base, Become, Conditional, Taggable):
         prepend = self._valid_attrs[attr].prepend
         try:
             value = self._attributes[attr]
-            if self._parent and (value is None or extend):
+            # If parent is static, we can grab attrs from the parent
+            # otherwise, defer to the grandparent
+            if getattr(self._parent, 'statically_loaded', True):
+                _parent = self._parent
+            else:
+                _parent = self._parent._parent
+
+            if _parent and (value is None or extend):
                 try:
-                    if getattr(self._parent, 'statically_loaded', True):
-                        if hasattr(self._parent, '_get_parent_attribute'):
-                            parent_value = self._parent._get_parent_attribute(attr)
+                    if getattr(_parent, 'statically_loaded', True):
+                        if hasattr(_parent, '_get_parent_attribute'):
+                            parent_value = _parent._get_parent_attribute(attr)
                         else:
-                            parent_value = self._parent._attributes.get(attr, None)
+                            parent_value = _parent._attributes.get(attr, None)
                         if extend:
                             value = self._extend_value(value, parent_value, prepend)
                         else:
diff --git a/lib/ansible/playbook/role_include.py b/lib/ansible/playbook/role_include.py
index 423fcdd4e6..f2d50c49d3 100644
--- a/lib/ansible/playbook/role_include.py
+++ b/lib/ansible/playbook/role_include.py
@@ -48,8 +48,6 @@ class IncludeRole(TaskInclude):
     OTHER_ARGS = ('private', 'allow_duplicates')  # assigned to matching property
     VALID_ARGS = tuple(frozenset(BASE + FROM_ARGS + OTHER_ARGS))  # all valid args
 
-    _inheritable = False
-
     # =================================================================================
     # ATTRIBUTES
 
diff --git a/lib/ansible/playbook/task.py b/lib/ansible/playbook/task.py
index 226380c3c0..3956a5835a 100644
--- a/lib/ansible/playbook/task.py
+++ b/lib/ansible/playbook/task.py
@@ -423,13 +423,20 @@ class Task(Base, Conditional, Taggable, Become):
         prepend = self._valid_attrs[attr].prepend
         try:
             value = self._attributes[attr]
-            if self._parent and (value is None or extend):
-                if getattr(self._parent, 'statically_loaded', True):
+            # If parent is static, we can grab attrs from the parent
+            # otherwise, defer to the grandparent
+            if getattr(self._parent, 'statically_loaded', True):
+                _parent = self._parent
+            else:
+                _parent = self._parent._parent
+
+            if _parent and (value is None or extend):
+                if getattr(_parent, 'statically_loaded', True):
                     # vars are always inheritable, other attributes might not be for the partent but still should be for other ancestors
-                    if attr != 'vars' and getattr(self._parent, '_inheritable', True) and hasattr(self._parent, '_get_parent_attribute'):
-                        parent_value = self._parent._get_parent_attribute(attr)
+                    if attr != 'vars' and hasattr(_parent, '_get_parent_attribute'):
+                        parent_value = _parent._get_parent_attribute(attr)
                     else:
-                        parent_value = self._parent._attributes.get(attr, None)
+                        parent_value = _parent._attributes.get(attr, None)
 
                     if extend:
                         value = self._extend_value(value, parent_value, prepend)
diff --git a/lib/ansible/playbook/task_include.py b/lib/ansible/playbook/task_include.py
index 55da790b67..f8612a02d3 100644
--- a/lib/ansible/playbook/task_include.py
+++ b/lib/ansible/playbook/task_include.py
@@ -50,8 +50,6 @@ class TaskInclude(Task):
     @staticmethod
     def load(data, block=None, role=None, task_include=None, variable_manager=None, loader=None):
         t = TaskInclude(block=block, role=role, task_include=task_include)
-        if t.action == 'include_task':
-            t._inheritable = False
         return t.load_data(data, variable_manager=variable_manager, loader=loader)
 
     def copy(self, exclude_parent=False, exclude_tasks=False):
diff --git a/test/integration/targets/include_import/grandchild/block_include_tasks.yml b/test/integration/targets/include_import/grandchild/block_include_tasks.yml
new file mode 100644
index 0000000000..f8addcf46a
--- /dev/null
+++ b/test/integration/targets/include_import/grandchild/block_include_tasks.yml
@@ -0,0 +1,2 @@
+- command: "true"
+  register: block_include_result
diff --git a/test/integration/targets/include_import/grandchild/import.yml b/test/integration/targets/include_import/grandchild/import.yml
new file mode 100644
index 0000000000..ef6990e2af
--- /dev/null
+++ b/test/integration/targets/include_import/grandchild/import.yml
@@ -0,0 +1 @@
+- include_tasks: include_level_1.yml
diff --git a/test/integration/targets/include_import/grandchild/import_include_include_tasks.yml b/test/integration/targets/include_import/grandchild/import_include_include_tasks.yml
new file mode 100644
index 0000000000..dae3a24548
--- /dev/null
+++ b/test/integration/targets/include_import/grandchild/import_include_include_tasks.yml
@@ -0,0 +1,2 @@
+- command: "true"
+  register: import_include_include_result
diff --git a/test/integration/targets/include_import/grandchild/include_level_1.yml b/test/integration/targets/include_import/grandchild/include_level_1.yml
new file mode 100644
index 0000000000..e323511f83
--- /dev/null
+++ b/test/integration/targets/include_import/grandchild/include_level_1.yml
@@ -0,0 +1 @@
+- include_tasks: import_include_include_tasks.yml
diff --git a/test/integration/targets/include_import/runme.sh b/test/integration/targets/include_import/runme.sh
index 0b907f6e87..8c98951858 100755
--- a/test/integration/targets/include_import/runme.sh
+++ b/test/integration/targets/include_import/runme.sh
@@ -55,3 +55,7 @@ gen_task_files
 ANSIBLE_STRATEGY='linear' ansible-playbook test_copious_include_tasks.yml  -i ../../inventory "$@" --skip-tags never
 ANSIBLE_STRATEGY='free' ansible-playbook test_copious_include_tasks.yml  -i ../../inventory "$@" --skip-tags never
 rm -f tasks/hello/*.yml
+
+# Inlcuded tasks should inherit attrs from non-dynamic blocks in parent chain
+# https://github.com/ansible/ansible/pull/38827
+ANSIBLE_STRATEGY='linear' ansible-playbook test_grandparent_inheritance.yml -i ../../inventory "$@"
diff --git a/test/integration/targets/include_import/test_grandparent_inheritance.yml b/test/integration/targets/include_import/test_grandparent_inheritance.yml
new file mode 100644
index 0000000000..45a3d83655
--- /dev/null
+++ b/test/integration/targets/include_import/test_grandparent_inheritance.yml
@@ -0,0 +1,29 @@
+---
+- hosts: testhost
+  gather_facts: false
+  tasks:
+    - debug:
+        var: inventory_hostname
+
+    - name: Test included tasks inherit from block
+      check_mode: true
+      block:
+        - include_tasks: grandchild/block_include_tasks.yml
+
+    - debug:
+        var: block_include_result
+
+    - assert:
+        that:
+          - block_include_result is skipped
+
+    - name: Test included tasks inherit deeply from import
+      import_tasks: grandchild/import.yml
+      check_mode: true
+
+    - debug:
+        var: import_include_include_result
+
+    - assert:
+        that:
+          - import_include_include_result is skipped
