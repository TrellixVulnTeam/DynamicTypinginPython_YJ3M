commit f666208b751d29e45fae93e90c22c4d3edb39ec7
Author: Martin Krizek <martin.krizek@gmail.com>
Date:   Tue Apr 3 16:25:51 2018 +0200

    Add integration test for #35900 (#38090)
    
    * Add integration test for #35900
    
    * Fix cleanup

diff --git a/test/integration/targets/apt/tasks/repo.yml b/test/integration/targets/apt/tasks/repo.yml
index e1263b0bb5..b963848ebf 100644
--- a/test/integration/targets/apt/tasks/repo.yml
+++ b/test/integration/targets/apt/tasks/repo.yml
@@ -34,9 +34,39 @@
         - "dpkg_result is success"
         - "'1.0.1' in dpkg_result.stdout"
 
+  # https://github.com/ansible/ansible/issues/35900
+  - name: Clean up
+    apt:
+      name: foo
+      state: absent
+
+  - name: Install foobar, installs foo as a dependency
+    apt:
+      name: foobar=1.0.0
+      allow_unauthenticated: yes
+
+  - name: Upgrade foobar to a version which does not depend on foo, autoremove should remove foo
+    apt:
+      upgrade: dist
+      autoremove: yes
+      force: yes  # workaround for --allow-unauthenticated used along with upgrade
+
+  - name: Check foo with dpkg
+    shell: dpkg-query -l foo
+    register: dpkg_result
+    ignore_errors: yes
+
+  - name: Check that foo was removed by autoremove
+    assert:
+      that:
+        - "dpkg_result is failed"
+
   always:
     - name: Clean up
       apt:
-        name: foo
+        name: "{{ item }}"
         state: absent
         allow_unauthenticated: yes
+      with_items:
+        - foo
+        - foobar
diff --git a/test/integration/targets/setup_deb_repo/files/package_specs/foobar-1.0.0 b/test/integration/targets/setup_deb_repo/files/package_specs/foobar-1.0.0
new file mode 100644
index 0000000000..0da0348fd6
--- /dev/null
+++ b/test/integration/targets/setup_deb_repo/files/package_specs/foobar-1.0.0
@@ -0,0 +1,11 @@
+Section: misc
+Priority: optional
+Standards-Version: 2.3.3
+
+Package: foobar
+Version: 1.0.0
+Section: system
+Depends: foo
+Maintainer: John Doe <john@doe.com>
+Architecture: all
+Description: Dummy package
diff --git a/test/integration/targets/setup_deb_repo/files/package_specs/foobar-1.0.1 b/test/integration/targets/setup_deb_repo/files/package_specs/foobar-1.0.1
new file mode 100644
index 0000000000..b9fa83031d
--- /dev/null
+++ b/test/integration/targets/setup_deb_repo/files/package_specs/foobar-1.0.1
@@ -0,0 +1,10 @@
+Section: misc
+Priority: optional
+Standards-Version: 2.3.3
+
+Package: foobar
+Version: 1.0.1
+Section: system
+Maintainer: John Doe <john@doe.com>
+Architecture: all
+Description: Dummy package
