commit ada2432165b47c96cd36c0320f5eb2be8a4b9231
Author: Matt Clay <matt@mystile.com>
Date:   Thu Sep 22 12:42:55 2016 -0700

    Add keep on failure option to integration.sh. (#17711)

diff --git a/test/utils/shippable/integration.sh b/test/utils/shippable/integration.sh
index f9b04ae5c7..4be0624e09 100755
--- a/test/utils/shippable/integration.sh
+++ b/test/utils/shippable/integration.sh
@@ -34,6 +34,7 @@ fi
 
 container_id=
 httptester_id=
+tests_completed=
 
 function show_environment
 {
@@ -51,6 +52,10 @@ function cleanup
         rm -rf "${controller_shared_dir}"
     fi
 
+    if [ "${keep_containers}" == "onfailure" ] && [ "${tests_completed}" != "" ]; then
+        keep_containers=
+    fi
+
     if [ "${keep_containers}" == "" ]; then
         if [ "${container_id}" ]; then
             docker rm -f "${container_id}"
@@ -111,3 +116,5 @@ docker exec "${container_id}" mkdir -p "${test_shared_dir}/shippable/testresults
 docker exec "${container_id}" /bin/sh -c "cd '${test_ansible_dir}' && . hacking/env-setup && cd test/integration && \
     JUNIT_OUTPUT_DIR='${test_shared_dir}/shippable/testresults' ANSIBLE_CALLBACK_WHITELIST=junit \
     HTTPTESTER=1 TEST_FLAGS='${test_flags}' LC_ALL=en_US.utf-8 make ${test_target}"
+
+tests_completed=1
