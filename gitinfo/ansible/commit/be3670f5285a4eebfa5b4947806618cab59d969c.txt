commit be3670f5285a4eebfa5b4947806618cab59d969c
Author: Jeffrey Forman <code@jeffreyforman.net>
Date:   Mon May 7 21:30:47 2018 -0400

    fix 'doas' become_method support, previously committed patch not submitted to devel branch (#37511)
    
    * fix become_method 'doas' support by properly specifying becomecmd
    
    a repatch of https://github.com/ansible/ansible/pull/13451/ which was never committed to 'devel' branch.
    
    * fix play_context test for become_method doas to match new becomecmd

diff --git a/lib/ansible/playbook/play_context.py b/lib/ansible/playbook/play_context.py
index 27c84fa284..f291e35f20 100644
--- a/lib/ansible/playbook/play_context.py
+++ b/lib/ansible/playbook/play_context.py
@@ -544,7 +544,7 @@ class PlayContext(Base):
                     flags += ' -u %s ' % self.become_user
 
                 # FIXME: make shell independent
-                becomecmd = '%s %s echo %s && %s %s env ANSIBLE=true %s' % (exe, flags, success_key, exe, flags, cmd)
+                becomecmd = '%s %s %s -c %s' % (exe, flags, executable, success_cmd)
 
             elif self.become_method == 'dzdo':
 
diff --git a/test/units/playbook/test_play_context.py b/test/units/playbook/test_play_context.py
index f77c53ff1c..266801601e 100644
--- a/test/units/playbook/test_play_context.py
+++ b/test/units/playbook/test_play_context.py
@@ -154,8 +154,7 @@ def test_play_context_make_become_cmd(parser):
 
     play_context.become_method = 'doas'
     cmd = play_context.make_become_cmd(cmd=default_cmd, executable="/bin/bash")
-    assert (cmd == """%s %s echo %s && %s %s env ANSIBLE=true %s""" % (doas_exe, doas_flags, play_context.
-                                                                       success_key, doas_exe, doas_flags, default_cmd))
+    assert (cmd == """%s %s %s -c 'echo %s; %s'""" % (doas_exe, doas_flags, default_exe, play_context.success_key, default_cmd))
 
     play_context.become_method = 'ksu'
     cmd = play_context.make_become_cmd(cmd=default_cmd, executable="/bin/bash")
