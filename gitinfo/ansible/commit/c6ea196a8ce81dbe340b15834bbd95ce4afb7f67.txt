commit c6ea196a8ce81dbe340b15834bbd95ce4afb7f67
Author: Anton Ovchinnikov <revolver112@gmail.com>
Date:   Thu Jul 28 18:12:14 2016 +0200

    Fix check mode for blockinfile when 'create: yes' is specified (#2413)
    
    Make the module more semantically similar to lineinfile when
    the destination does not exist. This fixes #2021.

diff --git a/lib/ansible/modules/extras/files/blockinfile.py b/lib/ansible/modules/extras/files/blockinfile.py
index 258284ea5a..38e719a970 100755
--- a/lib/ansible/modules/extras/files/blockinfile.py
+++ b/lib/ansible/modules/extras/files/blockinfile.py
@@ -212,7 +212,8 @@ def main():
         module.fail_json(rc=256,
                          msg='Destination %s is a directory !' % dest)
 
-    if not os.path.exists(dest):
+    path_exists = os.path.exists(dest)
+    if not path_exists:
         if not module.boolean(params['create']):
             module.fail_json(rc=257,
                              msg='Destination %s does not exist !' % dest)
@@ -230,6 +231,9 @@ def main():
     marker = params['marker']
     present = params['state'] == 'present'
 
+    if not present and not path_exists:
+        module.exit_json(changed=False, msg="File not present")
+
     if insertbefore is None and insertafter is None:
         insertafter = 'EOF'
 
@@ -299,10 +303,13 @@ def main():
         changed = True
 
     if changed and not module.check_mode:
-        if module.boolean(params['backup']) and os.path.exists(dest):
+        if module.boolean(params['backup']) and path_exists:
             module.backup_local(dest)
         write_changes(module, result, dest)
 
+    if module.check_mode and not path_exists:
+        module.exit_json(changed=changed, msg=msg)
+
     msg, changed = check_file_attrs(module, changed, msg)
     module.exit_json(changed=changed, msg=msg)
 
