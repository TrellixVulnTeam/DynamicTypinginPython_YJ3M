commit fd69c5687bb6a2fe4910766af4a58723e30c8c72
Author: gimoh <gimoh@bitmessage.ch>
Date:   Mon Feb 23 14:14:00 2015 +0000

    Do not insert extra newline if line already contains it
    
    When using YAML multi-line strings, e.g.:
    
    - lineinfile:
        dest: /tmp/foo
        line: >
          foo
          bar
    
    the line already ends with a newline.  If an extra newline is appended unconditionally it will lead to inserting an extra newline on each run.

diff --git a/lib/ansible/modules/files/lineinfile.py b/lib/ansible/modules/files/lineinfile.py
index fafb8470b5..6bcfb3b306 100644
--- a/lib/ansible/modules/files/lineinfile.py
+++ b/lib/ansible/modules/files/lineinfile.py
@@ -245,8 +245,11 @@ def present(module, dest, regexp, line, insertafter, insertbefore, create,
             # Don't do backref expansion if not asked.
             new_line = line
 
-        if lines[index[0]] != new_line + os.linesep:
-            lines[index[0]] = new_line + os.linesep
+        if not new_line.endswith(os.linesep):
+            new_line += os.linesep
+
+        if lines[index[0]] != new_line:
+            lines[index[0]] = new_line
             msg = 'line replaced'
             changed = True
     elif backrefs:
