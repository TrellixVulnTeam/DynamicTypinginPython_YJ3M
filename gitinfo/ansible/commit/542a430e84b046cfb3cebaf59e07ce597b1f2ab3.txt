commit 542a430e84b046cfb3cebaf59e07ce597b1f2ab3
Author: Daniele Varrazzo <piro@gambitresearch.com>
Date:   Tue Nov 3 14:39:22 2015 +0000

    Added tests to verify pip installation with VCS urls
    
    The test reproduces:
    - bug ansible/ansible#1705
    - bug ansible/ansible-modules-core#1645

diff --git a/test/integration/roles/test_pip/tasks/main.yml b/test/integration/roles/test_pip/tasks/main.yml
index fe5a4d29cd..6b1597dd8b 100644
--- a/test/integration/roles/test_pip/tasks/main.yml
+++ b/test/integration/roles/test_pip/tasks/main.yml
@@ -78,6 +78,41 @@
   pip: name={{ pip_test_package }} state=present
 
 
+# Test virtualenv installations
 
+- name: make sure the test env doesn't exist
+  file: state=absent name={{ output_dir }}/pipenv
 
+- name: create a requirement file with an vcs url
+  copy: dest={{ output_dir }}/pipreq.txt
+    content="-e git+https://github.com/dvarrazzo/pyiso8601#egg=pyiso8601"
 
+- name: install the requirement file in a virtualenv
+  pip: requirements={{ output_dir}}/pipreq.txt
+    virtualenv={{ output_dir }}/pipenv
+  register: req_installed
+
+- name: check that a change occurred
+  assert:
+    that:
+      - "req_installed.changed"
+
+- name: repeat installation to check status didn't change
+  pip: requirements={{ output_dir}}/pipreq.txt
+    virtualenv={{ output_dir }}/pipenv
+  register: req_installed
+
+- name: check that a change didn't occurr this time (bug ansible#1705)
+  assert:
+    that:
+      - "not req_installed.changed"
+
+- name: install the same module from url
+  pip: name="git+https://github.com/dvarrazzo/pyiso8601#egg=pyiso8601"
+    virtualenv={{ output_dir }}/pipenv
+  register: url_installed
+
+- name: check that a change didn't occurr (bug ansible-modules-core#1645)
+  assert:
+    that:
+      - "not url_installed.changed"
