commit d9576b3529c117e1e26b99cb496cb17ee1dbc634
Author: Petr Svoboda <petr@jatys.cz>
Date:   Fri Aug 2 12:53:08 2013 +0200

    Tidy up fix of git module traceback

diff --git a/library/source_control/git b/library/source_control/git
index 20e204c6ad..3bc3324eec 100644
--- a/library/source_control/git
+++ b/library/source_control/git
@@ -271,7 +271,6 @@ def switch_version(git_path, module, dest, remote, version):
                 cmd = "%s reset --hard %s/%s" % (git_path, remote, version)
         else:
             cmd = "%s checkout --force %s" % (git_path, version)
-        branch = version
     else:
         branch = get_head_branch(git_path, module, dest, remote)
         (rc, out, err) = module.run_command("%s checkout --force %s" % (git_path, branch))
@@ -280,7 +279,10 @@ def switch_version(git_path, module, dest, remote, version):
         cmd = "%s reset --hard %s" % (git_path, remote)
     (rc, out1, err1) = module.run_command(cmd)
     if rc != 0:
-        module.fail_json(msg="Failed to checkout branch %s" % (branch))
+        if version != 'HEAD':
+            module.fail_json(msg="Failed to checkout %s" % (version))
+        else:
+            module.fail_json(msg="Failed to checkout branch %s" % (branch))
     (rc, out2, err2) = submodule_update(git_path, module, dest)
     return (rc, out1 + out2, err1 + err2)
 
