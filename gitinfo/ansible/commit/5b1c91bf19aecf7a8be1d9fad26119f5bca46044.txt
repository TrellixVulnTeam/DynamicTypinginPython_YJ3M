commit 5b1c91bf19aecf7a8be1d9fad26119f5bca46044
Author: Trishna Guha <trishnaguha17@gmail.com>
Date:   Tue Sep 12 13:25:01 2017 +0530

    nxos_system parse name_servers fix (#29944)
    
    * nxos_system parse name_servers fix
    
    Signed-off-by: Trishna Guha <trishnaguha17@gmail.com>
    
    * fix nxos_system tests
    
    Signed-off-by: Trishna Guha <trishnaguha17@gmail.com>

diff --git a/lib/ansible/modules/network/nxos/nxos_system.py b/lib/ansible/modules/network/nxos/nxos_system.py
index 0059be17cc..da51e2bd42 100644
--- a/lib/ansible/modules/network/nxos/nxos_system.py
+++ b/lib/ansible/modules/network/nxos/nxos_system.py
@@ -238,12 +238,14 @@ def parse_domain_search(config, vrf_config):
 
     return objects
 
-def parse_name_servers(config, vrf_config):
+def parse_name_servers(config, vrf_config, vrfs):
     objects = list()
 
     match = re.search('^ip name-server (.+)$', config, re.M)
     if match:
         for addr in match.group(1).split(' '):
+            if addr == 'use-vrf' or addr in vrfs:
+                continue
             objects.append({'server': addr, 'vrf': None})
 
     for vrf, cfg in iteritems(vrf_config):
@@ -275,7 +277,7 @@ def map_config_to_obj(module):
         'domain_lookup': 'no ip domain-lookup' not in config,
         'domain_name': parse_domain_name(config, vrf_config),
         'domain_search': parse_domain_search(config, vrf_config),
-        'name_servers': parse_name_servers(config, vrf_config),
+        'name_servers': parse_name_servers(config, vrf_config, vrfs),
         'system_mtu': parse_system_mtu(config)
     }
 
diff --git a/test/integration/targets/nxos_system/tests/cli/set_name_servers.yaml b/test/integration/targets/nxos_system/tests/cli/set_name_servers.yaml
index 735bbd26f3..f8114e83ca 100644
--- a/test/integration/targets/nxos_system/tests/cli/set_name_servers.yaml
+++ b/test/integration/targets/nxos_system/tests/cli/set_name_servers.yaml
@@ -22,7 +22,6 @@
 - assert:
     that:
       - result.changed == true
-      - result.commands|length == 3
       - "'ip name-server 1.1.1.1' in result.commands"
       - "'ip name-server 2.2.2.2' in result.commands"
       - "'ip name-server 3.3.3.3' in result.commands"
diff --git a/test/integration/targets/nxos_system/tests/nxapi/set_name_servers.yaml b/test/integration/targets/nxos_system/tests/nxapi/set_name_servers.yaml
index 39620572d2..70879484eb 100644
--- a/test/integration/targets/nxos_system/tests/nxapi/set_name_servers.yaml
+++ b/test/integration/targets/nxos_system/tests/nxapi/set_name_servers.yaml
@@ -28,7 +28,6 @@
 - assert:
     that:
       - result.changed == true
-      - result.commands|length == 3
       - "'ip name-server 1.1.1.1' in result.commands"
       - "'ip name-server 2.2.2.2' in result.commands"
       - "'ip name-server 3.3.3.3' in result.commands"
