commit b441bcb678ca86c71b1f54f784df0db76453181c
Author: Toshio Kuratomi <a.badger@gmail.com>
Date:   Mon Oct 12 10:05:19 2015 -0700

    Fix display when run through a testing framework that overrides stderr/stdout

diff --git a/lib/ansible/utils/display.py b/lib/ansible/utils/display.py
index 5c392af8da..88e1a56804 100644
--- a/lib/ansible/utils/display.py
+++ b/lib/ansible/utils/display.py
@@ -26,6 +26,7 @@ import random
 import subprocess
 import sys
 import time
+import locale
 import logging
 import getpass
 from struct import unpack, pack
@@ -267,9 +268,13 @@ class Display:
 
     @staticmethod
     def _output_encoding(stderr=False):
-        if stderr:
-            return sys.stderr.encoding or 'utf-8'
-        return sys.stdout.encoding or 'utf-8'
+        encoding = locale.getpreferredencoding()
+        # https://bugs.python.org/issue6202
+        # Python2 hardcodes an obsolete value on Mac.  Use MacOSX defaults
+        # instead.
+        if encoding in ('mac-roman',):
+            encoding = 'utf-8'
+        return encoding
 
     def _set_column_width(self):
         if os.isatty(0):
