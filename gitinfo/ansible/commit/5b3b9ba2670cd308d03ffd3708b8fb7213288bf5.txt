commit 5b3b9ba2670cd308d03ffd3708b8fb7213288bf5
Author: James Tanner <tanner.jc@gmail.com>
Date:   Fri Mar 21 13:31:47 2014 -0400

    Addresses #4407 Caculate failed percentage based on serial and number of hosts in play

diff --git a/lib/ansible/playbook/__init__.py b/lib/ansible/playbook/__init__.py
index 88dd0f5f4b..ce17303bbc 100644
--- a/lib/ansible/playbook/__init__.py
+++ b/lib/ansible/playbook/__init__.py
@@ -674,8 +674,14 @@ class PlayBook(object):
                     play.max_fail_pct = 0
 
                 # If threshold for max nodes failed is exceeded , bail out.
-                if (hosts_count - len(host_list)) > int((play.max_fail_pct)/100.0 * hosts_count):
-                    host_list = None
+                if play.serial > 0:
+                    # if serial is set, we need to shorten the size of host_count
+                    play_count = len(play._play_hosts)
+                    if (play_count - len(host_list)) > int((play.max_fail_pct)/100.0 * play_count):
+                        host_list = None
+                else:
+                    if (hosts_count - len(host_list)) > int((play.max_fail_pct)/100.0 * hosts_count):
+                        host_list = None
 
                 # if no hosts remain, drop out
                 if not host_list:
