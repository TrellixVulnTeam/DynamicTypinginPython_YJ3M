commit 3f12fccd02c1a6481ff61740071e67c82562e469
Author: Toshio Kuratomi <a.badger@gmail.com>
Date:   Fri Aug 4 06:25:08 2017 -0700

    Fix several things causing tracebacks with unicode cwd (#27731)
    
    Fixes #27511

diff --git a/lib/ansible/cli/__init__.py b/lib/ansible/cli/__init__.py
index 89f2cd1a02..f656599027 100644
--- a/lib/ansible/cli/__init__.py
+++ b/lib/ansible/cli/__init__.py
@@ -161,7 +161,7 @@ class CLI(with_metaclass(ABCMeta, object)):
         running an Ansible command.
         """
 
-        display.vv(self.parser.get_version())
+        display.vv(to_text(self.parser.get_version()))
 
         if C.CONFIG_FILE:
             display.v(u"Using %s as config file" % to_text(C.CONFIG_FILE))
diff --git a/lib/ansible/plugins/vars/host_group_vars.py b/lib/ansible/plugins/vars/host_group_vars.py
index e72eae4552..1e35cb466b 100644
--- a/lib/ansible/plugins/vars/host_group_vars.py
+++ b/lib/ansible/plugins/vars/host_group_vars.py
@@ -35,7 +35,7 @@ __metaclass__ = type
 import os
 from ansible import constants as C
 from ansible.errors import AnsibleParserError
-from ansible.module_utils._text import to_bytes, to_text
+from ansible.module_utils._text import to_bytes, to_native, to_text
 from ansible.plugins.vars import BaseVarsPlugin
 from ansible.inventory.host import Host
 from ansible.inventory.group import Group
@@ -87,7 +87,7 @@ class VarsModule(BaseVarsPlugin):
                         data = combine_vars(data, new_data)
 
             except Exception as e:
-                raise AnsibleParserError(to_text(e))
+                raise AnsibleParserError(to_native(e))
         return data
 
     def _find_vars_files(self, path, name):
diff --git a/lib/ansible/utils/color.py b/lib/ansible/utils/color.py
index a82b6fef97..e6f35c0b58 100644
--- a/lib/ansible/utils/color.py
+++ b/lib/ansible/utils/color.py
@@ -90,7 +90,7 @@ def stringc(text, color):
 
     if ANSIBLE_COLOR:
         color_code = parsecolor(color)
-        return "\n".join([u"\033[%sm%s\033[0m" % (color_code, t) for t in text.split('\n')])
+        return u"\n".join([u"\033[%sm%s\033[0m" % (color_code, t) for t in text.split(u'\n')])
     else:
         return text
 
diff --git a/lib/ansible/utils/path.py b/lib/ansible/utils/path.py
index 67481cfe08..771aab30cb 100644
--- a/lib/ansible/utils/path.py
+++ b/lib/ansible/utils/path.py
@@ -75,7 +75,7 @@ def makedirs_safe(path, mode=None):
 
 def basedir(source):
     """ returns directory for inventory or playbook """
-
+    source = to_bytes(source, errors='surrogate_or_strict')
     dname = None
     if os.path.isdir(source):
         dname = source
@@ -88,4 +88,4 @@ def basedir(source):
         # don't follow symlinks for basedir, enables source re-use
         dname = os.path.abspath(dname)
 
-    return dname
+    return to_text(dname, errors='surrogate_or_strict')
