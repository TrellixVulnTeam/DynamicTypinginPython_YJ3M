commit 1b38bd8a40a643dc804d1ac23cb2681eb42278a4
Author: Brian Coca <bcoca@ansible.com>
Date:   Wed Mar 19 09:11:17 2014 -0400

    fixed issue with tmp file (path can include filename) and added missing
    else which made it try to link x2

diff --git a/library/files/file b/library/files/file
index 4296af2011..e1bdf53375 100644
--- a/library/files/file
+++ b/library/files/file
@@ -301,7 +301,7 @@ def main():
         if changed and not module.check_mode:
             if prev_state != 'absent':
                 # try to replace atomically
-                tmppath = ".%s.%s.%s.tmp" % (path,os.getpid(),time.time())
+                tmppath = '/'.join([os.path.dirname(path), ".%s.%s.tmp" % (os.getpid(),time.time())])
                 try:
                     if state == 'hard':
                         os.link(src,tmppath)
@@ -311,13 +311,14 @@ def main():
                 except OSError, e:
                     os.unlink(tmppath)
                     module.fail_json(path=path, msg='Error while replacing: %s' % str(e))
-            try:
-                if state == 'hard':
-                    os.link(src,path)
-                else:
-                    os.symlink(src, path)
-            except OSError, e:
-                module.fail_json(path=path, msg='Error while linking: %s' % str(e))
+            else:
+                try:
+                    if state == 'hard':
+                        os.link(src,path)
+                    else:
+                        os.symlink(src, path)
+                except OSError, e:
+                    module.fail_json(path=path, msg='Error while linking: %s' % str(e))
 
         changed = module.set_fs_attributes_if_different(file_args, changed)
         module.exit_json(dest=path, src=src, changed=changed)
