commit 9de3b035a6f29e6be7f41273f3a9bdb5dcf4b652
Author: anatoly techtonik <techtonik@gmail.com>
Date:   Tue Mar 4 20:00:18 2014 +0200

    setup: Fix KeyError: 'ipv4_secondaries' (issue #6274)

diff --git a/library/system/setup b/library/system/setup
index 1c51e52162..941a5dcd31 100644
--- a/library/system/setup
+++ b/library/system/setup
@@ -1562,13 +1562,13 @@ class LinuxNetwork(Network):
                         iface = words[-1]
                         if iface != device:
                             interfaces[iface] = {}
-                        if not secondary and "ipv4_secondaries" not in interfaces[iface]:
-                            interfaces[iface]["ipv4_secondaries"] = []
                         if not secondary or "ipv4" not in interfaces[iface]:
                             interfaces[iface]['ipv4'] = {'address': address,
                                                          'netmask': netmask,
                                                          'network': network}
                         else:
+                            if "ipv4_secondaries" not in interfaces[iface]:
+                                interfaces[iface]["ipv4_secondaries"] = []
                             interfaces[iface]["ipv4_secondaries"].append({
                                 'address': address,
                                 'netmask': netmask,
@@ -1577,6 +1577,8 @@ class LinuxNetwork(Network):
 
                         # add this secondary IP to the main device
                         if secondary:
+                            if "ipv4_secondaries" not in interfaces[device]:
+                                interfaces[device]["ipv4_secondaries"] = []
                             interfaces[device]["ipv4_secondaries"].append({
                                 'address': address,
                                 'netmask': netmask,
