commit fe06577ac284de31718c4723809b1d5e1cf5ca4f
Author: Brian Coca <bcoca@ansible.com>
Date:   Thu Aug 20 21:52:46 2015 -0400

    fixed mandatory test

diff --git a/lib/ansible/plugins/test/core.py b/lib/ansible/plugins/test/core.py
index cc8c702d75..7de8e7436c 100644
--- a/lib/ansible/plugins/test/core.py
+++ b/lib/ansible/plugins/test/core.py
@@ -58,15 +58,6 @@ def skipped(*a, **kw):
     skipped = item.get('skipped', False)
     return skipped
 
-def mandatory(a):
-    ''' Make a variable mandatory '''
-    try:
-        a
-    except NameError:
-        raise errors.AnsibleFilterError('Mandatory variable not defined.')
-    else:
-        return a
-
 def regex(value='', pattern='', ignorecase=False, match_type='search'):
     ''' Expose `re` as a boolean filter using the `search` method by default.
         This is likely only useful for `search` and `match` which already
@@ -88,6 +79,14 @@ def search(value, pattern='', ignorecase=False):
     ''' Perform a `re.search` returning a boolean '''
     return regex(value, pattern, ignorecase, 'search')
 
+def mandatory(a):
+    from jinja2.runtime import Undefined
+
+    ''' Make a variable mandatory '''
+    if isinstance(a, Undefined):
+        raise errors.AnsibleFilterError('Mandatory variable not defined.')
+    return a
+
 class TestModule(object):
     ''' Ansible core jinja2 tests '''
 
