commit 6a3e948a7c5a2f8c3c5c0445f2d5de7aedc0b817
Author: Rene Moser <mail@renemoser.net>
Date:   Tue Sep 13 16:03:58 2016 +0200

    jenkins_job: add integration tests (#17499)

diff --git a/test/integration/Makefile b/test/integration/Makefile
index b735331037..857b70e1a0 100644
--- a/test/integration/Makefile
+++ b/test/integration/Makefile
@@ -272,6 +272,11 @@ exoscale:
 	RC=$$? ; \
 	exit $$RC;
 
+jenkins:
+	ansible-playbook jenkins.yml -i $(INVENTORY) -e @$(VARS_FILE) -v $(TEST_FLAGS) ; \
+	RC=$$? ; \
+	exit $$RC;
+
 cloudflare: $(CREDENTIALS_FILE)
 	ansible-playbook cloudflare.yml -i $(INVENTORY) -e @$(VARS_FILE) -e @$(CREDENTIALS_FILE) -e "resource_prefix=$(CLOUD_RESOURCE_PREFIX)" -v $(TEST_FLAGS) ; \
 	RC=$$? ; \
diff --git a/test/integration/jenkins.yml b/test/integration/jenkins.yml
new file mode 100644
index 0000000000..a20e4bdc2b
--- /dev/null
+++ b/test/integration/jenkins.yml
@@ -0,0 +1,8 @@
+---
+- hosts: localhost
+  connection: local
+  gather_facts: no
+  tags:
+    - jenkins
+  roles:
+    - test_jenkins_job
diff --git a/test/integration/roles/test_jenkins_job/defaults/main.yml b/test/integration/roles/test_jenkins_job/defaults/main.yml
new file mode 100644
index 0000000000..ab05bc3096
--- /dev/null
+++ b/test/integration/roles/test_jenkins_job/defaults/main.yml
@@ -0,0 +1,5 @@
+---
+jenkins_url: http://localhost:8080
+jenkins_user: admin
+jenkins_password: ""
+jenkins_days_to_keep: 20
diff --git a/test/integration/roles/test_jenkins_job/tasks/main.yml b/test/integration/roles/test_jenkins_job/tasks/main.yml
new file mode 100644
index 0000000000..21962d8007
--- /dev/null
+++ b/test/integration/roles/test_jenkins_job/tasks/main.yml
@@ -0,0 +1,157 @@
+---
+- name: setup
+  local_action:
+     module: jenkins_job
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+     state: absent
+  register: result
+- name: verify setup
+  assert:
+    that:
+    - result|success
+
+- name: test create a job
+  local_action:
+     module: jenkins_job
+     config: "{{ lookup('template', 'config.xml.j2') }}"
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+  register: result
+- name: verify test create a job
+  assert:
+    that:
+    - result|success
+    - result|changed
+    - result.enabled
+
+- name: test create a job idempotence
+  local_action:
+     module: jenkins_job
+     config: "{{ lookup('template', 'config.xml.j2') }}"
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+  register: result
+- name: verify test create a job idempotence
+  assert:
+    that:
+    - result|success
+    - not result|changed
+    - result.enabled
+
+- name: test create a enabled job idempotence
+  local_action:
+     module: jenkins_job
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+     enabled: true
+  register: result
+- name: verify test create a enabled job idempotence
+  assert:
+    that:
+    - result|success
+    - not result|changed
+    - result.enabled
+
+- name: test update a job
+  local_action:
+     module: jenkins_job
+     config: "{{ lookup('template', 'config.xml.j2') }}"
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+  register: result
+  vars:
+    jenkins_days_to_keep: 10
+- name: verify test create a enabled job idempotence
+  assert:
+    that:
+    - result|success
+    - result|changed
+    - result.enabled
+
+- name: test disable an exising job without config
+  local_action:
+     module: jenkins_job
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+     enabled: false
+  register: result
+- name: verify test disable an exising job without config
+  assert:
+    that:
+    - result|success
+    - result|changed
+    - not result.enabled
+
+- name: test disable an exising job without config idempotence
+  local_action:
+     module: jenkins_job
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+     enabled: false
+  register: result
+- name: verify test disable an exising job without config idempotence
+  assert:
+    that:
+    - result|success
+    - not result|changed
+    - not result.enabled
+
+- name: test reset to config job
+  local_action:
+     module: jenkins_job
+     config: "{{ lookup('template', 'config.xml.j2') }}"
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+  register: result
+- name: verify test reset to config job
+  assert:
+    that:
+    - result|success
+    - result|changed
+
+- name: test remove job
+  local_action:
+     module: jenkins_job
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+     state: absent
+  register: result
+- name: verify test remove job
+  assert:
+    that:
+    - result|success
+    - result|changed
+
+- name: test remove job idempotence
+  local_action:
+     module: jenkins_job
+     name: test.job
+     url: "{{ jenkins_url }}"
+     user: "{{ jenkins_user }}"
+     password: "{{ jenkins_password }}"
+     state: absent
+  register: result
+- name: verify test remove job idempotence
+  assert:
+    that:
+    - result|success
+    - not result|changed
diff --git a/test/integration/roles/test_jenkins_job/templates/config.xml.j2 b/test/integration/roles/test_jenkins_job/templates/config.xml.j2
new file mode 100644
index 0000000000..c7249198b8
--- /dev/null
+++ b/test/integration/roles/test_jenkins_job/templates/config.xml.j2
@@ -0,0 +1,29 @@
+<?xml version='1.0' encoding='UTF-8'?>
+<project>
+  <actions/>
+  <description></description>
+  <keepDependencies>false</keepDependencies>
+  <properties>
+    <jenkins.model.BuildDiscarderProperty>
+      <strategy class="hudson.tasks.LogRotator">
+        <daysToKeep>{{ jenkins_days_to_keep }}</daysToKeep>
+        <numToKeep>20</numToKeep>
+        <artifactDaysToKeep>-1</artifactDaysToKeep>
+        <artifactNumToKeep>-1</artifactNumToKeep>
+      </strategy>
+    </jenkins.model.BuildDiscarderProperty>
+    <org.jenkinsci.plugins.gitbucket.GitBucketProjectProperty plugin="gitbucket@0.8">
+      <linkEnabled>false</linkEnabled>
+    </org.jenkinsci.plugins.gitbucket.GitBucketProjectProperty>
+  </properties>
+  <scm class="hudson.scm.NullSCM"/>
+  <canRoam>true</canRoam>
+  <disabled>false</disabled>
+  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
+  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
+  <triggers/>
+  <concurrentBuild>false</concurrentBuild>
+  <builders/>
+  <publishers/>
+  <buildWrappers/>
+</project>
