commit 9d48884e36fb4fd9551f000b87d264383de74e75
Author: Cl√©ment Notin <clement@notin.org>
Date:   Tue May 5 17:31:32 2020 +0200

    Fix support for Kali Linux detection (#69194)
    
    * Fix support for Kali Linux detection
    
    * Add test for Kali Linux detection
    
    * Improve path matching with "in list"
    
    Co-Authored-By: Abhijeet Kasurde <akasurde@redhat.com>
    
    Co-authored-by: Abhijeet Kasurde <akasurde@redhat.com>

diff --git a/lib/ansible/module_utils/facts/system/distribution.py b/lib/ansible/module_utils/facts/system/distribution.py
index 606dbc19bd..528b0e2b9e 100644
--- a/lib/ansible/module_utils/facts/system/distribution.py
+++ b/lib/ansible/module_utils/facts/system/distribution.py
@@ -320,7 +320,8 @@ class DistributionFiles:
         elif 'SteamOS' in data:
             debian_facts['distribution'] = 'SteamOS'
             # nothing else to do, SteamOS gets correct info from python functions
-        elif path == '/etc/lsb-release' and 'Kali' in data:
+        elif path in ('/etc/lsb-release', '/etc/os-release') and 'Kali' in data:
+            # Kali does not provide /etc/lsb-release anymore
             debian_facts['distribution'] = 'Kali'
             release = re.search('DISTRIB_RELEASE=(.*)', data)
             if release:
diff --git a/test/units/module_utils/test_distribution_version.py b/test/units/module_utils/test_distribution_version.py
index c92e3a4024..c709b76a53 100644
--- a/test/units/module_utils/test_distribution_version.py
+++ b/test/units/module_utils/test_distribution_version.py
@@ -990,6 +990,40 @@ TESTSETS = [
             'os_family': 'Debian'
         }
     },
+    {
+        'name': 'Kali 2020.2',
+        'input': {
+            '/etc/os-release': ("PRETTY_NAME=\"Kali GNU/Linux Rolling\"\nNAME=\"Kali GNU/Linux\"\nID=kali\nVERSION=\"2020.2\"\n"
+                                "VERSION_ID=\"2020.2\"\nVERSION_CODENAME=\"kali-rolling\"\nID_LIKE=debian\nANSI_COLOR=\"1;31\"\n"
+                                "HOME_URL=\"https://www.kali.org/\"\nSUPPORT_URL=\"https://forums.kali.org/\"\n"
+                                "BUG_REPORT_URL=\"https://bugs.kali.org/\""),
+            '/usr/lib/os-release': ("PRETTY_NAME=\"Kali GNU/Linux Rolling\"\nNAME=\"Kali GNU/Linux\"\nID=kali\nVERSION=\"2020.2\"\n"
+                                "VERSION_ID=\"2020.2\"\nVERSION_CODENAME=\"kali-rolling\"\nID_LIKE=debian\nANSI_COLOR=\"1;31\"\n"
+                                "HOME_URL=\"https://www.kali.org/\"\nSUPPORT_URL=\"https://forums.kali.org/\"\n"
+                                "BUG_REPORT_URL=\"https://bugs.kali.org/\"")
+        },
+        'platform.dist': [
+            'kali',
+            '2020.2',
+            ''
+        ],
+        'distro': {
+            'codename': 'kali-rolling',
+            'id': 'kali',
+            'name': 'Kali GNU/Linux Rolling',
+            'version': '2020.2',
+            'version_best': '2020.2',
+            'os_release_info': {},
+            'lsb_release_info': {},
+        },
+        'result': {
+            'distribution': 'Kali',
+            'distribution_version': '2020.2',
+            'distribution_release': 'kali-rolling',
+            'distribution_major_version': '2020',
+            'os_family': 'Debian'
+        }
+    },
     {
         "platform.dist": [
             "neon",
