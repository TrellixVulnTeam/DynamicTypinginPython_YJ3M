commit 5b5d24631af8e09f2fea0ed39d17f4733030e0e7
Author: Mike Wiebe <mwiebe@cisco.com>
Date:   Fri Feb 16 23:44:50 2018 -0500

    Fix nxos_system tests (#36201)
    
    * Fix nxos_system tests
    
    * Add debug connection plugin info
    
    * Move sanity test under common

diff --git a/test/integration/targets/nxos_system/tests/common/sanity.yaml b/test/integration/targets/nxos_system/tests/common/sanity.yaml
new file mode 100644
index 0000000000..af6da7585e
--- /dev/null
+++ b/test/integration/targets/nxos_system/tests/common/sanity.yaml
@@ -0,0 +1,36 @@
+---
+- debug: msg="START connection={{ ansible_connection }}/sanity.yaml"
+- debug: msg="Using provider={{ connection.transport }}"
+  when: ansible_connection == "local"
+
+- block:
+  - name: configure hostname and domain-name
+    nxos_system: &hostname
+      hostname: "{{ inventory_hostname_short }}"
+      domain_name: test.example.com
+      provider: "{{ connection }}"
+
+  - name: remove configuration
+    nxos_system:
+      state: absent
+      provider: "{{ connection }}"
+
+  - name: configure name servers
+    nxos_system:
+      name_servers:
+        - 8.8.8.8
+        - 8.8.4.4
+      provider: "{{ connection }}"
+
+  - name: configure name servers with VRF support
+    nxos_system:
+      name_servers:
+        - { server: 8.8.8.8, vrf: management }
+        - { server: 8.8.4.4, vrf: management }
+      provider: "{{ connection }}"
+
+  always:
+  - name: Re-configure hostname
+    nxos_system: *hostname
+
+  - debug: msg="END connection={{ ansible_connection }}/sanity.yaml" 
diff --git a/test/integration/targets/nxos_system/tests/common/set_hostname.yaml b/test/integration/targets/nxos_system/tests/common/set_hostname.yaml
index a5d5eafab7..a5b8d021fc 100644
--- a/test/integration/targets/nxos_system/tests/common/set_hostname.yaml
+++ b/test/integration/targets/nxos_system/tests/common/set_hostname.yaml
@@ -3,36 +3,39 @@
 - debug: msg="Using provider={{ connection.transport }}"
   when: ansible_connection == "local"
 
-- name: setup
-  nxos_config:
-    lines: hostname switch
-    match: none
-    provider: "{{ connection }}"
-
-- name: configure hostname
-  nxos_system:
-    hostname: foo
-    provider: "{{ connection }}"
-  register: result
-
-- assert:
-    that:
-      - "result.changed == true"
-
-- name: verify hostname
-  nxos_system:
-    hostname: foo
-    provider: "{{ connection }}"
-  register: result
-
-- assert:
-    that:
-      - "result.changed == false"
-
-- name: teardown
-  nxos_config:
-    lines: hostname switch
-    match: none
-    provider: "{{ connection }}"
-
-- debug: msg="END connection={{ ansible_connection }}/set_hostname.yaml"
+- block:
+  - name: setup
+    nxos_config:
+      lines: "hostname {{ inventory_hostname }}"
+      match: none
+      provider: "{{ connection }}"
+
+  - name: configure hostname
+    nxos_system:
+      hostname: foo
+      provider: "{{ connection }}"
+    register: result
+
+  - assert:
+      that:
+        - "result.changed == true"
+
+  - name: verify hostname
+    nxos_system:
+      hostname: foo
+      provider: "{{ connection }}"
+    register: result
+
+  - assert:
+      that:
+        - "result.changed == false"
+
+  always:
+  - name: teardown
+    nxos_config:
+      lines: "hostname {{ inventory_hostname }}"
+      match: none
+      provider: "{{ connection }}"
+
+
+  - debug: msg="END connection={{ ansible_connection }}/set_hostname.yaml"
diff --git a/test/integration/targets/nxos_system/tests/nxapi/net_system.yaml b/test/integration/targets/nxos_system/tests/nxapi/net_system.yaml
index 8193f809b8..e808e9d78d 100644
--- a/test/integration/targets/nxos_system/tests/nxapi/net_system.yaml
+++ b/test/integration/targets/nxos_system/tests/nxapi/net_system.yaml
@@ -12,6 +12,7 @@
       - no ip domain-list redhat.com
     match: none
     provider: "{{ nxapi }}"
+  ignore_errors: yes
 
 - name: configure domain_list using platform agnostic module
   net_system:
