commit b6e997aa5f0a33b96701e51c1123e7b1b4dcf594
Author: Andrey Klychkov <aaklychkov@mail.ru>
Date:   Sat Oct 19 14:10:35 2019 +0300

    Cleanup after MariaDB integration tests (#63657)

diff --git a/test/integration/targets/setup_mariadb/defaults/main.yml b/test/integration/targets/setup_mariadb/defaults/main.yml
index 69b8b7c7d4..a20d333add 100644
--- a/test/integration/targets/setup_mariadb/defaults/main.yml
+++ b/test/integration/targets/setup_mariadb/defaults/main.yml
@@ -1,7 +1,24 @@
+repo_link: http://yum.mariadb.org/10.1/centos7-amd64
+repo_gpgkey: https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
+
+mariadb_packages:
+- MariaDB-server
+- MariaDB-client
+
+packages_to_cleanup:
+- MariaDB-server
+- MariaDB-client
+- MariaDB-common
+- boost-program-options
+- galera
+- jemalloc
+
 master_port: 3306
-standby_port: 3307
 master_datadir: /var/lib/mysql_master
+
+standby_port: 3307
 standby_datadir: /var/lib/mysql_standby
 standby_logdir: /var/log/mysql_standby
+
 default_logdir: /var/log/mariadb
 mysql_safe_err_log: /var/log/mariadb/mysql_safe-err.log
diff --git a/test/integration/targets/setup_mariadb/handlers/main.yml b/test/integration/targets/setup_mariadb/handlers/main.yml
new file mode 100644
index 0000000000..584fd28817
--- /dev/null
+++ b/test/integration/targets/setup_mariadb/handlers/main.yml
@@ -0,0 +1,24 @@
+- name: Remove MariaDB repo
+  yum_repository:
+    name: MariaDB
+    state: absent
+  listen: cleanup mariadb
+
+- name: Remove MariaDB related packages
+  yum:
+    name: "{{ item }}"
+    state: absent
+  loop: "{{ packages_to_cleanup }}"
+  listen: cleanup mariadb
+
+- name: Remove related FS objects
+  file:
+    state: absent
+    path: "{{ item }}"
+  loop:
+  - "{{ master_datadir }}"
+  - "{{ standby_datadir }}"
+  - "{{ standby_logdir }}"
+  - "{{ default_logdir }}"
+  - "{{ mysql_safe_err_log }}"
+  listen: cleanup mariadb
diff --git a/test/integration/targets/setup_mariadb/tasks/main.yml b/test/integration/targets/setup_mariadb/tasks/main.yml
index d77d90f9cd..392efa4f7f 100644
--- a/test/integration/targets/setup_mariadb/tasks/main.yml
+++ b/test/integration/targets/setup_mariadb/tasks/main.yml
@@ -2,4 +2,6 @@
 # GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
 
 - import_tasks: setup_mariadb.yml
-  when: ansible_distribution == 'CentOS' and ansible_distribution_major_version >= '7'
+  when:
+  - ansible_distribution == 'CentOS'
+  - ansible_distribution_major_version >= '7'
diff --git a/test/integration/targets/setup_mariadb/tasks/setup_mariadb.yml b/test/integration/targets/setup_mariadb/tasks/setup_mariadb.yml
index 5a26eaa899..845c46bc8c 100644
--- a/test/integration/targets/setup_mariadb/tasks/setup_mariadb.yml
+++ b/test/integration/targets/setup_mariadb/tasks/setup_mariadb.yml
@@ -5,20 +5,20 @@
   yum_repository:
     name: MariaDB
     description: MariaDB official repo
-    baseurl: http://yum.mariadb.org/10.1/centos7-amd64
-    gpgkey: https://yum.mariadb.org/RPM-GPG-KEY-MariaDB
+    baseurl: "{{ repo_link }}"
+    gpgkey: "{{ repo_gpgkey }}"
     gpgcheck: yes
+  notify: cleanup mariadb
 
 - name: Install MariaDB packages on RedHat family OS
   yum:
     name: "{{ item }}"
     enablerepo: epel
-  loop:
-  - MariaDB-server
-  - MariaDB-client
+  loop: "{{ mariadb_packages }}"
   when: ansible_os_family == 'RedHat'
+  notify: cleanup mariadb
 
-- name: Create directories for standby
+- name: Create directories for instances
   file:
     state: directory
     path: "{{ item }}"
@@ -29,6 +29,7 @@
   - "{{ standby_datadir }}"
   - "{{ standby_logdir }}"
   - "{{ default_logdir }}"
+  notify: cleanup mariadb
 
 - name: Copy cnf template
   template:
