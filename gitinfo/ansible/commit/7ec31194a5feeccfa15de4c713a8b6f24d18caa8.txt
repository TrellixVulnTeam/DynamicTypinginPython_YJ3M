commit 7ec31194a5feeccfa15de4c713a8b6f24d18caa8
Author: s-hertel <shertel@redhat.com>
Date:   Tue Jul 2 09:17:18 2019 -0400

    Ensure only running instance facts are retrieved to match the following assertion
    Otherwise lingering terminated instances may be in the result
    Use the instance profile arn or the role name, but not the role arn
    Mark tests as unstable

diff --git a/test/integration/targets/ec2_instance/aliases b/test/integration/targets/ec2_instance/aliases
index 6e3860bee2..5e7a8d3877 100644
--- a/test/integration/targets/ec2_instance/aliases
+++ b/test/integration/targets/ec2_instance/aliases
@@ -1,2 +1,3 @@
 cloud/aws
 shippable/aws/group2
+unstable
diff --git a/test/integration/targets/ec2_instance/tasks/iam_instance_role.yml b/test/integration/targets/ec2_instance/tasks/iam_instance_role.yml
index c06b6a6042..dc70897012 100644
--- a/test/integration/targets/ec2_instance/tasks/iam_instance_role.yml
+++ b/test/integration/targets/ec2_instance/tasks/iam_instance_role.yml
@@ -50,7 +50,7 @@
         image_id: "{{ ec2_ami_image[aws_region] }}"
         security_groups: "{{ sg.group_id }}"
         instance_type: t2.micro
-        instance_role: "{{ iam_role.arn }}"
+        instance_role: "{{ iam_role.arn.replace(':role/', ':instance-profile/') }}"
         <<: *aws_connection_info
       check_mode: yes
 
@@ -80,7 +80,7 @@
         image_id: "{{ ec2_ami_image[aws_region] }}"
         security_groups: "{{ sg.group_id }}"
         instance_type: t2.micro
-        instance_role: "{{ iam_role_2.arn }}"
+        instance_role: "{{ iam_role_2.arn.replace(':role/', ':instance-profile/') }}"
         <<: *aws_connection_info
       register: instance_with_updated_role
       until: instance_with_updated_role is not failed
diff --git a/test/integration/targets/ec2_instance/tasks/main.yml b/test/integration/targets/ec2_instance/tasks/main.yml
index 6e3bece24c..030966569e 100644
--- a/test/integration/targets/ec2_instance/tasks/main.yml
+++ b/test/integration/targets/ec2_instance/tasks/main.yml
@@ -6,8 +6,6 @@
 #  - EC2_REGION -> AWS_REGION
 #
 
-# - include: ../../../../../setup_ec2/tasks/common.yml module_name: ec2_instance
-
 - block:
 
     - include_tasks: env_setup.yml
@@ -24,4 +22,4 @@
 
   always:
     - include_tasks: env_cleanup.yml
-      when: aws_cleanup
\ No newline at end of file
+      when: aws_cleanup
diff --git a/test/integration/targets/ec2_instance/tasks/termination_protection.yml b/test/integration/targets/ec2_instance/tasks/termination_protection.yml
index 25fb17901a..10fcd73521 100644
--- a/test/integration/targets/ec2_instance/tasks/termination_protection.yml
+++ b/test/integration/targets/ec2_instance/tasks/termination_protection.yml
@@ -19,6 +19,7 @@
         termination_protection: true
         instance_type: t2.micro
         state: running
+        wait: yes
         <<: *aws_connection_info
       register: in_test_vpc
 
@@ -39,6 +40,7 @@
       ec2_instance_info:
         filters:
           "tag:Name": "{{ resource_prefix }}-test-protected-instance-in-vpc"
+          "instance-state-name": "running"
         <<: *aws_connection_info
       register: presented_instance_fact
 
