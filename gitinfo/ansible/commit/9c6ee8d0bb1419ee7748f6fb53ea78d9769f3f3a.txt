commit 9c6ee8d0bb1419ee7748f6fb53ea78d9769f3f3a
Author: Trishna Guha <trishnaguha17@gmail.com>
Date:   Thu Jun 15 22:05:38 2017 +0530

    Add nxos_banner implementation module (#25695)
    
    * Add nxos_banner implementation module
    
    Signed-off-by: Trishna Guha <trishnaguha17@gmail.com>
    
    * nxos_banner integration test
    
    Signed-off-by: Trishna Guha <trishnaguha17@gmail.com>
    
    * nxos_banner unit test
    
    Signed-off-by: Trishna Guha <trishnaguha17@gmail.com>
    
    * doc update
    
    Signed-off-by: Trishna Guha <trishnaguha17@gmail.com>

diff --git a/lib/ansible/modules/network/nxos/nxos_banner.py b/lib/ansible/modules/network/nxos/nxos_banner.py
new file mode 100644
index 0000000000..a40407f771
--- /dev/null
+++ b/lib/ansible/modules/network/nxos/nxos_banner.py
@@ -0,0 +1,173 @@
+#!/usr/bin/python
+# -*- coding: utf-8 -*-
+
+# (c) 2017, Ansible by Red Hat, inc
+#
+# This file is part of Ansible by Red Hat
+#
+# Ansible is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or
+# (at your option) any later version.
+#
+# Ansible is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
+#
+
+ANSIBLE_METADATA = {'metadata_version': '1.0',
+                    'status': ['preview'],
+                    'supported_by': 'core'}
+
+DOCUMENTATION = """
+---
+module: nxos_banner
+version_added: "2.4"
+author: "Trishna Guha (@trishnag)"
+short_description: Manage multiline banners on Cisco NXOS devices
+description:
+  - This will configure both exec and motd banners on remote devices
+    running Cisco NXOS. It allows playbooks to add or remote
+    banner text from the active running configuration.
+options:
+  banner:
+    description:
+      - Specifies which banner that should be
+        configured on the remote device.
+    required: true
+    default: null
+    choices: ['exec', 'banner']
+  text:
+    description:
+      - The banner text that should be
+        present in the remote device running configuration. This argument
+        accepts a multiline string, with no empty lines. Requires I(state=present).
+    default: null
+  state:
+    description:
+      - Specifies whether or not the configuration is present in the current
+        devices active running configuration.
+    default: present
+    choices: ['present', 'absent']
+"""
+
+EXAMPLES = """
+- name: configure the exec banner
+  nxos_banner:
+    banner: exec
+    text: |
+      this is my exec banner
+      that contains a multiline
+      string
+    state: present
+- name: remove the motd banner
+  nxos_banner:
+    banner: motd
+    state: absent
+- name: Configure banner from file
+  nxos_banner:
+    banner:  motd
+    text: "{{ lookup('file', './config_partial/raw_banner.cfg') }}"
+    state: present
+"""
+
+RETURN = """
+commands:
+  description: The list of configuration mode commands to send to the device
+  returned: always
+  type: list
+  sample:
+    - banner exec
+    - this is my exec banner
+    - that contains a multiline
+    - string
+"""
+
+from ansible.module_utils.basic import AnsibleModule
+from ansible.module_utils.nxos import load_config, run_commands
+from ansible.module_utils.nxos import nxos_argument_spec, check_args
+
+
+def map_obj_to_commands(updates, module):
+    commands = list()
+    want, have = updates
+    state = module.params['state']
+
+    if state == 'absent' or (state == 'absent' and
+                             'text' in have.keys() and have['text']):
+        commands.append('no banner %s' % module.params['banner'])
+
+    elif state == 'present':
+        if want['text'] and (want['text'] != have.get('text')):
+            banner_cmd = 'banner %s' % module.params['banner']
+            banner_cmd += ' @\n'
+            banner_cmd += want['text'].strip()
+            banner_cmd += '\n@'
+            commands.append(banner_cmd)
+
+    return commands
+
+
+def map_config_to_obj(module):
+    output = run_commands(module, ['show banner %s' % module.params['banner']])[0]
+    obj = {'banner': module.params['banner'], 'state': 'absent'}
+    if output:
+        obj['text'] = output
+        obj['state'] = 'present'
+    return obj
+
+
+def map_params_to_obj(module):
+    text = module.params['text']
+    if text:
+        text = str(text).strip()
+
+    return {
+        'banner': module.params['banner'],
+        'text': text,
+        'state': module.params['state']
+    }
+
+
+def main():
+    """ main entry point for module execution
+    """
+    argument_spec = dict(
+        banner=dict(required=True, choices=['exec', 'motd']),
+        text=dict(),
+        state=dict(default='present', choices=['present', 'absent'])
+    )
+
+    argument_spec.update(nxos_argument_spec)
+
+    required_if = [('state', 'present', ('text',))]
+
+    module = AnsibleModule(argument_spec=argument_spec,
+                           required_if=required_if,
+                           supports_check_mode=True)
+
+    warnings = list()
+    check_args(module, warnings)
+
+    result = {'changed': False}
+    if warnings:
+        result['warnings'] = warnings
+    want = map_params_to_obj(module)
+    have = map_config_to_obj(module)
+
+    commands = map_obj_to_commands((want, have), module)
+    result['commands'] = commands
+
+    if commands:
+        if not module.check_mode:
+            load_config(module, commands)
+        result['changed'] = True
+
+    module.exit_json(**result)
+
+if __name__ == '__main__':
+    main()
diff --git a/test/integration/nxos.yaml b/test/integration/nxos.yaml
index 83a9b9d07b..99aa73fb2e 100644
--- a/test/integration/nxos.yaml
+++ b/test/integration/nxos.yaml
@@ -19,3 +19,4 @@
     - { role: nxos_system, when: "limit_to in ['*', 'nxos_system']" }
     - { role: nxos_interface, when: "limit_to in ['*', 'nxos_interface']" }
     - { role: nxos_user, when: "limit_to in ['*', 'nxos_user']" }
+    - { role: nxos_banner, when: "limit_to in ['*', 'nxos_banner']" }
diff --git a/test/integration/targets/nxos_banner/defaults/main.yaml b/test/integration/targets/nxos_banner/defaults/main.yaml
new file mode 100644
index 0000000000..9ef5ba5165
--- /dev/null
+++ b/test/integration/targets/nxos_banner/defaults/main.yaml
@@ -0,0 +1,3 @@
+---
+testcase: "*"
+test_items: []
diff --git a/test/integration/targets/nxos_banner/meta/main.yaml b/test/integration/targets/nxos_banner/meta/main.yaml
new file mode 100644
index 0000000000..ae741cbdc7
--- /dev/null
+++ b/test/integration/targets/nxos_banner/meta/main.yaml
@@ -0,0 +1,2 @@
+dependencies:
+  - prepare_nxos_tests
diff --git a/test/integration/targets/nxos_banner/tasks/cli.yaml b/test/integration/targets/nxos_banner/tasks/cli.yaml
new file mode 100644
index 0000000000..d675462dd0
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tasks/cli.yaml
@@ -0,0 +1,15 @@
+---
+- name: collect all cli test cases
+  find:
+    paths: "{{ role_path }}/tests/cli"
+    patterns: "{{ testcase }}.yaml"
+  register: test_cases
+
+- name: set test_items
+  set_fact: test_items="{{ test_cases.files | map(attribute='path') | list }}"
+
+- name: run test case
+  include: "{{ test_case_to_run }}"
+  with_items: "{{ test_items }}"
+  loop_control:
+    loop_var: test_case_to_run
diff --git a/test/integration/targets/nxos_banner/tasks/main.yaml b/test/integration/targets/nxos_banner/tasks/main.yaml
new file mode 100644
index 0000000000..4b0f8c64d9
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tasks/main.yaml
@@ -0,0 +1,3 @@
+---
+- { include: cli.yaml, tags: ['cli'] }
+- { include: nxapi.yaml, tags: ['nxapi'] }
diff --git a/test/integration/targets/nxos_banner/tests/cli/basic-exec.yaml b/test/integration/targets/nxos_banner/tests/cli/basic-exec.yaml
new file mode 100644
index 0000000000..f1cebcda1e
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tests/cli/basic-exec.yaml
@@ -0,0 +1,45 @@
+---
+- name: setup - remove exec
+  nxos_banner:
+    banner: exec
+    state: absent
+    provider: "{{ cli }}"
+
+- name: Set exec
+  nxos_banner:
+    banner: exec
+    text: |
+      this is my exec banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ cli }}"
+  register: result
+
+- debug:
+    msg: "{{ result }}"
+
+- assert:
+    that:
+      - "result.changed == true"
+      - "'banner exec @\nthis is my exec banner\nthat has a multiline\nstring\n@' in result.commands"
+
+- name: Set exec again (idempotent)
+  nxos_banner:
+    banner: exec
+    text: |
+      this is my exec banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ cli }}"
+  register: result
+
+- assert:
+    that:
+      - "result.changed == false"
+      - "result.commands | length == 0"
+
+# FIXME add in tests for everything defined in docs
+# FIXME Test state:absent + test:
+# FIXME Without powers ensure "privileged mode required"
diff --git a/test/integration/targets/nxos_banner/tests/cli/basic-motd.yaml b/test/integration/targets/nxos_banner/tests/cli/basic-motd.yaml
new file mode 100644
index 0000000000..474e091f59
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tests/cli/basic-motd.yaml
@@ -0,0 +1,46 @@
+---
+- name: setup - remove motd
+  nxos_banner:
+    banner: motd
+    state: absent
+    provider: "{{ cli }}"
+
+- name: Set motd
+  nxos_banner:
+    banner: motd
+    text: |
+      this is my motd banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ cli }}"
+  register: result
+
+- debug:
+    msg: "{{ result }}"
+
+- assert:
+    that:
+      - "result.changed == true"
+      - "'banner motd @\nthis is my motd banner\nthat has a multiline\nstring\n@' in result.commands"
+
+- name: Set motd again (idempotent)
+  nxos_banner:
+    banner: motd
+    text: |
+      this is my motd banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ cli }}"
+  register: result
+
+- assert:
+    that:
+      - "result.changed == false"
+      - "result.commands | length == 0"
+
+
+# FIXME add in tests for everything defined in docs
+# FIXME Test state:absent + test:
+# FIXME Without powers ensure "privileged mode required"
diff --git a/test/integration/targets/nxos_banner/tests/cli/basic-no-exec.yaml b/test/integration/targets/nxos_banner/tests/cli/basic-no-exec.yaml
new file mode 100644
index 0000000000..0208bd68e2
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tests/cli/basic-no-exec.yaml
@@ -0,0 +1,41 @@
+---
+- name: Setup
+  nxos_banner:
+    banner: exec
+    text: |
+      Junk exec banner
+      over multiple lines
+    state: present
+    provider: "{{ cli }}"
+
+- name: remove exec
+  nxos_banner:
+    banner: exec
+    state: absent
+    provider: "{{ cli }}"
+  register: result
+
+- debug:
+    msg: "{{ result }}"
+
+- assert:
+    that:
+      - "result.changed == true"
+      - "'no banner exec' in result.commands"
+
+- name: remove exec (idempotent)
+  nxos_banner:
+    banner: exec
+    state: absent
+    provider: "{{ cli }}"
+  register: result
+
+- assert:
+    that:
+      - "result.changed == false"
+      - "result.commands | length == 0"
+
+
+# FIXME add in tests for everything defined in docs
+# FIXME Test state:absent + test:
+# FIXME Without powers ensure "privileged mode required"
diff --git a/test/integration/targets/nxos_banner/tests/nxapi/basic-exec.yaml b/test/integration/targets/nxos_banner/tests/nxapi/basic-exec.yaml
new file mode 100644
index 0000000000..0f232e86cd
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tests/nxapi/basic-exec.yaml
@@ -0,0 +1,45 @@
+---
+- name: setup - remove exec
+  nxos_banner:
+    banner: exec
+    state: absent
+    provider: "{{ nxapi }}"
+
+- name: Set exec
+  nxos_banner:
+    banner: exec
+    text: |
+      this is my exec banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ nxapi }}"
+  register: result
+
+- debug:
+    msg: "{{ result }}"
+
+- assert:
+    that:
+      - "result.changed == true"
+      - "'banner exec @\nthis is my exec banner\nthat has a multiline\nstring\n@' in result.commands"
+
+- name: Set exec again (idempotent)
+  nxos_banner:
+    banner: exec
+    text: |
+      this is my exec banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ nxapi }}"
+  register: result
+
+- assert:
+    that:
+      - "result.changed == false"
+      - "result.commands | length == 0"
+
+# FIXME add in tests for everything defined in docs
+# FIXME Test state:absent + test:
+# FIXME Without powers ensure "privileged mode required"
diff --git a/test/integration/targets/nxos_banner/tests/nxapi/basic-motd.yaml b/test/integration/targets/nxos_banner/tests/nxapi/basic-motd.yaml
new file mode 100644
index 0000000000..25fcf15994
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tests/nxapi/basic-motd.yaml
@@ -0,0 +1,46 @@
+---
+- name: setup - remove motd
+  nxos_banner:
+    banner: motd
+    state: absent
+    provider: "{{ nxapi }}"
+
+- name: Set motd
+  nxos_banner:
+    banner: motd
+    text: |
+      this is my motd banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ nxapi }}"
+  register: result
+
+- debug:
+    msg: "{{ result }}"
+
+- assert:
+    that:
+      - "result.changed == true"
+      - "'banner motd @\nthis is my motd banner\nthat has a multiline\nstring\n@' in result.commands"
+
+- name: Set motd again (idempotent)
+  nxos_banner:
+    banner: motd
+    text: |
+      this is my motd banner
+      that has a multiline
+      string
+    state: present
+    provider: "{{ nxapi }}"
+  register: result
+
+- assert:
+    that:
+      - "result.changed == false"
+      - "result.commands | length == 0"
+
+
+# FIXME add in tests for everything defined in docs
+# FIXME Test state:absent + test:
+# FIXME Without powers ensure "privileged mode required"
diff --git a/test/integration/targets/nxos_banner/tests/nxapi/basic-no-exec.yaml b/test/integration/targets/nxos_banner/tests/nxapi/basic-no-exec.yaml
new file mode 100644
index 0000000000..8386fb7233
--- /dev/null
+++ b/test/integration/targets/nxos_banner/tests/nxapi/basic-no-exec.yaml
@@ -0,0 +1,41 @@
+---
+- name: Setup
+  nxos_banner:
+    banner: exec
+    text: |
+      Junk exec banner
+      over multiple lines
+    state: present
+    provider: "{{ nxapi }}"
+
+- name: remove exec
+  nxos_banner:
+    banner: exec
+    state: absent
+    provider: "{{ nxapi }}"
+  register: result
+
+- debug:
+    msg: "{{ result }}"
+
+- assert:
+    that:
+      - "result.changed == true"
+      - "'no banner exec' in result.commands"
+
+- name: remove exec (idempotent)
+  nxos_banner:
+    banner: exec
+    state: absent
+    provider: "{{ nxapi }}"
+  register: result
+
+- assert:
+    that:
+      - "result.changed == false"
+      - "result.commands | length == 0"
+
+
+# FIXME add in tests for everything defined in docs
+# FIXME Test state:absent + test:
+# FIXME Without powers ensure "privileged mode required"
diff --git a/test/units/modules/network/nxos/test_nxos_banner.py b/test/units/modules/network/nxos/test_nxos_banner.py
new file mode 100644
index 0000000000..3bd3ea7f81
--- /dev/null
+++ b/test/units/modules/network/nxos/test_nxos_banner.py
@@ -0,0 +1,53 @@
+# This file is part of Ansible
+#
+# Ansible is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or
+# (at your option) any later version.
+#
+# Ansible is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
+
+# Make coding more python3-ish
+from __future__ import (absolute_import, division, print_function)
+__metaclass__ = type
+
+import json
+
+from ansible.compat.tests.mock import patch
+from ansible.modules.network.nxos import nxos_banner
+from .nxos_module import TestNxosModule, load_fixture, set_module_args
+
+
+class TestNxosBannerModule(TestNxosModule):
+
+    module = nxos_banner
+
+    def setUp(self):
+        self.mock_run_commands = patch('ansible.modules.network.nxos.nxos_banner.run_commands')
+        self.run_commands = self.mock_run_commands.start()
+
+        self.mock_load_config = patch('ansible.modules.network.nxos.nxos_banner.load_config')
+        self.load_config = self.mock_load_config.start()
+
+    def tearDown(self):
+        self.mock_run_commands.stop()
+        self.mock_load_config.stop()
+
+    def load_fixtures(self, commands=None):
+        self.load_config.return_value = dict(diff=None, session='session')
+
+    def test_nxos_banner_create(self):
+        set_module_args(dict(banner='exec', text='test\nbanner\nstring'))
+        commands = ['banner exec @\ntest\nbanner\nstring\n@']
+        self.execute_module(changed=True, commands=commands)
+
+    def test_nxos_banner_remove(self):
+        set_module_args(dict(banner='exec', state='absent'))
+        commands = ['no banner exec']
+        self.execute_module(changed=True, commands=commands)
