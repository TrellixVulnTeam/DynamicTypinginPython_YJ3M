commit 4b0480dd9d3836b0cd5efe8c860ed2886eccd294
Author: Daniel NÃ©ri <dne@mayonnaise.net>
Date:   Sun May 13 20:36:08 2012 +0200

    Set 'hostvars' before performing variable replacements

diff --git a/lib/ansible/utils.py b/lib/ansible/utils.py
index 29b164de91..aacc9d5d6d 100644
--- a/lib/ansible/utils.py
+++ b/lib/ansible/utils.py
@@ -257,8 +257,8 @@ def varReplace(raw, vars):
 def template(text, vars, setup_cache, no_engine=True):
     ''' run a text buffer through the templating engine '''
     vars = vars.copy()
-    text = varReplace(unicode(text), vars)
     vars['hostvars'] = setup_cache
+    text = varReplace(unicode(text), vars)
     if no_engine:
         # used when processing include: directives so that Jinja is evaluated
         # in a later context when more variables are available
