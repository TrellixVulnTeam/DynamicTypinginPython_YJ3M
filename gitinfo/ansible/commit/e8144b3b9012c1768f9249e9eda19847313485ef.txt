commit e8144b3b9012c1768f9249e9eda19847313485ef
Author: Akos Vandra <avandra@whitepages.com>
Date:   Sun Jan 25 14:51:01 2015 +0100

    fixes #10086

diff --git a/lib/ansible/runner/shell_plugins/sh.py b/lib/ansible/runner/shell_plugins/sh.py
index c43a8e725c..816b4c301c 100644
--- a/lib/ansible/runner/shell_plugins/sh.py
+++ b/lib/ansible/runner/shell_plugins/sh.py
@@ -98,7 +98,7 @@ class ShellModule(object):
 
         test = "rc=flag; [ -r \'%(p)s\' ] || rc=2; [ -f \'%(p)s\' ] || rc=1; [ -d \'%(p)s\' ] && rc=3; %(i)s -V 2>/dev/null || rc=4; [ x\"$rc\" != \"xflag\" ] && echo \"${rc}\"\'  %(p)s\' && exit 0" % dict(p=path, i=python_interp)
         csums = [
-            "(%s -c 'import hashlib; print(hashlib.sha1(open(\"%s\", \"rb\").read()).hexdigest())' 2>/dev/null)" % (python_interp, path),      # Python > 2.4 (including python3)
+            "(%s -c 'import hashlib; BLOCKSIZE = 65536; hasher = hashlib.sha1();\nwith open(\"%s\", \"rb\") as afile:\n\tbuf = afile.read(BLOCKSIZE)\n\twhile len(buf) > 0:\n\t\thasher.update(buf)\n\t\tbuf = afile.read(BLOCKSIZE)\n\n\nprint(hasher.hexdigest())' 2>/dev/null)" % (python_interp, path),      # Python > 2.4 (including python3)
             "(%s -c 'import sha; print(sha.sha(open(\"%s\", \"rb\").read()).hexdigest())' 2>/dev/null)" % (python_interp, path),        # Python == 2.4
         ]
 
diff --git a/v2/ansible/plugins/shell/sh.py b/v2/ansible/plugins/shell/sh.py
index c43a8e725c..816b4c301c 100644
--- a/v2/ansible/plugins/shell/sh.py
+++ b/v2/ansible/plugins/shell/sh.py
@@ -98,7 +98,7 @@ class ShellModule(object):
 
         test = "rc=flag; [ -r \'%(p)s\' ] || rc=2; [ -f \'%(p)s\' ] || rc=1; [ -d \'%(p)s\' ] && rc=3; %(i)s -V 2>/dev/null || rc=4; [ x\"$rc\" != \"xflag\" ] && echo \"${rc}\"\'  %(p)s\' && exit 0" % dict(p=path, i=python_interp)
         csums = [
-            "(%s -c 'import hashlib; print(hashlib.sha1(open(\"%s\", \"rb\").read()).hexdigest())' 2>/dev/null)" % (python_interp, path),      # Python > 2.4 (including python3)
+            "(%s -c 'import hashlib; BLOCKSIZE = 65536; hasher = hashlib.sha1();\nwith open(\"%s\", \"rb\") as afile:\n\tbuf = afile.read(BLOCKSIZE)\n\twhile len(buf) > 0:\n\t\thasher.update(buf)\n\t\tbuf = afile.read(BLOCKSIZE)\n\n\nprint(hasher.hexdigest())' 2>/dev/null)" % (python_interp, path),      # Python > 2.4 (including python3)
             "(%s -c 'import sha; print(sha.sha(open(\"%s\", \"rb\").read()).hexdigest())' 2>/dev/null)" % (python_interp, path),        # Python == 2.4
         ]
 
