commit 3fadf4a1cbfe64ad1827248c0e9b73a2b38093cf
Author: dw <dw@botanicus.net>
Date:   Tue Jun 4 17:45:20 2019 +0100

    Fix file descriptor leak in lineinfile module. (#57328)

diff --git a/changelogs/fragments/57327-fix-file-descriptor-leak.yaml b/changelogs/fragments/57327-fix-file-descriptor-leak.yaml
new file mode 100644
index 0000000000..cee6d4f066
--- /dev/null
+++ b/changelogs/fragments/57327-fix-file-descriptor-leak.yaml
@@ -0,0 +1,2 @@
+bugfixes:
+- lineinfile - fix a race / file descriptor leak when writing the file (https://github.com/ansible/ansible/issues/57327)
diff --git a/lib/ansible/modules/files/lineinfile.py b/lib/ansible/modules/files/lineinfile.py
index 698bd4872f..86bc44e4f2 100644
--- a/lib/ansible/modules/files/lineinfile.py
+++ b/lib/ansible/modules/files/lineinfile.py
@@ -215,7 +215,7 @@ from ansible.module_utils._text import to_bytes, to_native
 def write_changes(module, b_lines, dest):
 
     tmpfd, tmpfile = tempfile.mkstemp()
-    with open(tmpfile, 'wb') as f:
+    with os.fdopen(tmpfd, 'wb') as f:
         f.writelines(b_lines)
 
     validate = module.params.get('validate', None)
