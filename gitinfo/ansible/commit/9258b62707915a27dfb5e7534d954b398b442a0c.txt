commit 9258b62707915a27dfb5e7534d954b398b442a0c
Author: Dave Kasberg <dkasberg@lenovo.com>
Date:   Thu Mar 2 08:11:19 2017 -0800

    New module: cnos_conditional_template (#21794)
    
    * Initial commit of cnos_conditional_template
    
    * fix compile error in module, change module short description, move roles to integration/roles
    
    * fix line length
    
    * Change module directory name to Lenovo
    
    * change import cnos statement

diff --git a/lib/ansible/modules/network/lenovo/cnos_conditional_template.py b/lib/ansible/modules/network/lenovo/cnos_conditional_template.py
new file mode 100644
index 0000000000..8956f191ec
--- /dev/null
+++ b/lib/ansible/modules/network/lenovo/cnos_conditional_template.py
@@ -0,0 +1,210 @@
+#!/usr/bin/python
+# -*- coding: utf-8 -*-
+#
+# Copyright (C) 2017 Lenovo, Inc.
+#
+# This file is part of Ansible
+#
+# Ansible is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or
+# (at your option) any later version.
+#
+# Ansible is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
+#
+# Module to send conditional template to Lenovo Switches
+# Lenovo Networking
+#
+
+ANSIBLE_METADATA = {'status': ['preview'],
+                    'supported_by': 'community',
+                    'version': '1.0'}
+
+DOCUMENTATION = '''
+---
+module: cnos_conditional_template
+short_description: Manage switch configuration using templates based on condition on devices running Lenovo CNOS
+description:
+    - This module allows you to work with the running configuration of a switch. It provides a way to
+     execute a set of CNOS commands on a switch by evaluating the current running configuration and
+     executing the commands only if the specific settings have not been already configured.
+     The configuration source can be a set of commands or a template written in the Jinja2 templating language.
+     This module functions the same as the cnos_template module.
+     The only exception is that the following inventory variable can be specified
+     [“condition = <flag string>”]
+     When this inventory variable is specified as the variable of a task, the template is executed for
+     the network element that matches the flag string. Usually, templates are used when commands are the
+     same across a group of network devices. When there is a requirement to skip the execution of the
+     template on one or more devices, it is recommended to use this module.
+     This module uses SSH to manage network device configuration.
+     For more information about this module from Lenovo and customizing it usage for your
+     use cases, please visit our [User Guide]
+     (http://systemx.lenovofiles.com/help/index.jsp?topic=%2Fcom.lenovo.switchmgt.ansible.doc%2Fcnos_conditional_template.html)
+version_added: "2.3"
+extends_documentation_fragment: cnos
+options:
+    commandfile:
+        description:
+            - This specifies the path to the CNOS command file which needs to be applied. This usually
+             comes from the commands folder. Generally this file is the output of the variables applied
+             on a template file. So this command is preceded by a template module.
+             The command file must contain the Ansible keyword {{ inventory_hostname }} and the condition
+             flag in its filename to ensure that the command file is unique for each switch and condition.
+             If this is omitted, the command file will be overwritten during iteration. For example,
+             commandfile=./commands/clos_leaf_bgp_{{ inventory_hostname }}_LP21_commands.txt
+        required: true
+        default: Null
+    condition:
+        description:
+            - If you specify condition=<flag string> in the inventory file against any device, the template
+             execution is done for that device in case it matches the flag setting for that task.
+        required: true
+        default: Null
+    flag:
+        description:
+            - If a task needs to be executed, you have to set the flag the same as it is specified in
+             the inventory for that device.
+        required: true
+        default: Null
+'''
+EXAMPLES = '''
+Tasks : The following are examples of using the module cnos_conditional_template. These are written in the main.yml file of the tasks directory.
+---
+- name: Applying CLI template on VLAG Tier1 Leaf Switch1
+  cnos_conditional_template:
+      host: "{{ inventory_hostname }}"
+      username: "{{ hostvars[inventory_hostname]['username'] }}"
+      password: "{{ hostvars[inventory_hostname]['password'] }}"
+      deviceType: "{{ hostvars[inventory_hostname]['deviceType'] }}"
+      outputfile: "./results/vlag_1tier_leaf_switch1_{{ inventory_hostname }}_output.txt"
+      condition: "{{ hostvars[inventory_hostname]['condition']}}"
+      flag: "leaf_switch1"
+      commandfile: "./commands/vlag_1tier_leaf_switch1_{{ inventory_hostname }}_commands.txt"
+      enablePassword: "anil"
+      stp_mode1: "disable"
+      port_range1: "17,18,29,30"
+      portchannel_interface_number1: 1001
+      portchannel_mode1: active
+      slot_chassis_number1: 1/48
+      switchport_mode1: trunk
+'''
+RETURN = '''
+  return value: |
+    On successful execution, the method returns a message in JSON format
+    [Template Applied.]
+    Upon any failure, the method returns an error display string.
+
+'''
+
+import sys
+import paramiko
+import time
+import argparse
+import socket
+import array
+import json
+import time
+import re
+try:
+    from ansible.module_utils import cnos
+    HAS_LIB = True
+except:
+    HAS_LIB = False
+from ansible.module_utils.basic import AnsibleModule
+from collections import defaultdict
+
+
+def main():
+    module = AnsibleModule(
+        argument_spec=dict(
+            commandfile=dict(required=True),
+            outputfile=dict(required=True),
+            condition=dict(required=True),
+            flag=dict(required=True),
+            host=dict(required=True),
+            deviceType=dict(required=True),
+            username=dict(required=True),
+            password=dict(required=True, no_log=True),
+            enablePassword=dict(required=False, no_log=True),),
+        supports_check_mode=False)
+
+    username = module.params['username']
+    password = module.params['password']
+    enablePassword = module.params['enablePassword']
+    condition = module.params['condition']
+    flag = module.params['flag']
+    commandfile = module.params['commandfile']
+    deviceType = module.params['deviceType']
+    outputfile = module.params['outputfile']
+    hostIP = module.params['host']
+
+    output = ""
+
+    # Here comes the logic against which a template is
+    # conditionally executed for right Network element.
+    if (condition != flag):
+        module.exit_json(changed=True, msg="Template Skipped for this value")
+        return " "
+
+    # Create instance of SSHClient object
+    remote_conn_pre = paramiko.SSHClient()
+
+    # Automatically add untrusted hosts (make sure okay for security policy in your environment)
+    remote_conn_pre.set_missing_host_key_policy(paramiko.AutoAddPolicy())
+
+    # initiate SSH connection with the switch
+    remote_conn_pre.connect(hostIP, username=username, password=password)
+    time.sleep(2)
+
+    # Use invoke_shell to establish an 'interactive session'
+    remote_conn = remote_conn_pre.invoke_shell()
+    time.sleep(2)
+    # Enable and enter configure terminal then send command
+    output = output + cnos.waitForDeviceResponse("\n", ">", 2, remote_conn)
+
+    output = output + cnos.enterEnableModeForDevice(enablePassword, 3, remote_conn)
+
+    # Make terminal length = 0
+    output = output + cnos.waitForDeviceResponse("terminal length 0\n", "#", 2, remote_conn)
+
+    # Go to config mode
+    output = output + cnos.waitForDeviceResponse("configure d\n", "(config)#", 2, remote_conn)
+    # Send commands one by one
+    #with open(commandfile, "r") as f:
+    f = open(commandfile, "r")
+    for line in f:
+        # Omit the comment lines in template file
+        if not line.startswith("#"):
+            # cnos.debugOutput(line)
+            command = line
+            if not line.endswith("\n"):
+                command = command+"\n"
+            response = cnos.waitForDeviceResponse(command, "#", 2, remote_conn)
+            errorMsg = cnos.checkOutputForError(response)
+            output = output + response
+            if(errorMsg is not None):
+                break
+            # To cater to Mufti case
+    # Write to memory
+    output = output + cnos.waitForDeviceResponse("save\n", "#", 3, remote_conn)
+
+    # Write output to file
+    file = open(outputfile, "a")
+    file.write(output)
+    file.close()
+
+    # Logic to check when changes occur or not
+    errorMsg = cnos.checkOutputForError(output)
+    if(errorMsg is None):
+        module.exit_json(changed=True, msg="Template Applied")
+    else:
+        module.fail_json(msg=errorMsg)
+
+if __name__ == '__main__':
+    main()
diff --git a/test/integration/roles/cnos_conditional_template/README.md b/test/integration/roles/cnos_conditional_template/README.md
new file mode 100644
index 0000000000..0f0c8a71c7
--- /dev/null
+++ b/test/integration/roles/cnos_conditional_template/README.md
@@ -0,0 +1,118 @@
+# Ansible Role: cnos_conditional_template_sample - Manages switch configuration using templates with respect to conditions specified in the inventory
+---
+<add role description below>
+
+This role is an example of using the *cnos_conditional_template.py* Lenovo module in the context of CNOS switch configuration. This module allows you to work with the running configuration of a switch. It provides a way to execute a set of CNOS commands on a switch by evaluating the current running configuration and executing the commands only if the specific settings have not been already configured.
+
+The configuration source can be a set of commands or a template written in the Jinja2 templating language.
+
+This module functions the same as the *cnos_template.py* module. The only exception is that the following inventory variable can be specified: condition = <flag string>
+
+When this inventory variable is specified as the variable of a task, the template is executed for the network element that matches the flag string.
+
+Usually, templates are used when commands are the same across a group of network devices. When there is a requirement to skip the execution of the template on one or more devices, it is recommended to use this module.
+
+The results of the operation can be viewed in *results* directory.
+
+For more details, see [Lenovo modules for Ansible: cnos_conditional_template](http://systemx.lenovofiles.com/help/index.jsp?topic=%2Fcom.lenovo.switchmgt.ansible.doc%2Fcnos_conditional_template.html&cp=0_3_1_0_4_11).
+
+
+## Requirements
+---
+<add role requirements information below>
+
+- Ansible version 2.2 or later ([Ansible installation documentation](http://docs.ansible.com/ansible/intro_installation.html))
+- Lenovo switches running CNOS version 10.2.1.0 or later
+- an SSH connection to the Lenovo switch (SSH must be enabled on the network device)
+
+
+## Role Variables
+---
+<add role variables information below>
+
+Available variables are listed below, along with description.
+
+The following are mandatory inventory variables:
+
+Variable | Description
+--- | ---
+`username` | Specifies the username used to log into the switch
+`password` | Specifies the password used to log into the switch
+`enablePassword` | Configures the password used to enter Global Configuration command mode on the switch (this is an optional parameter)
+`hostname` | Searches the hosts file at */etc/ansible/hosts* and identifies the IP address of the switch on which the role is going to be applied
+`deviceType` | Specifies the type of device from where the configuration will be backed up (**g8272_cnos** - G8272, **g8296_cnos** - G8296)
+`condition` | If `condition=<flag string>` is specified in the inventory file against any device, the template execution is done for that device in case it matches the flag setting for that task
+
+The values of the variables used need to be modified to fit the specific scenario in which you are deploying the solution. To change the values of the variables, you need to visits the *vars* directory of each role and edit the *main.yml* file located there. The values stored in this file will be used by Ansible when the template is executed.
+
+The syntax of *main.yml* file for variables is the following:
+
+```
+<template variable>:<value>
+```
+
+You will need to replace the `<value>` field with the value that suits your topology. The `<template variable>` fields are taken from the template and it is recommended that you leave them unchanged.
+
+Variable | Description
+--- | ---
+`flag` | If a task needs to be executed, you have to set the flag the same as it is specified in the inventory for that device
+`commandfile` | Specifies the path to the CNOS command file which needs to be applied
+
+
+## Dependencies
+---
+<add dependencies information below>
+
+- username.iptables - Configures the firewall and blocks all ports except those needed for web server and SSH access.
+- username.common - Performs common server configuration.
+- cnos_conditional_template.py - This modules needs to be present in the *library* directory of the role.
+- cnos.py - This module needs to be present in the PYTHONPATH environment variable set in the Ansible system.
+- /etc/ansible/hosts - You must edit the */etc/ansible/hosts* file with the device information of the switches designated as leaf switches. You may refer to *cnos_conditional_template_sample_hosts* for a sample configuration.
+
+Ansible keeps track of all network elements that it manages through a hosts file. Before the execution of a playbook, the hosts file must be set up.
+
+Open the */etc/ansible/hosts* file with root privileges. Most of the file is commented out by using **#**. You can also comment out the entries you will be adding by using **#**. You need to copy the content of the hosts file for the role into the */etc/ansible/hosts* file. The sample hosts file for the role is located in the main directory.
+
+```
+[cnos_conditional_template_sample]
+10.241.107.39   username=<username> password=<password> deviceType=g8272_cnos condition=pass
+10.241.107.40   username=<username> password=<password> deviceType=g8272_cnos 
+```
+    
+**Note:** You need to change the IP addresses to fit your specific topology. You also need to change the `<username>` and `<password>` to the appropriate values used to log into the specific Lenovo network devices.
+
+
+## Example Playbook
+---
+<add playbook samples below>
+
+To execute an Ansible playbook, use the following command:
+
+```
+ansible-playbook cnos_conditional_template_sample.yml -vvv
+```
+
+`-vvv` is an optional verbos command that helps identify what is happening during playbook execution. The playbook for each role is located in the main directory of the solution.
+
+```
+ - name: Module to  do some template configurations
+   hosts: cnos_conditional_template_sample
+   gather_facts: no
+   connection: local
+   roles:
+    - cnos_conditional_template_sample
+```
+
+
+## License
+---
+<add license information below>
+Copyright (C) 2017 Lenovo, Inc.
+
+This file is part of Ansible
+
+Ansible is free software: you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
+
+Ansible is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
\ No newline at end of file
diff --git a/test/integration/roles/cnos_conditional_template/cnos_conditional_template_sample_hosts b/test/integration/roles/cnos_conditional_template/cnos_conditional_template_sample_hosts
new file mode 100644
index 0000000000..0c2d0da0b4
--- /dev/null
+++ b/test/integration/roles/cnos_conditional_template/cnos_conditional_template_sample_hosts
@@ -0,0 +1,15 @@
+# You have to paste this dummy information  in /etc/ansible/hosts
+#    Notes:
+#    - Comments begin with the '#' character
+#    - Blank lines are ignored
+#    - Groups of hosts are delimited by [header] elements
+#    - You can enter hostnames or ip addresses
+#    - A hostname/ip can be a member of multiple groups
+#
+# In the /etc/ansible/hosts file u have to enter [cnos_conditional_template_sample] tag
+# Following you should specify IP Adresses details 
+# Please change <username> and <password> with appropriate value for your switch.
+
+[cnos_conditional_template_sample]
+10.241.107.39   username=<username> password=<password> deviceType=g8272_cnos condition=pass
+
diff --git a/test/integration/roles/cnos_conditional_template/tasks/main.yml b/test/integration/roles/cnos_conditional_template/tasks/main.yml
new file mode 100644
index 0000000000..d414469a7d
--- /dev/null
+++ b/test/integration/roles/cnos_conditional_template/tasks/main.yml
@@ -0,0 +1,11 @@
+# This contain sample conditional template execution tasks
+---
+- name: Replace Config CLI command template with values
+  template: src=demo_template.j2 dest=./commands/cnos_conditional_template_{{ inventory_hostname }}_command.txt
+  with_items: "{{conditional_template_data1}}"
+
+- name: Applying CLI commands on Switches
+  cnos_conditional_template: host={{ inventory_hostname }} username={{ hostvars[inventory_hostname]['username']}}  password={{ hostvars[inventory_hostname]['password']}} deviceType={{ hostvars[inventory_hostname]['deviceType']}} 
+   condition={{ hostvars[inventory_hostname]['condition'] }} flag='{{item.flag}}' commandfile=./commands/cnos_conditional_template_{{ inventory_hostname }}_command.txt outputfile=./results/cnos_conditional_template_{{ inventory_hostname }}_output.txt
+  with_items: "{{conditional_template_data1}}"
+# Completed file
diff --git a/test/integration/roles/cnos_conditional_template/templates/demo_template.j2 b/test/integration/roles/cnos_conditional_template/templates/demo_template.j2
new file mode 100644
index 0000000000..1b683084f5
--- /dev/null
+++ b/test/integration/roles/cnos_conditional_template/templates/demo_template.j2
@@ -0,0 +1,14 @@
+#Demo Template
+vlan {{item.vlanid1}}
+exit
+config d
+interface ethernet {{item.slot_chassis_number1}}
+aggregation-group {{item.portchannel_interface_number1}} mode {{item.portchannel_mode1}}
+exit
+config d
+interface port-aggregation {{item.portchannel_interface_number1}}
+shut
+lacp suspend-individual
+no shut
+exit
+
diff --git a/test/integration/roles/cnos_conditional_template/vars/main.yml b/test/integration/roles/cnos_conditional_template/vars/main.yml
new file mode 100644
index 0000000000..b2795dc79a
--- /dev/null
+++ b/test/integration/roles/cnos_conditional_template/vars/main.yml
@@ -0,0 +1,3 @@
+---
+conditional_template_data1:
+  - {flag: "pass", vlanid1: 13, slot_chassis_number1: "1/2", portchannel_interface_number1: 100, portchannel_mode1: "active"}
