commit f720499337bb3913ab332a305eaa7f9e74bc2133
Author: Jordan Borean <jborean93@gmail.com>
Date:   Wed Oct 17 10:43:30 2018 +1000

    gem: fix tests to work on newer Fedora hosts (#47158)

diff --git a/test/integration/targets/gem/tasks/main.yml b/test/integration/targets/gem/tasks/main.yml
index 924daa8930..555701ff2f 100644
--- a/test/integration/targets/gem/tasks/main.yml
+++ b/test/integration/targets/gem/tasks/main.yml
@@ -37,33 +37,80 @@
     name: gist
     state: present
   register: install_gem_result
+  ignore_errors: yes
 
-- name: List gems
-  command: gem list
-  register: current_gems
-
-- name: Ensure gem was installed
-  assert:
-    that:
-      - install_gem_result is changed
-      - current_gems.stdout is search('gist\s+\([0-9.]+\)')
-
-- name: Remove a gem
-  gem:
-    name: gist
-    state: absent
-  register: remove_gem_results
-
-- name: List gems
-  command: gem list
-  register: current_gems
-
-- name: Verify gem is not installed
-  assert:
-    that:
-      - remove_gem_results is changed
-      - current_gems.stdout is not search('gist\s+\([0-9.]+\)')
-
+# when running as root on Fedora, '--install-dir' is set in the os defaults which is
+# incompatible with '--user-install', we ignore this error for this case only
+- name: fail if failed to install gem
+  fail:
+    msg: "failed to install gem: {{ install_gem_result.msg }}"
+  when:
+  - install_gem_result is failed
+  - not (ansible_user_uid == 0 and "User --install-dir or --user-install but not both" not in install_gem_result.msg)
+
+- block:
+  - name: List gems
+    command: gem list
+    register: current_gems
+
+  - name: Ensure gem was installed
+    assert:
+      that:
+        - install_gem_result is changed
+        - current_gems.stdout is search('gist\s+\([0-9.]+\)')
+
+  - name: Remove a gem
+    gem:
+      name: gist
+      state: absent
+    register: remove_gem_results
+
+  - name: List gems
+    command: gem list
+    register: current_gems
+
+  - name: Verify gem is not installed
+    assert:
+      that:
+        - remove_gem_results is changed
+        - current_gems.stdout is not search('gist\s+\([0-9.]+\)')
+  when: not install_gem_result is failed
+
+# install gem in --no-user-install
+- block:
+  - name: Install a gem with --no-user-install
+    gem:
+      name: gist
+      state: present
+      user_install: no
+    register: install_gem_result
+
+  - name: List gems
+    command: gem list
+    register: current_gems
+
+  - name: Ensure gem was installed
+    assert:
+      that:
+        - install_gem_result is changed
+        - current_gems.stdout is search('gist\s+\([0-9.]+\)')
+
+  - name: Remove a gem
+    gem:
+      name: gist
+      state: absent
+    register: remove_gem_results
+
+  - name: List gems
+    command: gem list
+    register: current_gems
+
+  - name: Verify gem is not installed
+    assert:
+      that:
+        - remove_gem_results is changed
+        - current_gems.stdout is not search('gist\s+\([0-9.]+\)')
+  when: ansible_user_uid == 0
 
 # Check cutom gem directory
 - name: Install gem in a custom directory with incorrect options
