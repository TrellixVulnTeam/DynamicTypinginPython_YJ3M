commit ea72fd65474d52936523c9cb3c12c3827f8438f1
Author: = <jhawkesworth@users.noreply.github.com>
Date:   Wed Dec 9 08:57:06 2015 +0000

    adding integration tests for win_regmerge module (extras)

diff --git a/test/integration/roles/test_win_regmerge/files/settings1.reg b/test/integration/roles/test_win_regmerge/files/settings1.reg
new file mode 100644
index 0000000000..baec75b2af
Binary files /dev/null and b/test/integration/roles/test_win_regmerge/files/settings1.reg differ
diff --git a/test/integration/roles/test_win_regmerge/files/settings2.reg b/test/integration/roles/test_win_regmerge/files/settings2.reg
new file mode 100644
index 0000000000..fc2612cb8a
Binary files /dev/null and b/test/integration/roles/test_win_regmerge/files/settings2.reg differ
diff --git a/test/integration/roles/test_win_regmerge/files/settings3.reg b/test/integration/roles/test_win_regmerge/files/settings3.reg
new file mode 100644
index 0000000000..fbe7411c95
Binary files /dev/null and b/test/integration/roles/test_win_regmerge/files/settings3.reg differ
diff --git a/test/integration/roles/test_win_regmerge/meta/main.yml b/test/integration/roles/test_win_regmerge/meta/main.yml
new file mode 100644
index 0000000000..55200b3fc6
--- /dev/null
+++ b/test/integration/roles/test_win_regmerge/meta/main.yml
@@ -0,0 +1,3 @@
+dependencies: 
+  - prepare_win_tests
+
diff --git a/test/integration/roles/test_win_regmerge/tasks/main.yml b/test/integration/roles/test_win_regmerge/tasks/main.yml
new file mode 100644
index 0000000000..6e64c9dd4a
--- /dev/null
+++ b/test/integration/roles/test_win_regmerge/tasks/main.yml
@@ -0,0 +1,133 @@
+# test code for the win_regmerge module
+# (c) 2014, Michael DeHaan <michael.dehaan@gmail.com>
+
+# This file is part of Ansible
+#
+# Ansible is free software: you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or
+# (at your option) any later version.
+#
+# Ansible is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
+
+# clear the area of the registry we are using for tests
+- name: remove setting
+  win_regedit:
+    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
+    state: absent
+
+# copy over some registry files to work with
+- name: copy over some registry files to work with
+  win_copy: src={{item}} dest={{win_output_dir}}\\{{item}}
+  with_items:
+     - settings1.reg
+     - settings2.reg
+     - settings3.reg
+
+# test 1 -  basic test of changed behaviour
+# merge in REG_SZ 
+- name: test 1 merge in a setting
+  win_regmerge:
+     path: "{{win_output_dir}}\\settings1.reg"
+  register: merge11_result
+
+- assert:
+    that:
+      - "merge11_result.changed == true"
+
+# re run the merge
+- name: test 1 merge in the setting again
+  win_regmerge:
+     path: "{{win_output_dir}}\\settings1.reg"
+  register: merge12_result
+
+# without a compare to key, should allways report changed
+- assert:
+    that:
+      - "merge12_result.changed == true"
+# assert changed false
+
+# prune reg key
+- name: test 1 remove setting
+  win_regedit:
+     key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
+     state: absent
+
+#
+# test 2, observe behaviour when compare_to param is set
+#
+- name: test 2 merge in a setting
+  win_regmerge:
+    path: "{{win_output_dir}}\\settings1.reg"
+    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
+  register: merge21_result
+
+- assert:
+    that:
+      - "merge21_result.changed == true"
+
+# re run the merge
+- name: test 2 merge in the setting again but with compare_key
+  win_regmerge:
+    path: "{{win_output_dir}}\\settings1.reg"
+    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moosic\ILikeToMooveIt'
+  register: merge22_result
+
+# with a compare to key, should now report not changed
+- assert:
+    that:
+      - "merge22_result.changed == false"
+# assert changed false
+
+# prune the contents of the registry from the parent of the compare key downwards
+- name: test 2 clean up remove setting
+  win_regedit:
+    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
+    state: absent
+
+# test 3 merge in more complex settings
+- name: test 3 merge in a setting
+  win_regmerge:
+    path: "{{win_output_dir}}\\settings3.reg"
+    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
+  register: merge31_result
+
+- assert:
+    that:
+      - "merge31_result.changed == true"
+
+# re run the merge
+- name: test 3 merge in the setting again but with compare_key check
+  win_regmerge:
+    path: "{{win_output_dir}}\\settings3.reg"
+    compare_to: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp\Moo Monitor'
+  register: merge32_result
+
+# with a compare to key, should now report not changed
+- assert:
+    that:
+      - "merge32_result.changed == false"
+# assert changed false
+
+# prune the contents of the registry from the compare key downwards
+- name: test 3 clean up remove setting
+  win_regedit:
+    key: 'HKLM:\SOFTWARE\Wow6432Node\Cow Corp'
+    state: absent
+
+# clean up registry files
+
+- name: clean up registry files
+  win_file: path={{win_output_dir}}\\{{item}} state=absent
+  with_items:
+     - settings1.reg
+     - settings2.reg
+     - settings3.reg
+
+# END OF win_regmerge tests
diff --git a/test/integration/roles/test_win_regmerge/templates/win_line_ending.j2 b/test/integration/roles/test_win_regmerge/templates/win_line_ending.j2
new file mode 100644
index 0000000000..d0cefd76f4
--- /dev/null
+++ b/test/integration/roles/test_win_regmerge/templates/win_line_ending.j2
@@ -0,0 +1,4 @@
+#jinja2: newline_sequence:'\r\n'
+{{ templated_var }}
+{{ templated_var }}
+{{ templated_var }}
diff --git a/test/integration/roles/test_win_regmerge/vars/main.yml b/test/integration/roles/test_win_regmerge/vars/main.yml
new file mode 100644
index 0000000000..1e8f64ccf4
--- /dev/null
+++ b/test/integration/roles/test_win_regmerge/vars/main.yml
@@ -0,0 +1 @@
+templated_var: templated_var_loaded
diff --git a/test/integration/test_winrm.yml b/test/integration/test_winrm.yml
index f11171faf8..51a5daa51f 100644
--- a/test/integration/test_winrm.yml
+++ b/test/integration/test_winrm.yml
@@ -37,4 +37,5 @@
     - { role: test_win_copy, tags: test_win_copy }
     - { role: test_win_template, tags: test_win_template }
     - { role: test_win_lineinfile, tags: test_win_lineinfile }
+    - { role: test_win_regmerge, tags: test_win_regmerge }
 
