commit 345e39e1b1188e966a4d37f2c14b1f2dc3746937
Author: Rene Moser <mail@renemoser.net>
Date:   Fri Dec 9 07:03:18 2016 +0100

    cloudstack: cs_instance: fix userdata not up to date (#18942)
    
    Fixes unnecessary VM restart.
    
    VM userdata is currently not returned by the API listVirtualMachine and task will always be marked as changed in has_changed(), which will result in an unnecessary VM restart if force=true.
    
    Reported by @Mayeu

diff --git a/lib/ansible/modules/cloud/cloudstack/cs_instance.py b/lib/ansible/modules/cloud/cloudstack/cs_instance.py
index 58c9872485..2ac53e1ecd 100644
--- a/lib/ansible/modules/cloud/cloudstack/cs_instance.py
+++ b/lib/ansible/modules/cloud/cloudstack/cs_instance.py
@@ -533,6 +533,10 @@ class AnsibleCloudStackInstance(AnsibleCloudStack):
                     if not vpc_id and self.is_vm_in_vpc(vm=v):
                         continue
                     if instance_name.lower() in [ v['name'].lower(), v['displayname'].lower(), v['id'] ]:
+                        # Query the user data if we need to
+                        if 'userdata' not in v and self.get_user_data() is not None:
+                            res = self.cs.getVirtualMachineUserData(virtualmachineid=v['id'])
+                            v['userdata'] = res['virtualmachineuserdata'].get('userdata',"")
                         self.instance = v
                         break
         return self.instance
