commit a58fcde3a0d7a93c363ae7af4e6ee03001b96d82
Author: Jordan Borean <jborean93@gmail.com>
Date:   Thu Jun 11 06:38:17 2020 +1000

    Use common ps sanity requirements file (#69992)
    
    * Use common pssanity requirements file
    
    * Fix up sanity ignore

diff --git a/test/lib/ansible_test/_data/requirements/sanity.ps1 b/test/lib/ansible_test/_data/requirements/sanity.ps1
index 53d14a3418..1875c306ba 100755
--- a/test/lib/ansible_test/_data/requirements/sanity.ps1
+++ b/test/lib/ansible_test/_data/requirements/sanity.ps1
@@ -1,11 +1,26 @@
 #!/usr/bin/env pwsh
+param (
+    [Switch]
+    $IsContainer
+)
+
 #Requires -Version 6
 
 Set-StrictMode -Version 2.0
 $ErrorActionPreference = "Stop"
+$ProgressPreference = 'SilentlyContinue'
 
 Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
 Install-Module -Name PSScriptAnalyzer -RequiredVersion 1.18.0 -Scope CurrentUser
 
+if ($IsContainer) {
+    # PSScriptAnalyzer contain lots of json files for the UseCompatibleCommands check. We don't use this rule so by
+    # removing the contents we can save 200MB in the docker image (or more in the future).
+    # https://github.com/PowerShell/PSScriptAnalyzer/blob/master/RuleDocumentation/UseCompatibleCommands.md
+    $pssaPath = (Get-Module -ListAvailable -Name PSScriptAnalyzer).ModuleBase
+    $compatPath = Join-Path -Path $pssaPath -ChildPath compatibility_profiles -AdditionalChildPath '*'
+    Remove-Item -Path $compatPath -Recurse -Force
+}
+
 # Installed the PSCustomUseLiteralPath rule
 Install-Module -Name PSSA-PSCustomUseLiteralPath -RequiredVersion 0.1.1 -Scope CurrentUser
diff --git a/test/sanity/ignore.txt b/test/sanity/ignore.txt
index 51cc725660..21054b4775 100644
--- a/test/sanity/ignore.txt
+++ b/test/sanity/ignore.txt
@@ -375,6 +375,7 @@ test/integration/targets/win_script/files/test_script_with_splatting.ps1 pslint:
 test/integration/targets/windows-minimal/library/win_ping_syntax_error.ps1 pslint!skip
 test/lib/ansible_test/_data/requirements/constraints.txt test-constraints
 test/lib/ansible_test/_data/requirements/integration.cloud.azure.txt test-constraints
+test/lib/ansible_test/_data/requirements/sanity.ps1 pslint:PSCustomUseLiteralPath # Uses wildcards on purpose
 test/lib/ansible_test/_data/sanity/pylint/plugins/string_format.py use-compat-six
 test/lib/ansible_test/_data/setup/ConfigureRemotingForAnsible.ps1 pslint:PSCustomUseLiteralPath
 test/lib/ansible_test/_data/setup/windows-httptester.ps1 pslint:PSCustomUseLiteralPath
