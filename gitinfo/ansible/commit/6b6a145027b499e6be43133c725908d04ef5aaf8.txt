commit 6b6a145027b499e6be43133c725908d04ef5aaf8
Author: James Tanner <tanner.jc@gmail.com>
Date:   Mon Oct 2 08:44:13 2017 -0400

    Add an option to spawn vcsim in esx mode (#31155)

diff --git a/test/utils/docker/vcenter-simulator/flask_control.py b/test/utils/docker/vcenter-simulator/flask_control.py
index 1ea8cb5b34..2c70d7a230 100755
--- a/test/utils/docker/vcenter-simulator/flask_control.py
+++ b/test/utils/docker/vcenter-simulator/flask_control.py
@@ -132,12 +132,24 @@ def spawn_vcsim():
         '-httptest.serve',
         '%s:%s' % (hostname, port),
     ]
-    for x in cli_opts:
-        name = x[0]
-        default = x[1]
-        if request.args.get(name):
-            default = request.args.get(name)
-        cmd.append('-%s=%s' % (name, default))
+
+    # esx only allows certain arguments
+    if request.args.get('esx'):
+        cmd.append('-esx')
+        for x in [('vm', 1), ('ds', 1)]:
+            name = x[0]
+            default = x[1]
+            if request.args.get(name):
+                default = request.args.get(name)
+            cmd.append('-%s=%s' % (name, default))
+    else:
+        # use all other options as requested for vcenter
+        for x in cli_opts:
+            name = x[0]
+            default = x[1]
+            if request.args.get(name):
+                default = request.args.get(name)
+            cmd.append('-%s=%s' % (name, default))
     cmd = ' '.join(cmd)
     cmd += ' 2>&1 > vcsim.log'
 
