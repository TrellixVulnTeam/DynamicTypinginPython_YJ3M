commit 0c74ee4352fc5702de25d8bab8a592e0e044f0bc
Author: Matt Clay <matt@mystile.com>
Date:   Wed Aug 14 16:33:45 2019 -0700

    Clean up various integration tests. (#60613)
    
    * Fix var_blending test temp dir usage.
    
    * Fix filters integration test:
    
    - Fix use of `output_dir`.
    - Use `localhost` instead of `testhost` since we're only testing filters.
    - Fix `fileglob` test to actually test a directory that exists.
    
    * Fix lookups integration test:
    
    - Fix use of `output_dir`.
    - Use `localhost` instead of `testhost` since we're only testing lookups.
    
    * Fix ansible-runner test temp dir usage.
    
    * Fix template and template_jinja2_latest test.
    
    Use the `OUTPUT_DIR` env var to get the output directory for the tests.
    
    * Fix Python version compat in filters test.
    
    * Skip filters test on Python 2.6.

diff --git a/test/integration/targets/ansible-runner/runme.sh b/test/integration/targets/ansible-runner/runme.sh
index 2996fa1a83..384de80f72 100755
--- a/test/integration/targets/ansible-runner/runme.sh
+++ b/test/integration/targets/ansible-runner/runme.sh
@@ -2,4 +2,4 @@
 
 set -eux
 
-ANSIBLE_ROLES_PATH=../ ansible-playbook test.yml -e '@../../integration_config.yml' -i inventory "$@"
+ANSIBLE_ROLES_PATH=../ ansible-playbook test.yml -i inventory "$@"
diff --git a/test/integration/targets/ansible-runner/tasks/adhoc_example1.yml b/test/integration/targets/ansible-runner/tasks/adhoc_example1.yml
index d2bb3def60..5a4c55268e 100644
--- a/test/integration/targets/ansible-runner/tasks/adhoc_example1.yml
+++ b/test/integration/targets/ansible-runner/tasks/adhoc_example1.yml
@@ -1,5 +1,5 @@
 - name: execute the script
-  command: "'{{ ansible_python_interpreter }}' '{{ role_path }}/files/adhoc_example1.py' '{{ output_dir }}'"
+  command: "'{{ ansible_python_interpreter }}' '{{ role_path }}/files/adhoc_example1.py' '{{ lookup('env', 'OUTPUT_DIR') }}'"
   environment:
     AWX_LIB_DIRECTORY: "{{ callback_path }}"
   register: script
diff --git a/test/integration/targets/ansible-runner/tasks/playbook_example1.yml b/test/integration/targets/ansible-runner/tasks/playbook_example1.yml
index 381d4279e8..ec1f7cda2e 100644
--- a/test/integration/targets/ansible-runner/tasks/playbook_example1.yml
+++ b/test/integration/targets/ansible-runner/tasks/playbook_example1.yml
@@ -1,5 +1,5 @@
 - name: execute the script
-  command: "'{{ ansible_python_interpreter }}' '{{ role_path }}/files/playbook_example1.py' '{{ output_dir }}'"
+  command: "'{{ ansible_python_interpreter }}' '{{ role_path }}/files/playbook_example1.py' '{{ lookup('env', 'OUTPUT_DIR') }}'"
   environment:
     AWX_LIB_DIRECTORY: "{{ callback_path }}"
   register: script
diff --git a/test/integration/targets/filters/aliases b/test/integration/targets/filters/aliases
index 765b70da79..f04737b845 100644
--- a/test/integration/targets/filters/aliases
+++ b/test/integration/targets/filters/aliases
@@ -1 +1,2 @@
 shippable/posix/group2
+skip/python2.6  # filters are controller only, and we no longer support Python 2.6 on the controller
diff --git a/test/integration/targets/filters/files/fileglob/one.txt b/test/integration/targets/filters/files/fileglob/one.txt
new file mode 100644
index 0000000000..e69de29bb2
diff --git a/test/integration/targets/filters/files/fileglob/two.txt b/test/integration/targets/filters/files/fileglob/two.txt
new file mode 100644
index 0000000000..e69de29bb2
diff --git a/test/integration/targets/filters/files/foo.txt b/test/integration/targets/filters/files/foo.txt
index c8da3d9743..203a1be2b2 100644
--- a/test/integration/targets/filters/files/foo.txt
+++ b/test/integration/targets/filters/files/foo.txt
@@ -44,7 +44,7 @@ quoted = quoted
 
 The fileglob module returns the list of things matching a pattern.
 
-fileglob = []
+fileglob = one.txt, two.txt
 
 There are also various string operations that work on paths.  These do not require
 files to exist and are passthrus to the python os.path functions
diff --git a/test/integration/targets/filters/filters.yml b/test/integration/targets/filters/filters.yml
index 81b9592b51..acac43bc64 100644
--- a/test/integration/targets/filters/filters.yml
+++ b/test/integration/targets/filters/filters.yml
@@ -1,4 +1,4 @@
-- hosts: testhost
+- hosts: localhost
   gather_facts: yes
   roles:
     - { role: filters }
diff --git a/test/integration/targets/filters/host_vars/testhost b/test/integration/targets/filters/host_vars/localhost
similarity index 100%
rename from test/integration/targets/filters/host_vars/testhost
rename to test/integration/targets/filters/host_vars/localhost
diff --git a/test/integration/targets/filters/runme.sh b/test/integration/targets/filters/runme.sh
index d2a38f5900..2266ba3cc5 100755
--- a/test/integration/targets/filters/runme.sh
+++ b/test/integration/targets/filters/runme.sh
@@ -9,4 +9,4 @@ source virtualenv.sh
 
 pip install jmespath netaddr
 
-ANSIBLE_ROLES_PATH=../ ansible-playbook filters.yml -i ../../inventory -e @../../integration_config.yml "$@"
+ANSIBLE_ROLES_PATH=../ ansible-playbook filters.yml "$@"
diff --git a/test/integration/targets/filters/tasks/main.yml b/test/integration/targets/filters/tasks/main.yml
index 6d167f7bec..678d26f2ef 100644
--- a/test/integration/targets/filters/tasks/main.yml
+++ b/test/integration/targets/filters/tasks/main.yml
@@ -3,6 +3,9 @@
 # Copyright: (c) 2019, Ansible Project
 # GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
 
+- set_fact:
+    output_dir: "{{ lookup('env', 'OUTPUT_DIR') }}"
+
 - name: a dummy task to test the changed and success filters
   shell: echo hi
   register: some_registered_var
diff --git a/test/integration/targets/filters/templates/foo.j2 b/test/integration/targets/filters/templates/foo.j2
index 010dcd0b7e..5661723e5b 100644
--- a/test/integration/targets/filters/templates/foo.j2
+++ b/test/integration/targets/filters/templates/foo.j2
@@ -38,7 +38,7 @@ quoted = {{ 'quoted' | quote }}
 
 The fileglob module returns the list of things matching a pattern.
 
-fileglob = {{ (output_dir + '/*') | fileglob }}
+fileglob = {{ (playbook_dir + '/files/fileglob/*') | fileglob | map('basename') | sort | join(', ') }}
 
 There are also various string operations that work on paths.  These do not require
 files to exist and are passthrus to the python os.path functions
diff --git a/test/integration/targets/lookups/lookups.yml b/test/integration/targets/lookups/lookups.yml
index 3fc1f9bb9b..b50d63c044 100644
--- a/test/integration/targets/lookups/lookups.yml
+++ b/test/integration/targets/lookups/lookups.yml
@@ -1,4 +1,4 @@
-- hosts: testhost
+- hosts: localhost
   gather_facts: yes
   roles:
     - { role: lookups }
diff --git a/test/integration/targets/lookups/runme.sh b/test/integration/targets/lookups/runme.sh
index 77a73b9975..e92afab462 100755
--- a/test/integration/targets/lookups/runme.sh
+++ b/test/integration/targets/lookups/runme.sh
@@ -8,6 +8,6 @@ source virtualenv.sh
 # because plugins and requirements are loaded before the task runs
 pip install passlib
 
-ANSIBLE_ROLES_PATH=../ ansible-playbook lookups.yml -i ../../inventory -e @../../integration_config.yml "$@"
+ANSIBLE_ROLES_PATH=../ ansible-playbook lookups.yml "$@"
 
-ansible-playbook template_lookup_vaulted.yml -i ../../inventory -e @../../integration_config.yml --vault-password-file test_vault_pass "$@"
+ansible-playbook template_lookup_vaulted.yml --vault-password-file test_vault_pass "$@"
diff --git a/test/integration/targets/lookups/tasks/main.yml b/test/integration/targets/lookups/tasks/main.yml
index 7700758164..452515261b 100644
--- a/test/integration/targets/lookups/tasks/main.yml
+++ b/test/integration/targets/lookups/tasks/main.yml
@@ -4,6 +4,9 @@
 
 # FILE LOOKUP
 
+- set_fact:
+    output_dir: "{{ lookup('env', 'OUTPUT_DIR') }}"
+
 - name: make a new file to read
   copy: dest={{output_dir}}/foo.txt mode=0644 content="bar"
 
diff --git a/test/integration/targets/template/ansible_managed.yml b/test/integration/targets/template/ansible_managed.yml
index d827e55cab..2bd7c2c4f7 100644
--- a/test/integration/targets/template/ansible_managed.yml
+++ b/test/integration/targets/template/ansible_managed.yml
@@ -2,6 +2,8 @@
 - hosts: testhost
   gather_facts: False
   tasks:
+  - set_fact:
+      output_dir: "{{ lookup('env', 'OUTPUT_DIR') }}"
   - file:
       path: '{{ output_dir }}/caf√©.txt'
       state: 'absent'
diff --git a/test/integration/targets/template/custom_tasks/tasks/main.yml b/test/integration/targets/template/custom_tasks/tasks/main.yml
index d9f5e445b8..182f7ccaab 100644
--- a/test/integration/targets/template/custom_tasks/tasks/main.yml
+++ b/test/integration/targets/template/custom_tasks/tasks/main.yml
@@ -1,4 +1,7 @@
 ---
+- set_fact:
+    output_dir: "{{ lookup('env', 'OUTPUT_DIR') }}"
+
 - template:
     src: test
     dest: "{{ output_dir }}/templated_test"
diff --git a/test/integration/targets/template/runme.sh b/test/integration/targets/template/runme.sh
index 352b41a3f4..abdd62f28b 100755
--- a/test/integration/targets/template/runme.sh
+++ b/test/integration/targets/template/runme.sh
@@ -2,16 +2,16 @@
 
 set -eux
 
-ANSIBLE_ROLES_PATH=../ ansible-playbook template.yml -i ../../inventory -e @../../integration_config.yml -v "$@"
+ANSIBLE_ROLES_PATH=../ ansible-playbook template.yml -i ../../inventory -v "$@"
 
 # Test for #35571
 ansible testhost -i testhost, -m debug -a 'msg={{ hostvars["localhost"] }}' -e "vars1={{ undef }}" -e "vars2={{ vars1 }}"
 
 # Test for https://github.com/ansible/ansible/issues/27262
-ansible-playbook ansible_managed.yml -c  ansible_managed.cfg -i ../../inventory -e @../../integration_config.yml -v "$@"
+ansible-playbook ansible_managed.yml -c  ansible_managed.cfg -i ../../inventory -v "$@"
 
 # Test for #42585
-ANSIBLE_ROLES_PATH=../ ansible-playbook custom_template.yml -i ../../inventory -e @../../integration_config.yml -v "$@"
+ANSIBLE_ROLES_PATH=../ ansible-playbook custom_template.yml -i ../../inventory -v "$@"
 
 
 # Test for several corner cases #57188
diff --git a/test/integration/targets/template/tasks/main.yml b/test/integration/targets/template/tasks/main.yml
index 6fd25e1095..10ea474d7c 100644
--- a/test/integration/targets/template/tasks/main.yml
+++ b/test/integration/targets/template/tasks/main.yml
@@ -16,6 +16,9 @@
 # You should have received a copy of the GNU General Public License
 # along with Ansible.  If not, see <http://www.gnu.org/licenses/>.
 
+- set_fact:
+    output_dir: "{{ lookup('env', 'OUTPUT_DIR') }}"
+
 - name: show python interpreter
   debug:
      msg: "{{ ansible_python['executable'] }}"
@@ -395,7 +398,7 @@
   assert:
     that:
       - "template_result is not changed"
-      - "'templated_var_loaded' in lookup('file', '{{output_dir | expanduser}}/short.templated')"
+      - "'templated_var_loaded' in lookup('file', output_dir + '/short.templated')"
 
 - name: change var for the template
   set_fact:
@@ -409,7 +412,7 @@
 - name: verify that the file was marked as changed in check mode but the content was not changed
   assert:
     that:
-      - "'templated_var_loaded' in lookup('file', '{{output_dir | expanduser }}/short.templated')"
+      - "'templated_var_loaded' in lookup('file', output_dir + '/short.templated')"
       - "template_result is changed"
 
 # Create a template using a child template, to ensure that variables
diff --git a/test/integration/targets/template_jinja2_latest/runme.sh b/test/integration/targets/template_jinja2_latest/runme.sh
index 78dcf36fcd..e9767ac549 100755
--- a/test/integration/targets/template_jinja2_latest/runme.sh
+++ b/test/integration/targets/template_jinja2_latest/runme.sh
@@ -9,4 +9,4 @@ pip install -U jinja2
 ANSIBLE_ROLES_PATH=../
 export ANSIBLE_ROLES_PATH
 
-ansible-playbook -i ../../inventory main.yml -e @../../integration_config.yml -v "$@"
+ansible-playbook -i ../../inventory main.yml -v "$@"
diff --git a/test/integration/targets/var_blending/roles/test_var_blending/tasks/main.yml b/test/integration/targets/var_blending/roles/test_var_blending/tasks/main.yml
index 33c66d9b9f..f2b2e54a64 100644
--- a/test/integration/targets/var_blending/roles/test_var_blending/tasks/main.yml
+++ b/test/integration/targets/var_blending/roles/test_var_blending/tasks/main.yml
@@ -18,6 +18,9 @@
 
 - include_vars: more_vars.yml
 
+- set_fact:
+    output_dir: "{{ lookup('env', 'OUTPUT_DIR') }}"
+
 - name: deploy a template that will use variables at various levels
   template: src=foo.j2 dest={{output_dir}}/foo.templated 
   register: template_result
diff --git a/test/integration/targets/var_blending/runme.sh b/test/integration/targets/var_blending/runme.sh
index 24e523ced5..d0cf7f090c 100755
--- a/test/integration/targets/var_blending/runme.sh
+++ b/test/integration/targets/var_blending/runme.sh
@@ -2,4 +2,4 @@
 
 set -eux
 
-ansible-playbook test_var_blending.yml -i inventory -e @integration_config.yml -v "$@"
+ansible-playbook test_var_blending.yml -i inventory -e @test_vars.yml -v "$@"
diff --git a/test/integration/targets/var_blending/integration_config.yml b/test/integration/targets/var_blending/test_vars.yml
similarity index 54%
rename from test/integration/targets/var_blending/integration_config.yml
rename to test/integration/targets/var_blending/test_vars.yml
index 0686934a9a..abb71a55d8 100644
--- a/test/integration/targets/var_blending/integration_config.yml
+++ b/test/integration/targets/var_blending/test_vars.yml
@@ -1,2 +1 @@
-output_dir: .
 etest: 'from -e'
