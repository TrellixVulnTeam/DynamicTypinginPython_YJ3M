commit 314e6d0d8acc72717e7d9b0f7dfad2a1a4d57ba4
Author: Brian Coca <bcoca@ansible.com>
Date:   Mon Sep 18 13:37:01 2017 -0400

    start of 'is chroot' fact
    
    probably missing cornercases for some linux/bsd setups and other OSs

diff --git a/lib/ansible/module_utils/facts/default_collectors.py b/lib/ansible/module_utils/facts/default_collectors.py
index ffd14a9e9a..f76dc7b7f4 100644
--- a/lib/ansible/module_utils/facts/default_collectors.py
+++ b/lib/ansible/module_utils/facts/default_collectors.py
@@ -23,6 +23,7 @@ from ansible.module_utils.facts.other.ohai import OhaiFactCollector
 
 from ansible.module_utils.facts.system.apparmor import ApparmorFactCollector
 from ansible.module_utils.facts.system.caps import SystemCapabilitiesFactCollector
+from ansible.module_utils.facts.system.chroot import ChrootFactCollector
 from ansible.module_utils.facts.system.cmdline import CmdLineFactCollector
 from ansible.module_utils.facts.system.distribution import DistributionFactCollector
 from ansible.module_utils.facts.system.date_time import DateTimeFactCollector
@@ -74,6 +75,7 @@ from ansible.module_utils.facts.virtual.sunos import SunOSVirtualCollector
 
 # TODO: make config driven
 collectors = [ApparmorFactCollector,
+              ChrootFactCollector,
               CmdLineFactCollector,
               DateTimeFactCollector,
               DistributionFactCollector,
diff --git a/lib/ansible/module_utils/facts/system/chroot.py b/lib/ansible/module_utils/facts/system/chroot.py
new file mode 100644
index 0000000000..39ccf960c9
--- /dev/null
+++ b/lib/ansible/module_utils/facts/system/chroot.py
@@ -0,0 +1,35 @@
+# Copyright (c) 2017 Ansible Project
+# GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)
+from __future__ import (absolute_import, division, print_function)
+__metaclass__ = type
+
+import os
+
+from ansible.module_utils.facts.collector import BaseFactCollector
+
+
+def is_chroot():
+
+    is_chroot = None
+
+    if os.environ.get('debian_chroot', False):
+        is_chroot = True
+    else:
+        my_root = os.stat('/')
+        try:
+            # check if my file system is the root one
+            proc_root = os.stat('/proc/1/root/.')
+            is_chroot = my_root.st_ino != proc_root.st_ino or my_root.st_dev != proc_root.st_dev
+        except:
+            # I'm not root or no proc, fallback to checking it is inode #2
+            is_chroot = (my_root.st_ino != 2)
+
+    return is_chroot
+
+
+class ChrootFactCollector(BaseFactCollector):
+    name = 'chroot'
+    _fact_ids = set(['is_chroot'])
+
+    def collect(self, module=None, collected_facts=None):
+        return {'is_chroot': is_chroot()}
