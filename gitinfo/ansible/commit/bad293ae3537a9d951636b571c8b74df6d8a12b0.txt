commit bad293ae3537a9d951636b571c8b74df6d8a12b0
Author: Matt Clay <matt@mystile.com>
Date:   Thu May 19 10:33:17 2016 -0700

    Add work-around for ssh pty race condition.
    
    This should minimize loss of stdout when using
    a pty and connecting with ssh or paramiko_ssh.

diff --git a/lib/ansible/plugins/action/__init__.py b/lib/ansible/plugins/action/__init__.py
index 1d2275ae61..bff7f84de7 100644
--- a/lib/ansible/plugins/action/__init__.py
+++ b/lib/ansible/plugins/action/__init__.py
@@ -711,6 +711,9 @@ class ActionBase(with_metaclass(ABCMeta, object)):
         if self._connection.allow_executable:
             if executable is None:
                 executable = self._play_context.executable
+                # mitigation for SSH race which can drop stdout (https://github.com/ansible/ansible/issues/13876)
+                # only applied for the default executable to avoid interfering with the raw action
+                cmd = self._connection._shell.append_command(cmd, 'sleep 0')
             if executable:
                 cmd = executable + ' -c ' + pipes.quote(cmd)
 
diff --git a/lib/ansible/plugins/shell/__init__.py b/lib/ansible/plugins/shell/__init__.py
index 1fed18ad3f..28ded355ff 100644
--- a/lib/ansible/plugins/shell/__init__.py
+++ b/lib/ansible/plugins/shell/__init__.py
@@ -178,3 +178,11 @@ class ShellBase(object):
         if rm_tmp:
             new_cmd = '%s; rm -rf "%s" %s' % (new_cmd, rm_tmp, self._SHELL_REDIRECT_ALLNULL)
         return new_cmd
+
+    def append_command(self, cmd, cmd_to_append):
+        """Append an additional command if supported by the shell"""
+
+        if self._SHELL_AND:
+            cmd += ' %s %s' % (self._SHELL_AND, cmd_to_append)
+
+        return cmd
