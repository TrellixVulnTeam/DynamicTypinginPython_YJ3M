commit 61a1fe1d7dd4b2e7d03488dd50e241413f8ed0b4
Author: Rick Elrod <rick@elrod.me>
Date:   Fri May 29 15:45:33 2020 -0500

    Fix network_cli test to use a trap for cleanup (#69762)
    
    Signed-off-by: Rick Elrod <rick@elrod.me>

diff --git a/test/integration/targets/network_cli/passworded_user.yml b/test/integration/targets/network_cli/passworded_user.yml
index 20781a2af5..5538684c5e 100644
--- a/test/integration/targets/network_cli/passworded_user.yml
+++ b/test/integration/targets/network_cli/passworded_user.yml
@@ -1,4 +1,4 @@
-- hosts: vyos-1-1-8
+- hosts: vyos
   gather_facts: false
 
   tasks:
diff --git a/test/integration/targets/network_cli/runme.sh b/test/integration/targets/network_cli/runme.sh
index 783016a925..156674fe4d 100755
--- a/test/integration/targets/network_cli/runme.sh
+++ b/test/integration/targets/network_cli/runme.sh
@@ -1,7 +1,13 @@
 #!/usr/bin/env bash
-set -ux # no -e because we want to run teardown no matter waht
+set -eux
 export ANSIBLE_ROLES_PATH=../
 
+function cleanup {
+    ansible-playbook teardown.yml -i "$INVENTORY_PATH" "$@"
+}
+
+trap cleanup EXIT
+
 ansible-playbook setup.yml -i "$INVENTORY_PATH" "$@"
 
 # We need a nonempty file to override key with (empty file gives a
@@ -9,11 +15,13 @@ ansible-playbook setup.yml -i "$INVENTORY_PATH" "$@"
 foo=$(mktemp)
 echo hello > "$foo"
 
+# We want to ensure that passwords make it to the network connection plugins
+# because they follow a different path than the rest of the codebase.
+# In setup.yml, we create a passworded user, and now we connect as that user
+# to make sure the password we pass here successfully makes it to the plugin.
 ansible-playbook \
     -i "$INVENTORY_PATH" \
     -e ansible_user=atester \
     -e ansible_password=testymctest \
     -e ansible_ssh_private_key_file="$foo" \
     passworded_user.yml
-
-ansible-playbook teardown.yml -i "$INVENTORY_PATH" "$@"
diff --git a/test/integration/targets/network_cli/setup.yml b/test/integration/targets/network_cli/setup.yml
index bd61eb41fa..d862406f1f 100644
--- a/test/integration/targets/network_cli/setup.yml
+++ b/test/integration/targets/network_cli/setup.yml
@@ -1,4 +1,4 @@
-- hosts: vyos-1-1-8
+- hosts: vyos
   connection: ansible.netcommon.network_cli
   become: true
   gather_facts: false
diff --git a/test/integration/targets/network_cli/teardown.yml b/test/integration/targets/network_cli/teardown.yml
index b7b66a4965..c47f3e8967 100644
--- a/test/integration/targets/network_cli/teardown.yml
+++ b/test/integration/targets/network_cli/teardown.yml
@@ -1,4 +1,4 @@
-- hosts: vyos-1-1-8
+- hosts: vyos
   connection: ansible.netcommon.network_cli
   become: true
   gather_facts: false
