commit 0d8b81cd95a2f847f083fe03d769e7206415542f
Author: Michael Scherer <misc@zarb.org>
Date:   Sun Nov 17 15:10:17 2013 +0100

    optionally use rpm python module instead of calling a
    external executable, to avoid the cost of forking.
    Since python-rpm is not automatically present, we still fallback
    on the slower rpm fork method.

diff --git a/library/packaging/urpmi b/library/packaging/urpmi
index ac96a9d74f..46745fce5d 100644
--- a/library/packaging/urpmi
+++ b/library/packaging/urpmi
@@ -76,11 +76,18 @@ import json
 import shlex
 import os
 import sys
+try:
+    import rpm
+    USE_PYTHON = True
+except ImportError:
+    USE_PYTHON = False
 
 URPMI_PATH = '/usr/sbin/urpmi'
 URPME_PATH = '/usr/sbin/urpme'
 
 def query_package(module, name):
+    if USE_PYTHON:
+        return rpm.TransactionSet().dbMatch(rpm.RPMTAG_NAME, name).count() != 0
 
     # rpm -q returns 0 if the package is installed,
     # 1 if it is not installed
@@ -91,6 +98,8 @@ def query_package(module, name):
         return False
 
 def query_package_provides(module, name):
+    if USE_PYTHON:
+        return rpm.TransactionSet().dbMatch(rpm.RPMTAG_PROVIDES, name).count() != 0
 
     # rpm -q returns 0 if the package is installed,
     # 1 if it is not installed
