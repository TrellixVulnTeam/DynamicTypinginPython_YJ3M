commit f0657ddd93db039a95ec10930b8b8410b74454c2
Author: byron <byron@plot.ly>
Date:   Wed Jul 31 18:40:16 2019 -0400

    :sparkles: add control flag for percy finalize

diff --git a/dash/testing/browser.py b/dash/testing/browser.py
index b7bd53b5..5f4ae54e 100644
--- a/dash/testing/browser.py
+++ b/dash/testing/browser.py
@@ -36,6 +36,7 @@ class Browser(DashPageMixin):
         options=None,
         remote=None,
         download_path=None,
+        percy_finalize=True,
         wait_timeout=10,
     ):
         self._browser = browser.lower()
@@ -43,6 +44,7 @@ class Browser(DashPageMixin):
         self._options = options
         self._download_path = download_path
         self._wait_timeout = wait_timeout
+        self._percy_finalize = percy_finalize
 
         self._driver = until(lambda: self.get_webdriver(remote), timeout=1)
         self._driver.implicitly_wait(2)
@@ -72,8 +74,15 @@ class Browser(DashPageMixin):
     def __exit__(self, exc_type, exc_val, traceback):
         try:
             self.driver.quit()
+            if self._percy_finalize:
+                logger.info("percy runner finalize build now")
+                self.percy_runner.finalize_build()
+            else:
+                logger.info("percy finalize relies on CI job")
         except WebDriverException:
             logger.exception("webdriver quit was not successful")
+        except percy.errors.Error:
+            logger.exception("percy runner failed to finalize properly")
 
     def percy_snapshot(self, name=""):
         """percy_snapshot - visual test api shortcut to `percy_runner.snapshot`
diff --git a/dash/testing/plugin.py b/dash/testing/plugin.py
index 9aeb67c5..155d50ed 100644
--- a/dash/testing/plugin.py
+++ b/dash/testing/plugin.py
@@ -30,7 +30,15 @@ def pytest_addoption(parser):
     )
 
     dash.addoption(
-        "--headless", action="store_true", help="Run tests in headless mode"
+        "--headless",
+        action="store_true",
+        help="set this flag to run in headless mode",
+    )
+
+    dash.addoption(
+        "--percyfinalize",
+        action="store_false",
+        help="set this flag to control percy finalize at CI level",
     )
 
 
@@ -94,6 +102,7 @@ def dash_br(request, tmpdir):
         headless=request.config.getoption("headless"),
         options=request.config.hook.pytest_setup_options(),
         download_path=tmpdir.mkdir("download").strpath,
+        percy_finalize=request.config.getoption("percyfinalize"),
     ) as browser:
         yield browser
 
@@ -106,6 +115,7 @@ def dash_duo(request, dash_thread_server, tmpdir):
         headless=request.config.getoption("headless"),
         options=request.config.hook.pytest_setup_options(),
         download_path=tmpdir.mkdir("download").strpath,
+        percy_finalize=request.config.getoption("percyfinalize"),
     ) as dc:
         yield dc
 
@@ -118,5 +128,6 @@ def dashr(request, dashr_server, tmpdir):
         headless=request.config.getoption("headless"),
         options=request.config.hook.pytest_setup_options(),
         download_path=tmpdir.mkdir("download").strpath,
+        percy_finalize=request.config.getoption("percyfinalize"),
     ) as dc:
         yield dc
