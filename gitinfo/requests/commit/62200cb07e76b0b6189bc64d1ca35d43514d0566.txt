commit 62200cb07e76b0b6189bc64d1ca35d43514d0566
Author: Priit Laes <plaes@plaes.org>
Date:   Sat Mar 7 09:40:25 2015 +0200

    Add testcase to demonstrate r.iter_lines() reentrancy issue

diff --git a/test_requests.py b/test_requests.py
index 07430a8e..15406a22 100755
--- a/test_requests.py
+++ b/test_requests.py
@@ -1052,6 +1052,23 @@ class RequestsTestCase(unittest.TestCase):
         assert 'application/json' in r.request.headers['Content-Type']
         assert {'life': 42} == r.json()['json']
 
+    def test_response_iter_lines(self):
+        r = requests.get(httpbin('stream/4'), stream=True)
+        assert r.status_code == 200
+
+        it = r.iter_lines()
+        next(it)
+        assert len(list(it)) == 3
+
+    @pytest.mark.xfail
+    def test_response_iter_lines_reentrant(self):
+        """Response.iter_lines() is not reentrant safe"""
+        r = requests.get(httpbin('stream/4'), stream=True)
+        assert r.status_code == 200
+
+        next(r.iter_lines())
+        assert len(list(r.iter_lines())) == 3
+
 
 class TestContentEncodingDetection(unittest.TestCase):
 
