commit 2ad3f079821769062ad6b8e91c927b1b345895d6
Author: Braulio Valdivielso Mart√≠nez <brlvldvlsmrtnz@gmail.com>
Date:   Wed Nov 25 14:41:03 2015 +0100

    Make exceptions in the testserver.Server thread not block the main thread

diff --git a/testserver/server.py b/testserver/server.py
index 689aaaf8..6fa6464e 100644
--- a/testserver/server.py
+++ b/testserver/server.py
@@ -14,16 +14,23 @@ class Server(threading.Thread):
         self.stop_event = threading.Event()
 
     def run(self):
+        try:
+            sock = self._create_socket_and_bind()
+            # in case self.port = 0
+            self.port = sock.getsockname()[1]
+            self.ready_event.set()
+            self.handler(sock)
+            
+        finally:
+            self.ready_event.set() # just in case of exception
+            self.stop_event.set()
+            sock.close()
+
+    def _create_socket_and_bind(self):
         sock = socket.socket()
         sock.bind((self.host, self.port))
-        
-        # update port in case self.port = 0
-        self.port = sock.getsockname()[1]
         sock.listen(0)
-        self.ready_event.set()
-        self.handler(sock)
-        self.stop_event.set()
-        sock.close()
+        return sock
 
     def __enter__(self):
        self.start()
