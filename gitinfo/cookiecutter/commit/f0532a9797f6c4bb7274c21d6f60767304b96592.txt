commit f0532a9797f6c4bb7274c21d6f60767304b96592
Author: Raphael Pierzina <raphael@hackebrot.de>
Date:   Fri Dec 4 23:43:54 2015 +0100

    Re-raise in prompt_for_config and use 'key' for error message

diff --git a/cookiecutter/prompt.py b/cookiecutter/prompt.py
index 968d7dc..7b931c8 100755
--- a/cookiecutter/prompt.py
+++ b/cookiecutter/prompt.py
@@ -92,12 +92,7 @@ def render_variable(env, raw, cookiecutter_dict):
         raw = str(raw)
     template = env.from_string(raw)
 
-    try:
-        rendered_template = template.render(cookiecutter=cookiecutter_dict)
-    except UndefinedError as err:
-        msg = "Unable to render variable '{}'".format(raw)
-        raise UndefinedVariableInTemplate(msg, err, cookiecutter_dict)
-
+    rendered_template = template.render(cookiecutter=cookiecutter_dict)
     return rendered_template
 
 
@@ -129,17 +124,21 @@ def prompt_for_config(context, no_input=False):
             cookiecutter_dict[key] = raw
             continue
 
-        if isinstance(raw, list):
-            # We are dealing with a choice variable
-            val = prompt_choice_for_config(
-                cookiecutter_dict, env, key, raw, no_input
-            )
-        else:
-            # We are dealing with a regular variable
-            val = render_variable(env, raw, cookiecutter_dict)
-
-            if not no_input:
-                val = read_user_variable(key, val)
+        try:
+            if isinstance(raw, list):
+                # We are dealing with a choice variable
+                val = prompt_choice_for_config(
+                    cookiecutter_dict, env, key, raw, no_input
+                )
+            else:
+                # We are dealing with a regular variable
+                val = render_variable(env, raw, cookiecutter_dict)
+
+                if not no_input:
+                    val = read_user_variable(key, val)
+        except UndefinedError as err:
+            msg = "Unable to render variable '{}'".format(key)
+            raise UndefinedVariableInTemplate(msg, err, context)
 
         cookiecutter_dict[key] = val
     return cookiecutter_dict
diff --git a/tests/test_prompt.py b/tests/test_prompt.py
index 1274292..42aad0b 100644
--- a/tests/test_prompt.py
+++ b/tests/test_prompt.py
@@ -264,5 +264,20 @@ def test_undefined_variable_in_cookiecutter_dict():
         prompt.prompt_for_config(context, no_input=True)
 
     error = err.value
-    assert error.message == "Unable to render variable '{{cookiecutter.nope}}'"
-    assert error.context == {'hello': 'world'}
+    assert error.message == "Unable to render variable 'foo'"
+    assert error.context == context
+
+
+def test_undefined_variable_in_cookiecutter_dict_with_choices():
+    context = {
+        'cookiecutter': {
+            'hello': 'world',
+            'foo': ['123', '{{cookiecutter.nope}}', '456']
+        }
+    }
+    with pytest.raises(exceptions.UndefinedVariableInTemplate) as err:
+        prompt.prompt_for_config(context, no_input=True)
+
+    error = err.value
+    assert error.message == "Unable to render variable 'foo'"
+    assert error.context == context
