commit 33160172d718763a461a255bcadcff37cc7679bc
Author: Nathan Cheung <ncheung@ciena.com>
Date:   Mon Nov 28 21:01:11 2016 +0000

    load custom extensions in pre-hook

diff --git a/cookiecutter/generate.py b/cookiecutter/generate.py
index 68607d3..ea670c7 100644
--- a/cookiecutter/generate.py
+++ b/cookiecutter/generate.py
@@ -220,11 +220,18 @@ def ensure_dir_is_templated(dirname):
         raise NonTemplatedInputDirException
 
 
-def _run_hook_from_repo_dir(repo_dir, hook_name, project_dir, context):
-    """Run hook from repo directory, clean project directory if hook fails."""
+def _run_hook_from_repo_dir(repo_dir, hook_name, project_dir, context, env):
+    """Run hook from repo directory, clean project directory if hook fails.
+
+    :param repo_dir: Project template input directory.
+    :param hook_name: The hook to execute.
+    :param project_dir: The directory to execute the script from.
+    :param context: Cookiecutter project context.
+    :param env: Jinja2 template execution environment.
+    """
     with work_in(repo_dir):
         try:
-            run_hook(hook_name, project_dir, context)
+            run_hook(hook_name, project_dir, context, env)
         except FailedHookException:
             rmtree(project_dir)
             logger.error(
@@ -276,7 +283,13 @@ def generate_files(repo_dir, context=None, output_dir='.',
     project_dir = os.path.abspath(project_dir)
     logger.debug('Project directory is {}'.format(project_dir))
 
-    _run_hook_from_repo_dir(repo_dir, 'pre_gen_project', project_dir, context)
+    _run_hook_from_repo_dir(
+        repo_dir,
+        'pre_gen_project',
+        project_dir,
+        context,
+        env
+    )
 
     with work_in(template_dir):
         env.loader = FileSystemLoader('.')
@@ -346,6 +359,12 @@ def generate_files(repo_dir, context=None, output_dir='.',
                     msg = "Unable to create file '{}'".format(infile)
                     raise UndefinedVariableInTemplate(msg, err, context)
 
-    _run_hook_from_repo_dir(repo_dir, 'post_gen_project', project_dir, context)
+    _run_hook_from_repo_dir(
+        repo_dir,
+        'post_gen_project',
+        project_dir,
+        context,
+        env
+    )
 
     return project_dir
diff --git a/cookiecutter/hooks.py b/cookiecutter/hooks.py
index bffd5d7..fbc8234 100644
--- a/cookiecutter/hooks.py
+++ b/cookiecutter/hooks.py
@@ -9,8 +9,6 @@ import subprocess
 import sys
 import tempfile
 
-from jinja2 import Template
-
 from cookiecutter import utils
 from .exceptions import FailedHookException
 
@@ -90,12 +88,13 @@ def run_script(script_path, cwd='.'):
             "Hook script failed (exit status: %d)" % exit_status)
 
 
-def run_script_with_context(script_path, cwd, context):
+def run_script_with_context(script_path, cwd, context, env):
     """Execute a script after rendering it with Jinja.
 
     :param script_path: Absolute path to the script to run.
     :param cwd: The directory to run the script from.
     :param context: Cookiecutter project template context.
+    :param env: Jinja2 template execution environment.
     """
     _, extension = os.path.splitext(script_path)
 
@@ -106,23 +105,25 @@ def run_script_with_context(script_path, cwd, context):
         mode='wb',
         suffix=extension
     ) as temp:
-        output = Template(contents).render(**context)
+        template = env.from_string(contents)
+        output = template.render(**context)
         temp.write(output.encode('utf-8'))
 
     run_script(temp.name, cwd)
 
 
-def run_hook(hook_name, project_dir, context):
+def run_hook(hook_name, project_dir, context, env):
     """
     Try to find and execute a hook from the specified project directory.
 
     :param hook_name: The hook to execute.
     :param project_dir: The directory to execute the script from.
     :param context: Cookiecutter project context.
+    :param env: Jinja2 template execution environment.
     """
     script = find_hook(hook_name)
     if script is None:
         logger.debug('No hooks found')
         return
     logger.debug('Running hook {}'.format(hook_name))
-    run_script_with_context(script, project_dir, context)
+    run_script_with_context(script, project_dir, context, env)
diff --git a/tests/test-extensions/custom-extension-post/hooks/post_gen_project.py b/tests/test-extensions/custom-extension-post/hooks/post_gen_project.py
index 3a20ca7..f26e8e1 100644
--- a/tests/test-extensions/custom-extension-post/hooks/post_gen_project.py
+++ b/tests/test-extensions/custom-extension-post/hooks/post_gen_project.py
@@ -1,4 +1,4 @@
 # -*- coding: utf-8 -*-
 # flake8: noqa
 
-print({% hello cookiecutter.name %})
+print('{% hello cookiecutter.name %}')
diff --git a/tests/test-extensions/custom-extension-pre/hooks/pre_gen_project.py b/tests/test-extensions/custom-extension-pre/hooks/pre_gen_project.py
index 3a20ca7..f26e8e1 100644
--- a/tests/test-extensions/custom-extension-pre/hooks/pre_gen_project.py
+++ b/tests/test-extensions/custom-extension-pre/hooks/pre_gen_project.py
@@ -1,4 +1,4 @@
 # -*- coding: utf-8 -*-
 # flake8: noqa
 
-print({% hello cookiecutter.name %})
+print('{% hello cookiecutter.name %}')
diff --git a/tests/test_custom_extensions_in_hooks.py b/tests/test_custom_extensions_in_hooks.py
index 84e7160..c90be5f 100644
--- a/tests/test_custom_extensions_in_hooks.py
+++ b/tests/test_custom_extensions_in_hooks.py
@@ -32,10 +32,6 @@ def modify_syspath(monkeypatch):
     )
 
 
-@pytest.mark.xfail(
-    reason='issue #850',
-    strict=True,
-)
 def test_hook_with_extension(template, output_dir):
     project_dir = main.cookiecutter(
         template,
diff --git a/tests/test_hooks.py b/tests/test_hooks.py
index 4402599..15c2b9e 100644
--- a/tests/test_hooks.py
+++ b/tests/test_hooks.py
@@ -14,6 +14,7 @@ import sys
 import textwrap
 
 from cookiecutter import hooks, utils, exceptions
+from cookiecutter.environment import StrictEnvironment
 
 
 def make_test_repo(name):
@@ -101,6 +102,7 @@ class TestExternalHooks(object):
 
     repo_path = os.path.abspath('tests/test-hooks/')
     hooks_path = os.path.abspath('tests/test-hooks/hooks')
+    env = StrictEnvironment()
 
     def setup_method(self, method):
         self.post_hook = make_test_repo(self.repo_path)
@@ -163,7 +165,8 @@ class TestExternalHooks(object):
                 'cookiecutter': {
                     'file': 'context_post.txt'
                 }
-            })
+            },
+            self.env)
         assert os.path.isfile('tests/context_post.txt')
         assert 'tests' not in os.getcwd()
 
@@ -173,10 +176,10 @@ class TestExternalHooks(object):
         """
         tests_dir = os.path.join(self.repo_path, 'input{{hooks}}')
         with utils.work_in(self.repo_path):
-            hooks.run_hook('pre_gen_project', tests_dir, {})
+            hooks.run_hook('pre_gen_project', tests_dir, {}, self.env)
             assert os.path.isfile(os.path.join(tests_dir, 'python_pre.txt'))
 
-            hooks.run_hook('post_gen_project', tests_dir, {})
+            hooks.run_hook('post_gen_project', tests_dir, {}, self.env)
             assert os.path.isfile(os.path.join(tests_dir, 'shell_post.txt'))
 
     def test_run_failing_hook(self):
@@ -189,7 +192,7 @@ class TestExternalHooks(object):
 
         with utils.work_in(self.repo_path):
             with pytest.raises(exceptions.FailedHookException) as excinfo:
-                hooks.run_hook('pre_gen_project', tests_dir, {})
+                hooks.run_hook('pre_gen_project', tests_dir, {}, self.env)
             assert 'Hook script failed' in str(excinfo.value)
 
 
