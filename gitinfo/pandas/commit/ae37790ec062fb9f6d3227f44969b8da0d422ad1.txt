commit ae37790ec062fb9f6d3227f44969b8da0d422ad1
Author: jreback <jeff@reback.net>
Date:   Tue Apr 22 10:00:16 2014 -0400

    BUG/INT: Internal tests for patching __finalize__ / bug in merge not finalizing (GH 6923)

diff --git a/doc/source/release.rst b/doc/source/release.rst
index d2de554f1..245dd7188 100644
--- a/doc/source/release.rst
+++ b/doc/source/release.rst
@@ -391,6 +391,7 @@ Bug Fixes
 - Bug in ``DataFrame.to_csv`` where setting `index` to `False` ignored the
   `header` kwarg (:issue:`6186`)
 - Bug in `DataFrame.plot` and `Series.plot` legend behave inconsistently when plotting to the same axes repeatedly (:issue:`6678`)
+- Internal tests for patching ``__finalize__`` / bug in merge not finalizing (:issue:`6923`)
 
 pandas 0.13.1
 -------------
diff --git a/pandas/core/generic.py b/pandas/core/generic.py
index 919ea4c0e..9c3b3fab9 100644
--- a/pandas/core/generic.py
+++ b/pandas/core/generic.py
@@ -1827,8 +1827,9 @@ class NDFrame(PandasObject):
             types of propagation actions based on this
 
         """
-        for name in self._metadata:
-            object.__setattr__(self, name, getattr(other, name, None))
+        if isinstance(other, NDFrame):
+            for name in self._metadata:
+                object.__setattr__(self, name, getattr(other, name, None))
         return self
 
     def __getattr__(self, name):
diff --git a/pandas/tests/test_generic.py b/pandas/tests/test_generic.py
index 6c6e70b86..9556f5d9f 100644
--- a/pandas/tests/test_generic.py
+++ b/pandas/tests/test_generic.py
@@ -3,7 +3,7 @@
 from datetime import datetime, timedelta
 import operator
 import nose
-
+import copy
 import numpy as np
 from numpy import nan
 import pandas as pd
@@ -866,6 +866,37 @@ class TestDataFrame(tm.TestCase, Generic):
         result = df.resample('1T')
         self.check_metadata(df,result)
 
+        # merging with override
+        # GH 6923
+        _metadata = DataFrame._metadata
+        _finalize = DataFrame.__finalize__
+
+        np.random.seed(10)
+        df1 = DataFrame(np.random.randint(0, 4, (3, 2)), columns=['a', 'b'])
+        df2 = DataFrame(np.random.randint(0, 4, (3, 2)), columns=['c', 'd'])
+        DataFrame._metadata = ['filename']
+        df1.filename = 'fname1.csv'
+        df2.filename = 'fname2.csv'
+
+        def finalize(self, other, method=None, **kwargs):
+
+            for name in self._metadata:
+                if method == 'merge':
+                    left, right = other.left, other.right
+                    value = getattr(left, name, '') + '|' + getattr(right, name, '')
+                    object.__setattr__(self, name, value)
+                else:
+                    object.__setattr__(self, name, getattr(other, name, ''))
+
+            return self
+
+        DataFrame.__finalize__ = finalize
+        result = df1.merge(df2, left_on=['a'], right_on=['c'], how='inner')
+        self.assertEquals(result.filename,'fname1.csv|fname2.csv')
+
+        DataFrame._metadata = _metadata
+        DataFrame.__finalize__ = _finalize
+
 class TestPanel(tm.TestCase, Generic):
     _typ = Panel
     _comparator = lambda self, x, y: assert_panel_equal(x, y)
diff --git a/pandas/tools/merge.py b/pandas/tools/merge.py
index 90e713d72..42cea5101 100644
--- a/pandas/tools/merge.py
+++ b/pandas/tools/merge.py
@@ -195,7 +195,7 @@ class _MergeOperation(object):
                                       copy=self.copy)
 
         result_data = join_op.get_result()
-        result = DataFrame(result_data)
+        result = DataFrame(result_data).__finalize__(self, method='merge')
 
         self._maybe_add_join_keys(result, left_indexer, right_indexer)
 
