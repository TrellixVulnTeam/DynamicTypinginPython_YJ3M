commit a27a9f25e6d6979f4e136e31065cb1e260e94544
Author: Chang She <chang@lambdafoundry.com>
Date:   Sun May 6 22:28:25 2012 -0400

    ENH: parsing numbers with commas in read_csv/table/clipboard/fwf #796
    VB: read_csv with/without thousands separator parsing

diff --git a/pandas/io/parsers.py b/pandas/io/parsers.py
index 909eec9da..2206169df 100644
--- a/pandas/io/parsers.py
+++ b/pandas/io/parsers.py
@@ -53,6 +53,8 @@ date_parser : function
     dateutil.parser
 dayfirst : boolean, default False
     DD/MM format dates, international and European format
+thousands : str, default None
+    Thousands separator
 nrows : int, default None
     Number of rows of file to read. Useful for reading pieces of large files
 iterator : boolean, default False
@@ -176,6 +178,7 @@ def read_csv(filepath_or_buffer,
              names=None,
              skiprows=None,
              na_values=None,
+             thousands=None,
              parse_dates=False,
              dayfirst=False,
              date_parser=None,
@@ -204,6 +207,7 @@ def read_table(filepath_or_buffer,
                names=None,
                skiprows=None,
                na_values=None,
+               thousands=None,
                parse_dates=False,
                dayfirst=False,
                date_parser=None,
@@ -236,6 +240,7 @@ def read_fwf(filepath_or_buffer,
              names=None,
              skiprows=None,
              na_values=None,
+             thousands=None,
              parse_dates=False,
              dayfirst=False,
              date_parser=None,
@@ -265,10 +270,9 @@ def read_fwf(filepath_or_buffer,
             col += w
         kwds['colspecs'] = colspecs
 
+    kwds['thousands'] = thousands
     return _read(FixedWidthFieldParser, filepath_or_buffer, kwds)
 
-
-
 def read_clipboard(**kwargs):  # pragma: no cover
     """
     Read text from clipboard and pass to read_table. See read_table for the
@@ -346,7 +350,8 @@ class TextParser(object):
     """
 
     def __init__(self, f, delimiter=None, names=None, header=0,
-                 index_col=None, na_values=None, parse_dates=False,
+                 index_col=None, na_values=None, thousands=None,
+                 parse_dates=False,
                  date_parser=None, dayfirst=False, chunksize=None,
                  skiprows=None, skip_footer=0, converters=None,
                  verbose=False, encoding=None):
@@ -392,6 +397,8 @@ class TextParser(object):
         else:
             self.na_values = set(list(na_values)) | _NA_VALUES
 
+        self.thousands = thousands
+
         if hasattr(f, 'readline'):
             self._make_reader(f)
         else:
@@ -499,11 +506,31 @@ class TextParser(object):
                 next(self.data)
                 self.pos += 1
             line = next(self.data)
+
+        line = self._check_thousands([line])[0]
+
         self.pos += 1
         self.buf.append(line)
 
         return line
 
+    def _check_thousands(self, lines):
+        if self.thousands is None:
+            return lines
+        nonnum = re.compile('[^-^0-9^%s^.]+' % self.thousands)
+        ret = []
+        for l in lines:
+            rl = []
+            for x in l:
+                if (not isinstance(x, basestring) or
+                    self.thousands not in x or
+                    nonnum.search(x.strip())):
+                    rl.append(x)
+                else:
+                    rl.append(x.replace(',', ''))
+            ret.append(rl)
+        return ret
+
     def _clear_buffer(self):
         self.buf = []
 
@@ -703,7 +730,7 @@ class TextParser(object):
         if self.skip_footer:
             lines = lines[:-self.skip_footer]
 
-        return lines
+        return self._check_thousands(lines)
 
 def _convert_to_ndarrays(dct, na_values, verbose=False):
     def _get_na_values(col):
@@ -751,10 +778,11 @@ class FixedWidthReader(object):
     """
     A reader of fixed-width lines.
     """
-    def __init__(self, f, colspecs, filler):
+    def __init__(self, f, colspecs, filler, thousands=None):
         self.f = f
         self.colspecs = colspecs
         self.filler = filler # Empty characters between fields.
+        self.thousands = thousands
 
         assert isinstance(colspecs, (tuple, list))
         for colspec in colspecs:
@@ -768,7 +796,7 @@ class FixedWidthReader(object):
         # Note: 'colspecs' is a sequence of half-open intervals.
         return [line[fromm:to].strip(self.filler or ' ')
                 for (fromm, to) in self.colspecs]
-    
+
     # Iterator protocol in Python 3 uses __next__()
     __next__ = next
 
@@ -827,7 +855,7 @@ class ExcelFile(object):
 
     def parse(self, sheetname, header=0, skiprows=None, index_col=None,
               parse_dates=False, date_parser=None, na_values=None,
-              chunksize=None):
+              thousands=None, chunksize=None):
         """
         Read Excel table into DataFrame
 
@@ -855,11 +883,13 @@ class ExcelFile(object):
                                      skiprows=skiprows, index_col=index_col,
                                      parse_dates=parse_dates,
                                      date_parser=date_parser,
-                                     na_values=na_values, chunksize=chunksize)
+                                     na_values=na_values,
+                                     thousands=thousands,
+                                     chunksize=chunksize)
 
     def _parse_xlsx(self, sheetname, header=0, skiprows=None, index_col=None,
-              parse_dates=False, date_parser=None, na_values=None,
-              chunksize=None):
+                    parse_dates=False, date_parser=None, na_values=None,
+                    thousands=None, chunksize=None):
         sheet = self.book.get_sheet_by_name(name=sheetname)
         data = []
 
@@ -872,6 +902,7 @@ class ExcelFile(object):
 
         parser = TextParser(data, header=header, index_col=index_col,
                             na_values=na_values,
+                            thousands=thousands,
                             parse_dates=parse_dates,
                             date_parser=date_parser,
                             skiprows=skiprows,
@@ -880,8 +911,8 @@ class ExcelFile(object):
         return parser.get_chunk()
 
     def _parse_xls(self, sheetname, header=0, skiprows=None, index_col=None,
-              parse_dates=False, date_parser=None, na_values=None,
-              chunksize=None):
+                   parse_dates=False, date_parser=None, na_values=None,
+                   thousands=None, chunksize=None):
         from datetime import MINYEAR, time, datetime
         from xlrd import xldate_as_tuple, XL_CELL_DATE
 
@@ -907,6 +938,7 @@ class ExcelFile(object):
 
         parser = TextParser(data, header=header, index_col=index_col,
                             na_values=na_values,
+                            thousands=thousands,
                             parse_dates=parse_dates,
                             date_parser=date_parser,
                             skiprows=skiprows,
diff --git a/pandas/io/tests/test_parsers.py b/pandas/io/tests/test_parsers.py
index 3061779bf..07ff3eb6e 100644
--- a/pandas/io/tests/test_parsers.py
+++ b/pandas/io/tests/test_parsers.py
@@ -41,6 +41,31 @@ bar2,12,13,14,15
     def test_read_csv(self):
         pass
 
+    def test_1000_sep(self):
+        data = """A|B|C
+1|2,334.0|5
+10|13|10.
+"""
+        expected = [[1, 2334., 5],
+                    [10, 13, 10]]
+
+        df = read_csv(StringIO(data), sep='|', thousands=',')
+        assert_almost_equal(df.values, expected)
+
+        df = read_table(StringIO(data), sep='|', thousands=',')
+        assert_almost_equal(df.values, expected)
+
+    def test_1000_fwf(self):
+        data = """
+ 1 2,334.0    5
+10   13     10.
+"""
+        expected = [[1, 2334., 5],
+                    [10, 13, 10]]
+        df = read_fwf(StringIO(data), colspecs=[(0,3),(3,11),(12,16)],
+                      thousands=',')
+        assert_almost_equal(df.values, expected)
+
     def test_custom_na_values(self):
         data = """A,B,C
 ignore,this,row
diff --git a/vb_suite/frame_methods.py b/vb_suite/frame_methods.py
index b20bc5436..6a78b7d59 100644
--- a/vb_suite/frame_methods.py
+++ b/vb_suite/frame_methods.py
@@ -49,4 +49,4 @@ cols = cols[0:99]
 """
 
 frame_multiaxis_reindex = Benchmark('df.reindex(index=idx, columns=cols)',
-                                    setup)
+                                    setup, start_date=datetime(2012, 5, 6))
diff --git a/vb_suite/parser.py b/vb_suite/parser.py
new file mode 100644
index 000000000..298196e0b
--- /dev/null
+++ b/vb_suite/parser.py
@@ -0,0 +1,34 @@
+from vbench.api import Benchmark
+from datetime import datetime
+
+common_setup = """from pandas_vb_common import *
+"""
+
+setup = common_setup + """
+from pandas import read_csv
+import os
+N = 10000
+K = 8
+df = DataFrame(np.random.randn(N, K) * np.random.randint(100, 10000, (N, K)))
+df.to_csv('test.csv')
+"""
+
+read_csv_vb = Benchmark("read_csv('test.csv')", setup,
+                        cleanup="os.remove('test.csv')",
+                        start_date=datetime(2012, 5, 7))
+
+
+setup = common_setup + """
+from pandas import read_csv
+import os
+N = 10000
+K = 8
+format = lambda x: '{:,}'.format(x)
+df = DataFrame(np.random.randn(N, K) * np.random.randint(100, 10000, (N, K)))
+df = df.applymap(format)
+df.to_csv('test.csv', sep='|')
+"""
+
+read_csv_thou_vb = Benchmark("read_csv('test.csv')", setup,
+                             cleanup="os.remove('test.csv')",
+                             start_date=datetime(2012, 5, 7))
