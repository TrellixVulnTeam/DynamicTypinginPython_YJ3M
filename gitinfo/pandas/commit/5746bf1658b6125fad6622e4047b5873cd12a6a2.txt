commit 5746bf1658b6125fad6622e4047b5873cd12a6a2
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Fri May 25 14:36:53 2012 -0400

    BLD: fix numpy 1.6/1.7 datetime API problems

diff --git a/pandas/src/datetime.pyx b/pandas/src/datetime.pyx
index d1949317e..c0fdb4a00 100644
--- a/pandas/src/datetime.pyx
+++ b/pandas/src/datetime.pyx
@@ -26,6 +26,8 @@ PyDateTime_IMPORT
 # in numpy 1.7, will prob need the following:
 # numpy_pydatetime_import
 
+cdef bint numpy_16 = np.__version__ < '1.7'
+
 ctypedef enum time_res:
     r_min = 0
     r_microsecond
@@ -859,6 +861,13 @@ cdef inline _get_datetime64_nanos(object val):
         npy_datetime ival
 
     unit = get_datetime64_unit(val)
+    if numpy_16:
+        if unit == 4:
+            raise ValueError('NumPy 1.6.1 business freq not supported')
+
+        if unit > 4:
+            unit = <PANDAS_DATETIMEUNIT> ((<int>unit) - 1)
+
     ival = get_datetime64_value(val)
 
     if unit != PANDAS_FR_ns:
diff --git a/pandas/src/np_datetime.h b/pandas/src/np_datetime.h
index 0fbf74547..c3009625a 100644
--- a/pandas/src/np_datetime.h
+++ b/pandas/src/np_datetime.h
@@ -6,12 +6,13 @@
 #ifndef _PANDAS_DATETIME_H_
 #define _PANDAS_DATETIME_H_
 
+#include <numpy/ndarraytypes.h>
+
 typedef enum {
         PANDAS_FR_Y, /* Years */
         PANDAS_FR_M, /* Months */
         PANDAS_FR_W, /* Weeks */
         PANDAS_FR_D, /* Days */
-        PANDAS_FR_B, /* Business days */
         PANDAS_FR_h, /* hours */
         PANDAS_FR_m, /* minutes */
         PANDAS_FR_s, /* seconds */
@@ -21,9 +22,10 @@ typedef enum {
         PANDAS_FR_ps,/* picoseconds */
         PANDAS_FR_fs,/* femtoseconds */
         PANDAS_FR_as,/* attoseconds */
+        PANDAS_FR_GENERIC /* Generic, unbound units, can convert to anything */
 } PANDAS_DATETIMEUNIT;
 
-#define PANDAS_DATETIME_NUMUNITS 14
+#define PANDAS_DATETIME_NUMUNITS 13
 
 #define PANDAS_DATETIME_MAX_ISO8601_STRLEN (21+3*5+1+3*6+6+1)
 
@@ -46,7 +48,8 @@ int convert_pydatetime_to_datetimestruct(PyObject *obj, pandas_datetimestruct *o
                                          PANDAS_DATETIMEUNIT *out_bestunit,
                                          int apply_tzinfo);
 
-npy_datetime pandas_datetimestruct_to_datetime(PANDAS_DATETIMEUNIT fr, pandas_datetimestruct *d);
+npy_datetime pandas_datetimestruct_to_datetime(PANDAS_DATETIMEUNIT fr,
+                                               pandas_datetimestruct *d);
 
 void pandas_datetime_to_datetimestruct(npy_datetime val, PANDAS_DATETIMEUNIT fr,
                                        pandas_datetimestruct *result);
diff --git a/pandas/src/np_datetime_strings.c b/pandas/src/np_datetime_strings.c
index 15ea53493..857056427 100644
--- a/pandas/src/np_datetime_strings.c
+++ b/pandas/src/np_datetime_strings.c
@@ -62,7 +62,6 @@ static char *_datetime_strings[PANDAS_DATETIME_NUMUNITS] = {
     "M",
     "W",
     "D",
-    "B",
     "h",
     "m",
     "s",
@@ -943,7 +942,6 @@ get_datetime_iso_8601_strlen(int local, PANDAS_DATETIMEUNIT base)
         case PANDAS_FR_h:
             len += 3;  /* "T##" */
         case PANDAS_FR_D:
-        case PANDAS_FR_B:
         case PANDAS_FR_W:
             len += 3;  /* "-##" */
         case PANDAS_FR_M:
diff --git a/pandas/src/ujson/python/objToJSON.c b/pandas/src/ujson/python/objToJSON.c
index 8340436df..3bf99484a 100644
--- a/pandas/src/ujson/python/objToJSON.c
+++ b/pandas/src/ujson/python/objToJSON.c
@@ -1,5 +1,7 @@
-#include <Python.h>
+#include <py_defines.h>
+
 #define PY_ARRAY_UNIQUE_SYMBOL UJSON_NUMPY
+
 #include <numpy/arrayobject.h>
 #include <numpy/halffloat.h>
 #include <stdio.h>
