commit 940ea476f9af1a9c220887f6ac47b52dc97e5f3f
Author: Marc Garcia <garcia.marc@gmail.com>
Date:   Sun Nov 17 14:20:07 2019 +0000

    TST: Call tests just once with --dist=loadscope (#28531)

diff --git a/.travis.yml b/.travis.yml
index 398dd0708..048736e4b 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -85,15 +85,6 @@ install:
   - ci/submit_cython_cache.sh
   - echo "install done"
 
-
-before_script:
-  # display server (for clipboard functionality) needs to be started here,
-  # does not work if done in install:setup_env.sh (GH-26103)
-  - export DISPLAY=":99.0"
-  - echo "sh -e /etc/init.d/xvfb start"
-  - if [ "$JOB" != "3.8-dev" ]; then sh -e /etc/init.d/xvfb start; fi
-  - sleep 3
-
 script:
   - echo "script start"
   - echo "$JOB"
diff --git a/ci/azure/posix.yml b/ci/azure/posix.yml
index d6afb263b..66960ca2c 100644
--- a/ci/azure/posix.yml
+++ b/ci/azure/posix.yml
@@ -73,33 +73,16 @@ jobs:
 
     - task: PublishTestResults@2
       inputs:
-        testResultsFiles: 'test-data-*.xml'
+        testResultsFiles: 'test-data.xml'
         testRunTitle: ${{ format('{0}-$(CONDA_PY)', parameters.name) }}
       displayName: 'Publish test results'
 
     - powershell: |
-        $junitXml = "test-data-single.xml"
-        $(Get-Content $junitXml | Out-String) -match 'failures="(.*?)"'
-        if ($matches[1] -eq 0)
-        {
-          Write-Host "No test failures in test-data-single"
-        }
-        else
-        {
-          # note that this will produce $LASTEXITCODE=1
-          Write-Error "$($matches[1]) tests failed"
-        }
-
-        $junitXmlMulti = "test-data-multiple.xml"
-        $(Get-Content $junitXmlMulti | Out-String) -match 'failures="(.*?)"'
-        if ($matches[1] -eq 0)
-        {
-          Write-Host "No test failures in test-data-multi"
-        }
-        else
-        {
-          # note that this will produce $LASTEXITCODE=1
-          Write-Error "$($matches[1]) tests failed"
+        $(Get-Content "test-data.xml" | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0) {
+          Write-Host "No test failures in test-data"
+        } else {
+          Write-Error "$($matches[1]) tests failed"  # will produce $LASTEXITCODE=1
         }
       displayName: 'Check for test failures'
 
diff --git a/ci/print_skipped.py b/ci/print_skipped.py
index e99e789a7..51a2460e0 100755
--- a/ci/print_skipped.py
+++ b/ci/print_skipped.py
@@ -27,14 +27,13 @@ def main(filename):
 if __name__ == "__main__":
     print("SKIPPED TESTS:")
     i = 1
-    for file_type in ("-single", "-multiple", ""):
-        for test_data in main("test-data{}.xml".format(file_type)):
-            if test_data is None:
-                print("-" * 80)
-            else:
-                print(
-                    "#{i} {class_name}.{test_name}: {message}".format(
-                        **dict(test_data, i=i)
-                    )
+    for test_data in main("test-data.xml"):
+        if test_data is None:
+            print("-" * 80)
+        else:
+            print(
+                "#{i} {class_name}.{test_name}: {message}".format(
+                    **dict(test_data, i=i)
                 )
-                i += 1
+            )
+            i += 1
diff --git a/ci/run_tests.sh b/ci/run_tests.sh
index d1a9447c9..b91cfb3be 100755
--- a/ci/run_tests.sh
+++ b/ci/run_tests.sh
@@ -15,37 +15,29 @@ if [ -n "$LOCALE_OVERRIDE" ]; then
         # exit 1
     fi
 fi
+
 if [[ "not network" == *"$PATTERN"* ]]; then
     export http_proxy=http://1.2.3.4 https_proxy=http://1.2.3.4;
 fi
 
-
-if [ -n "$PATTERN" ]; then
-    PATTERN=" and $PATTERN"
+if [ "$COVERAGE" ]; then
+    COVERAGE_FNAME="/tmp/test_coverage.xml"
+    COVERAGE="-s --cov=pandas --cov-report=xml:$COVERAGE_FNAME"
 fi
 
-for TYPE in single multiple
-do
-    if [ "$COVERAGE" ]; then
-        COVERAGE_FNAME="/tmp/coc-$TYPE.xml"
-        COVERAGE="-s --cov=pandas --cov-report=xml:$COVERAGE_FNAME"
-    fi
+PYTEST_CMD="pytest -m \"$PATTERN\" -n auto --dist=loadfile -s --strict --durations=10 --junitxml=test-data.xml $TEST_ARGS $COVERAGE pandas"
 
-    TYPE_PATTERN=$TYPE
-    NUM_JOBS=1
-    if [[ "$TYPE_PATTERN" == "multiple" ]]; then
-        TYPE_PATTERN="not single"
-        NUM_JOBS=2
-    fi
+# Travis does not have have an X server
+if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then
+    DISPLAY=DISPLAY=:99.0
+    PYTEST_CMD="xvfb-run -e /dev/stdout $PYTEST_CMD"
+fi
 
-    PYTEST_CMD="pytest -m \"$TYPE_PATTERN$PATTERN\" -n $NUM_JOBS -s --strict --durations=10 --junitxml=test-data-$TYPE.xml $TEST_ARGS $COVERAGE pandas"
-    echo $PYTEST_CMD
-    # if no tests are found (the case of "single and slow"), pytest exits with code 5, and would make the script fail, if not for the below code
-    sh -c "$PYTEST_CMD; ret=\$?; [ \$ret = 5 ] && exit 0 || exit \$ret"
+echo $PYTEST_CMD
+sh -c "$PYTEST_CMD"
 
-    if [[ "$COVERAGE" && $? == 0 && "$TRAVIS_BRANCH" == "master" ]]; then
-        echo "uploading coverage for $TYPE tests"
-        echo "bash <(curl -s https://codecov.io/bash) -Z -c -F $TYPE -f $COVERAGE_FNAME"
-              bash <(curl -s https://codecov.io/bash) -Z -c -F $TYPE -f $COVERAGE_FNAME
-    fi
-done
+if [[ "$COVERAGE" && $? == 0 && "$TRAVIS_BRANCH" == "master" ]]; then
+    echo "uploading coverage"
+    echo "bash <(curl -s https://codecov.io/bash) -Z -c -F $TYPE -f $COVERAGE_FNAME"
+          bash <(curl -s https://codecov.io/bash) -Z -c -F $TYPE -f $COVERAGE_FNAME
+fi
diff --git a/environment.yml b/environment.yml
index a3582c56e..bbf3c036f 100644
--- a/environment.yml
+++ b/environment.yml
@@ -53,7 +53,7 @@ dependencies:
   - moto  # mock S3
   - pytest>=4.0.2
   - pytest-cov
-  - pytest-xdist
+  - pytest-xdist>=1.21
   - seaborn
   - statsmodels
 
diff --git a/requirements-dev.txt b/requirements-dev.txt
index 6235b61d9..5633a58f2 100644
--- a/requirements-dev.txt
+++ b/requirements-dev.txt
@@ -32,7 +32,7 @@ hypothesis>=3.82
 moto
 pytest>=4.0.2
 pytest-cov
-pytest-xdist
+pytest-xdist>=1.21
 seaborn
 statsmodels
 ipywidgets
