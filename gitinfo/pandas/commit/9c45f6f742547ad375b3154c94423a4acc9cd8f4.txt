commit 9c45f6f742547ad375b3154c94423a4acc9cd8f4
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Tue Sep 20 11:38:11 2011 -0400

    BUG: pivot should raise exception if there are duplicate entries,
    address GH #147

diff --git a/RELEASE.rst b/RELEASE.rst
index b293dda62..0e8a7635a 100644
--- a/RELEASE.rst
+++ b/RELEASE.rst
@@ -1,10 +1,28 @@
-========================
-pandas 0.4 Release Notes
-========================
+=============
+Release Notes
+=============
 
-What is it
+This is the list of changes to pandas between each release. For full details,
+see the commit logs at http://github.com/wesm/pandas
+
+
+pandas 0.4.1
+============
+
+**Release date:** Not yet released
+
+This is a bug fix release
+
+**Bug fixes**
+
+  -
+
+pandas 0.4
 ==========
 
+What is it
+----------
+
 **pandas** is a library of powerful labeled-axis data structures, statistical
 tools, and general code for working with relational data sets, including time
 series and cross-sectional data. It was designed with the practical needs of
@@ -13,14 +31,14 @@ particularly well suited for, among other things, financial data analysis
 applications.
 
 Where to get it
-===============
+---------------
 
 Source code: http://github.com/wesm/pandas
 Binary installers on PyPI: http://pypi.python.org/pypi/pandas
 Documentation: http://pandas.sourceforge.net
 
 Release notes
-=============
+-------------
 
 **Release date:** 9/12/2011
 
@@ -279,12 +297,8 @@ Thanks
   - Skipper Seabold
   - Chris Jordan-Squire
 
-========================
-pandas 0.3 Release Notes
-========================
-
-Release Notes
-=============
+pandas 0.3
+==========
 
 This major release of pandas represents approximately 1 year of continuous
 development work and brings with it many new features, bug fixes, speed
@@ -293,7 +307,7 @@ change from the 0.2 release has been the completion of a rigorous unit test
 suite covering all of the core functionality.
 
 What is it
-==========
+----------
 
 **pandas** is a library of labeled data structures, statistical models, and
 general code for working with time series and cross-sectional data. It was
@@ -301,14 +315,14 @@ designed with the practical needs of statistical modeling and large,
 inhomogeneous data sets in mind.
 
 Where to get it
-===============
+---------------
 
 Source code: http://github.com/wesm/pandas
 Binary installers on PyPI: http://pypi.python.org/pypi/pandas
 Documentation: http://pandas.sourceforge.net
 
 Release notes
-=============
+-------------
 
 **Release date:** February 20, 2011
 
diff --git a/pandas/core/reshape.py b/pandas/core/reshape.py
index 2952a71e8..5e17ecbb7 100644
--- a/pandas/core/reshape.py
+++ b/pandas/core/reshape.py
@@ -11,6 +11,10 @@ from pandas.core.series import Series
 from pandas.core.common import notnull
 from pandas.core.index import MultiIndex
 
+class ReshapeError(Exception):
+    pass
+
+
 class _Unstacker(object):
     """
     Helper class to unstack data / pivot with multi-level index
@@ -88,7 +92,8 @@ class _Unstacker(object):
 
         # make the mask
         group_index = self.sorted_labels[0]
-        prev_stride = np.prod([len(x) for x in new_levels[1:]])
+        prev_stride = np.prod([len(x) for x in new_levels[1:]],
+                              dtype=int)
 
         for lev, lab in zip(new_levels[1:], self.sorted_labels[1:-1]):
             group_index = group_index * prev_stride + lab
@@ -106,6 +111,10 @@ class _Unstacker(object):
         unique_groups = np.arange(self.full_shape[0])[group_mask]
         compressor = group_index.searchsorted(unique_groups)
 
+        if mask.sum() < len(self.index):
+            raise ReshapeError('Index contains duplicate entries, '
+                               'cannot reshape')
+
         self.group_mask = group_mask
         self.group_index = group_index
         self.mask = mask
@@ -192,10 +201,6 @@ def pivot(self, index=None, columns=None, values=None):
     index_vals = self[index]
     column_vals = self[columns]
     mindex = MultiIndex.from_arrays([index_vals, column_vals])
-    try:
-        mindex._verify_integrity()
-    except Exception:
-        raise Exception('duplicate index/column pairs!')
 
     if values is None:
         items = self.columns - [index, columns]
diff --git a/pandas/tests/test_frame.py b/pandas/tests/test_frame.py
index 0d4b12cff..8e37a6dac 100644
--- a/pandas/tests/test_frame.py
+++ b/pandas/tests/test_frame.py
@@ -1820,6 +1820,17 @@ class TestDataFrame(unittest.TestCase, CheckIndexing):
         df = DataFrame.from_records(lp.toRecords())
         assert_frame_equal(df.pivot('major', 'minor'), lp.unstack())
 
+    def test_pivot_duplicates(self):
+        data = DataFrame({'a' : ['bar', 'bar', 'foo', 'foo', 'foo'],
+                          'b' : ['one', 'two', 'one', 'one', 'two'],
+                          'c' : [1., 2., 3., 3., 4.]})
+        # expected = DataFrame([[1., 2.], [3., 4.]], index=['bar', 'foo'],
+        #                      columns=['one', 'two'])
+        # result = data.pivot('a', 'b', 'c')
+        # assert_frame_equal(result, expected)
+
+        self.assertRaises(Exception, data.pivot, 'a', 'b', 'c')
+
     def test_reindex(self):
         newFrame = self.frame.reindex(self.ts1.index)
 
diff --git a/pandas/tests/test_panel.py b/pandas/tests/test_panel.py
index 31421aacc..6aff1791d 100644
--- a/pandas/tests/test_panel.py
+++ b/pandas/tests/test_panel.py
@@ -1120,9 +1120,10 @@ class TestLongPanel(unittest.TestCase):
         a, b, c = (np.array([1, 2, 3, 4, 4]),
                    np.array(['a', 'a', 'a', 'a', 'a']),
                    np.array([1., 2., 3., 4., 5.]))
-        df = pivot(a, b, c)
-        expected = _slow_pivot(a, b, c)
-        assert_frame_equal(df, expected)
+        self.assertRaises(Exception, pivot, a, b, c)
+        # df = pivot(a, b, c)
+        # expected = _slow_pivot(a, b, c)
+        # assert_frame_equal(df, expected)
 
         # corner case, empty
         df = pivot(np.array([]), np.array([]), np.array([]))
diff --git a/pandas/version.py b/pandas/version.py
index 9baf1668d..b47afe3ed 100644
--- a/pandas/version.py
+++ b/pandas/version.py
@@ -1 +1 @@
-version = '0.4.0'
+version = '0.4.1.dev-877e596'
