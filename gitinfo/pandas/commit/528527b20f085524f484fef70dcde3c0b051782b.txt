commit 528527b20f085524f484fef70dcde3c0b051782b
Author: alimcmaster1 <alimcmaster1@gmail.com>
Date:   Wed Nov 7 02:02:58 2018 +0000

    CI: Fail Azure CI for failing tests (#23454)

diff --git a/ci/azure/linux.yml b/ci/azure/linux.yml
index 1f62c30f6..b5a8e36d5 100644
--- a/ci/azure/linux.yml
+++ b/ci/azure/linux.yml
@@ -54,3 +54,28 @@ jobs:
       inputs:
         testResultsFiles: 'test-data-*.xml'
         testRunTitle: 'Linux'
+    - powershell: |
+        $junitXml = "test-data-single.xml"
+        $(Get-Content $junitXml | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0)
+        {
+          Write-Host "No test failures in test-data-single"
+        }
+        else
+        {
+          # note that this will produce $LASTEXITCODE=1
+          Write-Error "$($matches[1]) tests failed"
+        }
+
+        $junitXmlMulti = "test-data-multiple.xml"
+        $(Get-Content $junitXmlMulti | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0)
+        {
+          Write-Host "No test failures in test-data-multi"
+        }
+        else
+        {
+          # note that this will produce $LASTEXITCODE=1
+          Write-Error "$($matches[1]) tests failed"
+        }
+      displayName: Check for test failures
diff --git a/ci/azure/macos.yml b/ci/azure/macos.yml
index 1a44933b7..16f2fa2d4 100644
--- a/ci/azure/macos.yml
+++ b/ci/azure/macos.yml
@@ -41,3 +41,28 @@ jobs:
       inputs:
         testResultsFiles: 'test-data-*.xml'
         testRunTitle: 'MacOS-35'
+    - powershell: |
+        $junitXml = "test-data-single.xml"
+        $(Get-Content $junitXml | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0)
+        {
+          Write-Host "No test failures in test-data-single"
+        }
+        else
+        {
+          # note that this will produce $LASTEXITCODE=1
+          Write-Error "$($matches[1]) tests failed"
+        }
+
+        $junitXmlMulti = "test-data-multiple.xml"
+        $(Get-Content $junitXmlMulti | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0)
+        {
+          Write-Host "No test failures in test-data-multi"
+        }
+        else
+        {
+          # note that this will produce $LASTEXITCODE=1
+          Write-Error "$($matches[1]) tests failed"
+        }
+      displayName: Check for test failures
\ No newline at end of file
diff --git a/ci/azure/windows-py27.yml b/ci/azure/windows-py27.yml
index 1f82bda59..fd72b7080 100644
--- a/ci/azure/windows-py27.yml
+++ b/ci/azure/windows-py27.yml
@@ -43,3 +43,16 @@ jobs:
       inputs:
         testResultsFiles: 'test-data.xml'
         testRunTitle: 'Windows 27'
+    - powershell: |
+        $junitXml = "test-data.xml"
+        $(Get-Content $junitXml | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0)
+        {
+          Write-Host "No test failures in test-data"
+        }
+        else
+        {
+          # note that this will produce $LASTEXITCODE=1
+          Write-Error "$($matches[1]) tests failed"
+        }
+      displayName: Check for test failures
diff --git a/ci/azure/windows.yml b/ci/azure/windows.yml
index 74235fc64..9b87ac771 100644
--- a/ci/azure/windows.yml
+++ b/ci/azure/windows.yml
@@ -34,3 +34,16 @@ jobs:
       inputs:
         testResultsFiles: 'test-data.xml'
         testRunTitle: 'Windows 36'
+    - powershell: |
+        $junitXml = "test-data.xml"
+        $(Get-Content $junitXml | Out-String) -match 'failures="(.*?)"'
+        if ($matches[1] -eq 0)
+        {
+          Write-Host "No test failures in test-data"
+        }
+        else
+        {
+          # note that this will produce $LASTEXITCODE=1
+          Write-Error "$($matches[1]) tests failed"
+        }
+      displayName: Check for test failures
\ No newline at end of file
diff --git a/ci/deps/azure-macos-35.yaml b/ci/deps/azure-macos-35.yaml
index 065deb914..6ccdc79d1 100644
--- a/ci/deps/azure-macos-35.yaml
+++ b/ci/deps/azure-macos-35.yaml
@@ -12,7 +12,7 @@ dependencies:
   - nomkl
   - numexpr
   - numpy=1.12.0
-  - openpyxl
+  - openpyxl=2.5.5
   - pytables
   - python=3.5*
   - pytz
