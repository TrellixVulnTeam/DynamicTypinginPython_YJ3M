commit 9020b9e2ecf6b551fe3d2a4615d83d719e5e216d
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Sat May 19 15:17:49 2012 -0400

    TST: more careful check for malformed BlockManager, close #815

diff --git a/pandas/core/internals.py b/pandas/core/internals.py
index c4e4d810f..617c4113d 100644
--- a/pandas/core/internals.py
+++ b/pandas/core/internals.py
@@ -499,6 +499,7 @@ class BlockManager(object):
         _union_block_items(self.blocks)
         mgr_shape = self.shape
         for block in self.blocks:
+            assert(block.ref_items is self.items)
             assert(block.values.shape[1:] == mgr_shape[1:])
         tot_items = sum(len(x.items) for x in self.blocks)
         assert(len(self.items) == tot_items)
@@ -575,6 +576,8 @@ class BlockManager(object):
     def from_blocks(cls, blocks, index):
         # also checks for overlap
         items = _union_block_items(blocks)
+        for blk in blocks:
+            blk.ref_items = items
         return BlockManager(blocks, [items, index])
 
     def __contains__(self, item):
@@ -911,6 +914,7 @@ class BlockManager(object):
                 if copy:
                     new_blocks.append(blk.reindex_items_from(new_items))
                 else:
+                    blk.ref_items = new_items
                     new_blocks.append(blk)
         else:
             for block in self.blocks:
diff --git a/pandas/io/pytables.py b/pandas/io/pytables.py
index b8724e854..b1f748a28 100644
--- a/pandas/io/pytables.py
+++ b/pandas/io/pytables.py
@@ -860,7 +860,7 @@ class HDFStore(object):
             block = block2d_to_block3d(sorted_values, fields, (J, K),
                                        major_labels, minor_labels)
 
-            mgr = BlockManager([block], [block.items,
+            mgr = BlockManager([block], [block.ref_items,
                                          major.levels, minor.levels])
             wp = Panel(mgr)
         else:
diff --git a/pandas/tools/merge.py b/pandas/tools/merge.py
index eaf833f47..16a337d47 100644
--- a/pandas/tools/merge.py
+++ b/pandas/tools/merge.py
@@ -924,6 +924,9 @@ class _Concatenator(object):
             if self.axis == 0 and self.ignore_index:
                 self.new_axes[0] = self._get_fresh_axis()
 
+            for blk in new_blocks:
+                blk.ref_items = self.new_axes[0]
+
             new_data = BlockManager(new_blocks, self.new_axes)
         except Exception:  # EAFP
             # should not be possible to fail here for the expected reason with
@@ -1028,12 +1031,12 @@ class _Concatenator(object):
         ndim = self._get_result_dim()
         new_axes = [None] * ndim
 
-        if self.ignore_index:
-            concat_axis = None
-        else:
-            concat_axis = self._get_concat_axis()
+        # if self.ignore_index:
+        #     concat_axis = None
+        # else:
+        #     concat_axis = self._get_concat_axis()
 
-        new_axes[self.axis] = concat_axis
+        # new_axes[self.axis] = concat_axis
 
         if self.join_axes is None:
             for i in range(ndim):
@@ -1050,6 +1053,13 @@ class _Concatenator(object):
             for i, ax in zip(indices, self.join_axes):
                 new_axes[i] = ax
 
+        if self.ignore_index:
+            concat_axis = None
+        else:
+            concat_axis = self._get_concat_axis()
+
+        new_axes[self.axis] = concat_axis
+
         return new_axes
 
     def _get_comb_axis(self, i):
