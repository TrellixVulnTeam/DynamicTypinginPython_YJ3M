commit 4f49001bc904df5897e80ddf4101c14d3e27c8e0
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Mon Jul 9 15:38:28 2012 -0400

    BUG: check for errors / clear errors inside khash with PyObject* close #1318

diff --git a/RELEASE.rst b/RELEASE.rst
index 25ebda239..a4c0e989c 100644
--- a/RELEASE.rst
+++ b/RELEASE.rst
@@ -22,6 +22,16 @@ Where to get it
 * Binary installers on PyPI: http://pypi.python.org/pypi/pandas
 * Documentation: http://pandas.pydata.org
 
+pandas 0.8.1
+============
+
+**Release date:** NOT YET RELEASED
+
+**Bug fixes**
+
+  - Handle TypeError issues inside PyObject_RichCompareBool calls in khash
+    (#1318)
+
 pandas 0.8.0
 ============
 
diff --git a/pandas/core/groupby.py b/pandas/core/groupby.py
index c5889692a..5acec9b3e 100644
--- a/pandas/core/groupby.py
+++ b/pandas/core/groupby.py
@@ -2,8 +2,7 @@ from itertools import izip
 import types
 import numpy as np
 
-from pandas.core.algorithms import unique
-from pandas.core.categorical import Factor
+from pandas.core.categorical import Categorical
 from pandas.core.frame import DataFrame
 from pandas.core.generic import NDFrame
 from pandas.core.index import Index, MultiIndex, _ensure_index
@@ -971,7 +970,7 @@ class Grouping(object):
         else:
             if isinstance(self.grouper, (list, tuple)):
                 self.grouper = com._asarray_tuplesafe(self.grouper)
-            elif isinstance(self.grouper, Factor):
+            elif isinstance(self.grouper, Categorical):
                 factor = self.grouper
                 self._was_factor = True
 
diff --git a/pandas/src/khash.h b/pandas/src/khash.h
index ac08587ba..df76dcc1c 100644
--- a/pandas/src/khash.h
+++ b/pandas/src/khash.h
@@ -574,21 +574,33 @@ typedef const char *kh_cstr_t;
 
 #include <Python.h>
 
+int PANDAS_INLINE pyobject_cmp(PyObject* a, PyObject* b) {
+	int result = PyObject_RichCompareBool(a, b, Py_EQ);
+	if (result < 0) {
+		PyErr_Clear();
+		return 0;
+	}
+	return result;
+}
+
+
 #define kh_python_hash_func(key) (PyObject_Hash(key))
-#define kh_python_hash_equal(a, b) ((a == b) || PyObject_RichCompareBool(a, b, Py_EQ))
+#define kh_python_hash_equal(a, b) (pyobject_cmp(a, b))
 
 
 // Python object
 
 typedef PyObject* kh_pyobject_t;
 
-#define KHASH_MAP_INIT_PYOBJECT(name, khval_t)                                  \
-	KHASH_INIT(name, kh_pyobject_t, khval_t, 1, kh_python_hash_func, kh_python_hash_equal)
+#define KHASH_MAP_INIT_PYOBJECT(name, khval_t)							\
+	KHASH_INIT(name, kh_pyobject_t, khval_t, 1,						\
+			   kh_python_hash_func, kh_python_hash_equal)
 
 KHASH_MAP_INIT_PYOBJECT(pymap, Py_ssize_t)
 
 #define KHASH_SET_INIT_PYOBJECT(name)                                  \
-	KHASH_INIT(name, kh_pyobject_t, char, 0, kh_python_hash_func, kh_python_hash_equal)
+	KHASH_INIT(name, kh_pyobject_t, char, 0,     \
+			   kh_python_hash_func, kh_python_hash_equal)
 
 KHASH_SET_INIT_PYOBJECT(pyset)
 
