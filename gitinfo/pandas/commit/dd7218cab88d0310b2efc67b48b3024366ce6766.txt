commit dd7218cab88d0310b2efc67b48b3024366ce6766
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Mon Dec 10 14:29:27 2012 -0500

    BUG: don't segfault in tokenizer cleanup if initializing file reader failed. close #2474

diff --git a/pandas/io/tests/test_parsers.py b/pandas/io/tests/test_parsers.py
index ccf5d8582..bc95f8113 100644
--- a/pandas/io/tests/test_parsers.py
+++ b/pandas/io/tests/test_parsers.py
@@ -1828,6 +1828,9 @@ a,b,c
 
             result = self.read_csv('__tmp__', compression='bz2')
             tm.assert_frame_equal(result, expected)
+
+            self.assertRaises(ValueError, self.read_csv,
+                              '__tmp__', compression='bz3')
         finally:
             try:
                 os.remove('__tmp__')
diff --git a/pandas/src/parser.pyx b/pandas/src/parser.pyx
index b06cc9244..325eb55a4 100644
--- a/pandas/src/parser.pyx
+++ b/pandas/src/parser.pyx
@@ -463,6 +463,9 @@ cdef class TextReader:
             int status
             void *ptr
 
+        self.parser.cb_io = NULL
+        self.parser.cb_cleanup = NULL
+
         if isinstance(source, basestring) and self.compression:
             if self.compression == 'gzip':
                 import gzip
diff --git a/pandas/src/parser/tokenizer.c b/pandas/src/parser/tokenizer.c
index 97b107ca4..1936760b6 100644
--- a/pandas/src/parser/tokenizer.c
+++ b/pandas/src/parser/tokenizer.c
@@ -179,6 +179,10 @@ int parser_clear_data_buffers(parser_t *self) {
 }
 
 int parser_cleanup(parser_t *self) {
+    if (self->cb_cleanup == NULL) {
+        return 0;
+    }
+
     if (self->cb_cleanup(self->source) < 0) {
         return -1;
     }
