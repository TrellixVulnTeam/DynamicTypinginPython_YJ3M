commit a9bf1fd278d98fff317474e67420d002519c1894
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Tue Jan 3 23:00:40 2012 -0500

    BUG: bug in many-to-one join in left_join cython routine

diff --git a/pandas/src/generate_code.py b/pandas/src/generate_code.py
index 7f4426455..6e0299ca4 100644
--- a/pandas/src/generate_code.py
+++ b/pandas/src/generate_code.py
@@ -354,6 +354,8 @@ def arrmap_%(name)s(ndarray[%(c_type)s] index, object func):
 #----------------------------------------------------------------------
 # Joins on ordered, unique indices
 
+# right might contain non-unique values
+
 left_join_template = """@cython.wraparound(False)
 @cython.boundscheck(False)
 def left_join_indexer_%(name)s(ndarray[%(c_type)s] left,
@@ -378,17 +380,20 @@ def left_join_indexer_%(name)s(ndarray[%(c_type)s] left,
             i += 1
             continue
 
-        lval = left[i]
         rval = right[j]
 
-        if lval == rval:
+        while i < nleft - 1 and left[i] == rval:
+            indexer[i] = j
+            i += 1
+
+        if left[i] == right[j]:
             indexer[i] = j
             i += 1
             while i < nleft - 1 and left[i] == rval:
                 indexer[i] = j
                 i += 1
             j += 1
-        elif lval > rval:
+        elif left[i] > rval:
             indexer[i] = -1
             j += 1
         else:
diff --git a/pandas/src/generated.pyx b/pandas/src/generated.pyx
index 299a308b0..1ffe76732 100644
--- a/pandas/src/generated.pyx
+++ b/pandas/src/generated.pyx
@@ -1427,17 +1427,20 @@ def left_join_indexer_float64(ndarray[float64_t] left,
             i += 1
             continue
 
-        lval = left[i]
         rval = right[j]
 
-        if lval == rval:
+        while i < nleft - 1 and left[i] == rval:
+            indexer[i] = j
+            i += 1
+
+        if left[i] == right[j]:
             indexer[i] = j
             i += 1
             while i < nleft - 1 and left[i] == rval:
                 indexer[i] = j
                 i += 1
             j += 1
-        elif lval > rval:
+        elif left[i] > rval:
             indexer[i] = -1
             j += 1
         else:
@@ -1469,17 +1472,20 @@ def left_join_indexer_object(ndarray[object] left,
             i += 1
             continue
 
-        lval = left[i]
         rval = right[j]
 
-        if lval == rval:
+        while i < nleft - 1 and left[i] == rval:
+            indexer[i] = j
+            i += 1
+
+        if left[i] == right[j]:
             indexer[i] = j
             i += 1
             while i < nleft - 1 and left[i] == rval:
                 indexer[i] = j
                 i += 1
             j += 1
-        elif lval > rval:
+        elif left[i] > rval:
             indexer[i] = -1
             j += 1
         else:
@@ -1511,17 +1517,20 @@ def left_join_indexer_int32(ndarray[int32_t] left,
             i += 1
             continue
 
-        lval = left[i]
         rval = right[j]
 
-        if lval == rval:
+        while i < nleft - 1 and left[i] == rval:
+            indexer[i] = j
+            i += 1
+
+        if left[i] == right[j]:
             indexer[i] = j
             i += 1
             while i < nleft - 1 and left[i] == rval:
                 indexer[i] = j
                 i += 1
             j += 1
-        elif lval > rval:
+        elif left[i] > rval:
             indexer[i] = -1
             j += 1
         else:
@@ -1553,17 +1562,20 @@ def left_join_indexer_int64(ndarray[int64_t] left,
             i += 1
             continue
 
-        lval = left[i]
         rval = right[j]
 
-        if lval == rval:
+        while i < nleft - 1 and left[i] == rval:
+            indexer[i] = j
+            i += 1
+
+        if left[i] == right[j]:
             indexer[i] = j
             i += 1
             while i < nleft - 1 and left[i] == rval:
                 indexer[i] = j
                 i += 1
             j += 1
-        elif lval > rval:
+        elif left[i] > rval:
             indexer[i] = -1
             j += 1
         else:
diff --git a/pandas/tests/test_tseries.py b/pandas/tests/test_tseries.py
index c068b90e0..109ae3d5e 100644
--- a/pandas/tests/test_tseries.py
+++ b/pandas/tests/test_tseries.py
@@ -72,6 +72,14 @@ class TestTseriesUtil(unittest.TestCase):
         expect_filler = [-1, -1, -1, -1, -1]
         self.assert_(np.array_equal(filler, expect_filler))
 
+def test_left_join_indexer():
+    a = np.array([1, 2, 3, 4, 5], dtype=np.int64)
+    b = np.array([2, 2, 3, 4, 4], dtype=np.int64)
+
+    result = lib.left_join_indexer_int64(b, a)
+    expected = np.array([1, 1, 2, 3, 3], dtype='i4')
+    assert(np.array_equal(result, expected))
+
 def test_inner_join_indexer():
     a = np.array([1, 2, 3, 4, 5], dtype=np.int64)
     b = np.array([0, 3, 5, 7, 9], dtype=np.int64)
