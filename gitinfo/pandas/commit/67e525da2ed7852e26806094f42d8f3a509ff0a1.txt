commit 67e525da2ed7852e26806094f42d8f3a509ff0a1
Author: jreback <jeff@reback.net>
Date:   Fri May 16 09:24:12 2014 -0400

    COMPAT/BUG: compat with pytz 2014.3, exposing several test that don't localize
                properly (GH7137)

diff --git a/pandas/tests/test_series.py b/pandas/tests/test_series.py
index c0a3c9320..eee0c699b 100644
--- a/pandas/tests/test_series.py
+++ b/pandas/tests/test_series.py
@@ -4589,8 +4589,11 @@ class TestSeries(tm.TestCase, CheckNameIntegration):
         assert_series_equal(result, ts)
 
         result = ts.copy()
-        result[datetime(1990, 1, 1, 3, tzinfo=tz('US/Central'))] = 0
-        result[datetime(1990, 1, 1, 3, tzinfo=tz('US/Central'))] = ts[4]
+
+        # comparison dates with datetime MUST be localized!
+        date = tz('US/Central').localize(datetime(1990, 1, 1, 3))
+        result[date] = 0
+        result[date] = ts[4]
         assert_series_equal(result, ts)
 
     def test_getitem_setitem_periodindex(self):
diff --git a/pandas/tseries/index.py b/pandas/tseries/index.py
index 61285528a..c1a22f547 100644
--- a/pandas/tseries/index.py
+++ b/pandas/tseries/index.py
@@ -257,7 +257,7 @@ class DatetimeIndex(Int64Index):
 
             if lib.is_string_array(values):
                 subarr = _str_to_dt_array(values, freq, dayfirst=dayfirst,
-                                        yearfirst=yearfirst)          
+                                        yearfirst=yearfirst)
             else:
                 try:
                     subarr = tools.to_datetime(data, box=False)
@@ -350,7 +350,9 @@ class DatetimeIndex(Int64Index):
                              'different timezones')
 
         inferred_tz = tools._maybe_get_tz(inferred_tz)
-        tz = tools._maybe_get_tz(tz)
+
+        # these may need to be localized
+        tz = tools._maybe_get_tz(tz, start or end)
 
         if tz is not None and inferred_tz is not None:
             if not inferred_tz == tz:
diff --git a/pandas/tseries/tests/test_timezones.py b/pandas/tseries/tests/test_timezones.py
index cc976488c..f70cf65f3 100644
--- a/pandas/tseries/tests/test_timezones.py
+++ b/pandas/tseries/tests/test_timezones.py
@@ -317,8 +317,11 @@ class TestTimeZoneSupport(tm.TestCase):
 
         # normalized
         central = dr.tz_convert(tz)
+
+        # compare vs a localized tz
+        comp = tz.localize(dr[0].to_pydatetime().replace(tzinfo=None)).tzinfo
         self.assertIs(central.tz, tz)
-        self.assertIs(central[0].tz, tz)
+        self.assertIs(central[0].tz, comp)
 
         # datetimes with tzinfo set
         dr = bdate_range(datetime(2005, 1, 1, tzinfo=pytz.utc),
@@ -393,9 +396,9 @@ class TestTimeZoneSupport(tm.TestCase):
 
         start = eastern.localize(_start)
         end = eastern.localize(_end)
-        assert(tools._infer_tzinfo(start, end) is eastern)
-        assert(tools._infer_tzinfo(start, None) is eastern)
-        assert(tools._infer_tzinfo(None, end) is eastern)
+        assert(tools._infer_tzinfo(start, end) is eastern.localize(_start).tzinfo)
+        assert(tools._infer_tzinfo(start, None) is eastern.localize(_start).tzinfo)
+        assert(tools._infer_tzinfo(None, end) is eastern.localize(_end).tzinfo)
 
         start = utc.localize(_start)
         end = utc.localize(_end)
@@ -643,8 +646,7 @@ class TestTimeZoneSupport(tm.TestCase):
                            tz='Europe/Berlin')
         ts = Series(index=index, data=index.hour)
         time_pandas = Timestamp('2012-12-24 17:00', tz='Europe/Berlin')
-        time_datetime = datetime(2012, 12, 24, 17, 0,
-                                 tzinfo=pytz.timezone('Europe/Berlin'))
+        time_datetime = pytz.timezone('Europe/Berlin').localize(datetime(2012, 12, 24, 17, 0))
         self.assertEqual(ts[time_pandas], ts[time_datetime])
 
     def test_index_drop_dont_lose_tz(self):
@@ -974,7 +976,7 @@ class TestTimeZones(tm.TestCase):
                 self.assert_(offset.equals(expected))
             offset = dates + timedelta(hours=5)
             self.assert_(offset.equals(expected))
-            
+
     def test_nat(self):
         # GH 5546
         dates = [NaT]
diff --git a/pandas/tseries/tools.py b/pandas/tseries/tools.py
index d01ad5616..4260705ea 100644
--- a/pandas/tseries/tools.py
+++ b/pandas/tseries/tools.py
@@ -56,13 +56,19 @@ def _infer_tzinfo(start, end):
     return tz
 
 
-def _maybe_get_tz(tz):
+def _maybe_get_tz(tz, date=None):
     if isinstance(tz, compat.string_types):
         import pytz
         tz = pytz.timezone(tz)
     if com.is_integer(tz):
         import pytz
         tz = pytz.FixedOffset(tz / 60)
+
+    # localize and get the tz
+    if date is not None and tz is not None:
+        if date.tzinfo is not None and hasattr(tz,'localize'):
+            tz = tz.localize(date.replace(tzinfo=None)).tzinfo
+
     return tz
 
 def _guess_datetime_format(dt_str, dayfirst=False,
