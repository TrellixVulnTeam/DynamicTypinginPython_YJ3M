commit 8d834fd9bb5703e3b72cd7141bda3fba5eccb767
Author: Joris Van den Bossche <jorisvandenbossche@gmail.com>
Date:   Tue Jul 9 22:11:06 2013 +0200

    DOC: update ipython_directive with changes from ipython to restart prompt number at 1 each page

diff --git a/doc/sphinxext/ipython_directive.py b/doc/sphinxext/ipython_directive.py
index b237341e8..0c28e397a 100644
--- a/doc/sphinxext/ipython_directive.py
+++ b/doc/sphinxext/ipython_directive.py
@@ -621,6 +621,8 @@ class IpythonDirective(Directive):
 
     shell = EmbeddedSphinxShell()
 
+    seen_docs = set()
+
     def get_config_options(self):
         # contains sphinx configuration variables
         config = self.state.document.settings.env.config
@@ -644,6 +646,12 @@ class IpythonDirective(Directive):
         return savefig_dir, source_dir, rgxin, rgxout, promptin, promptout
 
     def setup(self):
+
+        if not self.state.document.current_source in self.seen_docs:
+            self.shell.IP.history_manager.reset()
+            self.shell.IP.execution_count = 1
+            self.seen_docs.add(self.state.document.current_source)
+
         # get config values
         (savefig_dir, source_dir, rgxin,
                 rgxout, promptin, promptout) = self.get_config_options()
