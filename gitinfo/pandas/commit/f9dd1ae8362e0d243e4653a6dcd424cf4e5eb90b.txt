commit f9dd1ae8362e0d243e4653a6dcd424cf4e5eb90b
Author: Adam Klein <adamklein@gmail.com>
Date:   Wed May 30 16:32:08 2012 -0400

    ENH: add parameter to nancorr to suppress div by zero

diff --git a/pandas/src/moments.pyx b/pandas/src/moments.pyx
index 10f52dfdb..b2eb3d5c1 100644
--- a/pandas/src/moments.pyx
+++ b/pandas/src/moments.pyx
@@ -252,13 +252,13 @@ def ewma(ndarray[double_t] input, double_t com):
 
 @cython.boundscheck(False)
 @cython.wraparound(False)
-def nancorr(ndarray[float64_t, ndim=2] mat):
+def nancorr(ndarray[float64_t, ndim=2] mat, na_ok=False):
     cdef:
         Py_ssize_t i, j, xi, yi, N, K
         ndarray[float64_t, ndim=2] result
         ndarray[uint8_t, ndim=2] mask
         int64_t nobs = 0
-        float64_t vx, vy, sumx, sumy, sumxx, sumyy, meanx, meany
+        float64_t vx, vy, sumx, sumy, sumxx, sumyy, meanx, meany, divisor
 
     N, K = (<object> mat).shape
 
@@ -291,7 +291,12 @@ def nancorr(ndarray[float64_t, ndim=2] mat):
                     sumxx += vx * vx
                     sumyy += vy * vy
 
-            result[xi, yi] = result[yi, xi] = sumx / sqrt(sumxx * sumyy)
+            divisor = sqrt(sumxx * sumyy)
+
+            if na_ok == 0:
+                result[xi, yi] = result[yi, xi] = sumx / divisor if divisor != 0 else np.NaN
+            else:
+                result[xi, yi] = result[yi, xi] = sumx / divisor
 
     return result
 
