commit 3b2b0d31ad5bfc004e7ab5bb772ea4100d5bebda
Author: Tom Augspurger <TomAugspurger@users.noreply.github.com>
Date:   Tue Feb 4 13:25:59 2020 -0600

    PERF: Cache MultiIndex.levels (#31651)
    
    * PERF: Cache MultiIndex.levels
    
    Closes https://github.com/pandas-dev/pandas/issues/31648
    
    * fixup tests

diff --git a/pandas/core/indexes/multi.py b/pandas/core/indexes/multi.py
index c560d81ba..ea29e458f 100644
--- a/pandas/core/indexes/multi.py
+++ b/pandas/core/indexes/multi.py
@@ -677,8 +677,11 @@ class MultiIndex(Index):
     # --------------------------------------------------------------------
     # Levels Methods
 
-    @property
+    @cache_readonly
     def levels(self):
+        # Use cache_readonly to ensure that self.get_locs doesn't repeatedly
+        # create new IndexEngine
+        # https://github.com/pandas-dev/pandas/issues/31648
         result = [
             x._shallow_copy(name=name) for x, name in zip(self._levels, self._names)
         ]
@@ -1302,6 +1305,9 @@ class MultiIndex(Index):
                     )
             self._names[lev] = name
 
+        # If .levels has been accessed, the names in our cache will be stale.
+        self._reset_cache()
+
     names = property(
         fset=_set_names, fget=_get_names, doc="""\nNames of levels in MultiIndex.\n"""
     )
diff --git a/pandas/tests/indexes/multi/test_get_set.py b/pandas/tests/indexes/multi/test_get_set.py
index 074072ae5..57d16a739 100644
--- a/pandas/tests/indexes/multi/test_get_set.py
+++ b/pandas/tests/indexes/multi/test_get_set.py
@@ -159,7 +159,7 @@ def test_set_levels_codes_directly(idx):
     minor_codes = [(x + 1) % 1 for x in minor_codes]
     new_codes = [major_codes, minor_codes]
 
-    msg = "can't set attribute"
+    msg = "[Cc]an't set attribute"
     with pytest.raises(AttributeError, match=msg):
         idx.levels = new_levels
     with pytest.raises(AttributeError, match=msg):
