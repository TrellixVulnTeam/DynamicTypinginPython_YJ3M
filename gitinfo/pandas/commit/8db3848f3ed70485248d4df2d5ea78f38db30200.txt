commit 8db3848f3ed70485248d4df2d5ea78f38db30200
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Fri Aug 10 11:57:56 2012 -0400

    BUG: groupby DatetimeIndex asof/map issues close #1677

diff --git a/RELEASE.rst b/RELEASE.rst
index 840692dec..e50c1ca5c 100644
--- a/RELEASE.rst
+++ b/RELEASE.rst
@@ -45,6 +45,8 @@ pandas 0.8.2
   - Handle Ellipsis in Series.__getitem__/__setitem__ (#1721)
   - Fix some bugs with handling datetime64 scalars of other units in NumPy 1.6
     and 1.7 (#1717)
+  - Fix performance issue in MultiIndex.format (#1746)
+  - Fixed GroupBy bugs interacting with DatetimeIndex asof / map methods (#1677)
 
 pandas 0.8.1
 ============
diff --git a/pandas/core/index.py b/pandas/core/index.py
index c091a73b4..48ff22e5e 100644
--- a/pandas/core/index.py
+++ b/pandas/core/index.py
@@ -407,6 +407,9 @@ class Index(np.ndarray):
         For a sorted index, return the most recent label up to and including
         the passed label. Return NaN if not found
         """
+        if isinstance(label, (Index, np.ndarray)):
+            raise TypeError('%s' % type(label))
+
         if label not in self:
             loc = self.searchsorted(label, side='left')
             if loc > 0:
diff --git a/pandas/tseries/index.py b/pandas/tseries/index.py
index 391bb12c8..f228853dd 100644
--- a/pandas/tseries/index.py
+++ b/pandas/tseries/index.py
@@ -997,8 +997,11 @@ class DatetimeIndex(Int64Index):
     # Especially important for group-by functionality
     def map(self, f):
         try:
-            return f(self)
-        except:
+            result = f(self)
+            if not isinstance(result, np.ndarray):
+                raise TypeError
+            return result
+        except Exception:
             return _algos.arrmap_object(self.asobject, f)
 
     # alias to offset
diff --git a/pandas/tseries/tests/test_timeseries.py b/pandas/tseries/tests/test_timeseries.py
index d3515ed55..30e54f71d 100644
--- a/pandas/tseries/tests/test_timeseries.py
+++ b/pandas/tseries/tests/test_timeseries.py
@@ -1229,6 +1229,22 @@ class TestDatetimeIndex(unittest.TestCase):
         result = idx.insert(3, datetime(2000, 4, 30))
         self.assert_(result.freqstr == 'M')
 
+    def test_map_bug_1677(self):
+        index = DatetimeIndex(['2012-04-25 09:30:00.393000'])
+        f = index.asof
+
+        result = index.map(f)
+        expected = np.array([f(index[0])])
+        self.assert_(np.array_equal(result, expected))
+
+    def test_groupby_function_tuple_1677(self):
+        df = DataFrame(np.random.rand(100),
+                       index=date_range("1/1/2000", periods=100))
+        monthly_group = df.groupby(lambda x: (x.year,x.month))
+
+        result = monthly_group.mean()
+        self.assert_(isinstance(result.index[0], tuple))
+
 class TestLegacySupport(unittest.TestCase):
 
     @classmethod
