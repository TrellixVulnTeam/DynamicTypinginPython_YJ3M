commit 66458b6a872521cea12210c5dd87ab97aee7479c
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Wed Sep 28 22:22:54 2011 -0400

    BUG: groupby cython bug in _aggregate_group, unit test and raise up exceptions

diff --git a/pandas/src/groupby.pyx b/pandas/src/groupby.pyx
index 5c45b02df..ffa4ef9fa 100644
--- a/pandas/src/groupby.pyx
+++ b/pandas/src/groupby.pyx
@@ -340,10 +340,10 @@ def _group_reorder(values, label_list):
     sorted_values = values.take(indexer)
     return sorted_values, sorted_labels
 
-cdef void _aggregate_group(double_t *out, int32_t *counts, double_t *values,
+cdef int _aggregate_group(double_t *out, int32_t *counts, double_t *values,
                            list labels, int start, int end, tuple shape,
                            Py_ssize_t which, Py_ssize_t offset,
-                           agg_func func):
+                           agg_func func) except -1:
     cdef:
         ndarray[int32_t] axis
         cdef Py_ssize_t stride
@@ -352,7 +352,7 @@ cdef void _aggregate_group(double_t *out, int32_t *counts, double_t *values,
     if which == len(labels) - 1:
         axis = labels[which]
 
-        while axis[start] == -1 and start < end:
+        while start < end and axis[start] == -1:
             start += 1
         func(out, counts, values, <int32_t*> axis.data, start, end, offset)
     else:
diff --git a/pandas/tests/test_groupby.py b/pandas/tests/test_groupby.py
index d9418c2d8..5947d7da9 100644
--- a/pandas/tests/test_groupby.py
+++ b/pandas/tests/test_groupby.py
@@ -13,6 +13,7 @@ from pandas.util.testing import (assert_panel_equal, assert_frame_equal,
                                  assert_series_equal, assert_almost_equal)
 from pandas.core.panel import Panel
 from collections import defaultdict
+import pandas._tseries as lib
 import pandas.core.datetools as dt
 import numpy as np
 
@@ -797,6 +798,14 @@ class TestGroupBy(unittest.TestCase):
         assert_frame_equal(agg_result, expected)
         assert_frame_equal(apply_result, expected)
 
+    def test_cython_na_bug(self):
+        values = np.random.randn(10)
+        shape = (5, 5)
+        label_list = [np.array([0, 0, 0, 0, 1, 1, 1, 1, 2, 2], dtype=np.int32),
+                      np.array([1, 2, 3, 4, 0, 1, 2, 3, 3, 4], dtype=np.int32)]
+
+        lib.group_aggregate(values, label_list, shape)
+
 class TestPanelGroupBy(unittest.TestCase):
 
     def setUp(self):
