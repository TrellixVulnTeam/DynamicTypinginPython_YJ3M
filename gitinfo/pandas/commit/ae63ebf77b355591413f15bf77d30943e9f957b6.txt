commit ae63ebf77b355591413f15bf77d30943e9f957b6
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Wed Oct 17 11:01:35 2012 -0400

    BUG: fix WLS r-squared to match statsmodels post 10/2012

diff --git a/RELEASE.rst b/RELEASE.rst
index 9dbcd5e13..af34ce85b 100644
--- a/RELEASE.rst
+++ b/RELEASE.rst
@@ -31,6 +31,10 @@ pandas 0.9.1
 
   - Improve HTML display of DataFrame objects with hierarchical columns
 
+**Bug fixes**
+
+  - Make WLS r-squared match statsmodels 0.5.0 fixed value
+
 pandas 0.9.0
 ============
 
diff --git a/pandas/core/frame.py b/pandas/core/frame.py
index 9fa6e9ac2..c18010ab9 100644
--- a/pandas/core/frame.py
+++ b/pandas/core/frame.py
@@ -1647,7 +1647,7 @@ class DataFrame(NDFrame):
                 return self.reindex(columns=label)
 
             values = self._data.iget(i)
-            return Series(values, index=self.index, name=label)
+            return Series.from_array(values, index=self.index, name=label)
 
     def _ixs(self, i, axis=0):
         if axis == 0:
diff --git a/pandas/stats/ols.py b/pandas/stats/ols.py
index 9454ac75d..0192dced6 100644
--- a/pandas/stats/ols.py
+++ b/pandas/stats/ols.py
@@ -970,8 +970,10 @@ class MovingOLS(OLS):
         sst = []
         sse = []
 
+        Yreg = self._y
         Y = self._y_trans
         X = self._x_trans
+        weights = self._weights
 
         dates = self._index
         window = self._window
@@ -989,8 +991,16 @@ class MovingOLS(OLS):
 
             resid = Y_slice - np.dot(X_slice, beta)
 
+            if weights is not None:
+                Y_slice = _y_converter(Yreg.truncate(before=prior_date,
+                                                     after=date))
+                weights_slice = weights.truncate(prior_date, date)
+                demeaned = Y_slice - np.average(Y_slice, weights=weights_slice)
+                SS_total = (weights_slice*demeaned**2).sum()
+            else:
+                SS_total = ((Y_slice - Y_slice.mean()) ** 2).sum()
+
             SS_err = (resid ** 2).sum()
-            SS_total = ((Y_slice - Y_slice.mean()) ** 2).sum()
             SST_uncentered = (Y_slice ** 2).sum()
 
             sse.append(SS_err)
diff --git a/pandas/stats/tests/test_ols.py b/pandas/stats/tests/test_ols.py
index bc627410c..1af2449eb 100644
--- a/pandas/stats/tests/test_ols.py
+++ b/pandas/stats/tests/test_ols.py
@@ -81,6 +81,10 @@ class TestOLS(BaseTest):
         # self.checkDataSet(datasets.ccard.load(), 39, 49) # one col in X all 0s
 
     def testWLS(self):
+        # WLS centered SS changed (fixed) in 0.5.0
+        if sm.version.version < '0.5.0':
+            raise nose.SkipTest
+
         X = DataFrame(np.random.randn(30, 4), columns=['A', 'B', 'C', 'D'])
         Y = Series(np.random.randn(30))
         weights = X.std(1)
diff --git a/scripts/count_code.sh b/scripts/count_code.sh
index a4db9560d..31fff2ff3 100755
--- a/scripts/count_code.sh
+++ b/scripts/count_code.sh
@@ -1 +1 @@
-cloc pandas --force-lang=Python,pyx --not-match-f="tseries.c|sandbox.c|engines.c|sparse.c|generated.c|plib.c"
\ No newline at end of file
+cloc pandas --force-lang=Python,pyx --not-match-f="parser.c|tseries.c|sandbox.c|engines.c|sparse.c|generated.c|plib.c"
\ No newline at end of file
