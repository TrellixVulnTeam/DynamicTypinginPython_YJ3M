commit d07d3c2beb479ab08577eeff60488f0de8326391
Author: Chang She <changshe@gmail.com>
Date:   Mon Sep 10 13:49:53 2012 -0400

    BUG: set_index inplace modifies data even if unique check fails #1831

diff --git a/pandas/core/frame.py b/pandas/core/frame.py
index 275b9505c..114daff46 100644
--- a/pandas/core/frame.py
+++ b/pandas/core/frame.py
@@ -2400,6 +2400,7 @@ class DataFrame(NDFrame):
             else:
                 arrays.append(np.asarray(self.index))
 
+        to_remove = []
         for col in keys:
             if isinstance(col, Series):
                 level = col.values
@@ -2411,7 +2412,7 @@ class DataFrame(NDFrame):
                 level = frame[col].values
                 names.append(col)
                 if drop:
-                    del frame[col]
+                    to_remove.append(col)
             arrays.append(level)
 
         index = MultiIndex.from_arrays(arrays, names=names)
@@ -2420,6 +2421,9 @@ class DataFrame(NDFrame):
             duplicates = index.get_duplicates()
             raise Exception('Index has duplicate keys: %s' % duplicates)
 
+        for c in to_remove:
+            del frame[c]
+
         # clear up memory usage
         index._cleanup()
 
diff --git a/pandas/tests/test_frame.py b/pandas/tests/test_frame.py
index 6ce16e284..803a9859d 100644
--- a/pandas/tests/test_frame.py
+++ b/pandas/tests/test_frame.py
@@ -1423,6 +1423,16 @@ class TestDataFrame(unittest.TestCase, CheckIndexing,
         xp.index.names = [None, 'A', 'B']
         assert_frame_equal(result, xp)
 
+    def test_set_index_nonuniq(self):
+        df = DataFrame({'A' : ['foo', 'foo', 'foo', 'bar', 'bar'],
+                        'B' : ['one', 'two', 'three', 'one', 'two'],
+                        'C' : ['a', 'b', 'c', 'd', 'e'],
+                        'D' : np.random.randn(5),
+                        'E' : np.random.randn(5)})
+        self.assertRaises(Exception, df.set_index, 'A', verify_integrity=True,
+                          inplace=True)
+        self.assert_('A' in df)
+
     def test_set_index_bug(self):
         #GH1590
         df = DataFrame({'val' : [0, 1, 2], 'key': ['a', 'b', 'c']})
