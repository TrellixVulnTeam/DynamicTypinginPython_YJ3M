commit 07731611462a845516186452b202597f9f0b54c8
Author: y-p <yoval@gmx.com>
Date:   Tue Feb 4 13:22:39 2014 +0200

    BLD/DOC: fix ipython_directive to workaround ipython/4504

diff --git a/doc/sphinxext/ipython_directive.py b/doc/sphinxext/ipython_directive.py
index ff2379eb7..3f9be9560 100644
--- a/doc/sphinxext/ipython_directive.py
+++ b/doc/sphinxext/ipython_directive.py
@@ -344,7 +344,11 @@ class EmbeddedSphinxShell(object):
             splitter.push(line)
             more = splitter.push_accepts_more()
             if not more:
-                source_raw = splitter.source_raw_reset()[1]
+                try:
+                    source_raw = splitter.source_raw_reset()[1]
+                except:
+                    # recent ipython #4504
+                    source_raw = splitter.raw_reset()
                 self.IP.run_cell(source_raw, store_history=store_history)
         finally:
             sys.stdout = stdout
