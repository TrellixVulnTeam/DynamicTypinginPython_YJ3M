commit 4a3d008f62f894db613e002088ad5651a9035c55
Author: Wes McKinney <wesmckinn@gmail.com>
Date:   Mon Aug 22 14:13:49 2011 -0400

    BUG: groupby aggregate regression

diff --git a/pandas/core/groupby.py b/pandas/core/groupby.py
index 0ab66d8a8..546b2b494 100644
--- a/pandas/core/groupby.py
+++ b/pandas/core/groupby.py
@@ -276,8 +276,8 @@ class GroupBy(object):
             for name, obj in self._iterate_slices():
                 _doit(result, counts, gen_factory(obj))
                 # TODO: same mask for every column...
+                output[name] = result.ravel().copy()
                 result.fill(np.nan)
-                output[name] = result.ravel()
 
             mask = counts.ravel() > 0
             for name, result in output.iteritems():
diff --git a/pandas/tests/test_groupby.py b/pandas/tests/test_groupby.py
index e072bcc25..645a6f73d 100644
--- a/pandas/tests/test_groupby.py
+++ b/pandas/tests/test_groupby.py
@@ -103,6 +103,12 @@ class TestGroupBy(unittest.TestCase):
         # corner cases
         self.assertRaises(Exception, grouped.aggregate, lambda x: x * 2)
 
+    def test_agg_regression1(self):
+        grouped = self.tsframe.groupby([lambda x: x.year, lambda x: x.month])
+        result = grouped.agg(np.mean)
+        expected = grouped.mean()
+        assert_frame_equal(result, expected)
+
     def test_get_group(self):
         wp = tm.makeWidePanel()
         grouped = wp.groupby(lambda x: x.month, axis='major')
