commit b05453631270d4b78f79dc272222d5f3fe499ad7
Author: Jeff Reback <jeff@reback.net>
Date:   Mon Jul 18 21:15:04 2016 -0400

    BUG: merge_asof not handling allow_exact_matches and tolerance on first entry
    
    closes #13695
    
    Author: Jeff Reback <jeff@reback.net>
    
    Closes #13698 from jreback/merge_asof and squashes the following commits:
    
    c46dcfa [Jeff Reback] BUG: merge_asof not handling allow_exact_matches and tolerance on first entry

diff --git a/doc/source/whatsnew/v0.19.0.txt b/doc/source/whatsnew/v0.19.0.txt
index fd58eb1b0..e728cb791 100644
--- a/doc/source/whatsnew/v0.19.0.txt
+++ b/doc/source/whatsnew/v0.19.0.txt
@@ -46,7 +46,7 @@ The following are now part of this API:
 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
 
 A long-time requested feature has been added through the :func:`merge_asof` function, to
-support asof style joining of time-series. (:issue:`1870`). Full documentation is
+support asof style joining of time-series. (:issue:`1870`, :issue:`13695`). Full documentation is
 :ref:`here <merging.merge_asof>`
 
 The :func:`merge_asof` performs an asof merge, which is similar to a left-join
diff --git a/pandas/src/join.pyx b/pandas/src/join.pyx
index a81ac0aa3..ad3b1d4e4 100644
--- a/pandas/src/join.pyx
+++ b/pandas/src/join.pyx
@@ -193,11 +193,12 @@ def left_outer_asof_join(ndarray[int64_t] left, ndarray[int64_t] right,
                         diff = left_val - right_val
 
                         # do we allow exact matches
-                        if allow_exact_matches and diff > tol:
-                            right_indexer[indexer] = -1
-                            continue
+                        if allow_exact_matches:
+                            if diff > tol:
+                                right_indexer[indexer] = -1
+                                continue
                         elif not allow_exact_matches:
-                            if diff >= tol:
+                            if diff >= tol or lc == rc:
                                 right_indexer[indexer] = -1
                                 continue
 
@@ -220,13 +221,14 @@ def left_outer_asof_join(ndarray[int64_t] left, ndarray[int64_t] right,
                         diff = left_val - right_val
 
                         # do we allow exact matches
-                        if allow_exact_matches and diff > tol:
-                            right_indexer[indexer] = -1
-                            continue
+                        if allow_exact_matches:
+                            if diff > tol:
+                                right_indexer[indexer] = -1
+                                continue
 
                         # we don't allow exact matches
                         elif not allow_exact_matches:
-                            if diff >= tol or not right_pos:
+                            if diff >= tol or lc == rc:
                                 right_indexer[indexer] = -1
                             else:
                                 right_indexer[indexer] = right_pos - 1
diff --git a/pandas/tools/tests/test_merge_asof.py b/pandas/tools/tests/test_merge_asof.py
index 5d78ccf19..bcbb0f0fa 100644
--- a/pandas/tools/tests/test_merge_asof.py
+++ b/pandas/tools/tests/test_merge_asof.py
@@ -347,6 +347,39 @@ class TestAsOfMerge(tm.TestCase):
         expected = self.allow_exact_matches_and_tolerance
         assert_frame_equal(result, expected)
 
+    def test_allow_exact_matches_and_tolerance2(self):
+        # GH 13695
+        df1 = pd.DataFrame({
+            'time': pd.to_datetime(['2016-07-15 13:30:00.030']),
+            'username': ['bob']})
+        df2 = pd.DataFrame({
+            'time': pd.to_datetime(['2016-07-15 13:30:00.000',
+                                    '2016-07-15 13:30:00.030']),
+            'version': [1, 2]})
+
+        result = pd.merge_asof(df1, df2, on='time')
+        expected = pd.DataFrame({
+            'time': pd.to_datetime(['2016-07-15 13:30:00.030']),
+            'username': ['bob'],
+            'version': [2]})
+        assert_frame_equal(result, expected)
+
+        result = pd.merge_asof(df1, df2, on='time', allow_exact_matches=False)
+        expected = pd.DataFrame({
+            'time': pd.to_datetime(['2016-07-15 13:30:00.030']),
+            'username': ['bob'],
+            'version': [1]})
+        assert_frame_equal(result, expected)
+
+        result = pd.merge_asof(df1, df2, on='time', allow_exact_matches=False,
+                               tolerance=pd.Timedelta('10ms'))
+        expected = pd.DataFrame({
+            'time': pd.to_datetime(['2016-07-15 13:30:00.030']),
+            'username': ['bob'],
+            'version': [np.nan]})
+        assert_frame_equal(result, expected)
+
+
 if __name__ == '__main__':
     nose.runmodule(argv=[__file__, '-vvs', '-x', '--pdb', '--pdb-failure'],
                    exit=False)
