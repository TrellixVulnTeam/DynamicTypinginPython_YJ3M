commit 682ba086565402044a81f4f3aa5450440f08e18f
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Jan 26 15:33:02 2013 -0800

    Overhaul of group details page

diff --git a/src/sentry/models.py b/src/sentry/models.py
index 1ddcacd472..c880f38688 100644
--- a/src/sentry/models.py
+++ b/src/sentry/models.py
@@ -506,7 +506,7 @@ class Group(EventBase):
     def get_latest_event(self):
         if not hasattr(self, '_latest_event'):
             try:
-                self._latest_event = self.event_set.order_by('-id')[0]
+                self._latest_event = self.event_set.order_by('-datetime')[0]
             except IndexError:
                 self._latest_event = None
         return self._latest_event
diff --git a/src/sentry/static/sentry/less/sentry.less b/src/sentry/static/sentry/less/sentry.less
index 169f2f52e2..741060b7ab 100644
--- a/src/sentry/static/sentry/less/sentry.less
+++ b/src/sentry/static/sentry/less/sentry.less
@@ -427,9 +427,9 @@ h3 {
     position: relative;
     float: left;
   }
-  .body {
+  section.body {
     padding: 25px 30px 10px;
-
+ 
     .select2-drop {
       .box-shadow(0 0 0 2px #c3c8ce);
     }
@@ -445,6 +445,13 @@ h3 {
     list-style: none;
     padding: 15px 20px 15px 30px;
     border-bottom: 2px solid #f2f4f7;
+    text-align: center;
+
+    h4 {
+      line-height: 30px;
+      font-weight: normal;
+      color: #aaa;
+    }
     .btn-group {
       .btn {
         float: none;
@@ -465,6 +472,11 @@ h3 {
   section.body .btn-toolbar {
     padding: 15px 0;
   }
+  section.body .event-toolbar {
+    padding: 5px 30px 15px;
+    margin: 0 -30px 15px;
+    border-bottom: 0;
+  }
   .sidebar {
     position: relative;
     width: 240px;
@@ -1023,7 +1035,7 @@ ul.tag-list {
   .reset-filter();
   background-image: none;
   background-color: inherit;
-  border-color: #e5e6e7;
+  border-color: #f2f4f7;
 }
 
 label { font-weight: bold; }
@@ -1408,7 +1420,7 @@ legend {
 // #5e6a77
 // #505962
 
-.body .page-header:first-child {
+section.body .page-header:first-child {
   margin-top: 0;
 }
 .page-header {
@@ -1506,16 +1518,15 @@ legend {
 
 #event_nav.fixed {
   // overflow: hidden;
-  margin-bottom: 0;
-  position: fixed;
-  left: 0;
-  right: 0;
-  top: 0;
   z-index: 1000000;
 
   .event_nav_wrap {
+    position: fixed;
+    left: 0;
+    right: 0;
+    top: 0;
+    min-width: 1086px;
     max-width: 1300px;
-    margin: 0 auto;
 
     > ul {
       overflow: hidden;
@@ -1525,29 +1536,38 @@ legend {
       padding: 5px 0 5px 30px;
       margin: 0 300px 0 0;
       background: #fff;
-      @shadow: 0 1px 0 rgba(0,0,0, .08), 0 1px 3px rgba(0,0,0, .05);
-      .box-shadow(@shadow);
       
       li.dropdown {
         position: relative;
       }
+
+      li.top {
+        .pull-right;
+        display: block;
+      }
     }
   }
 }
 
 #event_nav {
-  margin-bottom: 20px;
   position: relative;
-  min-width: 1086px;
+  margin-bottom: 15px;
+  margin-top: -15px;
 
   .event_nav_wrap {
     > ul {
-      padding: 5px 20px;
-      margin: 0 -20px 0;
-
+      padding: 10px 30px;
+      margin: 0 -30px 0;
+      border-top: 1px solid #dee3e9;
+      @shadow: 0 1px 0 rgba(0,0,0, .08), 0 1px 3px rgba(0,0,0, .05);
+      .box-shadow(@shadow);
 
       > li {
         margin: 0 4px 0 0;
+
+        &.top {
+          display: none;
+        }
         > a {
           padding: 8px 18px;
           line-height: 16px;
@@ -1677,7 +1697,7 @@ legend {
   }
 }
 
-.body {
+section.body {
   textarea, input[type="text"], input[type="password"], input[type="datetime"], input[type="datetime-local"], input[type="date"], input[type="month"], input[type="time"], input[type="week"], input[type="number"], input[type="email"], input[type="url"], input[type="search"], input[type="tel"], input[type="color"], .uneditable-input {
     height: auto;
     line-height: auto;
diff --git a/src/sentry/templates/sentry/groups/details.html b/src/sentry/templates/sentry/groups/details.html
index 57f885833e..71e1e2cb5d 100644
--- a/src/sentry/templates/sentry/groups/details.html
+++ b/src/sentry/templates/sentry/groups/details.html
@@ -12,6 +12,47 @@
     <li><a href="{% url sentry-group group.team.slug group.project.slug group.id %}">{{ group.message|truncatechars:30 }}</a></li>
 {% endblock %}
 
+{% block main %}
+    {% handle_before_events request group %}
+
+    <div id="details">
+        <div id="event_list" class="inactive"></div>
+    </div>
+
+    <section class="body">
+        {% block inner %}
+            {% with event|get_rendered_interfaces as interface_list %}
+
+                {% if group|has_charts %}
+                    <div class="module">
+                        <div id="chart" class="chart" data-api-url="{% url sentry-api-chart project.team.slug project.slug %}" data-group="{{ group.id|safe }}">
+                            <div class="sparkline">
+                                <span class="loading">{% trans "Loading historical data..." %}</span>
+                                <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
+                            </div>
+                        </div>
+                    </div>
+                {% endif %}
+
+                <div class="btn-toolbar event-toolbar">
+                    <!-- We switch the ordering of events here as it makes more sense visually -->
+                    <a class="btn pull-left {% if not next_event %} disabled{% endif %}"{% if next_event %} href="{% url sentry-group-event group.team.slug group.project.slug group.id next_event.id %}"{% endif %}><span>{% trans "Newer Event" %}</span></a>
+                    <a class="btn pull-right {% if not prev_event %} disabled{% endif %}"{% if prev_event %} href="{% url sentry-group-event group.team.slug group.project.slug group.id prev_event.id %}"{% endif %}><span>{% trans "Older Event" %}</span></a>
+                    <h4>Event at {{ event.datetime }} UTC</h4>
+                </div>
+
+                {% include "sentry/partial/event_nav.html" %}
+            
+                {% if group.has_two_part_message %}
+                    <pre id="full-message">{{ group.message }}</pre>
+                {% endif %}
+
+                {% include "sentry/partial/_event_details.html" %}
+            {% endwith %}
+        {% endblock %}
+    </section>
+{% endblock %}
+
 {% block sidebar %}
     <ul class="nav nav-list">
         <li{% if page == 'details' %} class="active"{% endif %}><a href="{% url sentry-group group.team.slug group.project.slug group.id %}">Aggregate</a></li>
@@ -89,40 +130,6 @@
     {% for html in group|get_widgets:request %}
         {{ html|safe }}
     {% endfor %}
-
-{% endblock %}
-
-{% block main %}
-    {% handle_before_events request group %}
-
-    <div id="details">
-        <div id="event_list" class="inactive"></div>
-    </div>
-
-    {% with event|get_rendered_interfaces as interface_list %}
-        <section class="body">
-            {% block inner %}
-                {% include "sentry/partial/event_nav.html" %}
-
-                {% if group.has_two_part_message %}
-                    <pre id="full-message">{{ group.message }}</pre>
-                {% endif %}
-
-                {% if group|has_charts %}
-                    <div class="module">
-                        <div id="chart" class="chart" data-api-url="{% url sentry-api-chart project.team.slug project.slug %}" data-group="{{ group.id|safe }}">
-                            <div class="sparkline">
-                                <span class="loading">{% trans "Loading historical data..." %}</span>
-                                <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
-                            </div>
-                        </div>
-                    </div>
-                {% endif %}
-
-                {% include "sentry/partial/_event_details.html" %}
-            {% endblock %}
-        </section>
-    {% endwith %}
 {% endblock %}
 
 {% block content_after %}
diff --git a/src/sentry/templates/sentry/groups/event.html b/src/sentry/templates/sentry/groups/event.html
deleted file mode 100644
index 1e3f0e2564..0000000000
--- a/src/sentry/templates/sentry/groups/event.html
+++ /dev/null
@@ -1,32 +0,0 @@
-{% extends "sentry/groups/details.html" %}
-
-{% load i18n %}
-{% load sentry_helpers %}
-
-{% block breadcrumb %}
-    {{ block.super }}
-    <li class="divider"></li>
-    <li><a href="{% url sentry-group-event group.team.slug group.project.slug group.id event.id %}">Event at {{ event.datetime }} UTC</a></li>
-{% endblock %}
-
-{% block inner %}
-    {% include "sentry/partial/event_nav.html" %}
-
-    <div class="btn-toolbar">
-            <!-- We switch the ordering of events here as it makes more sense visually -->
-        <a class="btn {% if not next_event %} disabled{% endif %}"{% if next_event %} href="{% url sentry-group-event group.team.slug group.project.slug group.id next_event.id %}"{% endif %}><span>{% trans "Newer Event" %}</span></a>
-        <a class="btn pull-right {% if not prev_event %} disabled{% endif %}"{% if prev_event %} href="{% url sentry-group-event group.team.slug group.project.slug group.id prev_event.id %}"{% endif %}><span>{% trans "Older Event" %}</span></a>
-    </div>
-
-    <ul class="events no-counts">
-        {% include "sentry/partial/_event.html" %}
-    </ul>
-
-    <br>
-
-    {% if event.has_two_part_message %}
-        <pre id="full-message">{{ event.message }}</pre>
-    {% endif %}
-
-    {% include "sentry/partial/_event_details.html" %}
-{% endblock %}
\ No newline at end of file
diff --git a/src/sentry/templates/sentry/partial/event_nav.html b/src/sentry/templates/sentry/partial/event_nav.html
index 50f63a65f6..183ae1f60e 100644
--- a/src/sentry/templates/sentry/partial/event_nav.html
+++ b/src/sentry/templates/sentry/partial/event_nav.html
@@ -19,8 +19,8 @@
                     </li>
                 {% endif %}
             {% endwith %}
-            <li{% if page == 'details' %} class="active"{% endif %}>
-                <a href="#details">{% trans "Details" %}</a>
+            <li class="top{% if page == 'details' %} active{% endif %}">
+                <a href="javascript:window.location = '#details'">{% trans "Top" %}</a>
             </li>
             {% for interface, _ in interface_list %}
                 <li>
diff --git a/src/sentry/web/frontend/groups.py b/src/sentry/web/frontend/groups.py
index c8d788bcf7..1b7ff76df4 100644
--- a/src/sentry/web/frontend/groups.py
+++ b/src/sentry/web/frontend/groups.py
@@ -277,23 +277,39 @@ def group_list(request, team, project):
     }, request)
 
 
-def render_with_group_context(group, template, context, request=None):
-    # It's possible that a message would not be created under certain
-    # circumstances (such as a post_save signal failing)
-    event = group.get_latest_event() or Event()
-    event.group = group
-
+def render_with_group_context(group, template, context, request=None, event=None):
     context.update({
         'team': group.project.team,
         'project': group.project,
         'group': group,
-        'event': event,
-        'json_data': event.data.get('extra', {}),
-        'version_data': event.data.get('modules', None),
         'can_admin_event': can_admin_group(request.user, group),
         'SECTION': 'events',
     })
 
+    if event:
+        if event.id:
+            base_qs = group.event_set.exclude(id=event.id)
+            try:
+                next_event = base_qs.filter(datetime__gte=event.datetime).order_by('datetime')[0:1].get()
+            except Event.DoesNotExist:
+                next_event = None
+
+            try:
+                prev_event = base_qs.filter(datetime__lte=event.datetime).order_by('-datetime')[0:1].get()
+            except Event.DoesNotExist:
+                prev_event = None
+        else:
+            next_event = None
+            prev_event = None
+
+        context.update({
+            'event': event,
+            'json_data': event.data.get('extra', {}),
+            'version_data': event.data.get('modules', None),
+            'next_event': next_event,
+            'prev_event': prev_event,
+        })
+
     return render_to_response(template, context, request)
 
 
@@ -303,10 +319,15 @@ def group(request, team, project, group):
         group=group,
     ).order_by('-datetime').select_related('user')
 
+    # It's possible that a message would not be created under certain
+    # circumstances (such as a post_save signal failing)
+    event = group.get_latest_event() or Event()
+    event.group
+
     return render_with_group_context(group, 'sentry/groups/details.html', {
         'page': 'details',
         'activity': activity,
-    }, request)
+    }, request, event=event)
 
 
 @has_group_access
@@ -370,30 +391,9 @@ def group_event_list_json(request, team, project, group_id):
 def group_event_details(request, team, project, group, event_id):
     event = get_object_or_404(group.event_set, id=event_id)
 
-    base_qs = group.event_set.exclude(id=event_id)
-    try:
-        next_event = base_qs.filter(datetime__gte=event.datetime).order_by('datetime')[0:1].get()
-    except Event.DoesNotExist:
-        next_event = None
-
-    try:
-        prev_event = base_qs.filter(datetime__lte=event.datetime).order_by('-datetime')[0:1].get()
-    except Event.DoesNotExist:
-        prev_event = None
-
-    return render_to_response('sentry/groups/event.html', {
-        'team': team,
-        'project': project,
-        'page': 'event',
-        'group': group,
-        'event': event,
-        'next_event': next_event,
-        'prev_event': prev_event,
-        'json_data': event.data.get('extra', {}),
-        'version_data': event.data.get('modules', None),
-        'can_admin_event': can_admin_group(request.user, group),
-        'SECTION': 'events',
-    }, request)
+    return render_with_group_context(group, 'sentry/groups/details.html', {
+        'page': 'details',
+    }, request, event=event)
 
 
 @has_access(MEMBER_USER)
