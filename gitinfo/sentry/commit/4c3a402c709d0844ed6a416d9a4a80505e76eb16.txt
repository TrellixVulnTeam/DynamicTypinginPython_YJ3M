commit 4c3a402c709d0844ed6a416d9a4a80505e76eb16
Author: Wilmar den Ouden <wilmardo@users.noreply.github.com>
Date:   Wed Jan 29 14:10:41 2020 +0100

    fix: do not error when user already exists (#16440)
    
    Fixes #6763
    
    This solution fixes the issue in the simplest way possible, when the user exists skip the creation and adding to the organization.
    
    I tried an approach to also add checks for the organization but I decided against it since it might break existing functionality. This script now assumes when a user exists, everything already is as it is supposed to be. Which should be true in the most cases.
    
    Signed-off-by: wilmardo <info@wilmardenouden.nl>

diff --git a/src/sentry/runner/commands/createuser.py b/src/sentry/runner/commands/createuser.py
index f84305e0b0..52ee5f3c74 100644
--- a/src/sentry/runner/commands/createuser.py
+++ b/src/sentry/runner/commands/createuser.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import, print_function
 
 import click
+import sys
 from sentry.runner.decorators import configuration
 
 
@@ -42,8 +43,9 @@ def _get_superuser():
 @click.option("--superuser/--no-superuser", default=None, is_flag=True)
 @click.option("--no-password", default=False, is_flag=True)
 @click.option("--no-input", default=False, is_flag=True)
+@click.option("--force-update", default=False, is_flag=True)
 @configuration
-def createuser(email, password, superuser, no_password, no_input):
+def createuser(email, password, superuser, no_password, no_input, force_update):
     "Create a new user."
     if not no_input:
         if not email:
@@ -76,24 +78,31 @@ def createuser(email, password, superuser, no_password, no_input):
     if password:
         user.set_password(password)
 
-    user.save()
-
-    click.echo("User created: %s" % (email,))
-
-    # TODO(dcramer): kill this when we improve flows
-    if settings.SENTRY_SINGLE_ORGANIZATION:
-        from sentry.models import Organization, OrganizationMember, OrganizationMemberTeam, Team
-
-        org = Organization.get_default()
-        if superuser:
-            role = roles.get_top_dog().id
+    if User.objects.filter(username=email).exists():
+        if force_update:
+            user.save(force_update=force_update)
+            click.echo("User updated: %s" % (email,))
         else:
-            role = org.default_role
-        member = OrganizationMember.objects.create(organization=org, user=user, role=role)
-
-        # if we've only got a single team let's go ahead and give
-        # access to that team as its likely the desired outcome
-        teams = list(Team.objects.filter(organization=org)[0:2])
-        if len(teams) == 1:
-            OrganizationMemberTeam.objects.create(team=teams[0], organizationmember=member)
-        click.echo("Added to organization: %s" % (org.slug,))
+            click.echo("User: %s exists, use --force-update to force" % (email,))
+            sys.exit(3)
+    else:
+        user.save()
+        click.echo("User created: %s" % (email,))
+
+        # TODO(dcramer): kill this when we improve flows
+        if settings.SENTRY_SINGLE_ORGANIZATION:
+            from sentry.models import Organization, OrganizationMember, OrganizationMemberTeam, Team
+
+            org = Organization.get_default()
+            if superuser:
+                role = roles.get_top_dog().id
+            else:
+                role = org.default_role
+            member = OrganizationMember.objects.create(organization=org, user=user, role=role)
+
+            # if we've only got a single team let's go ahead and give
+            # access to that team as its likely the desired outcome
+            teams = list(Team.objects.filter(organization=org)[0:2])
+            if len(teams) == 1:
+                OrganizationMemberTeam.objects.create(team=teams[0], organizationmember=member)
+            click.echo("Added to organization: %s" % (org.slug,))
