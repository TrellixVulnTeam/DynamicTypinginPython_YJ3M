commit 387e93814043e8bf70ffe01639392b9ff18161d9
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Fri Mar 16 13:54:15 2018 -0700

    fix(ui): Add fingerprint for route not found (#7672)
    
    * feat(ui): Better fingerprinting for permission errors

diff --git a/src/sentry/static/sentry/app/components/asyncComponent.jsx b/src/sentry/static/sentry/app/components/asyncComponent.jsx
index 35ba781102..2560d78c52 100644
--- a/src/sentry/static/sentry/app/components/asyncComponent.jsx
+++ b/src/sentry/static/sentry/app/components/asyncComponent.jsx
@@ -1,13 +1,12 @@
 import {isEqual} from 'lodash';
 import PropTypes from 'prop-types';
-import Raven from 'raven-js';
 import React from 'react';
 
 import {Client} from '../api';
-import {t, tct} from '../locale';
-import ExternalLink from './externalLink';
+import {t} from '../locale';
 import LoadingError from './loadingError';
 import LoadingIndicator from '../components/loadingIndicator';
+import PermissionDenied from '../views/permissionDenied';
 import RouteError from './../views/routeError';
 
 class AsyncComponent extends React.Component {
@@ -187,18 +186,7 @@ class AsyncComponent extends React.Component {
     }
 
     if (permissionErrors) {
-      // TODO(billy): Refactor this into a new PermissionDenied component
-      Raven.captureException(new Error('Permission Denied'), {});
-      return (
-        <LoadingError
-          message={tct(
-            'Your role does not have the necessary permissions to access this resource, please read more about [link:organizational roles]',
-            {
-              link: <ExternalLink href="https://docs.sentry.io/learn/membership/" />,
-            }
-          )}
-        />
-      );
+      return <PermissionDenied />;
     }
 
     return <RouteError error={error} component={this} onRetry={this.remountComponent} />;
diff --git a/src/sentry/static/sentry/app/views/permissionDenied.jsx b/src/sentry/static/sentry/app/views/permissionDenied.jsx
new file mode 100644
index 0000000000..6f6b1719d0
--- /dev/null
+++ b/src/sentry/static/sentry/app/views/permissionDenied.jsx
@@ -0,0 +1,62 @@
+import {withRouter} from 'react-router';
+import DocumentTitle from 'react-document-title';
+import PropTypes from 'prop-types';
+import Raven from 'raven-js';
+import React from 'react';
+
+import {t, tct} from '../locale';
+import ExternalLink from '../components/externalLink';
+import LoadingError from '../components/loadingError';
+
+const ERROR_NAME = 'Permission Denied';
+
+class PermissionDenied extends React.Component {
+  static propTypes = {
+    routes: PropTypes.array,
+  };
+
+  static contextTypes = {
+    organization: PropTypes.object,
+    project: PropTypes.object,
+  };
+
+  componentDidMount() {
+    let {routes} = this.props;
+    let {organization, project} = this.context;
+
+    let route =
+      (Array.isArray(routes) &&
+        routes
+          .filter(({path}) => path)
+          .map(({path}) => path)
+          .join('')) ||
+      '';
+
+    Raven.captureException(new Error(ERROR_NAME), {
+      fingerprint: [ERROR_NAME, route],
+      extraInfo: {
+        route,
+        orgFeatures: (organization && organization.features) || [],
+        orgAccess: (organization && organization.access) || [],
+        projectFeatures: (project && project.features) || [],
+      },
+    });
+  }
+
+  render() {
+    return (
+      <DocumentTitle title={t('Permission Denied')}>
+        <LoadingError
+          message={tct(
+            'Your role does not have the necessary permissions to access this resource, please read more about [link:organizational roles]',
+            {
+              link: <ExternalLink href="https://docs.sentry.io/learn/membership/" />,
+            }
+          )}
+        />
+      </DocumentTitle>
+    );
+  }
+}
+
+export default withRouter(PermissionDenied);
diff --git a/src/sentry/static/sentry/app/views/routeNotFound.jsx b/src/sentry/static/sentry/app/views/routeNotFound.jsx
index 9b97964f8d..f093348b5d 100644
--- a/src/sentry/static/sentry/app/views/routeNotFound.jsx
+++ b/src/sentry/static/sentry/app/views/routeNotFound.jsx
@@ -8,7 +8,9 @@ import NotFound from '../components/errors/notFound';
 
 class RouteNotFound extends React.Component {
   componentDidMount() {
-    Raven.captureException(new Error('Route not found'));
+    Raven.captureException(new Error('Route not found'), {
+      fingerprint: ['RouteNotFound'],
+    });
   }
 
   getTitle = () => {
diff --git a/tests/js/spec/views/projectKeyDetails.spec.jsx b/tests/js/spec/views/projectKeyDetails.spec.jsx
index 4627042045..f4db3fbc93 100644
--- a/tests/js/spec/views/projectKeyDetails.spec.jsx
+++ b/tests/js/spec/views/projectKeyDetails.spec.jsx
@@ -8,6 +8,7 @@ import ProjectKeyDetails from 'app/views/settings/project/projectKeys/projectKey
 import theme from 'app/utils/theme';
 
 jest.mock('react-router', () => ({
+  withRouter: i => i,
   browserHistory: {push: jest.fn()},
 }));
 
