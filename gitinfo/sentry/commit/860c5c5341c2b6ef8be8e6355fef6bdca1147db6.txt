commit 860c5c5341c2b6ef8be8e6355fef6bdca1147db6
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Sep 26 11:04:52 2017 -0700

    fix(repos): Maintain feature flag

diff --git a/src/sentry/api/endpoints/organization_integrations.py b/src/sentry/api/endpoints/organization_integrations.py
index 87a1c07cf0..5cdfd29f50 100644
--- a/src/sentry/api/endpoints/organization_integrations.py
+++ b/src/sentry/api/endpoints/organization_integrations.py
@@ -21,7 +21,10 @@ class OrganizationIntegrationsEndpoint(OrganizationEndpoint):
 
     def get(self, request, organization):
         if not self.has_feature(request, organization):
-            return self.respond({'detail': ['You do not have that feature enabled']}, status=400)
+            return self.respond({
+                'error_type': 'unavailable_feature',
+                'detail': ['You do not have that feature enabled']
+            }, status=403)
 
         return self.paginate(
             queryset=Integration.objects.filter(organizations=organization),
diff --git a/src/sentry/api/endpoints/organization_repositories.py b/src/sentry/api/endpoints/organization_repositories.py
index f9900d87ba..f66c153ac5 100644
--- a/src/sentry/api/endpoints/organization_repositories.py
+++ b/src/sentry/api/endpoints/organization_repositories.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 from rest_framework.response import Response
 
+from sentry import features
 from sentry.api.base import DocSection
 from sentry.api.bases.organization import OrganizationEndpoint
 from sentry.api.paginator import OffsetPaginator
@@ -14,6 +15,13 @@ from sentry.plugins import bindings
 class OrganizationRepositoriesEndpoint(OrganizationEndpoint):
     doc_section = DocSection.ORGANIZATIONS
 
+    def has_feature(self, request, organization):
+        return features.has(
+            'organizations:repos',
+            organization=organization,
+            actor=request.user,
+        )
+
     def get(self, request, organization):
         """
         List an Organization's Repositories
@@ -24,6 +32,12 @@ class OrganizationRepositoriesEndpoint(OrganizationEndpoint):
         :pparam string organization_slug: the organization short name
         :auth: required
         """
+        if not self.has_feature(request, organization):
+            return self.respond({
+                'error_type': 'unavailable_feature',
+                'detail': ['You do not have that feature enabled']
+            }, status=403)
+
         queryset = Repository.objects.filter(
             organization_id=organization.id,
         )
@@ -52,6 +66,12 @@ class OrganizationRepositoriesEndpoint(OrganizationEndpoint):
         if not request.user.is_authenticated():
             return Response(status=401)
 
+        if not self.has_feature(request, organization):
+            return self.respond({
+                'error_type': 'unavailable_feature',
+                'detail': ['You do not have that feature enabled']
+            }, status=403)
+
         provider_id = request.DATA.get('provider')
         try:
             provider_cls = bindings.get('repository.provider').get(provider_id)
diff --git a/src/sentry/api/serializers/models/organization.py b/src/sentry/api/serializers/models/organization.py
index dc562e6034..1b0461bfd5 100644
--- a/src/sentry/api/serializers/models/organization.py
+++ b/src/sentry/api/serializers/models/organization.py
@@ -103,6 +103,8 @@ class DetailedOrganizationSerializer(OrganizationSerializer):
             feature_list.append('require-2fa')
         if features.has('organizations:environments', obj, actor=user):
             feature_list.append('environments')
+        if features.has('organizations:repos', obj, actor=user):
+            feature_list.append('repos')
 
         if getattr(obj.flags, 'allow_joinleave'):
             feature_list.append('open-membership')
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 691c58a98c..fef03c6317 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -740,6 +740,7 @@ SENTRY_FEATURES = {
     'auth:register': True,
     'organizations:api-keys': False,
     'organizations:create': True,
+    'organizations:repos': True,
     'organizations:sso': True,
     'organizations:sso-saml2': False,
     'organizations:sso-rippling': False,
diff --git a/src/sentry/static/sentry/app/components/organizations/homeSidebar.jsx b/src/sentry/static/sentry/app/components/organizations/homeSidebar.jsx
index 92a06de86b..46124a18aa 100644
--- a/src/sentry/static/sentry/app/components/organizations/homeSidebar.jsx
+++ b/src/sentry/static/sentry/app/components/organizations/homeSidebar.jsx
@@ -73,9 +73,10 @@ const OrgSettingsMenu = ({access, org, features}) => {
           access.has('org:integrations') && (
             <ListLink to={`${pathPrefix}/integrations/`}>{t('Integrations')}</ListLink>
           )}
-        {access.has('org:write') && (
-          <ListLink to={`${pathPrefix}/repos/`}>{t('Repositories')}</ListLink>
-        )}
+        {features.has('repos') &&
+          access.has('org:write') && (
+            <ListLink to={`${pathPrefix}/repos/`}>{t('Repositories')}</ListLink>
+          )}
         {access.has('org:write') && (
           <ListLink to={`${pathPrefix}/settings/`}>{t('Settings')}</ListLink>
         )}
