commit 3c57f5289bb875d113442b6eb3cc265547b2f740
Author: Matte Noble <me@mattenoble.com>
Date:   Mon Jun 17 14:03:21 2019 -0700

    fix(app-platform): ApiToken Cleanup Fix (#13712)
    
    Cleanup was failing due to foreign key constraints on ApiTokens that
    were associated with a SentryAppInstallation.
    
    It's okay if they stick around, so this just excludes them from the
    query to find all ApiTokens to delete.

diff --git a/src/sentry/runner/commands/cleanup.py b/src/sentry/runner/commands/cleanup.py
index 752efd0abe..54b86c0bd1 100644
--- a/src/sentry/runner/commands/cleanup.py
+++ b/src/sentry/runner/commands/cleanup.py
@@ -224,9 +224,18 @@ def cleanup(days, project, concurrency, silent, model, router, timed):
             if not silent:
                 click.echo(u'>> Skipping {}'.format(model.__name__))
         else:
-            model.objects.filter(
+            queryset = model.objects.filter(
                 expires_at__lt=(timezone.now() - timedelta(days=API_TOKEN_TTL_IN_DAYS)),
-            ).delete()
+            )
+
+            # SentryAppInstallations are associated to ApiTokens. We're okay
+            # with these tokens sticking around so that the Integration can
+            # refresh them, but all other non-associated tokens should be
+            # deleted.
+            if model is models.ApiToken:
+                queryset = queryset.filter(sentry_app_installation__isnull=True)
+
+            queryset.delete()
 
     project_id = None
     if project:
