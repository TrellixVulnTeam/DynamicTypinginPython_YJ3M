commit 3360d345ae623582d92394d746fd38e27310c3b6
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Mar 9 17:10:40 2015 -0700

    Switch all project endpoints to using slugs

diff --git a/src/sentry/api/bases/project.py b/src/sentry/api/bases/project.py
index 02031cb54c..be37539cf5 100644
--- a/src/sentry/api/bases/project.py
+++ b/src/sentry/api/bases/project.py
@@ -51,10 +51,11 @@ class ProjectEventPermission(ProjectPermission):
 class ProjectEndpoint(Endpoint):
     permission_classes = (ProjectPermission,)
 
-    def convert_args(self, request, project_id, *args, **kwargs):
+    def convert_args(self, request, organization_slug, project_slug, *args, **kwargs):
         try:
             project = Project.objects.get_from_cache(
-                id=project_id,
+                organization__slug=organization_slug,
+                slug=project_slug,
             )
         except Project.DoesNotExist:
             raise ResourceDoesNotExist
diff --git a/src/sentry/api/endpoints/legacy_project_redirect.py b/src/sentry/api/endpoints/legacy_project_redirect.py
new file mode 100644
index 0000000000..0a720a42b4
--- /dev/null
+++ b/src/sentry/api/endpoints/legacy_project_redirect.py
@@ -0,0 +1,43 @@
+from __future__ import absolute_import
+
+from django.http import HttpResponseRedirect
+
+from sentry.api.base import Endpoint
+from sentry.api.bases.project import ProjectPermission
+from sentry.api.exceptions import ResourceDoesNotExist
+from sentry.models import Project
+from sentry.utils.http import absolute_uri
+
+
+class LegacyProjectRedirectEndpoint(Endpoint):
+    permission_classes = (ProjectPermission,)
+
+    def convert_args(self, request, project_id, *args, **kwargs):
+        try:
+            project = Project.objects.get_from_cache(
+                id=project_id,
+            )
+        except Project.DoesNotExist:
+            raise ResourceDoesNotExist
+
+        self.check_object_permissions(request, project)
+
+        kwargs['project'] = project
+        return (args, kwargs)
+
+    def get(self, request, project, path):
+        """
+        Retrieve a project
+
+        Return details on an individual project.
+
+            {method} {path}
+
+        """
+        return HttpResponseRedirect(
+            absolute_uri('/api/0/projects/{}/{}/{}'.format(
+                project.organization.slug,
+                project.slug,
+                path or '',
+            ))
+        )
diff --git a/src/sentry/api/urls.py b/src/sentry/api/urls.py
index 523756d684..9ad509963d 100644
--- a/src/sentry/api/urls.py
+++ b/src/sentry/api/urls.py
@@ -17,6 +17,7 @@ from .endpoints.group_tagkey_values import GroupTagKeyValuesEndpoint
 from .endpoints.helppage_details import HelpPageDetailsEndpoint
 from .endpoints.helppage_index import HelpPageIndexEndpoint
 from .endpoints.index import IndexEndpoint
+from .endpoints.legacy_project_redirect import LegacyProjectRedirectEndpoint
 from .endpoints.organization_details import OrganizationDetailsEndpoint
 from .endpoints.organization_member_details import OrganizationMemberDetailsEndpoint
 from .endpoints.organization_index import OrganizationIndexEndpoint
@@ -95,32 +96,37 @@ urlpatterns = patterns(
         TeamStatsEndpoint.as_view(),
         name='sentry-api-0-team-stats'),
 
+    # Handles redirecting project_id => org_slug/project_slug
+    # TODO(dcramer): remove this after a reasonable period of time
+    url(r'^projects/(?P<project_id>\d+)/(?P<path>(?:groups|releases|stats|tags)/.+)?',
+        LegacyProjectRedirectEndpoint.as_view()),
+
     # Projects
-    url(r'^projects/(?P<project_id>\d+)/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/$',
         ProjectDetailsEndpoint.as_view(),
         name='sentry-api-0-project-details'),
-    url(r'^projects/(?P<project_id>\d+)/groups/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/groups/$',
         ProjectGroupIndexEndpoint.as_view(),
         name='sentry-api-0-project-group-index'),
-    url(r'^projects/(?P<project_id>\d+)/releases/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/releases/$',
         ProjectReleasesEndpoint.as_view(),
         name='sentry-api-0-project-releases'),
-    url(r'^projects/(?P<project_id>\d+)/releases/(?P<version>[^/]+)/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/releases/(?P<version>[^/]+)/$',
         ReleaseDetailsEndpoint.as_view(),
         name='sentry-api-0-release-details'),
-    url(r'^projects/(?P<project_id>\d+)/releases/(?P<version>[^/]+)/files/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/releases/(?P<version>[^/]+)/files/$',
         ReleaseFilesEndpoint.as_view(),
         name='sentry-api-0-release-files'),
-    url(r'^projects/(?P<project_id>\d+)/releases/(?P<version>[^/]+)/files/(?P<file_id>\d+)/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/releases/(?P<version>[^/]+)/files/(?P<file_id>\d+)/$',
         ReleaseFileDetailsEndpoint.as_view(),
         name='sentry-api-0-release-file-details'),
-    url(r'^projects/(?P<project_id>\d+)/stats/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/stats/$',
         ProjectStatsEndpoint.as_view(),
         name='sentry-api-0-project-stats'),
-    url(r'^projects/(?P<project_id>\d+)/tags/(?P<key>[^/]+)/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/tags/(?P<key>[^/]+)/$',
         ProjectTagKeyDetailsEndpoint.as_view(),
         name='sentry-api-0-project-tagkey-details'),
-    url(r'^projects/(?P<project_id>\d+)/tags/(?P<key>[^/]+)/values/$',
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/tags/(?P<key>[^/]+)/values/$',
         ProjectTagKeyValuesEndpoint.as_view(),
         name='sentry-api-0-project-tagkey-values'),
 
diff --git a/src/sentry/templates/sentry/groups/group_list.html b/src/sentry/templates/sentry/groups/group_list.html
index 2f89c4fe30..d7325f5cab 100644
--- a/src/sentry/templates/sentry/groups/group_list.html
+++ b/src/sentry/templates/sentry/groups/group_list.html
@@ -6,7 +6,7 @@
 {% load sentry_stream_filters %}
 
 {% block sidebar %}
-    <div id="chart" class="chart" data-api-url="{% url 'sentry-api-0-project-stats' project.id %}" data-days="1">
+    <div id="chart" class="chart" data-api-url="{% url 'sentry-api-0-project-stats' project.organization.slug project.slug %}" data-days="1">
         <div class="sparkline">
             <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
             <span class="loading">{% trans "Loading historical data..." %}</span>
diff --git a/tests/sentry/api/endpoints/test_project_details.py b/tests/sentry/api/endpoints/test_project_details.py
index 3a5bf895f3..6df0a18be8 100644
--- a/tests/sentry/api/endpoints/test_project_details.py
+++ b/tests/sentry/api/endpoints/test_project_details.py
@@ -12,7 +12,10 @@ class ProjectDetailsTest(APITestCase):
     def test_simple(self):
         project = self.project  # force creation
         self.login_as(user=self.user)
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
         response = self.client.get(url)
         assert response.status_code == 200
         assert response.data['id'] == str(project.id)
@@ -22,7 +25,10 @@ class ProjectUpdateTest(APITestCase):
     def test_simple(self):
         project = self.project  # force creation
         self.login_as(user=self.user)
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
         resp = self.client.put(url, data={
             'name': 'hello world',
             'slug': 'foobar',
@@ -35,7 +41,10 @@ class ProjectUpdateTest(APITestCase):
     def test_options(self):
         project = self.project  # force creation
         self.login_as(user=self.user)
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
         options = {
             'sentry:origins': 'foo\nbar',
             'sentry:resolve_age': 1,
@@ -60,7 +69,10 @@ class ProjectDeleteTest(APITestCase):
 
         self.login_as(user=self.user)
 
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
 
         with self.settings(SENTRY_PROJECT=0):
             response = self.client.delete(url)
@@ -78,7 +90,10 @@ class ProjectDeleteTest(APITestCase):
 
         self.login_as(user=self.user)
 
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
 
         with self.settings(SENTRY_PROJECT=project.id):
             response = self.client.delete(url)
diff --git a/tests/sentry/api/endpoints/test_project_group_index.py b/tests/sentry/api/endpoints/test_project_group_index.py
index a0309f923d..fbb660152a 100644
--- a/tests/sentry/api/endpoints/test_project_group_index.py
+++ b/tests/sentry/api/endpoints/test_project_group_index.py
@@ -15,7 +15,9 @@ class GroupListTest(APITestCase):
 
         self.login_as(user=self.user)
         url = reverse('sentry-api-0-project-group-index', kwargs={
-            'project_id': self.project.id})
+            'organization_slug': self.project.organization.slug,
+            'project_slug': self.project.slug,
+        })
         response = self.client.get(url + '?limit=1', format='json')
         assert response.status_code == 200
         # links come in {url: {...attrs}}, but we need {rel: {...attrs}}
@@ -39,7 +41,9 @@ class GroupUpdateTest(APITestCase):
 
         self.login_as(user=self.user)
         url = reverse('sentry-api-0-project-group-index', kwargs={
-            'project_id': self.project.id})
+            'organization_slug': self.project.organization.slug,
+            'project_slug': self.project.slug,
+        })
         response = self.client.put(url + '?status=unresolved', data={
             'status': 'resolved',
         }, format='json')
@@ -77,7 +81,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': self.project.organization.slug,
+                'project_slug': self.project.slug,
             }),
             group1=group1,
             group2=group2,
@@ -117,7 +122,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': self.project.organization.slug,
+                'project_slug': self.project.slug,
             }),
             group1=group1,
             group2=group2,
@@ -155,7 +161,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id,
+                'organization_slug': self.project.organization.slug,
+                'project_slug': self.project.slug,
             }),
             group1=group1,
             group2=group2,
@@ -191,7 +198,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&id={group3.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id,
+                'organization_slug': self.project.organization.slug,
+                'project_slug': self.project.slug,
             }),
             group1=group1,
             group2=group2,
@@ -214,7 +222,8 @@ class GroupDeleteTest(APITestCase):
     def test_global_is_forbidden(self):
         self.login_as(user=self.user)
         url = reverse('sentry-api-0-project-group-index', kwargs={
-            'project_id': self.project.id,
+            'organization_slug': self.project.organization.slug,
+            'project_slug': self.project.slug,
         })
         response = self.client.delete(url, data={
             'status': 'resolved',
@@ -232,7 +241,8 @@ class GroupDeleteTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': self.project.organization.slug,
+                'project_slug': self.project.slug,
             }),
             group1=group1,
             group2=group2,
diff --git a/tests/sentry/api/endpoints/test_project_releases.py b/tests/sentry/api/endpoints/test_project_releases.py
index 29fc3910ff..1b67ac787c 100644
--- a/tests/sentry/api/endpoints/test_project_releases.py
+++ b/tests/sentry/api/endpoints/test_project_releases.py
@@ -31,7 +31,8 @@ class ProjectReleaseListTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-project-releases', kwargs={
-            'project_id': project1.id,
+            'organization_slug': project1.organization.slug,
+            'project_slug': project1.slug,
         })
         response = self.client.get(url, format='json')
 
@@ -49,7 +50,8 @@ class ProjectReleaseCreateTest(APITestCase):
         project = self.create_project(team=team, name='foo')
 
         url = reverse('sentry-api-0-project-releases', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
         })
         response = self.client.post(url, data={
             'version': 'abcdef',
diff --git a/tests/sentry/api/endpoints/test_project_stats.py b/tests/sentry/api/endpoints/test_project_stats.py
index 8acdd133e4..e5d23d1401 100644
--- a/tests/sentry/api/endpoints/test_project_stats.py
+++ b/tests/sentry/api/endpoints/test_project_stats.py
@@ -17,7 +17,8 @@ class ProjectStatsTest(APITestCase):
         tsdb.incr(tsdb.models.project, project2.id, count=5)
 
         url = reverse('sentry-api-0-project-stats', kwargs={
-            'project_id': project1.id,
+            'organization_slug': project1.organization.slug,
+            'project_slug': project1.slug,
         })
         response = self.client.get(url, format='json')
 
diff --git a/tests/sentry/api/endpoints/test_project_tagkey_details.py b/tests/sentry/api/endpoints/test_project_tagkey_details.py
index aecb36a296..e15c06dd07 100644
--- a/tests/sentry/api/endpoints/test_project_tagkey_details.py
+++ b/tests/sentry/api/endpoints/test_project_tagkey_details.py
@@ -17,7 +17,8 @@ class ProjectTagKeyDeleteTest(APITestCase):
         self.login_as(user=self.user)
 
         url = reverse('sentry-api-0-project-tagkey-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'key': tagkey.key,
         })
 
diff --git a/tests/sentry/api/endpoints/test_project_tagkey_values.py b/tests/sentry/api/endpoints/test_project_tagkey_values.py
index 70d373440c..13e94b102a 100644
--- a/tests/sentry/api/endpoints/test_project_tagkey_values.py
+++ b/tests/sentry/api/endpoints/test_project_tagkey_values.py
@@ -15,7 +15,8 @@ class ProjectTagKeyValuesTest(APITestCase):
         self.login_as(user=self.user)
 
         url = reverse('sentry-api-0-project-tagkey-values', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'key': tagkey.key,
         })
 
diff --git a/tests/sentry/api/endpoints/test_release_details.py b/tests/sentry/api/endpoints/test_release_details.py
index 19fbfdf95f..5fbc482de9 100644
--- a/tests/sentry/api/endpoints/test_release_details.py
+++ b/tests/sentry/api/endpoints/test_release_details.py
@@ -17,7 +17,8 @@ class ReleaseDetailsTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
         })
         response = self.client.get(url)
@@ -47,7 +48,8 @@ class ReleaseDeleteTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
         })
         response = self.client.delete(url)
diff --git a/tests/sentry/api/endpoints/test_release_file_details.py b/tests/sentry/api/endpoints/test_release_file_details.py
index 16bd75c450..23bdeba749 100644
--- a/tests/sentry/api/endpoints/test_release_file_details.py
+++ b/tests/sentry/api/endpoints/test_release_file_details.py
@@ -29,7 +29,8 @@ class ReleaseFileDetailsTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-file-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
             'file_id': releasefile.id,
         })
@@ -63,7 +64,8 @@ class ReleaseFileUpdateTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-file-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
             'file_id': releasefile.id,
         })
@@ -102,7 +104,8 @@ class ReleaseFileDeleteTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-file-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
             'file_id': releasefile.id,
         })
diff --git a/tests/sentry/api/endpoints/test_release_files.py b/tests/sentry/api/endpoints/test_release_files.py
index fd10901527..67a1473d68 100644
--- a/tests/sentry/api/endpoints/test_release_files.py
+++ b/tests/sentry/api/endpoints/test_release_files.py
@@ -28,7 +28,8 @@ class ReleaseFilesListTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-files', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
         })
 
@@ -51,7 +52,8 @@ class ReleaseFileCreateTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-release-files', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'version': release.version,
         })
 
