commit 2e46ca92adf6650d5c0f4d003ec4157f94875053
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Feb 22 13:20:43 2013 -0800

    Use absolute_uri helper instead of build_absolute_uri

diff --git a/src/sentry/plugins/bases/issue.py b/src/sentry/plugins/bases/issue.py
index 5520189070..46e767580f 100644
--- a/src/sentry/plugins/bases/issue.py
+++ b/src/sentry/plugins/bases/issue.py
@@ -14,6 +14,7 @@ from django.utils.html import escape
 from django.utils.safestring import mark_safe
 from social_auth.models import UserSocialAuth
 from sentry.utils.auth import get_auth_providers
+from sentry.utils.http import absolute_uri
 
 
 class NewIssueForm(forms.Form):
@@ -42,7 +43,7 @@ class IssuePlugin(Plugin):
 
     def _get_group_description(self, request, group, event):
         output = [
-            request.build_absolute_uri(reverse('sentry-group', kwargs={
+            absolute_uri(reverse('sentry-group', kwargs={
                 'project_id': group.project.slug,
                 'team_slug': group.team.slug,
                 'group_id': group.id,
diff --git a/src/sentry/templates/sentry/account/identities.html b/src/sentry/templates/sentry/account/identities.html
index 4dae15678a..cbb64e8353 100644
--- a/src/sentry/templates/sentry/account/identities.html
+++ b/src/sentry/templates/sentry/account/identities.html
@@ -34,7 +34,9 @@
                 {% for identity in identity_list %}
                     <tr>
                         <td>{{ identity.provider|title }}</td>
-                        <td style="text-align: center;"><a href="{% url socialauth_disconnect_individual identity.provider identity.id %}?next={{ request.build_absolute_uri }}">Disconnect</a></td>
+                        <td style="text-align: center;">
+                            <a href="{% url socialauth_disconnect_individual identity.provider identity.id %}?next={% filter urlencode %}{% absolute_uri %}{% endfilter %}">Disconnect</a>
+                        </td>
                     </tr>
                 {% endfor %}
             </tbody>
@@ -46,7 +48,7 @@
         </fieldset>
         <ul class="auth-options">
             {% for engine in AUTH_PROVIDERS %}
-                <li><a href="{% url socialauth_associate_begin engine %}?next={{ request.build_absolute_uri }}" class="auth-{{ engine }}">Identify with {{ engine|title }}</a></li>
+                <li><a href="{% url socialauth_associate_begin engine %}?next={% filter urlencode %}{% absolute_uri %}{% endfilter %}" class="auth-{{ engine }}">Identify with {{ engine|title }}</a></li>
             {% endfor %}
         </ul>
     {% endif %}
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index 898d5d9c86..43bc96eb00 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -21,6 +21,7 @@ from sentry.models import Group
 from sentry.web.helpers import group_is_public
 from sentry.utils import to_unicode
 from sentry.utils.avatar import get_gravatar_url
+from sentry.utils.http import absolute_uri
 from sentry.utils.javascript import to_json
 from sentry.utils.safe import safe_execute
 from sentry.utils.strings import truncatechars
@@ -34,7 +35,9 @@ register = template.Library()
 truncatechars = register.filter(stringfilter(truncatechars))
 truncatechars.is_safe = True
 
-to_json = register.filter(to_json)
+register.filter(to_json)
+
+register.simple_tag(absolute_uri)
 
 
 @register.filter
diff --git a/src/sentry/utils/http.py b/src/sentry/utils/http.py
index 451d6e17d2..35ad6922ee 100644
--- a/src/sentry/utils/http.py
+++ b/src/sentry/utils/http.py
@@ -6,12 +6,18 @@ sentry.utils.http
 :license: BSD, see LICENSE for more details.
 """
 import urllib
-from urlparse import urlparse
+from urlparse import urlparse, urljoin
 
 from sentry.conf import settings
 from sentry.plugins.helpers import get_option
 
 
+def absolute_uri(url=None):
+    if not url:
+        return settings.SENTRY_URL_PREFIX
+    return urljoin(settings.SENTRY_URL_PREFIX, url)
+
+
 def safe_urlencode(params, doseq=0):
     """
     UTF-8-safe version of safe_urlencode
diff --git a/src/sentry/web/frontend/admin.py b/src/sentry/web/frontend/admin.py
index fadff5ae84..0bd03c8733 100644
--- a/src/sentry/web/frontend/admin.py
+++ b/src/sentry/web/frontend/admin.py
@@ -26,6 +26,7 @@ from sentry import environment
 from sentry.conf import settings
 from sentry.models import Project, GroupCountByMinute
 from sentry.plugins import plugins
+from sentry.utils.http import absolute_uri
 from sentry.web.forms import NewUserForm, ChangeUserForm, RemoveUserForm, TestEmailForm
 from sentry.web.decorators import requires_admin
 from sentry.web.helpers import render_to_response, plugin_config, \
@@ -144,7 +145,7 @@ def create_new_user(request):
             context = {
                 'username': user.username,
                 'password': password,
-                'url': request.build_absolute_uri(reverse('sentry')),
+                'url': absolute_uri(reverse('sentry')),
             }
             if form.cleaned_data['create_project']:
                 context.update({
