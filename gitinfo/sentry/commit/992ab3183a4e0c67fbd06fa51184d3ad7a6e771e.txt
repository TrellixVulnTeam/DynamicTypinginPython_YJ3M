commit 992ab3183a4e0c67fbd06fa51184d3ad7a6e771e
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jul 11 15:53:45 2013 +0200

    Reserve certain slugs so they cannot be used for teams (fixes GH-780)

diff --git a/src/sentry/constants.py b/src/sentry/constants.py
index b3a8c8d948..faa640aac0 100644
--- a/src/sentry/constants.py
+++ b/src/sentry/constants.py
@@ -169,3 +169,9 @@ MAX_EXTRA_VARIABLE_SIZE = 2048
 # individual item. In those cases we also want to limit the maximum number of
 # keys
 MAX_DICTIONARY_ITEMS = 50
+
+# Team slugs which may not be used. Generally these are top level URL patterns
+# which we don't want to worry about conflicts on.
+RESERVED_TEAM_SLUGS = (
+    'admin', 'manage', 'login', 'account', 'register', 'api',
+)
diff --git a/src/sentry/models.py b/src/sentry/models.py
index e1057077d5..b696d1041a 100644
--- a/src/sentry/models.py
+++ b/src/sentry/models.py
@@ -38,7 +38,7 @@ from sentry.constants import (
     STATUS_LEVELS, MEMBER_TYPES,
     MEMBER_OWNER, MEMBER_USER, PLATFORM_TITLES, PLATFORM_LIST,
     STATUS_UNRESOLVED, STATUS_RESOLVED, STATUS_VISIBLE, STATUS_HIDDEN,
-    MINUTE_NORMALIZATION, STATUS_MUTED)
+    MINUTE_NORMALIZATION, STATUS_MUTED, RESERVED_TEAM_SLUGS)
 from sentry.manager import (
     GroupManager, ProjectManager,
     MetaManager, InstanceMetaManager, SearchDocumentManager, BaseManager,
@@ -57,10 +57,12 @@ from sentry.utils.strings import truncatechars
 __all__ = ('Event', 'Group', 'Project', 'SearchDocument')
 
 
-def slugify_instance(inst, label, **kwargs):
+def slugify_instance(inst, label, reserved=(), **kwargs):
     base_slug = slugify(label)
+    if base_slug in reserved:
+        base_slug = None
     if not base_slug:
-        base_slug = 'default_%s' % (uuid.uuid4())
+        base_slug = uuid.uuid4().hex[:12]
     manager = type(inst).objects
     inst.slug = base_slug
     n = 0
@@ -134,7 +136,7 @@ class Team(Model):
 
     def save(self, *args, **kwargs):
         if not self.slug:
-            slugify_instance(self, self.name)
+            slugify_instance(self, self.name, reserved=RESERVED_TEAM_SLUGS)
         super(Team, self).save(*args, **kwargs)
 
     def get_owner_name(self):
diff --git a/src/sentry/web/forms/teams.py b/src/sentry/web/forms/teams.py
index c226cac4d4..e3a3a2e98a 100644
--- a/src/sentry/web/forms/teams.py
+++ b/src/sentry/web/forms/teams.py
@@ -8,7 +8,7 @@ sentry.web.forms.teams
 from django import forms
 from django.utils.translation import ugettext_lazy as _
 
-from sentry.constants import MEMBER_TYPES
+from sentry.constants import MEMBER_TYPES, RESERVED_TEAM_SLUGS
 from sentry.models import Team, TeamMember, PendingTeamMember, AccessGroup, Project
 from sentry.web.forms.fields import UserField, get_team_choices
 
@@ -47,6 +47,12 @@ class EditTeamAdminForm(EditTeamForm):
         fields = ('name', 'slug', 'owner',)
         model = Team
 
+    def clean_slug(self):
+        value = self.cleaned_data['slug']
+        if value in RESERVED_TEAM_SLUGS:
+            raise forms.ValidationError('You may not use "%s" as a slug' % (value,))
+        return value
+
 
 class SelectTeamForm(forms.Form):
     team = forms.TypedChoiceField(choices=(), coerce=int)
