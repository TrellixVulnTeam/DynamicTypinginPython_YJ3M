commit 8dc4fc12370ad1eb92f27dd874cdb9e124f41d5f
Author: Mark Story <mark@sentry.io>
Date:   Wed Jun 19 17:23:43 2019 -0400

    Revert "fix(bitbucket) Handle users with no username. (#13727)" (#13742)
    
    This reverts commit 0f7bf90bb5f910a4f79d62a8835a408c109f7be8.

diff --git a/src/sentry/integrations/bitbucket/integration.py b/src/sentry/integrations/bitbucket/integration.py
index 46a763684b..bd25df3d8b 100644
--- a/src/sentry/integrations/bitbucket/integration.py
+++ b/src/sentry/integrations/bitbucket/integration.py
@@ -173,7 +173,7 @@ class BitbucketIntegrationProvider(IntegrationProvider):
             return {
                 'provider': self.key,
                 'external_id': state['clientKey'],
-                'name': principal_data.get('display_name', 'Unnamed User'),
+                'name': principal_data['username'],
                 'metadata': {
                     'public_key': state['publicKey'],
                     'shared_secret': state['sharedSecret'],
diff --git a/tests/sentry/integrations/bitbucket/test_installed.py b/tests/sentry/integrations/bitbucket/test_installed.py
index a2136b1f66..a2a786bca7 100644
--- a/tests/sentry/integrations/bitbucket/test_installed.py
+++ b/tests/sentry/integrations/bitbucket/test_installed.py
@@ -18,6 +18,7 @@ class BitbucketInstalledEndpointTest(APITestCase):
         self.provider = 'bitbucket'
         self.path = '/extensions/bitbucket/installed/'
 
+        self.username = u'sentryuser'
         self.client_key = u'connection:123'
         self.public_key = u'123abcDEFg'
         self.shared_secret = u'G12332434SDfsjkdfgsd'
@@ -27,6 +28,7 @@ class BitbucketInstalledEndpointTest(APITestCase):
         self.icon = u'https://bitbucket.org/account/sentryuser/avatar/32/'
 
         self.user_data = {
+            u'username': self.username,
             u'display_name': self.display_name,
             u'account_id': u'123456t256371u',
             u'links': {
@@ -89,7 +91,7 @@ class BitbucketInstalledEndpointTest(APITestCase):
             provider=self.provider,
             external_id=self.client_key
         )
-        assert integration.name == self.display_name
+        assert integration.name == self.username
         assert integration.metadata == self.metadata
 
     @responses.activate
@@ -204,7 +206,7 @@ class BitbucketInstalledEndpointTest(APITestCase):
             provider=self.provider,
             external_id=self.client_key,
             defaults={
-                'name': self.display_name,
+                'name': self.username,
                 'metadata': self.metadata,
             }
         )[0]
