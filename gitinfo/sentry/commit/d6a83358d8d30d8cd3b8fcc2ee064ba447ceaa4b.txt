commit d6a83358d8d30d8cd3b8fcc2ee064ba447ceaa4b
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Feb 13 02:54:14 2013 -0800

    Clean up some logic with intervals in alerts

diff --git a/src/sentry/tasks/check_alerts.py b/src/sentry/tasks/check_alerts.py
index 06ac20d1ad..f3e3ff4c88 100644
--- a/src/sentry/tasks/check_alerts.py
+++ b/src/sentry/tasks/check_alerts.py
@@ -70,14 +70,14 @@ def check_alerts(**kwargs):
 
     now = timezone.now()
     # we want at least a 60 second window of events
-    min_date = now - timedelta(minutes=MINUTE_NORMALIZATION + 1)
-    max_date = min_date + timedelta(minutes=MINUTE_NORMALIZATION)
+    max_date = now - timedelta(minutes=1)
+    min_date = max_date - timedelta(minutes=MINUTE_NORMALIZATION)
 
     # find each project which has data for the last interval
     # TODO: we could force more work on the db by eliminating onces which dont have the full aggregate we need
     qs = ProjectCountByMinute.objects.filter(
-        date__gt=min_date,
         date__lte=max_date,
+        date__gt=min_date,
         times_seen__gt=0,
     ).values_list('project_id', 'date', 'times_seen')
     for project_id, date, count in qs:
@@ -113,14 +113,14 @@ def check_project_alerts(project_id, when, count, **kwargs):
     # number of 15 minute intervals to capture
     intervals = 8
 
-    min_date = when - timedelta(minutes=MINUTE_NORMALIZATION)
-    max_date = min_date - timedelta(minutes=(intervals * MINUTE_NORMALIZATION))
+    max_date = when - timedelta(minutes=MINUTE_NORMALIZATION)
+    min_date = max_date - timedelta(minutes=(intervals * MINUTE_NORMALIZATION))
 
     # get historical data
     data = list(ProjectCountByMinute.objects.filter(
         project=project_id,
-        date__lte=min_date,
-        date__gt=max_date,
+        date__lte=max_date,
+        date__gt=min_date,
     ).values_list('times_seen', flat=True))
 
     # Bail if we dont have enough data points
diff --git a/tests/sentry/tasks/check_alerts/tests.py b/tests/sentry/tasks/check_alerts/tests.py
index fa24c40f79..47ae64aee8 100644
--- a/tests/sentry/tasks/check_alerts/tests.py
+++ b/tests/sentry/tasks/check_alerts/tests.py
@@ -34,7 +34,7 @@ class CheckAlertsTest(BaseTestCase):
         maybe_delay.assert_called_once_with(
             check_project_alerts,
             project_id=self.project.id,
-            when=when,
+            when=when - timedelta(minutes=16),
             count=10,
             expires=120
         )
