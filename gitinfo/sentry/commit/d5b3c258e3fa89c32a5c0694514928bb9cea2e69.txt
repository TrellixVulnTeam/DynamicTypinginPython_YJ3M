commit d5b3c258e3fa89c32a5c0694514928bb9cea2e69
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Fri Feb 14 08:46:06 2020 -0800

    feat(workflow): Update Alert email with correct environments (#17033)
    
    Previously was just a placeholder

diff --git a/src/sentry/incidents/action_handlers.py b/src/sentry/incidents/action_handlers.py
index cc880ed41d..b99f26415f 100644
--- a/src/sentry/incidents/action_handlers.py
+++ b/src/sentry/incidents/action_handlers.py
@@ -109,6 +109,10 @@ class EmailActionHandler(ActionHandler):
         # if resolve threshold and threshold type is *BELOW* then show '>'
         # we can simplify this to be the below statement
         show_greater_than_string = is_active == is_threshold_type_above
+        environments = list(alert_rule.environment.all())
+        environment_string = (
+            ", ".join(sorted([env.name for env in environments])) if len(environments) else "All"
+        )
 
         return {
             "link": absolute_uri(
@@ -131,8 +135,7 @@ class EmailActionHandler(ActionHandler):
                 )
             ),
             "incident_name": self.incident.title,
-            # TODO(alerts): Add environment
-            "environment": "All",
+            "environment": environment_string,
             "time_window": format_duration(alert_rule.time_window),
             "triggered_at": trigger.date_added,
             "aggregate": self.query_aggregations_display[QueryAggregations(alert_rule.aggregation)],
diff --git a/src/sentry/testutils/factories.py b/src/sentry/testutils/factories.py
index 44bc86da93..fe68a3ea33 100644
--- a/src/sentry/testutils/factories.py
+++ b/src/sentry/testutils/factories.py
@@ -748,6 +748,7 @@ class Factories(object):
         date_closed=None,
         groups=None,
         seen_by=None,
+        alert_rule=None,
     ):
         if not title:
             title = petname.Generate(2, " ", letters=10).title()
@@ -758,6 +759,7 @@ class Factories(object):
             status=status,
             title=title,
             query=query,
+            alert_rule=alert_rule,
             date_started=date_started or timezone.now(),
             date_detected=date_detected or timezone.now(),
             date_closed=date_closed or timezone.now(),
@@ -788,6 +790,7 @@ class Factories(object):
         time_window=10,
         threshold_period=1,
         include_all_projects=False,
+        environment=None,
         excluded_projects=None,
         date_added=None,
     ):
@@ -802,6 +805,7 @@ class Factories(object):
             aggregation,
             time_window,
             threshold_period,
+            environment=environment,
             include_all_projects=include_all_projects,
             excluded_projects=excluded_projects,
         )
diff --git a/tests/sentry/incidents/test_action_handlers.py b/tests/sentry/incidents/test_action_handlers.py
index 3e6ec41eaf..dd20d5af03 100644
--- a/tests/sentry/incidents/test_action_handlers.py
+++ b/tests/sentry/incidents/test_action_handlers.py
@@ -122,6 +122,19 @@ class EmailActionHandlerGenerateEmailContextTest(TestCase):
         }
         assert expected == handler.generate_email_context(status)
 
+    def test_environment(self):
+        status = TriggerStatus.ACTIVE
+        environments = [
+            self.create_environment(project=self.project, name="prod"),
+            self.create_environment(project=self.project, name="dev"),
+        ]
+        alert_rule = self.create_alert_rule(environment=environments)
+        alert_rule_trigger = self.create_alert_rule_trigger(alert_rule=alert_rule)
+        action = self.create_alert_rule_trigger_action(alert_rule_trigger=alert_rule_trigger)
+        incident = self.create_incident()
+        handler = EmailActionHandler(action, incident, self.project)
+        assert "dev, prod" == handler.generate_email_context(status).get("environment")
+
 
 @freeze_time()
 class EmailActionHandlerFireTest(TestCase):
