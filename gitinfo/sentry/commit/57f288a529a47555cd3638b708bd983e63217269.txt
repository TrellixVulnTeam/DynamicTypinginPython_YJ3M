commit 57f288a529a47555cd3638b708bd983e63217269
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Oct 12 16:02:19 2015 -0700

    Yet another attempt at transactions

diff --git a/src/sentry/migrations/0204_backfill_team_membership.py b/src/sentry/migrations/0204_backfill_team_membership.py
index 816665c7d5..35d3d4d8af 100644
--- a/src/sentry/migrations/0204_backfill_team_membership.py
+++ b/src/sentry/migrations/0204_backfill_team_membership.py
@@ -2,7 +2,7 @@
 from south.utils import datetime_utils as datetime
 from south.db import db
 from south.v2 import DataMigration
-from django.db import IntegrityError, models
+from django.db import IntegrityError, models, transaction
 
 class Migration(DataMigration):
 
@@ -21,11 +21,18 @@ class Migration(DataMigration):
             for member in members:
                 for team in teams:
                     # XXX(dcramer): South doesnt like us using transactions here
-                    OrganizationMemberTeam.objects.get_or_create(
-                        team=team,
-                        organizationmember=member,
-                        is_active=True,
-                    )
+                    try:
+                        sid = transaction.savepoint()
+                        OrganizationMemberTeam.objects.create(
+                            team=team,
+                            organizationmember=member,
+                            is_active=True,
+                        )
+                    except IntegrityError:
+                        transaction.savepoint_rollback(sid)
+                    else:
+                        transaction.savepoint_commit(sid)
+                    transaction.commit()
 
     def backwards(self, orm):
         pass
