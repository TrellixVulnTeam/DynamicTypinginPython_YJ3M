commit 08a601ad002f1e3e9792d64fd527ae0fbc7f26e2
Author: Dan Fuller <dfuller@sentry.io>
Date:   Wed Mar 11 10:30:06 2020 -0700

    fix(incidents): Respect user email opt out for team actions, but not user actions.
    
    Got this in reverse for https://app.asana.com/0/1143295291839284/1154511107157496

diff --git a/src/sentry/incidents/action_handlers.py b/src/sentry/incidents/action_handlers.py
index 4501ff9fda..667fa66f5f 100644
--- a/src/sentry/incidents/action_handlers.py
+++ b/src/sentry/incidents/action_handlers.py
@@ -62,14 +62,17 @@ class EmailActionHandler(ActionHandler):
             AlertRuleTriggerAction.TargetType.TEAM.value,
         ):
             if self.action.target_type == AlertRuleTriggerAction.TargetType.USER.value:
+                targets = [(target.id, target.email)]
+            elif self.action.target_type == AlertRuleTriggerAction.TargetType.TEAM.value:
                 alert_settings = self.project.get_member_alert_settings("mail:alert")
                 disabled_users = set(
                     user_id for user_id, setting in alert_settings.items() if setting == 0
                 )
-                if target.id not in disabled_users:
-                    targets = [(target.id, target.email)]
-            elif self.action.target_type == AlertRuleTriggerAction.TargetType.TEAM.value:
-                targets = target.member_set.values_list("user_id", "user__email")
+                targets = [
+                    (user_id, email)
+                    for user_id, email in target.member_set.values_list("user_id", "user__email")
+                    if user_id not in disabled_users
+                ]
         # TODO: We need some sort of verification system to make sure we're not being
         # used as an email relay.
         # elif self.action.target_type == AlertRuleTriggerAction.TargetType.SPECIFIC.value:
diff --git a/tests/sentry/incidents/test_action_handlers.py b/tests/sentry/incidents/test_action_handlers.py
index cb2df7fe36..104b38b6d1 100644
--- a/tests/sentry/incidents/test_action_handlers.py
+++ b/tests/sentry/incidents/test_action_handlers.py
@@ -47,7 +47,7 @@ class EmailActionHandlerGetTargetsTest(TestCase):
             target_identifier=six.text_type(self.user.id),
         )
         handler = EmailActionHandler(action, self.incident, self.project)
-        assert handler.get_targets() == []
+        assert handler.get_targets() == [(self.user.id, self.user.email)]
 
     def test_team(self):
         new_user = self.create_user()
@@ -73,9 +73,7 @@ class EmailActionHandlerGetTargetsTest(TestCase):
             target_identifier=six.text_type(self.team.id),
         )
         handler = EmailActionHandler(action, self.incident, self.project)
-        assert set(handler.get_targets()) == set(
-            [(self.user.id, self.user.email), (new_user.id, new_user.email)]
-        )
+        assert set(handler.get_targets()) == set([(new_user.id, new_user.email)])
 
 
 @freeze_time()
