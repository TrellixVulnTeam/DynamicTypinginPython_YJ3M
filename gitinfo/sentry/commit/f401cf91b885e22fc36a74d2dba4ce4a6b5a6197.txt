commit f401cf91b885e22fc36a74d2dba4ce4a6b5a6197
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Apr 30 14:12:26 2018 -0700

    fix(auth): Ratelimit 2FA login attempts

diff --git a/src/sentry/web/frontend/twofactor.py b/src/sentry/web/frontend/twofactor.py
index 527caceb6b..7feec389d3 100644
--- a/src/sentry/web/frontend/twofactor.py
+++ b/src/sentry/web/frontend/twofactor.py
@@ -7,6 +7,7 @@ from django.http import HttpResponseRedirect, HttpResponse
 from django.utils.translation import ugettext as _
 
 from sentry import options
+from sentry.app import ratelimiter
 from sentry.web.frontend.base import BaseView
 from sentry.web.forms.accounts import TwoFactorForm
 from sentry.web.helpers import render_to_response
@@ -111,6 +112,20 @@ class TwoFactorAuthView(BaseView):
 
         challenge = activation = None
         interface = self.negotiate_interface(request, interfaces)
+
+        if request.method == 'POST' and ratelimiter.is_limited(
+            u'auth-2fa:user:{}'.format(user.id),
+            limit=5,
+            window=60,
+        ):
+            # TODO: Maybe email the account owner or do something to notify someone
+            # This would probably be good for them to know.
+            return HttpResponse(
+                'You have made too many 2FA attempts. Please try again later.',
+                content_type='text/plain',
+                status=429,
+            )
+
         if request.method == 'GET':
             activation = interface.activate(request)
             if activation is not None and activation.type == 'challenge':
