commit 9443382f5b6f9fd9c2a331053ab0c6cdfff87a45
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jan 8 10:53:13 2012 -0800

    More API refactoring

diff --git a/sentry/static/scripts/global.js b/sentry/static/scripts/global.js
index 8fe3959860..42fb1352b6 100644
--- a/sentry/static/scripts/global.js
+++ b/sentry/static/scripts/global.js
@@ -27,8 +27,8 @@ if (Sentry === undefined) {
     var self = Sentry;
 
     Sentry.options = {
+        urlPrefix: '',
         mediaUrl: '/media/',
-        urlMap: {},
         defaultImage: '/media/images/sentry.png'
     };
 
@@ -39,10 +39,10 @@ if (Sentry === undefined) {
     };
 
     Sentry.stream = {};
-    Sentry.stream.clear = function() {
+    Sentry.stream.clear = function(project_id) {
         if (confirm("Are you sure you want to mark all your stream as resolved?")) {
             $.ajax({
-                url: Sentry.options.urlMap.clear,
+                url: Sentry.options.urlPrefix + '/api/' + project_id + '/clear',
                 type: 'post',
                 dataType: 'json',
                 success: function(groups){
@@ -51,12 +51,12 @@ if (Sentry === undefined) {
             });
         }
     };
-    Sentry.stream.resolve = function(gid, remove){
+    Sentry.stream.resolve = function(project_id, gid, remove){
         if (typeof(remove) == 'undefined') {
             remove = true;
         }
         $.ajax({
-            url: Sentry.options.urlMap.resolve,
+            url: Sentry.options.urlPrefix + '/api/' + project_id + '/resolve',
             type: 'post',
             dataType: 'json',
             data: {
@@ -75,9 +75,9 @@ if (Sentry === undefined) {
             }
         });
     };
-    Sentry.stream.bookmark = function(gid){
+    Sentry.stream.bookmark = function(project_id, gid){
         $.ajax({
-            url: Sentry.options.urlMap.bookmark,
+            url: Sentry.options.urlPrefix + '/api/' + project_id + '/bookmark',
             type: 'post',
             dataType: 'json',
             data: {
@@ -124,7 +124,7 @@ if (Sentry === undefined) {
         data = getQueryParams();
         data.view_id = Sentry.realtime.options.viewId || undefined;
         $.ajax({
-            url: Sentry.options.urlMap.poll,
+            url: Sentry.options.urlPrefix + '/api/' + self.options.projectId + '/poll',
             type: 'get',
             dataType: 'json',
             data: data,
@@ -135,7 +135,7 @@ if (Sentry === undefined) {
                 for (var i=groups.length-1, el, row; (el=groups[i]); i--) {
                     var id = el[0];
                     var data = el[1];
-                    var url = Sentry.options.urlMap.notification + '?' + $.param({
+                    var url = Sentry.options.urlPrefix + '/api/notification?' + $.param({
                         count: data.count,
                         title: data.title,
                         message: data.message,
@@ -170,6 +170,59 @@ if (Sentry === undefined) {
         });
     };
 
+    Sentry.charts = {};
+    Sentry.charts.render = function(el, project_id, group_id, grid){
+        var $sparkline = $(el);
+        $.ajax({
+            url: Sentry.options.urlPrefix + '/api/' + project_id + '/chart',
+            type: 'get',
+            dataType: 'json',
+            data: {
+                days: 1,
+                gid: group_id || undefined
+            },
+            success: function(data){
+                if (!data.length) {
+                    return;
+                }
+
+                var start = new Date().getTime() - data.length * 3600000;
+                var pairs = [];
+                // for (var i=0; i<1000; i++) {
+                //     pairs.push([start + (3600 * 1000) * i, Math.random()*1000]);
+                // }
+                for (var i=0; i<data.length; i++) {
+                    pairs.push([start + (3600 * 1000) * i, data[i]]);
+                }
+                $sparkline.height($sparkline.parent().height());
+                $.plot($sparkline, [
+                    {
+                        data: pairs,
+                        color: '#3079d0',
+                        shadowSize: 0,
+                        lines: {
+                            lineWidth: 1,
+                            show: true,
+                            fill: true
+                        }
+                    }
+                ], {
+                    xaxis: {
+                       mode: "time"
+                    },
+                    grid: {
+                        show: grid || false,
+                        borderColor: '#dddddd',
+                        borderWidth: 1,
+                        backgroundColor: '#F5F5F5'
+                    },
+                    lines: { show: false }
+
+                });
+            }
+        });
+    };
+
     Sentry.notifications = {};
     Sentry.notifications.status = false;
 
@@ -287,4 +340,22 @@ $(document).ajaxSend(function(event, xhr, settings) {
     if (!safeMethod(settings.type) && sameOrigin(settings.url)) {
         xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
     }
+});
+
+$('.popup').click(function(){
+    var $this = $(this);
+    var $window = $(window);
+    var $container = $($this.attr('data-container'));
+    var title = $this.attr('data-title') || 'Untitled';
+    var content = $container.html();
+    var height = Math.min($window.height() - 100, $container.height() + 40);
+    var width = Math.min($window.width() - 100, $container.width() + 40);
+    var w = window.open("about:blank", "dsqApiExpand", "toolbar=0,status=0,location=0,menubar=0,height=" + height + ",width=" + width);
+    w.document.write("<!DOCTYPE html><html>" +
+        "<head>" +
+            "<title>" + title + "</title>" +
+            "<link href=\"" + Sentry.options.popupCss + "\" rel=\"stylesheet\" type=\"text/css\"/>" +
+        "</head><body>" +
+            "<div id=\"popup\">" + content + "</div></body>" +
+        "</html>");
 });
\ No newline at end of file
diff --git a/sentry/static/styles/bootstrap.css b/sentry/static/styles/bootstrap.css
index 0d9b0bcc42..8e1926bc79 100644
--- a/sentry/static/styles/bootstrap.css
+++ b/sentry/static/styles/bootstrap.css
@@ -6,7 +6,7 @@
  * http://www.apache.org/licenses/LICENSE-2.0
  *
  * Designed and built with all the love in the world @twitter by @mdo and @fat.
- * Date: Sat Jan  7 01:49:48 PST 2012
+ * Date: Sun Jan  8 10:52:54 PST 2012
  */
 /* Reset.less
  * Props to Eric Meyer (meyerweb.com) for his CSS reset file. We're using an adapted version here	that cuts out some of the reset HTML elements we will never need here (i.e., dfn, samp, etc).
diff --git a/sentry/templates/sentry/groups/details.html b/sentry/templates/sentry/groups/details.html
index 0dab42fe77..34a5cd5887 100644
--- a/sentry/templates/sentry/groups/details.html
+++ b/sentry/templates/sentry/groups/details.html
@@ -103,7 +103,7 @@
                 <div class="page-header">
                     <h2>{% trans "Frequency" %}</h2>
                 </div>
-                <div class="module-content">
+                <div class="module-content" style="height: 120px;">
                     <div id="chart">
                         <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
                         <p>Loading...</p>
@@ -180,67 +180,8 @@
 
 {% block content_after %}
     <script type="text/javascript">
-    $('.popup').click(function(){
-        var $this = $(this);
-        var $window = $(window);
-        var $container = $($this.attr('data-container'));
-        var title = $this.attr('data-title') || 'Untitled';
-        var content = $container.html();
-        var height = Math.min($window.height() - 100, $container.height() + 40);
-        var width = Math.min($window.width() - 100, $container.width() + 40);
-        var w = window.open("about:blank", "dsqApiExpand", "toolbar=0,status=0,location=0,menubar=0,height=" + height + ",width=" + width);
-        w.document.write("<!DOCTYPE html><html><title>" + title + "</title><head><link href=\"{% url sentry-media "styles/popup.css" %}\" rel=\"stylesheet\" type=\"text/css\"/></head><body><div id=\"popup\">" + content + "</div></body></html>");
-    });
     $(document).ready(function() {
-        if (!$('#chart').length) return;
-
-        $.ajax({
-            url: Sentry.options.urlMap.char,
-            type: 'post',
-            dataType: 'json',
-            data: {
-                gid: '{{ group.id }}'
-            },
-            success: function(data){
-                if (!data.length) {
-                    $('#chart').html('No data currently available.');
-                    return;
-                }
-
-                var start = new Date().getTime() - data.length * 3600000;
-                var pairs = [];
-                // for (var i=0; i<1000; i++) {
-                //     pairs.push([start + (3600 * 1000) * i, Math.random()*1000]);
-                // }
-                for (var i=0; i<data.length; i++) {
-                    pairs.push([start + (3600 * 1000) * i, data[i]]);
-                }
-                $('#chart').height(120);
-                $.plot($("#chart"), [
-                    {
-                        data: pairs,
-                        color: '#3079d0',
-                        shadowSize: 0,
-                        lines: {
-                            lineWidth: 1,
-                            show: true,
-                            fill: true
-                        },
-                    }
-                ], {
-                    xaxis: {
-                       mode: "time"
-                    },
-                    grid: {
-                        borderColor: '#dddddd',
-                        borderWidth: 1,
-                        backgroundColor: '#F5F5F5'
-                    },
-                    lines: { show: false }
-
-                });
-            }
-        });
+        Sentry.charts.render("#chart", {{ group.project.id }}, {{ group.id }}, true);
     });
     </script>
 {% endblock %}
\ No newline at end of file
diff --git a/sentry/templates/sentry/groups/group_list.html b/sentry/templates/sentry/groups/group_list.html
index 10c9a85208..5f659d3bc8 100644
--- a/sentry/templates/sentry/groups/group_list.html
+++ b/sentry/templates/sentry/groups/group_list.html
@@ -113,52 +113,7 @@
 {% block content_after %}
     <script type="text/javascript">
     $(document).ready(function() {
-        $sparkline = $('#sparkline');
-        $.ajax({
-            url: Sentry.options.urlMap.chart,
-            type: 'get',
-            dataType: 'json',
-            data: {
-                days: 1
-            },
-            success: function(data){
-                if (!data.length) {
-                    return;
-                }
-
-                var start = new Date().getTime() - data.length * 3600000;
-                var pairs = [];
-                // for (var i=0; i<1000; i++) {
-                //     pairs.push([start + (3600 * 1000) * i, Math.random()*1000]);
-                // }
-                for (var i=0; i<data.length; i++) {
-                    pairs.push([start + (3600 * 1000) * i, data[i]]);
-                }
-                $sparkline.height($sparkline.parent().height());
-                $.plot($sparkline, [
-                    {
-                        data: pairs,
-                        color: '#3079d0',
-                        shadowSize: 0,
-                        lines: {
-                            lineWidth: 1,
-                            show: true,
-                            fill: true
-                        },
-                    }
-                ], {
-                    xaxis: {
-                       mode: "time"
-                    },
-                    grid: {
-                        show: false,
-                        backgroundColor: '#F5F5F5'
-                    },
-                    lines: { show: false }
-
-                });
-            }
-        });
+        Sentry.charts.render("#sparkline", {{ project.id }});
     });
     </script>
 {% endblock %}
\ No newline at end of file
diff --git a/sentry/templates/sentry/layout.html b/sentry/templates/sentry/layout.html
index 6d75c9b406..d4c1466cf9 100644
--- a/sentry/templates/sentry/layout.html
+++ b/sentry/templates/sentry/layout.html
@@ -31,22 +31,12 @@
         <script type="text/javascript" src="{% url sentry-media "scripts/global.js" %}"></script>
         <script type="text/javascript">
         Sentry.config({
+            urlPrefix: '{{ URL_PREFIX }}',
             mediaUrl: '{% url sentry-media '' %}',
             defaultImage: '{% url sentry-media 'images/sentry.png' %}'
+            popupCss: '{% url sentry-media 'styles/popup.css' %}'
         });
-        {% if project %}
-        Sentry.config({
-            urlMap: {
-                notification: '{% url sentry-api-notification project.pk %}',
-                resolve: '{% url sentry-api-resolve project.pk %}',
-                clear: '{% url sentry-api-clear project.pk %}',
-                poll: '{% url sentry-api-poll project.pk %}',
-                bookmark: '{% url sentry-api-bookmark project.pk %}',
-                chart: '{% url sentry-api-chart project.pk %}',
-            }
-        });
-        {% endif %}
-            </script>
+        </script>
 
         {% block meta %}
         {% endblock %}
diff --git a/sentry/templates/sentry/partial/_group.html b/sentry/templates/sentry/partial/_group.html
index d23f500ecf..01bcbfacb3 100644
--- a/sentry/templates/sentry/partial/_group.html
+++ b/sentry/templates/sentry/partial/_group.html
@@ -23,11 +23,11 @@
     <ul class="actions">
         <li>
             {% if group.status == 0 %}
-                <a href="javascript:void(0)" onclick="Sentry.stream.resolve({{ group.pk|safe }});" class="btn small">&#10003;</a>
+                <a href="javascript:void(0)" onclick="Sentry.stream.resolve({{ group.project_id|safe }}, {{ group.pk|safe }});" class="btn small">&#10003;</a>
             {% else %}
                 <a href="javascript:void(0)" class="btn disabled small">&#10003;</a>
             {% endif %}
         </li>
-        <li><a href="javascript:void(0)" onclick="Sentry.stream.bookmark({{ group.pk|safe }});" class="btn small">&#9829;</a></li>
+        <li><a href="javascript:void(0)" onclick="Sentry.stream.bookmark({{ group.project_id|safe }}, {{ group.pk|safe }});" class="btn small">&#9829;</a></li>
     </ul>
 </li>
diff --git a/sentry/web/helpers.py b/sentry/web/helpers.py
index bf83905d96..4470c54a5c 100644
--- a/sentry/web/helpers.py
+++ b/sentry/web/helpers.py
@@ -85,6 +85,7 @@ def render_to_string(template, context=None, request=None):
         'MESSAGES_PER_PAGE': settings.MESSAGES_PER_PAGE,
         'PROJECT_ID': settings.PROJECT,
         'VIEWS': list(View.objects.all()),
+        'URL_PREFIX': settings.URL_PREFIX,
     })
 
     if request:
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index 744f010302..2e5331714f 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -74,12 +74,12 @@ urlpatterns = patterns('',
 
     # JS
 
-    url(r'^(?P<project_id>\d+)/api/notification/$', api.notification, name='sentry-api-notification'),
-    url(r'^(?P<project_id>\d+)/api/poll/$', api.poll, name='sentry-api-poll'),
-    url(r'^(?P<project_id>\d+)/api/resolve/$', api.resolve, name='sentry-api-resolve'),
-    url(r'^(?P<project_id>\d+)/api/bookmark/$', api.bookmark, name='sentry-api-bookmark'),
-    url(r'^(?P<project_id>\d+)/api/clear/$', api.clear, name='sentry-api-clear'),
-    url(r'^(?P<project_id>\d+)/api/chart/$', api.chart, name='sentry-api-chart'),
+    url(r'^api/notification/$', api.notification, name='sentry-api-notification'),
+    url(r'^api/(?P<project_id>\d+)/poll/$', api.poll, name='sentry-api-poll'),
+    url(r'^api/(?P<project_id>\d+)/resolve/$', api.resolve, name='sentry-api-resolve'),
+    url(r'^api/(?P<project_id>\d+)/bookmark/$', api.bookmark, name='sentry-api-bookmark'),
+    url(r'^api/(?P<project_id>\d+)/clear/$', api.clear, name='sentry-api-clear'),
+    url(r'^api/(?P<project_id>\d+)/chart/$', api.chart, name='sentry-api-chart'),
 
     # Project specific
 
