commit 752d3cfcf90bc0832e1359604151f50ff513a97f
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Aug 9 22:39:28 2015 -0700

    Remove thread binding (hook on request)

diff --git a/src/sentry/debug/middleware.py b/src/sentry/debug/middleware.py
index 4baf4102fa..ed8062d77e 100644
--- a/src/sentry/debug/middleware.py
+++ b/src/sentry/debug/middleware.py
@@ -2,35 +2,15 @@ from __future__ import absolute_import
 
 import json
 import re
-import thread
 
 from debug_toolbar.toolbar import DebugToolbar
 from django.utils.encoding import force_text
 
 
-class ToolbarCache(object):
-    def __init__(self):
-        self._toolbars = {}
-
-    def create(self, request):
-        toolbar = DebugToolbar(request)
-        self._toolbars[thread.get_ident()] = toolbar
-        return toolbar
-
-    def pop(self):
-        return self._toolbars.pop(thread.get_ident(), None)
-
-    def get(self):
-        return self._toolbars.get(thread.get_ident(), None)
-
-toolbar_cache = ToolbarCache()
-
-
 class DebugMiddleware(object):
     _body_regexp = re.compile(re.escape('</body>'), flags=re.IGNORECASE)
 
     def show_toolbar(self, request):
-        # TODO(dcramer): support VPN via INTERNAL_IPS + ipaddr maps
         if not request.user.is_authenticated():
             return False
         if not request.user.is_active_superuser():
@@ -44,7 +24,7 @@ class DebugMiddleware(object):
         if not self.show_toolbar(request):
             return
 
-        toolbar = toolbar_cache.create(request)
+        request.debugtoolbar = toolbar = DebugToolbar(request)
 
         # Activate instrumentation ie. monkey-patch.
         for panel in toolbar.enabled_panels:
@@ -59,7 +39,7 @@ class DebugMiddleware(object):
         return response
 
     def process_view(self, request, view_func, view_args, view_kwargs):
-        toolbar = toolbar_cache.get()
+        toolbar = getattr(request, 'debugtoolbar', None)
         if not toolbar:
             return
 
@@ -71,7 +51,7 @@ class DebugMiddleware(object):
                 break
 
     def process_response(self, request, response):
-        toolbar = toolbar_cache.pop()
+        toolbar = getattr(request, 'debugtoolbar', None)
         if not toolbar:
             return response
 
