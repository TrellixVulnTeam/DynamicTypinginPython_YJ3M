commit b87001f106d3747d899ba12ac158a2af7f4a28f2
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Sep 20 11:43:41 2014 -0700

    Enforce static media compilation as part of sdist

diff --git a/.gitignore b/.gitignore
index bd38631a02..f1f5b6fb8f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -7,6 +7,7 @@
 *.egg
 *.db
 *.pid
+MANIFEST
 test.conf
 pip-log.txt
 /htmlcov
diff --git a/setup.py b/setup.py
index 989c2458fe..4f8e25968d 100755
--- a/setup.py
+++ b/setup.py
@@ -22,7 +22,10 @@ any application.
 :license: BSD, see LICENSE for more details.
 """
 
+from distutils import log
+from distutils.command.sdist import sdist
 from setuptools import setup, find_packages
+from subprocess import check_output
 
 
 # Hack to prevent stupid "TypeError: 'NoneType' object is not callable" error
@@ -109,6 +112,19 @@ mysql_requires = [
 ]
 
 
+class CustomSdist(sdist):
+    """
+    Identical to the built-in sdist command except that we need to generate
+    static media before building the tarball.
+    """
+    def make_distribution(self):
+        log.info("running npm install")
+        check_output(['npm', 'install', '--quiet'])
+        log.info("running sentry compilestatic")
+        check_output(['sentry', 'compilestatic'])
+        return sdist.make_distribution(self)
+
+
 setup(
     name='sentry',
     version='7.0.0-DEV',
@@ -128,6 +144,9 @@ setup(
         'postgres_pypy': install_requires + postgres_pypy_requires,
         'mysql': install_requires + mysql_requires,
     },
+    cmdclass={
+        'sdist': CustomSdist,
+    },
     license='BSD',
     include_package_data=True,
     entry_points={
