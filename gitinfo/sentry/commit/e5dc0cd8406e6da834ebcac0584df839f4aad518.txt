commit e5dc0cd8406e6da834ebcac0584df839f4aad518
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Fri May 25 10:56:51 2018 -0700

    fix: Create ReleaseProjectEnvironment if not present on deploy creation (#8552)
    
    Create ReleaseProjectEnvironment objects if they do not exist when a release deploy is created

diff --git a/src/sentry/api/endpoints/release_deploys.py b/src/sentry/api/endpoints/release_deploys.py
index ad6d1c2d63..dc1e3bb3a4 100644
--- a/src/sentry/api/endpoints/release_deploys.py
+++ b/src/sentry/api/endpoints/release_deploys.py
@@ -119,13 +119,15 @@ class ReleaseDeploysEndpoint(OrganizationReleasesBaseEndpoint):
                 last_deploy_id=deploy.id,
             )
 
-            ReleaseProjectEnvironment.objects.filter(
-                release=release,
-                environment=env,
-                project__in=projects,
-            ).update(
-                last_deploy_id=deploy.id,
-            )
+            for project in projects:
+                ReleaseProjectEnvironment.objects.create_or_update(
+                    release=release,
+                    environment=env,
+                    project=project,
+                    values={
+                        'last_deploy_id': deploy.id,
+                    }
+                )
 
             Deploy.notify_if_ready(deploy.id)
 
diff --git a/tests/sentry/api/endpoints/test_release_deploys.py b/tests/sentry/api/endpoints/test_release_deploys.py
index 3a6741d8e8..ee27f249f6 100644
--- a/tests/sentry/api/endpoints/test_release_deploys.py
+++ b/tests/sentry/api/endpoints/test_release_deploys.py
@@ -6,7 +6,7 @@ import datetime
 
 from django.core.urlresolvers import reverse
 
-from sentry.models import Deploy, Environment, Release
+from sentry.models import Deploy, Environment, Release, ReleaseProjectEnvironment
 from sentry.testutils import APITestCase
 
 
@@ -106,3 +106,8 @@ class ReleaseDeploysCreateTest(APITestCase):
         release = Release.objects.get(id=release.id)
         assert release.total_deploys == 1
         assert release.last_deploy_id == deploy.id
+
+        rpe = ReleaseProjectEnvironment.objects.get(
+            project=project, release=release, environment=environment
+        )
+        assert rpe.last_deploy_id == deploy.id
