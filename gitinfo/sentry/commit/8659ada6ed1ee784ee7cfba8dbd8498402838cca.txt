commit 8659ada6ed1ee784ee7cfba8dbd8498402838cca
Author: Mark Story <mark@sentry.io>
Date:   Fri Jul 10 14:34:50 2020 -0400

    chore(discover) Remove discover toggling and deprecation warnings (#19745)
    
    This is paired with getsentry/getsentry#4130 and removes the ability to
    navigate between the two versions of discover. All customers should have
    either events1 + discover1, discover2, or neither now. I chose to retain
    the sidebar state switches to prevent our internal organization from
    having events and both discover editions in it.
    
    Fix users with discover-basic not getting dashboards
    
    Update the feature flags for dashboard to allow either flavour of
    discover. Update the discover1 endpoint to accept the discover2 feature
    flag as that is what dashboards is built against.

diff --git a/src/sentry/static/sentry/app/components/sidebar/index.tsx b/src/sentry/static/sentry/app/components/sidebar/index.tsx
index 6c7b14222d..c4151a1cfb 100644
--- a/src/sentry/static/sentry/app/components/sidebar/index.tsx
+++ b/src/sentry/static/sentry/app/components/sidebar/index.tsx
@@ -31,7 +31,6 @@ import ConfigStore from 'app/stores/configStore';
 import Feature from 'app/components/acl/feature';
 import HookStore from 'app/stores/hookStore';
 import PreferencesStore from 'app/stores/preferencesStore';
-import localStorage from 'app/utils/localStorage';
 import {getDiscoverLandingUrl} from 'app/utils/discover/urls';
 import space from 'app/styles/space';
 import theme from 'app/utils/theme';
@@ -267,19 +266,10 @@ class Sidebar extends React.Component<Props, State> {
     if (!organization || !organization.features) {
       return sidebarState;
     }
-    const optState = localStorage.getItem('discover:version');
     const features = organization.features;
 
     if (features.includes('discover-basic')) {
-      // If there is no opt-out state show discover2
-      if (!optState || optState === '2') {
-        sidebarState.discover2 = true;
-      }
-      // User wants discover1
-      if (optState === '1') {
-        sidebarState.discover1 = true;
-        sidebarState.events = true;
-      }
+      sidebarState.discover2 = true;
       return sidebarState;
     }
 
diff --git a/src/sentry/static/sentry/app/views/discover/discover.tsx b/src/sentry/static/sentry/app/views/discover/discover.tsx
index ce3cc5f963..666f779104 100644
--- a/src/sentry/static/sentry/app/views/discover/discover.tsx
+++ b/src/sentry/static/sentry/app/views/discover/discover.tsx
@@ -1,23 +1,16 @@
 import {browserHistory} from 'react-router';
 import React from 'react';
 import moment from 'moment';
-import styled from '@emotion/styled';
 
 import {addErrorMessage, addSuccessMessage} from 'app/actionCreators/indicator';
 import {getUtcDateString} from 'app/utils/dates';
 import {t, tct} from 'app/locale';
-import {IconWarning} from 'app/icons';
 import {updateProjects, updateDateTime} from 'app/actionCreators/globalSelection';
 import ConfigStore from 'app/stores/configStore';
 import {trackAnalyticsEvent} from 'app/utils/analytics';
-import Alert from 'app/components/alert';
-import Feature from 'app/components/acl/feature';
-import Link from 'app/components/links/link';
 import PageHeading from 'app/components/pageHeading';
 import {Organization} from 'app/types';
-import space from 'app/styles/space';
 import localStorage from 'app/utils/localStorage';
-import {getDiscoverLandingUrl} from 'app/utils/discover/urls';
 
 import {
   DiscoverContainer,
@@ -409,7 +402,6 @@ export default class Discover extends React.Component<Props, State> {
     } = this.props;
 
     const shouldDisplayResult = resultManager.shouldDisplayResult();
-    const discoverUrl = getDiscoverLandingUrl(organization);
 
     return (
       <DiscoverContainer>
@@ -445,17 +437,6 @@ export default class Discover extends React.Component<Props, State> {
               />
             </QueryPanel>
           )}
-          <Feature
-            features={['organizations:discover-basic']}
-            organization={organization}
-          >
-            <SwitchLink
-              href={getDiscoverLandingUrl(organization)}
-              onClick={this.onGoLegacyDiscover}
-            >
-              {t('Go to New Discover')}
-            </SwitchLink>
-          </Feature>
         </Sidebar>
 
         <DiscoverGlobalSelectionHeader
@@ -477,7 +458,6 @@ export default class Discover extends React.Component<Props, State> {
                 savedQuery={savedQuery}
                 onToggleEdit={toggleEditMode}
                 onFetchPage={this.onFetchPage}
-                discover2Url={discoverUrl}
               />
             )}
             {!shouldDisplayResult && (
@@ -487,11 +467,6 @@ export default class Discover extends React.Component<Props, State> {
                     <PageHeading>{t('Discover')}</PageHeading>
                   </HeadingContainer>
                 </div>
-                <Alert type="warning" icon={<IconWarning size="sm" />}>
-                  This discover view is deprecated. Check out our new visualization and
-                  querying capabilities in <Link to={discoverUrl}>the new Discover</Link>{' '}
-                  today.
-                </Alert>
                 <Intro updateQuery={this.updateAndRunQuery} />
               </React.Fragment>
             )}
@@ -502,9 +477,3 @@ export default class Discover extends React.Component<Props, State> {
     );
   }
 }
-
-const SwitchLink = styled('a')`
-  font-size: ${p => p.theme.fontSizeSmall};
-  margin-left: ${space(3)};
-  margin-bottom: ${space(1)};
-`;
diff --git a/src/sentry/static/sentry/app/views/discover/result/index.tsx b/src/sentry/static/sentry/app/views/discover/result/index.tsx
index 6473f22ea0..70c4c78fe3 100644
--- a/src/sentry/static/sentry/app/views/discover/result/index.tsx
+++ b/src/sentry/static/sentry/app/views/discover/result/index.tsx
@@ -7,9 +7,7 @@ import getDynamicText from 'app/utils/getDynamicText';
 import BarChart from 'app/components/charts/barChart';
 import LineChart from 'app/components/charts/lineChart';
 import PageHeading from 'app/components/pageHeading';
-import {IconEdit, IconWarning} from 'app/icons';
-import Alert from 'app/components/alert';
-import Link from 'app/components/links/link';
+import {IconEdit} from 'app/icons';
 
 import {
   getChartData,
@@ -42,7 +40,6 @@ import {SavedQuery} from '../types';
 type ResultProps = {
   data: any;
   location: any;
-  discover2Url: string;
   savedQuery: SavedQuery | null; // Provided if it's a saved search
   onFetchPage: (nextOrPrev: string) => void;
   onToggleEdit: () => void;
@@ -204,7 +201,6 @@ class Result extends React.Component<ResultProps, ResultState> {
   render() {
     const {
       data: {baseQuery, byDayQuery},
-      discover2Url,
       savedQuery,
       onFetchPage,
       utc,
@@ -232,10 +228,6 @@ class Result extends React.Component<ResultProps, ResultState> {
           <HeadingContainer>
             {savedQuery ? this.renderSavedQueryHeader() : this.renderQueryResultHeader()}
           </HeadingContainer>
-          <Alert type="warning" icon={<IconWarning size="sm" />}>
-            This discover view is deprecated. Check out our new visualization and querying
-            capabilities in <Link to={discover2Url}>the new Discover</Link> today.
-          </Alert>
           {this.renderToggle()}
         </div>
         <ResultInnerContainer ref={this.setDimensions}>
diff --git a/src/sentry/static/sentry/app/views/events/index.jsx b/src/sentry/static/sentry/app/views/events/index.jsx
index 5c946af21d..b26a95c5c4 100644
--- a/src/sentry/static/sentry/app/views/events/index.jsx
+++ b/src/sentry/static/sentry/app/views/events/index.jsx
@@ -6,19 +6,15 @@ import isEqual from 'lodash/isEqual';
 import {loadOrganizationTags} from 'app/actionCreators/tags';
 import {getParams} from 'app/components/organizations/globalSelectionHeader/getParams';
 import {t} from 'app/locale';
-import Alert from 'app/components/alert';
 import FeatureBadge from 'app/components/featureBadge';
 import Feature from 'app/components/acl/feature';
-import Link from 'app/components/links/link';
 import GlobalSelectionHeader from 'app/components/organizations/globalSelectionHeader';
 import LightWeightNoProjectMessage from 'app/components/lightWeightNoProjectMessage';
-import {IconWarning} from 'app/icons';
 import SentryTypes from 'app/sentryTypes';
 import PageHeading from 'app/components/pageHeading';
 import withApi from 'app/utils/withApi';
 import withGlobalSelection from 'app/utils/withGlobalSelection';
 import withOrganization from 'app/utils/withOrganization';
-import {getDiscoverLandingUrl} from 'app/utils/discover/urls';
 import {PageContent, PageHeader} from 'app/styles/organization';
 import space from 'app/styles/space';
 
@@ -60,7 +56,6 @@ class EventsContainer extends React.Component {
 
   render() {
     const {organization, location, children, selection} = this.props;
-    const discoverUrl = getDiscoverLandingUrl(organization);
 
     return (
       <Feature
@@ -78,11 +73,6 @@ class EventsContainer extends React.Component {
                   </HeaderTitle>
                 </PageHeader>
                 <div>
-                  <Alert type="warning" icon={<IconWarning size="sm" />}>
-                    The events view is deprecated. Check out our new visualization and
-                    querying capabilities in{' '}
-                    <Link to={discoverUrl}>the new Discover</Link> today.
-                  </Alert>
                   <StyledSearchBar
                     organization={organization}
                     projectIds={selection.projects}
diff --git a/src/sentry/static/sentry/app/views/eventsV2/landing.tsx b/src/sentry/static/sentry/app/views/eventsV2/landing.tsx
index 48027a8cc8..988b5f97be 100644
--- a/src/sentry/static/sentry/app/views/eventsV2/landing.tsx
+++ b/src/sentry/static/sentry/app/views/eventsV2/landing.tsx
@@ -343,19 +343,6 @@ class DiscoverLanding extends AsyncComponent<Props, State> {
                 {this.renderBanner()}
                 {this.renderActions()}
                 {this.renderComponent()}
-                <Feature
-                  features={['organizations:discover']}
-                  organization={organization}
-                >
-                  <div>
-                    <SwitchLink
-                      href={`/organizations/${organization.slug}/discover/`}
-                      onClick={this.onGoLegacyDiscover}
-                    >
-                      {t('Go to Legacy Discover')}
-                    </SwitchLink>
-                  </div>
-                </Feature>
               </PageContent>
             </LightWeightNoProjectMessage>
           </StyledPageContent>
@@ -399,10 +386,5 @@ const StarterButton = styled(Button)`
   margin: ${space(1)};
 `;
 
-const SwitchLink = styled('a')`
-  font-size: ${p => p.theme.fontSizeSmall};
-  margin-left: ${space(1)};
-`;
-
 export default withOrganization(DiscoverLanding);
 export {DiscoverLanding};
