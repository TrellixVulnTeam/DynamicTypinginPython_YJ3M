commit dc03d2310ebaed79eadb8b0fe031c98759f9da06
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Nov 14 02:36:53 2012 -0800

    Correct bookmarking and resolving of events

diff --git a/src/sentry/static/sentry/coffee/app.coffee b/src/sentry/static/sentry/coffee/app.coffee
index 33d87ce829..83fbdf7867 100644
--- a/src/sentry/static/sentry/coffee/app.coffee
+++ b/src/sentry/static/sentry/coffee/app.coffee
@@ -8,7 +8,7 @@ jQuery ->
         initialize: (data) ->
             _.bindAll(@)
 
-            @group_list = new app.OrderedElementsView
+            @group_list = new app.GroupListView
                 className: 'group-list'
                 id: 'event_list'
                 members: data.groups
@@ -126,7 +126,7 @@ jQuery ->
 
         getView: (id) ->
             if !@views[id]
-                @views[id] = new app.OrderedElementsView
+                @views[id] = new app.GroupListView
                     className: 'group-list small'
                     id: id
                     maxItems: 5
diff --git a/src/sentry/static/sentry/coffee/views.coffee b/src/sentry/static/sentry/coffee/views.coffee
index 35fdcf239d..9b45317316 100644
--- a/src/sentry/static/sentry/coffee/views.coffee
+++ b/src/sentry/static/sentry/coffee/views.coffee
@@ -129,19 +129,56 @@ jQuery ->
         initialize: ->
             _.bindAll(@)
             @model.on("change:count", @updateCount)
+            @model.on('change:isBookmarked', @render)
+            @model.on('change:isResolved', @render)
 
         render: ->
             data = @model.toJSON()
             data.historicalData = @getHistoricalAsString(@model)
             @$el.html(@template(data))
             @$el.addClass(@getLevelClassName(@model))
+            @$el.find('a[data-action=resolve]').click (e) =>
+                e.preventDefault()
+                @resolve(@model)
+            @$el.find('a[data-action=bookmark]').click (e) =>
+                e.preventDefault()
+                @bookmark(@model)
+
             if data.isResolved
                 @$el.addClass('resolved')
+            if data.isBookmarked
+                @$el.addClass('bookmarked')
             if data.historicalData
                 @$el.addClass('with-sparkline')
             @$el.attr('data-id', data.id)
             @
 
+        getResolveUrl: ->
+            app.config.urlPrefix + '/api/' + app.config.projectId + '/resolve/'
+
+        resolve: (obj) ->
+            $.ajax
+                url: @getResolveUrl()
+                type: 'post'
+                dataType: 'json'
+                data:
+                    gid: @model.get('id')
+                success: (response) =>
+                    @model.set('isResolved', true)
+
+        getBookmarkUrl: ->
+            app.config.urlPrefix + '/api/' + app.config.projectId + '/bookmark/'
+
+        bookmark: (obj) ->
+            $.ajax
+                url: @getBookmarkUrl()
+                type: 'post'
+                dataType: 'json'
+                data:
+                    gid: @model.get('id')
+                success: (response) =>
+                    @model.set('isBookmarked', response.bookmarked)
+
         getHistoricalAsString: (obj) ->
             if obj.get('historicalData') then obj.get('historicalData').join ', ' else ''
 
diff --git a/src/sentry/static/sentry/scripts/site.js b/src/sentry/static/sentry/scripts/site.js
index 83991daad7..b66ee60998 100644
--- a/src/sentry/static/sentry/scripts/site.js
+++ b/src/sentry/static/sentry/scripts/site.js
@@ -21,7 +21,7 @@
       StreamPage.prototype.initialize = function(data) {
         var _ref;
         _.bindAll(this);
-        this.group_list = new app.OrderedElementsView({
+        this.group_list = new app.GroupListView({
           className: 'group-list',
           id: 'event_list',
           members: data.groups,
@@ -145,7 +145,7 @@
 
       DashboardPage.prototype.getView = function(id) {
         if (!this.views[id]) {
-          this.views[id] = new app.OrderedElementsView({
+          this.views[id] = new app.GroupListView({
             className: 'group-list small',
             id: id,
             maxItems: 5
@@ -481,18 +481,32 @@
 
       GroupView.prototype.initialize = function() {
         _.bindAll(this);
-        return this.model.on("change:count", this.updateCount);
+        this.model.on("change:count", this.updateCount);
+        this.model.on('change:isBookmarked', this.render);
+        return this.model.on('change:isResolved', this.render);
       };
 
       GroupView.prototype.render = function() {
-        var data;
+        var data,
+          _this = this;
         data = this.model.toJSON();
         data.historicalData = this.getHistoricalAsString(this.model);
         this.$el.html(this.template(data));
         this.$el.addClass(this.getLevelClassName(this.model));
+        this.$el.find('a[data-action=resolve]').click(function(e) {
+          e.preventDefault();
+          return _this.resolve(_this.model);
+        });
+        this.$el.find('a[data-action=bookmark]').click(function(e) {
+          e.preventDefault();
+          return _this.bookmark(_this.model);
+        });
         if (data.isResolved) {
           this.$el.addClass('resolved');
         }
+        if (data.isBookmarked) {
+          this.$el.addClass('bookmarked');
+        }
         if (data.historicalData) {
           this.$el.addClass('with-sparkline');
         }
@@ -500,6 +514,44 @@
         return this;
       };
 
+      GroupView.prototype.getResolveUrl = function() {
+        return app.config.urlPrefix + '/api/' + app.config.projectId + '/resolve/';
+      };
+
+      GroupView.prototype.resolve = function(obj) {
+        var _this = this;
+        return $.ajax({
+          url: this.getResolveUrl(),
+          type: 'post',
+          dataType: 'json',
+          data: {
+            gid: this.model.get('id')
+          },
+          success: function(response) {
+            return _this.model.set('isResolved', true);
+          }
+        });
+      };
+
+      GroupView.prototype.getBookmarkUrl = function() {
+        return app.config.urlPrefix + '/api/' + app.config.projectId + '/bookmark/';
+      };
+
+      GroupView.prototype.bookmark = function(obj) {
+        var _this = this;
+        return $.ajax({
+          url: this.getBookmarkUrl(),
+          type: 'post',
+          dataType: 'json',
+          data: {
+            gid: this.model.get('id')
+          },
+          success: function(response) {
+            return _this.model.set('isBookmarked', response.bookmarked);
+          }
+        });
+      };
+
       GroupView.prototype.getHistoricalAsString = function(obj) {
         if (obj.get('historicalData')) {
           return obj.get('historicalData').join(', ');
diff --git a/src/sentry/templates/sentry/layout.html b/src/sentry/templates/sentry/layout.html
index 06677bd2bf..26ab1350a1 100644
--- a/src/sentry/templates/sentry/layout.html
+++ b/src/sentry/templates/sentry/layout.html
@@ -164,13 +164,13 @@
                     <% if (canResolve) { %>
                         <li>
                             <% if (!isResolved) { %>
-                                <a href="#" data-action="resolve" rel="tooltip" title="{% trans "Mark as Resolved" %}">&#10003;</a>
+                                <a href="#" data-action="resolve checked" title="{% trans "Mark as Resolved" %}">&#10003;</a>
                             <% } else { %>
-                                <a class="tip checked" rel="tooltip" title="{% trans "Already Resolved" %}">&#10003;</a>
+                                <a href="#" title="{% trans "Already Resolved" %}">&#10003;</a>
                             <% } %>
                         </li>
                         <li>
-                            <a href="#" data-action="bookmark" class="tip bookmark" rel="tooltip" title="{% trans "Bookmark" %}">&#9733;</a>
+                            <a href="#" data-action="bookmark" class="bookmark<% if (isBookmarked) { %> checked<% } %>" title="{% trans "Bookmark" %}">&#9733;</a>
                         </li>
                     <% } %>
                 </ul>
