commit 3e401b2970fca868f9bd538adf5fe38e8322e741
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Feb 12 18:42:33 2013 -0800

    Correct timestamp behavior

diff --git a/src/sentry/counter/redis.py b/src/sentry/counter/redis.py
index 283b157da1..4b0e6b0710 100644
--- a/src/sentry/counter/redis.py
+++ b/src/sentry/counter/redis.py
@@ -57,6 +57,7 @@ class RedisCounter(Counter):
         # items to check
         if not when:
             when = time.time() - 60
+
         with self.conn.map() as conn:
             key = self._make_key(prefix, when)
             results = conn.zrange(key, 0, -1, withscores=True)
diff --git a/src/sentry/tasks/check_alerts.py b/src/sentry/tasks/check_alerts.py
index 88cec6dc02..a56f7365bb 100644
--- a/src/sentry/tasks/check_alerts.py
+++ b/src/sentry/tasks/check_alerts.py
@@ -57,11 +57,12 @@ def check_alerts(**kwargs):
     from sentry import app
     from sentry.utils.queue import maybe_delay
 
-    when = datetime.fromtimestamp(time.time() - 60)
+    timestamp = time.time() - 60
+    when = datetime.fromtimestamp(timestamp)
     if dj_settings.USE_TZ:
         when = when.replace(tzinfo=timezone.utc)
 
-    results = app.counter.extract_counts(prefix='project', when=when)['results']
+    results = app.counter.extract_counts(prefix='project', when=timestamp)['results']
     for project_id, count in results:
         maybe_delay(check_project_alerts,
             project_id=int(project_id),
diff --git a/tests/sentry/tasks/check_alerts/tests.py b/tests/sentry/tasks/check_alerts/tests.py
index 698180ae84..db88dcf52f 100644
--- a/tests/sentry/tasks/check_alerts/tests.py
+++ b/tests/sentry/tasks/check_alerts/tests.py
@@ -15,7 +15,8 @@ class CheckAlertsTest(TestCase):
         time = time.time
         time.return_value = 1360721852.660331
 
-        when = datetime.fromtimestamp(time.return_value - 60).replace(tzinfo=timezone.utc)
+        timestamp = time.return_value - 60
+        when = datetime.fromtimestamp(timestamp).replace(tzinfo=timezone.utc)
 
         counter.extract_counts.return_value = {
             'when': when,
@@ -27,7 +28,7 @@ class CheckAlertsTest(TestCase):
         time.assert_called_once_with()
         counter.extract_counts.assert_called_once_with(
             prefix='project',
-            when=when,
+            when=timestamp,
         )
         maybe_delay.assert_called_once_with(
             check_project_alerts,
