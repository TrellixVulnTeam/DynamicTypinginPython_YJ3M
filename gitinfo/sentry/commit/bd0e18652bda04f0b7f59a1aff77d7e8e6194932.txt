commit bd0e18652bda04f0b7f59a1aff77d7e8e6194932
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Mar 10 08:59:03 2014 -0700

    Remove commitishes from end of js module names

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index 6122c47bcd..090620e282 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -31,13 +31,17 @@ CHARSET_RE = re.compile(r'charset=(\S+)')
 DEFAULT_ENCODING = 'utf-8'
 BASE64_SOURCEMAP_PREAMBLE = 'data:application/json;base64,'
 BASE64_PREAMBLE_LENGTH = len(BASE64_SOURCEMAP_PREAMBLE)
-CLEAN_MODULE_RE = re.compile(r"""^(?:/|(?:
+CLEAN_MODULE_RE = re.compile(r"""^
+(?:/|  # Leading slashes
+(?:
     (?:java)?scripts?|js|build|static|[_\.].*?|  # common folder prefixes
     v?(?:\d+\.)*\d+|   # version numbers, v1, 1.0.0
     [a-f0-9]{7,8}|     # short sha
     [a-f0-9]{32}|      # md5
     [a-f0-9]{40}       # sha1
-)/)+""", re.X | re.I)
+)/)+|
+(?:-[a-f0-9]{32,40}$)  # Ending in a commitish
+""", re.X | re.I)
 
 UrlResult = namedtuple('UrlResult', ['url', 'headers', 'body'])
 
diff --git a/tests/sentry/tasks/fetch_source/tests.py b/tests/sentry/tasks/fetch_source/tests.py
index fcc665ea66..766fd5d46b 100644
--- a/tests/sentry/tasks/fetch_source/tests.py
+++ b/tests/sentry/tasks/fetch_source/tests.py
@@ -138,6 +138,7 @@ class GenerateModuleTest(TestCase):
         assert generate_module('http://example.com/7d6d00eae0ceccdc7ee689659585d95f/foo/bar.js') == 'foo/bar'
         assert generate_module('/foo/bar.js') == 'foo/bar'
         assert generate_module('../../foo/bar.js') == 'foo/bar'
+        assert generate_module('/foo/bar-7d6d00eae0ceccdc7ee689659585d95f.js') == 'foo/bar'
 
 
 class FetchBase64SourcemapTest(TestCase):
