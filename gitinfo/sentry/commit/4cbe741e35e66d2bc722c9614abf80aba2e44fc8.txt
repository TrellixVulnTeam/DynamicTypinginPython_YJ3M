commit 4cbe741e35e66d2bc722c9614abf80aba2e44fc8
Author: Mark Story <mark@sentry.io>
Date:   Tue Dec 10 07:54:55 2019 -0800

    feat(discover) Format transaction.status as a string (#16026)
    
    When returning results transaction.status should be formatted as
    a string. For the short term I've done the translation in the endpoint,
    but I'd like to move that into the discover.query function once it has
    broader use.

diff --git a/src/sentry/api/endpoints/organization_events.py b/src/sentry/api/endpoints/organization_events.py
index b587292f55..08501d94db 100644
--- a/src/sentry/api/endpoints/organization_events.py
+++ b/src/sentry/api/endpoints/organization_events.py
@@ -5,6 +5,7 @@ import six
 from functools import partial
 from rest_framework.response import Response
 
+from semaphore.consts import SPAN_STATUS_CODE_TO_NAME
 from sentry.api.bases import OrganizationEventsEndpointBase, OrganizationEventsError, NoProjects
 from sentry.api.event_search import get_json_meta_type
 from sentry.api.helpers.events import get_direct_hit_response
@@ -156,9 +157,14 @@ class OrganizationEventsV2Endpoint(OrganizationEventsEndpointBase):
             return results
 
         first_row = results[0]
+
+        # TODO(mark) move all of this result formatting into discover.query()
+        # once those APIs are used across the application.
+        if "transaction.status" in first_row:
+            for row in results:
+                row["transaction.status"] = SPAN_STATUS_CODE_TO_NAME.get(row["transaction.status"])
         if not ("project.id" in first_row or "projectid" in first_row):
             return results
-
         fields = request.GET.getlist("field")
         projects = {
             p["id"]: p["slug"]
diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index a06061f28c..ffa5dad442 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -733,6 +733,8 @@ def get_json_meta_type(field, snuba_type):
         return alias_definition.get("result_type")
     if "duration" in field:
         return "duration"
+    if field == "transaction.status":
+        return "string"
     return get_json_type(snuba_type)
 
 
diff --git a/src/sentry/data/samples/transaction.json b/src/sentry/data/samples/transaction.json
index c6a460c49f..e9c4ff3a73 100644
--- a/src/sentry/data/samples/transaction.json
+++ b/src/sentry/data/samples/transaction.json
@@ -70,7 +70,8 @@
          "type": "trace",
          "op": "foobar",
          "trace_id": "a7d67cf796774551a95be6543cacd459",
-         "span_id": "babaae0d4b7512d9"
+         "span_id": "babaae0d4b7512d9",
+         "status": "ok"
       },
       "browser": {
          "version": "2.22",
diff --git a/tests/snuba/api/endpoints/test_organization_events_v2.py b/tests/snuba/api/endpoints/test_organization_events_v2.py
index f8b26ac114..ed282a3a4e 100644
--- a/tests/snuba/api/endpoints/test_organization_events_v2.py
+++ b/tests/snuba/api/endpoints/test_organization_events_v2.py
@@ -583,10 +583,12 @@ class OrganizationEventsV2EndpointTest(APITestCase, SnubaTestCase):
                 self.url,
                 format="json",
                 data={
-                    "field": ["transaction", "transaction.duration"],
+                    "field": ["transaction", "transaction.duration", "transaction.status"],
                     "query": "event.type:transaction",
                 },
             )
         assert response.status_code == 200, response.content
         assert len(response.data["data"]) == 1
         assert response.data["meta"]["transaction.duration"] == "duration"
+        assert response.data["meta"]["transaction.status"] == "string"
+        assert response.data["data"][0]["transaction.status"] == "ok"
