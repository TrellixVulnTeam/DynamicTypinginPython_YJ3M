commit 94d4bd39ee08fd358be145c64517db655e29c04f
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Mon Jun 11 11:46:41 2018 -0700

    feat(jira): Sync metadata post-install (#8598)

diff --git a/src/sentry/integrations/jira/client.py b/src/sentry/integrations/jira/client.py
index 674514ab2a..1fc2590e77 100644
--- a/src/sentry/integrations/jira/client.py
+++ b/src/sentry/integrations/jira/client.py
@@ -33,6 +33,7 @@ class JiraApiClient(ApiClient):
     SEARCH_URL = '/rest/api/2/search/'
     VERSIONS_URL = '/rest/api/2/project/%s/versions'
     USERS_URL = '/rest/api/2/user/assignable/search'
+    SERVER_INFO_URL = '/rest/api/2/serverInfo'
 
     def __init__(self, base_url, shared_secret):
         self.base_url = base_url
@@ -123,5 +124,8 @@ class JiraApiClient(ApiClient):
         data = {'fields': raw_form_data}
         return self.post(self.CREATE_URL, data=data)
 
+    def get_server_info(self):
+        return self.request('GET', self.SERVER_INFO_URL)
+
     def get_valid_statuses(self):
         return self.request('GET', self.STATUS_URL)
diff --git a/src/sentry/integrations/jira/installed.py b/src/sentry/integrations/jira/installed.py
index d0bb3ea4d2..290ffecd82 100644
--- a/src/sentry/integrations/jira/installed.py
+++ b/src/sentry/integrations/jira/installed.py
@@ -5,6 +5,7 @@ from django.views.decorators.csrf import csrf_exempt
 
 from sentry.api.base import Endpoint
 from sentry.integrations.pipeline import ensure_integration
+from sentry.tasks.integrations import sync_metadata
 
 from .integration import JiraIntegrationProvider
 
@@ -20,6 +21,11 @@ class JiraInstalledEndpoint(Endpoint):
     def post(self, request, *args, **kwargs):
         state = request.DATA
         data = JiraIntegrationProvider().build_integration(state)
-        ensure_integration('jira', data)
+        integration = ensure_integration('jira', data)
+
+        # Sync integration metadata from JIRA. This msut be executed *after*
+        # the integration has been isntalled on JIRA as the access tokens will
+        # not work until then.
+        sync_metadata.apply_async([integration.get_installation()], countdown=10)
 
         return self.respond()
diff --git a/src/sentry/integrations/jira/integration.py b/src/sentry/integrations/jira/integration.py
index ad16bef25d..8576632d9b 100644
--- a/src/sentry/integrations/jira/integration.py
+++ b/src/sentry/integrations/jira/integration.py
@@ -93,6 +93,26 @@ class JiraIntegration(Integration, IssueSyncMixin):
 
         return configuration
 
+    def sync_metadata(self):
+        client = self.get_client()
+
+        try:
+            server_info = client.get_server_info()
+            projects = client.get_projects_list()
+        except ApiError as e:
+            raise IntegrationError(self.message_from_error(e))
+
+        self.model.name = server_info['serverTitle']
+
+        # There is no JIRA instance icon (there is a favicon, but it doesn't seem
+        # possible to query that with the API). So instead we just use the first
+        # project Icon.
+        if len(projects) > 0:
+            avatar = projects[0]['avatarUrls']['48x48'],
+            self.model.metadata.update({'icon': avatar})
+
+        self.model.save()
+
     def get_link_issue_config(self, group, **kwargs):
         fields = super(JiraIntegration, self).get_link_issue_config(group, **kwargs)
         org = group.organization
diff --git a/src/sentry/tasks/integrations.py b/src/sentry/tasks/integrations.py
index ff4d81b2c6..8de13b850c 100644
--- a/src/sentry/tasks/integrations.py
+++ b/src/sentry/tasks/integrations.py
@@ -3,6 +3,7 @@ from __future__ import absolute_import
 from sentry.tasks.base import instrumented_task, retry
 
 from sentry.models import ExternalIssue, Integration
+from sentry.integrations.exceptions import IntegrationError
 
 
 @instrumented_task(
@@ -18,3 +19,14 @@ def post_comment(external_issue_id, data, **kwargs):
     external_issue = ExternalIssue.objects.get(id=external_issue_id)
     integration = Integration.objects.get(id=external_issue.integration_id)
     integration.get_installation().create_comment(external_issue.key, data['text'])
+
+
+@instrumented_task(
+    name='sentry.tasks.integrations.jira.sync_metadata',
+    queue='integrations',
+    default_retry_delay=20,
+    max_retries=5
+)
+@retry(on=(IntegrationError,))
+def sync_metadata(installation):
+    installation.sync_metadata()
