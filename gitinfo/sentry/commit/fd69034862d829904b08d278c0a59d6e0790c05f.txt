commit fd69034862d829904b08d278c0a59d6e0790c05f
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Tue Aug 21 12:34:55 2018 -0700

    fix(discover): Do not use topK to fetch tags (#9444)
    
    TopK doesn't currently work properly for values > 10

diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
index 9d505076f5..09a9db1d45 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
@@ -63,14 +63,16 @@ export default function createQueryBuilder(initial = {}, organization) {
   function load() {
     return fetch({
       projects: defaultProjects,
-      aggregations: [['topK(1000)', 'tags_key', 'tags_key']],
+      fields: ['tags_key'],
+      aggregations: [['count()', null, 'count']],
+      orderby: '-count',
       start: moment()
         .subtract(90, 'days')
         .format(DATE_TIME_FORMAT),
       end: moment().format(DATE_TIME_FORMAT),
     })
       .then(res => {
-        tags = res.data[0].tags_key.map(tag => ({name: `tags[${tag}]`, type: 'string'}));
+        tags = res.data.map(tag => ({name: `tags[${tag.tags_key}]`, type: 'string'}));
       })
       .catch(err => {
         tags = PROMOTED_TAGS;
diff --git a/tests/js/spec/views/organizationDiscover/queryBuilder.spec.jsx b/tests/js/spec/views/organizationDiscover/queryBuilder.spec.jsx
index 5ea963c501..c0fb1c6079 100644
--- a/tests/js/spec/views/organizationDiscover/queryBuilder.spec.jsx
+++ b/tests/js/spec/views/organizationDiscover/queryBuilder.spec.jsx
@@ -29,7 +29,7 @@ describe('Query Builder', function() {
         url: '/organizations/org-slug/discover/',
         method: 'POST',
         body: {
-          data: [{tags_key: ['tag1', 'tag2']}],
+          data: [{tags_key: 'tag1', count: 5}, {tags_key: 'tag2', count: 1}],
         },
       });
       const queryBuilder = createQueryBuilder(
@@ -42,7 +42,9 @@ describe('Query Builder', function() {
         '/organizations/org-slug/discover/',
         expect.objectContaining({
           data: expect.objectContaining({
-            aggregations: [['topK(1000)', 'tags_key', 'tags_key']],
+            fields: ['tags_key'],
+            aggregations: [['count()', null, 'count']],
+            orderby: '-count',
             projects: [2],
             start: '2017-07-19T02:41:20',
             end: '2017-10-17T02:41:20',
