commit e6d6f6d2df88b33eb5985bd7fbebf80f9a8ee3c6
Author: David Cramer <dcramer@gmail.com>
Date:   Tue May 7 21:31:20 2013 -0700

    Support instance_id in ProjectOption.objects.get_all_values

diff --git a/src/sentry/manager.py b/src/sentry/manager.py
index 55b3d9a047..8a57533512 100644
--- a/src/sentry/manager.py
+++ b/src/sentry/manager.py
@@ -955,15 +955,21 @@ class InstanceMetaManager(BaseManager):
     def get_all_values(self, instance):
         if not hasattr(self, '_metadata'):
             self._metadata = {}
-        if instance.pk not in self._metadata:
+
+        if isinstance(instance, models.Model):
+            instance_id = instance.pk
+        else:
+            instance_id = instance
+
+        if instance_id not in self._metadata:
             result = dict(
                 (i.key, i.value) for i in
                 self.filter(**{
-                    self.field_name: instance,
+                    self.field_name: instance_id,
                 })
             )
-            self._metadata[instance.pk] = result
-        return self._metadata.get(instance.pk, {})
+            self._metadata[instance_id] = result
+        return self._metadata.get(instance_id, {})
 
     def clear_cache(self, **kwargs):
         self._metadata = {}
diff --git a/src/sentry/tasks/check_alerts.py b/src/sentry/tasks/check_alerts.py
index ea09a2847c..d2c057cb3c 100644
--- a/src/sentry/tasks/check_alerts.py
+++ b/src/sentry/tasks/check_alerts.py
@@ -64,13 +64,8 @@ def check_project_alerts(project_id, when, count, **kwargs):
     from sentry.models import ProjectCountByMinute, ProjectOption, Alert
 
     # TODO: make this use the cache
-    try:
-        threshold, min_events = ProjectOption.objects.get_value(
-            project=project_id,
-            key='alert:threshold',
-        )
-    except ProjectOption.DoesNotExist:
-        threshold, min_events = settings.DEFAULT_ALERT_PROJECT_THRESHOLD
+    threshold, min_events = ProjectOption.objects.get_value(
+        project_id, 'alert:threshold', settings.DEFAULT_ALERT_PROJECT_THRESHOLD)
 
     if not threshold and min_events:
         return
