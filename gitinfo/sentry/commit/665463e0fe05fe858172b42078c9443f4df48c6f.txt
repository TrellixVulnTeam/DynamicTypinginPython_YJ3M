commit 665463e0fe05fe858172b42078c9443f4df48c6f
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jul 4 14:59:52 2012 +0200

    Initial work on dynamic tags

diff --git a/sentry/templates/sentry/projects/manage.html b/sentry/templates/sentry/projects/manage.html
index 520942f574..901f8a343c 100644
--- a/sentry/templates/sentry/projects/manage.html
+++ b/sentry/templates/sentry/projects/manage.html
@@ -18,6 +18,9 @@
             <li{% if page == 'details' %} class="active"{% endif %}>
                 <a href="{% url sentry-manage-project project.slug %}">{% trans "Details" %}</a>
             </li>
+            <li{% if page == 'tags' %} class="active"{% endif %}>
+                <a href="{% url sentry-manage-project-tags project.slug %}">{% trans "Tags" %}</a>
+            </li>
             {% for p in project|get_plugins %}
                 <li{% if page == 'plugin' and plugin.slug == p.slug %} class="active"{% endif %}>
                     <a href="{% url sentry-configure-project-plugin project.slug p.slug %}">{{ p.get_title }}</a>
diff --git a/sentry/templates/sentry/projects/manage_tags.html b/sentry/templates/sentry/projects/manage_tags.html
new file mode 100644
index 0000000000..7b38190d69
--- /dev/null
+++ b/sentry/templates/sentry/projects/manage_tags.html
@@ -0,0 +1,38 @@
+{% extends "sentry/projects/manage.html" %}
+
+{% load crispy_forms_tags %}
+{% load i18n %}
+
+{% block title %}{% trans "Manage Tags" %} | {{ block.super }}{% endblock %}
+
+{% block inner %}
+    <div class="page-header">
+        <h2>{% trans "Manage Tags" %}</h2>
+    </div>
+    {% if form %}
+        <p>{% trans "Configure tags which you want to enable filters for." %}</p>
+        <p><small>{% trans "Note: You can only configure tags which have already been seen." %}</small></p>
+        <form action="" method="post">
+            {% csrf_token %}
+            {% if form.non_field_errors %}
+                <div class="alert alert-block alert-error">
+                    <p>{% trans "There were errors saving your changes:" %}</p>
+                    <ul>
+                        {% for error in form.non_field_errors %}
+                            <li>{{ error }}</li>
+                        {% endfor %}
+                    </ul>
+                </div>
+            {% endif %}
+            <fieldset>
+                {% crispy form helper %}
+            </fieldset>
+            <fieldset class="form-actions">
+                <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
+            </fieldset>
+        </form>
+    {% else %}
+        <p>{% trans "We have not yet recorded any tags for this project." %}</p>
+    {% endif %}
+{% endblock %}
+
diff --git a/sentry/web/forms/projects.py b/sentry/web/forms/projects.py
new file mode 100644
index 0000000000..223fe689cf
--- /dev/null
+++ b/sentry/web/forms/projects.py
@@ -0,0 +1,31 @@
+"""
+sentry.web.forms.projects
+~~~~~~~~~~~~~~~~~~~~~~~~~
+
+:copyright: (c) 2010-2012 by the Sentry Team, see AUTHORS for more details.
+:license: BSD, see LICENSE for more details.
+"""
+import itertools
+from django import forms
+from sentry.models import ProjectOption
+
+
+class ProjectTagsForm(forms.Form):
+    tags = forms.MultipleChoiceField(choices=(), widget=forms.CheckboxSelectMultiple(), required=False)
+
+    def __init__(self, project, tag_list, *args, **kwargs):
+        self.project = project
+        super(ProjectTagsForm, self).__init__(*args, **kwargs)
+
+        self.fields['tags'].choices = tuple(
+            (k, '%s (%s)' % (k.replace('_', ' ').title(), k))
+            for k in itertools.imap(unicode, tag_list)
+        )
+        self.fields['tags'].widget.choices = self.fields['tags'].choices
+
+        enabled_tags = ProjectOption.objects.get_value(self.project, 'tags', tag_list)
+        self.fields['tags'].initial = enabled_tags
+
+    def save(self):
+        tags = self.cleaned_data.get('tags')
+        ProjectOption.objects.set_value(self.project, 'tags', tags)
diff --git a/sentry/web/frontend/projects.py b/sentry/web/frontend/projects.py
index 5850fd8ab4..3e96237733 100644
--- a/sentry/web/frontend/projects.py
+++ b/sentry/web/frontend/projects.py
@@ -5,19 +5,21 @@ sentry.web.frontend.projects
 :copyright: (c) 2012 by the Sentry Team, see AUTHORS for more details.
 :license: BSD, see LICENSE for more details.
 """
+from crispy_forms.helper import FormHelper
 from django.core.context_processors import csrf
 from django.core.urlresolvers import reverse
 from django.http import HttpResponseRedirect
 from django.views.decorators.csrf import csrf_protect
 
 from sentry.models import TeamMember, MEMBER_OWNER, \
-  ProjectKey, Team
+  ProjectKey, Team, FilterValue
 from sentry.permissions import can_create_projects, can_remove_project
 from sentry.plugins import plugins
 from sentry.plugins.helpers import set_option, get_option
 from sentry.web.decorators import login_required, has_access
 from sentry.web.forms import EditProjectForm, RemoveProjectForm, \
   EditProjectAdminForm
+from sentry.web.forms.projects import ProjectTagsForm
 from sentry.web.helpers import render_to_response, get_project_list, \
   plugin_config, get_team_list
 
@@ -153,6 +155,32 @@ def client_help(request, project):
     return render_to_response('sentry/projects/client_help.html', context, request)
 
 
+@login_required
+@has_access(MEMBER_OWNER)
+def manage_project_tags(request, project):
+    tag_list = list(FilterValue.objects.filter(project=project).values_list('key', flat=True).distinct())
+    if tag_list:
+        form = ProjectTagsForm(project, tag_list, request.POST or None)
+    else:
+        form = None
+
+    helper = FormHelper()
+    helper.form_tag = False
+
+    if form.is_valid():
+        form.save()
+        return HttpResponseRedirect(reverse('sentry-manage-project-tags', args=[project.slug]) + '?success=1')
+
+    context = {
+        'tag_list': tag_list,
+        'page': 'tags',
+        'project': project,
+        'form': form,
+        'helper': helper,
+    }
+    return render_to_response('sentry/projects/manage_tags.html', context, request)
+
+
 @login_required
 @has_access(MEMBER_OWNER)
 @csrf_protect
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index 7959471d8b..f85d096dea 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -83,6 +83,8 @@ urlpatterns = patterns('',
     url(r'^account/projects/new/$', projects.new_project, name='sentry-new-project'),
     url(r'^account/projects/(?P<project_id>[\w_-]+)/edit/$', projects.manage_project,
         name='sentry-manage-project'),
+    url(r'^account/projects/(?P<project_id>[\w_-]+)/tags/$', projects.manage_project_tags,
+        name='sentry-manage-project-tags'),
     url(r'^account/projects/(?P<project_id>[\w_-]+)/docs/$', projects.client_help,
         name='sentry-project-client-help'),
     url(r'^account/projects/(?P<project_id>[\w_-]+)/docs/(?P<platform>%s)/$' % ('|'.join(re.escape(r) for r in docs.PLATFORM_LIST),),
