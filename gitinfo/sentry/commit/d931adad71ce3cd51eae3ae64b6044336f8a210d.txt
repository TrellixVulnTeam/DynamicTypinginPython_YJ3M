commit d931adad71ce3cd51eae3ae64b6044336f8a210d
Author: David Cramer <dcramer@gmail.com>
Date:   Thu May 28 06:53:46 2015 +0200

    Correctly exclude inactive teams

diff --git a/src/sentry/models/project.py b/src/sentry/models/project.py
index 5c0f78b1b5..82e918a37a 100644
--- a/src/sentry/models/project.py
+++ b/src/sentry/models/project.py
@@ -197,13 +197,11 @@ class Project(Model):
 
     @property
     def member_set(self):
-        # Django does not correctly handle exclude on the many2many (it uses
-        # a singular subquery)
         return self.organization.member_set.filter(
-            Q(organizationmemberteam__is_active=True,
-              organizationmemberteam__team=self.team) |
-            Q(organizationmemberteam__isnull=True,
-              has_global_access=True),
+            Q(organizationmemberteam__team=self.team) |
+            Q(has_global_access=True),
+            ~Q(organizationmemberteam__is_active=False,
+               organizationmemberteam__team=self.team),
             user__is_active=True,
         ).distinct()
 
diff --git a/src/sentry/models/team.py b/src/sentry/models/team.py
index 3ff7768673..18f4433aca 100644
--- a/src/sentry/models/team.py
+++ b/src/sentry/models/team.py
@@ -175,14 +175,12 @@ class Team(Model):
         return self.owner.username
 
     @property
-    def member_set(self):
-        # Django does not correctly handle exclude on the many2many (it uses
-        # a singular subquery)
+    def member_set(self, user=None):
         return self.organization.member_set.filter(
-            Q(organizationmemberteam__is_active=True,
-              organizationmemberteam__team=self) |
-            Q(organizationmemberteam__isnull=True,
-              has_global_access=True),
+            Q(organizationmemberteam__team=self) |
+            Q(has_global_access=True),
+            ~Q(organizationmemberteam__is_active=False,
+               organizationmemberteam__team=self),
             user__is_active=True,
         ).distinct()
 
