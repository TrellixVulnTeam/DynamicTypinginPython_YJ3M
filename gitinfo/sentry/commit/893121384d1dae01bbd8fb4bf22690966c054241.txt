commit 893121384d1dae01bbd8fb4bf22690966c054241
Author: William Mak <william@wmak.io>
Date:   Wed Nov 20 11:09:41 2019 -0500

    fix: Preserves sort as a query parameter (#15645)
    
    * fix: preserve sort as a query parameter for issues
    
    - This change makes it so only issues will have sort appended if it
      exists in the url parameters
    - also refactored the query object construction a bit to make it easier
      to add more parameters this way in the future.

diff --git a/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx b/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
index 48e1324dab..702663f222 100644
--- a/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
+++ b/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
@@ -32,7 +32,7 @@ class EventOrGroupHeader extends React.Component {
   };
 
   getTitle() {
-    const {hideIcons, hideLevel, includeLink, data, params} = this.props;
+    const {hideIcons, hideLevel, includeLink, data, params, location} = this.props;
     const {orgId} = params;
 
     const {id, level, groupID} = data || {};
@@ -44,13 +44,11 @@ class EventOrGroupHeader extends React.Component {
     const basePath = `/organizations/${orgId}/issues/`;
 
     if (includeLink) {
-      const locationWithProject = {...this.props.location};
-      const query =
-        locationWithProject.query.project !== undefined
-          ? {
-              query: this.props.query,
-            }
-          : {query: this.props.query, _allp: 1}; //This appends _allp to the URL parameters if they have no project selected ("all" projects included in results). This is so that when we enter the issue details page and lock them to a project, we can properly take them back to the issue list page with no project selected (and not the locked project selected)
+      const query = {
+        query: this.props.query,
+        ...(location.query.sort !== undefined ? {sort: location.query.sort} : {}), // This adds sort to the query if one was selected from the issues list page
+        ...(location.query.project !== undefined ? {} : {_allp: 1}), //This appends _allp to the URL parameters if they have no project selected ("all" projects included in results). This is so that when we enter the issue details page and lock them to a project, we can properly take them back to the issue list page with no project selected (and not the locked project selected)
+      };
 
       props.to = {
         pathname: `${basePath}${isEvent ? groupID : id}/${
diff --git a/tests/js/spec/components/eventOrGroupHeader.spec.jsx b/tests/js/spec/components/eventOrGroupHeader.spec.jsx
index bfb0478b72..b747fc5980 100644
--- a/tests/js/spec/components/eventOrGroupHeader.spec.jsx
+++ b/tests/js/spec/components/eventOrGroupHeader.spec.jsx
@@ -144,5 +144,55 @@ describe('EventOrGroupHeader', function() {
 
       expect(toJson(component)).toMatchSnapshot();
     });
+
+    it('keeps sort in link when query has sort', function() {
+      const query = {
+        sort: 'freq',
+      };
+
+      const component = shallow(
+        <EventOrGroupHeader
+          params={{orgId: 'orgId'}}
+          data={{
+            ...eventData,
+            ...{
+              type: 'default',
+            },
+          }}
+          location={{query}}
+        />
+      );
+
+      const title = component
+        .dive()
+        .instance()
+        .getTitle();
+
+      expect(title.props.to.query.sort).toEqual('freq');
+    });
+
+    it('lack of project adds allp parameter', function() {
+      const query = {};
+
+      const component = shallow(
+        <EventOrGroupHeader
+          params={{orgId: 'orgId'}}
+          data={{
+            ...eventData,
+            ...{
+              type: 'default',
+            },
+          }}
+          location={{query}}
+        />
+      );
+
+      const title = component
+        .dive()
+        .instance()
+        .getTitle();
+
+      expect(title.props.to.query._allp).toEqual(1);
+    });
   });
 });
