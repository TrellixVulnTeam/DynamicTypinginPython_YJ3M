commit 2c24f815fa5a96cda3f9b5d5cf03c23e1c7d7ed8
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Thu Nov 16 15:20:54 2017 -0800

    Dropdown fixes (#6537)
    
    * feat(dropdown): Unify styles for dropdownLink and dropdownReact components
    
    Fixes #6464
    
    * feat(dropdown): Add nested dropdown functionality to dropdownReact component
    
    Fixes #6368

diff --git a/src/sentry/static/sentry/app/components/dropdownLink.jsx b/src/sentry/static/sentry/app/components/dropdownLink.jsx
index 51cc8c7910..6bf5532ac7 100644
--- a/src/sentry/static/sentry/app/components/dropdownLink.jsx
+++ b/src/sentry/static/sentry/app/components/dropdownLink.jsx
@@ -84,8 +84,10 @@ const DropdownLink = React.createClass({
     return (
       <span className={topLevelClasses}>
         <a className={className} data-toggle="dropdown" ref="dropdownToggle">
-          {this.props.title}
-          {this.props.caret && <i className="icon-arrow-down" />}
+          <div className="dropdown-actor-title">
+            {this.props.title}
+            {this.props.caret && <i className="icon-arrow-down" />}
+          </div>
         </a>
         <ul className={classNames(this.props.menuClasses, 'dropdown-menu')}>
           {this.props.children}
diff --git a/src/sentry/static/sentry/app/components/dropdownReact.jsx b/src/sentry/static/sentry/app/components/dropdownReact.jsx
index 3706a5549f..ab0e67b29b 100644
--- a/src/sentry/static/sentry/app/components/dropdownReact.jsx
+++ b/src/sentry/static/sentry/app/components/dropdownReact.jsx
@@ -39,6 +39,12 @@ class DropdownReact extends React.Component {
 
     topLevelClasses: PropTypes.string,
     menuClasses: PropTypes.string,
+
+    /**
+     * If this is set to true, the dropdown behaves as a "nested dropdown" and is
+     * triggered on mouse enter and mouse leave
+     */
+    isNestedDropdown: PropTypes.bool,
   };
 
   static defaultProps = {
@@ -98,6 +104,15 @@ class DropdownReact extends React.Component {
     }
   };
 
+  // Decide whether dropdown should be closed when mouse leaves element
+  handleMouseLeave = e => {
+    const toElement = e.toElement || e.relatedTarget;
+
+    if (this.dropdownMenu && !this.dropdownMenu.contains(toElement)) {
+      this.handleClose(e);
+    }
+  };
+
   // Closes dropdown menu
   handleClose = e => {
     let {onClose, isOpen} = this.props;
@@ -151,6 +166,7 @@ class DropdownReact extends React.Component {
       className,
       alwaysRenderMenu,
       topLevelClasses,
+      isNestedDropdown,
     } = this.props;
 
     // Default anchor = left
@@ -160,6 +176,7 @@ class DropdownReact extends React.Component {
     let cx = classNames('dropdown-actor', className, {
       'dropdown-menu-right': isRight,
       'dropdown-toggle': true,
+      hover: shouldShowDropdown,
       disabled,
     });
 
@@ -176,7 +193,9 @@ class DropdownReact extends React.Component {
         <a
           className={cx}
           ref={ref => (this.dropdownActor = ref)}
-          onClick={this.handleToggle}
+          onClick={!isNestedDropdown && this.handleToggle}
+          onMouseEnter={isNestedDropdown && this.handleOpen}
+          onMouseLeave={isNestedDropdown && this.handleMouseLeave}
         >
           <div className="dropdown-actor-title">
             <span>{title}</span>
@@ -188,6 +207,7 @@ class DropdownReact extends React.Component {
             ref={this.handleMenuMount}
             onClick={this.handleDropdownMenuClick}
             className={classNames(menuClasses, 'dropdown-menu')}
+            onMouseLeave={isNestedDropdown && this.handleMouseLeave}
           >
             {children}
           </ul>
diff --git a/src/sentry/static/sentry/app/views/groupDetails/actions.jsx b/src/sentry/static/sentry/app/views/groupDetails/actions.jsx
index 51a24d08c6..4918252939 100644
--- a/src/sentry/static/sentry/app/views/groupDetails/actions.jsx
+++ b/src/sentry/static/sentry/app/views/groupDetails/actions.jsx
@@ -8,7 +8,7 @@ import ApiMixin from '../../mixins/apiMixin';
 import CustomIgnoreCountModal from '../../components/customIgnoreCountModal';
 import CustomIgnoreDurationModal from '../../components/customIgnoreDurationModal';
 import CustomResolutionModal from '../../components/customResolutionModal';
-import DropdownLink from '../../components/dropdownLink';
+import DropdownReact from '../../components/dropdownReact';
 import Duration from '../../components/duration';
 import GroupActions from '../../actions/groupActions';
 import GroupState from '../../mixins/groupState';
@@ -103,7 +103,7 @@ const ResolveActions = React.createClass({
             <span className="icon-checkmark" style={{marginRight: 5}} />
             {t('Resolve')}
           </a>
-          <DropdownLink
+          <DropdownReact
             key="resolve-dropdown"
             caret={true}
             className={resolveClassName}
@@ -155,7 +155,7 @@ const ResolveActions = React.createClass({
                 {t('Another version ...')}
               </a>
             </MenuItem>
-          </DropdownLink>
+          </DropdownReact>
         </div>
       </div>
     );
@@ -257,10 +257,14 @@ const IgnoreActions = React.createClass({
             <span className="icon-ban" style={{marginRight: 5}} />
             {t('Ignore')}
           </a>
-          <DropdownLink caret={true} className={linkClassName} title="">
+          <DropdownReact caret={true} className={linkClassName} title="">
             <MenuItem header={true}>Ignore Until</MenuItem>
             <li className="dropdown-submenu">
-              <DropdownLink title="This occurs again after .." caret={false}>
+              <DropdownReact
+                title="This occurs again after .."
+                caret={false}
+                isNestedDropdown={true}
+              >
                 {this.getIgnoreDurations().map(duration => {
                   return (
                     <MenuItem noAnchor={true} key={duration}>
@@ -278,16 +282,21 @@ const IgnoreActions = React.createClass({
                 <MenuItem noAnchor={true}>
                   <a onClick={() => this.setState({modal: 'duration'})}>{t('Custom')}</a>
                 </MenuItem>
-              </DropdownLink>
+              </DropdownReact>
             </li>
             <li className="dropdown-submenu">
-              <DropdownLink title="This occurs again .." caret={false}>
+              <DropdownReact
+                title="This occurs again .."
+                caret={false}
+                isNestedDropdown={true}
+              >
                 {this.getIgnoreCounts().map(count => {
                   return (
                     <li className="dropdown-submenu" key={count}>
-                      <DropdownLink
+                      <DropdownReact
                         title={t('%s times', count.toLocaleString())}
                         caret={false}
+                        isNestedDropdown={true}
                       >
                         <MenuItem noAnchor={true}>
                           <a
@@ -312,7 +321,7 @@ const IgnoreActions = React.createClass({
                             </MenuItem>
                           );
                         })}
-                      </DropdownLink>
+                      </DropdownReact>
                     </li>
                   );
                 })}
@@ -320,16 +329,21 @@ const IgnoreActions = React.createClass({
                 <MenuItem noAnchor={true}>
                   <a onClick={() => this.setState({modal: 'count'})}>{t('Custom')}</a>
                 </MenuItem>
-              </DropdownLink>
+              </DropdownReact>
             </li>
             <li className="dropdown-submenu">
-              <DropdownLink title="This affects an additional .." caret={false}>
+              <DropdownReact
+                title="This affects an additional .."
+                caret={false}
+                isNestedDropdown={true}
+              >
                 {this.getIgnoreCounts().map(count => {
                   return (
                     <li className="dropdown-submenu" key={count}>
-                      <DropdownLink
+                      <DropdownReact
                         title={t('%s users', count.toLocaleString())}
                         caret={false}
+                        isNestedDropdown={true}
                       >
                         <MenuItem noAnchor={true}>
                           <a
@@ -354,7 +368,7 @@ const IgnoreActions = React.createClass({
                             </MenuItem>
                           );
                         })}
-                      </DropdownLink>
+                      </DropdownReact>
                     </li>
                   );
                 })}
@@ -362,9 +376,9 @@ const IgnoreActions = React.createClass({
                 <MenuItem noAnchor={true}>
                   <a onClick={() => this.setState({modal: 'users'})}>{t('Custom')}</a>
                 </MenuItem>
-              </DropdownLink>
+              </DropdownReact>
             </li>
-          </DropdownLink>
+          </DropdownReact>
         </div>
       </div>
     );
@@ -393,7 +407,7 @@ const DeleteActions = React.createClass({
           <span className="icon-trash" />
         </LinkWithConfirmation>
         {features.has('custom-filters') && (
-          <DropdownLink caret={true} className="group-delete btn btn-default btn-sm">
+          <DropdownReact caret={true} className="group-delete btn btn-default btn-sm">
             <li>
               <LinkWithConfirmation
                 title={t('Discard')}
@@ -408,7 +422,7 @@ const DeleteActions = React.createClass({
                 <span>{t('Delete and discard future events')}</span>
               </LinkWithConfirmation>
             </li>
-          </DropdownLink>
+          </DropdownReact>
         )}
       </div>
     );
@@ -602,7 +616,7 @@ const GroupDetailsActions = React.createClass({
 
         {group.pluginActions.length > 1 ? (
           <div className="btn-group more">
-            <DropdownLink className="btn btn-default btn-sm" title={t('More')}>
+            <DropdownReact className="btn btn-default btn-sm" title={t('More')}>
               {group.pluginActions.map((action, actionIdx) => {
                 return (
                   <MenuItem key={actionIdx} href={action[1]}>
@@ -610,7 +624,7 @@ const GroupDetailsActions = React.createClass({
                   </MenuItem>
                 );
               })}
-            </DropdownLink>
+            </DropdownReact>
           </div>
         ) : (
           group.pluginActions.length !== 0 &&
diff --git a/src/sentry/static/sentry/less/group-detail.less b/src/sentry/static/sentry/less/group-detail.less
index f758cddc13..6131a48c7c 100644
--- a/src/sentry/static/sentry/less/group-detail.less
+++ b/src/sentry/static/sentry/less/group-detail.less
@@ -306,6 +306,7 @@
       color: @gray-dark;
 
       > span {
+        display: inline-block;
         background: @white;
         padding-right: 7px;
       }
diff --git a/src/sentry/static/sentry/less/shared-components.less b/src/sentry/static/sentry/less/shared-components.less
index 59a3e7ace5..8b1de02cad 100644
--- a/src/sentry/static/sentry/less/shared-components.less
+++ b/src/sentry/static/sentry/less/shared-components.less
@@ -269,7 +269,9 @@ fieldset[disabled] .btn-danger.active,
   .icon-refresh {
     position: relative;
     font-size: 14px !important;
-    top: 2px;
+    display: block;
+    line-height: 18px;
+    top: 0;
   }
 }
 
@@ -1398,6 +1400,7 @@ table.integrations {
       left: 2px;
       font-size: 15px !important;
       color: @gray;
+      top: 1px;
     }
   }
 
@@ -1898,8 +1901,8 @@ ul.faces {
   }
 
   .icon-arrow-down {
-    top: 3px;
     right: -2px;
+    top: 0;
   }
 
   .avatar {
@@ -2611,7 +2614,8 @@ header + .alert {
     .transition(none);
     color: @gray-dark;
 
-    &:hover {
+    &:hover,
+    &.hover {
       background: #f7f8f9;
       color: darken(@gray-dark, 10);
     }
@@ -2658,6 +2662,9 @@ header + .alert {
 
 .dropdown-actor-title {
   display: flex;
+  align-items: center;
+  height: 100%;
+  min-height: 18px;
 }
 
 /**
diff --git a/src/sentry/static/sentry/less/type.less b/src/sentry/static/sentry/less/type.less
index 2330cdd748..17d3f428af 100644
--- a/src/sentry/static/sentry/less/type.less
+++ b/src/sentry/static/sentry/less/type.less
@@ -146,7 +146,7 @@ hr {
 .icon-arrow-left {
   font-size: 16px !important;
   position: relative;
-  top: 3px;
+  top: 2px;
 }
 
 /**
diff --git a/src/sentry/templates/sentry/project-issue-tracking.html b/src/sentry/templates/sentry/project-issue-tracking.html
index 8a94d029ea..d4ef36983f 100644
--- a/src/sentry/templates/sentry/project-issue-tracking.html
+++ b/src/sentry/templates/sentry/project-issue-tracking.html
@@ -11,9 +11,8 @@
     <h2>{% trans "Issue Tracking" %}</h2>
 
     <p>Enabling Issue Tracking will let you quickly create tasks within your existing tools.
-      You'll find the new action under <span class="btn btn-default btn-sm">More <span class="icon icon-arrow-down"></span></span>
-      on an issue's details page. Once you create an issue, you'll find a helpful annotation
-      and link to the task in your project management tool. </p>
+      You'll find the new action on an issue's details page. Once you create an issue, you'll
+      find a helpful annotation and link to the task in your project management tool. </p>
 
     {% if enabled_plugins or other_plugins %}
       {% for plugin, content in enabled_plugins %}
diff --git a/tests/js/spec/components/__snapshots__/dropdownLink.spec.jsx.snap b/tests/js/spec/components/__snapshots__/dropdownLink.spec.jsx.snap
index 40b898034c..2c3aab8631 100644
--- a/tests/js/spec/components/__snapshots__/dropdownLink.spec.jsx.snap
+++ b/tests/js/spec/components/__snapshots__/dropdownLink.spec.jsx.snap
@@ -8,10 +8,14 @@ exports[`DropdownLink renders and anchors to left by default 1`] = `
     className="dropdown-toggle"
     data-toggle="dropdown"
   >
-    test
-    <i
-      className="icon-arrow-down"
-    />
+    <div
+      className="dropdown-actor-title"
+    >
+      test
+      <i
+        className="icon-arrow-down"
+      />
+    </div>
   </a>
   <ul
     className="dropdown-menu"
@@ -34,10 +38,14 @@ exports[`DropdownLink renders and anchors to right 1`] = `
     className="dropdown-menu-right dropdown-toggle"
     data-toggle="dropdown"
   >
-    test
-    <i
-      className="icon-arrow-down"
-    />
+    <div
+      className="dropdown-actor-title"
+    >
+      test
+      <i
+        className="icon-arrow-down"
+      />
+    </div>
   </a>
   <ul
     className="dropdown-menu"
diff --git a/tests/js/spec/components/dropdownReact.spec.jsx b/tests/js/spec/components/dropdownReact.spec.jsx
index 5048010bc7..6d1a869400 100644
--- a/tests/js/spec/components/dropdownReact.spec.jsx
+++ b/tests/js/spec/components/dropdownReact.spec.jsx
@@ -153,4 +153,32 @@ describe('DropdownReact', function() {
       });
     });
   });
+
+  describe('Nested Dropdown', function() {
+    let wrapper;
+
+    beforeEach(function() {
+      if (wrapper) {
+        wrapper.unmount();
+      }
+
+      wrapper = mount(
+        <DropdownReact title="parent">
+          <DropdownReact title="nested" isNestedDropdown={true}>
+            Test
+          </DropdownReact>
+        </DropdownReact>
+      );
+    });
+
+    it('Opens / closes on mouse enter and leave', function() {
+      wrapper.find('a').simulate('click');
+      wrapper.find('.dropdown-menu a').simulate('mouseEnter');
+      expect(wrapper.find('.dropdown-menu').length).toBe(2);
+
+      wrapper.find('.dropdown-menu a').simulate('mouseLeave');
+
+      expect(wrapper.find('.dropdown-menu').length).toBe(1);
+    });
+  });
 });
diff --git a/tests/js/spec/components/projectHeader/__snapshots__/projectSelector.spec.jsx.snap b/tests/js/spec/components/projectHeader/__snapshots__/projectSelector.spec.jsx.snap
index e9eaaa525d..bb4a922d3b 100644
--- a/tests/js/spec/components/projectHeader/__snapshots__/projectSelector.spec.jsx.snap
+++ b/tests/js/spec/components/projectHeader/__snapshots__/projectSelector.spec.jsx.snap
@@ -61,7 +61,7 @@ exports[`ProjectSelector render() can filter projects by project name 1`] = `
           className="dropdown project-dropdown open"
         >
           <a
-            className="dropdown-actor dropdown-toggle"
+            className="dropdown-actor dropdown-toggle hover"
             onClick={[Function]}
           >
             <div
@@ -188,7 +188,7 @@ exports[`ProjectSelector render() can filter projects by team name/project name
           className="dropdown project-dropdown open"
         >
           <a
-            className="dropdown-actor dropdown-toggle"
+            className="dropdown-actor dropdown-toggle hover"
             onClick={[Function]}
           >
             <div
@@ -492,7 +492,7 @@ exports[`ProjectSelector render() shows empty filter message when filtering has
           className="dropdown project-dropdown is-empty open"
         >
           <a
-            className="dropdown-actor dropdown-toggle"
+            className="dropdown-actor dropdown-toggle hover"
             onClick={[Function]}
           >
             <div
diff --git a/tests/js/spec/components/projectHeader/projectSelector.spec.jsx b/tests/js/spec/components/projectHeader/projectSelector.spec.jsx
index 0db44b3283..8b3b36f092 100644
--- a/tests/js/spec/components/projectHeader/projectSelector.spec.jsx
+++ b/tests/js/spec/components/projectHeader/projectSelector.spec.jsx
@@ -111,7 +111,6 @@ describe('ProjectSelector', function() {
     it('closes dropdown when project is selected', function() {
       let wrapper = mount(<ProjectSelector organization={mockOrg} projectId="" />, {});
       wrapper.find('.dropdown-actor').simulate('click');
-
       // Select first project
       wrapper
         .find('.dropdown-menu [role="presentation"] a')
diff --git a/tests/js/spec/views/__snapshots__/organizationIntegrations.spec.jsx.snap b/tests/js/spec/views/__snapshots__/organizationIntegrations.spec.jsx.snap
index 696ce5e59a..bd200a482f 100644
--- a/tests/js/spec/views/__snapshots__/organizationIntegrations.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/organizationIntegrations.spec.jsx.snap
@@ -30,7 +30,7 @@ exports[`OrganizationIntegrations render() with a provider renders 1`] = `
             className="dropdown pull-right anchor-right open"
           >
             <a
-              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle"
+              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle hover"
               onClick={[Function]}
             >
               <div
@@ -131,7 +131,7 @@ exports[`OrganizationIntegrations render() with a provider renders with a reposi
             className="dropdown pull-right anchor-right open"
           >
             <a
-              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle"
+              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle hover"
               onClick={[Function]}
             >
               <div
@@ -374,7 +374,7 @@ exports[`OrganizationIntegrations render() without any providers renders 1`] = `
             className="dropdown pull-right anchor-right open"
           >
             <a
-              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle"
+              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle hover"
               onClick={[Function]}
             >
               <div
diff --git a/tests/js/spec/views/__snapshots__/organizationRepositories.spec.jsx.snap b/tests/js/spec/views/__snapshots__/organizationRepositories.spec.jsx.snap
index 7ff9c36e07..e586be5ba9 100644
--- a/tests/js/spec/views/__snapshots__/organizationRepositories.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/organizationRepositories.spec.jsx.snap
@@ -28,7 +28,7 @@ exports[`OrganizationRepositories render() with a provider renders 1`] = `
             className="dropdown pull-right anchor-right open"
           >
             <a
-              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle"
+              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle hover"
               onClick={[Function]}
             >
               <div
@@ -196,7 +196,7 @@ exports[`OrganizationRepositories render() with a provider renders with a reposi
             className="dropdown pull-right anchor-right open"
           >
             <a
-              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle"
+              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle hover"
               onClick={[Function]}
             >
               <div
@@ -535,7 +535,7 @@ exports[`OrganizationRepositories render() without any providers renders 1`] = `
             className="dropdown pull-right anchor-right open"
           >
             <a
-              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle"
+              className="dropdown-actor btn btn-primary btn-sm dropdown-menu-right dropdown-toggle hover"
               onClick={[Function]}
             >
               <div
