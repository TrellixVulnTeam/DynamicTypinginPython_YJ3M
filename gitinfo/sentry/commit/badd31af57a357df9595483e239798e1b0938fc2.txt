commit badd31af57a357df9595483e239798e1b0938fc2
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Aug 6 20:28:43 2012 -0700

    Allow association of identities on existing accounts

diff --git a/sentry/templates/sentry/account/identities.html b/sentry/templates/sentry/account/identities.html
new file mode 100644
index 0000000000..09ff34e7c6
--- /dev/null
+++ b/sentry/templates/sentry/account/identities.html
@@ -0,0 +1,53 @@
+{% extends "sentry/account/base.html" %}
+
+{% load crispy_forms_tags %}
+{% load i18n %}
+{% load sentry_helpers %}
+
+{% block title %}{% trans "Identities" %} | {{ block.super }}{% endblock %}
+
+{% block breadcrumb %}
+    {{ block.super }}
+    <li class="divider">/</li>
+    <li><a href="{% url sentry-account-settings-identities %}">{% trans "Identities" %}</a></li>
+{% endblock %}
+
+{% block heading %}
+    {% trans "Identities" %}
+{% endblock %}
+
+{% block inner %}
+    <fieldset>
+        <legend>{% trans "Current Identities" %}</legend>
+    </fieldset>
+    {% if not identity_list %}
+        <p>{% trans "There are no identities associated with this account." %}</p>
+    {% else %}
+        <table class="table table-striped table-bordered">
+            <thead>
+                <tr>
+                    <th>{% trans "Identity" %}</th>
+                    <th style="width: 100px">&nbsp;</th>
+                </tr>
+            </thead>
+            <tbody>
+                {% for identity in identity_list %}
+                    <tr>
+                        <td>{{ identity }}</td>
+                        <td style="text-align: center;"><a href="{% url socialauth_disconnect_individual identity.provider identity.id %}?next={{ request.build_absolute_uri }}">Disconnect</a></td>
+                    </tr>
+                {% endfor %}
+            </tbody>
+        </table>
+    {% endif %}
+    {% if auth_engines %}
+        <fieldset>
+            <legend>Associate a New Account</legend>
+        </fieldset>
+        <ul class="auth-options">
+            {% for engine in auth_engines %}
+                <li><a href="{% url socialauth_associate_begin engine %}?next={{ request.build_absolute_uri }}" class="auth-{{ engine }}">Identify with {{ engine|title }}</a></li>
+            {% endfor %}
+        </ul>
+    {% endif %}
+{% endblock %}
diff --git a/sentry/templates/sentry/login.html b/sentry/templates/sentry/login.html
index 3c65ed6457..121fada81d 100644
--- a/sentry/templates/sentry/login.html
+++ b/sentry/templates/sentry/login.html
@@ -48,6 +48,10 @@
                     <fieldset>
                         <legend>Login with another account</legend>
                     </fieldset>
+                    {% url sentry-account-settings-identities as identities_link %}
+                    <p>{% blocktrans with identities_link as link %}If you already have an account, you can associate a social identity in the
+                        <a href="{{ link }}">identities</a> page in your account settings (after you login).{% endblocktrans %}</p>
+                    <br>
                     <ul class="auth-options">
                         {% for engine in auth_engines %}
                             <li><a href="{% url socialauth_begin engine %}" class="auth-{{ engine }}">Sign in with {{ engine|title }}</a></li>
diff --git a/sentry/templates/sentry/partial/_account_sidebar.html b/sentry/templates/sentry/partial/_account_sidebar.html
index 4e05fafe25..8536e26368 100644
--- a/sentry/templates/sentry/partial/_account_sidebar.html
+++ b/sentry/templates/sentry/partial/_account_sidebar.html
@@ -4,6 +4,7 @@
 <ul class="nav nav-tabs nav-stacked">
     <li{% if page == 'settings' %} class="active"{% endif %}><a href="{% url sentry-account-settings %}">{% trans "Account" %}</a></li>
     <li{% if page == 'notifications' %} class="active"{% endif %}><a href="{% url sentry-account-settings-notifications %}">{% trans "Notifications" %}</a></li>
+    <li{% if page == 'identities' %} class="active"{% endif %}><a href="{% url sentry-account-settings-identities %}">{% trans "Identities" %}</a></li>
 </ul>
 
 <h6>{% trans "Projects" %}</h6>
diff --git a/sentry/web/frontend/accounts.py b/sentry/web/frontend/accounts.py
index c7c0ac82f1..8a211ec8fb 100644
--- a/sentry/web/frontend/accounts.py
+++ b/sentry/web/frontend/accounts.py
@@ -27,6 +27,13 @@ AUTH_ENGINES = {
 }
 
 
+def get_auth_engines():
+    return [key
+        for key, cfg_names
+        in AUTH_ENGINES.iteritems()
+        if all(getattr(dj_settings, c, None) for c in cfg_names)]
+
+
 @csrf_protect
 def login(request):
     from django.contrib.auth import login as login_
@@ -39,10 +46,7 @@ def login(request):
     else:
         request.session.set_test_cookie()
 
-    auth_engines = [key
-        for key, cfg_names
-        in AUTH_ENGINES.iteritems()
-        if all(getattr(dj_settings, c, None) for c in cfg_names)]
+    auth_engines = get_auth_engines()
 
     context = csrf(request)
     context.update({
@@ -124,3 +128,21 @@ def notification_settings(request):
         'page': 'notifications',
     })
     return render_to_response('sentry/account/notifications.html', context, request)
+
+
+@csrf_protect
+@login_required
+def list_identities(request):
+    from social_auth.models import UserSocialAuth
+
+    identity_list = list(UserSocialAuth.objects.filter(user=request.user))
+
+    auth_engines = get_auth_engines()
+
+    context = csrf(request)
+    context.update({
+        'identity_list': identity_list,
+        'page': 'identities',
+        'auth_engines': auth_engines,
+    })
+    return render_to_response('sentry/account/identities.html', context, request)
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index edfcde28c1..c3d6e4471d 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -51,6 +51,7 @@ urlpatterns = patterns('',
     url(r'^logout/$', accounts.logout, name='sentry-logout'),
     url(r'^account/settings/$', accounts.settings, name='sentry-account-settings'),
     url(r'^account/settings/notifications/$', accounts.notification_settings, name='sentry-account-settings-notifications'),
+    url(r'^account/settings/identities/$', accounts.list_identities, name='sentry-account-settings-identities'),
 
     # Teams
 
