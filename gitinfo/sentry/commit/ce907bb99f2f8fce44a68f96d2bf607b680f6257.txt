commit ce907bb99f2f8fce44a68f96d2bf607b680f6257
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Tue Apr 17 15:45:59 2018 -0700

    feat: Add project avatar photo view

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index ace4d189a9..6c0bfd0bee 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -266,7 +266,9 @@ STATIC_URL = '/_static/{version}/'
 
 # various middleware will use this to identify resources which should not access
 # cookies
-ANONYMOUS_STATIC_PREFIXES = ('/_static/', '/avatar/', '/organization-avatar/', '/team-avatar/')
+ANONYMOUS_STATIC_PREFIXES = (
+    '/_static/', '/avatar/', '/organization-avatar/', '/team-avatar/', '/project-avatar/',
+)
 
 STATICFILES_FINDERS = (
     "django.contrib.staticfiles.finders.FileSystemFinder",
diff --git a/src/sentry/constants.py b/src/sentry/constants.py
index e436ae9fb1..7d70473756 100644
--- a/src/sentry/constants.py
+++ b/src/sentry/constants.py
@@ -87,7 +87,7 @@ RESERVED_ORGANIZATION_SLUGS = frozenset(
         'security', 'terms', 'from', 'sponsorship', 'for', 'at', 'platforms', 'branding', 'vs',
         'answers', '_admin', 'support', 'contact', 'onboarding', 'ext', 'extension', 'extensions',
         'plugins', 'themonitor', 'settings', 'legal', 'avatar', 'organization-avatar',
-        'team-avatar',
+        'project-avatar', 'team-avatar',
     )
 )
 
diff --git a/src/sentry/middleware/user.py b/src/sentry/middleware/user.py
index 2a1bbf3639..aa5e3e721e 100644
--- a/src/sentry/middleware/user.py
+++ b/src/sentry/middleware/user.py
@@ -9,6 +9,7 @@ class UserActiveMiddleware(object):
     disallowed_paths = (
         'sentry.web.frontend.generic.static_media',
         'sentry.web.frontend.organization_avatar',
+        'sentry.web.frontend.project_avatar',
         'sentry.web.frontend.team_avatar',
         'sentry.web.frontend.user_avatar',
     )
diff --git a/src/sentry/web/frontend/project_avatar.py b/src/sentry/web/frontend/project_avatar.py
new file mode 100644
index 0000000000..f3dfb71b1d
--- /dev/null
+++ b/src/sentry/web/frontend/project_avatar.py
@@ -0,0 +1,8 @@
+from __future__ import absolute_import
+
+from sentry.models import ProjectAvatar
+from sentry.web.frontend.base import AvatarPhotoView
+
+
+class ProjectAvatarPhotoView(AvatarPhotoView):
+    model = ProjectAvatar
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index 4250ad05da..465d7b83d3 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -37,12 +37,12 @@ from sentry.web.frontend.oauth_authorize import OAuthAuthorizeView
 from sentry.web.frontend.oauth_token import OAuthTokenView
 from sentry.auth.providers.saml2 import SAML2AcceptACSView, SAML2SLSView, SAML2MetadataView
 from sentry.web.frontend.organization_avatar import OrganizationAvatarPhotoView
-from sentry.web.frontend.team_avatar import TeamAvatarPhotoView
 from sentry.web.frontend.organization_auth_settings import \
     OrganizationAuthSettingsView
 from sentry.web.frontend.organization_integration_setup import \
     OrganizationIntegrationSetupView
 from sentry.web.frontend.out import OutView
+from sentry.web.frontend.project_avatar import ProjectAvatarPhotoView
 from sentry.web.frontend.react_page import GenericReactPageView, ReactPageView
 from sentry.web.frontend.reactivate_account import ReactivateAccountView
 from sentry.web.frontend.release_webhook import ReleaseWebhookView
@@ -50,6 +50,7 @@ from sentry.web.frontend.remove_account import RemoveAccountView
 from sentry.web.frontend.restore_organization import RestoreOrganizationView
 from sentry.web.frontend.remove_project import RemoveProjectView
 from sentry.web.frontend.transfer_project import TransferProjectView
+from sentry.web.frontend.team_avatar import TeamAvatarPhotoView
 from sentry.web.frontend.account_identity import AccountIdentityAssociateView, AccountIdentityLinkView
 from sentry.web.frontend.remove_team import RemoveTeamView
 from sentry.web.frontend.sudo import SudoView
@@ -452,6 +453,11 @@ urlpatterns += patterns(
         OrganizationAvatarPhotoView.as_view(),
         name='sentry-organization-avatar-url'
     ),
+    url(
+        r'^project-avatar/(?P<avatar_id>[^\/]+)/$',
+        ProjectAvatarPhotoView.as_view(),
+        name='sentry-project-avatar-url'
+    ),
     url(
         r'^team-avatar/(?P<avatar_id>[^\/]+)/$',
         TeamAvatarPhotoView.as_view(),
diff --git a/tests/sentry/web/frontend/test_project_avatar.py b/tests/sentry/web/frontend/test_project_avatar.py
new file mode 100644
index 0000000000..5304a1f5af
--- /dev/null
+++ b/tests/sentry/web/frontend/test_project_avatar.py
@@ -0,0 +1,22 @@
+from __future__ import absolute_import
+
+from django.core.urlresolvers import reverse
+from six import BytesIO
+
+from sentry.models import File, ProjectAvatar
+from sentry.testutils import TestCase
+from sentry.web.frontend.generic import FOREVER_CACHE
+
+
+class ProjectAvatarTest(TestCase):
+    def test_headers(self):
+        project = self.create_project()
+        photo = File.objects.create(name='test.png', type='avatar.file')
+        photo.putfile(BytesIO(b'test'))
+        avatar = ProjectAvatar.objects.create(project=project, file=photo)
+        url = reverse('sentry-project-avatar-url', kwargs={'avatar_id': avatar.ident})
+        response = self.client.get(url)
+        assert response.status_code == 200
+        assert response['Cache-Control'] == FOREVER_CACHE
+        assert response.get('Vary') is None
+        assert response.get('Set-Cookie') is None
