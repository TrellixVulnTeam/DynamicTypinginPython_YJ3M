commit 3a57a9e8e060890a88c5d4b118f389e0ae954883
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Wed May 18 02:51:18 2016 +0200

    Added a way to regenerate recovery codes

diff --git a/src/sentry/models/authenticator.py b/src/sentry/models/authenticator.py
index ab59e07159..3dd04a34b4 100644
--- a/src/sentry/models/authenticator.py
+++ b/src/sentry/models/authenticator.py
@@ -266,6 +266,13 @@ class RecoveryCodeInterface(AuthenticatorInterface):
             'used': 0,
         }
 
+    def regenerate_codes(self, save=True):
+        if not self.is_enrolled:
+            raise RuntimeError('Interface is not enrolled')
+        self.config.update(self.generate_new_config())
+        if save:
+            self.authenticator.save()
+
     def validate_otp(self, otp):
         mask = self.config['used']
         code = otp.strip().replace('-', '').upper()
diff --git a/src/sentry/templates/sentry/account/twofactor/configure.html b/src/sentry/templates/sentry/account/twofactor/configure.html
index 73caf9f771..d8d1a9c942 100644
--- a/src/sentry/templates/sentry/account/twofactor/configure.html
+++ b/src/sentry/templates/sentry/account/twofactor/configure.html
@@ -27,12 +27,14 @@
   <fieldset class="form-actions">
     <form action="" method="post" style="display: inline">
       {% csrf_token %}
-    {% if not auth.is_enrolled %}
-      <button type="submit" name="enroll" class="btn btn-primary">{{ auth.enroll_button }}</button>
-    {% else %}
-      <button type="submit" name="remove"
-        class="btn btn-default">{{ auth.remove_button }}</button>
-    {% endif %}
+      {% block twofactor_buttons %}
+        {% if not auth.is_enrolled %}
+          <button type="submit" name="enroll" class="btn btn-primary">{{ auth.enroll_button }}</button>
+        {% elif auth.remove_button %}
+          <button type="submit" name="remove"
+            class="btn btn-default">{{ auth.remove_button }}</button>
+        {% endif %}
+      {% endblock %}
     </form>
     <a href="{% url 'sentry-account-settings-2fa' %}" class="btn btn-default">{% trans "Back" %}</a>
   </fieldset>
diff --git a/src/sentry/templates/sentry/account/twofactor/configure_recovery.html b/src/sentry/templates/sentry/account/twofactor/configure_recovery.html
index 9fa08ef4dd..4d86443040 100644
--- a/src/sentry/templates/sentry/account/twofactor/configure_recovery.html
+++ b/src/sentry/templates/sentry/account/twofactor/configure_recovery.html
@@ -14,3 +14,7 @@
 {% endfor %}</pre>
   {% endif %}
 {% endblock %}
+{% block twofactor_buttons %}
+  <button type="submit" name="regenerate" class="btn btn-primary">Regenerate codes</button>
+  {{ block.super }}
+{% endblock %}
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index a1d64ed1d4..c6bdc5dbfc 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -118,6 +118,12 @@ class TwoFactorSettingsView(BaseView):
 class RecoveryCodeSettingsView(TwoFactorSettingsView):
     interface_id = 'recovery'
 
+    def configure(self, request, interface):
+        if 'regenerate' in request.POST:
+            interface.regenerate_codes()
+            return HttpResponseRedirect(request.path)
+        return TwoFactorSettingsView.configure(self, request, interface)
+
 
 class TotpSettingsView(TwoFactorSettingsView):
     interface_id = 'totp'
