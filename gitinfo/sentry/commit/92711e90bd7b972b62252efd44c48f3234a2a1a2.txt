commit 92711e90bd7b972b62252efd44c48f3234a2a1a2
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Tue Jan 22 14:29:58 2019 -0800

    ref(app-platform): Remove service hooks on app uninstall (#11610)
    
    * ref(app-platform): remove service hooks on app uninstall

diff --git a/src/sentry/mediators/sentry_app_installations/destroyer.py b/src/sentry/mediators/sentry_app_installations/destroyer.py
index b3ff336e64..b67215cb66 100644
--- a/src/sentry/mediators/sentry_app_installations/destroyer.py
+++ b/src/sentry/mediators/sentry_app_installations/destroyer.py
@@ -1,6 +1,8 @@
 from __future__ import absolute_import
 
 from sentry.mediators import Mediator, Param
+from sentry.mediators import service_hooks
+from sentry.models import ServiceHook
 
 
 class Destroyer(Mediator):
@@ -9,6 +11,7 @@ class Destroyer(Mediator):
     def call(self):
         self._destroy_authorization()
         self._destroy_grant()
+        self._destroy_service_hooks()
         self._destroy_installation()
         return self.install
 
@@ -18,5 +21,13 @@ class Destroyer(Mediator):
     def _destroy_grant(self):
         self.install.api_grant.delete()
 
+    def _destroy_service_hooks(self):
+        hooks = ServiceHook.objects.filter(
+            application_id=self.install.sentry_app.application_id,
+            actor_id=self.install.id,
+        )
+        for hook in hooks:
+            service_hooks.Destroyer.run(service_hook=hook)
+
     def _destroy_installation(self):
         self.install.delete()
diff --git a/tests/sentry/mediators/sentry_app_installations/test_destroyer.py b/tests/sentry/mediators/sentry_app_installations/test_destroyer.py
index bb671bb067..288f2ce357 100644
--- a/tests/sentry/mediators/sentry_app_installations/test_destroyer.py
+++ b/tests/sentry/mediators/sentry_app_installations/test_destroyer.py
@@ -3,7 +3,7 @@ from __future__ import absolute_import
 from django.db import connection
 
 from sentry.mediators.sentry_app_installations import Creator, Destroyer
-from sentry.models import ApiAuthorization, ApiGrant, SentryAppInstallation
+from sentry.models import ApiAuthorization, ApiGrant, SentryAppInstallation, ServiceHook
 from sentry.testutils import TestCase
 
 
@@ -11,11 +11,13 @@ class TestDestroyer(TestCase):
     def setUp(self):
         self.user = self.create_user()
         self.org = self.create_organization()
+        self.project = self.create_project(organization=self.org)
 
         self.sentry_app = self.create_sentry_app(
             name='nulldb',
             organization=self.org,
-            scopes=('project:read',),
+            scopes=('project:read', 'event:read'),
+            events=('issue',),
         )
 
         self.install = Creator.run(
@@ -40,6 +42,17 @@ class TestDestroyer(TestCase):
 
         assert not ApiGrant.objects.filter(pk=grant.id).exists()
 
+    def test_deletes_service_hooks(self):
+        hook = self.create_service_hook(
+            application=self.sentry_app.application,
+            project=self.project,
+            actor=self.install,
+        )
+
+        self.destroyer.call()
+
+        assert not ServiceHook.objects.filter(pk=hook.id).exists()
+
     def test_soft_deletes_installation(self):
         self.destroyer.call()
 
