commit 34796de3f17d447f083392a0cf7ebf998cb05208
Author: Ted Kaemming <ted@kaemming.com>
Date:   Tue Oct 13 12:47:52 2015 -0700

    Only save the rule ID with the record, not the entire rule.

diff --git a/src/sentry/digests/notifications.py b/src/sentry/digests/notifications.py
index 8f4197dec8..b503bea22c 100644
--- a/src/sentry/digests/notifications.py
+++ b/src/sentry/digests/notifications.py
@@ -32,14 +32,13 @@ def strip_for_serialization(instance):
     return cls(**{field.attname: getattr(instance, field.attname) for field in cls._meta.fields})
 
 
-# XXX: Rules
-def event_to_record(event, rules=[], clean=strip_for_serialization):
+def event_to_record(event, rules, clean=strip_for_serialization):
+    if not rules:
+        logger.warning('Creating record for %r that does not contain any rules!', event)
+
     return Record(
         event.event_id,
-        NotificationEvent(
-            clean(event),
-            map(clean, rules),
-        ),
+        NotificationEvent(clean(event), [rule.id for rule in rules]),
         to_timestamp(event.datetime),
     )
 
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index ac55a368f2..d3bfbdd6cd 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -221,7 +221,7 @@ class MailPluginTest(TestCase):
     @mock.patch('sentry.plugins.sentry_mail.models.MailPlugin._send_mail')
     def test_notify_digest(self, _send_mail):
         project = self.event.project
-        rule = Rule(id=1, project=project, data={})
+        rule = project.rule_set.all()[0]
         digest = build_digest(
             project,
             (
