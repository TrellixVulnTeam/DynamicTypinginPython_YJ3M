commit 8f3c12af087a27ceffcc281362693a1aa3acb1e8
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Aug 26 00:42:57 2014 -0700

    Expand API docs

diff --git a/src/sentry/api/base.py b/src/sentry/api/base.py
index c4224f3637..710e5ba6df 100644
--- a/src/sentry/api/base.py
+++ b/src/sentry/api/base.py
@@ -24,10 +24,10 @@ LINK_HEADER = '<{uri}&cursor={cursor}>; rel="{name}"'
 
 
 class DocSection(Enum):
-    ACCOUNTS = 'Accounts API'
-    TEAMS = 'Teams API'
-    PROJECTS = 'Projects API'
-    EVENTS = 'Events API'
+    ACCOUNTS = 'Accounts'
+    TEAMS = 'Teams'
+    PROJECTS = 'Projects'
+    EVENTS = 'Events'
 
 
 class Endpoint(APIView):
diff --git a/src/sentry/api/help_urls.py b/src/sentry/api/help_urls.py
index 9ce31fd605..de4ac49077 100644
--- a/src/sentry/api/help_urls.py
+++ b/src/sentry/api/help_urls.py
@@ -1,6 +1,7 @@
 from django.conf.urls import patterns, url
 
 from .views.help_index import ApiHelpIndexView
+from .views.help_section import ApiHelpSectionView
 
 
 urlpatterns = patterns(
@@ -8,4 +9,6 @@ urlpatterns = patterns(
 
     url(r'^$', ApiHelpIndexView.as_view(),
         name='sentry-api-0-help'),
+    url(r'^(?P<section_id>[^/]+)/$', ApiHelpSectionView.as_view(),
+        name='sentry-api-0-help-section'),
 )
diff --git a/src/sentry/api/views/help_base.py b/src/sentry/api/views/help_base.py
new file mode 100644
index 0000000000..e69de29bb2
diff --git a/src/sentry/api/views/help_index.py b/src/sentry/api/views/help_index.py
index f219ec3990..8903105afb 100644
--- a/src/sentry/api/views/help_index.py
+++ b/src/sentry/api/views/help_index.py
@@ -22,7 +22,7 @@ class ApiHelpIndexView(View):
     def get_sections(self, prefix=''):
         resource_list = sorted(
             (r for r in self.get_resources(prefix) if r['section']),
-            key=lambda x: x['section']
+            key=lambda x: x['section'].value,
         )
 
         section_list = []
@@ -30,7 +30,8 @@ class ApiHelpIndexView(View):
         for resource in resource_list:
             if resource['section'] != last_section:
                 section_list.append({
-                    'name': resource['section'],
+                    'id': resource['section'].name,
+                    'name': resource['section'].value,
                     'resources': [],
                 })
             section_list[-1]['resources'].append(resource)
diff --git a/src/sentry/api/views/help_section.py b/src/sentry/api/views/help_section.py
new file mode 100644
index 0000000000..ec460091cd
--- /dev/null
+++ b/src/sentry/api/views/help_section.py
@@ -0,0 +1,101 @@
+from django.contrib.admindocs.views import simplify_regex
+from django.http import Http404
+from django.utils.importlib import import_module
+from django.views.generic import View
+
+from sentry.api.base import DocSection, Endpoint
+from sentry.web.helpers import render_to_response
+
+METHODS = ('get', 'post', 'delete', 'patch')
+
+
+class ApiHelpSectionView(View):
+
+    def get(self, request, section_id):
+        try:
+            section = DocSection[section_id.upper()]
+        except KeyError:
+            raise Http404
+
+        context = {
+            'section': {
+                'id': section.name.lower(),
+                'name': section.value,
+            },
+            'resource_list': self.get_resources(section)
+        }
+
+        return render_to_response('sentry/help/api_section.html', context, request)
+
+    def get_resources(self, section, prefix='/api/0/'):
+        urls = import_module('sentry.api.urls')
+
+        resources = []
+        for pattern in urls.urlpatterns:
+            callback = self.__get_resource_callback(pattern, prefix)
+            if callback is None:
+                continue
+            if getattr(callback, 'doc_section', None) != section:
+                continue
+            data = self.__get_resource_data(pattern, prefix, callback)
+            resources.append(data)
+        return sorted(resources, key=lambda x: x['path'])
+
+    def __strip_doc(self, doc):
+        return doc.strip()
+
+    def __split_doc(self, doc, path):
+        if doc:
+            try:
+                title, doc = doc.split('\n', 1)
+            except ValueError:
+                title, doc = doc, ''
+        else:
+            title = path
+
+        return title.strip(), doc.strip()
+
+    def __get_resource_callback(self, pattern, prefix):
+        if not hasattr(pattern, 'callback'):
+            return
+
+        if hasattr(pattern.callback, 'cls'):
+            callback = pattern.callback.cls
+
+            if not issubclass(callback, Endpoint):
+                return
+        elif hasattr(pattern.callback, 'cls_instance'):
+            callback = pattern.callback.cls_instance
+
+            if not isinstance(callback, Endpoint):
+                return
+        else:
+            return
+
+        return callback
+
+    def __get_resource_data(self, pattern, prefix, callback):
+        path = simplify_regex(pattern.regex.pattern)
+
+        path = path.replace('<', '{').replace('>', '}')
+
+        methods = []
+        for method_name in METHODS:
+            method = getattr(callback, method_name, None)
+            if method is None:
+                continue
+            methods.append({
+                'name': method_name,
+                'doc': self.__strip_doc(method.__doc__ or ''),
+            })
+
+        title, docstring = self.__split_doc(
+            self.__strip_doc(callback.__doc__ or ''), path=path)
+
+        return {
+            'path': prefix.rstrip('/') + path,
+            'methods': methods,
+            'doc': docstring,
+            'title': title,
+            'section': getattr(callback, 'doc_section', None),
+        }
diff --git a/src/sentry/templates/sentry/help/api_index.html b/src/sentry/templates/sentry/help/api_index.html
index 0c0c90eb53..d81fcf075c 100644
--- a/src/sentry/templates/sentry/help/api_index.html
+++ b/src/sentry/templates/sentry/help/api_index.html
@@ -6,8 +6,6 @@
 {% block breadcrumbs %}
     {{ block.super }}
     <li class="divider">/</li>
-    <li>API</li>
-    <li class="divider">/</li>
     <li><a href="{% url 'sentry-help-platform-list' %}">Web API</a></li>
 {% endblock%}
 
@@ -33,25 +31,4 @@
     dateCreated: "2014-06-11T05:29:56.987Z",
     id: "4"
 }]</pre>
-
-    {% for section in section_list %}
-        <br>
-        <h3>{{ section.name }}</h3>
-        <div class="list-group">
-            {% for resource in section.resources %}
-                <a href="#" class="list-group-item">
-                    <h4>{{ resource.path }}</h4>
-                    {% if resource.doc %}
-                        {{ resource.doc|linebreaks }}
-                    {% endif %}
-                    {% for method in resource.methods %}
-                        <h5>{{ method.name.upper }}</h5>
-                        {% if method.doc %}
-                            {{ method.doc|linebreaks }}
-                        {% endif %}
-                    {% endfor %}
-                </a>
-            {% endfor %}
-        </div>
-    {% endfor %}
 {% endblock %}
diff --git a/src/sentry/templates/sentry/help/api_section.html b/src/sentry/templates/sentry/help/api_section.html
new file mode 100644
index 0000000000..f44a0069ed
--- /dev/null
+++ b/src/sentry/templates/sentry/help/api_section.html
@@ -0,0 +1,32 @@
+{% extends "sentry/help/index.html" %}
+
+{% load i18n %}
+{% load sentry_helpers %}
+
+{% block breadcrumbs %}
+    {{ block.super }}
+    <li class="divider">/</li>
+    <li><a href="{% url 'sentry-help-platform-list' %}">Web API</a></li>
+    <li class="divider">/</li>
+    <li><a href="{% url 'sentry-help-platform-list' %}">{{ section.name }}</a></li>
+{% endblock%}
+
+{% block main %}
+    <h2>{{ section.name }}</h2>
+    <div class="list-group">
+        {% for resource in resource_list %}
+            <a href="#" class="list-group-item">
+                <h4>{{ resource.path }}</h4>
+                {% if resource.doc %}
+                    {{ resource.doc|linebreaks }}
+                {% endif %}
+                {% for method in resource.methods %}
+                    <h5>{{ method.name.upper }}</h5>
+                    {% if method.doc %}
+                        {{ method.doc|linebreaks }}
+                    {% endif %}
+                {% endfor %}
+            </a>
+        {% endfor %}
+    </div>
+{% endblock %}
diff --git a/src/sentry/templates/sentry/help/sidebar.html b/src/sentry/templates/sentry/help/sidebar.html
index 6e50b85897..50885b7c73 100644
--- a/src/sentry/templates/sentry/help/sidebar.html
+++ b/src/sentry/templates/sentry/help/sidebar.html
@@ -21,8 +21,8 @@
 <h4>API Reference</h4>
 <ul>
     <li><a href="{% url 'sentry-api-0-help' %}">Overview</a></li>
-    {% for section_key, section_label in api_sections %}
-      <li><a href="{% url 'sentry-api-0-help' %}">{{ section_label }}</a></li>
+    {% for section in api_sections %}
+      <li><a href="{% url 'sentry-api-0-help-section' section.id %}">{{ section.name }}</a></li>
     {% endfor %}
     <li><a href="http://sentry.readthedocs.org/en/latest/developer/client/index.html">Client Specification</a></li>
 </ul>
diff --git a/src/sentry/templatetags/sentry_docs.py b/src/sentry/templatetags/sentry_docs.py
index bf12caf6c7..9ace118003 100644
--- a/src/sentry/templatetags/sentry_docs.py
+++ b/src/sentry/templatetags/sentry_docs.py
@@ -7,8 +7,9 @@ register = template.Library()
 
 @register.inclusion_tag('sentry/help/sidebar.html', takes_context=True)
 def render_doc_sidebar(context):
-    api_sections = sorted(((v.name, v.value) for v in DocSection),
-                          key=lambda x: x[1])
+    api_sections = sorted(
+        ({'id': v.name.lower(), 'name': v.value} for v in DocSection),
+        key=lambda x: x['name'])
 
     return {
         'api_sections': api_sections,
