commit 7bb02ebd1b960383c5776eb447766b5791c33462
Author: ted kaemming <ted@kaemming.com>
Date:   Mon Oct 17 16:50:11 2016 -0700

    Add dry run mode to weekly report pipeline. (#4378)
    
    This allows for running the entire pipeline without actually sending an
    email.
    
    Intended to be used for testing changes to data access methods, or
    warming caches to allow emails to be sent to specific users without
    requiring them to be sent to the entire organization.

diff --git a/src/sentry/tasks/reports.py b/src/sentry/tasks/reports.py
index 17452e5ef3..93733999b3 100644
--- a/src/sentry/tasks/reports.py
+++ b/src/sentry/tasks/reports.py
@@ -571,18 +571,18 @@ backend = RedisReportBackend(
 @instrumented_task(
     name='sentry.tasks.reports.prepare_reports',
     queue='reports.prepare')
-def prepare_reports(*args, **kwargs):
+def prepare_reports(dry_run=False, *args, **kwargs):
     timestamp, duration = _fill_default_parameters(*args, **kwargs)
 
     organization_ids = _get_organization_queryset().values_list('id', flat=True)
     for organization_id in organization_ids:
-        prepare_organization_report.delay(timestamp, duration, organization_id)
+        prepare_organization_report.delay(timestamp, duration, organization_id, dry_run=dry_run)
 
 
 @instrumented_task(
     name='sentry.tasks.reports.prepare_organization_report',
     queue='reports.prepare')
-def prepare_organization_report(timestamp, duration, organization_id):
+def prepare_organization_report(timestamp, duration, organization_id, dry_run=False):
     organization = _get_organization_queryset().get(id=organization_id)
 
     if not features.has('organizations:reports:prepare', organization):
@@ -603,6 +603,7 @@ def prepare_organization_report(timestamp, duration, organization_id):
             duration,
             organization_id,
             user_id,
+            dry_run=dry_run,
         )
 
 
@@ -707,7 +708,7 @@ def has_valid_aggregates(interval, (project, report)):
 @instrumented_task(
     name='sentry.tasks.reports.deliver_organization_user_report',
     queue='reports.deliver')
-def deliver_organization_user_report(timestamp, duration, organization_id, user_id):
+def deliver_organization_user_report(timestamp, duration, organization_id, user_id, dry_run=False):
     organization = _get_organization_queryset().get(id=organization_id)
     user = User.objects.get(id=user_id)
 
@@ -768,7 +769,7 @@ def deliver_organization_user_report(timestamp, duration, organization_id, user_
         reports,
     )
 
-    if features.has('organizations:reports:deliver', organization):
+    if not dry_run and features.has('organizations:reports:deliver', organization):
         message.send()
 
 
