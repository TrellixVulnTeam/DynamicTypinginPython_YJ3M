commit babf4437793977669571bc2dff1d42e17ea2e14c
Author: Tony <Zylphrex@users.noreply.github.com>
Date:   Wed Jul 8 15:00:58 2020 -0400

    fix(discover): Don't trim search terms that will be quoted (#19720)
    
    If a search term needs to be quoted, then we should not be trimming leading or
    trailing whitespaces as they may be necessary.

diff --git a/src/sentry/static/sentry/app/views/eventsV2/utils.tsx b/src/sentry/static/sentry/app/views/eventsV2/utils.tsx
index af275080f6..63e9839ee7 100644
--- a/src/sentry/static/sentry/app/views/eventsV2/utils.tsx
+++ b/src/sentry/static/sentry/app/views/eventsV2/utils.tsx
@@ -331,7 +331,18 @@ function generateAdditionalConditions(
     // match their name.
     if (dataRow.hasOwnProperty(dataKey)) {
       const value = dataRow[dataKey];
-      const nextValue = value === null || value === undefined ? '' : String(value).trim();
+      // if the value will be quoted, then do not trim it as the whitespaces
+      // may be important to the query and should not be trimmed
+      const shouldQuote =
+        value === null || value === undefined
+          ? false
+          : /[\s\(\)\\"]/g.test(String(value).trim());
+      const nextValue =
+        value === null || value === undefined
+          ? ''
+          : shouldQuote
+          ? String(value)
+          : String(value).trim();
 
       switch (column.field) {
         case 'timestamp':
diff --git a/tests/js/spec/views/eventsV2/utils.spec.jsx b/tests/js/spec/views/eventsV2/utils.spec.jsx
index 0ef56ac16d..8980a840b9 100644
--- a/tests/js/spec/views/eventsV2/utils.spec.jsx
+++ b/tests/js/spec/views/eventsV2/utils.spec.jsx
@@ -435,6 +435,18 @@ describe('getExpandedResults()', function() {
     const result = getExpandedResults(view, {}, event);
     expect(result.query).toEqual('project.name:whoosh');
   });
+
+  it('should not trim values that need to be quoted', () => {
+    const view = new EventView({
+      ...state,
+      query: '',
+      fields: [{field: 'title'}],
+    });
+    // needs to be quoted because of whitespace in middle
+    const event = {title: 'hello there '};
+    const result = getExpandedResults(view, {}, event);
+    expect(result.query).toEqual('title:"hello there "');
+  });
 });
 
 describe('downloadAsCsv', function() {
