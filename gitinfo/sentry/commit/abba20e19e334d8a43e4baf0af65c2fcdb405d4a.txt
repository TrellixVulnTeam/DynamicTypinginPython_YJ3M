commit abba20e19e334d8a43e4baf0af65c2fcdb405d4a
Author: Chris Fuller <chris@iprogramstuff.com>
Date:   Tue Oct 1 12:55:37 2019 -0400

    fix(ui): Adds locked project id to the URL on issue details page if it does not exist. (#14731)
    
    * Replacing/Adding project URL Paramter with forced project ID
    
    * In progress work; attempting to work with project as a blank parameter or 'all'
    
    * Comitting fix for SEN-1024 - dealing with issue list <-> details transition later
    
    * Removing console.log
    
    * Linter cleanup
    
    * Camel case, explicit query.project setting
    
    * Prettier change
    
    * Switchign branches
    
    * Switchign branches
    
    * Adding allp workround, Removing logs.
    
    * Removing unused variable
    
    * Adding comments and removing _allp on navigation to issue details
    
    * Fixing typos
    
    * Updating snapshot
    
    * Linting
    
    * Making linter happy?

diff --git a/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx b/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
index 1a5d520597..cf5c5f6b14 100644
--- a/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
+++ b/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
@@ -1,6 +1,6 @@
 import PropTypes from 'prop-types';
 import React from 'react';
-import {withRouter, Link} from 'react-router';
+import {withRouter} from 'react-router';
 import styled, {css} from 'react-emotion';
 import classNames from 'classnames';
 import {capitalize} from 'lodash';
@@ -9,6 +9,7 @@ import SentryTypes from 'app/sentryTypes';
 import EventOrGroupTitle from 'app/components/eventOrGroupTitle';
 import Tooltip from 'app/components/tooltip';
 import {getMessage, getLocation} from 'app/utils/events';
+import GlobalSelectionLink from 'app/components/globalSelectionLink';
 
 /**
  * Displays an event or group/issue title (i.e. in Stream)
@@ -43,15 +44,22 @@ class EventOrGroupHeader extends React.Component {
     const basePath = `/organizations/${orgId}/issues/`;
 
     if (includeLink) {
+      const locationWithProject = {...this.props.location};
+      const query =
+        locationWithProject.query.project !== undefined
+          ? {
+              query: this.props.query,
+            }
+          : {query: this.props.query, _allp: 1}; //This appends _allp to the URL parameters if they have no project selected ("all" projects included in results). This is so that when we enter the issue details page and lock them to a project, we can properly take them back to the issue list page with no project selected (and not the locked project selected)
+
       props.to = {
         pathname: `${basePath}${isEvent ? groupID : id}/${
           isEvent ? `events/${data.id}/` : ''
         }`,
-        search: `${
-          this.props.query ? `?query=${window.encodeURIComponent(this.props.query)}` : ''
-        }`,
+        query,
       };
-      Wrapper = Link;
+
+      Wrapper = GlobalSelectionLink;
     } else {
       Wrapper = 'span';
     }
diff --git a/src/sentry/static/sentry/app/views/organizationGroupDetails/groupDetails.jsx b/src/sentry/static/sentry/app/views/organizationGroupDetails/groupDetails.jsx
index 1abb1f053a..ef219b5761 100644
--- a/src/sentry/static/sentry/app/views/organizationGroupDetails/groupDetails.jsx
+++ b/src/sentry/static/sentry/app/views/organizationGroupDetails/groupDetails.jsx
@@ -126,6 +126,19 @@ const GroupDetails = createReactClass({
           Sentry.withScope(scope => {
             Sentry.captureException(new Error('Project not found'));
           });
+        } else {
+          const locationWithProject = {...this.props.location};
+          if (
+            locationWithProject.query.project === undefined &&
+            locationWithProject.query._allp === undefined
+          ) {
+            //We use _allp as a temporary measure to know they came from the issue list page with no project selected (all projects included in filter).
+            //If it is not defined, we add the locked project id to the URL (this is because if someone navigates directly to an issue on single-project priveleges, then goes back - they were getting assigned to the first project).
+            //If it is defined, we do not so that our back button will bring us to the issue list page with no project selected instead of the locked project.
+            locationWithProject.query.project = project.id;
+          }
+          delete locationWithProject.query._allp; //We delete _allp from the URL to keep the hack a bit cleaner, but this is not an ideal solution and will ultimately be replaced with something smarter.
+          browserHistory.replace(locationWithProject);
         }
 
         this.setState({
diff --git a/tests/js/spec/views/organizationGroupDetails/__snapshots__/groupSimilar.spec.jsx.snap b/tests/js/spec/views/organizationGroupDetails/__snapshots__/groupSimilar.spec.jsx.snap
index ac4df3f055..cf68d38a45 100644
--- a/tests/js/spec/views/organizationGroupDetails/__snapshots__/groupSimilar.spec.jsx.snap
+++ b/tests/js/spec/views/organizationGroupDetails/__snapshots__/groupSimilar.spec.jsx.snap
@@ -768,7 +768,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                       Array [
                                         Object {
                                           "pathname": "/organizations/org-slug/issues/271/",
-                                          "search": "",
+                                          "query": Object {
+                                            "_allp": 1,
+                                            "query": undefined,
+                                          },
                                         },
                                       ],
                                       Array [
@@ -782,7 +785,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                       Array [
                                         Object {
                                           "pathname": "/organizations/org-slug/issues/271/",
-                                          "search": "",
+                                          "query": Object {
+                                            "_allp": 1,
+                                            "query": undefined,
+                                          },
                                         },
                                       ],
                                       Array [
@@ -843,9 +849,8 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                     className="css-10b3zgy-Title-truncateStyles eex8od0"
                                     size="normal"
                                   >
-                                    <Link
+                                    <GlobalSelectionLink
                                       data-test-id="resolved-issue"
-                                      onlyActiveOnIndex={false}
                                       style={
                                         Object {
                                           "textDecoration": "line-through",
@@ -854,176 +859,196 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                       to={
                                         Object {
                                           "pathname": "/organizations/org-slug/issues/271/",
-                                          "search": "",
+                                          "query": Object {
+                                            "_allp": 1,
+                                            "query": undefined,
+                                          },
                                         }
                                       }
                                     >
-                                      <a
+                                      <Link
                                         data-test-id="resolved-issue"
-                                        onClick={[Function]}
+                                        onlyActiveOnIndex={false}
                                         style={
                                           Object {
                                             "textDecoration": "line-through",
                                           }
                                         }
+                                        to={
+                                          Object {
+                                            "pathname": "/organizations/org-slug/issues/271/",
+                                            "query": Object {
+                                              "_allp": 1,
+                                              "query": undefined,
+                                            },
+                                          }
+                                        }
                                       >
-                                        <GroupLevel
-                                          level="error"
+                                        <a
+                                          data-test-id="resolved-issue"
+                                          onClick={[Function]}
+                                          style={
+                                            Object {
+                                              "textDecoration": "line-through",
+                                            }
+                                          }
                                         >
-                                          <div
-                                            className="css-1oawdkn-GroupLevel eex8od5"
+                                          <GroupLevel
+                                            level="error"
                                           >
-                                            <Tooltip
-                                              containerDisplayMode="inline-block"
-                                              position="top"
-                                              title="Error level: Error"
+                                            <div
+                                              className="css-1oawdkn-GroupLevel eex8od5"
                                             >
-                                              <Manager>
-                                                <Reference>
-                                                  <InnerReference
-                                                    setReferenceNode={[Function]}
-                                                  >
-                                                    <span
-                                                      aria-describedby="tooltip-123456"
-                                                      onBlur={[Function]}
-                                                      onFocus={[Function]}
-                                                      onMouseEnter={[Function]}
-                                                      onMouseLeave={[Function]}
-                                                    />
-                                                  </InnerReference>
-                                                </Reference>
-                                              </Manager>
-                                            </Tooltip>
-                                          </div>
-                                        </GroupLevel>
-                                        <EventOrGroupTitle
-                                          data={
-                                            Object {
-                                              "annotations": Array [],
-                                              "assignedTo": null,
-                                              "count": "90",
-                                              "culprit": "length(app/views/groupSimilar/groupSimilarView)",
-                                              "firstSeen": "2017-07-10T18:32:43Z",
-                                              "hasSeen": false,
-                                              "id": "271",
-                                              "isBookmarked": false,
-                                              "isPublic": false,
-                                              "isSubscribed": true,
-                                              "lastSeen": "2017-07-24T23:41:44Z",
-                                              "level": "error",
-                                              "logger": "javascript",
-                                              "metadata": Object {
-                                                "type": "TypeError",
-                                                "value": "Cannot read property 'length' of undefined",
-                                              },
-                                              "numComments": 0,
-                                              "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
-                                              "project": Object {
-                                                "id": "123",
-                                                "name": "Internal",
-                                                "slug": "project-slug",
-                                              },
-                                              "shareId": "312e323731",
-                                              "shortId": "INTERNAL-4G",
-                                              "status": "resolved",
-                                              "statusDetails": Object {},
-                                              "subscriptionDetails": null,
-                                              "title": "TypeError: Cannot read property 'length' of undefined",
-                                              "type": "error",
-                                              "userCount": 3,
+                                              <Tooltip
+                                                containerDisplayMode="inline-block"
+                                                position="top"
+                                                title="Error level: Error"
+                                              >
+                                                <Manager>
+                                                  <Reference>
+                                                    <InnerReference
+                                                      setReferenceNode={[Function]}
+                                                    >
+                                                      <span
+                                                        aria-describedby="tooltip-123456"
+                                                        onBlur={[Function]}
+                                                        onFocus={[Function]}
+                                                        onMouseEnter={[Function]}
+                                                        onMouseLeave={[Function]}
+                                                      />
+                                                    </InnerReference>
+                                                  </Reference>
+                                                </Manager>
+                                              </Tooltip>
+                                            </div>
+                                          </GroupLevel>
+                                          <EventOrGroupTitle
+                                            data={
+                                              Object {
+                                                "annotations": Array [],
+                                                "assignedTo": null,
+                                                "count": "90",
+                                                "culprit": "length(app/views/groupSimilar/groupSimilarView)",
+                                                "firstSeen": "2017-07-10T18:32:43Z",
+                                                "hasSeen": false,
+                                                "id": "271",
+                                                "isBookmarked": false,
+                                                "isPublic": false,
+                                                "isSubscribed": true,
+                                                "lastSeen": "2017-07-24T23:41:44Z",
+                                                "level": "error",
+                                                "logger": "javascript",
+                                                "metadata": Object {
+                                                  "type": "TypeError",
+                                                  "value": "Cannot read property 'length' of undefined",
+                                                },
+                                                "numComments": 0,
+                                                "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
+                                                "project": Object {
+                                                  "id": "123",
+                                                  "name": "Internal",
+                                                  "slug": "project-slug",
+                                                },
+                                                "shareId": "312e323731",
+                                                "shortId": "INTERNAL-4G",
+                                                "status": "resolved",
+                                                "statusDetails": Object {},
+                                                "subscriptionDetails": null,
+                                                "title": "TypeError: Cannot read property 'length' of undefined",
+                                                "type": "error",
+                                                "userCount": 3,
+                                              }
                                             }
-                                          }
-                                          includeLink={true}
-                                          location={
-                                            Object {
-                                              "query": Object {},
+                                            includeLink={true}
+                                            location={
+                                              Object {
+                                                "query": Object {},
+                                              }
                                             }
-                                          }
-                                          params={
-                                            Object {
-                                              "groupId": "group-id",
-                                              "orgId": "org-slug",
-                                              "projectId": "project-slug",
+                                            params={
+                                              Object {
+                                                "groupId": "group-id",
+                                                "orgId": "org-slug",
+                                                "projectId": "project-slug",
+                                              }
                                             }
-                                          }
-                                          router={
-                                            Object {
-                                              "createHref": [MockFunction] {
-                                                "calls": Array [
-                                                  Array [
+                                            router={
+                                              Object {
+                                                "createHref": [MockFunction] {
+                                                  "calls": Array [
+                                                    Array [
+                                                      Object {
+                                                        "pathname": "/organizations/org-slug/issues/271/",
+                                                        "query": Object {
+                                                          "_allp": 1,
+                                                          "query": undefined,
+                                                        },
+                                                      },
+                                                    ],
+                                                    Array [
+                                                      Object {
+                                                        "pathname": "/organizations/org-slug/issues/",
+                                                        "query": Object {
+                                                          "query": "logger:javascript",
+                                                        },
+                                                      },
+                                                    ],
+                                                    Array [
+                                                      Object {
+                                                        "pathname": "/organizations/org-slug/issues/271/",
+                                                        "query": Object {
+                                                          "_allp": 1,
+                                                          "query": undefined,
+                                                        },
+                                                      },
+                                                    ],
+                                                    Array [
+                                                      Object {
+                                                        "pathname": "/organizations/org-slug/issues/",
+                                                        "query": Object {
+                                                          "query": "logger:javascript",
+                                                        },
+                                                      },
+                                                    ],
+                                                  ],
+                                                  "results": Array [
                                                     Object {
-                                                      "pathname": "/organizations/org-slug/issues/271/",
-                                                      "search": "",
+                                                      "type": "return",
+                                                      "value": undefined,
                                                     },
-                                                  ],
-                                                  Array [
                                                     Object {
-                                                      "pathname": "/organizations/org-slug/issues/",
-                                                      "query": Object {
-                                                        "query": "logger:javascript",
-                                                      },
+                                                      "type": "return",
+                                                      "value": undefined,
                                                     },
-                                                  ],
-                                                  Array [
                                                     Object {
-                                                      "pathname": "/organizations/org-slug/issues/271/",
-                                                      "search": "",
+                                                      "type": "return",
+                                                      "value": undefined,
                                                     },
-                                                  ],
-                                                  Array [
                                                     Object {
-                                                      "pathname": "/organizations/org-slug/issues/",
-                                                      "query": Object {
-                                                        "query": "logger:javascript",
-                                                      },
+                                                      "type": "return",
+                                                      "value": undefined,
                                                     },
                                                   ],
-                                                ],
-                                                "results": Array [
-                                                  Object {
-                                                    "type": "return",
-                                                    "value": undefined,
-                                                  },
-                                                  Object {
-                                                    "type": "return",
-                                                    "value": undefined,
-                                                  },
-                                                  Object {
-                                                    "type": "return",
-                                                    "value": undefined,
-                                                  },
-                                                  Object {
-                                                    "type": "return",
-                                                    "value": undefined,
-                                                  },
-                                                ],
-                                              },
-                                              "go": [MockFunction],
-                                              "goBack": [MockFunction],
-                                              "goForward": [MockFunction],
-                                              "isActive": [MockFunction],
-                                              "listen": [MockFunction],
-                                              "location": Object {
-                                                "query": Object {},
-                                              },
-                                              "params": Object {
-                                                "groupId": "group-id",
-                                                "orgId": "org-slug",
-                                                "projectId": "project-slug",
-                                              },
-                                              "push": [MockFunction],
-                                              "replace": [MockFunction],
-                                              "setRouteLeaveHook": [MockFunction],
-                                            }
-                                          }
-                                          size="normal"
-                                          style={
-                                            Object {
-                                              "fontWeight": 600,
+                                                },
+                                                "go": [MockFunction],
+                                                "goBack": [MockFunction],
+                                                "goForward": [MockFunction],
+                                                "isActive": [MockFunction],
+                                                "listen": [MockFunction],
+                                                "location": Object {
+                                                  "query": Object {},
+                                                },
+                                                "params": Object {
+                                                  "groupId": "group-id",
+                                                  "orgId": "org-slug",
+                                                  "projectId": "project-slug",
+                                                },
+                                                "push": [MockFunction],
+                                                "replace": [MockFunction],
+                                                "setRouteLeaveHook": [MockFunction],
+                                              }
                                             }
-                                          }
-                                        >
-                                          <span
+                                            size="normal"
                                             style={
                                               Object {
                                                 "fontWeight": 600,
@@ -1033,22 +1058,30 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                             <span
                                               style={
                                                 Object {
-                                                  "marginRight": 10,
+                                                  "fontWeight": 600,
                                                 }
                                               }
                                             >
-                                              TypeError
+                                              <span
+                                                style={
+                                                  Object {
+                                                    "marginRight": 10,
+                                                  }
+                                                }
+                                              >
+                                                TypeError
+                                              </span>
+                                              <em
+                                                title="length(app/views/groupSimilar/groupSimilarView)"
+                                              >
+                                                length(app/views/groupSimilar/groupSimilarView)
+                                              </em>
+                                              <br />
                                             </span>
-                                            <em
-                                              title="length(app/views/groupSimilar/groupSimilarView)"
-                                            >
-                                              length(app/views/groupSimilar/groupSimilarView)
-                                            </em>
-                                            <br />
-                                          </span>
-                                        </EventOrGroupTitle>
-                                      </a>
-                                    </Link>
+                                          </EventOrGroupTitle>
+                                        </a>
+                                      </Link>
+                                    </GlobalSelectionLink>
                                   </div>
                                 </Title>
                                 <Message
@@ -1151,7 +1184,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                       Array [
                                         Object {
                                           "pathname": "/organizations/org-slug/issues/271/",
-                                          "search": "",
+                                          "query": Object {
+                                            "_allp": 1,
+                                            "query": undefined,
+                                          },
                                         },
                                       ],
                                       Array [
@@ -1165,7 +1201,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                       Array [
                                         Object {
                                           "pathname": "/organizations/org-slug/issues/271/",
-                                          "search": "",
+                                          "query": Object {
+                                            "_allp": 1,
+                                            "query": undefined,
+                                          },
                                         },
                                       ],
                                       Array [
