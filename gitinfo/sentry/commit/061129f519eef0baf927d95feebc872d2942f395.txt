commit 061129f519eef0baf927d95feebc872d2942f395
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Aug 31 15:37:18 2015 -0700

    Auto sanitize values that are urls in data scrubber

diff --git a/src/sentry/utils/data_scrubber.py b/src/sentry/utils/data_scrubber.py
index 46ee395be4..55c97c1c18 100644
--- a/src/sentry/utils/data_scrubber.py
+++ b/src/sentry/utils/data_scrubber.py
@@ -9,6 +9,7 @@ from __future__ import absolute_import
 
 import re
 import six
+from urlparse import urlsplit, urlunsplit
 
 from sentry.constants import DEFAULT_SCRUBBED_FIELDS
 
@@ -71,10 +72,30 @@ class SensitiveDataFilter(object):
         if value is None:
             return
 
-        if isinstance(value, six.string_types) and self.VALUES_RE.search(value):
-            return self.MASK
+        if isinstance(value, six.string_types):
+            if self.VALUES_RE.search(value):
+                return self.MASK
 
-        if isinstance(key, basestring):
+            # Check if the value is a url-like object
+            # that contains a password
+            # e.g. postgres://foo:password@example.com/db
+            if '//' in value:
+                pieces = urlsplit(value)
+
+                # The following is slightly modified from CPython
+                # source to avoid repeating ourselves:
+                # https://hg.python.org/cpython/file/2.7/Lib/urlparse.py#l87
+                netloc = pieces.netloc
+                if '@' in netloc:
+                    userinfo, host = netloc.rsplit('@', 1)
+                    if ':' in userinfo:
+                        netloc = '%s:%s@%s' % (userinfo.split(':', 1)[0], self.MASK, host)
+                        # Using urlunsplit here is safe because we're guaranteeing netloc
+                        # has a value. If netloc were empty, we could yield incorrect
+                        # results.
+                        return urlunsplit((pieces[0], netloc) + pieces[2:])
+
+        if isinstance(key, six.string_types):
             key = key.lower()
         else:
             key = ''
diff --git a/tests/sentry/utils/test_data_scrubber.py b/tests/sentry/utils/test_data_scrubber.py
index 80c03a10f3..2f0cae3077 100644
--- a/tests/sentry/utils/test_data_scrubber.py
+++ b/tests/sentry/utils/test_data_scrubber.py
@@ -150,6 +150,16 @@ class SensitiveDataFilterTest(TestCase):
         result = proc.sanitize('foo', "foo 4242424242424242")
         self.assertEquals(result, proc.MASK)
 
+    def test_sanitize_url(self):
+        proc = SensitiveDataFilter()
+        result = proc.sanitize('foo', 'pg://matt:pass@localhost/1')
+        self.assertEquals(result, 'pg://matt:%s@localhost/1' % proc.MASK)
+        # Make sure we don't mess up any other url.
+        # This url specifically if passed through urlunsplit(urlsplit()),
+        # it'll change the value.
+        result = proc.sanitize('foo', 'postgres:///path')
+        self.assertEquals(result, 'postgres:///path')
+
     def test_sanitize_http_body(self):
         data = {
             'sentry.interfaces.Http': {
