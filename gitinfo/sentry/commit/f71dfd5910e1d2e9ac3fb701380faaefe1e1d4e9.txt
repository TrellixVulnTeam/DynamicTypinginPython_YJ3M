commit f71dfd5910e1d2e9ac3fb701380faaefe1e1d4e9
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Fri Jan 3 23:59:13 2020 +0300

    fix(export): Fix broken export command after Django upgrades (#16250)
    
    A few things this command relied on got deprecated and removed so it stopped working after these. This patch makes it work again. We should probably add tests around this to prevent further breakage.

diff --git a/src/sentry/runner/commands/backup.py b/src/sentry/runner/commands/backup.py
index 19d5b03885..ca6cb9d880 100644
--- a/src/sentry/runner/commands/backup.py
+++ b/src/sentry/runner/commands/backup.py
@@ -16,7 +16,7 @@ def import_(src):
         obj.save()
 
 
-def sort_dependencies(app_list):
+def sort_dependencies():
     """
     Similar to Django's except that we discard the important of natural keys
     when sorting dependencies (i.e. it works without them).
@@ -26,9 +26,8 @@ def sort_dependencies(app_list):
     # Process the list of models, and get the list of dependencies
     model_dependencies = []
     models = set()
-    for app, model_list in app_list:
-        if model_list is None:
-            model_list = apps.get_app_config(app).get_models()
+    for app_config in apps.get_app_configs():
+        model_list = app_config.get_models()
 
         for model in model_list:
             models.add(model)
@@ -114,14 +113,11 @@ def export(dest, silent, indent, exclude):
     else:
         exclude = exclude.lower().split(",")
 
-    from django.db.models import get_apps
     from django.core import serializers
 
     def yield_objects():
-        app_list = [(a, None) for a in get_apps()]
-
         # Collate the objects to be serialized.
-        for model in sort_dependencies(app_list):
+        for model in sort_dependencies():
             if (
                 not getattr(model, "__core__", True)
                 or model.__name__.lower() in exclude
@@ -138,5 +134,5 @@ def export(dest, silent, indent, exclude):
     if not silent:
         click.echo(">> Beginning export", err=True)
     serializers.serialize(
-        "json", yield_objects(), indent=indent, stream=dest, use_natural_keys=True
+        "json", yield_objects(), indent=indent, stream=dest, use_natural_foreign_keys=True
     )
