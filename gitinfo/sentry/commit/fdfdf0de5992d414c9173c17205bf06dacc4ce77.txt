commit fdfdf0de5992d414c9173c17205bf06dacc4ce77
Author: Mark Story <mark@mark-story.com>
Date:   Mon Jan 14 15:51:57 2019 -0500

    fix(integrations) Fix jira server failure on invalid key (#11501)
    
    We should validate the uploaded private key so we can avoid hard
    failures later.
    
    Fixes APP-997

diff --git a/src/sentry/integrations/jira_server/integration.py b/src/sentry/integrations/jira_server/integration.py
index c46ff29b96..7d3467009f 100644
--- a/src/sentry/integrations/jira_server/integration.py
+++ b/src/sentry/integrations/jira_server/integration.py
@@ -3,6 +3,8 @@ from __future__ import absolute_import
 import logging
 import six
 
+from cryptography.hazmat.primitives.serialization import load_pem_private_key
+from cryptography.hazmat.backends import default_backend
 from django import forms
 from django.core.urlresolvers import reverse
 from django.utils.translation import ugettext as _
@@ -95,7 +97,8 @@ class InstallationForm(forms.Form):
     private_key = forms.CharField(
         label=_('Jira Consumer Private Key'),
         widget=forms.Textarea(
-            attrs={'placeholder': _('--PRIVATE KEY--')}
+            attrs={'placeholder': _(
+                '-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----')}
         )
     )
 
@@ -103,6 +106,16 @@ class InstallationForm(forms.Form):
         """Strip off trailing / as they cause invalid URLs downstream"""
         return self.cleaned_data['url'].rstrip('/')
 
+    def clean_private_key(self):
+        data = self.cleaned_data['private_key']
+
+        try:
+            load_pem_private_key(data.encode('utf-8'), None, default_backend())
+        except Exception:
+            raise forms.ValidationError(
+                'Private key must be a valid SSH private key encoded in a PEM format.')
+        return data
+
 
 class InstallationConfigView(PipelineView):
     """
diff --git a/tests/sentry/integrations/jira_server/test_integration.py b/tests/sentry/integrations/jira_server/test_integration.py
index 9b46381f7f..12160fae6e 100644
--- a/tests/sentry/integrations/jira_server/test_integration.py
+++ b/tests/sentry/integrations/jira_server/test_integration.py
@@ -28,6 +28,28 @@ class JiraServerIntegrationTest(IntegrationTestCase):
         self.assertContains(resp, 'Connect Sentry')
         self.assertContains(resp, 'Submit</button>')
 
+    @responses.activate
+    def test_validate_private_key(self):
+        responses.add(
+            responses.POST,
+            'https://jira.example.com/plugins/servlet/oauth/request-token',
+            status=503)
+
+        # Start pipeline and go to setup page.
+        self.client.get(self.setup_path)
+
+        # Submit credentials
+        data = {
+            'url': 'https://jira.example.com/',
+            'verify_ssl': False,
+            'consumer_key': 'sentry-bot',
+            'private_key': 'hot-garbage'
+        }
+        resp = self.client.post(self.setup_path, data=data)
+        assert resp.status_code == 200
+        self.assertContains(
+            resp, 'Private key must be a valid SSH private key encoded in a PEM format.')
+
     @responses.activate
     def test_authentication_request_token_fails(self):
         responses.add(
