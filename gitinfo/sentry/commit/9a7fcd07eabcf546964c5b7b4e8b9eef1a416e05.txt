commit 9a7fcd07eabcf546964c5b7b4e8b9eef1a416e05
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Oct 15 15:05:20 2010 -0700

    Better error handling for Redmine

diff --git a/sentry/media/styles/global.css b/sentry/media/styles/global.css
index cf6ab10a63..4764112574 100644
--- a/sentry/media/styles/global.css
+++ b/sentry/media/styles/global.css
@@ -180,7 +180,7 @@ div.commands a { color:black; text-decoration:none; }
 #reporter_body #traceback li { list-style-type: inherit; }
 #reporter_body #traceback { padding: 8px; margin-top: 10px; }
 #reporter_body td, #reporter_body th { border-bottom: 0; font:small sans-serif; line-height: auto; }
-.error { background: #ffc; }
+.error { background: #ffc; padding: 5px; }
 .specific { color:#cc3300; font-weight:bold; }
 h2 span.commands { font-size:.7em;}
 span.commands a:link {color:#5E5694;}
@@ -522,6 +522,9 @@ form table {
 }
 form table td { padding: 5px; }
 form .submit { text-align: right; }
+form .has-errors input,
+form .has-errors textarea { border-color: red; }
+form td .errors { color: red; margin-top: 5px; font-size: 0.9em; }
 
 form td textarea {
     min-height: 250px;
diff --git a/sentry/plugins/sentry_redmine/models.py b/sentry/plugins/sentry_redmine/models.py
index 41810ec16c..33c30f99ce 100644
--- a/sentry/plugins/sentry_redmine/models.py
+++ b/sentry/plugins/sentry_redmine/models.py
@@ -53,13 +53,16 @@ class CreateRedmineIssue(GroupActionProvider):
                 try:
                     response = urllib2.urlopen(req, data).read()
                 except urllib2.HTTPError, e:
-                    raise Exception('%s: %s' % (e.code, e.read()))
-                
-                data = simplejson.loads(response)
-                RedmineIssue.objects.create(group=group, issue_id=data['id'])
-                group.data['redmine'] = {'issue_id': data['id']}
-                group.save()
-                return HttpResponseRedirect(reverse('sentry-group', args=[group.pk]))
+                    form.errors['__all__'] = 'Bad response from Redmine: %s %s' % (e.code, e.read())
+                except urllib2.URLError, e:
+                    print dir(e), e.__dict__
+                    form.errors['__all__'] = 'Unable to reach Redmine host: %s' % (e.reason,)
+                else:
+                    data = simplejson.loads(response)
+                    RedmineIssue.objects.create(group=group, issue_id=data['id'])
+                    group.data['redmine'] = {'issue_id': data['id']}
+                    group.save()
+                    return HttpResponseRedirect(reverse('sentry-group', args=[group.pk]))
         else:
             description = 'Sentry Message: %s' % request.build_absolute_uri(group.get_absolute_url())
             description += '\n\n<pre>' + (group.traceback or group.message) + '</pre>'
@@ -68,6 +71,8 @@ class CreateRedmineIssue(GroupActionProvider):
                 'subject': group.error(),
                 'description': description,
             })
+            
+        global_errors = form.errors.get('__all__')
 
         BASE_TEMPLATE = "sentry/group/details.html"
 
diff --git a/sentry/plugins/sentry_redmine/templates/sentry/plugins/redmine/create_issue.html b/sentry/plugins/sentry_redmine/templates/sentry/plugins/redmine/create_issue.html
index 495f875539..6bcde1c7f7 100644
--- a/sentry/plugins/sentry_redmine/templates/sentry/plugins/redmine/create_issue.html
+++ b/sentry/plugins/sentry_redmine/templates/sentry/plugins/redmine/create_issue.html
@@ -7,18 +7,31 @@
 	<form method="post" action="">
 		<input type="hidden" name="next" value="{{ next }}" />
 		{% csrf_token %}
+		{% if global_errors %}
+			<p class="error">{{ global_errors }}</p>
+		{% endif %}
 		<table>
 			<colgroup>
 				<col width="100px"/>
 				<col/>
 			</colgroup>
-			<tr>
+			<tr{% if form.subject.errors %} class="has-errors"{% endif %}>
 				<td>{{ form.subject.label_tag }}</td>
-				<td>{{ form.subject }}</td>
+				<td>
+					{{ form.subject }}
+					{% if form.subject.errors %}
+						<div class="errors">{{ form.subject.errors|join:", " }}</div>
+					{% endif %}
+				</td>
 			</tr>
-			<tr>
+			<tr{% if form.description.errors %} class="has-errors"{% endif %}>
 				<td>{{ form.description.label_tag }}</td>
-				<td>{{ form.description }}</td>
+				<td>
+					{{ form.description }}
+					{% if form.description.errors %}
+						<div class="errors">{{ form.description.errors|join:", " }}</div>
+					{% endif %}
+				</td>
 			</tr>
 		</table>
 		<div class="submit">
