commit 15a97ac5aaa68b69431520744df2675e4ae14e8a
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Dec 17 09:35:00 2018 -0800

    api: Speed up releasefile endpoints
    
    The ReleaseFile serializer attempts to look at `self.dist` which causes
    O(n) queries, so this changes the serializer to be lazy, as well as
    adding a JOIN so it doesn't need to fetch it at all.

diff --git a/src/sentry/api/endpoints/organization_release_files.py b/src/sentry/api/endpoints/organization_release_files.py
index 06bbe2d579..86bdf8cf96 100644
--- a/src/sentry/api/endpoints/organization_release_files.py
+++ b/src/sentry/api/endpoints/organization_release_files.py
@@ -46,7 +46,7 @@ class OrganizationReleaseFilesEndpoint(OrganizationReleasesBaseEndpoint):
 
         file_list = ReleaseFile.objects.filter(
             release=release,
-        ).select_related('file').order_by('name')
+        ).select_related('file', 'dist').order_by('name')
 
         return self.paginate(
             request=request,
diff --git a/src/sentry/api/endpoints/project_release_files.py b/src/sentry/api/endpoints/project_release_files.py
index 83fbab5d89..6e68c57847 100644
--- a/src/sentry/api/endpoints/project_release_files.py
+++ b/src/sentry/api/endpoints/project_release_files.py
@@ -79,7 +79,7 @@ class ProjectReleaseFilesEndpoint(ProjectEndpoint):
 
         file_list = ReleaseFile.objects.filter(
             release=release,
-        ).select_related('file').order_by('name')
+        ).select_related('file', 'dist').order_by('name')
 
         return self.paginate(
             request=request,
diff --git a/src/sentry/api/serializers/models/release_file.py b/src/sentry/api/serializers/models/release_file.py
index 79ca0a11e2..b6bc9322eb 100644
--- a/src/sentry/api/serializers/models/release_file.py
+++ b/src/sentry/api/serializers/models/release_file.py
@@ -12,7 +12,7 @@ class ReleaseFileSerializer(Serializer):
         return {
             'id': six.text_type(obj.id),
             'name': obj.name,
-            'dist': obj.dist and obj.dist.name or None,
+            'dist': obj.dist_id and obj.dist.name or None,
             'headers': obj.file.headers,
             'size': obj.file.size,
             'sha1': obj.file.checksum,
diff --git a/src/sentry/models/releasefile.py b/src/sentry/models/releasefile.py
index f8187587f6..ab29a5967e 100644
--- a/src/sentry/models/releasefile.py
+++ b/src/sentry/models/releasefile.py
@@ -43,7 +43,7 @@ class ReleaseFile(Model):
 
     def save(self, *args, **kwargs):
         if not self.ident and self.name:
-            dist = self.dist and self.dist.name or None
+            dist = self.dist_id and self.dist.name or None
             self.ident = type(self).get_ident(self.name, dist)
         return super(ReleaseFile, self).save(*args, **kwargs)
 
