commit 49d96e05af856b8c16f9dac32c8f8c7bb1ff0647
Author: MeredithAnya <meredith@getsentry.com>
Date:   Tue May 14 15:03:51 2019 -0700

    ref(app-platform): Set api token on sentry app installation (#13190)
    
    * associate token with install
    
    * add some tests

diff --git a/src/sentry/mediators/token_exchange/grant_exchanger.py b/src/sentry/mediators/token_exchange/grant_exchanger.py
index fa0dbed11d..8589f36251 100644
--- a/src/sentry/mediators/token_exchange/grant_exchanger.py
+++ b/src/sentry/mediators/token_exchange/grant_exchanger.py
@@ -29,14 +29,7 @@ class GrantExchanger(Mediator):
         # Once it's exchanged it's no longer valid and should not be
         # exchangable, so we delete it.
         self._delete_grant()
-
-        self.token = ApiToken.objects.create(
-            user=self.user,
-            application=self.application,
-            scope_list=self.sentry_app.scope_list,
-            expires_at=token_expiration()
-        )
-
+        self._create_token()
         return self.token
 
     def record_analytics(self):
@@ -74,6 +67,16 @@ class GrantExchanger(Mediator):
     def _delete_grant(self):
         self.grant.delete()
 
+    def _create_token(self):
+        self.token = ApiToken.objects.create(
+            user=self.user,
+            application=self.application,
+            scope_list=self.sentry_app.scope_list,
+            expires_at=token_expiration()
+        )
+        self.install.api_token = self.token
+        self.install.save()
+
     @memoize
     def grant(self):
         try:
diff --git a/src/sentry/mediators/token_exchange/refresher.py b/src/sentry/mediators/token_exchange/refresher.py
index 6d239b3a61..bb625b57ef 100644
--- a/src/sentry/mediators/token_exchange/refresher.py
+++ b/src/sentry/mediators/token_exchange/refresher.py
@@ -24,13 +24,7 @@ class Refresher(Mediator):
     def call(self):
         self._validate()
         self._delete_token()
-
-        return ApiToken.objects.create(
-            user=self.user,
-            application=self.application,
-            scope_list=self.sentry_app.scope_list,
-            expires_at=token_expiration(),
-        )
+        return self._create_new_token()
 
     def record_analytics(self):
         analytics.record(
@@ -55,6 +49,17 @@ class Refresher(Mediator):
     def _delete_token(self):
         self.token.delete()
 
+    def _create_new_token(self):
+        token = ApiToken.objects.create(
+            user=self.user,
+            application=self.application,
+            scope_list=self.sentry_app.scope_list,
+            expires_at=token_expiration(),
+        )
+        self.install.api_token = token
+        self.install.save()
+        return token
+
     @memoize
     def token(self):
         try:
diff --git a/tests/sentry/mediators/token_exchange/test_grant_exchanger.py b/tests/sentry/mediators/token_exchange/test_grant_exchanger.py
index e361d5e724..5a3607d0f5 100644
--- a/tests/sentry/mediators/token_exchange/test_grant_exchanger.py
+++ b/tests/sentry/mediators/token_exchange/test_grant_exchanger.py
@@ -4,7 +4,7 @@ from mock import patch
 from datetime import datetime, timedelta
 
 from sentry.coreapi import APIUnauthorized
-from sentry.models import ApiApplication, SentryApp, ApiGrant
+from sentry.models import ApiApplication, SentryApp, SentryAppInstallation, ApiGrant
 from sentry.mediators.token_exchange import GrantExchanger
 from sentry.testutils import TestCase
 
@@ -26,6 +26,10 @@ class TestGrantExchanger(TestCase):
     def test_happy_path(self):
         assert self.grant_exchanger.call()
 
+    def test_adds_token_to_installation(self):
+        token = self.grant_exchanger.call()
+        assert SentryAppInstallation.objects.get(id=self.install.id).api_token == token
+
     @patch('sentry.mediators.token_exchange.Validator.run')
     def test_validate_generic_token_exchange_requirements(self, validator):
         self.grant_exchanger.call()
diff --git a/tests/sentry/mediators/token_exchange/test_refresher.py b/tests/sentry/mediators/token_exchange/test_refresher.py
index b260c9c876..338da78a42 100644
--- a/tests/sentry/mediators/token_exchange/test_refresher.py
+++ b/tests/sentry/mediators/token_exchange/test_refresher.py
@@ -3,7 +3,7 @@ from __future__ import absolute_import
 from mock import patch
 
 from sentry.coreapi import APIUnauthorized
-from sentry.models import ApiApplication, ApiToken, SentryApp
+from sentry.models import ApiApplication, ApiToken, SentryApp, SentryAppInstallation
 from sentry.mediators.token_exchange import GrantExchanger, Refresher
 from sentry.testutils import TestCase
 
@@ -31,6 +31,10 @@ class TestRefresher(TestCase):
     def test_happy_path(self):
         assert self.refresher.call()
 
+    def test_adds_token_to_installation(self):
+        token = self.refresher.call()
+        assert SentryAppInstallation.objects.get(id=self.install.id).api_token == token
+
     def test_deletes_refreshed_token(self):
         self.refresher.call()
         assert not ApiToken.objects.filter(id=self.token.id).exists()
