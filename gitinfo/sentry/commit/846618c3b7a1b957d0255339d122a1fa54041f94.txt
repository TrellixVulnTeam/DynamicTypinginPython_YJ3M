commit 846618c3b7a1b957d0255339d122a1fa54041f94
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue May 5 12:22:13 2020 +0200

    fix(grouping): Do not produce legacy checksums that cannot be stored (#18617)

diff --git a/src/sentry/grouping/api.py b/src/sentry/grouping/api.py
index 390321332a..ab0a4762e0 100644
--- a/src/sentry/grouping/api.py
+++ b/src/sentry/grouping/api.py
@@ -173,11 +173,19 @@ def get_grouping_variants_for_event(event, config=None):
     if checksum:
         if HASH_RE.match(checksum):
             return {"checksum": ChecksumVariant(checksum)}
-        return {
-            "checksum": ChecksumVariant(checksum),
+
+        rv = {
             "hashed-checksum": ChecksumVariant(hash_from_values(checksum), hashed=True),
         }
 
+        # The legacy code path also supported arbitrary values here but
+        # it will blow up if it results in more than 32 bytes of data
+        # as this cannot be inserted into the database.  (See GroupHash.hash)
+        if len(checksum) <= 32:
+            rv["checksum"] = ChecksumVariant(checksum)
+
+        return rv
+
     # Otherwise we go to the various forms of fingerprint handling.
     fingerprint = event.data.get("fingerprint") or ["{{ default }}"]
     defaults_referenced = sum(1 if d in DEFAULT_FINGERPRINT_VALUES else 0 for d in fingerprint)
