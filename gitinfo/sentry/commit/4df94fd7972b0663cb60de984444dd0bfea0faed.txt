commit 4df94fd7972b0663cb60de984444dd0bfea0faed
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jul 2 13:47:31 2015 -0700

    Correctly support authentication in internal client

diff --git a/src/sentry/api/client.py b/src/sentry/api/client.py
index 6f3bd0c965..328b1e521a 100644
--- a/src/sentry/api/client.py
+++ b/src/sentry/api/client.py
@@ -2,8 +2,7 @@ from __future__ import absolute_import
 
 __all__ = ('ApiClient',)
 
-from django.core.urlresolvers import resolve
-from rest_framework.test import APIRequestFactory
+from rest_framework.test import APIClient as DefaultAPIClient
 
 from sentry.utils import json
 
@@ -26,30 +25,16 @@ class ApiClient(object):
                 is_sudo=False):
         full_path = self.prefix + path
 
-        resolver_match = resolve(full_path)
-        callback, callback_args, callback_kwargs = resolver_match
-
         if data:
             # we encode to ensure compatibility
             data = json.loads(json.dumps(data))
 
-        rf = APIRequestFactory()
-        mock_request = getattr(rf, method.lower())(full_path, data)
-        mock_request.auth = auth
-        mock_request.user = user
-        mock_request.is_sudo = lambda: is_sudo
-
-        if params:
-            mock_request.GET._mutable = True
-            mock_request.GET.update(params)
-            mock_request.GET._mutable = False
+        # TODO(dcramer): implement is_sudo
+        client = DefaultAPIClient()
+        client.force_authenticate(user, auth)
 
-        if data:
-            mock_request.POST._mutable = True
-            mock_request.POST.update(data)
-            mock_request.POST._mutable = False
+        response = getattr(client, method.lower())(full_path, data)
 
-        response = callback(mock_request, *callback_args, **callback_kwargs)
         if 200 <= response.status_code < 400:
             return response
         raise self.ApiError(response.status_code, response.data)
