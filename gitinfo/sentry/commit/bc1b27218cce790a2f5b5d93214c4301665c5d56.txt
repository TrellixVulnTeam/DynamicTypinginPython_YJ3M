commit bc1b27218cce790a2f5b5d93214c4301665c5d56
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Nov 13 01:04:12 2012 -0800

    Dont include domain in login redirect url (violates simple security check)

diff --git a/src/sentry/web/decorators.py b/src/sentry/web/decorators.py
index 05f5be8083..2d5d367909 100644
--- a/src/sentry/web/decorators.py
+++ b/src/sentry/web/decorators.py
@@ -34,7 +34,7 @@ def has_access(group_or_func=None):
             # If we're asking for anything other than implied access, the user
             # must be authenticated
             if group_or_func is not None and not request.user.is_authenticated():
-                request.session['_next'] = request.build_absolute_uri()
+                request.session['_next'] = request.get_full_path()
                 return HttpResponseRedirect(get_login_url())
 
             # XXX: if project_id isn't set, should we only allow superuser?
@@ -149,7 +149,7 @@ def login_required(func):
     def wrapped(request, *args, **kwargs):
         if not settings.PUBLIC:
             if not request.user.is_authenticated():
-                request.session['_next'] = request.build_absolute_uri()
+                request.session['_next'] = request.get_full_path()
                 return HttpResponseRedirect(get_login_url())
         return func(request, *args, **kwargs)
     return wrapped
@@ -159,7 +159,7 @@ def requires_admin(func):
     @wraps(func)
     def wrapped(request, *args, **kwargs):
         if not request.user.is_authenticated():
-            request.session['_next'] = request.build_absolute_uri()
+            request.session['_next'] = request.get_full_path()
             return HttpResponseRedirect(get_login_url())
         if not request.user.is_staff:
             return render_to_response('sentry/missing_permissions.html', status=400)
@@ -172,7 +172,7 @@ def permission_required(perm):
         @wraps(func)
         def _wrapped(request, *args, **kwargs):
             if not request.user.is_authenticated():
-                request.session['_next'] = request.build_absolute_uri()
+                request.session['_next'] = request.get_full_path()
                 return HttpResponseRedirect(get_login_url())
             if not request.user.has_perm(perm):
                 return render_to_response('sentry/missing_permissions.html', status=400)
diff --git a/src/sentry/web/frontend/generic.py b/src/sentry/web/frontend/generic.py
index 059deccf9e..9b82b20077 100644
--- a/src/sentry/web/frontend/generic.py
+++ b/src/sentry/web/frontend/generic.py
@@ -26,7 +26,7 @@ def dashboard(request):
 
     if not has_projects:
         if not request.user.is_authenticated():
-            request.session['_next'] = request.build_absolute_uri()
+            request.session['_next'] = request.get_full_path()
             return HttpResponseRedirect(get_login_url())
         elif can_create_projects(request.user):
             return HttpResponseRedirect(reverse('sentry-new-project'))
