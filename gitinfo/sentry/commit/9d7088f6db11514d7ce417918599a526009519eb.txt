commit 9d7088f6db11514d7ce417918599a526009519eb
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Tue Sep 24 14:13:35 2019 -0700

    feat(ui): Upgrade to mobx@5 (from v3) (#14798)
    
    Lots of changes w/ 2 major version bumps, but because our mobx usage is pretty limited, not much affects us. Lots of deprecation, but nothing that we use. Requires native `Map`, which we already require.
    
    The reason for this upgrade is because of how arrays are unhandled in versions < 4. They are observable array objects with array like methods and properties. This causes issues in things like tests because `Array.isArray(observableArray) === false`. We have some hacks in our tests and components, but generally is very hard to debug. In `mobx >= 4`, they are native Arrays, so we don't need to do any workarounds.
    
    ## Bundle Sizes
    There is not much of an overall change and comparing the sizes of all `*.js.gzip`, `v5` comes out a tiny bit smaller.

diff --git a/package.json b/package.json
index e696e94e1c..126a086e0a 100644
--- a/package.json
+++ b/package.json
@@ -76,8 +76,8 @@
     "lodash-webpack-plugin": "^0.11.5",
     "marked": "0.6.2",
     "mini-css-extract-plugin": "^v0.5.0",
-    "mobx": "^3.2.2",
-    "mobx-react": "^4.2.2",
+    "mobx": "^5.13.0",
+    "mobx-react": "~5.4.4",
     "moment": "2.23.0",
     "moment-timezone": "0.5.25",
     "node-libs-browser": "0.5.3",
diff --git a/src/sentry/static/sentry/app/components/forms/selectControl.jsx b/src/sentry/static/sentry/app/components/forms/selectControl.jsx
index 9989ff10f0..468b5baf09 100644
--- a/src/sentry/static/sentry/app/components/forms/selectControl.jsx
+++ b/src/sentry/static/sentry/app/components/forms/selectControl.jsx
@@ -5,6 +5,15 @@ import styled from 'react-emotion';
 
 import convertFromSelect2Choices from 'app/utils/convertFromSelect2Choices';
 
+/**
+ * The library has `value` defined as `PropTypes.object`, but this
+ * is not the case when `multiple` is true :/
+ */
+ReactSelect.Value.propTypes = {
+  ...ReactSelect.Value.propTypes,
+  value: PropTypes.any,
+};
+
 export default class SelectControl extends React.Component {
   static propTypes = {
     ...ReactSelect.propTypes,
diff --git a/src/sentry/static/sentry/app/views/settings/account/apiNewToken.jsx b/src/sentry/static/sentry/app/views/settings/account/apiNewToken.jsx
index 27f85cc046..c93a0e49ca 100644
--- a/src/sentry/static/sentry/app/views/settings/account/apiNewToken.jsx
+++ b/src/sentry/static/sentry/app/views/settings/account/apiNewToken.jsx
@@ -67,7 +67,7 @@ export default class ApiNewToken extends React.Component {
                   {({value, onChange}) => (
                     <MultipleCheckbox
                       onChange={onChange}
-                      value={value.peek()}
+                      value={value}
                       choices={API_CHOICES}
                     />
                   )}
diff --git a/src/sentry/static/sentry/app/views/settings/components/forms/model.tsx b/src/sentry/static/sentry/app/views/settings/components/forms/model.tsx
index f13557b87b..8fb9ae5a2a 100644
--- a/src/sentry/static/sentry/app/views/settings/components/forms/model.tsx
+++ b/src/sentry/static/sentry/app/views/settings/components/forms/model.tsx
@@ -33,7 +33,7 @@ class FormModel {
   /**
    * Map of field name -> value
    */
-  fields: ObservableMap<FieldValue> = observable.map();
+  fields: ObservableMap<string, FieldValue> = observable.map();
 
   /**
    * Errors for individual fields
diff --git a/src/sentry/static/sentry/app/views/settings/components/forms/selectField.jsx b/src/sentry/static/sentry/app/views/settings/components/forms/selectField.jsx
index 945a85887f..a03b2b180b 100644
--- a/src/sentry/static/sentry/app/views/settings/components/forms/selectField.jsx
+++ b/src/sentry/static/sentry/app/views/settings/components/forms/selectField.jsx
@@ -60,22 +60,11 @@ export default class SelectField extends React.Component {
       <InputField
         {...otherProps}
         alignRight={this.props.small}
-        field={({onChange, onBlur, disabled, required, ...props}) => {
+        field={({onChange, onBlur, disabled, required: _required, ...props}) => {
           // We remove the required property here since applying it to the
           // DOM causes the native tooltip to render in strange places.
           const choices = getChoices(props);
 
-          // Check if value quacks like mobx and get the raw array.
-          // Inside Form containers `value` can be a mobx observable
-          // which doesn't play nice with downstream code.
-          let val = props.value;
-          if (
-            multiple &&
-            Array.isArray(val) === false &&
-            typeof val.peek === 'function'
-          ) {
-            val = val.peek();
-          }
           return (
             <SelectControl
               {...props}
@@ -83,7 +72,7 @@ export default class SelectField extends React.Component {
               multiple={multiple}
               disabled={disabled}
               onChange={this.handleChange.bind(this, onBlur, onChange)}
-              value={val}
+              value={props.value}
               options={choices.map(([value, label]) => ({
                 value,
                 label,
diff --git a/src/sentry/static/sentry/app/views/settings/project/serviceHookSettingsForm.jsx b/src/sentry/static/sentry/app/views/settings/project/serviceHookSettingsForm.jsx
index 0fc9a83ec0..0236596458 100644
--- a/src/sentry/static/sentry/app/views/settings/project/serviceHookSettingsForm.jsx
+++ b/src/sentry/static/sentry/app/views/settings/project/serviceHookSettingsForm.jsx
@@ -64,7 +64,7 @@ export default class ServiceHookSettingsForm extends React.Component {
               {({value, onChange}) => (
                 <MultipleCheckbox
                   onChange={onChange}
-                  value={value.peek()}
+                  value={value}
                   choices={EVENT_CHOICES}
                 />
               )}
diff --git a/tests/js/spec/views/settings/organizationDeveloperSettings/sentryApplicationDetails.spec.jsx b/tests/js/spec/views/settings/organizationDeveloperSettings/sentryApplicationDetails.spec.jsx
index 3eb1ac6caa..7ece6a0b5c 100644
--- a/tests/js/spec/views/settings/organizationDeveloperSettings/sentryApplicationDetails.spec.jsx
+++ b/tests/js/spec/views/settings/organizationDeveloperSettings/sentryApplicationDetails.spec.jsx
@@ -1,4 +1,3 @@
-import {observable} from 'mobx';
 import React from 'react';
 
 import {Client} from 'app/api';
@@ -91,8 +90,13 @@ describe('Sentry Application Details', function() {
         organization: org.slug,
         redirectUrl: 'https://webhook.com/setup',
         webhookUrl: 'https://webhook.com',
-        scopes: observable(['member:read', 'member:admin', 'event:read', 'event:admin']),
-        events: observable(['issue']),
+        scopes: expect.arrayContaining([
+          'member:read',
+          'member:admin',
+          'event:read',
+          'event:admin',
+        ]),
+        events: ['issue'],
         isInternal: false,
         verifyInstall: true,
         isAlertable: true,
@@ -321,7 +325,7 @@ describe('Sentry Application Details', function() {
         expect.objectContaining({
           data: expect.objectContaining({
             redirectUrl: 'https://hello.com/',
-            events: observable.array([]),
+            events: [],
           }),
           method: 'PUT',
         })
@@ -344,7 +348,7 @@ describe('Sentry Application Details', function() {
         `/sentry-apps/${sentryApp.slug}/`,
         expect.objectContaining({
           data: expect.objectContaining({
-            events: observable.array([]),
+            events: [],
           }),
           method: 'PUT',
         })
diff --git a/yarn.lock b/yarn.lock
index 48270de5c9..d6483df332 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -7253,7 +7253,7 @@ hoist-non-react-statics@^2.3.1:
   resolved "https://registry.yarnpkg.com/hoist-non-react-statics/-/hoist-non-react-statics-2.3.1.tgz#343db84c6018c650778898240135a1420ee22ce0"
   integrity sha1-ND24TGAYxlB3iJgkATWhQg7iLOA=
 
-hoist-non-react-statics@^3.3.0:
+hoist-non-react-statics@^3.0.0, hoist-non-react-statics@^3.3.0:
   version "3.3.0"
   resolved "https://registry.yarnpkg.com/hoist-non-react-statics/-/hoist-non-react-statics-3.3.0.tgz#b09178f0122184fb95acf525daaecb4d8f45958b"
   integrity sha512-0XsbTXxgiaCDYDIWFcwkmerZPSwywfUqYmwT4jzewKTQSWoE6FCMoUVOeBJWK3E/CrWbxRG3m5GzY4lnIwGRBA==
@@ -9642,17 +9642,18 @@ mkdirp@0.5.x, mkdirp@^0.5.0, mkdirp@^0.5.1, mkdirp@~0.5.0, mkdirp@~0.5.1:
   dependencies:
     minimist "0.0.8"
 
-mobx-react@^4.2.2:
-  version "4.3.5"
-  resolved "https://registry.yarnpkg.com/mobx-react/-/mobx-react-4.3.5.tgz#76853f2f2ef4a6f960c374bcd9f01e875929c04c"
-  integrity sha1-doU/Ly70pvlgw3S82fAeh1kpwEw=
+mobx-react@~5.4.4:
+  version "5.4.4"
+  resolved "https://registry.yarnpkg.com/mobx-react/-/mobx-react-5.4.4.tgz#b3de9c6eabcd0ed8a40036888cb0221ab9568b80"
+  integrity sha512-2mTzpyEjVB/RGk2i6KbcmP4HWcAUFox5ZRCrGvSyz49w20I4C4qql63grPpYrS9E9GKwgydBHQlA4y665LuRCQ==
   dependencies:
-    hoist-non-react-statics "^2.3.1"
+    hoist-non-react-statics "^3.0.0"
+    react-lifecycles-compat "^3.0.2"
 
-mobx@^3.2.2:
-  version "3.4.1"
-  resolved "https://registry.yarnpkg.com/mobx/-/mobx-3.4.1.tgz#37abe5ee882d401828d9f26c6c1a2f47614bbbef"
-  integrity sha1-N6vl7ogtQBgo2fJsbBovR2FLu+8=
+mobx@^5.13.0:
+  version "5.13.0"
+  resolved "https://registry.yarnpkg.com/mobx/-/mobx-5.13.0.tgz#0fd68f10aa5ff2d146a4ed9e145b53337cfbca59"
+  integrity sha512-eSAntMSMNj0PFL705rgv+aB/z1RjNqDnFEpBe18yQVreXTWiVgIrmBUXzjnJfuba+eo4eAk6zi+/gXQkSUea8A==
 
 mockdate@2.0.2:
   version "2.0.2"
@@ -11910,7 +11911,7 @@ react-lazyload@^2.3.0:
   resolved "https://registry.yarnpkg.com/react-lazyload/-/react-lazyload-2.3.0.tgz#ccb134223012447074a96543954f44b055dc6185"
   integrity sha512-0z3qmL+qtSERdfKFpn0yKXm+1Gg1ZLZBXnCzHhSGiu1L8iDARuCkbOypxEx9+ETxZvMnXj98xvWCs5jyXTuM2w==
 
-react-lifecycles-compat@^3.0.0, react-lifecycles-compat@^3.0.4:
+react-lifecycles-compat@^3.0.0, react-lifecycles-compat@^3.0.2, react-lifecycles-compat@^3.0.4:
   version "3.0.4"
   resolved "https://registry.yarnpkg.com/react-lifecycles-compat/-/react-lifecycles-compat-3.0.4.tgz#4f1a273afdfc8f3488a8c516bfda78f872352362"
   integrity sha512-fBASbA6LnOU9dOU2eW7aQ8xmYBSXUIWr+UmF9b1efZBazGNO+rcXT/icdKnYm2pTwcRylVUYwW7H1PHfLekVzA==
