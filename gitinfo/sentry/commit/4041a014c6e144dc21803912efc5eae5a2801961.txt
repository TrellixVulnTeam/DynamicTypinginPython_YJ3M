commit 4041a014c6e144dc21803912efc5eae5a2801961
Author: Jess MacQueen <jess@getsentry.com>
Date:   Mon Oct 23 14:47:48 2017 -0700

    feat(repos): Send notification when repo deletion fails

diff --git a/src/sentry/models/repository.py b/src/sentry/models/repository.py
index cf77dd6b8d..2a4b072b14 100644
--- a/src/sentry/models/repository.py
+++ b/src/sentry/models/repository.py
@@ -40,12 +40,38 @@ class Repository(Model):
         provider_cls = bindings.get('repository.provider').get(self.provider)
         return provider_cls(self.provider)
 
+    def generate_delete_fail_email(self, error_message):
+        from sentry.utils.email import MessageBuilder
+
+        new_context = {
+            'repo': self,
+            'error_message': error_message,
+        }
+
+        return MessageBuilder(
+            subject='Unable to Delete Repository',
+            context=new_context,
+            template='sentry/emails/unable-to-delete-repo.txt',
+            html_template='sentry/emails/unable-to-delete-repo.html',
+        )
+
 
 def on_delete(instance, actor=None, **kwargs):
-    instance.get_provider().delete_repository(
-        repo=instance,
-        actor=actor,
-    )
+    from sentry.exceptions import InvalidIdentity, PluginError
+    try:
+        instance.get_provider().delete_repository(
+            repo=instance,
+            actor=actor,
+        )
+    except Exception as exc:
+        if isinstance(exc, (PluginError, InvalidIdentity)):
+            error = exc.message
+        else:
+            error = 'An unknown error occurred'
+        if actor is not None:
+            msg = instance.generate_delete_fail_email(error)
+            msg.send_async(to=[actor.email])
+        raise
 
 
 pending_delete.connect(on_delete, sender=Repository, weak=False)
diff --git a/src/sentry/templates/sentry/emails/unable-to-delete-repo.html b/src/sentry/templates/sentry/emails/unable-to-delete-repo.html
new file mode 100644
index 0000000000..9315e0f9dc
--- /dev/null
+++ b/src/sentry/templates/sentry/emails/unable-to-delete-repo.html
@@ -0,0 +1,9 @@
+{% extends "sentry/emails/base.html" %}
+
+{% block main %}
+  <h3>Unable to Delete Repository</h3>
+  <p>We were unable to delete your repository (<em>{{ repo.name }}</em>) due to the following error:</p>
+  <p>{{ error_message }}</p>
+{% endblock %}
+
+{% block footer %}{% endblock %}
diff --git a/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt b/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt
new file mode 100644
index 0000000000..57133fc7ab
--- /dev/null
+++ b/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt
@@ -0,0 +1,6 @@
+Unable to Delete Repo
+---------------------
+
+We were unable to delete your repository ({{ repo.name }}) due to the following error:
+
+{{ error_message }}
