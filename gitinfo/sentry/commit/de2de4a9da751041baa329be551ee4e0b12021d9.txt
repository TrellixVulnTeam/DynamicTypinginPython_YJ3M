commit de2de4a9da751041baa329be551ee4e0b12021d9
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Oct 13 01:13:14 2015 -0700

    Ensure releases can be used when scraping is disabled

diff --git a/src/sentry/lang/javascript/plugin.py b/src/sentry/lang/javascript/plugin.py
index 6042ed1bf0..21fc96d076 100644
--- a/src/sentry/lang/javascript/plugin.py
+++ b/src/sentry/lang/javascript/plugin.py
@@ -15,10 +15,10 @@ def preprocess_event(data):
     project = Project.objects.get_from_cache(
         id=data['project'],
     )
-    if not bool(project.get_option('sentry:scrape_javascript', True)):
-        return
 
-    processor = SourceProcessor()
+    allow_scraping = bool(project.get_option('sentry:scrape_javascript', True))
+
+    processor = SourceProcessor(allow_scraping=allow_scraping)
     return processor.process(project, data)
 
 
diff --git a/src/sentry/lang/javascript/processor.py b/src/sentry/lang/javascript/processor.py
index 988c58aae7..480b5f50ca 100644
--- a/src/sentry/lang/javascript/processor.py
+++ b/src/sentry/lang/javascript/processor.py
@@ -215,7 +215,7 @@ def fetch_release_file(filename, release):
     return result
 
 
-def fetch_url(url, project=None, release=None):
+def fetch_url(url, project=None, release=None, allow_scraping=True):
     """
     Pull down a URL, returning a UrlResult object.
 
@@ -227,6 +227,12 @@ def fetch_url(url, project=None, release=None):
 
     if release:
         result = fetch_release_file(url, release)
+    elif not allow_scraping:
+        error = {
+            'type': EventError.JS_MISSING_SOURCE,
+            'url': url,
+        }
+        raise CannotFetchSource(error)
     else:
         result = None
 
@@ -314,11 +320,12 @@ def fetch_url(url, project=None, release=None):
     return UrlResult(url, result[0], result[1])
 
 
-def fetch_sourcemap(url, project=None, release=None):
+def fetch_sourcemap(url, project=None, release=None, allow_scraping=True):
     if is_data_uri(url):
         body = base64.b64decode(url[BASE64_PREAMBLE_LENGTH:])
     else:
-        result = fetch_url(url, project=project, release=release)
+        result = fetch_url(url, project=project, release=release,
+                           allow_scraping=allow_scraping)
         body = result.body
 
     # According to various specs[1][2] a SourceMap may be prefixed to force
@@ -384,7 +391,8 @@ class SourceProcessor(object):
 
     Mutates the input ``data`` with expanded context if available.
     """
-    def __init__(self, max_fetches=MAX_RESOURCE_FETCHES):
+    def __init__(self, max_fetches=MAX_RESOURCE_FETCHES, allow_scraping=True):
+        self.allow_scraping = allow_scraping
         self.max_fetches = max_fetches
         self.cache = SourceCache()
         self.sourcemaps = SourceMapCache()
@@ -590,7 +598,8 @@ class SourceProcessor(object):
             # TODO: respect cache-control/max-age headers to some extent
             logger.debug('Fetching remote source %r', filename)
             try:
-                result = fetch_url(filename, project=project, release=release)
+                result = fetch_url(filename, project=project, release=release,
+                                   allow_scraping=self.allow_scraping)
             except BadSource as exc:
                 cache.add_error(filename, exc.data)
                 continue
@@ -622,6 +631,7 @@ class SourceProcessor(object):
                     sourcemap_url,
                     project=project,
                     release=release,
+                    allow_scraping=self.allow_scraping,
                 )
             except BadSource as exc:
                 cache.add_error(filename, exc.data)
diff --git a/tests/sentry/lang/javascript/test_plugin.py b/tests/sentry/lang/javascript/test_plugin.py
index 8be222381b..94a4167a49 100644
--- a/tests/sentry/lang/javascript/test_plugin.py
+++ b/tests/sentry/lang/javascript/test_plugin.py
@@ -58,6 +58,7 @@ class JavascriptIntegrationTest(TestCase):
             'http://example.com/foo.js',
             project=self.project,
             release=None,
+            allow_scraping=True,
         )
 
         event = Event.objects.get()
@@ -109,6 +110,7 @@ class JavascriptIntegrationTest(TestCase):
             'http://example.com/test.min.js',
             project=self.project,
             release=None,
+            allow_scraping=True,
         )
 
         event = Event.objects.get()
