commit 75b3a14d6a69daaf2e121d24af548a4a7629ff48
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Fri Sep 13 19:24:49 2019 +0300

    build(docker): Add per-sha tagging to base and onbuild (#14687)
    
     - Adds per-SHA tagging so we have `getsentry/sentry:<SHA>` and `getsentry/sentry:<SHA>-onbuild`.
     - Replaces the `:git` and `:git-onbuild` tags with `:latest` and `:latest-onbuild`

diff --git a/docker/hooks/build b/docker/hooks/build
index f97168078e..07e44d65de 100755
--- a/docker/hooks/build
+++ b/docker/hooks/build
@@ -1,6 +1,6 @@
 #!/bin/bash
 
-set -x;
+set -e;
 
 if [[ -z "$SOURCE_COMMIT" ]]; then
 	export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
@@ -8,10 +8,9 @@ if [[ -z "$SOURCE_COMMIT" ]]; then
 fi
 
 echo "SOURCE_COMMIT: $SOURCE_COMMIT";
-echo $(pwd);
 cd $(git rev-parse --show-toplevel);
 
 git archive --format=tar.gz -o context.tar.gz $SOURCE_COMMIT
-docker build --build-arg SOURCE_COMMIT="$SOURCE_COMMIT" -t "$DOCKER_REPO:$SOURCE_COMMIT" -t "$DOCKER_REPO:git" -f "./docker/Dockerfile" - < context.tar.gz
-docker build -t "$DOCKER_REPO:$SOURCE_COMMIT-onbuild" -t "$DOCKER_REPO:git-onbuild" -f "./docker/onbuild/Dockerfile" - < context.tar.gz
-rm context.tar.gz
+docker build --build-arg SOURCE_COMMIT="$SOURCE_COMMIT" -t "$DOCKER_REPO:$SOURCE_COMMIT" -t "$DOCKER_REPO:latest" -f "./docker/Dockerfile" - < context.tar.gz
+docker build -t "$DOCKER_REPO:$SOURCE_COMMIT-onbuild" -t "$DOCKER_REPO:latest-onbuild" -f "./docker/onbuild/Dockerfile" - < context.tar.gz
+rm context.tar.gz || true
diff --git a/docker/hooks/post_push b/docker/hooks/post_push
new file mode 100755
index 0000000000..ca49b919e5
--- /dev/null
+++ b/docker/hooks/post_push
@@ -0,0 +1,13 @@
+#!/bin/bash
+
+set -e;
+
+if [[ -z "$SOURCE_COMMIT" ]]; then
+	export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
+	echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
+fi
+
+echo "SOURCE_COMMIT: $SOURCE_COMMIT";
+
+docker push "$DOCKER_REPO:$SOURCE_COMMIT"
+docker push "$DOCKER_REPO:$SOURCE_COMMIT-onbuild"
