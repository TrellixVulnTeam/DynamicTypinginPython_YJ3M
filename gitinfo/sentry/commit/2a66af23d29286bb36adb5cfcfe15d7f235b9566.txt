commit 2a66af23d29286bb36adb5cfcfe15d7f235b9566
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Sep 15 14:20:20 2013 +0900

    Update wad usage

diff --git a/.travis.yml b/.travis.yml
index a146e2bd0d..073d78f6a3 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -18,7 +18,7 @@ env:
     # travis encrypt S3_BUCKET_NAME=secretvalue S3_CREDENTIALS=accesskey:secretkey
     # - S3_BUCKET_NAME=
     # - S3_CREDENTIALS=
-    - secure: "i0bMZg4KalLr+dIfRfuX7bTAEgFln/ETcttk4zF9zqbSqvOePGYUtKrSJGCHaUWmzKcSh5KcUMijZVjOnMFzCr8dD3Ym7xcoeHRDsGTjuaN1KDLikhw37UqYlaryTluFjXKrGWJr9Z8LNYzyzSwCe6PH2gMtw8cKiuflAWwJLJM="
+    - secure: pZ7DtkEu2q/pGINfVT9S+iPRE5ck6mBQmuHTQz3PVXF/UJmpM1LCbC7aqrw4GXWuUhYc50QCnMZJL1yoBORVEfY4nfXHLRc3HMoWE6Srqf0IBDywi6T+UUdLeOYe13EDb4p8WIpnRGlV4WI1WaPXuFlMEdj5tAjlC9ZotLxyVaI=
 before_script:
   - mysql -e 'create database sentry;'
   - psql -c 'create database sentry;' -U postgres
diff --git a/script/wad b/script/wad
index 40fd62605f..98f5565ab0 100755
--- a/script/wad
+++ b/script/wad
@@ -1,6 +1,6 @@
 #!/usr/bin/env ruby
 
-# Generated on: 14-09-2013 at 21:23
+# Generated on: 14-09-2013 at 22:13
 
 require 'time'
 require 'net/http'
@@ -61,6 +61,18 @@ class Presss
       end
     end
 
+    def bucket_in_hostname?
+      config[:bucket_in_hostname]
+    end
+
+    def url_prefix
+      if bucket_in_hostname?
+        "https://#{bucket_name}.#{domain}"
+      else
+        "https://#{domain}/#{bucket_name}"
+      end
+    end
+
     # Returns the absolute path based on the key for the object.
     def absolute_path(path)
       path.start_with?('/') ? path : '/' + path
@@ -86,10 +98,11 @@ class Presss
     end
 
     def signed_url(verb, expires, headers, path)
-      path = canonicalized_resource(path)
-      signature = [ verb.to_s.upcase, nil, nil, expires, [ headers, path ].flatten.compact ].flatten.join("\n")
-      signed = authorization.sign(signature)
-      "https://#{domain}#{path}?Signature=#{signed}&Expires=#{expires}&AWSAccessKeyId=#{authorization.access_key_id}"
+      path           = absolute_path(path)
+      canonical_path = canonicalized_resource(path)
+      signature      = [ verb.to_s.upcase, nil, nil, expires, [ headers, canonical_path ].flatten.compact ].flatten.join("\n")
+      signed         = authorization.sign(signature)
+      "#{url_prefix}#{path}?Signature=#{signed}&Expires=#{expires}&AWSAccessKeyId=#{authorization.access_key_id}"
     end
 
     def download(path, destination)
@@ -204,18 +217,18 @@ class Wad
   end
 
   def s3_bucket_name
-    if ENV['S3_BUCKET_NAME']
-      ENV['S3_BUCKET_NAME']
+    if bucket = ENV['WAD_S3_BUCKET_NAME'] || ENV['S3_BUCKET_NAME']
+      bucket
     else
-      abort "Must provide S3_BUCKET_NAME="
+      abort "Must provide WAD_S3_BUCKET_NAME="
     end
   end
 
   def s3_credentials
-    if ENV['S3_CREDENTIALS']
-      ENV['S3_CREDENTIALS'].split(':')
+    if creds = ENV['WAD_S3_CREDENTIALS'] || ENV['S3_CREDENTIALS']
+      creds.split(':')
     else
-      abort "Must provide S3_CREDENTIALS="
+      abort "Must provide WAD_S3_CREDENTIALS="
     end
   end
 
@@ -235,7 +248,9 @@ class Wad
     Presss.config = {
       :bucket_name => s3_bucket_name,
       :access_key_id => s3_access_key_id,
-      :secret_access_key => s3_secret_access_key
+      :secret_access_key => s3_secret_access_key,
+      :region => ENV['WAD_AWS_REGION'],
+      :bucket_in_hostname => (ENV['WAD_BUCKET_IN_HOSTNAME'] == 'true')
     }
   end
 
@@ -318,4 +333,3 @@ end
 
 Wad.new.setup
 __END__
-
