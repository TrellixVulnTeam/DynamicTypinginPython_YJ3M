commit 5414e658c06d1e71203fec6b6f2a75d762341bbe
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Oct 3 13:13:20 2016 -0700

    Randomly disconnect queue workers to distribute load (#4257)

diff --git a/src/sentry/celery.py b/src/sentry/celery.py
index 6784298599..f1d354b435 100644
--- a/src/sentry/celery.py
+++ b/src/sentry/celery.py
@@ -1,5 +1,6 @@
 from __future__ import absolute_import
 
+from random import random
 import celery
 import os
 import os.path
@@ -82,12 +83,17 @@ OriginalTask = app.Task
 
 
 class SentryTask(OriginalTask):
+    chance_for_close = 0.2
 
     def apply_async(self, *args, **kwargs):
         key = 'jobs.delay'
         instance = self.name
-        with metrics.timer(key, instance=instance):
-            return OriginalTask.apply_async(self, *args, **kwargs)
+        try:
+            with metrics.timer(key, instance=instance):
+                return OriginalTask.apply_async(self, *args, **kwargs)
+        finally:
+            if random() < self.chance_for_close:
+                app.close()
 
 app.Task = SentryTask
 
