commit e40c2769a1de461921c8704831cb954fb339b56a
Author: Mark Story <mark@sentry.io>
Date:   Tue Jul 16 11:42:54 2019 -0400

    fix(gitlab) Handle missing author information in merge events (#14031)
    
    Merge request events are sometimes missing authors. The gitlab docs
    don't really explain why this happens, but we shouldn't 500 when it
    does.
    
    Fixes SENTRY-8Y4

diff --git a/src/sentry/integrations/gitlab/webhooks.py b/src/sentry/integrations/gitlab/webhooks.py
index 21489b098b..d625d15fef 100644
--- a/src/sentry/integrations/gitlab/webhooks.py
+++ b/src/sentry/integrations/gitlab/webhooks.py
@@ -71,9 +71,12 @@ class MergeEventWebhook(Webhook):
             created_at = event['object_attributes']['created_at']
             merge_commit_sha = event['object_attributes']['merge_commit_sha']
 
-            author = event['object_attributes']['last_commit']['author']
-            author_email = author['email']
-            author_name = author['name']
+            last_commit = event['object_attributes']['last_commit']
+            author_email = None
+            author_name = None
+            if last_commit:
+                author_email = last_commit['author']['email']
+                author_name = last_commit['author']['name']
         except KeyError as e:
             logger.info(
                 'gitlab.webhook.invalid-merge-data',
@@ -81,6 +84,8 @@ class MergeEventWebhook(Webhook):
                     'integration_id': integration.id,
                     'error': six.string_type(e)
                 })
+
+        if not author_email:
             raise Http404()
 
         author = CommitAuthor.objects.get_or_create(
diff --git a/tests/sentry/integrations/gitlab/test_webhook.py b/tests/sentry/integrations/gitlab/test_webhook.py
index 61f05ec4bf..34baadcb4d 100644
--- a/tests/sentry/integrations/gitlab/test_webhook.py
+++ b/tests/sentry/integrations/gitlab/test_webhook.py
@@ -6,6 +6,7 @@ from sentry.models import (
     PullRequest,
     GroupLink
 )
+from sentry.utils import json
 from .testutils import (
     GitLabTestCase,
     WEBHOOK_TOKEN,
@@ -196,6 +197,23 @@ class WebhookTest(GitLabTestCase):
         assert response.status_code == 204
         assert 0 == PullRequest.objects.count()
 
+    def test_merge_event_no_last_commit(self):
+        payload = json.loads(MERGE_REQUEST_OPENED_EVENT)
+
+        # Remove required keys. There have been events in prod that are missing
+        # these important attributes. GitLab docs don't explain why though.
+        del payload['object_attributes']['last_commit']
+
+        response = self.client.post(
+            self.url,
+            data=json.dumps(payload),
+            content_type='application/json',
+            HTTP_X_GITLAB_TOKEN=WEBHOOK_TOKEN,
+            HTTP_X_GITLAB_EVENT='Merge Request Hook'
+        )
+        assert response.status_code == 204
+        assert 0 == PullRequest.objects.count()
+
     def test_merge_event_create_pull_request(self):
         self.create_repo('getsentry/sentry')
         group = self.create_group(
