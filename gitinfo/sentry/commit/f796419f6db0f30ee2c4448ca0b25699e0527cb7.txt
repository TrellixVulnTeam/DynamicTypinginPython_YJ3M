commit f796419f6db0f30ee2c4448ca0b25699e0527cb7
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Thu Feb 2 11:09:11 2017 -0800

    update docs and status code in project release endpoint (#4856)

diff --git a/src/sentry/api/endpoints/project_releases.py b/src/sentry/api/endpoints/project_releases.py
index 5fa83d258c..9fd21e6b36 100644
--- a/src/sentry/api/endpoints/project_releases.py
+++ b/src/sentry/api/endpoints/project_releases.py
@@ -1,6 +1,8 @@
 from __future__ import absolute_import
 import string
 
+from django.db import IntegrityError, transaction
+
 from rest_framework import serializers
 from rest_framework.response import Response
 
@@ -11,7 +13,7 @@ from sentry.api.fields.user import UserField
 from sentry.api.serializers import serialize
 from sentry.api.serializers.rest_framework import CommitSerializer, ListField
 from sentry.app import locks
-from sentry.models import Activity, Release
+from sentry.models import Activity, Release, ReleaseProject
 from sentry.plugins.interfaces.releasehook import ReleaseHook
 from sentry.utils.apidocs import scenario, attach_scenarios
 from sentry.utils.retries import TimedRetryPolicy
@@ -107,10 +109,13 @@ class ProjectReleasesEndpoint(ProjectEndpoint):
         Create a New Release
         ````````````````````
 
-        Create a new release for the given project.  Releases are used by
-        Sentry to improve its error reporting abilities by correlating
-        first seen events with the release that might have introduced the
-        problem.
+        Create a new release and/or associate a project with a release.
+        Release versions that are the same across multiple projects
+        within an Organization will be treated as the same release in Sentry.
+
+        Releases are used by Sentry to improve its error reporting abilities
+        by correlating first seen events with the release that might have
+        introduced the problem.
 
         Releases are also necessary for sourcemaps and other debug features
         that require manual upload for functioning well.
@@ -173,7 +178,12 @@ class ProjectReleasesEndpoint(ProjectEndpoint):
                                 date_released=result.get('dateReleased'),
                             ), True
                 was_released = False
-                release.add_project(project)
+                try:
+                    with transaction.atomic():
+                        ReleaseProject.objects.create(project=project, release=release)
+                    created = True
+                except IntegrityError:
+                    pass
 
             commit_list = result.get('commits')
             if commit_list:
diff --git a/tests/sentry/api/endpoints/test_project_releases.py b/tests/sentry/api/endpoints/test_project_releases.py
index 02a351b8f1..fae18cd336 100644
--- a/tests/sentry/api/endpoints/test_project_releases.py
+++ b/tests/sentry/api/endpoints/test_project_releases.py
@@ -153,7 +153,8 @@ class ProjectReleaseCreateTest(APITestCase):
             'version': '1.2.1',
         })
 
-        assert response.status_code == 208, response.content
+        # since project2 was added, should be 201
+        assert response.status_code == 201, response.content
         assert Release.objects.filter(
             version='1.2.1',
             organization_id=project.organization_id
