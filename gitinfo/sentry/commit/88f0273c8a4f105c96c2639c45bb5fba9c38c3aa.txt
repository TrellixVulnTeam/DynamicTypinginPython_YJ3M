commit 88f0273c8a4f105c96c2639c45bb5fba9c38c3aa
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Feb 22 20:11:07 2013 -0800

    Cleanup queue settings and split tasks

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index b3bd3af9d4..bac0f507ab 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -234,6 +234,7 @@ SOCIAL_AUTH_DEFAULT_USERNAME = lambda: random.choice(['Darth Vader', 'Obi-Wan Ke
 SOCIAL_AUTH_PROTECTED_USER_FIELDS = ['email']
 
 # Queue configuration
+from kombu import Queue
 
 BROKER_URL = "django://"
 
@@ -242,6 +243,20 @@ CELERY_SEND_EVENTS = False
 CELERY_RESULT_BACKEND = None
 CELERY_TASK_RESULT_EXPIRES = 1
 CELERY_DISABLE_RATE_LIMITS = True
+CELERY_DEFAULT_QUEUE = "default"
+CELERY_DEFAULT_EXCHANGE = "default"
+CELERY_DEFAULT_EXCHANGE_TYPE = "direct"
+CELERY_DEFAULT_ROUTING_KEY = "default"
+CELERY_QUEUES = (
+    Queue('alerts', routing_key='alerts'),
+    Queue('cleanup', routing_key='cleanup'),
+    Queue('sourcemaps', routing_key='sourcemaps'),
+    Queue('search', routing_key='search'),
+    Queue('counters', routing_key='counters'),
+    Queue('events', routing_key='events'),
+    Queue('triggers', routing_key='triggers'),
+)
+
 
 # Sentry and Raven configuration
 
diff --git a/src/sentry/tasks/check_alerts.py b/src/sentry/tasks/check_alerts.py
index 6ca7b5e1f0..6af5eebccd 100644
--- a/src/sentry/tasks/check_alerts.py
+++ b/src/sentry/tasks/check_alerts.py
@@ -48,7 +48,7 @@ def fsteps(start, stop, steps):
         start += step
 
 
-@periodic_task(ignore_result=True, run_every=crontab(minute='*'))
+@periodic_task(run_every=crontab(minute='*'), queue='alerts')
 def check_alerts(**kwargs):
     """
     Iterates all current keys and fires additional tasks to check each individual
@@ -79,7 +79,7 @@ def check_alerts(**kwargs):
         )
 
 
-@task(ignore_result=True)
+@task(queue='alerts')
 def check_project_alerts(project_id, when, count, **kwargs):
     """
     Given 'when' and 'count', which should signify recent times we compare it to historical data for this project
diff --git a/src/sentry/tasks/cleanup.py b/src/sentry/tasks/cleanup.py
index 195a78ef77..73bd024d3a 100644
--- a/src/sentry/tasks/cleanup.py
+++ b/src/sentry/tasks/cleanup.py
@@ -9,7 +9,7 @@ sentry.tasks.cleanup
 from celery.task import task
 
 
-@task(ignore_result=True)
+@task(ignore_result=True, queue='cleanup')
 def cleanup(days=30, project=None, chunk_size=1000, **kwargs):
     """
     Deletes a portion of the trailing data in Sentry based on
diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index 6dbebd9f9f..76ee6419d5 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -129,6 +129,7 @@ def fetch_url(url, logger=None):
     return result
 
 
+<<<<<<< HEAD
 def fetch_sourcemap(url, logger=None):
     result = fetch_url(url, logger=logger)
     if result == BAD_SOURCE:
@@ -150,7 +151,7 @@ def fetch_sourcemap(url, logger=None):
         return index
 
 
-@task(ignore_result=True)
+@task(ignore_result=True, queue='sourcemaps')
 def fetch_javascript_source(event, **kwargs):
     """
     Attempt to fetch source code for javascript frames.
diff --git a/src/sentry/tasks/index.py b/src/sentry/tasks/index.py
index 2bde79f5be..f601d4afee 100644
--- a/src/sentry/tasks/index.py
+++ b/src/sentry/tasks/index.py
@@ -9,7 +9,7 @@ sentry.tasks.index
 from celery.task import task
 
 
-@task(ignore_result=True)
+@task(queue='search')
 def index_event(event, **kwargs):
     from sentry.models import SearchDocument
 
diff --git a/src/sentry/tasks/post_process.py b/src/sentry/tasks/post_process.py
index c214509c23..f12d080c31 100644
--- a/src/sentry/tasks/post_process.py
+++ b/src/sentry/tasks/post_process.py
@@ -12,7 +12,7 @@ from sentry.utils.safe import safe_execute
 from sentry.utils.queue import maybe_delay
 
 
-@task(ignore_result=True)
+@task(queue='triggers')
 def post_process_group(group, **kwargs):
     """
     Fires post processing hooks for a group.
@@ -23,7 +23,7 @@ def post_process_group(group, **kwargs):
                 plugin.slug, group=group, **kwargs)
 
 
-@task(ignore_result=True)
+@task(queue='triggers')
 def plugin_post_process_group(plugin_slug, group, **kwargs):
     """
     Fires post processing hooks for a group.
diff --git a/src/sentry/tasks/process_buffer.py b/src/sentry/tasks/process_buffer.py
index 21a8b17dfe..31be8f2927 100644
--- a/src/sentry/tasks/process_buffer.py
+++ b/src/sentry/tasks/process_buffer.py
@@ -9,7 +9,7 @@ sentry.tasks.process_buffer
 from celery.task import task
 
 
-@task(ignore_result=True)
+@task(queue='counters')
 def process_incr(**kwargs):
     """
     Processes a buffer event.
diff --git a/src/sentry/tasks/store.py b/src/sentry/tasks/store.py
index 588215f58f..67012b3cf1 100644
--- a/src/sentry/tasks/store.py
+++ b/src/sentry/tasks/store.py
@@ -9,7 +9,7 @@ sentry.tasks.store
 from celery.task import task
 
 
-@task(ignore_result=True)
+@task(queue='events')
 def store_event(data, **kwargs):
     """
     Saves an event to the database.
