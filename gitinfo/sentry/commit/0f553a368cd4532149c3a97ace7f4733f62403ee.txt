commit 0f553a368cd4532149c3a97ace7f4733f62403ee
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Tue Sep 18 10:03:33 2018 -0700

    ref(integrations): Allow deleting disabled repos (#9780)
    
    * ref(integrations): Allow deleting disabled repos

diff --git a/src/sentry/api/endpoints/organization_repository_details.py b/src/sentry/api/endpoints/organization_repository_details.py
index 031e58448a..a78a72c091 100644
--- a/src/sentry/api/endpoints/organization_repository_details.py
+++ b/src/sentry/api/endpoints/organization_repository_details.py
@@ -73,7 +73,7 @@ class OrganizationRepositoryDetailsEndpoint(OrganizationEndpoint):
 
         updated = Repository.objects.filter(
             id=repo.id,
-            status=ObjectStatus.VISIBLE,
+            status__in=[ObjectStatus.VISIBLE, ObjectStatus.DISABLED],
         ).update(status=ObjectStatus.PENDING_DELETION)
         if updated:
             repo.status = ObjectStatus.PENDING_DELETION
diff --git a/tests/sentry/api/endpoints/test_organization_repository_details.py b/tests/sentry/api/endpoints/test_organization_repository_details.py
index 1214273748..5b234e3447 100644
--- a/tests/sentry/api/endpoints/test_organization_repository_details.py
+++ b/tests/sentry/api/endpoints/test_organization_repository_details.py
@@ -81,3 +81,77 @@ class OrganizationRepositoryDeleteTest(APITestCase):
             },
             countdown=3600,
         )
+
+    @patch('sentry.api.endpoints.organization_repository_details.get_transaction_id')
+    @patch('sentry.api.endpoints.organization_repository_details.delete_repository')
+    def test_delete_disabled_no_commits(self, mock_delete_repository, mock_get_transaction_id):
+        mock_get_transaction_id.return_value = '1'
+
+        self.login_as(user=self.user)
+
+        org = self.create_organization(owner=self.user, name='baz')
+        repo = Repository.objects.create(
+            name='example',
+            organization_id=org.id,
+            status=ObjectStatus.DISABLED,
+        )
+
+        url = reverse(
+            'sentry-api-0-organization-repository-details', args=[
+                org.slug,
+                repo.id,
+            ]
+        )
+        response = self.client.delete(url)
+        assert response.status_code == 202, (response.status_code, response.content)
+
+        repo = Repository.objects.get(id=repo.id)
+        assert repo.status == ObjectStatus.PENDING_DELETION
+
+        mock_delete_repository.apply_async.assert_called_with(
+            kwargs={
+                'object_id': repo.id,
+                'transaction_id': '1',
+                'actor_id': self.user.id,
+            },
+            countdown=0,
+        )
+
+    @patch('sentry.api.endpoints.organization_repository_details.get_transaction_id')
+    @patch('sentry.api.endpoints.organization_repository_details.delete_repository')
+    def test_delete_disabled_with_commits(self, mock_delete_repository, mock_get_transaction_id):
+        mock_get_transaction_id.return_value = '1'
+        self.login_as(user=self.user)
+
+        org = self.create_organization(owner=self.user, name='baz')
+        repo = Repository.objects.create(
+            name='example',
+            organization_id=org.id,
+            status=ObjectStatus.DISABLED,
+        )
+        Commit.objects.create(
+            repository_id=repo.id,
+            key='a' * 40,
+            organization_id=org.id,
+        )
+
+        url = reverse(
+            'sentry-api-0-organization-repository-details', args=[
+                org.slug,
+                repo.id,
+            ]
+        )
+        response = self.client.delete(url)
+
+        assert response.status_code == 202, (response.status_code, response.content)
+
+        repo = Repository.objects.get(id=repo.id)
+        assert repo.status == ObjectStatus.PENDING_DELETION
+        mock_delete_repository.apply_async.assert_called_with(
+            kwargs={
+                'object_id': repo.id,
+                'transaction_id': '1',
+                'actor_id': self.user.id,
+            },
+            countdown=3600,
+        )
