commit 6cfda99bc1f8bcc8ba56d85ff8f64c611912581e
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Mar 16 18:47:26 2016 -0700

    Remove HOST() usage for IP addresses (fixes GH-2854)

diff --git a/src/sentry/db/postgres/base.py b/src/sentry/db/postgres/base.py
index c4f366ffb0..364ced7f9a 100644
--- a/src/sentry/db/postgres/base.py
+++ b/src/sentry/db/postgres/base.py
@@ -4,20 +4,15 @@ import psycopg2 as Database
 
 # Some of these imports are unused, but they are inherited from other engines
 # and should be available as part of the backend ``base.py`` namespace.
-from django.db.backends.postgresql_psycopg2.base import (  # NOQA
-    DatabaseWrapper, DatabaseFeatures, DatabaseOperations, DatabaseClient,
-    DatabaseCreation, DatabaseIntrospection
-)
+from django.db.backends.postgresql_psycopg2.base import DatabaseWrapper
 
 from .decorators import (
     capture_transaction_exceptions, auto_reconnect_cursor,
     auto_reconnect_connection, less_shitty_error_messages
 )
+from .operations import DatabaseOperations
 
-
-__all__ = ('DatabaseWrapper', 'DatabaseFeatures', 'DatabaseOperations',
-           'DatabaseOperations', 'DatabaseClient', 'DatabaseCreation',
-           'DatabaseIntrospection')
+__all__ = ('DatabaseWrapper',)
 
 
 class CursorWrapper(object):
@@ -52,6 +47,10 @@ class CursorWrapper(object):
 
 
 class DatabaseWrapper(DatabaseWrapper):
+    def __init__(self, *args, **kwargs):
+        super(DatabaseWrapper, self).__init__(*args, **kwargs)
+        self.ops = DatabaseOperations(self)
+
     @auto_reconnect_connection
     def _set_isolation_level(self, level):
         return super(DatabaseWrapper, self)._set_isolation_level(level)
@@ -74,10 +73,3 @@ class DatabaseWrapper(DatabaseWrapper):
                     # like pgbouncer idle timeout.
                     pass
             self.connection = None
-
-
-class DatabaseFeatures(DatabaseFeatures):
-    can_return_id_from_insert = True
-
-    def __init__(self, connection):
-        self.connection = connection
diff --git a/src/sentry/db/postgres/operations.py b/src/sentry/db/postgres/operations.py
new file mode 100644
index 0000000000..3a67f68e48
--- /dev/null
+++ b/src/sentry/db/postgres/operations.py
@@ -0,0 +1,9 @@
+from __future__ import absolute_import
+
+from django.db.backends.postgresql_psycopg2.base import DatabaseOperations
+
+
+class DatabaseOperations(DatabaseOperations):
+    # Remove HOST() lookups for GenericIPAddressField
+    def field_cast_sql(self, db_type, internal_type):
+        return '%s'
