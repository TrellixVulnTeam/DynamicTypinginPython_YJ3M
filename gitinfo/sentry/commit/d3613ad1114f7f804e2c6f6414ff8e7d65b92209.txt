commit d3613ad1114f7f804e2c6f6414ff8e7d65b92209
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Sun Jan 12 22:40:51 2014 -0800

    Send along the correct Message-Id for the initial group email

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index a1470709c7..078891a55b 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -32,7 +32,8 @@ class MailPlugin(NotificationPlugin):
     subject_prefix = settings.EMAIL_SUBJECT_PREFIX
 
     def _send_mail(self, subject, template=None, html_template=None, body=None,
-                   project=None, headers=None, context=None, fail_silently=False):
+                   project=None, group=None, headers=None, context=None,
+                   fail_silently=False):
         send_to = self.get_send_to(project)
         if not send_to:
             return
@@ -46,6 +47,7 @@ class MailPlugin(NotificationPlugin):
             body=body,
             headers=headers,
             context=context,
+            reference=group,
         )
         msg.add_users(send_to, project=project)
         return msg.send(fail_silently=fail_silently)
@@ -165,6 +167,7 @@ class MailPlugin(NotificationPlugin):
             template=template,
             html_template=html_template,
             project=project,
+            group=group,
             fail_silently=fail_silently,
             headers=headers,
             context=context,
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index e26b519335..3a41803a86 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -123,6 +123,7 @@ class MailPluginTest(TestCase):
         args, kwargs = _send_mail.call_args
         self.assertEquals(kwargs.get('fail_silently'), False)
         self.assertEquals(kwargs.get('project'), self.project)
+        self.assertEquals(kwargs.get('group'), group)
         assert kwargs.get('subject') == u"[{0}] ERROR: hello world".format(self.project.name)
 
     @mock.patch('sentry.plugins.sentry_mail.models.MailPlugin._send_mail')
