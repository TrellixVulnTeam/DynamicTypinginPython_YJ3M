commit b2ebbc80f773b2b758f5d4a37c1901cbb3d478d9
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Thu Aug 31 12:39:06 2017 -0700

    feat(api): Store a non-mutated copy of event data in preprocess hash cache (#5992)
    
    * event processing: store a non-mutated copy of event data in preprocess hash cache
    
    * move to filters directory, other pr feedback

diff --git a/src/sentry/filters/preprocess_hashes.py b/src/sentry/filters/preprocess_hashes.py
new file mode 100644
index 0000000000..383cd1836a
--- /dev/null
+++ b/src/sentry/filters/preprocess_hashes.py
@@ -0,0 +1,13 @@
+from __future__ import absolute_import
+
+from django.core.cache import cache, get_cache, InvalidCacheBackendError
+
+
+try:
+    hash_cache = get_cache('preprocess_hash')
+except InvalidCacheBackendError:
+    hash_cache = cache
+
+
+def get_raw_cache_key(project_id, event_id):
+    return 'e:raw:{1}:{0}'.format(project_id, event_id)
diff --git a/src/sentry/tasks/store.py b/src/sentry/tasks/store.py
index 172bc4f57d..d37758b622 100644
--- a/src/sentry/tasks/store.py
+++ b/src/sentry/tasks/store.py
@@ -16,6 +16,7 @@ from time import time
 from django.utils import timezone
 
 from sentry.cache import default_cache
+from sentry.filters.preprocess_hashes import get_raw_cache_key, hash_cache
 from sentry.tasks.base import instrumented_task
 from sentry.utils import metrics
 from sentry.utils.safe import safe_execute
@@ -57,12 +58,16 @@ def _do_preprocess_event(cache_key, data, start_time, event_id, process_event):
         error_logger.error('preprocess.failed.empty', extra={'cache_key': cache_key})
         return
 
-    project = data['project']
+    project_id = data['project']
     Raven.tags_context({
-        'project': project,
+        'project': project_id,
     })
 
     if should_process(data):
+        # save another version of data for some projects to generate
+        # preprocessing hash that won't be modified by pipeline
+        hash_cache.set(get_raw_cache_key(project_id, data['event_id']), data)
+
         process_event.delay(cache_key=cache_key, start_time=start_time, event_id=event_id)
         return
 
diff --git a/tests/sentry/tasks/test_store.py b/tests/sentry/tasks/test_store.py
index 5c7eae3300..5eea6729b9 100644
--- a/tests/sentry/tasks/test_store.py
+++ b/tests/sentry/tasks/test_store.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 
 import mock
+import uuid
 
 from sentry.plugins import Plugin2
 from sentry.tasks.store import preprocess_event, process_event
@@ -42,6 +43,7 @@ class StoreTasksTest(PluginTestCase):
 
         data = {
             'project': project.id,
+            'event_id': uuid.uuid4().hex,
             'platform': 'mattlang',
             'message': 'test',
             'extra': {
