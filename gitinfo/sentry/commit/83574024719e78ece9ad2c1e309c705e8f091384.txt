commit 83574024719e78ece9ad2c1e309c705e8f091384
Author: Dan Fuller <dfuller@sentry.io>
Date:   Mon Apr 8 15:20:47 2019 -0700

    Run snuba in all tests

diff --git a/.travis.yml b/.travis.yml
index 13c89f627d..8699832963 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -75,6 +75,10 @@ base_postgres: &postgres_default
     - pip install -e ".[dev,tests,optional]"
   before_script:
     - psql -c 'create database sentry;' -U postgres
+  before_install:
+    - docker run -d --network host --name clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:18.14.9
+    - docker run -d --network host --name snuba --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=localhost:9000 getsentry/snuba
+    - docker ps -a
 
 base_acceptance: &acceptance_default
   python: 2.7
@@ -160,6 +164,10 @@ matrix:
         - pip install -e ".[dev,tests,optional]"
       before_script:
         - psql -c 'create database sentry;' -U postgres
+      before_install:
+        - docker run -d --network host --name clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:18.14.9
+        - docker run -d --network host --name snuba --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=localhost:9000 getsentry/snuba
+        - docker ps -a
 
     - <<: *acceptance_default
       name: 'Acceptance'
diff --git a/src/sentry/search/django/backend.py b/src/sentry/search/django/backend.py
index 5b0c0b51ae..3851ff4ebc 100644
--- a/src/sentry/search/django/backend.py
+++ b/src/sentry/search/django/backend.py
@@ -16,6 +16,7 @@ from django.utils import timezone
 
 from sentry import quotas
 from sentry.api.event_search import InvalidSearchQuery
+from sentry.search.base import SearchBackend
 from sentry.utils.db import is_postgres
 
 
diff --git a/tests/snuba/api/endpoints/test_project_group_index.py b/tests/snuba/api/endpoints/test_project_group_index.py
index dabc814c4f..55baece15e 100644
--- a/tests/snuba/api/endpoints/test_project_group_index.py
+++ b/tests/snuba/api/endpoints/test_project_group_index.py
@@ -143,15 +143,32 @@ class GroupListTest(APITestCase, SnubaTestCase):
         assert response.status_code == 400
 
     def test_environment(self):
-        self.create_event(tags={'environment': 'production'})
+        self.store_event(
+            data={
+                'fingerprint': ['put-me-in-group1'],
+                'timestamp': self.min_ago.isoformat()[:19],
+                'environment': 'production',
+            },
+            project_id=self.project.id
+        )
+        self.store_event(
+            data={
+                'fingerprint': ['put-me-in-group2'],
+                'timestamp': self.min_ago.isoformat()[:19],
+                'environment': 'staging',
+            },
+            project_id=self.project.id
+        )
 
         self.login_as(user=self.user)
 
         response = self.client.get(self.path + '?environment=production', format='json')
         assert response.status_code == 200
+        assert len(response.data) == 1
 
         response = self.client.get(self.path + '?environment=garbage', format='json')
         assert response.status_code == 200
+        assert len(response.data) == 0
 
     def test_auto_resolved(self):
         project = self.project
