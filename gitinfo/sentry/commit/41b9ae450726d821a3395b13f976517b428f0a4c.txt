commit 41b9ae450726d821a3395b13f976517b428f0a4c
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jun 29 12:55:39 2016 -0700

    Add explicit notifications option
    
    This adds a new 'workflow:notifications' option, which can be modified to indicate a user does not which to participate by default in all conversations.

diff --git a/src/sentry/models/groupsubscription.py b/src/sentry/models/groupsubscription.py
index f897679888..2269ea2761 100644
--- a/src/sentry/models/groupsubscription.py
+++ b/src/sentry/models/groupsubscription.py
@@ -40,7 +40,7 @@ class GroupSubscriptionManager(BaseManager):
         """
         Identify all users who are participating with a given issue.
         """
-        from sentry.models import User
+        from sentry.models import User, UserOption, UserOptionValue
 
         # identify all members of a project
         users = User.objects.filter(
@@ -53,9 +53,32 @@ class GroupSubscriptionManager(BaseManager):
             id__in=GroupSubscription.objects.filter(
                 group=group,
                 is_active=False,
+                user__in=users,
             ).values('user')
         )
 
+        participating_only = set(UserOption.objects.filter(
+            user__in=users,
+            key='workflow:notifications',
+            value=UserOptionValue.participating_only,
+        ).values_list('user', flat=True))
+
+        if participating_only:
+            excluded = participating_only.difference(
+                GroupSubscription.objects.filter(
+                    group=group,
+                    is_active=True,
+                    user__in=participating_only,
+                ).values_list('user', flat=True)
+            )
+
+            print excluded
+
+            if excluded:
+                users = users.exclude(
+                    id__in=excluded,
+                )
+
         return list(users)
 
 
diff --git a/src/sentry/models/useroption.py b/src/sentry/models/useroption.py
index 423bb13e3d..c0c3f872cd 100644
--- a/src/sentry/models/useroption.py
+++ b/src/sentry/models/useroption.py
@@ -17,6 +17,10 @@ from sentry.db.models.fields import UnicodePickledObjectField
 from sentry.db.models.manager import BaseManager
 
 
+class UserOptionValue(object):
+    participating_only = '1'
+
+
 class UserOptionManager(BaseManager):
     def __init__(self, *args, **kwargs):
         super(UserOptionManager, self).__init__(*args, **kwargs)
diff --git a/tests/sentry/models/test_groupsubscription.py b/tests/sentry/models/test_groupsubscription.py
index 0fc5307b37..484b40c9f9 100644
--- a/tests/sentry/models/test_groupsubscription.py
+++ b/tests/sentry/models/test_groupsubscription.py
@@ -1,6 +1,6 @@
 from __future__ import absolute_import
 
-from sentry.models import GroupSubscription
+from sentry.models import GroupSubscription, UserOption, UserOptionValue
 from sentry.testutils import TestCase
 
 
@@ -47,3 +47,32 @@ class GetParticipantsTest(TestCase):
         users = GroupSubscription.objects.get_participants(group=group)
 
         assert users == []
+
+        # not participating by default
+        GroupSubscription.objects.filter(
+            user=user,
+            group=group,
+        ).delete()
+
+        UserOption.objects.set_value(
+            user=user,
+            key='workflow:notifications',
+            project=None,
+            value=UserOptionValue.participating_only,
+        )
+
+        users = GroupSubscription.objects.get_participants(group=group)
+
+        assert users == []
+
+        # explicitly participating
+        GroupSubscription.objects.create(
+            user=user,
+            group=group,
+            project=project,
+            is_active=True,
+        )
+
+        users = GroupSubscription.objects.get_participants(group=group)
+
+        assert users == [user]
