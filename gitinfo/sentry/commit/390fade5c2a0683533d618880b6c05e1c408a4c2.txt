commit 390fade5c2a0683533d618880b6c05e1c408a4c2
Author: Alex Coomans <alexc@squareup.com>
Date:   Sat Jun 4 11:15:43 2016 -0700

    Properly format an event's email subject

diff --git a/src/sentry/models/event.py b/src/sentry/models/event.py
index 7eae27b7a1..7d14b8ed47 100644
--- a/src/sentry/models/event.py
+++ b/src/sentry/models/event.py
@@ -9,6 +9,7 @@ from __future__ import absolute_import
 
 import warnings
 
+import six
 from collections import OrderedDict
 from django.db import models
 from django.utils import timezone
@@ -233,3 +234,10 @@ class Event(Model):
     def checksum(self):
         warnings.warn('Event.checksum is no longer used', DeprecationWarning)
         return ''
+
+    def get_email_subject(self):
+        return '[%s] %s: %s' % (
+            self.project.get_full_name().encode('utf-8'),
+            six.text_type(self.get_tag('level')).upper().encode('utf-8'),
+            self.message_short.encode('utf-8')
+        )
diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index 16c70b897a..401c5c3f0e 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -135,7 +135,7 @@ class MailPlugin(NotificationPlugin):
         project = group.project
         org = group.organization
 
-        subject = group.get_email_subject()
+        subject = event.get_email_subject()
 
         link = group.get_absolute_url()
 
diff --git a/tests/sentry/models/test_event.py b/tests/sentry/models/test_event.py
index f8e4998218..99c3d4411b 100644
--- a/tests/sentry/models/test_event.py
+++ b/tests/sentry/models/test_event.py
@@ -17,3 +17,11 @@ class EventTest(TestCase):
         assert event.site == 'foo'
         assert event.server_name == 'bar'
         assert event.culprit == event.group.culprit
+
+    def test_email_subject(self):
+        event1 = self.create_event(event_id='a' * 32, group=self.group, tags={'level': 'info'})
+        event2 = self.create_event(event_id='b' * 32, group=self.group, tags={'level': 'error'})
+        self.group.level = 30
+
+        assert event1.get_email_subject() == '[foo Bar] INFO: Foo bar'
+        assert event2.get_email_subject() == '[foo Bar] ERROR: Foo bar'
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index d69485e447..4f00052a64 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -41,7 +41,7 @@ class MailPluginTest(TestCase):
 
     def test_simple_notification(self):
         group = self.create_group(message='Hello world')
-        event = self.create_event(group=group, message='Hello world')
+        event = self.create_event(group=group, message='Hello world', tags={'level': 'error'})
 
         rule = Rule.objects.create(project=self.project, label='my rule')
 
@@ -124,6 +124,11 @@ class MailPluginTest(TestCase):
             message=group.message,
             project=self.project,
             datetime=group.last_seen,
+            data={
+                'tags': [
+                    ('level', 'error'),
+                ]
+            },
         )
 
         notification = Notification(event=event)
@@ -154,6 +159,11 @@ class MailPluginTest(TestCase):
             message=group.message,
             project=self.project,
             datetime=group.last_seen,
+            data={
+                'tags': [
+                    ('level', 'error'),
+                ]
+            },
         )
 
         notification = Notification(event=event)
@@ -220,8 +230,8 @@ class MailPluginTest(TestCase):
         assert user4.pk not in self.plugin.get_sendable_users(project)
 
     def test_notify_users_with_utf8_subject(self):
-        group = self.create_group(message=u'רונית מגן')
-        event = self.create_event(group=group, message='Hello world')
+        group = self.create_group(message='Hello world')
+        event = self.create_event(group=group, message=u'רונית מגן', tags={'level': 'error'})
 
         notification = Notification(event=event)
 
