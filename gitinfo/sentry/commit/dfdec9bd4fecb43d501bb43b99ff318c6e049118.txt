commit dfdec9bd4fecb43d501bb43b99ff318c6e049118
Author: Dan Tehranian <tehranian@gmail.com>
Date:   Fri Jun 1 15:05:55 2012 -0700

    add Gravatar & username to navbar; Gravatar link to "Account Settings"

diff --git a/bootstrap/sentry.less b/bootstrap/sentry.less
index 52e9a6f4b7..92424f29d4 100644
--- a/bootstrap/sentry.less
+++ b/bootstrap/sentry.less
@@ -158,7 +158,7 @@ p {
 
       &:last-child > a {
         color: @grayDark;
-      }    
+      }
 
       .action {
         .btn;
@@ -793,4 +793,9 @@ legend {
 
 #daterange {
   display: none;
-}
\ No newline at end of file
+}
+
+.avatar {
+  vertical-align: middle;
+  border-radius: 3px;
+}
diff --git a/sentry/templates/sentry/account/settings.html b/sentry/templates/sentry/account/settings.html
index 3d68265c71..43453ffef2 100644
--- a/sentry/templates/sentry/account/settings.html
+++ b/sentry/templates/sentry/account/settings.html
@@ -1,6 +1,7 @@
 {% extends "sentry/layout.html" %}
 
 {% load i18n %}
+{% load sentry_helpers %}
 
 {% block title %}{% trans "Account Settings" %} | {{ block.super }}{% endblock %}
 
@@ -49,6 +50,13 @@
             {% with form.language as field %}
                 {% include "sentry/partial/_form_field.html" %}
             {% endwith %}
+            <fieldset class="control-group">
+                <label>Avatar</label>
+                <div class="controls">
+                    <img class="avatar" src="{% gravatar_url user.email size 32 %}">
+                    <a href="http://gravatar.com/">Change your avatar at Gravatar.com</a>
+                </div>
+            </fieldset>
             <hr>
             <p>{% trans "You may also optionally change your password." %}</p>
             {% with form.new_password1 as field %}
@@ -67,4 +75,4 @@
 
 {% block sidebar %}
     {% include "sentry/partial/_account_sidebar.html" %}
-{% endblock %}
\ No newline at end of file
+{% endblock %}
diff --git a/sentry/templates/sentry/header.html b/sentry/templates/sentry/header.html
index 6323d43e84..a012ea0219 100644
--- a/sentry/templates/sentry/header.html
+++ b/sentry/templates/sentry/header.html
@@ -1,4 +1,5 @@
 {% load i18n %}
+{% load sentry_helpers %}
 
 <header id="header">
     <div class="navbar">
@@ -39,7 +40,7 @@
                                 </li>
                             {% endif %}
                             <li class="dropdown">
-                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Account" %} <span class="caret"></span></a>
+                                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><img class="avatar" src="{% gravatar_url user.email size 20 %}"> {{ user.username}} <span class="caret"></span></a>
                                 <ul class="dropdown-menu">
                                     <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a></li>
                                     <li><a href="{% url sentry-team-list %}">{% trans "Teams" %}</a></li>
@@ -59,4 +60,4 @@
              </div>
         </div>
     </div>
-</header>
\ No newline at end of file
+</header>
diff --git a/sentry/templatetags/sentry_helpers.py b/sentry/templatetags/sentry_helpers.py
index 6ce7a92172..ec30af43fa 100644
--- a/sentry/templatetags/sentry_helpers.py
+++ b/sentry/templatetags/sentry_helpers.py
@@ -22,6 +22,8 @@ from templatetag_sugar.register import tag
 from templatetag_sugar.parser import Name, Variable, Constant, Optional
 
 import datetime
+import hashlib
+import urllib
 
 register = template.Library()
 
@@ -290,3 +292,29 @@ def get_project_dsn(context, user, project, asvar):
         context[asvar] = key.get_dsn()
 
     return ''
+
+
+# Adapted from http://en.gravatar.com/site/implement/images/django/
+# The "mm" default is for the grey, "mystery man" icon. See:
+#   http://en.gravatar.com/site/implement/images/
+@tag(register, [Variable('email'),
+                Optional([Constant('size'), Variable('sizevar')]),
+                Optional([Constant('default'), Variable('defaultvar')])])
+def gravatar_url(context, email, sizevar=None, defaultvar='mm'):
+    # XXX - use request.is_secure() in django 1.4
+    if context['request'].META['wsgi.url_scheme'] == 'https':
+        base = 'https://secure.gravatar.com'
+    else:
+        base = 'http://www.gravatar.com'
+
+    gravatar_url = "%s/avatar/%s" % (base, hashlib.md5(email.lower()).hexdigest())
+
+    properties = {}
+    if sizevar:
+        properties['s'] = str(sizevar)
+    if defaultvar:
+        properties['d'] = defaultvar
+    if properties:
+        gravatar_url += "?" + urllib.urlencode(properties)
+
+    return gravatar_url
