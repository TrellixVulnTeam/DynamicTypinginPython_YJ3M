commit 207f6d2d8b83dd1948eb48869d8800144df5b625
Author: Jess MacQueen <jess@getsentry.com>
Date:   Fri Sep 15 16:39:07 2017 -0700

    fix(deletion): Ensure delete_repository is called when deleting orgs
    
    fixes SENTRY-3B4

diff --git a/src/sentry/api/endpoints/organization_details.py b/src/sentry/api/endpoints/organization_details.py
index e3066e649e..722d77ee92 100644
--- a/src/sentry/api/endpoints/organization_details.py
+++ b/src/sentry/api/endpoints/organization_details.py
@@ -268,6 +268,7 @@ class OrganizationDetailsEndpoint(OrganizationEndpoint):
                 kwargs={
                     'object_id': organization.id,
                     'transaction_id': transaction_id,
+                    'actor_id': request.user.id,
                 },
                 countdown=countdown,
             )
diff --git a/src/sentry/deletions/defaults/repository.py b/src/sentry/deletions/defaults/repository.py
index 3b14f2808a..fa6d2d13b8 100644
--- a/src/sentry/deletions/defaults/repository.py
+++ b/src/sentry/deletions/defaults/repository.py
@@ -1,5 +1,7 @@
 from __future__ import absolute_import, print_function
 
+from sentry.signals import pending_delete
+
 from ..base import ModelDeletionTask, ModelRelation
 
 
@@ -10,3 +12,11 @@ class RepositoryDeletionTask(ModelDeletionTask):
         return [
             ModelRelation(Commit, {'repository_id': instance.id}),
         ]
+
+    def delete_instance(self, instance):
+        pending_delete.send(
+            sender=type(instance),
+            instance=instance,
+            actor=self.get_actor(),
+        )
+        return super(RepositoryDeletionTask, self).delete_instance(instance)
diff --git a/src/sentry/tasks/deletion.py b/src/sentry/tasks/deletion.py
index 0cfb2ed14d..e9ebbf32cd 100644
--- a/src/sentry/tasks/deletion.py
+++ b/src/sentry/tasks/deletion.py
@@ -133,7 +133,7 @@ def revoke_api_tokens(object_id, transaction_id=None, timestamp=None, **kwargs):
     max_retries=MAX_RETRIES
 )
 @retry(exclude=(DeleteAborted, ))
-def delete_organization(object_id, transaction_id=None, **kwargs):
+def delete_organization(object_id, transaction_id=None, actor_id=None, **kwargs):
     from sentry import deletions
     from sentry.models import Organization, OrganizationStatus
 
@@ -158,12 +158,14 @@ def delete_organization(object_id, transaction_id=None, **kwargs):
             'id': object_id,
         },
         transaction_id=transaction_id or uuid4().hex,
+        actor_id=actor_id,
     )
     has_more = task.chunk()
     if has_more:
         delete_organization.apply_async(
             kwargs={'object_id': object_id,
-                    'transaction_id': transaction_id},
+                    'transaction_id': transaction_id,
+                    'actor_id': actor_id},
             countdown=15,
         )
 
diff --git a/src/sentry/web/frontend/remove_organization.py b/src/sentry/web/frontend/remove_organization.py
index 9ccae17877..585c11b979 100644
--- a/src/sentry/web/frontend/remove_organization.py
+++ b/src/sentry/web/frontend/remove_organization.py
@@ -62,6 +62,7 @@ class RemoveOrganizationView(OrganizationView):
                     kwargs={
                         'object_id': organization.id,
                         'transaction_id': transaction_id,
+                        'actor_id': request.user.id,
                     },
                     countdown=countdown,
                 )
diff --git a/tests/sentry/api/endpoints/test_organization_details.py b/tests/sentry/api/endpoints/test_organization_details.py
index 2210bb8143..583d0f5788 100644
--- a/tests/sentry/api/endpoints/test_organization_details.py
+++ b/tests/sentry/api/endpoints/test_organization_details.py
@@ -321,6 +321,7 @@ class OrganizationDeleteTest(APITestCase):
             kwargs={
                 'object_id': org.id,
                 'transaction_id': 'abc123',
+                'actor_id': user.id,
             },
             countdown=86400,
         )
diff --git a/tests/sentry/deletions/test_organization.py b/tests/sentry/deletions/test_organization.py
index e856b48504..54e9cde7b7 100644
--- a/tests/sentry/deletions/test_organization.py
+++ b/tests/sentry/deletions/test_organization.py
@@ -20,6 +20,7 @@ class DeleteOrganizationTest(TestCase):
         repo = Repository.objects.create(
             organization_id=org.id,
             name=org.name,
+            provider='dummy',
         )
         commit_author = CommitAuthor.objects.create(
             organization_id=org.id,
diff --git a/tests/sentry/tasks/test_deletion.py b/tests/sentry/tasks/test_deletion.py
index 6cbc30d715..6e5c40a192 100644
--- a/tests/sentry/tasks/test_deletion.py
+++ b/tests/sentry/tasks/test_deletion.py
@@ -33,6 +33,7 @@ class DeleteOrganizationTest(TestCase):
         repo = Repository.objects.create(
             organization_id=org.id,
             name=org.name,
+            provider='dummy',
         )
         commit_author = CommitAuthor.objects.create(
             organization_id=org.id,
diff --git a/tests/sentry/web/frontend/test_remove_organization.py b/tests/sentry/web/frontend/test_remove_organization.py
index a59cb72b01..c16c35d79c 100644
--- a/tests/sentry/web/frontend/test_remove_organization.py
+++ b/tests/sentry/web/frontend/test_remove_organization.py
@@ -69,6 +69,7 @@ class RemoveOrganizationTest(TestCase):
             kwargs={
                 'object_id': org.id,
                 'transaction_id': 'abc123',
+                'actor_id': self.user.id,
             },
             countdown=86400,
         )
