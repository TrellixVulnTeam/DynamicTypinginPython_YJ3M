commit b5b5a5cb6de6cea294da27fdea05eca17ed1c060
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Mar 11 02:09:35 2014 -0700

    Enforce unicode in picklefield

diff --git a/src/sentry/db/models/fields/__init__.py b/src/sentry/db/models/fields/__init__.py
index a74c310e6f..63506a17fe 100644
--- a/src/sentry/db/models/fields/__init__.py
+++ b/src/sentry/db/models/fields/__init__.py
@@ -11,3 +11,4 @@ from __future__ import absolute_import
 from .bounded import *  # NOQA
 from .gzippeddict import *  # NOQA
 from .node import *  # NOQA
+from .pickle import *  # NOQA
diff --git a/src/sentry/db/models/fields/pickle.py b/src/sentry/db/models/fields/pickle.py
new file mode 100644
index 0000000000..7de0793641
--- /dev/null
+++ b/src/sentry/db/models/fields/pickle.py
@@ -0,0 +1,9 @@
+from picklefield.fields import PickledObjectField
+
+
+class UnicodePickledObjectField(PickledObjectField):
+    def get_db_prep_value(self, value, *args, **kwargs):
+        if isinstance(value, str):
+            value = value.decode('utf-8')
+        return super(UnicodePickledObjectField, self).get_db_prep_value(
+            value, *args, **kwargs)
diff --git a/src/sentry/models/activity.py b/src/sentry/models/activity.py
index 598fdcd11b..90f20ba98e 100644
--- a/src/sentry/models/activity.py
+++ b/src/sentry/models/activity.py
@@ -109,7 +109,7 @@ class Activity(Model):
         disabled = set(UserOption.objects.filter(
             user__in=user_id_list,
             key='subscribe_notes',
-            value='0',
+            value=u'0',
         ).values_list('user', flat=True))
 
         send_to = filter(lambda u_id: u_id not in disabled, user_id_list)
diff --git a/src/sentry/models/option.py b/src/sentry/models/option.py
index a691869748..3a7e13197f 100644
--- a/src/sentry/models/option.py
+++ b/src/sentry/models/option.py
@@ -6,11 +6,10 @@ sentry.models.option
 :license: BSD, see LICENSE for more details.
 """
 
-from picklefield.fields import PickledObjectField
-
 from django.db import models
 
 from sentry.db.models import Model, sane_repr
+from sentry.db.models.fields import UnicodePickledObjectField
 from sentry.manager import MetaManager
 
 
@@ -23,7 +22,7 @@ class Option(Model):
     their key. e.g. key='myplugin:optname'
     """
     key = models.CharField(max_length=64, unique=True)
-    value = PickledObjectField()
+    value = UnicodePickledObjectField()
 
     objects = MetaManager(cache_fields=[
         'key',
diff --git a/src/sentry/models/projectoption.py b/src/sentry/models/projectoption.py
index ef1e810964..8fa09a7394 100644
--- a/src/sentry/models/projectoption.py
+++ b/src/sentry/models/projectoption.py
@@ -6,11 +6,10 @@ sentry.models.projectoption
 :license: BSD, see LICENSE for more details.
 """
 
-from picklefield.fields import PickledObjectField
-
 from django.db import models
 
 from sentry.db.models import Model, sane_repr
+from sentry.db.models.fields import UnicodePickledObjectField
 from sentry.manager import InstanceMetaManager
 
 
@@ -23,7 +22,7 @@ class ProjectOption(Model):
     """
     project = models.ForeignKey('sentry.Project')
     key = models.CharField(max_length=64)
-    value = PickledObjectField()
+    value = UnicodePickledObjectField()
 
     objects = InstanceMetaManager('project')
 
diff --git a/src/sentry/models/useroption.py b/src/sentry/models/useroption.py
index 67e0e2b975..b605e3197b 100644
--- a/src/sentry/models/useroption.py
+++ b/src/sentry/models/useroption.py
@@ -6,12 +6,12 @@ sentry.models.useroption
 :license: BSD, see LICENSE for more details.
 """
 
-from picklefield.fields import PickledObjectField
 
 from django.conf import settings
 from django.db import models
 
 from sentry.db.models import Model, sane_repr
+from sentry.db.models.fields import UnicodePickledObjectField
 from sentry.manager import UserOptionManager
 
 
@@ -25,7 +25,7 @@ class UserOption(Model):
     user = models.ForeignKey(settings.AUTH_USER_MODEL)
     project = models.ForeignKey('sentry.Project', null=True)
     key = models.CharField(max_length=64)
-    value = PickledObjectField()
+    value = UnicodePickledObjectField()
 
     objects = UserOptionManager()
 
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index 1f494edcdb..8d4e67fc96 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -195,7 +195,14 @@ class MailPluginTest(TestCase):
         assert user4.pk in self.plugin.get_sendable_users(project)
 
         # disabled by default user4
-        UserOption.objects.create(key='subscribe_by_default', value='0',
+        uo1 = UserOption.objects.create(key='subscribe_by_default', value='0',
+                                  project=project, user=user4)
+
+        assert user4.pk not in self.plugin.get_sendable_users(project)
+
+        uo1.delete()
+
+        UserOption.objects.create(key='subscribe_by_default', value=u'0',
                                   project=project, user=user4)
 
         assert user4.pk not in self.plugin.get_sendable_users(project)
