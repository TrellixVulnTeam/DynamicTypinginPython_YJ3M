commit a24bfc36aa40da03306e5cf5afaa93db57a76876
Author: Katie Byers <katie.byers@sentry.io>
Date:   Tue Mar 10 06:22:26 2020 -0700

    fix(sourcemaps): Do a better job of excluding node_modules (#17538)
    
    For `node` events, when we do our source map processing, server-side, we make a point to exclude code from local `node_modules` folders, since
    
    a) there's no possibility of us being able to retrieve it, and
    b) we shouldn't need to since it's unlikely to be minified/source mapped/etc and since the SDK records pre- and post-context data as part of processing the stacktrace, before the event is sent.
    
    Specifically, on the server, we only process frames whose paths start with `"/"`, `"app:"`, or `"webpack:"`.
    
    That middle prefix, `"app:"`, comes directly from the SDK's `RewriteFrames` integration, where we substitute it in for details of the path specific the machine hosting the app (if any). When using that integration, you can provide a `root` configuration option, to tell the integration about those machine-specific details. And when you do that, we look at the relative path from that root to the file in question. The intent here is to turn
    
    `/some/irrelevant/stuff/myapp/path/to/file.js`
    
    into
    
    `app:///path/to/file.js`,
    
    and for that it works great.
    
    What is also does, though, is take paths to files _outside_ of your app (like `node_modules` files) and transform their paths into things like
    
    `app:///../node_modules/someModule/path/to/someScript.js`.
    
    As a result, the server-side check for whether or not we should skip the file fails, we continue to process the file, and (as predicted) run into problems - specifically, error messages at the top of the event saying "Source code not found."
    
    This change simply casts a wider net when looking for files to exclude.
    
    (See associated PR for links to code illustrating many of the above points.)

diff --git a/src/sentry/lang/javascript/processor.py b/src/sentry/lang/javascript/processor.py
index 5d26ed5a82..e4d786f809 100644
--- a/src/sentry/lang/javascript/processor.py
+++ b/src/sentry/lang/javascript/processor.py
@@ -538,8 +538,9 @@ class JavaScriptStacktraceProcessor(StacktraceProcessor):
         # can't fetch if this is internal node module as well
         # therefore we only process user-land frames (starting with /)
         # or those created by bundle/webpack internals
-        if self.data.get("platform") == "node" and not frame.get("abs_path").startswith(
-            ("/", "app:", "webpack:")
+        if self.data.get("platform") == "node" and (
+            "node_modules" in frame.get("abs_path")
+            or not frame.get("abs_path").startswith(("/", "app:", "webpack:"))
         ):
             return
 
