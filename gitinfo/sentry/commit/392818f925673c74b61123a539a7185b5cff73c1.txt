commit 392818f925673c74b61123a539a7185b5cff73c1
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Jun 7 11:45:02 2018 -0700

    fix(snuba): Ignore legacy (non-MD5) hashes (#8675)
    
    Fixes SNS-99

diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index fe735b50d8..f394a0174a 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -12,6 +12,7 @@ import urllib3
 from django.conf import settings
 from django.db.models import Q
 
+from sentry.event_manager import HASH_RE
 from sentry.models import Group, GroupHash, GroupHashTombstone, Environment, Release, ReleaseProject
 from sentry.utils import metrics
 from sentry.utils.dates import to_timestamp
@@ -226,7 +227,7 @@ def get_project_issues(project_ids, issue_ids=None):
     else:
         hashes = GroupHash.objects.filter(project__in=project_ids)
 
-    hashes = list(hashes)
+    hashes = [h for h in hashes if HASH_RE.match(h.hash)]
     if not hashes:
         return []
 
diff --git a/tests/snuba/test_snuba.py b/tests/snuba/test_snuba.py
index 5f0452dc51..69f708c0eb 100644
--- a/tests/snuba/test_snuba.py
+++ b/tests/snuba/test_snuba.py
@@ -47,6 +47,19 @@ class SnubaTest(SnubaTestCase):
                 groupby=[")("],
             )
 
+    def test_project_issues_with_legacy_hash(self):
+        a_hash = 'a' * 32
+
+        for h in [a_hash, 'A' * 8]:
+            GroupHash.objects.create(
+                project=self.project,
+                group=self.group,
+                hash=h,
+            )
+
+        assert snuba.get_project_issues([self.project], [self.group.id]) == \
+            [(self.group.id, [('aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa', None)])]
+
     def test_project_issues_with_tombstones(self):
         base_time = datetime.utcnow()
         a_hash = 'a' * 32
