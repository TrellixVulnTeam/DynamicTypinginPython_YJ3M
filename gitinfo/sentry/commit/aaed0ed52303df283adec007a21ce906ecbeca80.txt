commit aaed0ed52303df283adec007a21ce906ecbeca80
Author: James Cunningham <cunninghamjt09@gmail.com>
Date:   Tue Sep 4 14:28:02 2018 -0700

    Add a cache get/set for EnvironmentProject creation. (#9609)
    
    * Add a cache get/set for EnvironmentProject creation.
    
    * fix name error and only set cache on successful create or IntegrityError
    
    * Add a comment for why we're setting it in both scenarios.
    
    * remove unused variable.
    
    * remove the assertion that sentry_environmentproject was queried because the 'preflight post' does it.

diff --git a/src/sentry/models/environment.py b/src/sentry/models/environment.py
index e1779e04da..a0843bfe61 100644
--- a/src/sentry/models/environment.py
+++ b/src/sentry/models/environment.py
@@ -88,11 +88,16 @@ class Environment(Model):
         return env
 
     def add_project(self, project):
-        try:
-            with transaction.atomic():
-                EnvironmentProject.objects.create(project=project, environment=self)
-        except IntegrityError:
-            pass
+        cache_key = 'envproj:c:%s:%s' % (self.id, project.id)
+
+        if cache.get(cache_key) is None:
+            try:
+                with transaction.atomic():
+                    EnvironmentProject.objects.create(project=project, environment=self)
+                cache.set(cache_key, 1, 3600)
+            except IntegrityError:
+                # We've already created the object, should still cache the action.
+                cache.set(cache_key, 1, 3600)
 
     @staticmethod
     def get_name_from_path_segment(segment):
diff --git a/tests/sentry/lang/java/test_plugin.py b/tests/sentry/lang/java/test_plugin.py
index 9672b3c2b6..182b7971bf 100644
--- a/tests/sentry/lang/java/test_plugin.py
+++ b/tests/sentry/lang/java/test_plugin.py
@@ -104,7 +104,6 @@ class BasicResolvingIntegrationTest(TestCase):
         self._postWithHeader(event_data)
         with self.assertWriteQueries({
             'nodestore_node': 2,
-            'sentry_environmentproject': 1,
             'sentry_eventtag': 1,
             'sentry_eventuser': 1,
             'sentry_filtervalue': 2,
diff --git a/tests/sentry/lang/javascript/test_plugin.py b/tests/sentry/lang/javascript/test_plugin.py
index 3adad1e3de..9ada9e6bf5 100644
--- a/tests/sentry/lang/javascript/test_plugin.py
+++ b/tests/sentry/lang/javascript/test_plugin.py
@@ -54,7 +54,6 @@ class JavascriptIntegrationTest(TestCase):
         self._postWithHeader(data)
         with self.assertWriteQueries({
             'nodestore_node': 2,
-            'sentry_environmentproject': 1,
             'sentry_eventtag': 1,
             'sentry_eventuser': 1,
             'sentry_filtervalue': 6,
diff --git a/tests/sentry/lang/native/test_plugin.py b/tests/sentry/lang/native/test_plugin.py
index 3319e40915..3c1576138c 100644
--- a/tests/sentry/lang/native/test_plugin.py
+++ b/tests/sentry/lang/native/test_plugin.py
@@ -174,7 +174,6 @@ class BasicResolvingIntegrationTest(TestCase):
         self._postWithHeader(event_data)
         with self.assertWriteQueries({
             'nodestore_node': 2,
-            'sentry_environmentproject': 1,
             'sentry_eventtag': 1,
             'sentry_eventuser': 1,
             'sentry_filtervalue': 8,
