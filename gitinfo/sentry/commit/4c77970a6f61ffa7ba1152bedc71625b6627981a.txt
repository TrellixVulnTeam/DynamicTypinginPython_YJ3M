commit 4c77970a6f61ffa7ba1152bedc71625b6627981a
Author: Bruno Garcia <github@brunogarcia.com>
Date:   Fri Feb 8 15:59:06 2019 +0100

    fix: Use img_addr as base_addr (#11996)
    
    * fix: Use img_addr as base_addr

diff --git a/src/sentry/lang/native/unreal.py b/src/sentry/lang/native/unreal.py
index edcf1312f5..754d4f3ab2 100644
--- a/src/sentry/lang/native/unreal.py
+++ b/src/sentry/lang/native/unreal.py
@@ -2,7 +2,7 @@ from __future__ import absolute_import
 from symbolic import Unreal4Crash
 from sentry.lang.native.minidump import MINIDUMP_ATTACHMENT_TYPE
 from sentry.models import UserReport
-from sentry.utils.safe import set_path, setdefault_path
+from sentry.utils.safe import set_path, setdefault_path, get_path
 
 import re
 import uuid
@@ -137,6 +137,7 @@ def merge_unreal_context_event(unreal_context, event, project):
         if portable_callstack is not None:
             frames = []
 
+            images = get_path(event, 'debug_meta', 'images', filter=True, default=())
             for match in _portable_callstack_regexp.finditer(portable_callstack):
                 baseaddr = int(match.group('baseaddr'), 16)
                 offset = int(match.group('offset'), 16)
@@ -144,6 +145,20 @@ def merge_unreal_context_event(unreal_context, event, project):
                 if baseaddr == 0xffffffff and offset == 0xffffffff:
                     continue
 
+                my_regex = re.escape(match.group('package')) + r"(\.dll|\.exe)?$"
+
+                # baseaddr reported in the pcallstack missing most relevant bits:
+                # i.e: 0x0000000080db0000
+                # The image address should be used instead with the offset:
+                it = next(
+                    (item for item in images if item.get("name") is not None and re.search(
+                        my_regex, item.get("name"), re.IGNORECASE)), {})
+
+                image_addr = it.get('image_addr')
+                if image_addr:
+                    # Rebase with the image address if available.
+                    baseaddr = int(image_addr, 16)
+
                 frames.append({
                     'package': match.group('package'),
                     'instruction_addr': hex(baseaddr + offset),
diff --git a/tests/sentry/lang/native/test_unreal.py b/tests/sentry/lang/native/test_unreal.py
index bd81b4d137..bc9bc63557 100644
--- a/tests/sentry/lang/native/test_unreal.py
+++ b/tests/sentry/lang/native/test_unreal.py
@@ -209,7 +209,7 @@ class UnrealIntegrationTest(TestCase):
         frames = bt.frames
         main = frames[-1]
         assert main.errors is None
-        assert main.instruction_addr == '0x54be3394'
+        assert main.instruction_addr == '0x7ff754be3394'
 
         attachments = sorted(
             EventAttachment.objects.filter(
