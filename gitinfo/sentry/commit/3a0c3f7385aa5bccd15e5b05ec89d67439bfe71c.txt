commit 3a0c3f7385aa5bccd15e5b05ec89d67439bfe71c
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu Apr 6 12:22:33 2017 +0200

    Changed test mocking to work with the fix for repos

diff --git a/tests/sentry/api/endpoints/test_organization_release_details.py b/tests/sentry/api/endpoints/test_organization_release_details.py
index bb4ad41b4a..e1d776ac0c 100644
--- a/tests/sentry/api/endpoints/test_organization_release_details.py
+++ b/tests/sentry/api/endpoints/test_organization_release_details.py
@@ -117,6 +117,11 @@ class UpdateReleaseDetailsTest(APITestCase):
         project = self.create_project(team=team1, organization=org)
         project2 = self.create_project(team=team2, organization=org)
 
+        base_release = Release.objects.create(
+            organization_id=org.id,
+            version='000000000',
+        )
+        base_release.add_project(project)
         release = Release.objects.create(
             organization_id=org.id,
             version='abcabcabc',
@@ -132,6 +137,18 @@ class UpdateReleaseDetailsTest(APITestCase):
 
         self.login_as(user=user)
 
+        url = reverse('sentry-api-0-organization-release-details', kwargs={
+            'organization_slug': org.slug,
+            'version': base_release.version,
+        })
+        self.client.put(url, {
+            'ref': 'master',
+            'headCommits': [
+                {'currentId': '0' * 40, 'repository': repo.name},
+                {'currentId': '0' * 40, 'repository': repo2.name},
+            ],
+        })
+
         url = reverse('sentry-api-0-organization-release-details', kwargs={
             'organization_slug': org.slug,
             'version': release.version,
@@ -201,6 +218,12 @@ class UpdateReleaseDetailsTest(APITestCase):
         project = self.create_project(team=team1, organization=org)
         project2 = self.create_project(team=team2, organization=org)
 
+        base_release = Release.objects.create(
+            organization_id=org.id,
+            version='000000000',
+        )
+        base_release.add_project(project)
+
         release = Release.objects.create(
             organization_id=org.id,
             version='abcabcabc',
@@ -216,6 +239,18 @@ class UpdateReleaseDetailsTest(APITestCase):
 
         self.login_as(user=user)
 
+        url = reverse('sentry-api-0-organization-release-details', kwargs={
+            'organization_slug': org.slug,
+            'version': base_release.version,
+        })
+        self.client.put(url, {
+            'ref': 'master',
+            'headCommits': [
+                {'currentId': '0' * 40, 'repository': repo.name},
+                {'currentId': '0' * 40, 'repository': repo2.name},
+            ],
+        })
+
         url = reverse('sentry-api-0-organization-release-details', kwargs={
             'organization_slug': org.slug,
             'version': release.version,
diff --git a/tests/sentry/api/endpoints/test_organization_releases.py b/tests/sentry/api/endpoints/test_organization_releases.py
index 73cf83228b..526196db78 100644
--- a/tests/sentry/api/endpoints/test_organization_releases.py
+++ b/tests/sentry/api/endpoints/test_organization_releases.py
@@ -467,6 +467,14 @@ class OrganizationReleaseCreateTest(APITestCase):
         url = reverse('sentry-api-0-organization-releases', kwargs={
             'organization_slug': org.slug
         })
+        self.client.post(url, data={
+            'version': '1',
+            'refs': [
+                {'commit': '0' * 40, 'repository': repo.name},
+                {'commit': '0' * 40, 'repository': repo2.name},
+            ],
+            'projects': [project.slug]
+        })
         response = self.client.post(url, data={
             'version': '1.2.1',
             'refs': [
@@ -528,6 +536,14 @@ class OrganizationReleaseCreateTest(APITestCase):
         url = reverse('sentry-api-0-organization-releases', kwargs={
             'organization_slug': org.slug
         })
+        self.client.post(url, data={
+            'version': '1',
+            'headCommits': [
+                {'currentId': '0' * 40, 'repository': repo.name},
+                {'currentId': '0' * 40, 'repository': repo2.name},
+            ],
+            'projects': [project.slug]
+        })
         response = self.client.post(url, data={
             'version': '1.2.1',
             'headCommits': [
@@ -732,6 +748,13 @@ class OrganizationReleaseCreateTest(APITestCase):
             'organization_slug': org.slug
         })
 
+        response = self.client.post(url, data={
+            'version': '1',
+            'headCommits': [
+                {'currentId': 'b' * 40, 'repository': repo2.name},
+            ],
+            'projects': [project1.slug]
+        }, HTTP_AUTHORIZATION='Bearer {}'.format(api_token.token))
         response = self.client.post(url, data={
             'version': '1.2.1',
             'headCommits': [
