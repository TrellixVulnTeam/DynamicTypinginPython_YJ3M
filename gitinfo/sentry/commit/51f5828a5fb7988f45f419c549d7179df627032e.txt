commit 51f5828a5fb7988f45f419c549d7179df627032e
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jun 27 15:40:40 2017 -0700

    ui: various fixes for form values
    
    - fix onChange in Select2Field
    - fix onChange in BooleanField
    - add tests for BooleanField

diff --git a/src/sentry/static/sentry/app/components/forms/booleanField.jsx b/src/sentry/static/sentry/app/components/forms/booleanField.jsx
index ba8159263c..c458260209 100644
--- a/src/sentry/static/sentry/app/components/forms/booleanField.jsx
+++ b/src/sentry/static/sentry/app/components/forms/booleanField.jsx
@@ -5,21 +5,15 @@ import {defined} from '../../utils';
 import InputField from './inputField';
 
 export default class BooleanField extends InputField {
-  valueFromProps(props) {
-    let value = super.valueFromProps(props);
+  coerceValue(props) {
+    let value = super.coerceValue(props);
     return value ? true : false;
   }
 
-  onChange(e) {
-    this.setState(
-      {
-        value: e.target.checked
-      },
-      () => {
-        this.props.onChange(this.state.value);
-      }
-    );
-  }
+  onChange = e => {
+    let value = e.target.checked;
+    this.setValue(value);
+  };
 
   getField() {
     return (
diff --git a/src/sentry/static/sentry/app/components/forms/formField.jsx b/src/sentry/static/sentry/app/components/forms/formField.jsx
index 9be0c4c218..5bdcf96d2b 100644
--- a/src/sentry/static/sentry/app/components/forms/formField.jsx
+++ b/src/sentry/static/sentry/app/components/forms/formField.jsx
@@ -71,15 +71,24 @@ export default class FormField extends React.Component {
     return `id-${this.props.name}`;
   }
 
+  coerceValue(value) {
+    return value;
+  }
+
   onChange = e => {
+    let value = e.target.value;
+    this.setValue(value);
+  };
+
+  setValue = value => {
     let form = (this.context || {}).form;
     this.setState(
       {
-        value: e.target.value
+        value: value
       },
       () => {
-        this.props.onChange && this.props.onChange(this.state.value);
-        form && form.onFieldChange(this.props.name, this.state.value);
+        this.props.onChange && this.props.onChange(this.coerceValue(this.state.value));
+        form && form.onFieldChange(this.props.name, this.coerceValue(this.state.value));
       }
     );
   };
diff --git a/src/sentry/static/sentry/app/components/forms/select2Field.jsx b/src/sentry/static/sentry/app/components/forms/select2Field.jsx
index 52dde9d3c9..67f46d18f8 100644
--- a/src/sentry/static/sentry/app/components/forms/select2Field.jsx
+++ b/src/sentry/static/sentry/app/components/forms/select2Field.jsx
@@ -27,7 +27,7 @@ class Select2Field extends InputField {
     );
   }
 
-  onChange(e) {
+  onChange = e => {
     if (this.props.multiple) {
       let options = e.target.options;
       let value = [];
@@ -36,18 +36,11 @@ class Select2Field extends InputField {
           value.push(options[i].value);
         }
       }
-      this.setState(
-        {
-          value: value
-        },
-        () => {
-          this.props.onChange(this.state.value);
-        }
-      );
-      return;
+      this.setValue(value);
+    } else {
+      this.setValue(e.target.value);
     }
-    super.onChange(e);
-  }
+  };
 
   getSelect2Options() {
     return {
diff --git a/tests/js/spec/components/forms/__snapshots__/booleanField.spec.jsx.snap b/tests/js/spec/components/forms/__snapshots__/booleanField.spec.jsx.snap
new file mode 100644
index 0000000000..6ca9eb9f82
--- /dev/null
+++ b/tests/js/spec/components/forms/__snapshots__/booleanField.spec.jsx.snap
@@ -0,0 +1,45 @@
+// Jest Snapshot v1, https://goo.gl/fbAQLP
+
+exports[`BooleanField render() renders with form context 1`] = `
+<div
+  className="control-group checkbox"
+>
+  <div
+    className="controls"
+  >
+    <label
+      className="control-label"
+    >
+      <input
+        defaultChecked={true}
+        disabled={false}
+        id="id-fieldName"
+        onChange={[Function]}
+        type="checkbox"
+      />
+    </label>
+  </div>
+</div>
+`;
+
+exports[`BooleanField render() renders without form context 1`] = `
+<div
+  className="control-group checkbox"
+>
+  <div
+    className="controls"
+  >
+    <label
+      className="control-label"
+    >
+      <input
+        defaultChecked=""
+        disabled={false}
+        id="id-fieldName"
+        onChange={[Function]}
+        type="checkbox"
+      />
+    </label>
+  </div>
+</div>
+`;
diff --git a/tests/js/spec/components/forms/booleanField.spec.jsx b/tests/js/spec/components/forms/booleanField.spec.jsx
new file mode 100644
index 0000000000..1dda8b136b
--- /dev/null
+++ b/tests/js/spec/components/forms/booleanField.spec.jsx
@@ -0,0 +1,28 @@
+import React from 'react';
+import {shallow} from 'enzyme';
+import toJson from 'enzyme-to-json';
+
+import {BooleanField} from 'app/components/forms';
+
+describe('BooleanField', function() {
+  describe('render()', function() {
+    it('renders without form context', function() {
+      let wrapper = shallow(<BooleanField name="fieldName" />);
+      expect(toJson(wrapper)).toMatchSnapshot();
+    });
+
+    it('renders with form context', function() {
+      let wrapper = shallow(<BooleanField name="fieldName" />, {
+        context: {
+          form: {
+            data: {
+              fieldName: true
+            },
+            errors: {}
+          }
+        }
+      });
+      expect(toJson(wrapper)).toMatchSnapshot();
+    });
+  });
+});
