commit e93ae4566acd5f641a8028c75756368cc219ad9e
Author: Dan Fuller <dfuller@sentry.io>
Date:   Wed May 6 15:52:10 2020 -0700

    Revert "refs(mail): Cleanup digests task key migration code. (#18429)" (#18650)
    
    * Revert "refs(mail): Cleanup digests task key migration code. (#18429)"
    
    This reverts commit 8e335c7b070cb6d2e9dc1fdc3ce7e1964469346f.
    
    We're reverting this because it causes an issue when on-prem users migrate and have old digest tasks
    hanging around. We'll have to keep this transition code around indefinitely, unfortunately.

diff --git a/src/sentry/digests/notifications.py b/src/sentry/digests/notifications.py
index 3269ec75ad..c24190b370 100644
--- a/src/sentry/digests/notifications.py
+++ b/src/sentry/digests/notifications.py
@@ -23,8 +23,15 @@ def split_key(key):
 
     key_parts = key.split(":", 4)
     project_id = key_parts[2]
-    target_type = ActionTargetType(key_parts[3])
-    target_identifier = key_parts[4] if key_parts[4] else None
+    # XXX: We transitioned to new style keys (len == 5) a while ago on sentry.io. But
+    # on-prem users might transition at any time, so we need to keep this transition
+    # code around for a while, maybe indefinitely.
+    if len(key_parts) == 5:
+        target_type = ActionTargetType(key_parts[3])
+        target_identifier = key_parts[4] if key_parts[4] else None
+    else:
+        target_type = ActionTargetType.ISSUE_OWNERS
+        target_identifier = None
     return Project.objects.get(pk=project_id), target_type, target_identifier
 
 
diff --git a/tests/sentry/digests/test_notifications.py b/tests/sentry/digests/test_notifications.py
index 45d3ecaf0a..8f7e072c31 100644
--- a/tests/sentry/digests/test_notifications.py
+++ b/tests/sentry/digests/test_notifications.py
@@ -118,6 +118,13 @@ class SortRecordsTestCase(TestCase):
 
 
 class SplitKeyTestCase(TestCase):
+    def test_old_style_key(self):
+        assert split_key("mail:p:{}".format(self.project.id)) == (
+            self.project,
+            ActionTargetType.ISSUE_OWNERS,
+            None,
+        )
+
     def test_new_style_key_no_identifier(self):
         assert split_key(
             "mail:p:{}:{}:".format(self.project.id, ActionTargetType.ISSUE_OWNERS.value)
diff --git a/tests/sentry/tasks/test_digests.py b/tests/sentry/tasks/test_digests.py
index a11109d301..77c423e3a0 100644
--- a/tests/sentry/tasks/test_digests.py
+++ b/tests/sentry/tasks/test_digests.py
@@ -28,6 +28,7 @@ class DeliverDigestTest(TestCase):
             data={"timestamp": iso_format(before_now(days=1)), "fingerprint": ["group-2"]},
             project_id=self.project.id,
         )
+        key = "mail:p:{}".format(self.project.id)
         backend.add(key, event_to_record(event, [rule]), increment_delay=0, maximum_delay=0)
         backend.add(key, event_to_record(event_2, [rule]), increment_delay=0, maximum_delay=0)
         digests.digest = backend.digest
@@ -35,6 +36,10 @@ class DeliverDigestTest(TestCase):
             deliver_digest(key)
         assert "2 new alerts since" in mail.outbox[0].subject
 
+    @patch.object(sentry, "digests")
+    def test_old_key(self, digests):
+        self.run_test("mail:p:{}".format(self.project.id), digests)
+
     @patch.object(sentry, "digests")
     def test_new_key(self, digests):
         self.run_test("mail:p:{}:IssueOwners:".format(self.project.id), digests)
