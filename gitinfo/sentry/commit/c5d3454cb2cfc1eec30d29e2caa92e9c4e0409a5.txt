commit c5d3454cb2cfc1eec30d29e2caa92e9c4e0409a5
Author: Dan Fuller <dfuller@sentry.io>
Date:   Thu Nov 21 16:38:04 2019 -0800

    fix(tests): Fix Django 1.10 bug in `TestRefresher.test_happy_path`
    
    Django 1.10 adds contraint checks to the end of test runs. Since Django uses deferrable constraints
    for all fks this means we check db constraints after each test.
    
    This causes a break in `TestRefresher.test_happy_path`. Turns out that if you use a `GrantExchanger`
    it deletes the previous `ApiGrant`, which causes related foreign keys to be set to null, which is
    what we want. However, if you use a `Refresher` with a cached `SentryAppInstallation`, it ends up
    saving the `SentryAppInstallation`, which means it then writes the `api_grant_id` to be set back to
    the previous id. This ends up causing a constraint error.

diff --git a/src/sentry/mediators/token_exchange/refresher.py b/src/sentry/mediators/token_exchange/refresher.py
index 88293160ee..d1f13a16af 100644
--- a/src/sentry/mediators/token_exchange/refresher.py
+++ b/src/sentry/mediators/token_exchange/refresher.py
@@ -52,8 +52,7 @@ class Refresher(Mediator):
             scope_list=self.sentry_app.scope_list,
             expires_at=token_expiration(),
         )
-        self.install.api_token = token
-        self.install.save()
+        self.install.update(api_token=token)
         return token
 
     @memoize
