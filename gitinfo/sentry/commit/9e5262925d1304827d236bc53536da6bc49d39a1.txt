commit 9e5262925d1304827d236bc53536da6bc49d39a1
Author: William Mak <william@wmak.io>
Date:   Thu Nov 21 17:59:33 2019 -0500

    fix(user_tags): Fix clicking affected users with special characters (#15756)
    
    * fix(user_tags): Fix clicking affected users with special characters
    
    - This is to fix an issue when clicking an affected user in an event tag
      with a space in it, currently the query is missing quotes, so we
      interpret the part after a space as another term.
        - eg. user.id:123 456
    - As part of this also fixing it when the tag has a quote in it as well
        - eg. user.id:123"456

diff --git a/src/sentry/search/utils.py b/src/sentry/search/utils.py
index 78611cd13f..f2509f6548 100644
--- a/src/sentry/search/utils.py
+++ b/src/sentry/search/utils.py
@@ -442,4 +442,4 @@ def convert_user_tag_to_query(key, value):
     if key == "user" and ":" in value:
         sub_key, value = value.split(":", 1)
         if KEYWORD_MAP.get_key(sub_key, None):
-            return "user.%s:%s" % (sub_key, value)
+            return 'user.%s:"%s"' % (sub_key, value.replace('"', '\\"'))
diff --git a/tests/sentry/api/serializers/test_event.py b/tests/sentry/api/serializers/test_event.py
index 48e8432fd5..26b7d2eef1 100644
--- a/tests/sentry/api/serializers/test_event.py
+++ b/tests/sentry/api/serializers/test_event.py
@@ -292,7 +292,7 @@ class SimpleEventSerializerTest(TestCase):
         assert result["user"]["username"] == event.username
         assert result["user"]["ip_address"] == event.ip_address
         assert result["tags"] == [
-            {"key": "user", "value": "email:test@test.com", "query": "user.email:test@test.com"}
+            {"key": "user", "value": "email:test@test.com", "query": 'user.email:"test@test.com"'}
         ]
 
     def test_no_group(self):
diff --git a/tests/sentry/api/serializers/test_tagvalue.py b/tests/sentry/api/serializers/test_tagvalue.py
index c91f3869aa..527b6af3d4 100644
--- a/tests/sentry/api/serializers/test_tagvalue.py
+++ b/tests/sentry/api/serializers/test_tagvalue.py
@@ -24,7 +24,7 @@ class TagValueSerializerTest(TestCase):
         assert result["key"] == "user"
         assert result["value"] == "username:ted"
         assert result["name"] == "ted"
-        assert result["query"] == "user.username:ted"
+        assert result["query"] == 'user.username:"ted"'
 
     def test_release(self):
         user = self.create_user()
@@ -56,4 +56,4 @@ class UseTagValueSerializerTest(TestCase):
 
         result = serialize(tagvalue, user, serializer=UserTagValueSerializer(project_id=1))
         assert result["value"] == "username:ted"
-        assert result["query"] == "user.username:ted"
+        assert result["query"] == 'user.username:"ted"'
diff --git a/tests/sentry/search/test_utils.py b/tests/sentry/search/test_utils.py
index 045d3cb75c..7a1e8f106f 100644
--- a/tests/sentry/search/test_utils.py
+++ b/tests/sentry/search/test_utils.py
@@ -20,6 +20,7 @@ from sentry.search.utils import (
     parse_query,
     get_latest_release,
     get_numeric_field_value,
+    convert_user_tag_to_query,
     InvalidQuery,
 )
 
@@ -514,3 +515,17 @@ class GetLatestReleaseTest(TestCase):
             environment = self.create_environment()
             result = get_latest_release([self.project], [environment])
             assert result == new.version
+
+
+class ConvertUserTagTest(TestCase):
+    def test_simple_user_tag(self):
+        assert convert_user_tag_to_query("user", "id:123456") == 'user.id:"123456"'
+
+    def test_user_tag_with_quote(self):
+        assert convert_user_tag_to_query("user", 'id:123"456') == 'user.id:"123\\"456"'
+
+    def test_user_tag_with_space(self):
+        assert convert_user_tag_to_query("user", "id:123 456") == 'user.id:"123 456"'
+
+    def test_non_user_tag(self):
+        assert convert_user_tag_to_query("user", 'fake:123"456') is None
diff --git a/tests/snuba/models/test_event.py b/tests/snuba/models/test_event.py
index 6f1b588ec2..8c31643595 100644
--- a/tests/snuba/models/test_event.py
+++ b/tests/snuba/models/test_event.py
@@ -99,5 +99,5 @@ class SnubaEventTest(TestCase, SnubaTestCase):
             {"_meta": None, "key": "foo", "value": "bar"},
             {"_meta": None, "key": "level", "value": "error"},
             {"_meta": None, "key": "release", "value": "release1"},
-            {"_meta": None, "key": "user", "query": "user.id:user1", "value": "id:user1"},
+            {"_meta": None, "key": "user", "query": 'user.id:"user1"', "value": "id:user1"},
         ]
