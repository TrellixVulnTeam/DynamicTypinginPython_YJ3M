commit 6ff35d380a8e59f16b7855134e688cdc06ae5b5e
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu May 19 20:26:31 2016 +0200

    Added unsubscribe links to activity and digest mails

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index 486a11e536..4ebb7a10d0 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -123,6 +123,12 @@ class MailPlugin(NotificationPlugin):
 
         return send_to_list
 
+    def add_unsubscribe_link(self, context, user_id, project):
+        context['unsubscribe_link'] = generate_signed_link(user_id,
+            'sentry-account-email-unsubscribe-project', kwargs={
+                'project_id': project.id,
+            })
+
     def notify(self, notification):
         event = notification.event
         group = event.group
@@ -181,10 +187,7 @@ class MailPlugin(NotificationPlugin):
         }
 
         for user_id in self.get_send_to(project):
-            context['unsubscribe_link'] = generate_signed_link(user_id,
-                'sentry-account-email-unsubscribe-project', kwargs={
-                    'project_id': project.id,
-                })
+            self.add_unsubscribe_link(context, user_id, project)
             self._send_mail(
                 subject=subject,
                 template=template,
@@ -222,13 +225,16 @@ class MailPlugin(NotificationPlugin):
             'counts': counts,
         }
 
-        self._send_mail(
-            subject=render_to_string('sentry/emails/digests/subject.txt', context).rstrip(),
-            template='sentry/emails/digests/body.txt',
-            html_template='sentry/emails/digests/body.html',
-            project=project,
-            context=context,
-        )
+        for user_id in self.get_send_to(project):
+            self.add_unsubscribe_link(context, user_id, project)
+            self._send_mail(
+                subject=render_to_string('sentry/emails/digests/subject.txt', context).rstrip(),
+                template='sentry/emails/digests/body.txt',
+                html_template='sentry/emails/digests/body.html',
+                project=project,
+                context=context,
+                send_to=[user_id],
+            )
 
     def notify_about_activity(self, activity):
         if activity.type not in (Activity.NOTE, Activity.ASSIGNED, Activity.RELEASE):
@@ -311,17 +317,19 @@ class MailPlugin(NotificationPlugin):
         else:
             raise NotImplementedError
 
-        self._send_mail(
-            project=project,
-            send_to=recipient_ids,
-            subject=subject,
-            context=context,
-            template='sentry/emails/activity/{}.txt'.format(template_name),
-            html_template='sentry/emails/activity/{}.html'.format(template_name),
-            headers=headers,
-            reference=activity,
-            reply_reference=group,
-        )
+        for user_id in recipient_ids:
+            self.add_unsubscribe_link(context, user_id, project)
+            self._send_mail(
+                project=project,
+                send_to=[user_id],
+                subject=subject,
+                context=context,
+                template='sentry/emails/activity/{}.txt'.format(template_name),
+                html_template='sentry/emails/activity/{}.html'.format(template_name),
+                headers=headers,
+                reference=activity,
+                reply_reference=group,
+            )
 
 
 # Legacy compatibility
diff --git a/src/sentry/templates/sentry/emails/activity/assigned.txt b/src/sentry/templates/sentry/emails/activity/assigned.txt
index a61c014bd7..13d3472a69 100644
--- a/src/sentry/templates/sentry/emails/activity/assigned.txt
+++ b/src/sentry/templates/sentry/emails/activity/assigned.txt
@@ -10,5 +10,7 @@ Details
 
 {{ link }}
 
+Unsubscribe: {{ unsubscribe_link }}
+
 {% endautoescape %}
 {% endspaceless %}
diff --git a/src/sentry/templates/sentry/emails/activity/note.txt b/src/sentry/templates/sentry/emails/activity/note.txt
index e2e0482658..eb98a935c4 100644
--- a/src/sentry/templates/sentry/emails/activity/note.txt
+++ b/src/sentry/templates/sentry/emails/activity/note.txt
@@ -12,5 +12,7 @@ Details
 
 {{ activity_link }}
 
+Unsubscribe: {{ unsubscribe_link }}
+
 {% endautoescape %}
 {% endspaceless %}
diff --git a/src/sentry/templates/sentry/emails/base.html b/src/sentry/templates/sentry/emails/base.html
index 63ca986f44..c1d9cc4ac6 100644
--- a/src/sentry/templates/sentry/emails/base.html
+++ b/src/sentry/templates/sentry/emails/base.html
@@ -32,6 +32,11 @@
           {% block main %}
           <p>This is the body of an email</p>
           {% endblock %}
+          {% if unsubscribe_link %}
+            <p>
+              <a href="{{ unsubscribe_link }}">Click to unsubscribe</a>
+            </p>
+          {% endif %}
         </div>
         <div class="footer">
           {% block footer %}
diff --git a/src/sentry/templates/sentry/emails/digests/body.html b/src/sentry/templates/sentry/emails/digests/body.html
index 94c6f985fd..4ad79ace59 100644
--- a/src/sentry/templates/sentry/emails/digests/body.html
+++ b/src/sentry/templates/sentry/emails/digests/body.html
@@ -54,6 +54,10 @@
     </div>
 {% endfor %}
 
+    <p>
+      <a href="{{ unsubscribe_link }}">Click to unsubscribe</a>
+    </p>
+
 <div class="container">
   <div class="footer" style="margin-top: 30px">
     {% block footer %}
diff --git a/src/sentry/templates/sentry/emails/digests/body.txt b/src/sentry/templates/sentry/emails/digests/body.txt
index cfb926169a..557faf9f01 100644
--- a/src/sentry/templates/sentry/emails/digests/body.txt
+++ b/src/sentry/templates/sentry/emails/digests/body.txt
@@ -7,3 +7,5 @@
   {% url 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}{% absolute_uri group_link %}
 
 {% endfor %}{% endfor %}
+
+Unsubscribe: {{ unsubscribe_link }}
diff --git a/src/sentry/templates/sentry/emails/error.html b/src/sentry/templates/sentry/emails/error.html
index df9a5aee05..1f5729f8f7 100644
--- a/src/sentry/templates/sentry/emails/error.html
+++ b/src/sentry/templates/sentry/emails/error.html
@@ -70,10 +70,6 @@
             {% endfor %}
         </p>
     {% endif %}
-    <p>
-      <a href="{{ unsubscribe_link }}">Click to unsubscribe</a>
-    </p>
-
 
     {# support for gmail actions #}
     <div itemscope itemtype="http://schema.org/EmailMessage">
