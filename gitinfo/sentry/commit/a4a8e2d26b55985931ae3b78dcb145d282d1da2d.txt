commit a4a8e2d26b55985931ae3b78dcb145d282d1da2d
Author: Burak Yigit Kaya <ben@byk.im>
Date:   Wed Jan 15 16:28:44 2020 +0300

    fix(Docker): Make file storage init more robust (#16353)
    
    * fix(Docker): Make file storage init more robust
    
    Docker images assume and hard-code certain things around local file storage and rely on the SENTRY_FILESTORE_DIR env variable for the location which is not the source of truth, causing issues like getsentry/onpremise#328. This patch removes the hard-coding and assumptions around local filesystem storage and makes the init more robust by making calls to `sentry config get` at a cost of increased init time.
    
    * hard-code /data

diff --git a/docker/Dockerfile b/docker/Dockerfile
index a40a10d115..f0087bc6c7 100644
--- a/docker/Dockerfile
+++ b/docker/Dockerfile
@@ -173,12 +173,12 @@ RUN set -x \
     # Fully verify that the C extension is correctly installed, it unfortunately
     # requires a full check into maxminddb.extension.Reader
     && python -c 'import maxminddb.extension; maxminddb.extension.Reader' \
-    && mkdir -p $SENTRY_CONF && mkdir -p $SENTRY_FILESTORE_DIR
+    && mkdir -p $SENTRY_CONF
 
 COPY ./docker/docker-entrypoint.sh ./docker/sentry.conf.py ./docker/config.yml $SENTRY_CONF/
 
 EXPOSE 9000
-VOLUME /var/lib/sentry/files
+VOLUME /data
 
 ENTRYPOINT exec $SENTRY_CONF/docker-entrypoint.sh $0 $@
 CMD ["run", "web"]
diff --git a/docker/config.yml b/docker/config.yml
index 433b9dcd3b..acc2699c8b 100644
--- a/docker/config.yml
+++ b/docker/config.yml
@@ -26,6 +26,25 @@
 # route to forward to /api/hooks/mailgun/inbound/
 # mail.mailgun-api-key: ''
 
+################
+# File storage #
+################
+
+# Uploaded media uses these `filestore` settings. The available
+# backends are either `filesystem` or `s3`.
+
+filestore.backend: 'filesystem'
+filestore.options:
+  location: '/data/files'
+dsym.cache-path: '/data/dsym-cache'
+releasefile.cache-path: '/data/releasefile-cache'
+
+# filestore.backend: 's3'
+# filestore.options:
+#   access_key: 'AKIXXXXXX'
+#   secret_key: 'XXXXXXX'
+#   bucket_name: 's3-bucket-name'
+
 ###################
 # System Settings #
 ###################
diff --git a/docker/docker-entrypoint.sh b/docker/docker-entrypoint.sh
index a17001f5d0..546dbc756e 100755
--- a/docker/docker-entrypoint.sh
+++ b/docker/docker-entrypoint.sh
@@ -17,8 +17,8 @@ esac
 if [ "$1" = 'sentry' ]; then
 	set -- tini -- "$@"
 	if [ "$(id -u)" = '0' ]; then
-		mkdir -p "$SENTRY_FILESTORE_DIR"
-		find "$SENTRY_FILESTORE_DIR" ! -user sentry -exec chown sentry {} \;
+		mkdir -p /data/files
+		find /data ! -user sentry -exec chown sentry {} \;
 		set -- gosu sentry "$@"
 	fi
 fi
diff --git a/docker/sentry.conf.py b/docker/sentry.conf.py
index 9f8bcf77d2..f71598a325 100644
--- a/docker/sentry.conf.py
+++ b/docker/sentry.conf.py
@@ -217,18 +217,6 @@ SENTRY_TSDB = 'sentry.tsdb.redis.RedisTSDB'
 
 SENTRY_DIGESTS = 'sentry.digests.backends.redis.RedisBackend'
 
-################
-# File storage #
-################
-
-# Uploaded media uses these `filestore` settings. The available
-# backends are either `filesystem` or `s3`.
-
-SENTRY_OPTIONS['filestore.backend'] = 'filesystem'
-SENTRY_OPTIONS['filestore.options'] = {
-    'location': env('SENTRY_FILESTORE_DIR'),
-}
-
 ##############
 # Web Server #
 ##############
