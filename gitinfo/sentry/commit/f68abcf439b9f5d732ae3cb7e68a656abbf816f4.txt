commit f68abcf439b9f5d732ae3cb7e68a656abbf816f4
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Feb 4 12:12:27 2017 +0300

    [alerts] enhance digest/alert emails
    
    - add issue header to alert
    - add transaction to issue headers
    - update event rendering to reflect current UI

diff --git a/src/sentry/models/event.py b/src/sentry/models/event.py
index 0c16897bdc..efb061d7b6 100644
--- a/src/sentry/models/event.py
+++ b/src/sentry/models/event.py
@@ -258,13 +258,17 @@ class Event(Model):
     @property
     def culprit(self):
         warnings.warn('Event.culprit is deprecated. Use Group.culprit instead.')
-        return self.get_tag('transaction') or self.group.culprit
+        return self.transaction or self.group.culprit
 
     @property
     def checksum(self):
         warnings.warn('Event.checksum is no longer used', DeprecationWarning)
         return ''
 
+    @property
+    def transaction(self):
+        return self.get_tag('transaction')
+
     def get_email_subject(self):
         template = self.project.get_option('mail:subject_template')
         if template:
diff --git a/src/sentry/templates/sentry/emails/_group.html b/src/sentry/templates/sentry/emails/_group.html
index 101f752718..92f019c6f6 100644
--- a/src/sentry/templates/sentry/emails/_group.html
+++ b/src/sentry/templates/sentry/emails/_group.html
@@ -2,33 +2,46 @@
 
 {% url 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}
 
+{% with type=group.get_event_type metadata=group.get_event_metadata transaction=group.culprit %}
 <div class="issue {% if group.is_resolved %}resolved{% endif %}">
-
-  {% if group.data.type == "error" %}
-  <div class="event-type error">
+  {% if type == "error" %}
+    <div class="event-type error">
       <h3>
-        {% if group.data.metadata.type %}
-          <a href="{% absolute_uri group_link %}">{{ group.data.metadata.type|truncatechars:40 }}</a>
-          {% if group.data.metadata.value %}
-            <small>{{ group.data.metadata.value|truncatechars:100|soft_break:40 }}</small>
+        {% if metadata.type %}
+          <a href="{% absolute_uri link %}">{{ metadata.type|truncatechars:40 }}</a>
+          {% if transaction %}
+            <em class="event-subtitle">{{ transaction }}</em>
+          {% endif %}
+          <br />
+          {% if metadata.value %}
+            <small>{{ metadata.value|truncatechars:100|soft_break:40 }}</small>
           {% endif %}
         {% else %}
-          <a href="{% absolute_uri group_link %}">{{ group.data.metadata.value|truncatechars:40 }}</a>
+          <a href="{% absolute_uri link %}">{{ metadata.value|truncatechars:40 }}</a><br />
+          {% if transaction %}
+            <em class="event-subtitle">{{ transaction }}</em>
+          {% endif %}
         {% endif %}
       </h3>
     </div>
-  {% elif group.data.type == "csp" %}
+  {% elif type == "csp" %}
     <div class="event-type csp">
       <h3>
-        <a href="{% absolute_uri group_link %}">{{ group.data.metadata.message|truncatechars:40 }}</a>
+        <a href="{% absolute_uri link %}">{{ metadata.directive|truncatechars:40 }}</a><br />
+        {% if metadata.uri %}
+          <em class="event-subtitle">{{ metadata.uri }}</em>
+        {% endif %}
       </h3>
     </div>
   {% else %}
     <div class="event-type default">
       <h3>
-        <a href="{% absolute_uri group_link %}">{{ group.message_short|truncatechars:40 }}</a>
+        <a href="{% absolute_uri link %}">{{ group.title|truncatechars:40 }}</a><br />
+        {% if transaction %}
+          <em class="event-subtitle">{{ transaction }}</em>
+        {% endif %}
       </h3>
     </div>
   {% endif %}
-
 </div>
+{% endwith %}
diff --git a/src/sentry/templates/sentry/emails/digests/body.html b/src/sentry/templates/sentry/emails/digests/body.html
index e69a39d72d..f7db6a4178 100644
--- a/src/sentry/templates/sentry/emails/digests/body.html
+++ b/src/sentry/templates/sentry/emails/digests/body.html
@@ -33,9 +33,7 @@
                   </td>
                   <td class="event-detail">
                       {% include "sentry/emails/_group.html" %}
-                      <p>
-                        <small>{{ records.0.datetime|date:"N j, Y, g:i:s a e" }}</small>
-                      </p>
+                      <div><small>{{ records.0.datetime|date:"N j, Y, g:i:s a e" }}</small></div>
                   </td>
               </tr>
           {% endfor %}
diff --git a/src/sentry/templates/sentry/emails/email-styles.html b/src/sentry/templates/sentry/emails/email-styles.html
index a14f3bbc6a..2b9b57c594 100644
--- a/src/sentry/templates/sentry/emails/email-styles.html
+++ b/src/sentry/templates/sentry/emails/email-styles.html
@@ -408,11 +408,11 @@
   /* Issue */
 
   .issue {
-    line-height: 24px;
+    line-height: 22px;
   }
 
   .issue h3 {
-    line-height: 24px;
+    line-height: 22px;
     margin: 0;
   }
 
@@ -567,6 +567,10 @@
     padding-bottom: 10px;
   }
 
+  table.event-list td.error-level {
+    width: 70px;
+  }
+
   table.event-list th.align-right, table.event-list td.align-right {
     text-align: right;
   }
@@ -577,8 +581,16 @@
     font-weight: 600;
   }
 
+  table.event-list .event-type a {
+    margin-right: 10px;
+  }
+
+  table.event-list .event-subtitle {
+    font-size: 13px;
+  }
+
   table.event-list .event-detail {
-    line-height: 24px;
+    line-height: 22px;
     width: 400px;
     text-align: left;
   }
diff --git a/src/sentry/templates/sentry/emails/error.html b/src/sentry/templates/sentry/emails/error.html
index b0838b0b6f..003a2f900e 100644
--- a/src/sentry/templates/sentry/emails/error.html
+++ b/src/sentry/templates/sentry/emails/error.html
@@ -18,9 +18,70 @@
     </h2>
 
     {% if enhanced_privacy %}
+      <div class="event">
+        <div class="event-id">ID: {{ event.event_id }}</div>
+        <div class="event-date">{{ event.datetime|date:"N j, Y, g:i:s a e" }}</div>
+      </div>
+
       <div class="notice">Details about this issue are not shown in this notification since enhanced privacy
         controls are enabled. For more details about this issue, <a href="{{ link }}">view this issue on Sentry</a>.</div>
     {% else %}
+      <table class="event-list">
+        <tr>
+            <th colspan="2">Issue</th>
+        </tr>
+        <tr>
+          <td class="error-level">
+              <span class="level level-{{ group.get_level_display }}">{{ group.get_level_display }}</span>
+          </td>
+          <td class="event-detail">
+            <div class="issue">
+              {% with type=event.get_event_type metadata=event.get_event_metadata transaction=event.transaction %}
+                {% if type == "error" %}
+                  <div class="event-type error">
+                    <h3>
+                      {% if metadata.type %}
+                        <a href="{% absolute_uri link %}">{{ metadata.type|truncatechars:40 }}</a>
+                        {% if transaction %}
+                          <em class="event-subtitle">{{ transaction }}</em>
+                        {% endif %}
+                        <br />
+                        {% if metadata.value %}
+                          <small>{{ metadata.value|truncatechars:100|soft_break:40 }}</small>
+                        {% endif %}
+                      {% else %}
+                        <a href="{% absolute_uri link %}">{{ metadata.value|truncatechars:40 }}</a><br />
+                        {% if transaction %}
+                          <em class="event-subtitle">{{ transaction }}</em>
+                        {% endif %}
+                      {% endif %}
+                    </h3>
+                  </div>
+                {% elif type == "csp" %}
+                  <div class="event-type csp">
+                    <h3>
+                      <a href="{% absolute_uri link %}">{{ metadata.directive|truncatechars:40 }}</a><br />
+                      {% if metadata.uri %}
+                        <em class="event-subtitle">{{ metadata.uri }}</em>
+                      {% endif %}
+                    </h3>
+                  </div>
+                {% else %}
+                  <div class="event-type default">
+                    <h3>
+                      <a href="{% absolute_uri link %}">{{ event.title|truncatechars:40 }}</a><br />
+                      {% if transaction %}
+                        <em class="event-subtitle">{{ transaction }}</em>
+                      {% endif %}
+                    </h3>
+                  </div>
+                {% endif %}
+              {% endwith %}
+            </div>
+          </td>
+        </tr>
+      </table>
+
       <div class="event">
         <div class="event-id">ID: {{ event.event_id }}</div>
         <div class="event-date">{{ event.datetime|date:"N j, Y, g:i:s a e" }}</div>
diff --git a/src/sentry/web/frontend/debug/mail.py b/src/sentry/web/frontend/debug/mail.py
index f55f6b97c3..b363491cdb 100644
--- a/src/sentry/web/frontend/debug/mail.py
+++ b/src/sentry/web/frontend/debug/mail.py
@@ -232,6 +232,7 @@ def alert(request):
 
     event = Event(
         id=1,
+        event_id='44f1419e73884cd2b45c79918f4b6dc4',
         project=project,
         group=group,
         message=group.message,
