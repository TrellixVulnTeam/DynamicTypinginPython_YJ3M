commit e1598f1748d299cafccb43c05bdbf661c0bb2f26
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 12 12:39:01 2017 -0800

    [events] allow control of sampling via feature flag (#4756)

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 30c09e3ea7..4a19ea516c 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -684,6 +684,7 @@ SENTRY_FEATURES = {
     'projects:global-events': False,
     'projects:plugins': True,
     'projects:dsym': False,
+    'projects:sample-events': True,
     'workflow:release-emails': False,
 }
 
diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index c774ec9b19..ca2c010b32 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -21,7 +21,7 @@ from django.utils.encoding import force_bytes, force_text
 from hashlib import md5
 from uuid import uuid4
 
-from sentry import eventtypes
+from sentry import eventtypes, features
 from sentry.app import buffer, tsdb
 from sentry.constants import (
     CLIENT_RESERVED_ATTRS, LOG_LEVELS, DEFAULT_LOGGER_NAME, MAX_CULPRIT_LENGTH
@@ -833,10 +833,13 @@ class EventManager(object):
 
         # XXX(dcramer): it's important this gets called **before** the aggregate
         # is processed as otherwise values like last_seen will get mutated
-        can_sample = should_sample(
-            event.data.get('received') or float(event.datetime.strftime('%s')),
-            group.data.get('last_received') or float(group.last_seen.strftime('%s')),
-            group.times_seen,
+        can_sample = (
+            features.has('projects:sample-events', project=project) and
+            should_sample(
+                event.data.get('received') or float(event.datetime.strftime('%s')),
+                group.data.get('last_received') or float(group.last_seen.strftime('%s')),
+                group.times_seen,
+            )
         )
 
         if not is_new:
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index fd224de840..96792d733f 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -16,6 +16,7 @@ default_manager.add('organizations:repos', OrganizationFeature)  # NOQA
 default_manager.add('projects:global-events', ProjectFeature)  # NOQA
 default_manager.add('projects:plugins', ProjectPluginFeature)  # NOQA
 default_manager.add('workflow:release-emails')
+default_manager.add('projects:sample-events', ProjectFeature)  # NOQA
 
 # expose public api
 add = default_manager.add
diff --git a/tests/sentry/test_event_manager.py b/tests/sentry/test_event_manager.py
index eb834e0adf..7f52a20a66 100644
--- a/tests/sentry/test_event_manager.py
+++ b/tests/sentry/test_event_manager.py
@@ -74,6 +74,20 @@ class EventManagerTest(TransactionTestCase):
             event_id=event_id,
         ).exists()
 
+    @patch('sentry.event_manager.should_sample')
+    def test_sample_feature_flag(self, should_sample):
+        should_sample.return_value = True
+
+        manager = EventManager(self.make_event())
+        with self.feature('projects:sample-events'):
+            event = manager.save(1)
+        assert event.id
+
+        manager = EventManager(self.make_event())
+        with self.feature('projects:sample-events', False):
+            event = manager.save(1)
+        assert not event.id
+
     def test_tags_as_list(self):
         manager = EventManager(self.make_event(tags=[('foo', 'bar')]))
         data = manager.normalize()
