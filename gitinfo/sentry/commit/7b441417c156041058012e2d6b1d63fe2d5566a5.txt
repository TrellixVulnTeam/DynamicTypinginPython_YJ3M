commit 7b441417c156041058012e2d6b1d63fe2d5566a5
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Tue Jun 26 10:53:39 2018 -0700

    Ensure integration installations recieve the project ID (#8846)
    
    Instead of relying on the project_id making it's way through the kwargs
    of the `model.Integration.get_installation`, specifically declare the
    `project_id` argument in the signature.

diff --git a/src/sentry/api/serializers/models/integration.py b/src/sentry/api/serializers/models/integration.py
index 876810e7f4..3b7a62c1e4 100644
--- a/src/sentry/api/serializers/models/integration.py
+++ b/src/sentry/api/serializers/models/integration.py
@@ -1,10 +1,14 @@
 from __future__ import absolute_import
 
-import six
 from collections import defaultdict
 
-from sentry.api.serializers import register, Serializer, serialize
-from sentry.models import ExternalIssue, GroupLink, Integration, OrganizationIntegration, ProjectIntegration
+import six
+
+from sentry.api.serializers import Serializer, register, serialize
+from sentry.models import (
+    ExternalIssue, GroupLink, Integration, OrganizationIntegration,
+    ProjectIntegration,
+)
 
 
 @register(Integration)
@@ -28,8 +32,9 @@ class IntegrationSerializer(Serializer):
 
 
 class IntegrationConfigSerializer(IntegrationSerializer):
-    def __init__(self, organization_id=None):
+    def __init__(self, organization_id=None, project_id=None):
         self.organization_id = organization_id
+        self.project_id = project_id
 
     def serialize(self, obj, attrs, user):
         data = super(IntegrationConfigSerializer, self).serialize(obj, attrs, user)
@@ -40,7 +45,10 @@ class IntegrationConfigSerializer(IntegrationSerializer):
         })
 
         try:
-            install = obj.get_installation(self.organization_id)
+            install = obj.get_installation(
+                organization_id=self.organization_id,
+                project_id=self.project_id,
+            )
         except NotImplementedError:
             # The integration may not implement a Installed Integration object
             # representation.
@@ -75,7 +83,7 @@ class OrganizationIntegrationSerializer(Serializer):
             } for i in item_list
         }
 
-    def serialize(self, obj, attrs, user, organization=None, project=None):
+    def serialize(self, obj, attrs, user):
         # XXX(epurkhiser): This is O(n) for integrations, especially since
         # we're using the IntegrationConfigSerializer which pulls in the
         # integration installation config object which very well may be making
@@ -95,8 +103,15 @@ class OrganizationIntegrationSerializer(Serializer):
 
 @register(ProjectIntegration)
 class ProjectIntegrationSerializer(Serializer):
-    def serialize(self, obj, attrs, user, organization=None, project=None):
-        integration = serialize(obj.integration, user, IntegrationConfigSerializer())
+    def serialize(self, obj, attrs, user):
+        integration = serialize(
+            objects=obj.integration,
+            user=user,
+            serializer=IntegrationConfigSerializer(
+                project_id=obj.project.id,
+                organization_id=obj.project.organization.id,
+            ),
+        )
         integration.update({
             'configData': obj.config,
         })
diff --git a/src/sentry/models/integration.py b/src/sentry/models/integration.py
index d181769667..fb8efe2370 100644
--- a/src/sentry/models/integration.py
+++ b/src/sentry/models/integration.py
@@ -69,8 +69,8 @@ class Integration(Model):
         from sentry import integrations
         return integrations.get(self.provider)
 
-    def get_installation(self, organization_id=None, **kwargs):
-        return self.get_provider().get_installation(self, organization_id, **kwargs)
+    def get_installation(self, organization_id=None, project_id=None, **kwargs):
+        return self.get_provider().get_installation(self, organization_id, project_id, **kwargs)
 
     def has_feature(self, feature):
         return feature in self.get_provider().features
