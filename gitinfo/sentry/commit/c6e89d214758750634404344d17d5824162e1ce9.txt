commit c6e89d214758750634404344d17d5824162e1ce9
Author: Stephen Cefali <scefali@sentry.io>
Date:   Tue May 12 11:40:43 2020 -0700

    adds JIRA_USE_EMAIL_SCOPE setting (#18769)

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 63ea30ff86..a4642fb9c4 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -1800,6 +1800,11 @@ KAFKA_TOPICS = {
     KAFKA_INGEST_TRANSACTIONS: {"cluster": "default", "topic": KAFKA_INGEST_TRANSACTIONS},
 }
 
+# For Jira, only approved apps can use the access_email_addresses scope
+# This scope allows Sentry to use the email endpoint (https://developer.atlassian.com/cloud/jira/platform/rest/v3/#api-rest-api-3-user-email-get)
+# We use the email with Jira 2-way sync in order to match the user
+JIRA_USE_EMAIL_SCOPE = False
+
 """
 Fields are:
  - south_app_name: Which app to apply the conversion to
diff --git a/src/sentry/integrations/jira/descriptor.py b/src/sentry/integrations/jira/descriptor.py
index 60cca6a5e3..f465bbc730 100644
--- a/src/sentry/integrations/jira/descriptor.py
+++ b/src/sentry/integrations/jira/descriptor.py
@@ -1,5 +1,6 @@
 from __future__ import absolute_import
 
+from django.conf import settings
 from django.core.urlresolvers import reverse
 
 from sentry.api.base import Endpoint
@@ -7,6 +8,13 @@ from sentry.utils.http import absolute_uri
 
 from .client import JIRA_KEY
 
+scopes = ["read", "write", "act_as_user"]
+# For Jira, only approved apps can use the access_email_addresses scope
+# This scope allows Sentry to use the email endpoint (https://developer.atlassian.com/cloud/jira/platform/rest/v3/#api-rest-api-3-user-email-get)
+# We use the email with Jira 2-way sync in order to match the user
+if settings.JIRA_USE_EMAIL_SCOPE:
+    scopes.append("access_email_addresses")
+
 
 class JiraDescriptorEndpoint(Endpoint):
     authentication_classes = ()
@@ -46,6 +54,6 @@ class JiraDescriptorEndpoint(Endpoint):
                     ],
                 },
                 "apiMigrations": {"gdpr": True},
-                "scopes": ["read", "write", "act_as_user"],
+                "scopes": scopes,
             }
         )
