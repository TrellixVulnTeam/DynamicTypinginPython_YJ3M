commit f436a7a646a383a684e022b37656f20fab794621
Author: mikellykels <kelly@getsentry.com>
Date:   Wed Jan 3 14:54:35 2018 -0800

    fix: Handle bitfield data (#6770)
    
    * fix: Handle bitfield data
    
    Handle copy of mutable data.
    
    * add test, refactor flag_has_changed
    
    * Explicitly handle bitfield data
    
    * Refactor _update_tracked_data

diff --git a/src/sentry/db/models/base.py b/src/sentry/db/models/base.py
index 5db61cc601..39f0b77655 100644
--- a/src/sentry/db/models/base.py
+++ b/src/sentry/db/models/base.py
@@ -8,9 +8,11 @@ sentry.db.models
 
 from __future__ import absolute_import
 
+from copy import copy
 import logging
 import six
 
+from bitfield.types import BitHandler
 from django.db import models
 from django.db.models import signals
 
@@ -74,10 +76,14 @@ class BaseModel(models.Model):
             data = {}
             for f in self._meta.fields:
                 try:
-                    data[f.column] = self.__get_field_value(f)
+                    v = self.__get_field_value(f)
                 except AttributeError as e:
                     # this case can come up from pickling
                     logging.exception(six.text_type(e))
+                else:
+                    if isinstance(v, BitHandler):
+                        v = copy(v)
+                    data[f.column] = v
             self.__data = data
         else:
             self.__data = UNSAVED
diff --git a/src/sentry/models/organization.py b/src/sentry/models/organization.py
index 88c5f80127..f5c29a2928 100644
--- a/src/sentry/models/organization.py
+++ b/src/sentry/models/organization.py
@@ -321,3 +321,7 @@ class Organization(Model):
             type='org.confirm_delete',
             context=context,
         ).send_async([o.email for o in owners])
+
+    def flag_has_changed(self, flag_name):
+        "Returns ``True`` if ``flag`` has changed since initialization."
+        return getattr(self.old_value('flags'), flag_name, None) != getattr(self.flags, flag_name)
diff --git a/tests/sentry/models/test_organization.py b/tests/sentry/models/test_organization.py
index 2f3ee6d5c7..a384c4d19c 100644
--- a/tests/sentry/models/test_organization.py
+++ b/tests/sentry/models/test_organization.py
@@ -127,3 +127,9 @@ class OrganizationTest(TestCase):
         user = self.create_user('foo@example.com')
         org = self.create_organization(owner=user)
         assert org.get_default_owner() == user
+
+    def test_flags_have_changed(self):
+        org = self.create_organization()
+        org.flags.early_adopter = True
+        assert org.flag_has_changed('early_adopter')
+        assert org.flag_has_changed('allow_joinleave') is False
