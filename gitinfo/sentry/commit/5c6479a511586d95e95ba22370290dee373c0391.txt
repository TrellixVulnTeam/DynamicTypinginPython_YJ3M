commit 5c6479a511586d95e95ba22370290dee373c0391
Author: jpellerin <jpellerin@gmail.com>
Date:   Thu Dec 16 12:28:39 2010 -0500

    Updated sentry.helpers.transform to handle lazy strings, such as those returned by django's gettext_lazy

diff --git a/sentry/helpers.py b/sentry/helpers.py
index 5ceb217a86..64fc9cc059 100644
--- a/sentry/helpers.py
+++ b/sentry/helpers.py
@@ -5,7 +5,7 @@ import uuid
 
 import django
 from django.conf import settings
-from django.utils.encoding import smart_unicode
+from django.utils.encoding import force_unicode
 from django.utils.hashcompat import md5_constructor
 
 from sentry import conf
@@ -69,24 +69,24 @@ def transform(value):
     elif isinstance(value, dict):
         return dict((k, transform(v)) for k, v in value.iteritems())
     elif isinstance(value, unicode):
-        return force_unicode(value)
+        return to_unicode(value)
     elif isinstance(value, str):
         try:
             return str(value)
         except:
-            return force_unicode(value)
+            return to_unicode(value)
     elif not isinstance(value, (int, bool)) and value is not None:
         # XXX: we could do transform(repr(value)) here
-        return force_unicode(value)
+        return to_unicode(value)
     return value
 
-def force_unicode(value):
+def to_unicode(value):
     try:
-        value = smart_unicode(value)
+        value = force_unicode(value)
     except (UnicodeEncodeError, UnicodeDecodeError):
         value = '(Error decoding value)'
     except Exception: # in some cases we get a different exception
-        value = smart_unicode(type(value))
+        value = force_unicode(type(value))
     return value
 
 def get_installed_apps():
diff --git a/sentry/tests/tests.py b/sentry/tests/tests.py
index 2795f7492a..114efd5844 100644
--- a/sentry/tests/tests.py
+++ b/sentry/tests/tests.py
@@ -24,7 +24,7 @@ from django.template import TemplateSyntaxError
 from django.utils.encoding import smart_unicode
 
 from sentry import conf
-from sentry.helpers import transform, force_unicode
+from sentry.helpers import transform
 from sentry.models import Message, GroupedMessage
 from sentry.client.base import SentryClient
 from sentry.client.handlers import SentryHandler
@@ -901,6 +901,18 @@ class SentryHelpersTest(TestCase):
         settings.DATABASES = _databases
         settings.DATABASE_ENGINE = _engine
 
+    def test_transform_handles_gettext_lazy(self):
+        from sentry.helpers import transform
+        from django.utils.functional import lazy
+
+        def fake_gettext(to_translate):
+            return u'Igpay Atinlay'
+        fake_gettext_lazy = lazy(fake_gettext, str)
+        self.assertEquals(
+            pickle.loads(pickle.dumps(
+                    transform(fake_gettext_lazy("something")))),
+            u'Igpay Atinlay')
+
 class SentryClientTest(TestCase):
     urls = 'sentry.tests.urls'
 
@@ -971,4 +983,4 @@ class SentryManageTest(TestCase):
         command = Command()
         command.handle(days=1)
         
-        self.assertEquals(Message.objects.count(), 0)
\ No newline at end of file
+        self.assertEquals(Message.objects.count(), 0)
