commit 702f7dcc47faf8cb6432fb2d0933c2141cb3d838
Author: Lauryn Brown <lauryndbrown@gmail.com>
Date:   Thu Oct 11 14:57:38 2018 -0700

    fix(integrations): Azure DevOps Subscription creation problem (#10094)
    
    * SENTRY-768
    
    * Rearranged exception handling.

diff --git a/src/sentry/integrations/vsts/integration.py b/src/sentry/integrations/vsts/integration.py
index 22b2e2bf7f..1ef296c317 100644
--- a/src/sentry/integrations/vsts/integration.py
+++ b/src/sentry/integrations/vsts/integration.py
@@ -378,14 +378,15 @@ class VstsIntegrationProvider(IntegrationProvider):
                 external_id=account['accountId'],
                 status=ObjectStatus.VISIBLE,
             )
-            assert 'subscription' in integration_model.metadata
+            # preserve previously created subscription information
+            integration['metadata']['subscription'] = integration_model.metadata['subscription']
 
             assert OrganizationIntegration.objects.filter(
                 integration_id=integration_model.id,
                 status=ObjectStatus.VISIBLE,
             ).exists()
 
-        except (IntegrationModel.DoesNotExist, AssertionError):
+        except (IntegrationModel.DoesNotExist, AssertionError, KeyError):
             subscription_id, subscription_secret = self.create_subscription(
                 base_url, account['accountId'], oauth_data)
             integration['metadata']['subscription'] = {
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index 927e8c8700..101547ff4c 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -188,7 +188,9 @@ class VstsIntegrationProviderTest(VstsIntegrationTestCase):
         # The above already created the Webhook, so subsequent calls to
         # ``build_integration`` should omit that data.
         data = VstsIntegrationProvider().build_integration(state)
-        assert 'subscription' not in data['metadata']
+        assert 'subscription' in data['metadata']
+        assert Integration.objects.get(
+            provider='vsts').metadata['subscription'] == data['metadata']['subscription']
 
     def test_fix_subscription(self):
         external_id = '1234567890'
