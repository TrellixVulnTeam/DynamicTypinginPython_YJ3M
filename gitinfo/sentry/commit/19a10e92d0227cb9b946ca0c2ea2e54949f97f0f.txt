commit 19a10e92d0227cb9b946ca0c2ea2e54949f97f0f
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Aug 28 09:42:47 2017 -0700

    admin: improve user merge
    
    - prioritize active accounts
    - merge authenticators

diff --git a/src/sentry/management/commands/merge_users.py b/src/sentry/management/commands/merge_users.py
index d97d6a341c..053f8b7779 100644
--- a/src/sentry/management/commands/merge_users.py
+++ b/src/sentry/management/commands/merge_users.py
@@ -97,7 +97,12 @@ class Command(BaseCommand):
         )
 
         for user_list in unique_users:
-            user_list.sort(key=lambda x: (x.is_superuser, not x.is_managed, x.date_joined))
+            user_list.sort(
+                key=lambda x: (
+                    x.is_active,
+                    x.is_superuser,
+                    not x.is_managed,
+                    x.date_joined))
 
             primary_user = user_list[0]
             if not noinput and not self._confirm_merge(primary_user, user_list[1:]):
diff --git a/src/sentry/models/user.py b/src/sentry/models/user.py
index dbc9cccafd..a63dae65e4 100644
--- a/src/sentry/models/user.py
+++ b/src/sentry/models/user.py
@@ -182,7 +182,7 @@ class User(BaseModel, AbstractBaseUser):
         # TODO: we could discover relations automatically and make this useful
         from sentry import roles
         from sentry.models import (
-            AuditLogEntry, Activity, AuthIdentity, GroupAssignee, GroupBookmark, GroupSeen,
+            Activity, AuditLogEntry, AuthIdentity, Authenticator, GroupAssignee, GroupBookmark, GroupSeen,
             GroupSubscription, OrganizationMember, OrganizationMemberTeam, UserAvatar, UserEmail,
             UserOption
         )
@@ -220,7 +220,7 @@ class User(BaseModel, AbstractBaseUser):
                     pass
 
         model_list = (
-            GroupAssignee, GroupBookmark, GroupSeen, GroupSubscription, UserAvatar, UserEmail,
+            Authenticator, GroupAssignee, GroupBookmark, GroupSeen, GroupSubscription, UserAvatar, UserEmail,
             UserOption
         )
 
diff --git a/tests/sentry/models/test_user.py b/tests/sentry/models/test_user.py
index a2e8b10ba7..4bac29d694 100644
--- a/tests/sentry/models/test_user.py
+++ b/tests/sentry/models/test_user.py
@@ -1,6 +1,6 @@
 from __future__ import absolute_import
 
-from sentry.models import OrganizationMember, UserEmail
+from sentry.models import Authenticator, OrganizationMember, UserEmail
 from sentry.testutils import TestCase
 
 
@@ -18,6 +18,10 @@ class UserMergeToTest(TestCase):
                 'is_verified': True,
             }
         )
+        auth1 = Authenticator.objects.create(user=from_user, type=1)
+        auth2 = Authenticator.objects.create(user=to_user, type=1)
+        auth3 = Authenticator.objects.create(user=to_user, type=2)
+
         from_user.merge_to(to_user)
 
         assert UserEmail.objects.filter(
@@ -32,6 +36,20 @@ class UserMergeToTest(TestCase):
             is_verified=True,
         ).exists()
 
+        assert Authenticator.objects.filter(
+            user=to_user,
+            id=auth2.id,
+        ).exists()
+        assert Authenticator.objects.filter(
+            user=to_user,
+            id=auth3.id,
+        ).exists()
+        # dupe shouldn't get merged
+        assert Authenticator.objects.filter(
+            user=from_user,
+            id=auth1.id,
+        ).exists()
+
     def test_duplicate_memberships(self):
         from_user = self.create_user('foo@example.com')
         to_user = self.create_user('bar@example.com')
