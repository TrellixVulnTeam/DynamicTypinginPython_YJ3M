commit 35396d98c4e2a724bbb6c7ffa195997b9444038d
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Wed Feb 7 13:09:17 2018 -0800

    ref: Refactor alert rules (#7157)

diff --git a/src/sentry/static/sentry/app/views/ruleEditor/index.jsx b/src/sentry/static/sentry/app/views/ruleEditor/index.jsx
index b171a9facd..93f30b3c16 100644
--- a/src/sentry/static/sentry/app/views/ruleEditor/index.jsx
+++ b/src/sentry/static/sentry/app/views/ruleEditor/index.jsx
@@ -4,13 +4,34 @@ import createReactClass from 'create-react-class';
 import ReactDOM from 'react-dom';
 import {browserHistory} from 'react-router';
 import $ from 'jquery';
+import styled from 'react-emotion';
+
 import ApiMixin from '../../mixins/apiMixin';
 import IndicatorStore from '../../stores/indicatorStore';
-import SelectInput from '../../components/selectInput';
-import {t, tct} from '../../locale';
+import {Select2Field} from '../../components/forms';
+import {t} from '../../locale';
 import LoadingIndicator from '../../components/loadingIndicator';
 import RuleNodeList from './ruleNodeList';
 
+const FREQUENCY_CHOICES = [
+  ['5', t('5 minutes')],
+  ['10', t('10 minutes')],
+  ['30', t('30 minutes')],
+  ['60', t('60 minutes')],
+  ['180', t('3 hours')],
+  ['720', t('12 hours')],
+  ['1440', t('24 hours')],
+  ['10080', t('one week')],
+  ['43200', t('30 days')],
+];
+
+const ACTION_MATCH_CHOICES = [['all', t('all')], ['any', t('any')], ['none', t('none')]];
+
+const AlertRuleRow = styled('h6')`
+  display: flex;
+  align-items: center;
+`;
+
 const RuleEditor = createReactClass({
   displayName: 'RuleEditor',
 
@@ -89,16 +110,8 @@ const RuleEditor = createReactClass({
     form.find('.rule-action-list .rule-form').each((_, el) => {
       actions.push(this.serializeNode(el));
     });
-    let actionMatch = $(ReactDOM.findDOMNode(this.refs.actionMatch)).val();
-    let frequency = $(ReactDOM.findDOMNode(this.refs.frequency)).val();
-    let name = $(ReactDOM.findDOMNode(this.refs.name)).val();
-    let data = {
-      actionMatch,
-      actions,
-      conditions,
-      frequency,
-      name,
-    };
+    let data = {...this.state.rule, actions, conditions};
+
     let rule = this.state.rule;
     let project = this.props.project;
     let org = this.props.organization;
@@ -136,6 +149,14 @@ const RuleEditor = createReactClass({
     return !!error[field];
   },
 
+  handleChange(prop, val) {
+    this.setState(state => {
+      let rule = {...state.rule};
+      rule[prop] = val;
+      return {rule};
+    });
+  },
+
   render() {
     if (!this.state.rule) return <LoadingIndicator />;
 
@@ -162,34 +183,32 @@ const RuleEditor = createReactClass({
             <h6>{t('Rule name')}:</h6>
             <div className="control-group">
               <input
-                ref="name"
                 type="text"
                 className="form-control"
                 defaultValue={name}
                 required={true}
                 placeholder={t('My Rule Name')}
+                onChange={e => this.handleChange('name', e.target.value)}
               />
             </div>
 
             <hr />
 
             <div className="node-match-selector">
-              <h6>
+              <AlertRuleRow>
                 {t(
                   'Every time %s of these conditions are met:',
-                  <SelectInput
-                    ref="actionMatch"
+                  <Select2Field
                     className={this.hasError('actionMatch') ? ' error' : ''}
+                    style={{marginBottom: 0, marginLeft: 5, marginRight: 5}}
+                    name="actionMatch"
                     value={actionMatch}
-                    style={{width: 80}}
                     required={true}
-                  >
-                    <option value="all">{t('all')}</option>
-                    <option value="any">{t('any')}</option>
-                    <option value="none">{t('none')}</option>
-                  </SelectInput>
+                    choices={ACTION_MATCH_CHOICES}
+                    onChange={val => this.handleChange('actionMatch', val)}
+                  />
                 )}
-              </h6>
+              </AlertRuleRow>
             </div>
 
             {this.hasError('conditions') && (
@@ -200,7 +219,6 @@ const RuleEditor = createReactClass({
               nodes={this.props.conditions}
               initialItems={conditions}
               className="rule-condition-list"
-              onChange={this.onConditionsChange}
             />
 
             <hr />
@@ -215,38 +233,25 @@ const RuleEditor = createReactClass({
               nodes={this.props.actions}
               initialItems={actions}
               className="rule-action-list"
-              onChange={this.onActionsChange}
             />
 
             <hr />
 
             <div className="node-frequency-selector">
-              <h6>
-                {tct(
-                  'Perform these actions at most once every [frequency] for an issue.',
-                  {
-                    frequency: (
-                      <SelectInput
-                        ref="frequency"
-                        className={this.hasError('frequency') ? ' error' : ''}
-                        value={frequency}
-                        style={{width: 150}}
-                        required={true}
-                      >
-                        <option value="5">{t('5 minutes')}</option>
-                        <option value="10">{t('10 minutes')}</option>
-                        <option value="30">{t('30 minutes')}</option>
-                        <option value="60">{t('60 minutes')}</option>
-                        <option value="180">{t('3 hours')}</option>
-                        <option value="720">{t('12 hours')}</option>
-                        <option value="1440">{t('24 hours')}</option>
-                        <option value="10080">{t('one week')}</option>
-                        <option value="43200">{t('30 days')}</option>
-                      </SelectInput>
-                    ),
-                  }
+              <AlertRuleRow>
+                {t(
+                  'Perform these actions at most once every %s for an issue.',
+                  <Select2Field
+                    name="frequency"
+                    className={this.hasError('frequency') ? ' error' : ''}
+                    value={frequency}
+                    style={{marginBottom: 0, marginLeft: 5, marginRight: 5, width: 140}}
+                    required={true}
+                    choices={FREQUENCY_CHOICES}
+                    onChange={val => this.handleChange('frequency', val)}
+                  />
                 )}
-              </h6>
+              </AlertRuleRow>
             </div>
 
             <div className="actions">
diff --git a/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
index ccb377b531..0cff2384f1 100644
--- a/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
@@ -1,6 +1,17 @@
 // Jest Snapshot v1, https://goo.gl/fbAQLP
 
 exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
+.glamor-0 {
+  display: -webkit-box;
+  display: -webkit-flex;
+  display: -ms-flexbox;
+  display: flex;
+  -webkit-align-items: center;
+  -webkit-box-align: center;
+  -ms-flex-align: center;
+  align-items: center;
+}
+
 <ProjectAlertRuleDetails
   params={
     Object {
@@ -102,6 +113,7 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
                 <input
                   className="form-control"
                   defaultValue=""
+                  onChange={[Function]}
                   placeholder="My Rule Name"
                   required={true}
                   type="text"
@@ -111,56 +123,97 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
               <div
                 className="node-match-selector"
               >
-                <h6>
-                  Every time 
-                  <SelectInput
-                    className=""
-                    disabled={false}
-                    key="1"
-                    multiple={false}
-                    onChange={[Function]}
-                    placeholder="Select an option..."
-                    required={true}
-                    style={
-                      Object {
-                        "width": 80,
-                      }
-                    }
-                    value="all"
+                <AlertRuleRow>
+                  <h6
+                    className="glamor-0 glamor-1"
                   >
-                    <select
+                    Every time 
+                    <Select2Field
+                      allowClear={false}
+                      allowEmpty={false}
+                      choices={
+                        Array [
+                          Array [
+                            "all",
+                            "all",
+                          ],
+                          Array [
+                            "any",
+                            "any",
+                          ],
+                          Array [
+                            "none",
+                            "none",
+                          ],
+                        ]
+                      }
                       className=""
                       disabled={false}
+                      escapeMarkup={true}
+                      hideErrorMessage={false}
+                      key="1"
                       multiple={false}
+                      name="actionMatch"
                       onChange={[Function]}
-                      placeholder="Select an option..."
+                      placeholder="--"
                       required={true}
                       style={
                         Object {
-                          "width": 80,
+                          "marginBottom": 0,
+                          "marginLeft": 5,
+                          "marginRight": 5,
                         }
                       }
                       value="all"
                     >
-                      <option
-                        value="all"
-                      >
-                        all
-                      </option>
-                      <option
-                        value="any"
-                      >
-                        any
-                      </option>
-                      <option
-                        value="none"
+                      <div
+                        className="control-group required"
+                        style={
+                          Object {
+                            "marginBottom": 0,
+                            "marginLeft": 5,
+                            "marginRight": 5,
+                          }
+                        }
                       >
-                        none
-                      </option>
-                    </select>
-                  </SelectInput>
-                   of these conditions are met:
-                </h6>
+                        <div
+                          className="controls"
+                        >
+                          <select
+                            className="form-control"
+                            disabled={false}
+                            id="id-actionMatch"
+                            multiple={false}
+                            onChange={[Function]}
+                            placeholder="--"
+                            required={true}
+                            value="all"
+                          >
+                            <option
+                              key="all"
+                              value="all"
+                            >
+                              all
+                            </option>
+                            <option
+                              key="any"
+                              value="any"
+                            >
+                              any
+                            </option>
+                            <option
+                              key="none"
+                              value="none"
+                            >
+                              none
+                            </option>
+                          </select>
+                        </div>
+                      </div>
+                    </Select2Field>
+                     of these conditions are met:
+                  </h6>
+                </AlertRuleRow>
               </div>
               <RuleNodeList
                 className="rule-condition-list"
@@ -308,98 +361,159 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
               <div
                 className="node-frequency-selector"
               >
-                <h6>
-                  <span
-                    key="4"
+                <AlertRuleRow>
+                  <h6
+                    className="glamor-0 glamor-1"
                   >
-                    <span
-                      key="0"
-                    >
-                      Perform these actions at most once every 
-                    </span>
-                    <SelectInput
+                    Perform these actions at most once every 
+                    <Select2Field
+                      allowClear={false}
+                      allowEmpty={false}
+                      choices={
+                        Array [
+                          Array [
+                            "5",
+                            "5 minutes",
+                          ],
+                          Array [
+                            "10",
+                            "10 minutes",
+                          ],
+                          Array [
+                            "30",
+                            "30 minutes",
+                          ],
+                          Array [
+                            "60",
+                            "60 minutes",
+                          ],
+                          Array [
+                            "180",
+                            "3 hours",
+                          ],
+                          Array [
+                            "720",
+                            "12 hours",
+                          ],
+                          Array [
+                            "1440",
+                            "24 hours",
+                          ],
+                          Array [
+                            "10080",
+                            "one week",
+                          ],
+                          Array [
+                            "43200",
+                            "30 days",
+                          ],
+                        ]
+                      }
                       className=""
                       disabled={false}
+                      escapeMarkup={true}
+                      hideErrorMessage={false}
                       key="1"
                       multiple={false}
+                      name="frequency"
                       onChange={[Function]}
-                      placeholder="Select an option..."
+                      placeholder="--"
                       required={true}
                       style={
                         Object {
-                          "width": 150,
+                          "marginBottom": 0,
+                          "marginLeft": 5,
+                          "marginRight": 5,
+                          "width": 140,
                         }
                       }
                       value={30}
                     >
-                      <select
-                        className=""
-                        disabled={false}
-                        multiple={false}
-                        onChange={[Function]}
-                        placeholder="Select an option..."
-                        required={true}
+                      <div
+                        className="control-group required"
                         style={
                           Object {
-                            "width": 150,
+                            "marginBottom": 0,
+                            "marginLeft": 5,
+                            "marginRight": 5,
+                            "width": 140,
                           }
                         }
-                        value={30}
                       >
-                        <option
-                          value="5"
+                        <div
+                          className="controls"
                         >
-                          5 minutes
-                        </option>
-                        <option
-                          value="10"
-                        >
-                          10 minutes
-                        </option>
-                        <option
-                          value="30"
-                        >
-                          30 minutes
-                        </option>
-                        <option
-                          value="60"
-                        >
-                          60 minutes
-                        </option>
-                        <option
-                          value="180"
-                        >
-                          3 hours
-                        </option>
-                        <option
-                          value="720"
-                        >
-                          12 hours
-                        </option>
-                        <option
-                          value="1440"
-                        >
-                          24 hours
-                        </option>
-                        <option
-                          value="10080"
-                        >
-                          one week
-                        </option>
-                        <option
-                          value="43200"
-                        >
-                          30 days
-                        </option>
-                      </select>
-                    </SelectInput>
-                    <span
-                      key="2"
-                    >
-                       for an issue.
-                    </span>
-                  </span>
-                </h6>
+                          <select
+                            className="form-control"
+                            disabled={false}
+                            id="id-frequency"
+                            multiple={false}
+                            onChange={[Function]}
+                            placeholder="--"
+                            required={true}
+                            value={30}
+                          >
+                            <option
+                              key="5"
+                              value="5"
+                            >
+                              5 minutes
+                            </option>
+                            <option
+                              key="10"
+                              value="10"
+                            >
+                              10 minutes
+                            </option>
+                            <option
+                              key="30"
+                              value="30"
+                            >
+                              30 minutes
+                            </option>
+                            <option
+                              key="60"
+                              value="60"
+                            >
+                              60 minutes
+                            </option>
+                            <option
+                              key="180"
+                              value="180"
+                            >
+                              3 hours
+                            </option>
+                            <option
+                              key="720"
+                              value="720"
+                            >
+                              12 hours
+                            </option>
+                            <option
+                              key="1440"
+                              value="1440"
+                            >
+                              24 hours
+                            </option>
+                            <option
+                              key="10080"
+                              value="10080"
+                            >
+                              one week
+                            </option>
+                            <option
+                              key="43200"
+                              value="43200"
+                            >
+                              30 days
+                            </option>
+                          </select>
+                        </div>
+                      </div>
+                    </Select2Field>
+                     for an issue.
+                  </h6>
+                </AlertRuleRow>
               </div>
               <div
                 className="actions"
@@ -421,6 +535,17 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
 `;
 
 exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
+.glamor-0 {
+  display: -webkit-box;
+  display: -webkit-flex;
+  display: -ms-flexbox;
+  display: flex;
+  -webkit-align-items: center;
+  -webkit-box-align: center;
+  -ms-flex-align: center;
+  align-items: center;
+}
+
 <ProjectAlertRuleDetails
   params={
     Object {
@@ -522,6 +647,7 @@ exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
                 <input
                   className="form-control"
                   defaultValue=""
+                  onChange={[Function]}
                   placeholder="My Rule Name"
                   required={true}
                   type="text"
@@ -531,56 +657,97 @@ exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
               <div
                 className="node-match-selector"
               >
-                <h6>
-                  Every time 
-                  <SelectInput
-                    className=""
-                    disabled={false}
-                    key="1"
-                    multiple={false}
-                    onChange={[Function]}
-                    placeholder="Select an option..."
-                    required={true}
-                    style={
-                      Object {
-                        "width": 80,
-                      }
-                    }
-                    value="all"
+                <AlertRuleRow>
+                  <h6
+                    className="glamor-0 glamor-1"
                   >
-                    <select
+                    Every time 
+                    <Select2Field
+                      allowClear={false}
+                      allowEmpty={false}
+                      choices={
+                        Array [
+                          Array [
+                            "all",
+                            "all",
+                          ],
+                          Array [
+                            "any",
+                            "any",
+                          ],
+                          Array [
+                            "none",
+                            "none",
+                          ],
+                        ]
+                      }
                       className=""
                       disabled={false}
+                      escapeMarkup={true}
+                      hideErrorMessage={false}
+                      key="1"
                       multiple={false}
+                      name="actionMatch"
                       onChange={[Function]}
-                      placeholder="Select an option..."
+                      placeholder="--"
                       required={true}
                       style={
                         Object {
-                          "width": 80,
+                          "marginBottom": 0,
+                          "marginLeft": 5,
+                          "marginRight": 5,
                         }
                       }
                       value="all"
                     >
-                      <option
-                        value="all"
-                      >
-                        all
-                      </option>
-                      <option
-                        value="any"
-                      >
-                        any
-                      </option>
-                      <option
-                        value="none"
+                      <div
+                        className="control-group required"
+                        style={
+                          Object {
+                            "marginBottom": 0,
+                            "marginLeft": 5,
+                            "marginRight": 5,
+                          }
+                        }
                       >
-                        none
-                      </option>
-                    </select>
-                  </SelectInput>
-                   of these conditions are met:
-                </h6>
+                        <div
+                          className="controls"
+                        >
+                          <select
+                            className="form-control"
+                            disabled={false}
+                            id="id-actionMatch"
+                            multiple={false}
+                            onChange={[Function]}
+                            placeholder="--"
+                            required={true}
+                            value="all"
+                          >
+                            <option
+                              key="all"
+                              value="all"
+                            >
+                              all
+                            </option>
+                            <option
+                              key="any"
+                              value="any"
+                            >
+                              any
+                            </option>
+                            <option
+                              key="none"
+                              value="none"
+                            >
+                              none
+                            </option>
+                          </select>
+                        </div>
+                      </div>
+                    </Select2Field>
+                     of these conditions are met:
+                  </h6>
+                </AlertRuleRow>
               </div>
               <RuleNodeList
                 className="rule-condition-list"
@@ -728,98 +895,159 @@ exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
               <div
                 className="node-frequency-selector"
               >
-                <h6>
-                  <span
-                    key="4"
+                <AlertRuleRow>
+                  <h6
+                    className="glamor-0 glamor-1"
                   >
-                    <span
-                      key="0"
-                    >
-                      Perform these actions at most once every 
-                    </span>
-                    <SelectInput
+                    Perform these actions at most once every 
+                    <Select2Field
+                      allowClear={false}
+                      allowEmpty={false}
+                      choices={
+                        Array [
+                          Array [
+                            "5",
+                            "5 minutes",
+                          ],
+                          Array [
+                            "10",
+                            "10 minutes",
+                          ],
+                          Array [
+                            "30",
+                            "30 minutes",
+                          ],
+                          Array [
+                            "60",
+                            "60 minutes",
+                          ],
+                          Array [
+                            "180",
+                            "3 hours",
+                          ],
+                          Array [
+                            "720",
+                            "12 hours",
+                          ],
+                          Array [
+                            "1440",
+                            "24 hours",
+                          ],
+                          Array [
+                            "10080",
+                            "one week",
+                          ],
+                          Array [
+                            "43200",
+                            "30 days",
+                          ],
+                        ]
+                      }
                       className=""
                       disabled={false}
+                      escapeMarkup={true}
+                      hideErrorMessage={false}
                       key="1"
                       multiple={false}
+                      name="frequency"
                       onChange={[Function]}
-                      placeholder="Select an option..."
+                      placeholder="--"
                       required={true}
                       style={
                         Object {
-                          "width": 150,
+                          "marginBottom": 0,
+                          "marginLeft": 5,
+                          "marginRight": 5,
+                          "width": 140,
                         }
                       }
                       value={30}
                     >
-                      <select
-                        className=""
-                        disabled={false}
-                        multiple={false}
-                        onChange={[Function]}
-                        placeholder="Select an option..."
-                        required={true}
+                      <div
+                        className="control-group required"
                         style={
                           Object {
-                            "width": 150,
+                            "marginBottom": 0,
+                            "marginLeft": 5,
+                            "marginRight": 5,
+                            "width": 140,
                           }
                         }
-                        value={30}
                       >
-                        <option
-                          value="5"
+                        <div
+                          className="controls"
                         >
-                          5 minutes
-                        </option>
-                        <option
-                          value="10"
-                        >
-                          10 minutes
-                        </option>
-                        <option
-                          value="30"
-                        >
-                          30 minutes
-                        </option>
-                        <option
-                          value="60"
-                        >
-                          60 minutes
-                        </option>
-                        <option
-                          value="180"
-                        >
-                          3 hours
-                        </option>
-                        <option
-                          value="720"
-                        >
-                          12 hours
-                        </option>
-                        <option
-                          value="1440"
-                        >
-                          24 hours
-                        </option>
-                        <option
-                          value="10080"
-                        >
-                          one week
-                        </option>
-                        <option
-                          value="43200"
-                        >
-                          30 days
-                        </option>
-                      </select>
-                    </SelectInput>
-                    <span
-                      key="2"
-                    >
-                       for an issue.
-                    </span>
-                  </span>
-                </h6>
+                          <select
+                            className="form-control"
+                            disabled={false}
+                            id="id-frequency"
+                            multiple={false}
+                            onChange={[Function]}
+                            placeholder="--"
+                            required={true}
+                            value={30}
+                          >
+                            <option
+                              key="5"
+                              value="5"
+                            >
+                              5 minutes
+                            </option>
+                            <option
+                              key="10"
+                              value="10"
+                            >
+                              10 minutes
+                            </option>
+                            <option
+                              key="30"
+                              value="30"
+                            >
+                              30 minutes
+                            </option>
+                            <option
+                              key="60"
+                              value="60"
+                            >
+                              60 minutes
+                            </option>
+                            <option
+                              key="180"
+                              value="180"
+                            >
+                              3 hours
+                            </option>
+                            <option
+                              key="720"
+                              value="720"
+                            >
+                              12 hours
+                            </option>
+                            <option
+                              key="1440"
+                              value="1440"
+                            >
+                              24 hours
+                            </option>
+                            <option
+                              key="10080"
+                              value="10080"
+                            >
+                              one week
+                            </option>
+                            <option
+                              key="43200"
+                              value="43200"
+                            >
+                              30 days
+                            </option>
+                          </select>
+                        </div>
+                      </div>
+                    </Select2Field>
+                     for an issue.
+                  </h6>
+                </AlertRuleRow>
               </div>
               <div
                 className="actions"
diff --git a/tests/js/spec/views/projectAlertRuleDetails.spec.jsx b/tests/js/spec/views/projectAlertRuleDetails.spec.jsx
index 3dc5c013b9..a23ac4bfa6 100644
--- a/tests/js/spec/views/projectAlertRuleDetails.spec.jsx
+++ b/tests/js/spec/views/projectAlertRuleDetails.spec.jsx
@@ -57,7 +57,7 @@ describe('ProjectAlertRuleDetails', function() {
     });
 
     it('sets defaults', function() {
-      let selects = wrapper.find('select');
+      let selects = wrapper.find('Select2Field');
       expect(selects.first().props().value).toBe('all');
       expect(selects.last().props().value).toBe(30);
     });
