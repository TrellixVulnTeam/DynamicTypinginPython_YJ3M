commit e7f0a10eab1485b0905e550ff2410a7fdf83133d
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Oct 15 17:49:27 2013 +0100

    Support headers on MessageBuilder

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index e0a551f7fc..e4159b03dc 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -34,7 +34,7 @@ class MailPlugin(NotificationPlugin):
     subject_prefix = settings.EMAIL_SUBJECT_PREFIX
 
     def _send_mail(self, subject, body, html_body=None, project=None,
-                   fail_silently=False):
+                   headers=None, fail_silently=False):
         send_to = self.get_send_to(project)
         if not send_to:
             return
@@ -45,6 +45,7 @@ class MailPlugin(NotificationPlugin):
             subject='%s%s' % (subject_prefix, subject),
             body=body,
             html_body=html_body,
+            headers=headers,
         )
         msg.send(send_to, fail_silently=fail_silently)
 
diff --git a/src/sentry/utils/email.py b/src/sentry/utils/email.py
index f2de2bd530..6062fb97ba 100644
--- a/src/sentry/utils/email.py
+++ b/src/sentry/utils/email.py
@@ -16,7 +16,7 @@ from sentry.web.helpers import render_to_string
 
 class MessageBuilder(object):
     def __init__(self, subject, context=None, template=None, html_template=None,
-                 body=None, html_body=None):
+                 body=None, html_body=None, headers=None):
         assert not (body and template)
         assert not (html_body and html_template)
         assert context or not (template or html_template)
@@ -27,8 +27,14 @@ class MessageBuilder(object):
         self.html_template = html_template
         self.body = body
         self.html_body = html_body
+        self.headers = headers
 
     def build(self, to):
+        if self.headers is None:
+            headers = {}
+        else:
+            headers = self.headers.copy()
+
         headers = {
             'Reply-To': ', '.join(to),
         }
