commit 2b2b121b581393531f0ad44ee98e04ff7070ad76
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Apr 24 14:32:45 2020 -0700

    fix(search): Dont create an empty "query" param
    
    This ensures we're not passing an invalid 'query=[]' token to upstream users, which would commonly treat this as 'find something with a blank string' and exclude searches that might have been operating on NULL columns.

diff --git a/src/sentry/search/utils.py b/src/sentry/search/utils.py
index ecfe538d8a..b314a5a31c 100644
--- a/src/sentry/search/utils.py
+++ b/src/sentry/search/utils.py
@@ -331,7 +331,8 @@ def tokenize_query(query):
                 break
         query_params[state].append(token)
 
-    result["query"] = map(format_query, query_params["query"])
+    if "query" in query_params:
+        result["query"] = map(format_query, query_params["query"])
     for tag in query_params["tags"]:
         key, value = format_tag(tag)
         result[key].append(value)
diff --git a/tests/sentry/search/test_utils.py b/tests/sentry/search/test_utils.py
index 2b75858614..47320c5425 100644
--- a/tests/sentry/search/test_utils.py
+++ b/tests/sentry/search/test_utils.py
@@ -21,6 +21,7 @@ from sentry.search.utils import (
     get_latest_release,
     get_numeric_field_value,
     convert_user_tag_to_query,
+    tokenize_query,
     InvalidQuery,
 )
 
@@ -47,6 +48,10 @@ def test_get_numeric_field_value():
     }
 
 
+def test_tokenize_query_only_keyed_fields():
+    assert tokenize_query("foo:bar") == {"foo": ["bar"]}
+
+
 def test_get_numeric_field_value_invalid():
     with pytest.raises(InvalidQuery):
         get_numeric_field_value("foo", ">=1k")
