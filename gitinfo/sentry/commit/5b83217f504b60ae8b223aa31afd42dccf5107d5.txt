commit 5b83217f504b60ae8b223aa31afd42dccf5107d5
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Feb 24 04:35:50 2012 -0800

    DSN should respect SENTRY_URL_PREFIX, deprecate domain arg

diff --git a/sentry/models.py b/sentry/models.py
index 58a3023ac8..d69f61e8df 100644
--- a/sentry/models.py
+++ b/sentry/models.py
@@ -203,12 +203,13 @@ class ProjectMember(Model):
     def generate_api_key(cls):
         return uuid.uuid4().hex
 
-    def get_dsn(self, domain, secure=True):
+    def get_dsn(self, domain=None, secure=True):
+        urlparts = urlparse.urlparse(settings.SENTRY_URL_PREFIX)
         return 'http%s://%s:%s@%s/%s' % (
-            secure and 's' or '',
+            urlparts.scheme,
             self.public_key,
             self.secret_key,
-            domain,
+            urlparts.domain,
             self.project_id,
         )
 
diff --git a/sentry/web/frontend/admin.py b/sentry/web/frontend/admin.py
index ef0d932c95..2c4e4e969e 100644
--- a/sentry/web/frontend/admin.py
+++ b/sentry/web/frontend/admin.py
@@ -113,7 +113,7 @@ def create_new_user(request):
                 context.update({
                     'project': project,
                     'member': member,
-                    'dsn': member.get_dsn(request.get_host(), secure=request.is_secure()),
+                    'dsn': member.get_dsn(),
                 })
             body = render_to_string('sentry/emails/welcome_mail.txt', context, request)
 
diff --git a/sentry/web/frontend/projects.py b/sentry/web/frontend/projects.py
index 6d62250162..ff7dcab416 100644
--- a/sentry/web/frontend/projects.py
+++ b/sentry/web/frontend/projects.py
@@ -43,7 +43,7 @@ def project_list(request):
 
     for member in memberships:
         project_id = member.project_id
-        project_list[project_id].member_dsn = member.get_dsn(request.get_host(), secure=request.is_secure())
+        project_list[project_id].member_dsn = member.get_dsn()
         project_list[project_id].member_type = member.get_type_display()
 
     return render_to_response('sentry/projects/list.html', {
@@ -195,7 +195,7 @@ def edit_project_member(request, project, member_id):
         'member': member,
         'project': project,
         'form': form,
-        'dsn': member.get_dsn(request.get_host(), secure=request.is_secure()),
+        'dsn': member.get_dsn(),
     })
 
     return render_to_response('sentry/projects/members/edit.html', context, request)
