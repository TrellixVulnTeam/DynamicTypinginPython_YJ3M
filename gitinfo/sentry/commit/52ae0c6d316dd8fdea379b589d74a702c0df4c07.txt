commit 52ae0c6d316dd8fdea379b589d74a702c0df4c07
Author: Alex Hofsteede <alex@hofsteede.com>
Date:   Mon Apr 2 15:23:12 2018 -0700

    fix(security) Do not allow a user to demote her superiors. (#7885)
    
    A role assignment can only happen if the destination role *and* the
    source user are in the allowed_roles list

diff --git a/src/sentry/api/endpoints/organization_member_details.py b/src/sentry/api/endpoints/organization_member_details.py
index cae627c438..e0580335de 100644
--- a/src/sentry/api/endpoints/organization_member_details.py
+++ b/src/sentry/api/endpoints/organization_member_details.py
@@ -196,10 +196,17 @@ class OrganizationMemberDetailsEndpoint(OrganizationEndpoint):
 
         if result.get('role'):
             _, allowed_roles = get_allowed_roles(request, organization)
-            if not result['role'] in {r.id for r in allowed_roles}:
+            allowed_role_ids = {r.id for r in allowed_roles}
+
+            # A user cannot promote others above themselves
+            if result['role'] not in allowed_role_ids:
+                return Response(
+                    {'role': 'You do not have permission to assign the given role.'}, status=403)
+
+            # A user cannot demote a superior
+            if om.role not in allowed_role_ids:
                 return Response(
-                    {'role': 'You do not have permission to invite that role.'}, status=403)
-                # You can't edit your own role
+                    {'role': 'You do not have permission to assign a role to the given user.'}, status=403)
 
             if om.user == request.user and (result['role'] != om.role):
                 return Response(
diff --git a/tests/sentry/api/endpoints/test_organization_member_details.py b/tests/sentry/api/endpoints/test_organization_member_details.py
index f98ae004c0..07e8126f12 100644
--- a/tests/sentry/api/endpoints/test_organization_member_details.py
+++ b/tests/sentry/api/endpoints/test_organization_member_details.py
@@ -386,6 +386,36 @@ class UpdateOrganizationMemberTest(APITestCase):
 
         assert resp.status_code == 400
 
+    def test_cannot_lower_superior_role(self):
+        organization = self.create_organization(name='foo', owner=self.user)
+        owner = self.create_user('baz@example.com')
+        owner_om = self.create_member(
+            organization=organization,
+            user=owner,
+            role='owner',
+            teams=[]
+        )
+
+        manager = self.create_user('foo@example.com')
+        self.create_member(
+            organization=organization,
+            user=manager,
+            role='manager',
+            teams=[],
+        )
+        self.login_as(manager)
+
+        path = reverse(
+            'sentry-api-0-organization-member-details', args=[organization.slug, owner_om.id]
+        )
+
+        resp = self.client.put(path, data={'role': 'member'})
+        assert resp.status_code == 403
+
+        owner_om = OrganizationMember.objects.get(
+            organization=organization, user=owner)
+        assert owner_om.role == 'owner'
+
 
 class DeleteOrganizationMemberTest(APITestCase):
     def test_simple(self):
