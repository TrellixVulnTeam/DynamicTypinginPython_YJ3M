commit 2421acc91c469be3dd91b3b28ffd309448aa2e7d
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Oct 9 00:55:56 2015 -0700

    Restore user counts

diff --git a/src/sentry/api/serializers/models/group.py b/src/sentry/api/serializers/models/group.py
index 6570eef0ee..13e53f74f1 100644
--- a/src/sentry/api/serializers/models/group.py
+++ b/src/sentry/api/serializers/models/group.py
@@ -8,7 +8,8 @@ from sentry.api.serializers import Serializer, register, serialize
 from sentry.app import tsdb
 from sentry.constants import LOG_LEVELS
 from sentry.models import (
-    Group, GroupAssignee, GroupBookmark, GroupMeta, GroupSeen, GroupStatus
+    Group, GroupAssignee, GroupBookmark, GroupMeta, GroupSeen, GroupStatus,
+    GroupTagKey
 )
 from sentry.utils.db import attach_foreignkey
 from sentry.utils.http import absolute_uri
@@ -44,6 +45,13 @@ class GroupSerializer(Serializer):
             ).select_related('user')
         )
 
+        user_counts = dict(
+            GroupTagKey.objects.filter(
+                group__in=item_list,
+                key='sentry:user',
+            ).values_list('group', 'values_seen')
+        )
+
         result = {}
         for item in item_list:
             active_date = item.active_at or item.last_seen
@@ -59,6 +67,7 @@ class GroupSerializer(Serializer):
                 'is_bookmarked': item.id in bookmarks,
                 'has_seen': seen_groups.get(item.id, active_date) > active_date,
                 'annotations': annotations,
+                'user_count': user_counts.get(item.id, 0),
             }
         return result
 
@@ -85,6 +94,7 @@ class GroupSerializer(Serializer):
             'id': str(obj.id),
             'shareId': obj.get_share_id(),
             'count': str(obj.times_seen),
+            'userCount': attrs['user_count'],
             'title': obj.message_short,
             'culprit': obj.culprit,
             'permalink': permalink,
diff --git a/src/sentry/static/sentry/app/components/stream/group.jsx b/src/sentry/static/sentry/app/components/stream/group.jsx
index b592026b86..ace396c363 100644
--- a/src/sentry/static/sentry/app/components/stream/group.jsx
+++ b/src/sentry/static/sentry/app/components/stream/group.jsx
@@ -87,11 +87,7 @@ var StreamGroup = React.createClass({
     var router = this.context.router;
     var params = router.getCurrentParams();
     var data = this.state.data;
-    var userCount = 0;
-
-    if (data.tags.user !== undefined) {
-      userCount = data.tags.user.count;
-    }
+    var userCount = data.userCount;
 
     var className = "group row";
     if (data.isBookmarked) {
diff --git a/src/sentry/static/sentry/app/views/groupDetails/header.jsx b/src/sentry/static/sentry/app/views/groupDetails/header.jsx
index 27e35c3470..9714a4f3fb 100644
--- a/src/sentry/static/sentry/app/views/groupDetails/header.jsx
+++ b/src/sentry/static/sentry/app/views/groupDetails/header.jsx
@@ -68,13 +68,9 @@ var GroupHeader = React.createClass({
 
   render() {
     var group = this.props.group,
-        userCount = 0,
+        userCount = group.userCount,
         features = this.getProjectFeatures();
 
-    if (group.tags.user !== undefined) {
-      userCount = group.tags.user.count;
-    }
-
     var className = "group-detail level-" + group.level;
     if (group.isBookmarked) {
       className += " isBookmarked";
diff --git a/src/sentry/static/sentry/app/views/projectDashboard/eventNode.jsx b/src/sentry/static/sentry/app/views/projectDashboard/eventNode.jsx
index 407aa00883..ff9c28cf40 100644
--- a/src/sentry/static/sentry/app/views/projectDashboard/eventNode.jsx
+++ b/src/sentry/static/sentry/app/views/projectDashboard/eventNode.jsx
@@ -31,10 +31,7 @@ var EventNode = React.createClass({
 
   render() {
     var group = this.props.group;
-
-    var userCount = (group.tags.user !== undefined ?
-      userCount = group.tags.user.count :
-      0);
+    var userCount = group.userCount;
 
     return (
       <li className="group">
diff --git a/src/sentry/static/sentry/app/views/sharedGroupDetails/sharedGroupHeader.jsx b/src/sentry/static/sentry/app/views/sharedGroupDetails/sharedGroupHeader.jsx
index a540b7a5f5..7cb7ec0bed 100644
--- a/src/sentry/static/sentry/app/views/sharedGroupDetails/sharedGroupHeader.jsx
+++ b/src/sentry/static/sentry/app/views/sharedGroupDetails/sharedGroupHeader.jsx
@@ -5,11 +5,7 @@ import Count from "../../components/count";
 var SharedGroupHeader = React.createClass({
   render() {
     var group = this.props.group,
-        userCount = 0;
-
-    if (group.tags.user !== undefined) {
-      userCount = group.tags.user.count;
-    }
+        userCount = group.userCount;
 
     return (
       <div className="group-detail">
