commit 0a7135d371d32b2df3f20403baf0eab3d1702d98
Author: Alex Gaynor <alex.gaynor@rd.io>
Date:   Thu Dec 13 11:40:27 2012 -0800

    Make search lowercase both the index and the query.

diff --git a/src/sentry/manager.py b/src/sentry/manager.py
index 989144d636..9a18018339 100644
--- a/src/sentry/manager.py
+++ b/src/sentry/manager.py
@@ -991,7 +991,7 @@ class SearchDocumentManager(BaseManager):
 
         text = self.PUNCTUATION_CHARS.sub(' ', text)
 
-        words = [t[:128] for t in text.split() if len(t) >= self.MIN_WORD_LENGTH and t.lower() not in self.STOP_WORDS]
+        words = [t[:128].lower() for t in text.split() if len(t) >= self.MIN_WORD_LENGTH and t.lower() not in self.STOP_WORDS]
 
         return words
 
@@ -1084,10 +1084,12 @@ class SearchDocumentManager(BaseManager):
             if field == 'text':
                 # we only tokenize the base text field
                 values = itertools.chain(*[self._tokenize(force_unicode(v)) for v in values])
+            else:
+                values = [v.lower() for v in values]
             for value in values:
                 if not value:
                     continue
-                token_counts[field][value.lower()] += 1
+                token_counts[field][value] += 1
 
         for field, tokens in token_counts.iteritems():
             for token, count in tokens.iteritems():
diff --git a/tests/sentry/search/tests.py b/tests/sentry/search/tests.py
index 4aa10f8190..1729aaf929 100644
--- a/tests/sentry/search/tests.py
+++ b/tests/sentry/search/tests.py
@@ -25,3 +25,11 @@ class SearchIndexTest(TestCase):
         self.assertEquals(doc.total_events, 2)
         self.assertEquals(doc.date_added, event.group.first_seen)
         self.assertEquals(doc.date_changed, event.group.last_seen)
+
+    def test_search(self):
+        event = Event.objects.all()[0]
+        doc = SearchDocument.objects.index(event)
+
+        results = list(SearchDocument.objects.search(event.project, event.message.upper()))
+        [res] = results
+        self.assertEqual(res.id, doc.id)
