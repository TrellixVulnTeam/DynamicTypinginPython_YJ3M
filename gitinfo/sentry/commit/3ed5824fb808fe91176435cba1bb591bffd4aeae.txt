commit 3ed5824fb808fe91176435cba1bb591bffd4aeae
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Feb 24 11:12:30 2015 -0800

    Issue raw query for node cleanup (refs GH-1436)

diff --git a/src/sentry/nodestore/django/backend.py b/src/sentry/nodestore/django/backend.py
index 96cc4a0c07..bcb44ac2e9 100644
--- a/src/sentry/nodestore/django/backend.py
+++ b/src/sentry/nodestore/django/backend.py
@@ -8,6 +8,7 @@ sentry.nodestore.django.backend
 
 from __future__ import absolute_import
 
+from django.db import connection
 from django.utils import timezone
 
 from sentry.db.models import create_or_update
@@ -43,4 +44,10 @@ class DjangoNodeStorage(NodeStorage):
         )
 
     def cleanup(self, cutoff_timestamp):
-        Node.objects.filter(timestamp__lte=cutoff_timestamp).delete()
+        query = """
+        DELETE FROM %s WHERE timestamp <= %%s
+        """ % (Node._meta.db_table,)
+        params = [cutoff_timestamp]
+
+        cursor = connection.cursor()
+        cursor.execute(query, params)
diff --git a/tests/sentry/nodestore/django/backend/tests.py b/tests/sentry/nodestore/django/backend/tests.py
index c2a681965e..700f18e40e 100644
--- a/tests/sentry/nodestore/django/backend/tests.py
+++ b/tests/sentry/nodestore/django/backend/tests.py
@@ -2,6 +2,9 @@
 
 from __future__ import absolute_import
 
+from datetime import timedelta
+from django.utils import timezone
+
 from sentry.nodestore.django.models import Node
 from sentry.nodestore.django.backend import DjangoNodeStorage
 from sentry.testutils import TestCase
@@ -96,3 +99,28 @@ class DjangoNodeStorageTest(TestCase):
 
         self.ns.delete_multi([node.id])
         assert not Node.objects.filter(id=node.id).exists()
+
+    def test_cleanup(self):
+        now = timezone.now()
+        cutoff = now - timedelta(days=1)
+
+        node = Node.objects.create(
+            id='d2502ebbd7df41ceba8d3275595cac33',
+            timestamp=now,
+            data={
+                'foo': 'bar',
+            }
+        )
+
+        node2 = Node.objects.create(
+            id='d2502ebbd7df41ceba8d3275595cac34',
+            timestamp=cutoff,
+            data={
+                'foo': 'bar',
+            }
+        )
+
+        self.ns.cleanup(cutoff)
+
+        assert Node.objects.filter(id=node.id).exists()
+        assert not Node.objects.filter(id=node2.id).exists()
