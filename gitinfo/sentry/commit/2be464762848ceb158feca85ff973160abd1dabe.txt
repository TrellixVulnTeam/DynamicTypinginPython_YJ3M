commit 2be464762848ceb158feca85ff973160abd1dabe
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Nov 23 14:36:55 2015 -0800

    Add periodic task for cleaning up GroupSnooze

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 0b8f8d7b8c..a86db7588d 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -371,6 +371,7 @@ CELERY_DEFAULT_ROUTING_KEY = "default"
 CELERY_CREATE_MISSING_QUEUES = True
 CELERY_IMPORTS = (
     'sentry.tasks.beacon',
+    'sentry.tasks.clear_expired_snoozes',
     'sentry.tasks.check_auth',
     'sentry.tasks.deletion',
     'sentry.tasks.digests',
@@ -466,7 +467,14 @@ CELERYBEAT_SCHEDULE = {
         'options': {
             'expires': 30,
         },
-    }
+    },
+    'clear-expired-snoozes': {
+        'task': 'sentry.tasks.clear_expired_snoozes',
+        'schedule': timedelta(minutes=5),
+        'options': {
+            'expires': 300,
+        },
+    },
 }
 
 LOGGING = {
diff --git a/src/sentry/tasks/clear_expired_snoozes.py b/src/sentry/tasks/clear_expired_snoozes.py
new file mode 100644
index 0000000000..0f8f07db7a
--- /dev/null
+++ b/src/sentry/tasks/clear_expired_snoozes.py
@@ -0,0 +1,26 @@
+from __future__ import absolute_import, print_function
+
+from django.utils import timezone
+
+from sentry.models import Group, GroupSnooze, GroupStatus
+from sentry.tasks.base import instrumented_task
+
+
+@instrumented_task(name='sentry.tasks.clear_expired_snoozes',
+                   time_limit=15,
+                   soft_time_limit=10)
+def clear_expired_snoozes():
+    group_list = list(GroupSnooze.objects.filter(
+        until__lte=timezone.now(),
+    ).values_list('group', flat=True))
+
+    Group.objects.filter(
+        id__in=group_list,
+        status=GroupStatus.MUTED,
+    ).update(
+        status=GroupStatus.UNRESOLVED,
+    )
+
+    GroupSnooze.objects.filter(
+        group__in=group_list,
+    ).delete()
diff --git a/tests/sentry/tasks/test_clear_expired_snoozes.py b/tests/sentry/tasks/test_clear_expired_snoozes.py
new file mode 100644
index 0000000000..b762f35b46
--- /dev/null
+++ b/tests/sentry/tasks/test_clear_expired_snoozes.py
@@ -0,0 +1,40 @@
+from __future__ import absolute_import
+
+from datetime import timedelta
+from django.utils import timezone
+
+from sentry.models import Group, GroupSnooze, GroupStatus
+from sentry.tasks.clear_expired_snoozes import clear_expired_snoozes
+from sentry.testutils import TestCase
+
+
+class ClearExpiredSnoozesTest(TestCase):
+    def test_task_persistent_name(self):
+        assert clear_expired_snoozes.name == 'sentry.tasks.clear_expired_snoozes'
+
+    def test_simple(self):
+        group1 = self.create_group(
+            status=GroupStatus.MUTED,
+        )
+        GroupSnooze.objects.create(
+            group=group1,
+            until=timezone.now() - timedelta(minutes=1),
+        )
+
+        group2 = self.create_group(
+            status=GroupStatus.MUTED,
+        )
+        GroupSnooze.objects.create(
+            group=group2,
+            until=timezone.now() + timedelta(minutes=1),
+        )
+
+        clear_expired_snoozes()
+
+        assert Group.objects.get(
+            id=group1.id,
+        ).status == GroupStatus.UNRESOLVED
+
+        assert Group.objects.get(
+            id=group2.id,
+        ).status == GroupStatus.MUTED
