commit e4081bc4ecdd95aa75ad5674fa94af7c166fbe04
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Mon Apr 9 20:37:05 2018 +0200

    bugfix: deduplicate errors before logging them more than once in the event (#7940)

diff --git a/src/sentry/stacktraces.py b/src/sentry/stacktraces.py
index d7704a8ae8..88818ee428 100644
--- a/src/sentry/stacktraces.py
+++ b/src/sentry/stacktraces.py
@@ -380,6 +380,16 @@ def get_stacktrace_processing_task(infos, processors):
     )
 
 
+def dedup_errors(errors):
+    # This operation scales bad but we do not expect that many items to
+    # end up in rv, so that should be okay enough to do.
+    rv = []
+    for error in errors:
+        if error not in rv:
+            rv.append(error)
+    return rv
+
+
 def process_stacktraces(data, make_processors=None):
     infos = find_stacktraces_in_data(data)
     if make_processors is None:
@@ -418,7 +428,7 @@ def process_stacktraces(data, make_processors=None):
                 )
                 changed = True
             if errors:
-                data.setdefault('errors', []).extend(errors)
+                data.setdefault('errors', []).extend(dedup_errors(errors))
                 changed = True
 
     finally:
diff --git a/tests/sentry/lang/javascript/test_plugin.py b/tests/sentry/lang/javascript/test_plugin.py
index 5fb222fb7b..602922c67a 100644
--- a/tests/sentry/lang/javascript/test_plugin.py
+++ b/tests/sentry/lang/javascript/test_plugin.py
@@ -960,6 +960,8 @@ class JavascriptIntegrationTest(TestCase):
                     {
                         'type': 'Error',
                         'stacktrace': {
+                            # Add two frames.  We only want to see the
+                            # error once though.
                             'frames': [
                                 {
                                     'abs_path': 'http://example.com/file.min.js',
@@ -967,6 +969,12 @@ class JavascriptIntegrationTest(TestCase):
                                     'lineno': 1,
                                     'colno': 39,
                                 },
+                                {
+                                    'abs_path': 'http://example.com/file.min.js',
+                                    'filename': 'file.min.js',
+                                    'lineno': 1,
+                                    'colno': 39,
+                                },
                             ],
                         },
                     }
