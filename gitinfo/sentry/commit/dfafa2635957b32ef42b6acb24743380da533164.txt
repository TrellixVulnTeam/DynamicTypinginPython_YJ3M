commit dfafa2635957b32ef42b6acb24743380da533164
Author: josh <josh@jrl.ninja>
Date:   Fri Aug 16 22:03:24 2019 +0000

    chore: upgrade+pin pip in ci, disable pep517 where applicable (#14421)

diff --git a/.travis.yml b/.travis.yml
index 955a46261b..96a59df0ea 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -26,6 +26,9 @@ addons:
 env:
   global:
     - NODE_ENV=development
+    # PIP_VERSION causes issues because: https://github.com/pypa/pip/issues/4528
+    - PYTHON_PIP_VERSION=19.1.1
+    - PIP_USE_PEP517=off
     - PIP_DISABLE_PIP_VERSION_CHECK=on
     - PIP_QUIET=1
     - SENTRY_LIGHT_BUILD=1
@@ -36,6 +39,9 @@ env:
     - NODE_DIR="${HOME}/.nvm/versions/node/v$(< .nvmrc)"
     - NODE_OPTIONS=--max-old-space-size=4096
 
+before_install:
+  - pip install "pip==${PYTHON_PIP_VERSION}"
+
 script:
   # certain commands require sentry init to be run, but this is only true for
   # running things within Travis
@@ -74,15 +80,15 @@ base_postgres: &postgres_default
     - memcached
     - redis-server
     - postgresql
+  before_install:
+    - docker run -d --network host --name clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:19.4
+    - docker run -d --network host --name snuba --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=localhost:9000 getsentry/snuba
+    - docker ps -a
   install:
     - python setup.py install_egg_info
     - pip install -U -e ".[dev,tests,optional]"
   before_script:
     - psql -c 'create database sentry;' -U postgres
-  before_install:
-    - docker run -d --network host --name clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:19.4
-    - docker run -d --network host --name snuba --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=localhost:9000 getsentry/snuba
-    - docker ps -a
 
 base_acceptance: &acceptance_default
   python: 2.7
@@ -143,15 +149,15 @@ matrix:
         - redis-server
         - postgresql
         - riak
+      before_install:
+        - docker run -d --network host --name clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:19.4
+        - docker run -d --network host --name snuba --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=localhost:9000 getsentry/snuba
+        - docker ps -a
       install:
         - python setup.py install_egg_info
         - pip install -U -e ".[dev,tests,optional]"
       before_script:
         - psql -c 'create database sentry;' -U postgres
-      before_install:
-        - docker run -d --network host --name clickhouse-server --ulimit nofile=262144:262144 yandex/clickhouse-server:19.4
-        - docker run -d --network host --name snuba --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=localhost:9000 getsentry/snuba
-        - docker ps -a
 
     - <<: *acceptance_default
       name: 'Acceptance'
diff --git a/Makefile b/Makefile
index 296f349187..dcbadff4d8 100644
--- a/Makefile
+++ b/Makefile
@@ -8,6 +8,7 @@ ifneq "$(wildcard /usr/local/opt/openssl/lib)" ""
 endif
 
 PIP = LDFLAGS="$(LDFLAGS)" pip
+PIP_OPTS = --no-use-pep517 --disable-pip-version-check
 WEBPACK = NODE_ENV=production ./bin/yarn webpack
 YARN = ./bin/yarn
 
@@ -60,7 +61,7 @@ setup-git:
 	git config branch.autosetuprebase always
 	git config core.ignorecase false
 	cd .git/hooks && ln -sf ../../config/hooks/* ./
-	pip install "pre-commit>=1.10.1,<1.11.0"
+	$(PIP) install "pre-commit>=1.10.1,<1.11.0" $(PIP_OPTS)
 	pre-commit install --install-hooks
 	@echo ""
 
@@ -90,7 +91,7 @@ install-yarn-pkgs:
 
 install-sentry-dev:
 	@echo "--> Installing Sentry (for development)"
-	$(PIP) install -e ".[dev,tests,optional]"
+	$(PIP) install -e ".[dev,tests,optional]" $(PIP_OPTS)
 
 build-js-po: node-version-check
 	mkdir -p build
@@ -103,7 +104,7 @@ locale: build-js-po
 	cd src/sentry && sentry django compilemessages
 
 update-transifex: build-js-po
-	$(PIP) install transifex-client
+	$(PIP) install transifex-client $(PIP_OPTS)
 	cd src/sentry && sentry django makemessages -i static -l en
 	./bin/merge-catalogs en
 	tx push -s
@@ -243,7 +244,7 @@ travis-test-riak: test-riak
 .PHONY: scan-python travis-scan-postgres travis-scan-acceptance travis-scan-snuba travis-scan-symbolicator travis-scan-js travis-scan-cli travis-scan-dist travis-scan-lint travis-scan-riak
 scan-python:
 	@echo "--> Running Python vulnerability scanner"
-	$(PIP) install safety
+	$(PIP) install safety $(PIP_OPTS)
 	bin/scan
 	@echo ""
 
