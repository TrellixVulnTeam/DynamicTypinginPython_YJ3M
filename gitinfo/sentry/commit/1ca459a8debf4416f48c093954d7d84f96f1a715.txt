commit 1ca459a8debf4416f48c093954d7d84f96f1a715
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Wed Jul 18 15:55:20 2018 -0700

    fix(discover): Fix orderby validation (#9091)
    
    Allows ordering by any field  if we're returning raw data, otherwise allow only aggregations and selected fields.

diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
index 5fd88198e4..162e4ede8a 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
@@ -131,12 +131,15 @@ export default function createQueryBuilder(initial = {}, organization) {
     );
 
     const orderbyField = (query.orderby || '').replace(/^-/, '');
-    const hasOrderFieldInFields = query.fields.includes(orderbyField);
+    const hasOrderFieldInFields = getColumns().includes(orderbyField);
+    const hasOrderFieldInSelectedFields = query.fields.includes(orderbyField);
     const hasOrderFieldInAggregations = query.aggregations.some(
       agg => orderbyField === agg[2]
     );
 
-    const hasInvalidOrderbyField = !hasOrderFieldInFields && !hasOrderFieldInAggregations;
+    const hasInvalidOrderbyField = validAggregations.length
+      ? !hasOrderFieldInSelectedFields && !hasOrderFieldInAggregations
+      : hasOrderFieldInFields;
 
     // If orderby value becomes invalid, update it to the first valid aggregation
     if (validAggregations.length > 0 && hasInvalidOrderbyField) {
