commit 317ddaf249985c1903002613c172b0cd7c24b78a
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Fri Feb 28 11:12:00 2020 +0100

    fix(pii): Do not emit unnecessary selectors (#17371)

diff --git a/src/sentry/datascrubbing.py b/src/sentry/datascrubbing.py
index 658eecc8ef..71e59e71eb 100644
--- a/src/sentry/datascrubbing.py
+++ b/src/sentry/datascrubbing.py
@@ -36,11 +36,9 @@ def _path_selectors_from_diff(old_data, data):
     fields that changed.
     """
 
-    if type(old_data) != type(data):
-        yield None
-        yield u"**"
+    dict_types = (CanonicalKeyDict, dict)
 
-    elif isinstance(data, (CanonicalKeyDict, dict)):
+    if isinstance(old_data, dict_types) and isinstance(data, dict_types):
         for key, value in six.iteritems(data):
             old_value = old_data.get(key)
             key = _escape_key(key)
@@ -53,7 +51,7 @@ def _path_selectors_from_diff(old_data, data):
                 else:
                     yield key
 
-    elif isinstance(data, list):
+    elif isinstance(old_data, list) and isinstance(data, list):
         for i, value in enumerate(data):
             old_value = old_data[i] if len(old_data) > i else None
             for selector in _path_selectors_from_diff(old_value, value):
@@ -63,7 +61,12 @@ def _path_selectors_from_diff(old_data, data):
                     yield six.text_type(i)
 
     elif old_data != data:
+        # If the values are not equal we yield out both
+        #
+        # * the specific selector (for changes from null <-> int|string)
+        # * the deep-wildcard one (for changes array|dict <-> null)
         yield None
+        yield u"**"
 
 
 def _narrow_pii_config_for_processing(config, old_event, event):
@@ -112,6 +115,7 @@ def scrub_data(project_config, event, in_processing=False, old_event=None):
         if in_processing:
             assert old_event is not None
             config = _narrow_pii_config_for_processing(config, old_event, event)
+
         event = sentry_relay.pii_strip_event(config, event)
 
     return event
diff --git a/tests/sentry/test_datascrubbing.py b/tests/sentry/test_datascrubbing.py
index b14e809e5e..cf44d8675b 100644
--- a/tests/sentry/test_datascrubbing.py
+++ b/tests/sentry/test_datascrubbing.py
@@ -13,11 +13,14 @@ def test_path_selectors_from_diff():
 
     assert f({}, {"foo": {"bar": ["baz"]}}) == ["foo", "foo.**"]
     assert f({"foo": {"bar": ["baz"]}}, {}) == []
-    assert f({"foo": {"bar": ["bam"]}}, {"foo": {"bar": ["baz"]}}) == ["foo.bar.0"]
+    assert f({"foo": {"bar": ["bam"]}}, {"foo": {"bar": ["baz"]}}) == ["foo.bar.0", "foo.bar.0.**"]
     assert f(42, {}) == [None, "**"]
     assert f({"foo": {"bar": []}}, {"foo": {"bar": [42]}}) == ["foo.bar.0", "foo.bar.0.**"]
     assert f({"foo": {"bar": [42]}}, {"foo": {"bar": []}}) == []
 
+    # unicode vs bytes
+    assert f({"foo": {"bar": b"baz"}}, {"foo": {"bar": u"baz"}}) == []
+
 
 @pytest.mark.parametrize(
     "field",
