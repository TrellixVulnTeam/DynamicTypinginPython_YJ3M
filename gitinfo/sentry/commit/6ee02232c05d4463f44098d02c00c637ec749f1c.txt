commit 6ee02232c05d4463f44098d02c00c637ec749f1c
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jul 12 19:35:33 2015 -0700

    Various additions to error embed
    
    - Fix syntax issues
    - Added default name and email

diff --git a/src/sentry/templates/sentry/500.html b/src/sentry/templates/sentry/500.html
index 52c4d15bd9..f5e27cd52d 100644
--- a/src/sentry/templates/sentry/500.html
+++ b/src/sentry/templates/sentry/500.html
@@ -13,16 +13,20 @@
 
     {% if request.sentry.id %}
       <script>
-      window.sentryConfig = {
-        eventId: '{{ request.sentry.id }}',
-        dsn: '{{ public_dsn }}'
-      };
+      window.sentryConfig = {{ embed_config }};
+      // TODO(dcramer): This snippet will be moved in to the generated "installation code"
       (function(document, window){
         var config = window.sentryConfig;
         var escape = window.encodeURIComponent;
         var endpoint = '{% url 'sentry-error-page-embed' %}';
-        endpoint += '?eventId=' + escape(config.eventId);
-        endpoint += '&dsn=' + escape(config.dsn);
+        endpoint += '?eventId=' + escape(config.eventId || '');
+        endpoint += '&dsn=' + escape(config.dsn || '');
+        if (config.userName) {
+          endpoint += '&name=' + escape(config.userName);
+        }
+        if (config.userEmail) {
+          endpoint += '&email=' + escape(config.userEmail);
+        }
         var script = document.createElement('script');
         script.type = 'text/javascript';
         script.async = true;
diff --git a/src/sentry/templates/sentry/error-page-embed.js b/src/sentry/templates/sentry/error-page-embed.js
index 282a06f39f..609a3de74c 100644
--- a/src/sentry/templates/sentry/error-page-embed.js
+++ b/src/sentry/templates/sentry/error-page-embed.js
@@ -44,7 +44,7 @@
     xhr.onreadystatechange = function() {
       if (xhr.readyState === XMLHttpRequest.DONE) {
         if (xhr.status === 200) {
-          formContent.innerHTML = "<p class="message-success">Your report has been sent. Thank you!</p>";
+          formContent.innerHTML = '<p class="message-success">Your report has been sent. Thank you!</p>';
           submitBtn.parentNode.removeChild(submitBtn);
         } else if (xhr.status == 400) {
           var data = JSON.parse(xhr.responseText);
diff --git a/src/sentry/web/frontend/error_500.py b/src/sentry/web/frontend/error_500.py
index e07d20e5c0..721c80b317 100644
--- a/src/sentry/web/frontend/error_500.py
+++ b/src/sentry/web/frontend/error_500.py
@@ -6,11 +6,39 @@ from django.conf import settings
 from django.views.generic import View
 from django.template import Context, loader
 from django.http import HttpResponseServerError
+from django.utils.safestring import mark_safe
 
 from sentry.models import ProjectKey
+from sentry.utils import json
 
 
 class Error500View(View):
+    def get_embed_config(self, request):
+        if not getattr(request, 'sentry'):
+            return
+
+        try:
+            projectkey = ProjectKey.objects.filter(
+                id=settings.SENTRY_PROJECT,
+            )[0]
+        except Exception:
+            logging.exception('Unable to fetch ProjectKey for internal project')
+            return
+
+        result = {
+            'dsn': projectkey.dsn_public,
+            'eventId': request.sentry['id'],
+        }
+        if request.user.is_authenticated():
+            try:
+                result.update({
+                    'userName': request.user.get_full_name(),
+                    'userEmail': request.user.email,
+                })
+            except Exception:
+                logging.exception('Unable to fetch user information for embed')
+        return result
+
     def dispatch(self, request):
         """
         500 error handler.
@@ -22,14 +50,9 @@ class Error500View(View):
             'request': request,
         }
 
-        try:
-            projectkey = ProjectKey.objects.filter(
-                id=settings.SENTRY_PROJECT,
-            )[0]
-        except Exception:
-            logging.warn('Unable to fetch ProjectKey for internal project')
-        else:
-            context['public_dsn'] = projectkey.dsn_public
+        embed_config = self.get_embed_config(request)
+        if embed_config:
+            context['embed_config'] = mark_safe(json.dumps(embed_config))
 
         t = loader.get_template('sentry/500.html')
         return HttpResponseServerError(t.render(Context(context)))
diff --git a/src/sentry/web/frontend/error_page_embed.py b/src/sentry/web/frontend/error_page_embed.py
index cfced287c3..319130b46a 100644
--- a/src/sentry/web/frontend/error_page_embed.py
+++ b/src/sentry/web/frontend/error_page_embed.py
@@ -89,8 +89,6 @@ class ErrorPageEmbedView(View):
                 "errors": dict(form.errors),
             }), status=400, content_type='application/json')
 
-        form = UserReportForm(initial=initial)
-
         template = render_to_string('sentry/error-page-embed.html', {
             'form': form,
         })
