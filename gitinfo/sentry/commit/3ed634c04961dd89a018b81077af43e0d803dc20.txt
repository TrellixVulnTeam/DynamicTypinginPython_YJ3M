commit 3ed634c04961dd89a018b81077af43e0d803dc20
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jun 3 15:49:23 2012 -0700

    Missing changes from 80934d5d00693adbede9e763f445e942404661b2

diff --git a/sentry/templates/sentry/dashboard.html b/sentry/templates/sentry/dashboard.html
index 58189cac7e..7fbf118a5c 100644
--- a/sentry/templates/sentry/dashboard.html
+++ b/sentry/templates/sentry/dashboard.html
@@ -26,34 +26,46 @@
                 <div class="page-header">
                     <h3 class="pull-left">{% trans "Trends" %}</h3>
                     <ul class="nav nav-pills nav-small">
-                        <li><a href="#">{% trans "15 minutes" %}</a></li>
-                        <li><a href="#">{% trans "60 minutes" %}</a></li>
-                        <li class="active"><a href="#">{% trans "24 hours" %}</a></li>
+                        <li><a href="#top_15m" data-toggle="ajtab" data-uri="{% url sentry-api-groups-trends %}?minutes=15&amp;limit=5">{% trans "15 minutes" %}</a></li>
+                        <li><a href="#top_60m" data-toggle="ajtab" data-uri="{% url sentry-api-groups-trends %}?minutes=60&amp;limit=5">{% trans "60 minutes" %}</a></li>
+                        <li class="active"><a href="#top_24h" data-toggle="ajtab" data-uri="{% url sentry-api-groups-trends %}?minutes=1440&amp;limit=5">{% trans "24 hours" %}</a></li>
                     </ul>
                 </div>
-                <ul class="events" id="event_list">
-                    {% for group in top_event_list %}
-                        {% include "sentry/partial/_group_small.html" %}
-                    {% endfor %}
-                </ul>
-            {% endif %}
-                <div class="page-header">
-                    <h3 class="pull-left">{% trans "New Events" %}</h3>
-                    <ul class="nav nav-pills nav-small">
-                        <li><a href="#">{% trans "15 minutes" %}</a></li>
-                        <li><a href="#">{% trans "60 minutes" %}</a></li>
-                        <li class="active"><a href="#">{% trans "24 hours" %}</a></li>
-                    </ul>
+                <div class="tab-content">
+                    <div class="tab-pane active" id="top_15m">
+                        <ul class="events">
+                            {% for group in top_event_list %}
+                                {% include "sentry/partial/_group_small.html" %}
+                            {% endfor %}
+                        </ul>
+                    </div>
+                    <div class="tab-pane" id="top_60m"></div>
+                    <div class="tab-pane" id="top_24h"></div>
                 </div>
-            {% if new_event_list %}
-                <ul class="events" id="event_list">
-                    {% for group in new_event_list %}
-                        {% include "sentry/partial/_group_small.html" %}
-                    {% endfor %}
-                </ul>
-            {% else %}
-                <p>{% trans "No unresolved events are available for the last 24 hours." %}</p>
             {% endif %}
+            <div class="page-header">
+                <h3 class="pull-left">{% trans "New Events" %}</h3>
+                <ul class="nav nav-pills nav-small">
+                    <li><a href="#new_15m" data-toggle="ajtab" data-uri="{% url sentry-api-groups-new %}?minutes=15&amp;limit=5">{% trans "15 minutes" %}</a></li>
+                    <li><a href="#new_60m" data-toggle="ajtab" data-uri="{% url sentry-api-groups-new %}?minutes=60&amp;limit=5">{% trans "60 minutes" %}</a></li>
+                    <li class="active"><a href="#new_24h" data-toggle="ajtab" data-uri="{% url sentry-api-groups-new %}?minutes=1440&amp;limit=5">{% trans "24 hours" %}</a></li>
+                </ul>
+            </div>
+            <div class="tab-content">
+                <div class="tab-pane active" id="new_15m">
+                    {% if new_event_list %}
+                        <ul class="events">
+                            {% for group in new_event_list %}
+                                {% include "sentry/partial/_group_small.html" %}
+                            {% endfor %}
+                        </ul>
+                    {% else %}
+                        <p>{% trans "No unresolved events are available for the last 24 hours." %}</p>
+                    {% endif %}
+                </div>
+                <div class="tab-pane" id="new_60m"></div>
+                <div class="tab-pane" id="new_24h"></div>
+            </div>
         {% else %}
             {% if can_create_projects %}
                 {% url sentry-new-project as link %}
@@ -96,6 +108,35 @@
     <script type="text/javascript">
     $(document).ready(function() {
         Sentry.charts.render('#chart');
+        //load content for first tab and initialize
+        $('a[data-toggle=ajtab]').bind('click', function(e) {
+            var $el = $(e.target);
+            var uri = $el.attr('data-uri');
+            if (!uri) {
+                return;
+            }
+            var $tab = $(this);
+            var $cont = $($tab.attr('href'));
+            var $parent = $cont.parent();
+
+            $parent.css('opacity', .6)
+            e.preventDefault()
+
+            // load content for selected tab
+            $.ajax({
+                url: uri,
+                dataType: 'json',
+                success: function(data){
+                    var $ul = $('<ul class="events"></ul>');
+                    $.each(data, function(_, group){
+                        $ul.append($(group.html));
+                    });
+                    $cont.html($ul);
+                    $parent.css('opacity', 1)
+                    $tab.tab('show');
+                }
+            });
+        });
     });
     </script>
 {% endblock %}
\ No newline at end of file
diff --git a/sentry/web/api.py b/sentry/web/api.py
index e6f822212c..60c2aeaa4c 100644
--- a/sentry/web/api.py
+++ b/sentry/web/api.py
@@ -22,7 +22,9 @@ from sentry.coreapi import project_from_auth_vars, project_from_id, \
   decode_and_decompress_data, safely_load_json_string, validate_data, \
   insert_data_to_database, APIError, APIUnauthorized, extract_auth_vars
 from sentry.models import Group, GroupBookmark, Project, View
+from sentry.templatetags.sentry_helpers import as_bookmarks
 from sentry.utils import json
+from sentry.utils.db import has_trending
 from sentry.utils.http import is_same_domain, is_valid_origin, apply_access_control_headers
 from sentry.web.decorators import has_access
 from sentry.web.frontend.groups import _get_group_list
@@ -32,6 +34,26 @@ error_logger = logging.getLogger('sentry.errors.api.http')
 logger = logging.getLogger('sentry.api.http')
 
 
+def transform_groups(request, group_list, template='sentry/partial/_group.html'):
+    return [
+        {
+            'id': m.pk,
+            'html': render_to_string(template, {
+                'group': m,
+                'request': request,
+                'is_bookmarked': b,
+            }).strip(),
+            'title': m.message_top(),
+            'message': m.error(),
+            'level': m.get_level_display(),
+            'logger': m.logger,
+            'count': m.times_seen,
+            'score': getattr(m, 'sort_value', None),
+        }
+        for m, b in as_bookmarks(group_list, request.user)
+    ]
+
+
 def api_method(func):
     @wraps(func)
     @csrf_exempt
@@ -171,7 +193,6 @@ def notification(request, project):
 @has_access
 @never_cache
 def poll(request, project):
-    from sentry.templatetags.sentry_helpers import as_bookmarks
     from sentry.templatetags.sentry_plugins import handle_before_events
 
     offset = 0
@@ -196,21 +217,7 @@ def poll(request, project):
     event_list = list(event_list[offset:limit])
     handle_before_events(request, event_list)
 
-    data = [
-        {
-            'id': m.pk,
-            'html': render_to_string('sentry/partial/_group.html', {
-                'group': m,
-                'request': request,
-                'is_bookmarked': b,
-            }).strip(),
-            'title': m.message_top(),
-            'message': m.error(),
-            'level': m.get_level_display(),
-            'logger': m.logger,
-            'count': m.times_seen,
-            'score': getattr(m, 'sort_value', None),
-        } for m, b in as_bookmarks(event_list, request.user)]
+    data = transform_groups(request, event_list)
 
     response = HttpResponse(json.dumps(data))
     response['Content-Type'] = 'application/json'
@@ -238,14 +245,7 @@ def resolve(request, project):
     group.status = 1
     group.resolved_at = now
 
-    data = [
-        (m.pk, {
-            'html': render_to_string('sentry/partial/_group.html', {
-                'group': m,
-                'request': request,
-            }).strip(),
-            'count': m.times_seen,
-        }) for m in [group]]
+    data = transform_groups(request, [group])
 
     response = HttpResponse(json.dumps(data))
     response['Content-Type'] = 'application/json'
@@ -352,3 +352,69 @@ def chart(request, project=None):
     response = HttpResponse(json.dumps(data))
     response['Content-Type'] = 'application/json'
     return response
+
+
+@never_cache
+@csrf_exempt
+@has_access
+def get_group_trends(request, project=None):
+    minutes = int(request.REQUEST.get('minutes', 15))
+    limit = min(100, int(request.REQUEST.get('limit', 10)))
+
+    if project:
+        project_list = [project]
+    else:
+        project_list = get_project_list(request.user).values()
+
+    cutoff = datetime.timedelta(minutes=minutes)
+    cutoff_dt = datetime.datetime.now() - cutoff
+
+    base_qs = Group.objects.filter(
+        project__in=project_list,
+        status=0,
+    ).select_related('project').order_by('-score')
+
+    if has_trending():
+        group_list = list(Group.objects.get_accelerated(base_qs, minutes=(
+            (cutoff.days * 1440) + (cutoff.seconds * 60)
+        ))[:limit])
+    else:
+        group_list = list(base_qs.filter(
+            last_seen__gte=cutoff_dt
+        )[:limit])
+
+    data = transform_groups(request, group_list, template='sentry/partial/_group_small.html')
+
+    response = HttpResponse(json.dumps(data))
+    response['Content-Type'] = 'application/json'
+
+    return response
+
+
+@never_cache
+@csrf_exempt
+@has_access
+def get_new_groups(request, project=None):
+    minutes = int(request.REQUEST.get('minutes', 15))
+    limit = min(100, int(request.REQUEST.get('limit', 10)))
+
+    if project:
+        project_list = [project]
+    else:
+        project_list = get_project_list(request.user).values()
+
+    cutoff = datetime.timedelta(minutes=minutes)
+    cutoff_dt = datetime.datetime.now() - cutoff
+
+    group_list = Group.objects.filter(
+        project__in=project_list,
+        status=0,
+        active_at__gte=cutoff_dt,
+    ).select_related('project').order_by('-score')[:limit]
+
+    data = transform_groups(request, group_list, template='sentry/partial/_group_small.html')
+
+    response = HttpResponse(json.dumps(data))
+    response['Content-Type'] = 'application/json'
+
+    return response
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index 4facb1fd9b..8feab8ad31 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -120,6 +120,8 @@ urlpatterns = patterns('',
     url(r'^api/(?P<project_id>[\w_-]+)/clear/$', api.clear, name='sentry-api-clear'),
     url(r'^api/(?:(?P<project_id>[\w_-]+)/)?chart/$', api.chart, name='sentry-api-chart'),
     url(r'^api/(?P<project_id>[\w_-]+)/group/(?P<group_id>[\w_-]+)/remove/$', api.remove_group, name='sentry-api-remove-group'),
+    url(r'^api/(?:(?P<project_id>[\w_-]+)/)?groups/trends/$', api.get_group_trends, name='sentry-api-groups-trends'),
+    url(r'^api/(?:(?P<project_id>[\w_-]+)/)?groups/newest/$', api.get_new_groups, name='sentry-api-groups-new'),
 
     # Project specific
 
diff --git a/setup.py b/setup.py
index 7a26048bc2..f47a38b4b2 100755
--- a/setup.py
+++ b/setup.py
@@ -72,7 +72,7 @@ dependency_links = [
 
 setup(
     name='sentry',
-    version='4.5.4.1',
+    version='4.5.4.2',
     author='David Cramer',
     author_email='dcramer@gmail.com',
     url='http://github.com/dcramer/sentry',
