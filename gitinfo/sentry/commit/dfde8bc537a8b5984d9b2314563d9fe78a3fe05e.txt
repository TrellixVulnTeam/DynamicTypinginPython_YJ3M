commit dfde8bc537a8b5984d9b2314563d9fe78a3fe05e
Author: Jess MacQueen <jess@getsentry.com>
Date:   Sun Apr 17 08:07:15 2016 -0700

    fix letter avatars in email

diff --git a/src/sentry/templates/sentry/emails/activity/assigned.html b/src/sentry/templates/sentry/emails/activity/assigned.html
index 54b44441d5..dfb01fa5aa 100644
--- a/src/sentry/templates/sentry/emails/activity/assigned.html
+++ b/src/sentry/templates/sentry/emails/activity/assigned.html
@@ -16,7 +16,7 @@
   <h2>Assigned</h2>
 
   <p>
-    <strong><span class="avatar-container">{% letter_avatar_svg author.get_display_name author.get_label %}<img class="avatar" width="20" height="20" src="{% gravatar_url author.email size 40 default 'blank' %}"></span>{{ author.get_display_name }}</strong> assigned this issue to you in <strong>{{ group.organization.name }}/{{ group.project.name }}</strong>.
+    <strong><span class="avatar-container">{% letter_avatar_svg author.get_display_name author.get_label size 20 use_svg False %}<img class="avatar" width="20" height="20" src="{% gravatar_url author.email size 40 default 'blank' %}"></span>{{ author.get_display_name }}</strong> assigned this issue to you in <strong>{{ group.organization.name }}/{{ group.project.name }}</strong>.
   </p>
 
   {% include "sentry/emails/group_header.html" %}
diff --git a/src/sentry/templates/sentry/emails/activity/note.html b/src/sentry/templates/sentry/emails/activity/note.html
index d9e2864ee3..6e56801511 100644
--- a/src/sentry/templates/sentry/emails/activity/note.html
+++ b/src/sentry/templates/sentry/emails/activity/note.html
@@ -18,7 +18,7 @@
   <table class="note">
     <tr>
       <td class="avatar-column">
-        <span>{% letter_avatar_svg author.get_display_name author.get_label size 48 %}</span>
+        <span>{% letter_avatar_svg author.get_display_name author.get_label size 48 use_svg False %}</span>
         <span>
           <img class="avatar" width="48" height="48" src="{% gravatar_url author.email size 96 default 'blank' %}">
         </span>
diff --git a/src/sentry/templates/sentry/emails/email-styles.html b/src/sentry/templates/sentry/emails/email-styles.html
index 3766114625..524e3a9547 100644
--- a/src/sentry/templates/sentry/emails/email-styles.html
+++ b/src/sentry/templates/sentry/emails/email-styles.html
@@ -413,9 +413,16 @@
     display: inline-block;
     vertical-align: bottom;
   }
-  .avatar {
+  .avatar,
+  .html-avatar {
     border-radius: 3px;
   }
+  .html-avatar {
+    display: inline-block;
+    text-align: center;
+    vertical-align: middle;
+    color: #fff;
+  }
 
   .inner table.reset {
     border-collapse: collapse;
diff --git a/src/sentry/templates/sentry/partial/interfaces/user_email.html b/src/sentry/templates/sentry/partial/interfaces/user_email.html
index 517d4fe169..48a07f24b1 100644
--- a/src/sentry/templates/sentry/partial/interfaces/user_email.html
+++ b/src/sentry/templates/sentry/partial/interfaces/user_email.html
@@ -46,7 +46,7 @@
     {% if user_email %}
       <td style="padding-top:5px; width:64px; vertical-align:top; text-align: right;">
         <span class="avatar-container" style="width: inherit;">
-          {% letter_avatar_svg user.get_display_name user.get_label %}
+          {% letter_avatar_svg user.get_display_name user.get_label size 64 use_svg False %}
           <img src="{% gravatar_url user_email size 64 default 'blank' %}" style="border-radius: 3px;">
         </span>
       </td>
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index f88a557ad7..4f2f787779 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -303,9 +303,10 @@ def gravatar_url(context, email, size=None, default='mm'):
 
 @tag(register, [Variable('display_name'),
                 Variable('identifier'),
-                Optional([Constant('size'), Variable('size')])])
-def letter_avatar_svg(context, display_name, identifier, size=None):
-    return get_letter_avatar(display_name, identifier, size=size)
+                Optional([Constant('size'), Variable('size')]),
+                Optional([Constant('use_svg'), Variable('use_svg')])])
+def letter_avatar_svg(context, display_name, identifier, size=None, use_svg=True):
+    return get_letter_avatar(display_name, identifier, size=size, use_svg=use_svg)
 
 
 @register.filter
diff --git a/src/sentry/utils/avatar.py b/src/sentry/utils/avatar.py
index 0cbba70272..90b449fd44 100644
--- a/src/sentry/utils/avatar.py
+++ b/src/sentry/utils/avatar.py
@@ -61,17 +61,29 @@ def get_letter_avatar_color(identifier):
     return LETTER_AVATAR_COLORS[hashed_id % COLOR_COUNT]
 
 
-def get_letter_avatar(display_name, identifier, size=None):
+def get_letter_avatar(display_name, identifier, size=None, use_svg=True):
     display_name = display_name or '?'
     names = display_name.split(' ')
     initials = '%s%s' % (names[0][0], names[-1][0] if len(names) > 1 else '')
     initials = escape(initials.upper())
     color = get_letter_avatar_color(identifier)
-    size_attrs = 'height="%s" width="%s"' % (size, size) if size else ''
-    return (
-        u'<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" {size_attrs}>'
-        '<rect x="0" y="0" width="120" height="120" rx="15" ry="15" fill={color}></rect>'
-        '<text x="50%" y="50%" font-size="65" dominant-baseline="central" text-anchor="middle" fill="#FFFFFF">'
-        '{initials}'
-        '</text>'
-        '</svg>').format(color=color, initials=initials, size_attrs=size_attrs)
+    if use_svg:
+        size_attrs = 'height="%s" width="%s"' % (size, size) if size else ''
+        return (
+            u'<svg viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg" {size_attrs}>'
+            '<rect x="0" y="0" width="120" height="120" rx="15" ry="15" fill={color}></rect>'
+            '<text x="50%" y="50%" font-size="65" dominant-baseline="central" text-anchor="middle" fill="#FFFFFF">'
+            '{initials}'
+            '</text>'
+            '</svg>').format(color=color, initials=initials, size_attrs=size_attrs)
+    else:
+        size_attrs = 'height:%spx;width:%spx;' % (size, size) if size else ''
+        font_size = 'font-size:%spx;' % (size / 2) if size else ''
+        line_height = 'line-height:%spx;' % size if size else ''
+        return (
+            u'<span class="html-avatar" '
+            'style="background-color:{color};{size_attrs}{font_size}{line_height}">'
+            '{initials}</span>').format(color=color, initials=initials,
+                                        size_attrs=size_attrs, font_size=font_size,
+                                        line_height=line_height)
+
