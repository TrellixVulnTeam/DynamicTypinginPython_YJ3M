commit 67aaaa349f44c87daa8bb8fe38e77fddf7d33533
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Sat May 14 15:22:03 2016 +0200

    Added warning for missing 2fa backup methods

diff --git a/src/sentry/models/authenticator.py b/src/sentry/models/authenticator.py
index 0bd84937a2..509206586a 100644
--- a/src/sentry/models/authenticator.py
+++ b/src/sentry/models/authenticator.py
@@ -34,6 +34,14 @@ class AuthenticatorManager(BaseManager):
             rvm.pop(iface.interface_id, None)
         return _sort(rv), _sort([x() for x in rvm.values()])
 
+    def is_missing_backup_interfaces(self, user):
+        has_authenticators = False
+        for authenticator in Authenticator.objects.filter(user=user):
+            if authenticator.interface.backup_interface:
+                return True
+            has_authenticators = True
+        return has_authenticators
+
     def get_interface(self, user, interface_id):
         interface = AUTHENTICATOR_INTERFACES.get(interface_id)
         if interface is None:
diff --git a/src/sentry/templates/sentry/account/twofactor.html b/src/sentry/templates/sentry/account/twofactor.html
index 24565e0997..6debe2e43e 100644
--- a/src/sentry/templates/sentry/account/twofactor.html
+++ b/src/sentry/templates/sentry/account/twofactor.html
@@ -1,13 +1,12 @@
-{% extends "sentry/bases/account.html" %}
+{% extends "sentry/bases/twofactor_settings.html" %}
 
 {% load i18n %}
 {% load sentry_helpers %}
 
-{% block title %}{% trans "Two-Factor Authentication Settings" %} | {{ block.super }}{% endblock %}
-
-{% block main %}
-  <legend style="margin-top: 0;">{% trans "Two-Factor Authentication" %}</legend>
+{% block title %}{% trans "Two-Factor Authentication" %} | {{ block.super }}{% endblock %}
 
+{% block twofactor_title %}{% trans "Two-Factor Authentication" %}{% endblock %}
+{% block twofactor_body %}
   <p>
     Two-factor authentication improves your security by requiring an authentication
     code in addition to your password.
diff --git a/src/sentry/templates/sentry/bases/twofactor_settings.html b/src/sentry/templates/sentry/bases/twofactor_settings.html
index 66edc3dc3f..34e71182f2 100644
--- a/src/sentry/templates/sentry/bases/twofactor_settings.html
+++ b/src/sentry/templates/sentry/bases/twofactor_settings.html
@@ -7,5 +7,13 @@
 
 {% block main %}
   <legend style="margin-top: 0;">{% block twofactor_title %}{% trans "Method:" %} {{ auth.name }}{% endblock %}</legend>
+  {% if is_missing_backup_interfaces %}
+    <div class="alert alert-warning">
+      <strong>Warning:</strong>
+      You do not have a backup authenticator enabled.
+      <a href="{% url 'sentry-account-settings-2fa-recovery' %}">Click here to add recovery codes</a>.
+    </div>
+  {% endif %}
+
   {% block twofactor_body %}{% endblock %}
 {% endblock %}
diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index f06d3e8e42..b30c17ce39 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -156,6 +156,8 @@ def twofactor_settings(request):
         'has_2fa': len(active) > 0,
         'active_authenticators': active,
         'missing_authenticators': missing,
+        'is_missing_backup_interfaces':
+            Authenticator.objects.is_missing_backup_interfaces(request.user)
     })
     return render_to_response('sentry/account/twofactor.html', context, request)
 
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index 3715cb3d15..bb24de102e 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -35,6 +35,8 @@ class TwoFactorSettingsView(BaseView):
         context = csrf(request)
         context['auth'] = interface
         context['page'] = 'settings'
+        context['is_missing_backup_interfaces'] = \
+            Authenticator.objects.is_missing_backup_interfaces(request.user)
         return context
 
     def delete_authenticator(self, interface):
