commit 658b6767b2a653cbef705b9474af022e25627675
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Jan 18 14:31:09 2018 -0800

    feat(tags): Add protected tags to API to prevent deletion (#6998)

diff --git a/src/sentry/api/endpoints/project_tagkey_details.py b/src/sentry/api/endpoints/project_tagkey_details.py
index 53bfa94f47..44a4e412f8 100644
--- a/src/sentry/api/endpoints/project_tagkey_details.py
+++ b/src/sentry/api/endpoints/project_tagkey_details.py
@@ -7,6 +7,7 @@ from sentry.api.base import EnvironmentMixin
 from sentry.api.bases.project import ProjectEndpoint
 from sentry.api.exceptions import ResourceDoesNotExist
 from sentry.api.serializers import serialize
+from sentry.constants import PROTECTED_TAG_KEYS
 from sentry.models import AuditLogEntryEvent, Environment
 
 
@@ -34,6 +35,9 @@ class ProjectTagKeyDetailsEndpoint(ProjectEndpoint, EnvironmentMixin):
             {method} {path}
 
         """
+        if key in PROTECTED_TAG_KEYS:
+            return Response(status=403)
+
         lookup_key = tagstore.prefix_reserved_key(key)
 
         try:
diff --git a/src/sentry/api/endpoints/project_tags.py b/src/sentry/api/endpoints/project_tags.py
index d0e115084b..2c809279ef 100644
--- a/src/sentry/api/endpoints/project_tags.py
+++ b/src/sentry/api/endpoints/project_tags.py
@@ -7,6 +7,7 @@ from rest_framework.response import Response
 from sentry import tagstore
 from sentry.api.base import EnvironmentMixin
 from sentry.api.bases.project import ProjectEndpoint
+from sentry.constants import PROTECTED_TAG_KEYS
 from sentry.models import Environment
 
 
@@ -32,6 +33,7 @@ class ProjectTagsEndpoint(ProjectEndpoint, EnvironmentMixin):
                     'key': tagstore.get_standardized_key(tag_key.key),
                     'name': tagstore.get_tag_key_label(tag_key.key),
                     'uniqueValues': tag_key.values_seen,
+                    'canDelete': tag_key.key not in PROTECTED_TAG_KEYS,
                 }
             )
 
diff --git a/src/sentry/constants.py b/src/sentry/constants.py
index d7f7fbc97b..def6c65b27 100644
--- a/src/sentry/constants.py
+++ b/src/sentry/constants.py
@@ -125,6 +125,12 @@ TAG_LABELS = {
     'server_name': 'Server',
 }
 
+PROTECTED_TAG_KEYS = frozenset([
+    'environment',
+    'release',
+    'sentry:release',
+])
+
 # TODO(dcramer): once this is more flushed out we want this to be extendable
 SENTRY_RULES = (
     'sentry.rules.actions.notify_event.NotifyEventAction',
diff --git a/tests/sentry/api/endpoints/test_project_tagkey_details.py b/tests/sentry/api/endpoints/test_project_tagkey_details.py
index 6d0f963127..54606bfcc8 100644
--- a/tests/sentry/api/endpoints/test_project_tagkey_details.py
+++ b/tests/sentry/api/endpoints/test_project_tagkey_details.py
@@ -76,3 +76,34 @@ class ProjectTagKeyDeleteTest(APITestCase):
             tagkey.key,
             status=TagKeyStatus.PENDING_DELETION
         ).status == TagKeyStatus.PENDING_DELETION
+
+    @mock.patch('sentry.tagstore.tasks.delete_tag_key')
+    def test_protected(self, mock_delete_tag_key):
+        project = self.create_project()
+        tagkey = tagstore.create_tag_key(
+            project_id=project.id,
+            environment_id=None,
+            key='environment')
+
+        self.login_as(user=self.user)
+
+        url = reverse(
+            'sentry-api-0-project-tagkey-details',
+            kwargs={
+                'organization_slug': project.organization.slug,
+                'project_slug': project.slug,
+                'key': tagkey.key,
+            }
+        )
+
+        response = self.client.delete(url)
+
+        assert response.status_code == 403
+        assert mock_delete_tag_key.delay.call_count == 0
+
+        assert tagstore.get_tag_key(
+            project.id,
+            None,  # environment_id
+            tagkey.key,
+            status=TagKeyStatus.VISIBLE
+        ).status == TagKeyStatus.VISIBLE
diff --git a/tests/sentry/api/endpoints/test_project_tags.py b/tests/sentry/api/endpoints/test_project_tags.py
index ad4f00b594..432d7ae000 100644
--- a/tests/sentry/api/endpoints/test_project_tags.py
+++ b/tests/sentry/api/endpoints/test_project_tags.py
@@ -10,7 +10,7 @@ class ProjectTagsTest(APITestCase):
     def test_simple(self):
         project = self.create_project()
 
-        for key in ('foo', 'bar'):
+        for key in ('foo', 'bar', 'environment'):
             tagstore.create_tag_key(
                 project_id=project.id,
                 environment_id=None,
@@ -28,4 +28,9 @@ class ProjectTagsTest(APITestCase):
         )
         response = self.client.get(url, format='json')
         assert response.status_code == 200, response.content
-        assert len(response.data) == 2
+        data = {v['key']: v for v in response.data}
+        assert len(data) == 3
+
+        data['foo']['canDelete'] is True
+        data['bar']['canDelete'] is True
+        data['environment']['canDelete'] is False
