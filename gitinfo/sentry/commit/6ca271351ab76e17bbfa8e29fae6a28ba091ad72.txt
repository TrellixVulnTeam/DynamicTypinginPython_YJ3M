commit 6ca271351ab76e17bbfa8e29fae6a28ba091ad72
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Wed Mar 7 18:03:02 2018 -0800

    fix(tagstore): TagValue.key shortcut needs to include partition key
    
    Fixes SENTRY-620

diff --git a/src/sentry/receivers/releases.py b/src/sentry/receivers/releases.py
index f1f9d79c79..1c80e6945e 100644
--- a/src/sentry/receivers/releases.py
+++ b/src/sentry/receivers/releases.py
@@ -16,7 +16,7 @@ def ensure_release_exists(instance, created, **kwargs):
     if instance.data and instance.data.get('release_id'):
         return
 
-    project = Project.objects.get(pk=instance.project_id)
+    project = Project.objects.get_from_cache(id=instance.project_id)
 
     try:
         with transaction.atomic():
@@ -32,7 +32,12 @@ def ensure_release_exists(instance, created, **kwargs):
         )
         release.update(date_added=instance.first_seen)
     else:
-        instance.update(data={'release_id': release.id})
+        # Make sure we use our partition key since `instance` is a
+        # `TagValue`.
+        type(instance).objects.filter(
+            id=instance.id,
+            project_id=instance.project_id,
+        ).update(data={'release_id': release.id})
 
     release.add_project(project)
 
diff --git a/src/sentry/tagstore/v2/models/tagvalue.py b/src/sentry/tagstore/v2/models/tagvalue.py
index 86d6e69bea..a4ee0242ec 100644
--- a/src/sentry/tagstore/v2/models/tagvalue.py
+++ b/src/sentry/tagstore/v2/models/tagvalue.py
@@ -47,7 +47,11 @@ class TagValue(Model):
 
     @property
     def key(self):
-        return self._key.key
+        from sentry.tagstore.v2.models import TagKey
+        return TagKey.objects.filter(
+            project_id=self.project_id,
+            id=self._key_id,
+        ).values_list('key', flat=True).get()
 
     def get_label(self):
         from sentry import tagstore
