commit 4ab7eb4d62a7e37fd68d41e0de1587693f5767b1
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Feb 16 14:42:15 2017 -0800

    Change return type from `features.query`. (#4926)

diff --git a/src/sentry/similarity.py b/src/sentry/similarity.py
index 519fdd3667..3300d41410 100644
--- a/src/sentry/similarity.py
+++ b/src/sentry/similarity.py
@@ -465,22 +465,27 @@ class FeatureSet(object):
         return self.index.record_multi(items)
 
     def query(self, group):
-        results = {}
         key = self.__number_format.pack(group.id)
+
+        results = {}
         for label in self.features.keys():
             alias = self.aliases[label]
             scope = ':'.join((
                 alias,
-                self.__number_format.pack(group.project_id)
+                self.__number_format.pack(group.project_id),
             ))
-            results[label] = map(
-                lambda (id, score): (
+
+            for id, score in self.index.query(scope, key):
+                results.setdefault(
                     self.__number_format.unpack(id)[0],
-                    score,
-                ),
-                self.index.query(scope, key)
-            )
-        return results
+                    {},
+                )[label] = score
+
+        return sorted(
+            results.items(),
+            key=lambda (id, features): sum(features.values()),
+            reverse=True,
+        )
 
 
 def serialize_text_shingle(value, separator=b''):
