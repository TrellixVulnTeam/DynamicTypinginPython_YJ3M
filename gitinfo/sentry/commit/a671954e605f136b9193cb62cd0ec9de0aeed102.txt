commit a671954e605f136b9193cb62cd0ec9de0aeed102
Author: evanh <evanh@users.noreply.github.com>
Date:   Thu Jan 30 11:13:04 2020 -0500

    fix(user_reports) Add a migration to backfill all user report data (#16603)
    
    Add a migration that runs through all user reports that are missing group and
    environment, and add the event data to the user report if we can find the event.

diff --git a/src/sentry/migrations/0028_user_reports.py b/src/sentry/migrations/0028_user_reports.py
new file mode 100644
index 0000000000..a7f89f41a8
--- /dev/null
+++ b/src/sentry/migrations/0028_user_reports.py
@@ -0,0 +1,47 @@
+# -*- coding: utf-8 -*-
+# Generated by Django 1.11.27 on 2020-01-23 19:07
+from __future__ import unicode_literals
+
+from django.db import migrations
+
+from sentry import eventstore
+from sentry.utils.query import RangeQuerySetWrapper
+
+
+def backfill_user_reports(apps, schema_editor):
+    """
+    Processes user reports that are missing event data, and adds the appropriate data
+    if the event exists in Clickhouse.
+    """
+    UserReport = apps.get_model("sentry", "UserReport")
+
+    user_reports = UserReport.objects.filter(group__isnull=True, environment__isnull=True)
+
+    for report in RangeQuerySetWrapper(user_reports, step=1000):
+        event = eventstore.get_event_by_id(report.project_id, report.event_id)
+        if event:
+            report.update(group_id=event.group_id, environment=event.get_environment())
+
+
+class Migration(migrations.Migration):
+    # This flag is used to mark that a migration shouldn't be automatically run in
+    # production. We set this to True for operations that we think are risky and want
+    # someone from ops to run manually and monitor.
+    # General advice is that if in doubt, mark your migration as `is_dangerous`.
+    # Some things you should always mark as dangerous:
+    # - Adding indexes to large tables. These indexes should be created concurrently,
+    #   unfortunately we can't run migrations outside of a transaction until Django
+    #   1.10. So until then these should be run manually.
+    # - Large data migrations. Typically we want these to be run manually by ops so that
+    #   they can be monitored. Since data migrations will now hold a transaction open
+    #   this is even more important.
+    # - Adding columns to highly active tables, even ones that are NULL.
+    is_dangerous = True
+
+    dependencies = [
+        ("sentry", "0027_exporteddata"),
+    ]
+
+    operations = [
+        migrations.RunPython(backfill_user_reports, migrations.RunPython.noop),
+    ]
