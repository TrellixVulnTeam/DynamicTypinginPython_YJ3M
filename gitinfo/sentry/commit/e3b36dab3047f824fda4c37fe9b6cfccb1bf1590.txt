commit e3b36dab3047f824fda4c37fe9b6cfccb1bf1590
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Tue Mar 27 15:13:06 2018 -0700

    fix(ui): Make sure remote image size >= requested size (#7807)

diff --git a/src/sentry/static/sentry/app/components/avatar/baseAvatar.jsx b/src/sentry/static/sentry/app/components/avatar/baseAvatar.jsx
index 2ffa1f8708..ddd8d16ff1 100644
--- a/src/sentry/static/sentry/app/components/avatar/baseAvatar.jsx
+++ b/src/sentry/static/sentry/app/components/avatar/baseAvatar.jsx
@@ -1,4 +1,3 @@
-import {sortedIndexOf} from 'lodash';
 import MD5 from 'crypto-js/md5';
 import PropTypes from 'prop-types';
 import React from 'react';
@@ -47,12 +46,14 @@ class BaseAvatar extends React.Component {
 
   getRemoteImageSize = () => {
     let {remoteImageSize, size} = this.props;
-
-    return (
-      remoteImageSize ||
-      (size && ALLOWED_SIZES[sortedIndexOf(ALLOWED_SIZES, size)]) ||
-      DEFAULT_GRAVATAR_SIZE
-    );
+    // Try to make sure remote image size is >= requested size
+    // If requested size > allowed size then use the largest allowed size
+    let allowed =
+      size &&
+      (ALLOWED_SIZES.find(allowedSize => allowedSize >= size) ||
+        ALLOWED_SIZES[ALLOWED_SIZES.length - 1]);
+
+    return remoteImageSize || allowed || DEFAULT_GRAVATAR_SIZE;
   };
 
   buildGravatarUrl = () => {
diff --git a/tests/js/spec/components/avatar.spec.jsx b/tests/js/spec/components/avatar.spec.jsx
index c569a20369..685830e7ba 100644
--- a/tests/js/spec/components/avatar.spec.jsx
+++ b/tests/js/spec/components/avatar.spec.jsx
@@ -61,6 +61,34 @@ describe('Avatar', function() {
       );
     });
 
+    it('should show an upload with the correct size', function() {
+      let user = Object.assign({}, USER, {
+        avatar: {
+          avatarType: 'upload',
+          avatarUuid: '2d641b5d-8c74-44de-9cb6-fbd54701b35e',
+        },
+      });
+      let avatar = mount(<Avatar user={user} size={76} />);
+      expect(avatar.find('BaseAvatar img').prop('src')).toMatch(
+        '/avatar/2d641b5d-8c74-44de-9cb6-fbd54701b35e/?s=80'
+      );
+
+      avatar = mount(<Avatar user={user} size={121} />);
+      expect(avatar.find('BaseAvatar img').prop('src')).toMatch(
+        '/avatar/2d641b5d-8c74-44de-9cb6-fbd54701b35e/?s=120'
+      );
+
+      avatar = mount(<Avatar user={user} size={32} />);
+      expect(avatar.find('BaseAvatar img').prop('src')).toMatch(
+        '/avatar/2d641b5d-8c74-44de-9cb6-fbd54701b35e/?s=32'
+      );
+
+      avatar = mount(<Avatar user={user} size={1} />);
+      expect(avatar.find('BaseAvatar img').prop('src')).toMatch(
+        '/avatar/2d641b5d-8c74-44de-9cb6-fbd54701b35e/?s=20'
+      );
+    });
+
     it('should not show upload or gravatar when avatar type is letter', function() {
       let user = Object.assign({}, USER, {
         avatar: {
