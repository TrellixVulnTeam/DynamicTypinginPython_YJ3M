commit bee1b4b3e2173292c92edab3f7cd03123a20728f
Author: Jess MacQueen <jess@getsentry.com>
Date:   Mon Apr 18 17:08:14 2016 -0700

    fix formatting of avatars in emails

diff --git a/src/sentry/templates/sentry/emails/activity/assigned.html b/src/sentry/templates/sentry/emails/activity/assigned.html
index dfb01fa5aa..903b41f946 100644
--- a/src/sentry/templates/sentry/emails/activity/assigned.html
+++ b/src/sentry/templates/sentry/emails/activity/assigned.html
@@ -16,7 +16,7 @@
   <h2>Assigned</h2>
 
   <p>
-    <strong><span class="avatar-container">{% letter_avatar_svg author.get_display_name author.get_label size 20 use_svg False %}<img class="avatar" width="20" height="20" src="{% gravatar_url author.email size 40 default 'blank' %}"></span>{{ author.get_display_name }}</strong> assigned this issue to you in <strong>{{ group.organization.name }}/{{ group.project.name }}</strong>.
+    <strong><span class="avatar-container">{% email_avatar author.get_display_name author.get_label size 20 %}</span>{{ author.get_display_name }}</strong> assigned this issue to you in <strong>{{ group.organization.name }}/{{ group.project.name }}</strong>.
   </p>
 
   {% include "sentry/emails/group_header.html" %}
diff --git a/src/sentry/templates/sentry/emails/activity/note.html b/src/sentry/templates/sentry/emails/activity/note.html
index 6e56801511..0bcfc5b6b4 100644
--- a/src/sentry/templates/sentry/emails/activity/note.html
+++ b/src/sentry/templates/sentry/emails/activity/note.html
@@ -18,10 +18,7 @@
   <table class="note">
     <tr>
       <td class="avatar-column">
-        <span>{% letter_avatar_svg author.get_display_name author.get_label size 48 use_svg False %}</span>
-        <span>
-          <img class="avatar" width="48" height="48" src="{% gravatar_url author.email size 96 default 'blank' %}">
-        </span>
+        {% email_avatar author.get_display_name author.get_label size 48 %}
       </td>
       <td class="notch-column">
         <img width="7" height="48" src="{% absolute_asset_url 'sentry' 'images/email/avatar-notch.png' %}">
diff --git a/src/sentry/templates/sentry/emails/email-styles.html b/src/sentry/templates/sentry/emails/email-styles.html
index 524e3a9547..ec2ffec6a2 100644
--- a/src/sentry/templates/sentry/emails/email-styles.html
+++ b/src/sentry/templates/sentry/emails/email-styles.html
@@ -385,17 +385,14 @@
   .inner .note-body a {
     word-break: break-all;
   }
-  .avatar-column {
-    width: 60px;
-    vertical-align: top;
-    position: relative;
+
+  .avatar-column img,
+  .avatar-column span {
+    width: 48px;
+    height: 48px;
   }
-  .avatar-column span,
-  .avatar-container svg,
-  .avatar-container img {
-    position: absolute;
-    top: 0px;
-    left: 0px;
+  .avatar-column {
+    width: 64px;
   }
   .notch-column {
     width: 7px;
diff --git a/src/sentry/templates/sentry/partial/interfaces/user_email.html b/src/sentry/templates/sentry/partial/interfaces/user_email.html
index 48a07f24b1..01403c1fd2 100644
--- a/src/sentry/templates/sentry/partial/interfaces/user_email.html
+++ b/src/sentry/templates/sentry/partial/interfaces/user_email.html
@@ -46,8 +46,7 @@
     {% if user_email %}
       <td style="padding-top:5px; width:64px; vertical-align:top; text-align: right;">
         <span class="avatar-container" style="width: inherit;">
-          {% letter_avatar_svg user.get_display_name user.get_label size 64 use_svg False %}
-          <img src="{% gravatar_url user_email size 64 default 'blank' %}" style="border-radius: 3px;">
+          {% email_avatar user.get_display_name user.get_label size 64 %}
         </span>
       </td>
     {% endif %}
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index 4f2f787779..00b9be0bd0 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -38,7 +38,7 @@ from sentry.constants import EVENTS_PER_PAGE
 from sentry.models import Organization
 from sentry.utils import json
 from sentry.utils.strings import to_unicode
-from sentry.utils.avatar import get_gravatar_url, get_letter_avatar
+from sentry.utils.avatar import get_gravatar_url, get_email_avatar, get_letter_avatar
 from sentry.utils.javascript import to_json
 from sentry.utils.strings import (
     soft_break as _soft_break,
@@ -303,10 +303,18 @@ def gravatar_url(context, email, size=None, default='mm'):
 
 @tag(register, [Variable('display_name'),
                 Variable('identifier'),
-                Optional([Constant('size'), Variable('size')]),
-                Optional([Constant('use_svg'), Variable('use_svg')])])
-def letter_avatar_svg(context, display_name, identifier, size=None, use_svg=True):
-    return get_letter_avatar(display_name, identifier, size=size, use_svg=use_svg)
+                Optional([Constant('size'), Variable('size')])])
+def letter_avatar_svg(context, display_name, identifier, size=None):
+    return get_letter_avatar(display_name, identifier, size=size)
+
+
+# Don't use this in any situations where you're rendering more
+# than 1-2 avatars. It will make a request for every user!
+@tag(register, [Variable('display_name'),
+                Variable('identifier'),
+                Optional([Constant('size'), Variable('size')])])
+def email_avatar(context, display_name, identifier, size=None):
+    return get_email_avatar(display_name, identifier, size)
 
 
 @register.filter
diff --git a/src/sentry/utils/avatar.py b/src/sentry/utils/avatar.py
index 979be69007..0ea0ba59fe 100644
--- a/src/sentry/utils/avatar.py
+++ b/src/sentry/utils/avatar.py
@@ -10,9 +10,12 @@ selected, the svg, etc) will also need to be changed there.
 """
 from __future__ import absolute_import
 
+import requests
 import urllib
 
 from django.conf import settings
+from django.core.exceptions import ValidationError
+from django.core.validators import validate_email
 from django.utils.encoding import force_text
 from django.utils.html import escape
 
@@ -88,3 +91,17 @@ def get_letter_avatar(display_name, identifier, size=None, use_svg=True):
             '{initials}</span>').format(color=color, initials=initials,
                                         size_attrs=size_attrs, font_size=font_size,
                                         line_height=line_height)
+
+
+def get_email_avatar(display_name, identifier, size=None):
+    try:
+        validate_email(identifier)
+    except ValidationError:
+        pass
+    else:
+        resp = requests.get(get_gravatar_url(identifier, default=404))
+        if resp.status_code == 200:
+            # default to mm if including in emails
+            gravatar_url = get_gravatar_url(identifier, size=size)
+            return u'<img class="avatar" src="{url}">'.format(url=gravatar_url)
+    return get_letter_avatar(display_name, identifier, size, use_svg=False)
