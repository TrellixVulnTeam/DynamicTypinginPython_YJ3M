commit dbe7a9263ff49c0d41566f7475636b8498624c5e
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Feb 4 00:12:43 2012 -0800

    More fixes for queueing

diff --git a/sentry/manager.py b/sentry/manager.py
index e22f6e1d98..ae670a7fa5 100644
--- a/sentry/manager.py
+++ b/sentry/manager.py
@@ -27,6 +27,7 @@ from sentry.utils.charts import has_charts
 from sentry.utils.compat.db import connections
 from sentry.utils.dates import utc_to_local
 from sentry.queue.client import delay
+from sentry.queue.tasks.index import index_event
 
 logger = logging.getLogger('sentry.errors')
 
@@ -344,10 +345,11 @@ class GroupManager(models.Manager, ChartMixin):
 
         if settings.USE_SEARCH:
             try:
-                delay(SearchDocument.objects.index, event)
+                delay(index_event, event)
             except Exception, e:
                 transaction.rollback_unless_managed(using=group._state.db)
                 logger.exception(u'Error indexing document: %s', e)
+                import traceback; traceback.print_exc()
 
         if is_new:
             try:
diff --git a/sentry/queue/client.py b/sentry/queue/client.py
index a4b0adddae..07c862e023 100644
--- a/sentry/queue/client.py
+++ b/sentry/queue/client.py
@@ -28,6 +28,8 @@ class Broker(object):
         with producers[self.connection].acquire(block=False) as producer:
             for queue in task_queues:
                 maybe_declare(queue, producer.channel)
+
+        return self._connection
     connection = property(_get_connection)
 
     def delay(self, func, *args, **kwargs):
diff --git a/sentry/queue/tasks.py b/sentry/queue/tasks.py
deleted file mode 100644
index e217eb8f7c..0000000000
--- a/sentry/queue/tasks.py
+++ /dev/null
@@ -1,3 +0,0 @@
-def test(*args, **kwargs):
-    print args, kwargs
-    raise
diff --git a/sentry/queue/tasks/index.py b/sentry/queue/tasks/index.py
new file mode 100644
index 0000000000..96fe5db418
--- /dev/null
+++ b/sentry/queue/tasks/index.py
@@ -0,0 +1,4 @@
+def index_event(event, **kwargs):
+    from sentry.models import SearchDocument
+
+    SearchDocument.objects.index(event)
diff --git a/setup.py b/setup.py
index 2a4c13d174..252d183dfd 100755
--- a/setup.py
+++ b/setup.py
@@ -45,7 +45,7 @@ install_requires = [
 
 setup(
     name='sentry',
-    version='2.4.6',
+    version='2.4.7',
     author='David Cramer',
     author_email='dcramer@gmail.com',
     url='http://github.com/dcramer/sentry',
