commit 0c208fddf45c2479f2a20d99e78dff70ff31ffe0
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Thu Mar 28 16:17:26 2019 +0100

    feat: More event size metrics (#12571)
    
    * feat: More event size metrics
    
    * fix: Remove broken node_size metric
    
    * fix: Do not attempt to serialize CanonicalKeyDict

diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index dcc30f7d26..6051be6fcb 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -976,6 +976,12 @@ class EventManager(object):
             },
         )
 
+        metrics.timing(
+            'events.size.data.post_save',
+            event.size,
+            tags={'project_id': project.id}
+        )
+
         return event
 
     def _get_event_user(self, project, data):
diff --git a/src/sentry/models/event.py b/src/sentry/models/event.py
index e8214333ae..2790a376b4 100644
--- a/src/sentry/models/event.py
+++ b/src/sentry/models/event.py
@@ -34,7 +34,7 @@ from sentry.db.models import (
 )
 from sentry.db.models.manager import EventManager, SnubaEventManager
 from sentry.interfaces.base import get_interfaces
-from sentry.utils import metrics
+from sentry.utils import json, metrics
 from sentry.utils.cache import memoize
 from sentry.utils.canonical import CanonicalKeyDict, CanonicalKeyView
 from sentry.utils.safe import get_path
@@ -292,10 +292,7 @@ class EventCommon(object):
 
     @property
     def size(self):
-        data_len = 0
-        for value in six.itervalues(self.data):
-            data_len += len(repr(value))
-        return data_len
+        return len(json.dumps(dict(self.data)))
 
     @property
     def transaction(self):
diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index 5702697b25..dc794956a8 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -557,6 +557,12 @@ class StoreView(APIView):
             metrics.timing('events.size.rejected', data_size)
             raise APIForbidden("Event size exceeded 10MB after normalization.")
 
+        metrics.timing(
+            'events.size.data.post_storeendpoint',
+            data_size,
+            tags={'project_id': project.id}
+        )
+
         return process_event(event_manager, project,
                              key, remote_addr, helper, attachments)
 
