commit eef15aae3f9999dc5449ca73e80df49dc280fe77
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Tue Oct 22 11:16:33 2019 +0200

    fix: Do not crash on missing project ID in outcome (#15213)

diff --git a/src/sentry/ingest/outcomes_consumer.py b/src/sentry/ingest/outcomes_consumer.py
index ffc3a2ba10..c795dfd4bf 100644
--- a/src/sentry/ingest/outcomes_consumer.py
+++ b/src/sentry/ingest/outcomes_consumer.py
@@ -85,6 +85,9 @@ def _process_signal(msg):
         return  # nothing to do here
 
     event_id = msg.get("event_id")
+    if not event_id:
+        return
+
     if is_signal_sent(project_id=project_id, event_id=event_id):
         return  # message already processed nothing left to do
 
@@ -127,6 +130,9 @@ def _process_tsdb_batch(batch):
         project_id = int(msg.get("project_id") or 0) or None
         event_id = msg.get("event_id")
 
+        if not project_id or not event_id:
+            continue
+
         if is_tsdb_incremented(project_id, event_id):
             continue
 
diff --git a/src/sentry/utils/outcomes.py b/src/sentry/utils/outcomes.py
index 56b5b6ff50..097e6d5aa3 100644
--- a/src/sentry/utils/outcomes.py
+++ b/src/sentry/utils/outcomes.py
@@ -133,7 +133,8 @@ def track_outcome(org_id, project_id, key_id, outcome, reason=None, timestamp=No
         if increment_list:
             tsdb.incr_multi(increment_list, timestamp=timestamp)
 
-        mark_tsdb_incremented(project_id, event_id)
+        if project_id and event_id:
+            mark_tsdb_incremented(project_id, event_id)
 
     # Send a snuba metrics payload.
     outcomes_publisher.publish(
