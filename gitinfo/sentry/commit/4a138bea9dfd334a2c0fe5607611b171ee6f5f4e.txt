commit 4a138bea9dfd334a2c0fe5607611b171ee6f5f4e
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Thu Nov 22 11:18:27 2018 +0100

    fix: Crash when generating relay PII config (#10716)
    
    * fix: Crash when generating relay PII config
    
    * fix: Add tag for project

diff --git a/src/sentry/relay/config.py b/src/sentry/relay/config.py
index 989ed51775..fcb46b5016 100644
--- a/src/sentry/relay/config.py
+++ b/src/sentry/relay/config.py
@@ -9,6 +9,7 @@ from datetime import datetime
 from pytz import utc
 
 from sentry.models import ProjectKey, OrganizationOption
+from sentry.utils.sdk import configure_scope
 
 
 def _generate_pii_config(project, org_options):
@@ -41,10 +42,10 @@ def _generate_pii_config(project, org_options):
                 'redaction': 'remove',
                 'keyPattern': r'\b%s\n' % '|'.join(re.escape(x) for x in fields),
             }
-            databag_rules.push('strip-fields')
+            databag_rules.append('strip-fields')
 
     if scrub_ip_address:
-        ip_rules.push('@ip')
+        ip_rules.append('@ip')
 
     return {
         'rules': custom_rules,
@@ -70,6 +71,10 @@ def get_pii_config(project, org_options):
 
 def get_project_options(project):
     """Returns a dict containing the config for a project for the sentry relay"""
+
+    with configure_scope() as scope:
+        scope.set_tag("project", project.id)
+
     project_keys = ProjectKey.objects.filter(
         project=project,
     ).all()
diff --git a/tests/sentry/api/endpoints/test_relay_projectconfigs.py b/tests/sentry/api/endpoints/test_relay_projectconfigs.py
index b1b2bc9047..646d44d9e6 100644
--- a/tests/sentry/api/endpoints/test_relay_projectconfigs.py
+++ b/tests/sentry/api/endpoints/test_relay_projectconfigs.py
@@ -30,6 +30,7 @@ class RelayQueryGetProjectConfigTest(APITestCase):
         )
 
         self.project = self.create_project()
+        self.project.update_option('sentry:scrub_ip_address', True)
         self.path = reverse(
             'sentry-api-0-relay-projectconfigs'
         )
