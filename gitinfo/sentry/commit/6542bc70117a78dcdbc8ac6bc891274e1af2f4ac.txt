commit 6542bc70117a78dcdbc8ac6bc891274e1af2f4ac
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Feb 14 11:12:53 2019 -0800

    fix(tagstore): Return TagKey instance from delete_tag_key (#12064)
    
    This enables the deletions to be written to the audit log.
    
    This wasn't working earlier since GH-8270 only changed the return types
    of the read interface (tag deletions for legacy and v2 were still
    returning model instances.) The result value of this method was later
    mistakenly diagnosed as unused in GH-11903.
    
    Fixes SENTRY-9GS.

diff --git a/src/sentry/api/endpoints/project_tagkey_details.py b/src/sentry/api/endpoints/project_tagkey_details.py
index ad3c01f847..c11987b286 100644
--- a/src/sentry/api/endpoints/project_tagkey_details.py
+++ b/src/sentry/api/endpoints/project_tagkey_details.py
@@ -59,7 +59,7 @@ class ProjectTagKeyDetailsEndpoint(ProjectEndpoint, EnvironmentMixin):
             self.create_audit_entry(
                 request=request,
                 organization=project.organization,
-                target_object=tagkey.id,
+                target_object=getattr(tagkey, 'id', None),
                 event=AuditLogEntryEvent.TAGKEY_REMOVE,
                 data=tagkey.get_audit_log_data(),
             )
diff --git a/src/sentry/tagstore/snuba/backend.py b/src/sentry/tagstore/snuba/backend.py
index 527a79df1d..a47ad3fe2d 100644
--- a/src/sentry/tagstore/snuba/backend.py
+++ b/src/sentry/tagstore/snuba/backend.py
@@ -749,8 +749,17 @@ class SnubaCompatibilityTagStorage(SnubaTagStorage):
 
     def delete_tag_key(self, project_id, key):
         # Called by ``ProjectTagKeyDetailsEndpoint.delete``. The return value
-        # is not used.
-        pass
+        # is used for audit logging.
+        try:
+            return [
+                self.get_tag_key(
+                    project_id=project_id,
+                    key=key,
+                    environment_id=None,
+                ),
+            ]
+        except TagKeyNotFound:
+            return []
 
     def incr_tag_value_times_seen(self, project_id, environment_id,
                                   key, value, extra=None, count=1):
diff --git a/src/sentry/tagstore/types.py b/src/sentry/tagstore/types.py
index 8bdade56d5..fbc2e87e8e 100644
--- a/src/sentry/tagstore/types.py
+++ b/src/sentry/tagstore/types.py
@@ -37,6 +37,11 @@ class TagKey(TagType):
         self.count = count
         self.top_values = top_values
 
+    def get_audit_log_data(self):
+        return {
+            'key': self.key,
+        }
+
 
 class TagValue(TagType):
     __slots__ = ['key', 'value', 'times_seen', 'first_seen', 'last_seen']
