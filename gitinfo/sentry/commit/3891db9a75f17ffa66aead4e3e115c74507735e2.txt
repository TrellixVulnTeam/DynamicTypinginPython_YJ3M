commit 3891db9a75f17ffa66aead4e3e115c74507735e2
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 16 00:24:38 2014 -0800

    Slightly better pattern matching

diff --git a/src/sentry/interfaces.py b/src/sentry/interfaces.py
index 91aa63f743..4391d9a036 100644
--- a/src/sentry/interfaces.py
+++ b/src/sentry/interfaces.py
@@ -31,8 +31,8 @@ from sentry.utils.strings import strip
 from sentry.web.helpers import render_to_string
 
 _Exception = Exception
-_ruby_anon_func = re.compile(r'(?:_(\d{2,}))')
-_filename_version_re = re.compile(r"""/?(
+_ruby_anon_func = re.compile(r'_(?:\d{2,})')
+_filename_version_re = re.compile(r"""(?:
     v?(?:\d+\.)*\d+|   # version numbers, v1, 1.0.0
     [a-f0-9]{7,8}|     # short sha
     [a-f0-9]{32}|      # md5
@@ -60,7 +60,7 @@ def remove_function_outliers(function):
     """
     if function.startswith('block '):
         return 'block'
-    return _ruby_anon_func.sub('<anon>', function)
+    return _ruby_anon_func.sub('_<anon>', function)
 
 
 def remove_filename_outliers(filename):
@@ -69,7 +69,7 @@ def remove_filename_outliers(filename):
 
     - Sometimes filename paths contain build numbers
     """
-    return _filename_version_re.sub('<version>', filename)
+    return _filename_version_re.sub('<version>/', filename)
 
 
 def get_context(lineno, context_line, pre_context=None, post_context=None, filename=None,
diff --git a/tests/sentry/interfaces/stacktrace/tests.py b/tests/sentry/interfaces/stacktrace/tests.py
index 2e9ef6fc83..cd9730514b 100644
--- a/tests/sentry/interfaces/stacktrace/tests.py
+++ b/tests/sentry/interfaces/stacktrace/tests.py
@@ -115,7 +115,7 @@ class StacktraceTest(TestCase):
         }])
         result = interface.get_hash()
         self.assertEquals(result, [
-            '/data/foo/releases<version>app/views/foo.html.erb',
+            '/data/foo/releases/<version>/app/views/foo.html.erb',
             '<% if @hotels.size > 0 %>',
         ])
 
@@ -125,7 +125,7 @@ class StacktraceTest(TestCase):
         }])
         result = interface.get_hash()
         self.assertEquals(result, [
-            '<version>app/views/foo.html.erb',
+            '<version>/app/views/foo.html.erb',
             '<% if @hotels.size > 0 %>',
         ])
 
@@ -137,7 +137,7 @@ class StacktraceTest(TestCase):
         }])
         result = interface.get_hash()
         self.assertEquals(result, [
-            'foo.html.erb', '_foo_html_erb_<anon><anon>',
+            'foo.html.erb', '_foo_html_erb__<anon>_<anon>',
         ])
 
     def test_get_hash_ignores_filename_if_http(self):
