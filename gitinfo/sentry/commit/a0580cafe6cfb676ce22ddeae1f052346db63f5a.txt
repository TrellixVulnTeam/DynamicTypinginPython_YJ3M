commit a0580cafe6cfb676ce22ddeae1f052346db63f5a
Author: Mark Story <mark@mark-story.com>
Date:   Fri Dec 7 10:08:39 2018 -0500

    fix(integrations) Give better error messages when creation fails (#10957)
    
    When an unprivileged user attempts to complete the integration setup, we
    can use the error message from Jira to give a better error message to
    the user.
    
    Fixes APP-873

diff --git a/src/sentry/integrations/jira_server/integration.py b/src/sentry/integrations/jira_server/integration.py
index 49df796bba..c64f388a77 100644
--- a/src/sentry/integrations/jira_server/integration.py
+++ b/src/sentry/integrations/jira_server/integration.py
@@ -310,4 +310,9 @@ class JiraServerIntegrationProvider(IntegrationProvider):
                 'error': six.text_type(err),
                 'external_id': external_id,
             })
-            raise IntegrationError('Could not create issue webhook in Jira')
+            try:
+                details = err.json['messages'][0].values().pop()
+            except Exception:
+                details = ''
+            message = u'Could not create issue webhook in Jira. {}'.format(details)
+            raise IntegrationError(message)
diff --git a/tests/sentry/integrations/jira_server/test_integration.py b/tests/sentry/integrations/jira_server/test_integration.py
index ae265d75c2..d0a3423651 100644
--- a/tests/sentry/integrations/jira_server/test_integration.py
+++ b/tests/sentry/integrations/jira_server/test_integration.py
@@ -276,3 +276,33 @@ class JiraServerIntegrationTest(IntegrationTestCase):
         self.assertContains(resp, 'webhook')
 
         assert Integration.objects.count() == 0
+
+    @responses.activate
+    def test_setup_create_webhook_failure_forbidden(self):
+        responses.add(
+            responses.POST,
+            'https://jira.example.com/plugins/servlet/oauth/request-token',
+            status=200,
+            content_type='text/plain',
+            body='oauth_token=abc123&oauth_token_secret=def456')
+        responses.add(
+            responses.POST,
+            'https://jira.example.com/plugins/servlet/oauth/access-token',
+            status=200,
+            content_type='text/plain',
+            body='oauth_token=valid-token&oauth_token_secret=valid-secret')
+        responses.add(
+            responses.POST,
+            'https://jira.example.com/rest/webhooks/1.0/webhook',
+            status=403,
+            json={"messages": [
+                {
+                    "key": "You do not have permission to create WebHook 'Sentry Issue Sync'."
+                }
+            ]})
+
+        resp = self.install_integration()
+        self.assertContains(resp, 'You do not have permission to create')
+        self.assertContains(resp, 'Could not create issue webhook')
+
+        assert Integration.objects.count() == 0
