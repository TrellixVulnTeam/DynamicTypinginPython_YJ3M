commit e6f18e889f78de3c5fc194320c972548996ecefe
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Jul 11 11:19:23 2016 -0700

    Allow passing sentry_release querystring to CSP reports (#3665)
    
    This allows passing along release information to CSP reports which will
    help reduce noise by being able to leverage "resolved in next release"
    functionality.

diff --git a/src/sentry/coreapi.py b/src/sentry/coreapi.py
index bbf5577c09..8adda74ae7 100644
--- a/src/sentry/coreapi.py
+++ b/src/sentry/coreapi.py
@@ -691,6 +691,9 @@ class CspApiHelper(ClientApiHelper):
         return auth
 
     def validate_data(self, project, data):
+        # pop off our meta data used to hold Sentry specific stuff
+        meta = data.pop('_meta', {})
+
         # All keys are sent with hyphens, so we want to conver to underscores
         report = dict(map(lambda v: (v[0].replace('-', '_'), v[1]), data.iteritems()))
 
@@ -706,12 +709,13 @@ class CspApiHelper(ClientApiHelper):
         if inst.referrer:
             headers['Referer'] = inst.referrer
 
-        return {
+        data = {
             'logger': 'csp',
             'project': project.id,
             'message': inst.get_message(),
             'culprit': inst.get_culprit(),
             'tags': inst.get_tags(),
+            'release': meta.get('release'),
             inst.get_path(): inst.to_json(),
             # This is a bit weird, since we don't have nearly enough
             # information to create an Http interface, but
@@ -723,5 +727,19 @@ class CspApiHelper(ClientApiHelper):
             },
             'sentry.interfaces.User': {
                 'ip_address': self.context.ip_address,
-            }
+            },
+            'errors': [],
         }
+
+        # Copy/pasted from above in ClientApiHelper.validate_data
+        if data.get('release'):
+            data['release'] = unicode(data['release'])
+            if len(data['release']) > 64:
+                data['errors'].append({
+                    'type': EventError.VALUE_TOO_LONG,
+                    'name': 'release',
+                    'value': data['release'],
+                })
+                del data['release']
+
+        return data
diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index 8af32d178e..27deee2207 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -489,6 +489,12 @@ class CspReportView(StoreView):
             metrics.incr('events.blacklisted')
             raise APIForbidden('Rejected CSP report')
 
+        # Attach on collected meta data. This data obviously isn't a part
+        # of the spec, but we need to append to the report sentry specific things.
+        report['_meta'] = {
+            'release': request.GET.get('sentry_release'),
+        }
+
         response_or_event_id = self.process(
             request,
             project=project,
diff --git a/tests/sentry/coreapi/tests.py b/tests/sentry/coreapi/tests.py
index 4916a0744a..d0184cdd55 100644
--- a/tests/sentry/coreapi/tests.py
+++ b/tests/sentry/coreapi/tests.py
@@ -480,11 +480,16 @@ class CspApiHelperTest(BaseAPITest):
             "effective-directive": "img-src",
             "original-policy": "default-src  https://45.55.25.245:8123/; child-src  https://45.55.25.245:8123/; connect-src  https://45.55.25.245:8123/; font-src  https://45.55.25.245:8123/; img-src  https://45.55.25.245:8123/; media-src  https://45.55.25.245:8123/; object-src  https://45.55.25.245:8123/; script-src  https://45.55.25.245:8123/; style-src  https://45.55.25.245:8123/; form-action  https://45.55.25.245:8123/; frame-ancestors 'none'; plugin-types 'none'; report-uri http://45.55.25.245:8123/csp-report?os=OS%20X&device=&browser_version=43.0&browser=chrome&os_version=Lion",
             "blocked-uri": "http://google.com",
-            "status-code": 200
+            "status-code": 200,
+            "_meta": {
+                "release": "abc123",
+            }
         }
         result = self.helper.validate_data(self.project, report)
         assert result['logger'] == 'csp'
         assert result['project'] == self.project.id
+        assert result['release'] == 'abc123'
+        assert result['errors'] == []
         assert 'message' in result
         assert 'culprit' in result
         assert 'tags' in result
