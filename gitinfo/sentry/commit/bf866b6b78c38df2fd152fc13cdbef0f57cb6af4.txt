commit bf866b6b78c38df2fd152fc13cdbef0f57cb6af4
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jan 24 14:17:00 2012 -0800

    General improvements for how cookies are stored and rendered in Http interface

diff --git a/sentry/interfaces.py b/sentry/interfaces.py
index 16cee77568..c563181777 100644
--- a/sentry/interfaces.py
+++ b/sentry/interfaces.py
@@ -226,7 +226,14 @@ class Http(Interface):
         self.query_string = query_string
         self.headers = headers or {}
         self.env = env or {}
-        self.cookies = cookies or None
+        if cookies:
+            self.cookies = cookies
+        else:
+            self.cookies = {}
+        if 'Cookie' in headers:
+            cookies = headers.pop('Cookie')
+            if not self.cookies:
+                cookies = self.cookies
 
     def serialize(self):
         return {
@@ -249,6 +256,18 @@ class Http(Interface):
                 pass
             else:
                 data_is_dict = True
+
+        # It's kind of silly we store this twice
+        cookies = self.cookies or self.headers.pop('Cookie', {})
+        cookies_is_dict = isinstance(cookies, dict)
+        if not cookies_is_dict:
+            try:
+                cookies = QueryDict(cookies)
+            except:
+                pass
+            else:
+                cookies_is_dict = True
+
         return render_to_string('sentry/partial/interfaces/http.html', {
             'event': event,
             'full_url': '?'.join(filter(None, [self.url, self.query_string])),
@@ -257,7 +276,8 @@ class Http(Interface):
             'data': data,
             'data_is_dict': data_is_dict,
             'query_string': self.query_string,
-            'cookies': self.cookies,
+            'cookies': cookies,
+            'cookies_is_dict': cookies_is_dict,
             'headers': self.headers,
             'env': self.env,
         })
diff --git a/sentry/templates/sentry/partial/interfaces/http.html b/sentry/templates/sentry/partial/interfaces/http.html
index 904520564c..7ce7c0a177 100644
--- a/sentry/templates/sentry/partial/interfaces/http.html
+++ b/sentry/templates/sentry/partial/interfaces/http.html
@@ -22,14 +22,12 @@
                         <td>{{ method }}</td>
                     </tr>
                 {% endif %}
-                {% if query_string %}
-                    <tr>
-                        <th>{% trans "Query:" %}</th>
-                        <td>
-                            <code>{{ query_string|pprint }}</code>
-                        </td>
-                    </tr>
-                {% endif %}
+                <tr>
+                    <th>{% trans "Query:" %}</th>
+                    <td>
+                        <code>{{ query_string|pprint }}</code>
+                    </td>
+                </tr>
                 {% if data %}
                     <tr>
                         <th>{% trans "Body:" %}</th>
@@ -62,6 +60,38 @@
                         </td>
                     </tr>
                 {% endif %}
+                {% if cookies %}
+                    <tr>
+                        <th>{% trans "Cookies:" %}</th>
+                        <td>
+                            {% if cookies_is_dict %}
+                                {% if cookies|length > 5 %}
+                                    <a href="#" onclick="return varToggle(this, 'HttpCookies')"><span>&#x25b6;</span> {% trans "Cookies" %}</a>
+                                {% endif %}
+                                <table class="vars" id="vHttpCookies"{% if cookies|length > 5 %} style="display:none;"{% endif %}>
+                                    <colgroup>
+                                        <col style="width:100px;">
+                                    </colgroup>
+                                    <tbody>
+                                        {% for key, value in cookies.iteritems|as_sorted %}
+                                            <tr>
+                                                <td>{{ key|to_str }}</td>
+                                                <td class="code"><pre>{{ value|pprint }}</pre></td>
+                                            </tr>
+                                        {% endfor %}
+                                    </tbody>
+                                </table>
+                            {% else %}
+                                {% if cookies|length > 5 %}
+                                    <a href="#" onclick="return varToggle(this, 'HttpCookies')"><span>&#x25b6;</span> {% trans "Cookies" %}</a>
+                                {% endif %}
+                                <div id="vHttpCookies"{% if cookies|length > 5 %} style="display:none;"{% endif %}>
+                                    <pre>{{ cookies|pprint }}</pre>
+                                </div>
+                            {% endif %}
+                        </td>
+                    </tr>
+                {% endif %}
                 {% if headers %}
                     <tr>
                         <th>{% trans "Headers:" %}</th>
diff --git a/sentry/templatetags/sentry_helpers.py b/sentry/templatetags/sentry_helpers.py
index b96168ed5c..79c7ece5c6 100644
--- a/sentry/templatetags/sentry_helpers.py
+++ b/sentry/templatetags/sentry_helpers.py
@@ -112,6 +112,11 @@ def to_json(data):
     return json.dumps(data)
 
 
+@register.filter
+def to_str(data):
+    return str(data)
+
+
 @register.simple_tag
 def sentry_version():
     import sentry
