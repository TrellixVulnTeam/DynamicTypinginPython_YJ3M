commit 890487e9676c2c590277de718a13e578e2bf1bf3
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jan 19 10:07:03 2014 -0800

    Improve code/users support in explore

diff --git a/src/sentry/models/tagkey.py b/src/sentry/models/tagkey.py
index d33133260e..f62d55b4de 100644
--- a/src/sentry/models/tagkey.py
+++ b/src/sentry/models/tagkey.py
@@ -6,11 +6,13 @@ sentry.models.tagkey
 :license: BSD, see LICENSE for more details.
 """
 
+from django.core.urlresolvers import reverse
 from django.db import models
 
 from sentry.constants import MAX_TAG_KEY_LENGTH, TAG_LABELS
 from sentry.db.models import Model, BoundedPositiveIntegerField, sane_repr
 from sentry.manager import TagKeyManager
+from sentry.utils.http import absolute_uri
 
 
 class TagKey(Model):
@@ -35,3 +37,19 @@ class TagKey(Model):
         return self.label \
             or TAG_LABELS.get(self.key) \
             or self.key.replace('_', ' ').title()
+
+    def get_absolute_url(self):
+        # HACK(dcramer): quick and dirty way to support code/users
+        if self.key == 'sentry:user':
+            url_name = 'sentry-users'
+        elif self.key == 'sentry:filename':
+            url_name = 'sentry-explore-code-by-filename'
+        elif self.key == 'sentry:function':
+            url_name = 'sentry-explore-code-by-function'
+        else:
+            url_name = 'sentry-explore-tag'
+            return absolute_uri(reverse(url_name, args=[
+                self.project.team.slug, self.project.slug, self.key]))
+
+        return absolute_uri(reverse(url_name, args=[
+            self.project.team.slug, self.project.slug]))
diff --git a/src/sentry/models/tagvalue.py b/src/sentry/models/tagvalue.py
index 07cfb82e93..e0ab758721 100644
--- a/src/sentry/models/tagvalue.py
+++ b/src/sentry/models/tagvalue.py
@@ -6,6 +6,7 @@ sentry.models.tagvalue
 :license: BSD, see LICENSE for more details.
 """
 
+from django.core.urlresolvers import reverse
 from django.db import models
 from django.utils import timezone
 
@@ -14,6 +15,7 @@ from sentry.db.models import (
     Model, BoundedPositiveIntegerField, GzippedDictField, BaseManager,
     sane_repr
 )
+from sentry.utils.http import absolute_uri
 
 
 class TagValue(Model):
@@ -38,3 +40,25 @@ class TagValue(Model):
         unique_together = (('project', 'key', 'value'),)
 
     __repr__ = sane_repr('project_id', 'key', 'value')
+
+    def get_label(self):
+        # HACK(dcramer): quick and dirty way to hack in better display states
+        if self.key == 'sentry:user':
+            return self.data.get('email') or self.value
+        return self.value
+
+    def get_absolute_url(self):
+        # HACK(dcramer): quick and dirty way to support code/users
+        if self.key == 'sentry:user':
+            url_name = 'sentry-user-details'
+        elif self.key == 'sentry:filename':
+            url_name = 'sentry-explore-code-details'
+        elif self.key == 'sentry:function':
+            url_name = 'sentry-explore-code-details-by-function'
+        else:
+            url_name = 'sentry-explore-tag-value'
+            return absolute_uri(reverse(url_name, args=[
+                self.project.team.slug, self.project.slug, self.key, self.id]))
+
+        return absolute_uri(reverse(url_name, args=[
+            self.project.team.slug, self.project.slug, self.id]))
diff --git a/src/sentry/templates/sentry/explore/tag_list.html b/src/sentry/templates/sentry/explore/tag_list.html
index 8888a6408e..2438213906 100644
--- a/src/sentry/templates/sentry/explore/tag_list.html
+++ b/src/sentry/templates/sentry/explore/tag_list.html
@@ -6,7 +6,6 @@
 
 {% block inner %}
     {% if tag_list %}
-
         {% for tag_key, tag_values in tag_list %}
             {% if not forloop.counter|divisibleby:2 %}
                 {% if not forloop.first %}
@@ -16,17 +15,17 @@
             {% endif %}
             <div class="span6">
                 <div class="page-header">
-                    <span class="pull-right"><a href="{% url 'sentry-explore-tag' project.team.slug project.slug tag_key.key|urlquote %}">More Details</a></span>
+                    <span class="pull-right"><a href="{{ tag_key.get_absolute_url }}">More Details</a></span>
 
                     <h4>{{ tag_key.get_label }} <small>({{ tag_key.values_seen|small_count }})</small></h4>
                 </div>
 
                 <ul class="tag-list">
-                    {% for value_id, tag_value, times_seen in tag_values %}
+                    {% for tag_value in tag_values %}
                         <li>
-                            <a href="{% url 'sentry-explore-tag-value' project.team.slug project.slug tag_key.key|urlquote value_id %}">
-                                {{ tag_value }}
-                                <span>{{ times_seen|small_count }}</span>
+                            <a href="{{ tag_value.get_absolute_url }}">
+                                {{ tag_value.get_label }}
+                                <span>{{ tag_value.times_seen|small_count }}</span>
                             </a>
                         </li>
                     {% endfor %}
@@ -36,9 +35,7 @@
                 </div>
             {% endif %}
         {% endfor %}
-
     {% else %}
-
         <p>{% trans "There don't seem to be any tags in the system yet. For more information on how you can tag data, check your client's documentation." %}</p>
 
     {% endif %}
diff --git a/src/sentry/templates/sentry/explore/tag_value_list.html b/src/sentry/templates/sentry/explore/tag_value_list.html
index 38f31f7a10..743370bfa7 100644
--- a/src/sentry/templates/sentry/explore/tag_value_list.html
+++ b/src/sentry/templates/sentry/explore/tag_value_list.html
@@ -46,8 +46,8 @@
                 {% for tag_value in tag_values.paginator.objects %}
                     <tr>
                         <td>
-                            
-                            <a href="{% url 'sentry-explore-tag-value' team.slug project.slug tag_value.key tag_value.id %}">
+
+                            <a href="{{ tag_value.get_absolute_url }}">
                                 {{ tag_value.value }}
                             </a>
                         </td>
diff --git a/src/sentry/templates/sentry/users/list.html b/src/sentry/templates/sentry/users/list.html
index b6d38550cb..79dd3ccf5f 100644
--- a/src/sentry/templates/sentry/users/list.html
+++ b/src/sentry/templates/sentry/users/list.html
@@ -39,7 +39,7 @@
             <tbody>
                 {% for tag in tag_list.paginator.objects %}
                     <tr>
-                        <td><a href="{% url 'sentry-user-details' team.slug project.slug tag.id %}">{% if tag.data.email %}{{ tag.data.email }}{% else %}{{ tag.value }}{% endif %}</a></td>
+                        <td><a href="{% url 'sentry-user-details' team.slug project.slug tag.id %}">{{ tag.get_label }}</a></td>
                         <td style="text-align:center">{{ tag.last_seen|timesince }}</td>
                         <td style="text-align:center">{{ tag.times_seen|small_count }}</td>
                     </tr>
diff --git a/src/sentry/web/frontend/explore.py b/src/sentry/web/frontend/explore.py
index e368059919..91167fa064 100644
--- a/src/sentry/web/frontend/explore.py
+++ b/src/sentry/web/frontend/explore.py
@@ -25,7 +25,7 @@ SORT_OPTIONS = {
 def tag_list(request, team, project):
     tag_key_qs = sorted(TagKey.objects.filter(
         project=project
-    ).exclude(key__startswith='sentry:'), key=lambda x: x.get_label())
+    ), key=lambda x: x.get_label())
 
     tag_value_qs = TagValue.objects.filter(
         project=project).order_by('-times_seen')
@@ -33,12 +33,12 @@ def tag_list(request, team, project):
     # O(N) db access
     tag_list = []
     for tag_key in tag_key_qs:
-        tag_list.append((tag_key, [
-            (id, value, times_seen)
-            for (id, value, times_seen)
-            in tag_value_qs.filter(
-                key=tag_key.key).values_list('id', 'value', 'times_seen')[:5]
-        ]))
+        # prevent some excess queries by binding project
+        tag_key.project = project
+        tag_values = tag_value_qs.filter(key=tag_key.key)[:5]
+        for tag_value in tag_values:
+            tag_value.project = project
+        tag_list.append((tag_key, tag_values))
 
     return render_to_response('sentry/explore/tag_list.html', {
         'SECTION': 'explore',
@@ -51,9 +51,9 @@ def tag_list(request, team, project):
 @has_access
 def tag_value_list(request, team, project, key):
     tag_key = TagKey.objects.get(
-        project=project, key=key)
+        project=project, key=key).select_related('project')
     tag_values_qs = TagValue.objects.filter(
-        project=project, key=key)
+        project=project, key=key).select_related('project')
 
     sort = request.GET.get('sort')
     if sort not in SORT_OPTIONS:
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index 23cca9b49a..97b41bdffe 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -287,7 +287,8 @@ urlpatterns += patterns('',
     # Explore - Users
     url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/users/$',
         users.user_list, name='sentry-users'),
-    url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/users/(?P<user_id>\d+)/$', users.user_details, name='sentry-user-details'),
+    url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/users/(?P<user_id>\d+)/$',
+        users.user_details, name='sentry-user-details'),
 
     # Explore - Code
     url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/code/$', explore_code.list_tag,
