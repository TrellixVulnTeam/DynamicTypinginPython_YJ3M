commit eaa9d106350952803d56b6f638c883f100d97d0a
Author: Ted Kaemming <ted@kaemming.com>
Date:   Wed Sep 16 12:32:14 2015 -0700

    Ensure timeline is in the ready state before digesting.

diff --git a/src/sentry/timelines/redis.py b/src/sentry/timelines/redis.py
index 6ef6f77023..1d8f49f562 100644
--- a/src/sentry/timelines/redis.py
+++ b/src/sentry/timelines/redis.py
@@ -169,6 +169,9 @@ class RedisBackend(Backend):
         # TODO: Need to wrap this whole section in a lease to try and avoid data races.
         connection = self.cluster.get_local_client_for_key(timeline_key)
 
+        if connection.zscore(self.prefix_key(make_schedule_key(READY_STATE)), timeline) is None:
+            raise Exception('Cannot digest timeline, timeline is not in the ready state.')
+
         with connection.pipeline() as pipeline:
             pipeline.watch(digest_key)  # This shouldn't be necessary, but better safe than sorry?
 
