commit 96f052f3ba69536c998d0c2148bd802946b98282
Author: Mark Story <mark@sentry.io>
Date:   Mon Jan 13 11:05:17 2020 -0500

    ref(ts) Convert UserBadge to typescript (#16360)
    
    * ref(ts) Convert UserBadge to typescript
    
    * Use typescript better and add className prop so UserBadge can be styled.

diff --git a/src/sentry/static/sentry/app/components/avatarCropper.tsx b/src/sentry/static/sentry/app/components/avatarCropper.tsx
index 9bc7d57cdf..e69ea48f1f 100644
--- a/src/sentry/static/sentry/app/components/avatarCropper.tsx
+++ b/src/sentry/static/sentry/app/components/avatarCropper.tsx
@@ -341,7 +341,7 @@ class AvatarCropper extends React.Component<Props, State> {
 
   get imageSrc() {
     const {savedDataUrl, model, type} = this.props;
-    const uuid = model && model.avatar.avatarUuid;
+    const uuid = model && model.avatar && model.avatar.avatarUuid;
     const photoUrl = uuid && `/${AVATAR_URL_MAP[type] || 'avatar'}/${uuid}/`;
 
     return savedDataUrl || this.state.objectURL || photoUrl;
diff --git a/src/sentry/static/sentry/app/components/idBadge/userBadge.jsx b/src/sentry/static/sentry/app/components/idBadge/userBadge.tsx
similarity index 56%
rename from src/sentry/static/sentry/app/components/idBadge/userBadge.jsx
rename to src/sentry/static/sentry/app/components/idBadge/userBadge.tsx
index 4d6c55f84c..ccddfee5ec 100644
--- a/src/sentry/static/sentry/app/components/idBadge/userBadge.jsx
+++ b/src/sentry/static/sentry/app/components/idBadge/userBadge.tsx
@@ -1,6 +1,7 @@
 import PropTypes from 'prop-types';
 import React from 'react';
 import styled from '@emotion/styled';
+import {AvatarUser, Member} from 'app/types';
 import UserAvatar from 'app/components/avatar/userAvatar';
 import Link from 'app/components/links/link';
 import overflowEllipsis from 'app/styles/overflowEllipsis';
@@ -8,41 +9,67 @@ import space from 'app/styles/space';
 import SentryTypes from 'app/sentryTypes';
 import omit from 'lodash/omit';
 
+const defaultProps = {
+  useLink: true,
+  hideEmail: false,
+};
+
+type Props = {
+  avatarSize: UserAvatar['props']['size'];
+  className?: string;
+  displayName?: string;
+  displayEmail?: string;
+  user?: AvatarUser;
+  member?: Member;
+  orgId?: string;
+} & Partial<typeof defaultProps>;
+
+function getUser(props: {user?: AvatarUser; member?: Member}): AvatarUser | undefined {
+  if (props.user) {
+    return props.user;
+  }
+  if (props.member && props.member.user) {
+    return props.member.user;
+  }
+  return undefined;
+}
+
 const UserBadge = ({
+  className,
   displayName,
   displayEmail,
-  user,
-  member,
   orgId,
   avatarSize,
   useLink,
   hideEmail,
   ...props
-}) => {
-  const userFromPropsOrMember = user || (member && member.user) || member;
+}: Props) => {
+  const user = getUser(props);
+  const member = props.member;
+  const title =
+    displayName ||
+    (user &&
+      (user.name ||
+        user.email ||
+        user.username ||
+        user.ipAddress ||
+        // Because this can be used to render EventUser models, or User *interface*
+        // objects from serialized Event models. we try both ipAddress and ip_address.
+        user.ip_address)) ||
+    (member && member.name);
+
   return (
-    <StyledUserBadge {...props}>
-      <StyledAvatar user={userFromPropsOrMember} size={avatarSize} />
+    <StyledUserBadge className={className}>
+      <StyledAvatar user={user} size={avatarSize} />
       <StyledNameAndEmail>
         <StyledName
           useLink={useLink && orgId && member}
           hideEmail={hideEmail}
           to={member && orgId && `/settings/${orgId}/members/${member.id}/`}
         >
-          {displayName ||
-            userFromPropsOrMember.name ||
-            userFromPropsOrMember.email ||
-            userFromPropsOrMember.username ||
-            userFromPropsOrMember.ipAddress ||
-            /**
-             * Because this can be used to render EventUser models, or User *interface*
-             * objects from serialized Event models. we try both ipAddress and ip_address.
-             */
-            userFromPropsOrMember.ip_address}
+          {title}
         </StyledName>
-        {!hideEmail && (
-          <StyledEmail>{displayEmail || userFromPropsOrMember.email}</StyledEmail>
-        )}
+        {!hideEmail && <StyledEmail>{displayEmail || (user && user.email)}</StyledEmail>}
       </StyledNameAndEmail>
     </StyledUserBadge>
   );
@@ -66,10 +93,7 @@ UserBadge.propTypes = {
   hideEmail: PropTypes.bool,
 };
 
-UserBadge.defaultProps = {
-  useLink: true,
-  hideEmail: false,
-};
+UserBadge.defaultProps = defaultProps;
 
 const StyledUserBadge = styled('div')`
   display: flex;
@@ -89,16 +113,21 @@ const StyledEmail = styled('div')`
   ${overflowEllipsis};
 `;
 
-const StyledName = styled(({useLink, to, ...props}) => {
+type NameProps = {
+  useLink: boolean;
+  hideEmail: boolean;
+} & Link['props'];
+
+const StyledName = styled<NameProps>(({useLink, to, ...props}) => {
   const forwardProps = omit(props, 'hideEmail');
   return useLink ? <Link to={to} {...forwardProps} /> : <span {...forwardProps} />;
 })`
-  font-weight: ${p => (p.hideEmail ? 'inherit' : 'bold')};
+  font-weight: ${(p: NameProps) => (p.hideEmail ? 'inherit' : 'bold')};
   line-height: 1.15em;
   ${overflowEllipsis};
 `;
 
-const StyledAvatar = styled(props => <UserAvatar {...props} />)`
+const StyledAvatar = styled(UserAvatar)`
   min-width: ${space(3)};
   min-height: ${space(3)};
   margin-right: ${space(1)};
diff --git a/src/sentry/static/sentry/app/types/index.tsx b/src/sentry/static/sentry/app/types/index.tsx
index 1863b8b25d..989657265a 100644
--- a/src/sentry/static/sentry/app/types/index.tsx
+++ b/src/sentry/static/sentry/app/types/index.tsx
@@ -228,9 +228,11 @@ export type AvatarUser = {
   name: string;
   username: string;
   email: string;
-  avatarUrl: string;
-  avatar: Avatar;
+  avatarUrl?: string;
+  avatar?: Avatar;
   ip_address: string;
+  // Compatibility shim with EventUser serializer
+  ipAddress?: string;
   options?: {
     avatarType: string;
   };
diff --git a/tests/js/spec/components/sidebar/__snapshots__/index.spec.jsx.snap b/tests/js/spec/components/sidebar/__snapshots__/index.spec.jsx.snap
index 45b97b091b..d82f8a20ec 100644
--- a/tests/js/spec/components/sidebar/__snapshots__/index.spec.jsx.snap
+++ b/tests/js/spec/components/sidebar/__snapshots__/index.spec.jsx.snap
@@ -617,9 +617,10 @@ exports[`Sidebar SidebarDropdown can open Sidebar org/name dropdown menu 1`] = `
                         className="css-1b4dtj5-UserBadgeNoOverflow e1fowdfw2"
                       >
                         <div
-                          className="e1fowdfw2 css-qu415y-StyledUserBadge-UserBadgeNoOverflow ev46mzr0"
+                          className="e1fowdfw2 css-qu415y-StyledUserBadge-UserBadgeNoOverflow e31z2f80"
                         >
                           <StyledAvatar
+                            gravatar={false}
                             size={32}
                             user={
                               Object {
@@ -639,8 +640,9 @@ exports[`Sidebar SidebarDropdown can open Sidebar org/name dropdown menu 1`] = `
                               }
                             }
                           >
-                            <Component
-                              className="css-593o0g-StyledAvatar ev46mzr4"
+                            <UserAvatar
+                              className="css-593o0g-StyledAvatar e31z2f84"
+                              gravatar={false}
                               size={32}
                               user={
                                 Object {
@@ -660,52 +662,39 @@ exports[`Sidebar SidebarDropdown can open Sidebar org/name dropdown menu 1`] = `
                                 }
                               }
                             >
-                              <UserAvatar
-                                className="css-593o0g-StyledAvatar ev46mzr4"
-                                gravatar={false}
+                              <BaseAvatar
+                                className="css-593o0g-StyledAvatar e31z2f84"
+                                gravatarId="foo@example.com"
+                                hasTooltip={false}
+                                letterId="foo@example.com"
+                                round={true}
                                 size={32}
-                                user={
-                                  Object {
-                                    "email": "foo@example.com",
-                                    "flags": Object {
-                                      "newsletter_consent_prompt": false,
-                                    },
-                                    "hasPasswordAuth": true,
-                                    "id": "1",
-                                    "isAuthenticated": true,
-                                    "name": "Foo Bar",
-                                    "options": Object {
-                                      "timezone": "UTC",
-                                    },
-                                    "permissions": Set {},
-                                    "username": "foo@example.com",
-                                  }
-                                }
+                                style={Object {}}
+                                title="Foo Bar"
+                                tooltip="Foo Bar (foo@example.com)"
+                                type="letter_avatar"
+                                uploadId=""
+                                uploadPath="avatar"
                               >
-                                <BaseAvatar
-                                  className="css-593o0g-StyledAvatar ev46mzr4"
-                                  gravatarId="foo@example.com"
-                                  hasTooltip={false}
-                                  letterId="foo@example.com"
-                                  round={true}
-                                  size={32}
-                                  style={Object {}}
-                                  title="Foo Bar"
-                                  tooltip="Foo Bar (foo@example.com)"
-                                  type="letter_avatar"
-                                  uploadId=""
-                                  uploadPath="avatar"
+                                <Tooltip
+                                  containerDisplayMode="inline-block"
+                                  disabled={true}
+                                  position="top"
+                                  title="Foo Bar (foo@example.com)"
                                 >
-                                  <Tooltip
-                                    containerDisplayMode="inline-block"
-                                    disabled={true}
-                                    position="top"
-                                    title="Foo Bar (foo@example.com)"
+                                  <StyledBaseAvatar
+                                    className="avatar css-593o0g-StyledAvatar e31z2f84"
+                                    loaded={true}
+                                    round={true}
+                                    style={
+                                      Object {
+                                        "height": "32px",
+                                        "width": "32px",
+                                      }
+                                    }
                                   >
-                                    <StyledBaseAvatar
-                                      className="avatar css-593o0g-StyledAvatar ev46mzr4"
-                                      loaded={true}
-                                      round={true}
+                                    <span
+                                      className="avatar e31z2f84 css-13sepyg-StyledBaseAvatar-StyledAvatar e147uwb0"
                                       style={
                                         Object {
                                           "height": "32px",
@@ -713,76 +702,66 @@ exports[`Sidebar SidebarDropdown can open Sidebar org/name dropdown menu 1`] = `
                                         }
                                       }
                                     >
-                                      <span
-                                        className="avatar ev46mzr4 css-13sepyg-StyledBaseAvatar-StyledAvatar e147uwb0"
-                                        style={
-                                          Object {
-                                            "height": "32px",
-                                            "width": "32px",
-                                          }
-                                        }
+                                      <LetterAvatar
+                                        displayName="Foo Bar"
+                                        identifier="foo@example.com"
+                                        round={true}
                                       >
-                                        <LetterAvatar
+                                        <Component
+                                          className="css-1oxr9oh-LetterAvatar e12lgfev0"
                                           displayName="Foo Bar"
                                           identifier="foo@example.com"
                                           round={true}
                                         >
-                                          <Component
+                                          <svg
                                             className="css-1oxr9oh-LetterAvatar e12lgfev0"
-                                            displayName="Foo Bar"
-                                            identifier="foo@example.com"
-                                            round={true}
+                                            viewBox="0 0 120 120"
                                           >
-                                            <svg
-                                              className="css-1oxr9oh-LetterAvatar e12lgfev0"
-                                              viewBox="0 0 120 120"
-                                            >
-                                              <rect
-                                                fill="#315cac"
-                                                height="120"
-                                                rx="15"
-                                                ry="15"
-                                                width="120"
-                                                x="0"
-                                                y="0"
-                                              />
-                                              <text
-                                                fill="#FFFFFF"
-                                                fontSize="65"
-                                                style={
-                                                  Object {
-                                                    "dominantBaseline": "central",
-                                                  }
+                                            <rect
+                                              fill="#315cac"
+                                              height="120"
+                                              rx="15"
+                                              ry="15"
+                                              width="120"
+                                              x="0"
+                                              y="0"
+                                            />
+                                            <text
+                                              fill="#FFFFFF"
+                                              fontSize="65"
+                                              style={
+                                                Object {
+                                                  "dominantBaseline": "central",
                                                 }
-                                                textAnchor="middle"
-                                                x="50%"
-                                                y="50%"
-                                              >
-                                                FB
-                                              </text>
-                                            </svg>
-                                          </Component>
-                                        </LetterAvatar>
-                                      </span>
-                                    </StyledBaseAvatar>
-                                  </Tooltip>
-                                </BaseAvatar>
-                              </UserAvatar>
-                            </Component>
+                                              }
+                                              textAnchor="middle"
+                                              x="50%"
+                                              y="50%"
+                                            >
+                                              FB
+                                            </text>
+                                          </svg>
+                                        </Component>
+                                      </LetterAvatar>
+                                    </span>
+                                  </StyledBaseAvatar>
+                                </Tooltip>
+                              </BaseAvatar>
+                            </UserAvatar>
                           </StyledAvatar>
                           <StyledNameAndEmail>
                             <div
-                              className="css-14b4oxh-StyledNameAndEmail ev46mzr1"
+                              className="css-14b4oxh-StyledNameAndEmail e31z2f81"
                             >
                               <StyledName
                                 hideEmail={false}
                               >
                                 <Component
-                                  className="css-19h2nhd-StyledName ev46mzr3"
+                                  className="css-19h2nhd-StyledName e31z2f83"
                                   hideEmail={false}
                                 >
                                   <span
-                                    className="css-19h2nhd-StyledName ev46mzr3"
+                                    className="css-19h2nhd-StyledName e31z2f83"
                                   >
                                     Foo Bar
                                   </span>
@@ -790,7 +769,7 @@ exports[`Sidebar SidebarDropdown can open Sidebar org/name dropdown menu 1`] = `
                               </StyledName>
                               <StyledEmail>
                                 <div
-                                  className="css-zdh78r-StyledEmail ev46mzr2"
+                                  className="css-zdh78r-StyledEmail e31z2f82"
                                 >
                                   foo@example.com
                                 </div>
@@ -3364,9 +3343,10 @@ exports[`Sidebar renders without org and router 1`] = `
                         className="css-1b4dtj5-UserBadgeNoOverflow e1fowdfw2"
                       >
                         <div
-                          className="e1fowdfw2 css-qu415y-StyledUserBadge-UserBadgeNoOverflow ev46mzr0"
+                          className="e1fowdfw2 css-qu415y-StyledUserBadge-UserBadgeNoOverflow e31z2f80"
                         >
                           <StyledAvatar
+                            gravatar={false}
                             size={32}
                             user={
                               Object {
@@ -3386,8 +3366,9 @@ exports[`Sidebar renders without org and router 1`] = `
                               }
                             }
                           >
-                            <Component
-                              className="css-593o0g-StyledAvatar ev46mzr4"
+                            <UserAvatar
+                              className="css-593o0g-StyledAvatar e31z2f84"
+                              gravatar={false}
                               size={32}
                               user={
                                 Object {
@@ -3407,52 +3388,39 @@ exports[`Sidebar renders without org and router 1`] = `
                                 }
                               }
                             >
-                              <UserAvatar
-                                className="css-593o0g-StyledAvatar ev46mzr4"
-                                gravatar={false}
+                              <BaseAvatar
+                                className="css-593o0g-StyledAvatar e31z2f84"
+                                gravatarId="foo@example.com"
+                                hasTooltip={false}
+                                letterId="foo@example.com"
+                                round={true}
                                 size={32}
-                                user={
-                                  Object {
-                                    "email": "foo@example.com",
-                                    "flags": Object {
-                                      "newsletter_consent_prompt": false,
-                                    },
-                                    "hasPasswordAuth": true,
-                                    "id": "1",
-                                    "isAuthenticated": true,
-                                    "name": "Foo Bar",
-                                    "options": Object {
-                                      "timezone": "UTC",
-                                    },
-                                    "permissions": Set {},
-                                    "username": "foo@example.com",
-                                  }
-                                }
+                                style={Object {}}
+                                title="Foo Bar"
+                                tooltip="Foo Bar (foo@example.com)"
+                                type="letter_avatar"
+                                uploadId=""
+                                uploadPath="avatar"
                               >
-                                <BaseAvatar
-                                  className="css-593o0g-StyledAvatar ev46mzr4"
-                                  gravatarId="foo@example.com"
-                                  hasTooltip={false}
-                                  letterId="foo@example.com"
-                                  round={true}
-                                  size={32}
-                                  style={Object {}}
-                                  title="Foo Bar"
-                                  tooltip="Foo Bar (foo@example.com)"
-                                  type="letter_avatar"
-                                  uploadId=""
-                                  uploadPath="avatar"
+                                <Tooltip
+                                  containerDisplayMode="inline-block"
+                                  disabled={true}
+                                  position="top"
+                                  title="Foo Bar (foo@example.com)"
                                 >
-                                  <Tooltip
-                                    containerDisplayMode="inline-block"
-                                    disabled={true}
-                                    position="top"
-                                    title="Foo Bar (foo@example.com)"
+                                  <StyledBaseAvatar
+                                    className="avatar css-593o0g-StyledAvatar e31z2f84"
+                                    loaded={true}
+                                    round={true}
+                                    style={
+                                      Object {
+                                        "height": "32px",
+                                        "width": "32px",
+                                      }
+                                    }
                                   >
-                                    <StyledBaseAvatar
-                                      className="avatar css-593o0g-StyledAvatar ev46mzr4"
-                                      loaded={true}
-                                      round={true}
+                                    <span
+                                      className="avatar e31z2f84 css-13sepyg-StyledBaseAvatar-StyledAvatar e147uwb0"
                                       style={
                                         Object {
                                           "height": "32px",
@@ -3460,76 +3428,66 @@ exports[`Sidebar renders without org and router 1`] = `
                                         }
                                       }
                                     >
-                                      <span
-                                        className="avatar ev46mzr4 css-13sepyg-StyledBaseAvatar-StyledAvatar e147uwb0"
-                                        style={
-                                          Object {
-                                            "height": "32px",
-                                            "width": "32px",
-                                          }
-                                        }
+                                      <LetterAvatar
+                                        displayName="Foo Bar"
+                                        identifier="foo@example.com"
+                                        round={true}
                                       >
-                                        <LetterAvatar
+                                        <Component
+                                          className="css-1oxr9oh-LetterAvatar e12lgfev0"
                                           displayName="Foo Bar"
                                           identifier="foo@example.com"
                                           round={true}
                                         >
-                                          <Component
+                                          <svg
                                             className="css-1oxr9oh-LetterAvatar e12lgfev0"
-                                            displayName="Foo Bar"
-                                            identifier="foo@example.com"
-                                            round={true}
+                                            viewBox="0 0 120 120"
                                           >
-                                            <svg
-                                              className="css-1oxr9oh-LetterAvatar e12lgfev0"
-                                              viewBox="0 0 120 120"
-                                            >
-                                              <rect
-                                                fill="#315cac"
-                                                height="120"
-                                                rx="15"
-                                                ry="15"
-                                                width="120"
-                                                x="0"
-                                                y="0"
-                                              />
-                                              <text
-                                                fill="#FFFFFF"
-                                                fontSize="65"
-                                                style={
-                                                  Object {
-                                                    "dominantBaseline": "central",
-                                                  }
+                                            <rect
+                                              fill="#315cac"
+                                              height="120"
+                                              rx="15"
+                                              ry="15"
+                                              width="120"
+                                              x="0"
+                                              y="0"
+                                            />
+                                            <text
+                                              fill="#FFFFFF"
+                                              fontSize="65"
+                                              style={
+                                                Object {
+                                                  "dominantBaseline": "central",
                                                 }
-                                                textAnchor="middle"
-                                                x="50%"
-                                                y="50%"
-                                              >
-                                                FB
-                                              </text>
-                                            </svg>
-                                          </Component>
-                                        </LetterAvatar>
-                                      </span>
-                                    </StyledBaseAvatar>
-                                  </Tooltip>
-                                </BaseAvatar>
-                              </UserAvatar>
-                            </Component>
+                                              }
+                                              textAnchor="middle"
+                                              x="50%"
+                                              y="50%"
+                                            >
+                                              FB
+                                            </text>
+                                          </svg>
+                                        </Component>
+                                      </LetterAvatar>
+                                    </span>
+                                  </StyledBaseAvatar>
+                                </Tooltip>
+                              </BaseAvatar>
+                            </UserAvatar>
                           </StyledAvatar>
                           <StyledNameAndEmail>
                             <div
-                              className="css-14b4oxh-StyledNameAndEmail ev46mzr1"
+                              className="css-14b4oxh-StyledNameAndEmail e31z2f81"
                             >
                               <StyledName
                                 hideEmail={false}
                               >
                                 <Component
-                                  className="css-19h2nhd-StyledName ev46mzr3"
+                                  className="css-19h2nhd-StyledName e31z2f83"
                                   hideEmail={false}
                                 >
                                   <span
-                                    className="css-19h2nhd-StyledName ev46mzr3"
+                                    className="css-19h2nhd-StyledName e31z2f83"
                                   >
                                     Foo Bar
                                   </span>
@@ -3537,7 +3495,7 @@ exports[`Sidebar renders without org and router 1`] = `
                               </StyledName>
                               <StyledEmail>
                                 <div
-                                  className="css-zdh78r-StyledEmail ev46mzr2"
+                                  className="css-zdh78r-StyledEmail e31z2f82"
                                 >
                                   foo@example.com
                                 </div>
