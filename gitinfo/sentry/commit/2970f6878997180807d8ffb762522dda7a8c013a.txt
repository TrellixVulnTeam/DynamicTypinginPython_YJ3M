commit 2970f6878997180807d8ffb762522dda7a8c013a
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Thu May 19 16:36:44 2016 -0700

    Fix logic for user_has_2fa (#3273)

diff --git a/src/sentry/models/authenticator.py b/src/sentry/models/authenticator.py
index bc14a5fced..5344eaa67c 100644
--- a/src/sentry/models/authenticator.py
+++ b/src/sentry/models/authenticator.py
@@ -109,14 +109,13 @@ class AuthenticatorManager(BaseManager):
         """Checks if the user has any 2FA configured.  Optionally backup
         interfaces can be ignored.
         """
-        if ignore_backup:
-            for authenticator in Authenticator.objects.filter(user=user):
-                if not authenticator.interface.is_available:
-                    continue
-                if not authenticator.interface.is_backup_interface:
-                    return True
-            return False
-        return Authenticator.objects.filter(user=user).first() is not None
+        for authenticator in Authenticator.objects.filter(user=user):
+            if not authenticator.interface.is_available:
+                continue
+            if ignore_backup and authenticator.interface.is_backup_interface:
+                continue
+            return True
+        return False
 
 
 AUTHENTICATOR_INTERFACES = {}
diff --git a/tests/sentry/models/test_authenticator.py b/tests/sentry/models/test_authenticator.py
new file mode 100644
index 0000000000..58e6ca014c
--- /dev/null
+++ b/tests/sentry/models/test_authenticator.py
@@ -0,0 +1,23 @@
+from __future__ import absolute_import
+
+from sentry.testutils import TestCase
+from sentry.models import Authenticator, TotpInterface, RecoveryCodeInterface
+
+
+class AuthenticatorTest(TestCase):
+    def test_user_has_2fa(self):
+        user = self.create_user('foo@example.com')
+        assert Authenticator.objects.user_has_2fa(user) is False
+        assert Authenticator.objects.filter(user=user).count() == 0
+
+        RecoveryCodeInterface().enroll(user)
+
+        assert Authenticator.objects.user_has_2fa(user) is True
+        assert Authenticator.objects.user_has_2fa(user, ignore_backup=True) is False
+        assert Authenticator.objects.filter(user=user).count() == 1
+
+        TotpInterface().enroll(user)
+
+        assert Authenticator.objects.user_has_2fa(user) is True
+        assert Authenticator.objects.user_has_2fa(user, ignore_backup=True) is True
+        assert Authenticator.objects.filter(user=user).count() == 2
