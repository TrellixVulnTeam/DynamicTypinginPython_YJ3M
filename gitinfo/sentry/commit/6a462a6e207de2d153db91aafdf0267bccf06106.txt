commit 6a462a6e207de2d153db91aafdf0267bccf06106
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jun 26 13:23:08 2013 -0700

    More cleanup for explore pages

diff --git a/src/sentry/templates/sentry/explore/list_tag.html b/src/sentry/templates/sentry/explore/list_tag.html
deleted file mode 100644
index 0b9bf00494..0000000000
--- a/src/sentry/templates/sentry/explore/list_tag.html
+++ /dev/null
@@ -1,72 +0,0 @@
-{% extends "sentry/bases/explore.html" %}
-
-{% load i18n %}
-{% load sentry_helpers %}
-{% load sentry_plugins %}
-
-{% block title %}{{ tag.get_label }} | {{ block.super }}{% endblock %}
-
-{% block bodyclass %}{% endblock %}
-
-{% block main %}
-    <section class="body">
-        <div class="page-header">
-            <h2>
-                Explore by {{ tag.get_label }}
-            </h2>
-        </div>
-
-        {% paginator tag_list from request as tag_list %}
-        {% querystring from request without sort as sort_querystring %}
-
-        <div class="btn-toolbar">
-            <div class="btn-group">
-                <a href="#" class="btn dropdown-toggle" data-toggle="dropdown">{% blocktrans with sort_label as label %}Sort by: {{ label }}{% endblocktrans %} <span class="caret"></span></a>
-                <ul class="dropdown-menu">
-                    <li{% ifequal sort 'recent' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=recent">{{ SORT_OPTIONS.recent }}</a></li>
-                    <li{% ifequal sort 'newest' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=newest">{{ SORT_OPTIONS.newest }}</a></li>
-                    <li{% ifequal sort 'events' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=events">{{ SORT_OPTIONS.events }}</a></li>
-                </ul>
-            </div>
-            <div class="btn-group pull-right">
-                <a class="btn prev{% if not tag_list.paginator.has_previous %} disabled{% endif %}" href="?{{ tag_list.query_string|escape }}&amp;p={{ tag_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
-                <a class="btn next{% if not tag_list.paginator.has_next %} disabled{% endif %}" href="?{{ tag_list.query_string|escape }}&amp;p={{ tag_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
-            </div>
-        </div>
-
-        {% if not tag_list.paginator.objects %}
-            <p>{% blocktrans %}You dont seem to have any data recorded for this tag. For more information on how to send this information consult your client's documentation.{% endblocktrans %}</p>
-        {% else %}
-            <table class="table table-bordered table-striped">
-                <thead>
-                    <tr>
-                        <th>{{ tag.get_label }}</th>
-                        <th style="width:150px;text-align:center">{% trans "Last Seen" %}</th>
-                        <th style="width:100px;text-align:center">{% trans "Events Seen" %}</th>
-                    </tr>
-                </thead>
-                <tbody>
-                    {% for tag_value in tag_list.paginator.objects %}
-                        <tr>
-                            <td>
-                                
-                                <a href="{% url 'sentry-explore-tag-details' team.slug project.slug tag_value.key tag_value.id %}">
-                                    {{ tag_value.value }}
-                                </a>
-                            </td>
-                            <td style="text-align:center">{{ tag_value.last_seen|timesince }}</td>
-                            <td style="text-align:center">{{ tag_value.times_seen|small_count }}</td>
-                        </tr>
-                    {% endfor %}
-                </tbody>
-            </table>
-
-            <div class="btn-toolbar">
-                <div class="btn-group pull-right">
-                    <a class="btn prev{% if not tag_list.paginator.has_previous %} disabled{% endif %}" href="?{{ tag_list.query_string|escape }}&amp;p={{ tag_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
-                    <a class="btn next{% if not tag_list.paginator.has_next %} disabled{% endif %}" href="?{{ tag_list.query_string|escape }}&amp;p={{ tag_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
-                </div>
-            </div>
-        {% endif %}
-    </section>
-{% endblock %}
diff --git a/src/sentry/templates/sentry/explore/tag_list.html b/src/sentry/templates/sentry/explore/tag_list.html
index 0a4ab6f42a..def48fb7f8 100644
--- a/src/sentry/templates/sentry/explore/tag_list.html
+++ b/src/sentry/templates/sentry/explore/tag_list.html
@@ -22,9 +22,9 @@
                 </div>
 
                 <ul class="tag-list">
-                    {% for tag_value, times_seen in tag_values %}
+                    {% for value_id, tag_value, times_seen in tag_values %}
                         <li>
-                            <a href="{% url 'sentry-explore-tag-value' project.team.slug project.slug tag_name|urlquote tag_value|urlquote %}">
+                            <a href="{% url 'sentry-explore-tag-value' project.team.slug project.slug tag_name|urlquote value_id %}">
                                 {{ tag_value }}
                                 <span>{{ times_seen|small_count }}</span>
                             </a>
diff --git a/src/sentry/templates/sentry/explore/tag_value_details.html b/src/sentry/templates/sentry/explore/tag_value_details.html
index e69de29bb2..34ba4d70d3 100644
--- a/src/sentry/templates/sentry/explore/tag_value_details.html
+++ b/src/sentry/templates/sentry/explore/tag_value_details.html
@@ -0,0 +1,60 @@
+{% extends "sentry/explore/tag_value_list.html" %}
+
+{% load i18n %}
+{% load sentry_helpers %}
+{% load sentry_plugins %}
+
+{% block title %}{{ tag_value.value }} | {{ block.super }}{% endblock %}
+
+{% block sidebar %}
+    <h6>{% trans "Details" %}</h6>
+    <dl>
+        <dt>{% trans "Key:" %}</dt>
+        <dd>
+            <a href="{% url 'sentry-explore-tag' team.slug project.slug tag_key.key %}">{{ tag_key.get_label }}</a>
+        </dd>
+        <dt>First Seen:</dt>
+        <dd>{{ tag_value.first_seen|timesince }}</dd>
+        <dt>Last Seen:</dt>
+        <dd>{{ tag_value.last_seen|timesince }}</dd>
+        <dt>Number of Events:</dt>
+        <dd>{{ tag_value.times_seen|small_count }}</dd>
+        <dt>Other Values for Tags:</dt>
+        <dd>{{ tag_key.values_seen|small_count }}</dd>
+    </dl>
+{% endblock %}
+
+{% block main %}
+    {% paginator event_list from request as event_list per_page MESSAGES_PER_PAGE %}
+
+    <div class="btn-toolbar">
+        <div class="pull-left">
+            <h2 style="line-height:1;">Explore by {{ tag_key.get_label }}
+                <small>{{ tag_value.value }}</small>
+            </h2>
+        </div>
+        <div class="btn-group pull-right">
+            <a class="btn prev{% if not event_list.paginator.has_previous %} disabled{% endif %}" href="?p={{ event_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
+            <a class="btn next{% if not event_list.paginator.has_next %} disabled{% endif %}" href="?p={{ event_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
+        </div>
+    </div>
+
+    <div id="event_list"></div>
+
+    <script>
+    $(function(){
+        new app.GroupListView({
+            className: 'group-list',
+            members: {{ event_list.paginator.objects|to_json:request|safe }},
+            id: "event_list"
+        });
+    });
+    </script>
+
+    <div class="btn-toolbar">
+        <div class="btn-group pull-right">
+            <a class="btn prev{% if not event_list.paginator.has_previous %} disabled{% endif %}" href="?p={{ event_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
+            <a class="btn next{% if not event_list.paginator.has_next %} disabled{% endif %}" href="?p={{ event_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
+        </div>
+    </div>
+{% endblock %}
diff --git a/src/sentry/templates/sentry/explore/tag_value_list.html b/src/sentry/templates/sentry/explore/tag_value_list.html
index e69de29bb2..38f31f7a10 100644
--- a/src/sentry/templates/sentry/explore/tag_value_list.html
+++ b/src/sentry/templates/sentry/explore/tag_value_list.html
@@ -0,0 +1,68 @@
+{% extends "sentry/bases/explore.html" %}
+
+{% load i18n %}
+{% load sentry_helpers %}
+{% load sentry_plugins %}
+
+{% block title %}{{ tag_key.get_label }} | {{ block.super }}{% endblock %}
+
+{% block inner %}
+    <div class="page-header">
+        <h2>
+            Explore by {{ tag_key.get_label }}
+        </h2>
+    </div>
+
+    {% paginator tag_values from request as tag_values %}
+    {% querystring from request without sort as sort_querystring %}
+
+    <div class="btn-toolbar">
+        <div class="btn-group">
+            <a href="#" class="btn dropdown-toggle" data-toggle="dropdown">{% blocktrans with sort_label as label %}Sort by: {{ label }}{% endblocktrans %} <span class="caret"></span></a>
+            <ul class="dropdown-menu">
+                <li{% ifequal sort 'recent' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=recent">{{ SORT_OPTIONS.recent }}</a></li>
+                <li{% ifequal sort 'newest' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=newest">{{ SORT_OPTIONS.newest }}</a></li>
+                <li{% ifequal sort 'events' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=events">{{ SORT_OPTIONS.events }}</a></li>
+            </ul>
+        </div>
+        <div class="btn-group pull-right">
+            <a class="btn prev{% if not tag_values.paginator.has_previous %} disabled{% endif %}" href="?{{ tag_values.query_string|escape }}&amp;p={{ tag_values.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
+            <a class="btn next{% if not tag_values.paginator.has_next %} disabled{% endif %}" href="?{{ tag_values.query_string|escape }}&amp;p={{ tag_values.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
+        </div>
+    </div>
+
+    {% if not tag_values.paginator.objects %}
+        <p>{% blocktrans %}You dont seem to have any data recorded for this tag. For more information on how to send this information consult your client's documentation.{% endblocktrans %}</p>
+    {% else %}
+        <table class="table table-bordered table-striped">
+            <thead>
+                <tr>
+                    <th>{{ tag_key.get_label }}</th>
+                    <th style="width:150px;text-align:center">{% trans "Last Seen" %}</th>
+                    <th style="width:100px;text-align:center">{% trans "Events Seen" %}</th>
+                </tr>
+            </thead>
+            <tbody>
+                {% for tag_value in tag_values.paginator.objects %}
+                    <tr>
+                        <td>
+                            
+                            <a href="{% url 'sentry-explore-tag-value' team.slug project.slug tag_value.key tag_value.id %}">
+                                {{ tag_value.value }}
+                            </a>
+                        </td>
+                        <td style="text-align:center">{{ tag_value.last_seen|timesince }}</td>
+                        <td style="text-align:center">{{ tag_value.times_seen|small_count }}</td>
+                    </tr>
+                {% endfor %}
+            </tbody>
+        </table>
+
+        <div class="btn-toolbar">
+            <div class="btn-group pull-right">
+                <a class="btn prev{% if not tag_values.paginator.has_previous %} disabled{% endif %}" href="?{{ tag_values.query_string|escape }}&amp;p={{ tag_values.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
+                <a class="btn next{% if not tag_values.paginator.has_next %} disabled{% endif %}" href="?{{ tag_values.query_string|escape }}&amp;p={{ tag_values.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
+            </div>
+        </div>
+    {% endif %}
+{% endblock %}
diff --git a/src/sentry/web/frontend/explore.py b/src/sentry/web/frontend/explore.py
index 356ddaa048..f6e7f936de 100644
--- a/src/sentry/web/frontend/explore.py
+++ b/src/sentry/web/frontend/explore.py
@@ -13,6 +13,13 @@ from sentry.models import TagKey, TagValue, Group
 from sentry.web.decorators import has_access
 from sentry.web.helpers import render_to_response
 
+DEFAULT_SORT_OPTION = 'recent'
+SORT_OPTIONS = {
+    'recent': 'Last Seen',
+    'newest': 'First Seen',
+    'events': 'Number of Events',
+}
+
 
 @has_access
 def tag_list(request, team, project):
@@ -27,10 +34,10 @@ def tag_list(request, team, project):
     tag_list = []
     for tag_name in tag_name_qs:
         tag_list.append((tag_name, [
-            (value, times_seen)
-            for (value, times_seen)
+            (id, value, times_seen)
+            for (id, value, times_seen)
             in tag_value_qs.filter(
-                key=tag_name).values_list('value', 'times_seen')[:5]
+                key=tag_name).values_list('id', 'value', 'times_seen')[:5]
         ]))
 
     return render_to_response('sentry/explore/tag_list.html', {
@@ -43,33 +50,50 @@ def tag_list(request, team, project):
 
 @has_access
 def tag_value_list(request, team, project, key):
+    tag_key = TagKey.objects.get(
+        project=project, key=key)
     tag_values_qs = TagValue.objects.filter(
-        project=project).order_by('-times_seen')
+        project=project, key=key)
+
+    sort = request.GET.get('sort')
+    if sort not in SORT_OPTIONS:
+        sort = DEFAULT_SORT_OPTION
+
+    if sort == 'recent':
+        tag_values_qs = tag_values_qs.order_by('-last_seen')
+    elif sort == 'newest':
+        tag_values_qs = tag_values_qs.order_by('-first_seen')
+    elif sort == 'events':
+        tag_values_qs = tag_values_qs.order_by('-times_seen')
 
     return render_to_response('sentry/explore/tag_value_list.html', {
         'SECTION': 'explore',
         'project': project,
         'team': team,
-        'title': key.replace('_', ' ').title(),
-        'tag_name': key,
+        'SORT_OPTIONS': SORT_OPTIONS,
+        'sort_label': SORT_OPTIONS[sort],
+        'tag_key': tag_key,
         'tag_values': tag_values_qs,
     }, request)
 
 
 @has_access
-def tag_value_details(request, team, project, key, value):
-    tag = TagValue.objects.get(
-        project=project, key=key, value=value)
+def tag_value_details(request, team, project, key, value_id):
+    tag_key = TagKey.objects.get(
+        project=project, key=key)
+    tag_value = TagValue.objects.get(
+        project=project, key=key, id=value_id)
 
     event_list = Group.objects.filter(
         grouptag__key=key,
-        grouptag__value=value,
+        grouptag__value=tag_value.value,
     ).order_by('-score')
 
     return render_to_response('sentry/explore/tag_value_details.html', {
         'SECTION': 'explore',
         'project': project,
         'team': team,
-        'tag': tag,
+        'tag_key': tag_key,
+        'tag_value': tag_value,
         'event_list': event_list,
     }, request)
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index 837548ab3d..8ed1c991c0 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -252,7 +252,7 @@ urlpatterns = patterns('',
         name='sentry-explore'),
     url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/(?P<key>[^\/]+)/$', explore.tag_value_list,
         name='sentry-explore-tag'),
-    url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/(?P<key>[^\/]+)/(?P<value>[^\/]+)/$', explore.tag_value_details,
+    url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/explore/(?P<key>[^\/]+)/(?P<value_id>\d+)/$', explore.tag_value_details,
         name='sentry-explore-tag-value'),
 
     url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/get-started/$', projects.get_started,
