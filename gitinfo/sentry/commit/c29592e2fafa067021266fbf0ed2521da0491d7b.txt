commit c29592e2fafa067021266fbf0ed2521da0491d7b
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Fri Oct 19 09:46:12 2018 -0700

    fix(ui): Fix Similar Issues redirect (#10189)
    
    After a similar issues merge, we were never redirecting to parent issue. This was causing several issues.
    
    Fixes JAVASCRIPT-4DW
    Fixes JAVASCRIPT-4GR
    Fixes JAVASCRIPT-4EB

diff --git a/src/sentry/static/sentry/app/__mocks__/api.jsx b/src/sentry/static/sentry/app/__mocks__/api.jsx
index e96200fb06..063b993fbd 100644
--- a/src/sentry/static/sentry/app/__mocks__/api.jsx
+++ b/src/sentry/static/sentry/app/__mocks__/api.jsx
@@ -52,15 +52,6 @@ class Client {
 
   static mockAsync = false;
 
-  merge(params, options) {
-    let path = '/projects/' + params.orgId + '/' + params.projectId + '/issues/';
-    return this.request(path, {
-      method: 'PUT',
-      data: {merge: 1},
-      ...options,
-    });
-  }
-
   wrapCallback(id, error) {
     return (...args) => {
       if (this.hasProjectBeenRenamed(...args)) return;
@@ -138,5 +129,6 @@ Client.prototype._chain = RealClient.Client.prototype._chain;
 Client.prototype._wrapRequest = RealClient.Client.prototype._wrapRequest;
 Client.prototype.hasProjectBeenRenamed =
   RealClient.Client.prototype.hasProjectBeenRenamed;
+Client.prototype.merge = RealClient.Client.prototype.merge;
 
 export {Client};
diff --git a/src/sentry/static/sentry/app/components/assigneeSelector.jsx b/src/sentry/static/sentry/app/components/assigneeSelector.jsx
index 793cc60f16..ea22e32b68 100644
--- a/src/sentry/static/sentry/app/components/assigneeSelector.jsx
+++ b/src/sentry/static/sentry/app/components/assigneeSelector.jsx
@@ -22,7 +22,6 @@ import ProjectsStore from 'app/stores/projectsStore';
 import SentryTypes from 'app/sentryTypes';
 import TextOverflow from 'app/components/textOverflow';
 import space from 'app/styles/space';
-import {addErrorMessage} from 'app/actionCreators/indicator';
 
 const AssigneeSelectorComponent = createReactClass({
   displayName: 'AssigneeSelector',
@@ -107,13 +106,6 @@ const AssigneeSelectorComponent = createReactClass({
   assignableTeams() {
     let group = GroupStore.get(this.props.id);
 
-    // TODO(billyvg): There seems to be a race condition after merging where `group`
-    // is not found in `GroupStore`, show an error toast for now
-    if (!group) {
-      addErrorMessage(t('Error loading teams, please try again.'));
-      return [];
-    }
-
     return (ProjectsStore.getBySlug(group.project.slug) || {
       teams: [],
     }).teams
diff --git a/src/sentry/static/sentry/app/stores/groupingStore.jsx b/src/sentry/static/sentry/app/stores/groupingStore.jsx
index c3ed821d58..730282af83 100644
--- a/src/sentry/static/sentry/app/stores/groupingStore.jsx
+++ b/src/sentry/static/sentry/app/stores/groupingStore.jsx
@@ -303,6 +303,12 @@ const GroupingStore = Reflux.createStore({
           },
           {
             success: (data, _, jqXHR) => {
+              if (data && data.merge && data.merge.parent) {
+                this.trigger({
+                  mergedParent: data.merge.parent,
+                });
+              }
+
               // Hide rows after successful merge
               this.setStateForId(this.mergeState, ids, {
                 checked: false,
@@ -330,14 +336,6 @@ const GroupingStore = Reflux.createStore({
     return promise;
   },
 
-  onMergeSuccess(id, ids, response) {
-    if (!response || !response.merge || !response.merge.parent) return;
-
-    this.trigger({
-      mergedParent: response.merge.parent,
-    });
-  },
-
   // Toggle collapsed state of all fingerprints
   onToggleCollapseFingerprints() {
     this.setStateForId(this.unmergeState, this.mergedItems.map(({id}) => id), {
diff --git a/src/sentry/static/sentry/app/views/groupSimilar/groupSimilarView.jsx b/src/sentry/static/sentry/app/views/groupSimilar/groupSimilarView.jsx
index ed2f088931..4da9de01ab 100644
--- a/src/sentry/static/sentry/app/views/groupSimilar/groupSimilarView.jsx
+++ b/src/sentry/static/sentry/app/views/groupSimilar/groupSimilarView.jsx
@@ -61,8 +61,11 @@ const GroupGroupingView = createReactClass({
         error: typeof error !== 'undefined' ? error : false,
       });
     } else if (mergedParent && mergedParent !== this.props.params.groupId) {
+      let {params} = this.props;
       // Merge success, since we can't specify target, we need to redirect to new parent
-      browserHistory.push(`/issues/${mergedParent}/similar/`);
+      browserHistory.push(
+        `/${params.orgId}/${params.projectId}/issues/${mergedParent}/similar/`
+      );
     }
   },
 
diff --git a/src/sentry/static/sentry/app/views/groupSimilar/similarItem.jsx b/src/sentry/static/sentry/app/views/groupSimilar/similarItem.jsx
index d8f725af20..b97ba1fca0 100644
--- a/src/sentry/static/sentry/app/views/groupSimilar/similarItem.jsx
+++ b/src/sentry/static/sentry/app/views/groupSimilar/similarItem.jsx
@@ -116,7 +116,12 @@ const SimilarIssueItem = createReactClass({
     });
 
     return (
-      <SpreadLayout className={cx} responsive onClick={this.handleToggle}>
+      <SpreadLayout
+        data-test-id="similar-item-row"
+        className={cx}
+        responsive
+        onClick={this.handleToggle}
+      >
         <FlowLayout truncate>
           <FlowLayout truncate>
             <div className="action-column">
diff --git a/src/sentry/static/sentry/app/views/groupSimilar/similarToolbar.jsx b/src/sentry/static/sentry/app/views/groupSimilar/similarToolbar.jsx
index e6349094ee..f452646026 100644
--- a/src/sentry/static/sentry/app/views/groupSimilar/similarToolbar.jsx
+++ b/src/sentry/static/sentry/app/views/groupSimilar/similarToolbar.jsx
@@ -44,6 +44,7 @@ const SimilarToolbar = createReactClass({
             <FlowLayout>
               <div className="similar-toolbar-actions">
                 <LinkWithConfirmation
+                  data-test-id="merge"
                   disabled={this.state.mergeCount === 0}
                   title={t(`Merging ${this.state.mergeCount} issues`)}
                   message={t('Are you sure you want to merge these issues?')}
diff --git a/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap b/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap
index 60447e7567..ed3900ec91 100644
--- a/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap
@@ -21,9 +21,9 @@ exports[`Issues Similar View renders with mocked data 1`] = `
   location={Object {}}
   params={
     Object {
-      "groupId": "groupId",
-      "orgId": "orgId",
-      "projectId": "projectId",
+      "groupId": "group-id",
+      "orgId": "org-slug",
+      "projectId": "project-slug",
     }
   }
 >
@@ -224,7 +224,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
           },
         ]
       }
-      groupId="groupId"
+      groupId="group-id"
       items={
         Array [
           Object {
@@ -280,8 +280,8 @@ exports[`Issues Similar View renders with mocked data 1`] = `
         ]
       }
       onMerge={[Function]}
-      orgId="orgId"
-      projectId="projectId"
+      orgId="org-slug"
+      projectId="project-slug"
     >
       <div
         className="similar-list-container"
@@ -416,6 +416,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                           >
                             <LinkWithConfirmation
                               className="btn btn-sm btn-default"
+                              data-test-id="merge"
                               disabled={true}
                               message="Are you sure you want to merge these issues?"
                               onConfirm={[Function]}
@@ -424,6 +425,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                               <Confirm
                                 cancelText="Cancel"
                                 confirmText="Confirm"
+                                data-test-id="merge"
                                 disableConfirmButton={false}
                                 disabled={true}
                                 message="Are you sure you want to merge these issues?"
@@ -545,7 +547,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                 "exception": 0.875,
               }
             }
-            groupId="groupId"
+            groupId="group-id"
             isBelowThreshold={false}
             issue={
               Object {
@@ -583,8 +585,8 @@ exports[`Issues Similar View renders with mocked data 1`] = `
               }
             }
             key="271"
-            orgId="orgId"
-            projectId="projectId"
+            orgId="org-slug"
+            projectId="project-slug"
             score={
               Object {
                 "exception:stacktrace:pairs": 0.875,
@@ -604,11 +606,13 @@ exports[`Issues Similar View renders with mocked data 1`] = `
             <SpreadLayout
               center={true}
               className="group similar-issue isResolved"
+              data-test-id="similar-item-row"
               onClick={[Function]}
               responsive={true}
             >
               <div
                 className="spread-layout group similar-issue isResolved center allow-responsive"
+                data-test-id="similar-item-row"
                 onClick={[Function]}
               >
                 <FlowLayout
@@ -687,8 +691,8 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                               }
                             }
                             includeLink={true}
-                            orgId="orgId"
-                            projectId="projectId"
+                            orgId="org-slug"
+                            projectId="project-slug"
                           >
                             <div
                               className="event-issue-header"
@@ -705,7 +709,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                     }
                                     to={
                                       Object {
-                                        "pathname": "/orgId/projectId/issues/271/",
+                                        "pathname": "/org-slug/project-slug/issues/271/",
                                         "search": "",
                                       }
                                     }
@@ -719,7 +723,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                       }
                                       to={
                                         Object {
-                                          "pathname": "/orgId/projectId/issues/271/",
+                                          "pathname": "/org-slug/project-slug/issues/271/",
                                           "search": "",
                                         }
                                       }
@@ -783,8 +787,8 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                             }
                                           }
                                           includeLink={true}
-                                          orgId="orgId"
-                                          projectId="projectId"
+                                          orgId="org-slug"
+                                          projectId="project-slug"
                                           style={
                                             Object {
                                               "fontWeight": 600,
@@ -852,7 +856,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                               }
                             }
                             numComments={0}
-                            orgId="orgId"
+                            orgId="org-slug"
                             permalink="http://localhost:8000/sentry/internal/issues/271/"
                             project={
                               Object {
@@ -860,7 +864,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                 "slug": "internal",
                               }
                             }
-                            projectId="projectId"
+                            projectId="project-slug"
                             shareId="312e323731"
                             shortId="INTERNAL-4G"
                             showAssignee={true}
@@ -981,7 +985,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                                 style={Object {}}
                                                 to={
                                                   Object {
-                                                    "pathname": "/orgId/projectId/",
+                                                    "pathname": "/org-slug/project-slug/",
                                                     "query": Object {
                                                       "query": "logger:javascript",
                                                     },
diff --git a/tests/js/spec/views/groupSimilarView.spec.jsx b/tests/js/spec/views/groupSimilarView.spec.jsx
index 41d5dc051d..a14928cfbc 100644
--- a/tests/js/spec/views/groupSimilarView.spec.jsx
+++ b/tests/js/spec/views/groupSimilarView.spec.jsx
@@ -1,5 +1,7 @@
 /* eslint-env jest */
+import {browserHistory} from 'react-router';
 import React from 'react';
+
 import {mount, shallow} from 'enzyme';
 import GroupSimilarView from 'app/views/groupSimilar/groupSimilarView';
 
@@ -30,14 +32,14 @@ describe('Issues Similar View', function() {
   let mock;
   beforeEach(function() {
     mock = MockApiClient.addMockResponse({
-      url: '/issues/groupId/similar/?limit=50',
+      url: '/issues/group-id/similar/?limit=50',
       body: mockData.similar,
     });
   });
 
   it('renders initially with loading component', function() {
     let component = shallow(
-      <GroupSimilarView params={{groupId: 'groupId'}} location={{}} />
+      <GroupSimilarView params={{groupId: 'group-id'}} location={{}} />
     );
 
     expect(component).toMatchSnapshot();
@@ -46,7 +48,7 @@ describe('Issues Similar View', function() {
   it('renders with mocked data', async function() {
     let wrapper = mount(
       <GroupSimilarView
-        params={{orgId: 'orgId', projectId: 'projectId', groupId: 'groupId'}}
+        params={{orgId: 'org-slug', projectId: 'project-slug', groupId: 'group-id'}}
         location={{}}
       />,
       TestStubs.routerContext()
@@ -58,4 +60,49 @@ describe('Issues Similar View', function() {
     expect(mock).toHaveBeenCalled();
     expect(wrapper.find('GroupGroupingView')).toMatchSnapshot();
   });
+
+  it('can merge and redirect to new parent', async function() {
+    let wrapper = mount(
+      <GroupSimilarView
+        params={{orgId: 'org-slug', projectId: 'project-slug', groupId: 'group-id'}}
+        location={{}}
+      />,
+      TestStubs.routerContext()
+    );
+    let merge = MockApiClient.addMockResponse({
+      method: 'PUT',
+      url: '/projects/org-slug/project-slug/issues/',
+      body: {
+        merge: {children: ['123'], parent: '321'},
+      },
+    });
+
+    await tick();
+    await tick();
+    wrapper.update();
+
+    wrapper
+      .find('[data-test-id="similar-item-row"]')
+      .first()
+      .simulate('click');
+
+    await tick();
+    wrapper.update();
+    wrapper.find('[data-test-id="merge"] a').simulate('click');
+    wrapper.find('Button[data-test-id="confirm-modal"]').simulate('click');
+
+    await tick();
+    wrapper.update();
+
+    expect(merge).toHaveBeenCalledWith(
+      '/projects/org-slug/project-slug/issues/',
+      expect.objectContaining({
+        data: {merge: 1},
+      })
+    );
+
+    expect(browserHistory.push).toHaveBeenCalledWith(
+      '/org-slug/project-slug/issues/321/similar/'
+    );
+  });
 });
