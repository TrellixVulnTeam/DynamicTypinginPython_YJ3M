commit c5ad980248e46e7e1d37a9f5eb12341a2bd4c748
Author: ted kaemming <ted@kaemming.com>
Date:   Wed Dec 5 16:02:23 2018 -0800

    fix(snuba): Run digests building/delivery with strict consistency (#10941)

diff --git a/src/sentry/tasks/digests.py b/src/sentry/tasks/digests.py
index 0044879740..e739a96ca7 100644
--- a/src/sentry/tasks/digests.py
+++ b/src/sentry/tasks/digests.py
@@ -14,6 +14,7 @@ from sentry.models import (
     ProjectOption,
 )
 from sentry.tasks.base import instrumented_task
+from sentry.utils import snuba
 
 logger = logging.getLogger(__name__)
 
@@ -54,12 +55,13 @@ def deliver_digest(key, schedule_timestamp=None):
         project, get_option_key(plugin.get_conf_key(), 'minimum_delay')
     )
 
-    try:
-        with digests.digest(key, minimum_delay=minimum_delay) as records:
-            digest = build_digest(project, records)
-    except InvalidState as error:
-        logger.info('Skipped digest delivery: %s', error, exc_info=True)
-        return
+    with snuba.options_override({'consistent': True}):
+        try:
+            with digests.digest(key, minimum_delay=minimum_delay) as records:
+                digest = build_digest(project, records)
+        except InvalidState as error:
+            logger.info('Skipped digest delivery: %s', error, exc_info=True)
+            return
 
-    if digest:
-        plugin.notify_digest(project, digest)
+        if digest:
+            plugin.notify_digest(project, digest)
