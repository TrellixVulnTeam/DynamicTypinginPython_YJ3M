commit 0489db0e6dfe69bcb475f98304b5fe4e30e590de
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Mon Aug 20 11:59:41 2018 -0700

    feat(bitbucket): Add feature flag (#9427)

diff --git a/src/sentry/api/endpoints/organization_config_integrations.py b/src/sentry/api/endpoints/organization_config_integrations.py
index ca9bcef686..2034b7487a 100644
--- a/src/sentry/api/endpoints/organization_config_integrations.py
+++ b/src/sentry/api/endpoints/organization_config_integrations.py
@@ -12,6 +12,9 @@ from django.conf import settings
 
 class OrganizationConfigIntegrationsEndpoint(OrganizationEndpoint):
     def get(self, request, organization):
+        has_bb = features.has('organizations:bitbucket-integration',
+                              organization,
+                              actor=request.user)
         has_ghe = features.has('organizations:github-enterprise',
                                organization,
                                actor=request.user)
@@ -25,6 +28,8 @@ class OrganizationConfigIntegrationsEndpoint(OrganizationEndpoint):
         providers = []
         for provider in integrations.all():
             internal_integrations = {i for i in settings.SENTRY_INTERNAL_INTEGRATIONS}
+            if has_bb:
+                internal_integrations.remove('bitbucket')
             if has_ghe:
                 internal_integrations.remove('github_enterprise')
             if has_github_apps:
diff --git a/src/sentry/api/endpoints/organization_repositories.py b/src/sentry/api/endpoints/organization_repositories.py
index 07c6474a83..ab7e8e9bfc 100644
--- a/src/sentry/api/endpoints/organization_repositories.py
+++ b/src/sentry/api/endpoints/organization_repositories.py
@@ -75,8 +75,11 @@ class OrganizationRepositoriesEndpoint(OrganizationEndpoint):
         provider_id = request.DATA.get('provider')
         has_ghe = provider_id == 'integrations:github_enterprise' and features.has(
             'organizations:github-enterprise', organization, actor=request.user)
+        has_bb = provider_id == 'integrations:bitbucket' and features.has(
+            'organizations:bitbucket-integration', organization, actor=request.user)
+
         if features.has('organizations:internal-catchall', organization,
-                        actor=request.user) or has_ghe:
+                        actor=request.user) or has_ghe or has_bb:
             if provider_id is not None and provider_id.startswith('integrations:'):
                 try:
                     provider_cls = bindings.get('integration-repository.provider').get(provider_id)
diff --git a/src/sentry/api/serializers/models/organization.py b/src/sentry/api/serializers/models/organization.py
index 61aa146680..22c1e2a5f1 100644
--- a/src/sentry/api/serializers/models/organization.py
+++ b/src/sentry/api/serializers/models/organization.py
@@ -125,6 +125,8 @@ class DetailedOrganizationSerializer(OrganizationSerializer):
             feature_list.append('new-issue-ui')
         if features.has('organizations:github-enterprise', obj, actor=user):
             feature_list.append('github-enterprise')
+        if features.has('organizations:bitbucket-integration', obj, actor=user):
+            feature_list.append('bitbucket-integration')
         if features.has('organizations:suggested-commits', obj, actor=user):
             feature_list.append('suggested-commits')
         if features.has('organizations:new-teams', obj, actor=user):
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 07764d55fe..cdbf7edbc7 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -776,6 +776,7 @@ SENTRY_FEATURES = {
     'organizations:internal-catchall': False,
     'organizations:new-issue-ui': False,
     'organizations:github-enterprise': False,
+    'organizations:bitbucket-integration': False,
     'organizations:new-teams': True,
     'organizations:unreleased-changes': False,
     'organizations:suggested-commits': True,
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index 8b110d8f06..dc9b683fc3 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -25,6 +25,7 @@ default_manager.add('organizations:require-2fa', OrganizationFeature)  # NOQA
 default_manager.add('organizations:internal-catchall', OrganizationFeature)  # NOQA
 default_manager.add('organizations:new-issue-ui', OrganizationFeature)  # NOQA
 default_manager.add('organizations:github-enterprise', OrganizationFeature)  # NOQA
+default_manager.add('organizations:bitbucket-integration', OrganizationFeature)  # NOQA
 default_manager.add('organizations:new-teams', OrganizationFeature)  # NOQA
 default_manager.add('organizations:unreleased-changes', OrganizationFeature)  # NOQA
 default_manager.add('organizations:environments', OrganizationFeature)  # NOQA
