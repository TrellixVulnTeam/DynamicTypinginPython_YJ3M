commit 6d0f3ae48f49736e2ba25b3b8666b84dccfa1774
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Sep 12 11:17:22 2016 -0700

    Prevent non-owners from mutating default role (#4101)
    
    * Prevent non-owners from mutating default role

diff --git a/src/sentry/templates/sentry/organization-settings.html b/src/sentry/templates/sentry/organization-settings.html
index c48c8531f2..f0449c3668 100644
--- a/src/sentry/templates/sentry/organization-settings.html
+++ b/src/sentry/templates/sentry/organization-settings.html
@@ -27,7 +27,9 @@
 
         <legend>Membership</legend>
 
-        {{ form.default_role|as_crispy_field }}
+        {% if form.default_role %}
+          {{ form.default_role|as_crispy_field }}
+        {% endif %}
         {{ form.allow_joinleave|as_crispy_field }}
 
         <legend>Security &amp; Privacy</legend>
diff --git a/src/sentry/web/frontend/organization_settings.py b/src/sentry/web/frontend/organization_settings.py
index d12cba8cb7..6f2c04438b 100644
--- a/src/sentry/web/frontend/organization_settings.py
+++ b/src/sentry/web/frontend/organization_settings.py
@@ -74,6 +74,11 @@ class OrganizationSettingsForm(forms.ModelForm):
         fields = ('name', 'slug', 'default_role')
         model = Organization
 
+    def __init__(self, has_delete, *args, **kwargs):
+        super(OrganizationSettingsForm, self).__init__(*args, **kwargs)
+        if not has_delete:
+            del self.fields['default_role']
+
     def clean_sensitive_fields(self):
         value = self.cleaned_data.get('sensitive_fields')
         if not value:
@@ -86,8 +91,11 @@ class OrganizationSettingsView(OrganizationView):
     required_scope = 'org:write'
 
     def get_form(self, request, organization):
+        has_delete = request.access.has_scope('org:delete')
+
         return OrganizationSettingsForm(
-            request.POST or None,
+            has_delete=has_delete,
+            data=request.POST or None,
             instance=organization,
             initial={
                 'default_role': organization.default_role,
diff --git a/tests/sentry/web/frontend/test_organization_settings.py b/tests/sentry/web/frontend/test_organization_settings.py
index 036bd5546d..27450d0113 100644
--- a/tests/sentry/web/frontend/test_organization_settings.py
+++ b/tests/sentry/web/frontend/test_organization_settings.py
@@ -58,3 +58,26 @@ class OrganizationSettingsTest(TestCase):
         assert organization.name == 'bar'
         assert organization.slug == 'bar'
         assert organization.default_role == 'admin'
+
+    def test_manager_cannot_change_default_role(self):
+        user = self.create_user('foo@example.com', is_superuser=False)
+        organization = self.create_organization(name='foo')
+        self.create_member(organization=organization, user=user, role='manager')
+
+        path = reverse('sentry-organization-settings', args=[organization.slug])
+
+        self.login_as(user)
+
+        resp = self.client.post(path, {
+            'name': 'bar',
+            'slug': 'bar',
+            'default_role': 'owner',
+        })
+
+        assert resp.status_code == 302
+
+        organization = Organization.objects.get(id=organization.id)
+
+        assert organization.name == 'bar'
+        assert organization.slug == 'bar'
+        assert organization.default_role == 'member'
