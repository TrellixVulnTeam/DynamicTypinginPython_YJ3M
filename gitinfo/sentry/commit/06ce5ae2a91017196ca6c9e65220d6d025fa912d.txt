commit 06ce5ae2a91017196ca6c9e65220d6d025fa912d
Author: adhiraj <693121+adhiraj@users.noreply.github.com>
Date:   Tue Nov 20 19:14:50 2018 -0800

    feat(analytics): Track view-issue event from activity emails (#10693)

diff --git a/src/sentry/plugins/sentry_mail/activity/base.py b/src/sentry/plugins/sentry_mail/activity/base.py
index 26c99fc0ee..efc048101a 100644
--- a/src/sentry/plugins/sentry_mail/activity/base.py
+++ b/src/sentry/plugins/sentry_mail/activity/base.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 from django.core.urlresolvers import reverse
 from django.utils.html import escape, mark_safe
+from six.moves.urllib.parse import urlparse, urlunparse
 
 from sentry import options
 from sentry.models import (
@@ -63,13 +64,8 @@ class ActivityEmail(object):
         ))
 
     def get_group_link(self):
-        return absolute_uri(
-            u'/{}/{}/issues/{}/'.format(
-                self.organization.slug,
-                self.project.slug,
-                self.group.id,
-            )
-        )
+        referrer = self.__class__.__name__
+        return self.group.get_absolute_url(params={'referrer': referrer})
 
     def get_base_context(self):
         activity = self.activity
@@ -86,12 +82,15 @@ class ActivityEmail(object):
 
     def get_group_context(self):
         group_link = self.get_group_link()
-        activity_link = u'{}activity/'.format(group_link)
+        parts = list(urlparse(group_link))
+        parts[2] = parts[2].rstrip('/') + '/activity/'
+        activity_link = urlunparse(parts)
 
         return {
             'group': self.group,
             'link': group_link,
             'activity_link': activity_link,
+            'referrer': self.__class__.__name__,
         }
 
     def get_email_type(self):
diff --git a/src/sentry/templates/sentry/emails/_group.html b/src/sentry/templates/sentry/emails/_group.html
index 1e378e3aab..fdd30d31e1 100644
--- a/src/sentry/templates/sentry/emails/_group.html
+++ b/src/sentry/templates/sentry/emails/_group.html
@@ -1,6 +1,6 @@
 {% load sentry_helpers %}
 
-{% url 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}
+{% url_with_referrer 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}
 
 {% with type=group.get_event_type metadata=group.get_event_metadata transaction=group.culprit %}
 <div class="issue {% if group.is_resolved %}resolved{% endif %}">
diff --git a/src/sentry/templates/sentry/emails/digests/body.txt b/src/sentry/templates/sentry/emails/digests/body.txt
index 98835f19a3..ea5b4177e8 100644
--- a/src/sentry/templates/sentry/emails/digests/body.txt
+++ b/src/sentry/templates/sentry/emails/digests/body.txt
@@ -4,7 +4,7 @@
 {% for rule, groups in digest.iteritems %}{{ rule.label }}
 
 {% for group, records in groups.iteritems %}* {{ group.title }} ({{ group.event_count }} event{{ group.event_count|pluralize }}, {{ group.user_count }} user{{ group.user_count|pluralize }})
-  {% url 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}{% absolute_uri group_link %}
+  {% url 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}{% absolute_uri group_link %}?referrer=digest_email
 
 {% endfor %}{% endfor %}
 
diff --git a/src/sentry/templates/sentry/emails/group_header.html b/src/sentry/templates/sentry/emails/group_header.html
index 7f4fe8f8bb..904edeaf7f 100644
--- a/src/sentry/templates/sentry/emails/group_header.html
+++ b/src/sentry/templates/sentry/emails/group_header.html
@@ -1,6 +1,5 @@
 {% load sentry_helpers %}
 
-{% url 'sentry-group' group.organization.slug group.project.slug group.id as group_link %}
 {% url 'sentry-stream' group.organization.slug group.project.slug as project_link %}
 <div class="group-header">
   <table class="group-stats">
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index 2f95de235a..6c408b1b76 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -15,6 +15,7 @@ from random import randint
 
 import six
 from django import template
+from django.core.urlresolvers import reverse
 from django.template.defaultfilters import stringfilter
 from django.utils import timezone
 from django.utils.html import escape
@@ -116,6 +117,14 @@ def absolute_uri(parser, token):
     return AbsoluteUriNode(bits, target_var)
 
 
+@register.assignment_tag(takes_context=True)
+def url_with_referrer(context, viewname, *args):
+    url = reverse(viewname, args=args)
+    if context.get('referrer'):
+        url += '?referrer=%s' % context['referrer']
+    return url
+
+
 @register.simple_tag
 def system_origin():
     from sentry.utils.http import absolute_uri, origin_from_url
diff --git a/src/sentry/web/frontend/debug/mail.py b/src/sentry/web/frontend/debug/mail.py
index 9c19fa3813..06a3da0c56 100644
--- a/src/sentry/web/frontend/debug/mail.py
+++ b/src/sentry/web/frontend/debug/mail.py
@@ -366,6 +366,7 @@ def digest(request):
         'digest': digest,
         'start': start,
         'end': end,
+        'referrer': 'digest_email',
     }
     add_unsubscribe_link(context)
 
diff --git a/tests/fixtures/emails/assigned.txt b/tests/fixtures/emails/assigned.txt
index a877926466..4e04e31a10 100644
--- a/tests/fixtures/emails/assigned.txt
+++ b/tests/fixtures/emails/assigned.txt
@@ -7,7 +7,7 @@ foo@example.com assigned an issue to foo@example.com
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=AssignedActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/assigned_self.txt b/tests/fixtures/emails/assigned_self.txt
index a6c4bf6f4f..092aa774c8 100644
--- a/tests/fixtures/emails/assigned_self.txt
+++ b/tests/fixtures/emails/assigned_self.txt
@@ -7,7 +7,7 @@ foo@example.com assigned an issue to themselves
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=AssignedActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/digest.txt b/tests/fixtures/emails/digest.txt
index 10225ff44c..31967dd93b 100644
--- a/tests/fixtures/emails/digest.txt
+++ b/tests/fixtures/emails/digest.txt
@@ -4,22 +4,22 @@ June 8, 2016, 7:25 a.m. UTC to July 4, 2016, 2:11 p.m. UTC
 Rule #1
 
 * CursusError: nibh curabitur (9729 events, 5901 users)
-  http://testserver/example/example/issues/9/
+  http://testserver/example/example/issues/9/?referrer=digest_email
 
 * CuraeError: pulvinar fames suspendisse erat integer ad magna (7555 events, 4549 users)
-  http://testserver/example/example/issues/15/
+  http://testserver/example/example/issues/15/?referrer=digest_email
 
 * erat pellentesque enim imperdiet tortor (3180 events, 276 users)
-  http://testserver/example/example/issues/16/
+  http://testserver/example/example/issues/16/?referrer=digest_email
 
 * NecVivamusError: consequat ipsum proin gravida inceptos scelerisque inceptos iaculis libero vulputate (2824 events, 1188 users)
-  http://testserver/example/example/issues/14/
+  http://testserver/example/example/issues/14/?referrer=digest_email
 
 * LectusDapibusTacitiError: semper porta curae luctus fermentum molestie praesent ac auctor (2358 events, 7906 users)
-  http://testserver/example/example/issues/2/
+  http://testserver/example/example/issues/2/?referrer=digest_email
 
 * VelTorquentError: porttitor praesent ridiculus (562 events, 8950 users)
-  http://testserver/example/example/issues/13/
+  http://testserver/example/example/issues/13/?referrer=digest_email
 
 
 
diff --git a/tests/fixtures/emails/note.txt b/tests/fixtures/emails/note.txt
index c05d2d41be..764dc889d6 100644
--- a/tests/fixtures/emails/note.txt
+++ b/tests/fixtures/emails/note.txt
@@ -9,6 +9,6 @@ metus volutpat
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/activity/
+http://testserver/organization/project/issues/1/activity/?referrer=NoteActivityEmail
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/regression.txt b/tests/fixtures/emails/regression.txt
index 0b7be7acf2..d6e79e70a1 100644
--- a/tests/fixtures/emails/regression.txt
+++ b/tests/fixtures/emails/regression.txt
@@ -7,7 +7,7 @@ Sentry marked an issue as a regression
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=RegressionActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/regression_with_version.txt b/tests/fixtures/emails/regression_with_version.txt
index 24302cd613..dc428cdbb1 100644
--- a/tests/fixtures/emails/regression_with_version.txt
+++ b/tests/fixtures/emails/regression_with_version.txt
@@ -7,7 +7,7 @@ Sentry marked an issue as a regression in abcdef
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=RegressionActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/resolved.txt b/tests/fixtures/emails/resolved.txt
index 9a6c70b873..dcad5d5ce4 100644
--- a/tests/fixtures/emails/resolved.txt
+++ b/tests/fixtures/emails/resolved.txt
@@ -7,7 +7,7 @@ Sentry marked an issue as resolved
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=ResolvedActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/resolved_in_release.txt b/tests/fixtures/emails/resolved_in_release.txt
index f99a6c3b4a..d93957b211 100644
--- a/tests/fixtures/emails/resolved_in_release.txt
+++ b/tests/fixtures/emails/resolved_in_release.txt
@@ -7,7 +7,7 @@ Sentry marked an issue as resolved in abcdef
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=ResolvedInReleaseActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/resolved_in_release_upcoming.txt b/tests/fixtures/emails/resolved_in_release_upcoming.txt
index 41047946d1..ae76342333 100644
--- a/tests/fixtures/emails/resolved_in_release_upcoming.txt
+++ b/tests/fixtures/emails/resolved_in_release_upcoming.txt
@@ -7,7 +7,7 @@ Sentry marked an issue as resolved in an upcoming release
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=ResolvedInReleaseActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
diff --git a/tests/fixtures/emails/unassigned.txt b/tests/fixtures/emails/unassigned.txt
index 71f10cd156..8eca8792dc 100644
--- a/tests/fixtures/emails/unassigned.txt
+++ b/tests/fixtures/emails/unassigned.txt
@@ -7,7 +7,7 @@ foo@example.com unassigned an issue
 
 ornare elit pulvinar nisl integer cum ad massa
 
-http://testserver/organization/project/issues/1/
+http://testserver/organization/project/issues/1/?referrer=UnassignedActivityEmail
 
 
 Unsubscribe: javascript:alert("This is a preview page, what did you expect to happen?");
