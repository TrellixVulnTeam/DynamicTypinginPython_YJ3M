commit e5a34b31d5fc54fa3797e2f42b1a2fbdfe519d30
Author: Mark Story <mark@sentry.io>
Date:   Wed Oct 30 16:41:50 2019 -0400

    fix(discover) Allow 'all projects' to be used in a saved query (#15352)
    
    Saved queries have foreign keys to projects, which prevents us from
    simply storing the `-1` value. Instead we have to use a key in the query
    payload and reverse that flag when serializing responses.

diff --git a/src/sentry/api/bases/organization.py b/src/sentry/api/bases/organization.py
index 33776c6079..7206b2a8b5 100644
--- a/src/sentry/api/bases/organization.py
+++ b/src/sentry/api/bases/organization.py
@@ -10,6 +10,7 @@ from sentry.api.helpers.environments import get_environments
 from sentry.api.permissions import SentryPermission
 from sentry.api.utils import get_date_range_from_params, InvalidParams
 from sentry.auth.superuser import is_active_superuser
+from sentry.constants import ALL_ACCESS_PROJECTS
 from sentry.models import (
     ApiKey,
     Authenticator,
@@ -31,9 +32,6 @@ class NoProjects(Exception):
     pass
 
 
-ALL_ACCESS_PROJECTS = {-1}
-
-
 class OrganizationPermission(SentryPermission):
     scope_map = {
         "GET": ["org:read", "org:write", "org:admin"],
diff --git a/src/sentry/api/serializers/models/discoversavedquery.py b/src/sentry/api/serializers/models/discoversavedquery.py
index c048e96409..6726deae1c 100644
--- a/src/sentry/api/serializers/models/discoversavedquery.py
+++ b/src/sentry/api/serializers/models/discoversavedquery.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 import six
 from sentry.api.serializers import Serializer, register
+from sentry.constants import ALL_ACCESS_PROJECTS
 from sentry.discover.models import DiscoverSavedQuery
 
 
@@ -37,4 +38,7 @@ class DiscoverSavedQuerySerializer(Serializer):
             if obj.query.get(key) is not None:
                 data[key] = obj.query[key]
 
+        if obj.query.get("all_projects"):
+            data["projects"] = list(ALL_ACCESS_PROJECTS)
+
         return data
diff --git a/src/sentry/constants.py b/src/sentry/constants.py
index dd1396bf5f..a32ae4c3e1 100644
--- a/src/sentry/constants.py
+++ b/src/sentry/constants.py
@@ -476,3 +476,5 @@ DEFAULT_STORE_NORMALIZER_ARGS = dict(
 )
 
 INTERNAL_INTEGRATION_TOKEN_COUNT_MAX = 20
+
+ALL_ACCESS_PROJECTS = {-1}
diff --git a/src/sentry/discover/endpoints/serializers.py b/src/sentry/discover/endpoints/serializers.py
index b559d2d640..785736454a 100644
--- a/src/sentry/discover/endpoints/serializers.py
+++ b/src/sentry/discover/endpoints/serializers.py
@@ -9,6 +9,7 @@ from sentry.models import Project, ProjectStatus
 from sentry.api.fields.empty_integer import EmptyIntegerField
 from sentry.api.serializers.rest_framework import ListField
 from sentry.api.utils import get_date_range_from_params, InvalidParams
+from sentry.constants import ALL_ACCESS_PROJECTS
 from sentry.utils.snuba import SENTRY_SNUBA_MAP
 
 
@@ -168,13 +169,16 @@ class DiscoverSavedQuerySerializer(serializers.Serializer):
     def validate_projects(self, projects):
         organization = self.context["organization"]
 
+        projects = set(projects)
+        if projects == ALL_ACCESS_PROJECTS:
+            return projects
+
         org_projects = set(
             Project.objects.filter(
                 organization=organization, id__in=projects, status=ProjectStatus.VISIBLE
             ).values_list("id", flat=True)
         )
-
-        if set(projects) != org_projects:
+        if projects != org_projects:
             raise PermissionDenied
 
         return projects
@@ -211,6 +215,10 @@ class DiscoverSavedQuerySerializer(serializers.Serializer):
                     "You must provide an equal number of field names and fields"
                 )
 
+            if data["projects"] == ALL_ACCESS_PROJECTS:
+                data["projects"] = []
+                query["all_projects"] = True
+
         return {"name": data["name"], "project_ids": data["projects"], "query": query}
 
     def validate_version_fields(self, version, query):
diff --git a/tests/snuba/api/endpoints/test_discover_saved_queries.py b/tests/snuba/api/endpoints/test_discover_saved_queries.py
index e4c2bc692c..fe5e79809e 100644
--- a/tests/snuba/api/endpoints/test_discover_saved_queries.py
+++ b/tests/snuba/api/endpoints/test_discover_saved_queries.py
@@ -194,3 +194,19 @@ class DiscoverSavedQueriesVersion2Test(DiscoverSavedQueryBase):
                 },
             )
         assert response.status_code == 201, response.content
+
+    def test_post_all_projects(self):
+        with self.feature(self.feature_name):
+            url = reverse("sentry-api-0-discover-saved-queries", args=[self.org.slug])
+            response = self.client.post(
+                url,
+                {
+                    "name": "New query",
+                    "projects": [-1],
+                    "fields": ["title", "count()"],
+                    "range": "24h",
+                    "version": 2,
+                },
+            )
+        assert response.status_code == 201, response.content
+        assert response.data["projects"] == [-1]
