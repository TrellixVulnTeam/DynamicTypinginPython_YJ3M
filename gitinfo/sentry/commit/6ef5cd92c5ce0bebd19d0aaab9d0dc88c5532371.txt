commit 6ef5cd92c5ce0bebd19d0aaab9d0dc88c5532371
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu Apr 20 02:09:21 2017 +0200

    Add organization_id to distributions and handle in task deletion

diff --git a/src/sentry/models/distribution.py b/src/sentry/models/distribution.py
index 01adb3918d..bf1582376d 100644
--- a/src/sentry/models/distribution.py
+++ b/src/sentry/models/distribution.py
@@ -10,12 +10,14 @@ from __future__ import absolute_import
 from django.db import models
 from django.utils import timezone
 
-from sentry.db.models import Model, FlexibleForeignKey, sane_repr
+from sentry.db.models import Model, BoundedPositiveIntegerField, \
+    FlexibleForeignKey, sane_repr
 
 
 class Distribution(Model):
     __core__ = False
 
+    organization_id = BoundedPositiveIntegerField(db_index=True)
     release = FlexibleForeignKey('sentry.Release')
     name = models.CharField(max_length=64)
     date_added = models.DateTimeField(default=timezone.now)
diff --git a/src/sentry/models/release.py b/src/sentry/models/release.py
index 38f9c49883..f93f7ba102 100644
--- a/src/sentry/models/release.py
+++ b/src/sentry/models/release.py
@@ -206,7 +206,10 @@ class Release(Model):
         return Distribution.objects.get_or_create(
             release=self,
             name=name,
-            defaults={'date_added': date_added}
+            defaults={
+                'date_added': date_added,
+                'organization_id': self.organization_id,
+            }
         )[0]
 
     def add_project(self, project):
diff --git a/src/sentry/south_migrations/0313_auto__add_distribution__add_unique_distribution_release_name__add_fiel.py b/src/sentry/south_migrations/0313_auto__add_distribution__add_unique_distribution_release_name__add_fiel.py
index 143eab4391..2f45c48cd9 100644
--- a/src/sentry/south_migrations/0313_auto__add_distribution__add_unique_distribution_release_name__add_fiel.py
+++ b/src/sentry/south_migrations/0313_auto__add_distribution__add_unique_distribution_release_name__add_fiel.py
@@ -11,9 +11,10 @@ class Migration(SchemaMigration):
         # Adding model 'Distribution'
         db.create_table('sentry_distribution', (
             ('id', self.gf('sentry.db.models.fields.bounded.BoundedBigAutoField')(primary_key=True)),
+            ('organization_id', self.gf('sentry.db.models.fields.bounded.BoundedPositiveIntegerField')(db_index=True)),
             ('release', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.Release'])),
             ('name', self.gf('django.db.models.fields.CharField')(max_length=64)),
-            ('date_added', self.gf('django.db.models.fields.DateTimeField')()),
+            ('date_added', self.gf('django.db.models.fields.DateTimeField')(default=datetime.datetime.now)),
         ))
         db.send_create_signal('sentry', ['Distribution'])
 
@@ -52,12 +53,12 @@ class Migration(SchemaMigration):
         'sentry.apiapplication': {
             'Meta': {'object_name': 'ApiApplication'},
             'allowed_origins': ('django.db.models.fields.TextField', [], {'null': 'True', 'blank': 'True'}),
-            'client_id': ('django.db.models.fields.CharField', [], {'default': "'0d521b5ef4f547cfb5c4a27124a1e39e25d7ce1aa6d74175b0f390b49902d002'", 'unique': 'True', 'max_length': '64'}),
-            'client_secret': ('sentry.db.models.fields.encrypted.EncryptedTextField', [], {'default': "'45b2a5238cdd43a18d0ee6e652e4d5405c529167a2ad45c388a7c20bf7901e3d'"}),
+            'client_id': ('django.db.models.fields.CharField', [], {'default': "'e66a7f08f1ce49708025c83e47577b58bd0b8fdcae3640c3945ab5feffba3dc6'", 'unique': 'True', 'max_length': '64'}),
+            'client_secret': ('sentry.db.models.fields.encrypted.EncryptedTextField', [], {'default': "'71957d6fc8af455b845b9c565787fbc0c37bb4557c044a21a5d80f06ed14748e'"}),
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
             'homepage_url': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
-            'name': ('django.db.models.fields.CharField', [], {'default': "'Cacographical Essie'", 'max_length': '64', 'blank': 'True'}),
+            'name': ('django.db.models.fields.CharField', [], {'default': "'Isacoustic Haven'", 'max_length': '64', 'blank': 'True'}),
             'owner': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.User']"}),
             'privacy_url': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True'}),
             'redirect_uris': ('django.db.models.fields.TextField', [], {}),
@@ -76,8 +77,8 @@ class Migration(SchemaMigration):
         'sentry.apigrant': {
             'Meta': {'object_name': 'ApiGrant'},
             'application': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.ApiApplication']"}),
-            'code': ('django.db.models.fields.CharField', [], {'default': "'90df8ff3b79b4bf39f36b00512ebfc8a'", 'max_length': '64', 'db_index': 'True'}),
-            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 4, 19, 0, 0)', 'db_index': 'True'}),
+            'code': ('django.db.models.fields.CharField', [], {'default': "'94559ef2f5c64e008de66fb7025bb44c'", 'max_length': '64', 'db_index': 'True'}),
+            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 4, 20, 0, 0)', 'db_index': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'redirect_uri': ('django.db.models.fields.CharField', [], {'max_length': '255'}),
             'scope_list': ('sentry.db.models.fields.array.ArrayField', [], {'of': ('django.db.models.fields.TextField', [], {})}),
@@ -100,12 +101,12 @@ class Migration(SchemaMigration):
             'Meta': {'object_name': 'ApiToken'},
             'application': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.ApiApplication']", 'null': 'True'}),
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 5, 19, 0, 0)', 'null': 'True'}),
+            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 5, 20, 0, 0)', 'null': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
-            'refresh_token': ('django.db.models.fields.CharField', [], {'default': "'7dca8d8ae7394809b711d63c460dc0ab8c2c2db50fb749ea84db0c7b48e8696a'", 'max_length': '64', 'unique': 'True', 'null': 'True'}),
+            'refresh_token': ('django.db.models.fields.CharField', [], {'default': "'04c1998d016049b9bbbf06444d015477bd324a090c3f4ddfa5a9f46c0bf09dca'", 'max_length': '64', 'unique': 'True', 'null': 'True'}),
             'scope_list': ('sentry.db.models.fields.array.ArrayField', [], {'of': ('django.db.models.fields.TextField', [], {})}),
             'scopes': ('django.db.models.fields.BigIntegerField', [], {'default': 'None'}),
-            'token': ('django.db.models.fields.CharField', [], {'default': "'f407098cb4944c528fc2786e8e27d707a1f30b8b73ba472381ddb91d249738d1'", 'unique': 'True', 'max_length': '64'}),
+            'token': ('django.db.models.fields.CharField', [], {'default': "'bd357d14b0564d7196bc4796e3f411ba86ff0bd1472f4e5aa9eb4418f05fcb76'", 'unique': 'True', 'max_length': '64'}),
             'user': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.User']"})
         },
         'sentry.auditlogentry': {
@@ -159,7 +160,7 @@ class Migration(SchemaMigration):
         'sentry.broadcast': {
             'Meta': {'object_name': 'Broadcast'},
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 4, 26, 0, 0)', 'null': 'True', 'blank': 'True'}),
+            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 4, 27, 0, 0)', 'null': 'True', 'blank': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_active': ('django.db.models.fields.BooleanField', [], {'default': 'True', 'db_index': 'True'}),
             'link': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True', 'blank': 'True'}),
@@ -218,9 +219,10 @@ class Migration(SchemaMigration):
         },
         'sentry.distribution': {
             'Meta': {'unique_together': "(('release', 'name'),)", 'object_name': 'Distribution'},
-            'date_added': ('django.db.models.fields.DateTimeField', [], {}),
+            'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'name': ('django.db.models.fields.CharField', [], {'max_length': '64'}),
+            'organization_id': ('sentry.db.models.fields.bounded.BoundedPositiveIntegerField', [], {'db_index': 'True'}),
             'release': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.Release']"})
         },
         'sentry.dsymapp': {
@@ -829,7 +831,7 @@ class Migration(SchemaMigration):
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_verified': ('django.db.models.fields.BooleanField', [], {'default': 'False'}),
             'user': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'related_name': "'emails'", 'to': "orm['sentry.User']"}),
-            'validation_hash': ('django.db.models.fields.CharField', [], {'default': "u'rRqta6UczT1X5VXnGeMAO0p7q6zmMM3o'", 'max_length': '32'})
+            'validation_hash': ('django.db.models.fields.CharField', [], {'default': "u'DTQWewnThGD8LznbDFxMlSpbpLRpg12o'", 'max_length': '32'})
         },
         'sentry.useroption': {
             'Meta': {'unique_together': "(('user', 'project', 'key'),)", 'object_name': 'UserOption'},
diff --git a/src/sentry/tasks/deletion.py b/src/sentry/tasks/deletion.py
index a6df6e4ba8..9a77cd66ef 100644
--- a/src/sentry/tasks/deletion.py
+++ b/src/sentry/tasks/deletion.py
@@ -30,7 +30,7 @@ def delete_organization(object_id, transaction_id=None, continuous=True, **kwarg
     from sentry.models import (
         Organization, OrganizationMember, OrganizationStatus, Team, TeamStatus,
         Commit, CommitAuthor, CommitFileChange, Environment, Release, ReleaseCommit,
-        ReleaseEnvironment, ReleaseFile, ReleaseHeadCommit, Repository
+        ReleaseEnvironment, ReleaseFile, Distribution, ReleaseHeadCommit, Repository
     )
 
     try:
@@ -58,7 +58,7 @@ def delete_organization(object_id, transaction_id=None, continuous=True, **kwarg
     model_list = (
         OrganizationMember, CommitFileChange, Commit, CommitAuthor,
         Environment, Repository, Release, ReleaseCommit,
-        ReleaseEnvironment, ReleaseFile, ReleaseHeadCommit
+        ReleaseEnvironment, ReleaseFile, Distribution, ReleaseHeadCommit
     )
 
     has_more = delete_objects(
