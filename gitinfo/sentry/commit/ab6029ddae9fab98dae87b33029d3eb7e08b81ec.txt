commit ab6029ddae9fab98dae87b33029d3eb7e08b81ec
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Thu Sep 12 20:11:42 2019 +0300

    build(docker): Fix auto build issues (#14658)
    
    Fixes auto tests and enables per-SHA tagging

diff --git a/MANIFEST.in b/MANIFEST.in
index f2b6bfcf9f..dd96a0ff8a 100644
--- a/MANIFEST.in
+++ b/MANIFEST.in
@@ -2,4 +2,3 @@ include setup.py README.rst MANIFEST.in LICENSE AUTHORS
 recursive-include ./ requirements*.txt
 graft src/sentry
 global-exclude *~
-prune docker
diff --git a/docker/Dockerfile b/docker/Dockerfile
index 315de49819..281671ab3b 100644
--- a/docker/Dockerfile
+++ b/docker/Dockerfile
@@ -60,7 +60,8 @@ RUN cd /usr/src/sentry \
     && tar -xzf "node-v$NODE_VERSION-linux-x64.tar.gz" -C /usr/local --strip-components=1 \
     && rm -r "node-v$NODE_VERSION-linux-x64.tar.gz" SHASUMS256.txt.asc
 
-ENV SENTRY_BUILD=${SOURCE_COMMIT:-master}
+ARG SOURCE_COMMIT="unknown"
+ENV SENTRY_BUILD=$SOURCE_COMMIT
 COPY . /usr/src/sentry/
 RUN export YARN_CACHE_FOLDER="$(mktemp -d)" \
     && cd /usr/src/sentry \
diff --git a/docker/docker-compose.test.yml b/docker/docker-compose.test.yml
index bbc726e662..a632e5cb46 100644
--- a/docker/docker-compose.test.yml
+++ b/docker/docker-compose.test.yml
@@ -1,7 +1,9 @@
-sut:
-  environment:
-    - SENTRY_SKIP_BACKEND_VALIDATION=1
-    - SENTRY_SECRET_KEY=abc
-    - SENTRY_REDIS_HOST=localhost
-  build: .
-  command: config get system.secret-key
\ No newline at end of file
+version: '3.4'
+services:
+  sut:
+    image: getsentry/sentry:git
+    environment:
+      - SENTRY_SKIP_BACKEND_VALIDATION=1
+      - SENTRY_SECRET_KEY=abc
+      - SENTRY_REDIS_HOST=localhost
+    command: config get system.secret-key
diff --git a/docker/hooks/build b/docker/hooks/build
new file mode 100755
index 0000000000..f97168078e
--- /dev/null
+++ b/docker/hooks/build
@@ -0,0 +1,17 @@
+#!/bin/bash
+
+set -x;
+
+if [[ -z "$SOURCE_COMMIT" ]]; then
+	export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
+	echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
+fi
+
+echo "SOURCE_COMMIT: $SOURCE_COMMIT";
+echo $(pwd);
+cd $(git rev-parse --show-toplevel);
+
+git archive --format=tar.gz -o context.tar.gz $SOURCE_COMMIT
+docker build --build-arg SOURCE_COMMIT="$SOURCE_COMMIT" -t "$DOCKER_REPO:$SOURCE_COMMIT" -t "$DOCKER_REPO:git" -f "./docker/Dockerfile" - < context.tar.gz
+docker build -t "$DOCKER_REPO:$SOURCE_COMMIT-onbuild" -t "$DOCKER_REPO:git-onbuild" -f "./docker/onbuild/Dockerfile" - < context.tar.gz
+rm context.tar.gz
diff --git a/docker/test.dockerfile b/docker/test.dockerfile
new file mode 100644
index 0000000000..f4e4756522
--- /dev/null
+++ b/docker/test.dockerfile
@@ -0,0 +1,7 @@
+FROM debian:buster-slim
+
+RUN apt-get update && apt-get install -y --no-install-recommends \
+    curl \
+  && rm -rf /var/lib/apt/lists/*
+
+COPY onpremise/test.sh test.sh
