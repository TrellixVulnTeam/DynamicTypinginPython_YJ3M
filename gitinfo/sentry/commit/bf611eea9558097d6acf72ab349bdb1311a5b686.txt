commit bf611eea9558097d6acf72ab349bdb1311a5b686
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Thu Sep 28 10:55:21 2017 -0700

    feat(auth): Support raising IdentityNotValid in provider.build_identity
    
    Useful in cases where the user has misconfigured their Identity
    Provider and an Identity cannot be created.

diff --git a/src/sentry/auth/helper.py b/src/sentry/auth/helper.py
index 1df3996487..0c7e8cd6db 100644
--- a/src/sentry/auth/helper.py
+++ b/src/sentry/auth/helper.py
@@ -13,6 +13,7 @@ from django.utils import timezone
 from django.utils.translation import ugettext_lazy as _
 
 from sentry.app import locks
+from sentry.auth.exceptions import IdentityNotValid
 from sentry.models import (
     AuditLogEntry, AuditLogEntryEvent, AuthIdentity, AuthProvider, Organization, OrganizationMember,
     OrganizationMemberTeam, User, UserEmail
@@ -37,6 +38,8 @@ ERR_UID_MISMATCH = _('There was an error encountered during authentication.')
 
 ERR_NOT_AUTHED = _('You must be authenticated to link accounts.')
 
+ERR_INVALID_IDENTITY = _('The provider did not return a valid user identity.')
+
 
 class AuthHelper(object):
     """
@@ -170,7 +173,11 @@ class AuthHelper(object):
     def finish_pipeline(self):
         session = self.request.session['auth']
         state = session['state']
-        identity = self.provider.build_identity(state)
+
+        try:
+            identity = self.provider.build_identity(state)
+        except IdentityNotValid:
+            return self.error(ERR_INVALID_IDENTITY)
 
         if session['flow'] == self.FLOW_LOGIN:
             # create identity and authenticate the user
diff --git a/src/sentry/auth/provider.py b/src/sentry/auth/provider.py
index f44dd6d015..98e8a443d3 100644
--- a/src/sentry/auth/provider.py
+++ b/src/sentry/auth/provider.py
@@ -60,6 +60,9 @@ class Provider(object):
         >>> }
 
         The ``email`` and ``id`` keys are required, ``name`` is optional.
+
+        If the identity can not be constructed an ``IdentityNotValid`` error
+        should be raised.
         """
         raise NotImplementedError
 
