commit ae42ebae02a2b51c2118c4e5a37bbfd162649be1
Author: Mark Story <mark@sentry.io>
Date:   Fri Nov 1 15:16:22 2019 -0400

    fix(discover1) Accept all projects in discover1 saved queries as well (#15395)
    
    Previously 'all projects' could only be saved in a discover2 query.

diff --git a/src/sentry/discover/endpoints/serializers.py b/src/sentry/discover/endpoints/serializers.py
index e811d352c0..6ca98d0437 100644
--- a/src/sentry/discover/endpoints/serializers.py
+++ b/src/sentry/discover/endpoints/serializers.py
@@ -219,9 +219,9 @@ class DiscoverSavedQuerySerializer(serializers.Serializer):
                     "You must provide an equal number of field names and fields"
                 )
 
-            if data["projects"] == ALL_ACCESS_PROJECTS:
-                data["projects"] = []
-                query["all_projects"] = True
+        if data["projects"] == ALL_ACCESS_PROJECTS:
+            data["projects"] = []
+            query["all_projects"] = True
 
         return {"name": data["name"], "project_ids": data["projects"], "query": query}
 
diff --git a/src/sentry/static/sentry/app/views/discover/queryBuilder.tsx b/src/sentry/static/sentry/app/views/discover/queryBuilder.tsx
index 90e10f1e26..952f283ad4 100644
--- a/src/sentry/static/sentry/app/views/discover/queryBuilder.tsx
+++ b/src/sentry/static/sentry/app/views/discover/queryBuilder.tsx
@@ -349,7 +349,8 @@ export default function createQueryBuilder(
    */
   function reset(q: any) {
     const [validProjects, invalidProjects] = partition(q.projects || [], project =>
-      defaultProjectIds.includes(project)
+      // -1 means all projects
+      project === -1 ? true : defaultProjectIds.includes(project)
     );
 
     if (invalidProjects.length) {
diff --git a/tests/js/spec/views/discover/queryBuilder.spec.jsx b/tests/js/spec/views/discover/queryBuilder.spec.jsx
index dcb2a64105..421720d210 100644
--- a/tests/js/spec/views/discover/queryBuilder.spec.jsx
+++ b/tests/js/spec/views/discover/queryBuilder.spec.jsx
@@ -297,6 +297,14 @@ describe('Query Builder', function() {
       });
       expect(openModal).not.toHaveBeenCalled();
     });
+
+    it('does not display warning for -1 (all projects)', function() {
+      queryBuilder.reset({
+        fields: ['id'],
+        projects: [-1],
+      });
+      expect(openModal).not.toHaveBeenCalled();
+    });
   });
 
   describe('getColumns()', function() {
diff --git a/tests/snuba/api/endpoints/test_discover_saved_queries.py b/tests/snuba/api/endpoints/test_discover_saved_queries.py
index 7887bde719..38bad32a9f 100644
--- a/tests/snuba/api/endpoints/test_discover_saved_queries.py
+++ b/tests/snuba/api/endpoints/test_discover_saved_queries.py
@@ -82,6 +82,24 @@ class DiscoverSavedQueriesTest(DiscoverSavedQueryBase):
             )
         assert response.status_code == 403, response.content
 
+    def test_post_all_projects(self):
+        with self.feature(self.feature_name):
+            url = reverse("sentry-api-0-discover-saved-queries", args=[self.org.slug])
+            response = self.client.post(
+                url,
+                {
+                    "name": "All projects",
+                    "projects": [-1],
+                    "conditions": [],
+                    "fields": ["title", "count()"],
+                    "range": "24h",
+                    "orderby": "time",
+                },
+            )
+        assert response.status_code == 201, response.content
+        assert response.data["projects"] == [-1]
+        assert response.data["name"] == "All projects"
+
     def test_post_cannot_use_version_two_fields(self):
         with self.feature(self.feature_name):
             url = reverse("sentry-api-0-discover-saved-queries", args=[self.org.slug])
