commit 6ea5f00169953ebe321f18df51dfc9f8bfff8cb2
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jan 27 13:57:42 2015 -0800

    Query organization stats separate from project table data

diff --git a/src/sentry/templates/sentry/organization-stats.html b/src/sentry/templates/sentry/organization-stats.html
index 638e63076f..cd2a6531fb 100644
--- a/src/sentry/templates/sentry/organization-stats.html
+++ b/src/sentry/templates/sentry/organization-stats.html
@@ -25,19 +25,20 @@
   <div class="page-header">
     <h3>Events by Project</h3>
   </div>
-
-  <table class="table table-striped project-list">
-    <thead>
-      <tr>
-        <th>Project</th>
-        <th>Accepted</th>
-        <th>Rejected</th>
-        <th>Total</th>
-      </tr>
-    </thead>
-    <tbody>
-    </tbody>
-  </table>
+  <div id="project_data">
+    <table class="table table-striped project-list">
+      <thead>
+        <tr>
+          <th>Project</th>
+          <th>Accepted</th>
+          <th>Rejected</th>
+          <th>Total</th>
+        </tr>
+      </thead>
+      <tbody>
+      </tbody>
+    </table>
+  </div>
 {% endblock %}
 
 {% block content_after %}
@@ -56,13 +57,15 @@
   <script type="text/javascript">
   $(function(){
     var $sparkline = $('#chart');
-    var rawData = {received: null, rejected: null};
+    var $projectData = $('#project_data');
+    var rawProjectData = {received: null, rejected: null};
+    var rawOrgData = {received: null, rejected: null};
     var statsEndpoint = app.config.urlPrefix + '/api/0/organizations/' + app.config.organizationId + '/stats/';
     var stats = {received: [], rejected: []};
     var projectTotals = [];
     var orgTotal = {received: 0, rejected: 0, accepted: 0};
-    var pendingRequests = 3;
-    var projectMap = {};
+    var pendingRequests = 5;
+    var projectMap = null;
 
     $sparkline.height('250px');
 
@@ -71,17 +74,19 @@
       type: 'get',
       dataType: 'json',
       success: function(data) {
+        projectMap = {};
         $.each(data, function(_, project){
           projectMap[project.id] = project;
         });
         requestFinished();
       },
       error: function(data) {
-        $sparkline.html('<div class="error">There was an error loading statistics.</div>');
+        $projectData.html('<div class="error">There was an error loading project data.</div>');
+        requestFinished();
       }
     });
 
-    $.each(rawData, function(statName, _) {
+    $.each(rawProjectData, function(statName, _) {
       $.ajax({
         url: statsEndpoint,
         type: 'get',
@@ -93,7 +98,30 @@
           group: 'project'
         },
         success: function(data){
-          rawData[statName] = data;
+          rawProjectData[statName] = data;
+          requestFinished();
+        },
+        error: function(data) {
+          $projectData.html('<div class="error">There was an error loading project data.</div>');
+          requestFinished();
+        }
+      });
+    });
+
+    $.each(rawOrgData, function(statName, _) {
+      // query the organization stats via a separate call as its possible the project stats
+      // are too heavy
+      $.ajax({
+        url: statsEndpoint,
+        type: 'get',
+        dataType: 'json',
+        data: {
+          since: new Date().getTime() / 1000 - 3600 * 24 * 7,
+          resolution: '1h',
+          stat: statName
+        },
+        success: function(data){
+          rawOrgData[statName] = data;
           requestFinished();
         },
         error: function(data) {
@@ -103,33 +131,57 @@
     });
 
     function requestFinished() {
-      pendingRequests -= 1;
-      if (pendingRequests === 0) {
-        processData();
+      if (rawOrgData.received && rawOrgData.rejected) {
+        processOrgData();
         renderChart();
+      }
+
+      if (rawProjectData.received && rawProjectData.rejected && projectMap) {
+        processProjectData();
         renderTable();
       }
     }
 
-    function processData() {
+    function processOrgData() {
+      var oReceived = 0;
+      var oRejected = 0;
       var sReceived = {};
       var sRejected = {};
-      $.each(rawData.received, function(projectId, data){
+      $.each(rawOrgData.received, function(idx, point){
+        var dReceived = point[1];
+        var dRejected = rawOrgData.rejected[idx][1];
+        var ts = point[0] * 1000;
+        if (sReceived[ts] === undefined) {
+          sReceived[ts] = dReceived;
+          sRejected[ts] = dRejected;
+        } else {
+          sReceived[ts] += dReceived;
+          sRejected[ts] += dRejected;
+        }
+        oReceived += dReceived;
+        oRejected += dRejected;
+      });
+      orgTotal.received = oReceived;
+      orgTotal.rejected = oRejected;
+      orgTotal.accepted = oReceived - oRejected;
+
+      stats.rejected = $.map(sRejected, function(value, ts) { return [[ts, value || null]]; });
+      stats.accepted = $.map(sReceived, function(value, ts) {
+        // total number of events accepted (received - rejected)
+        return [[ts, value - sRejected[ts]]];
+      });
+    }
+
+    function processProjectData() {
+
+      var sReceived = {};
+      var sRejected = {};
+      $.each(rawProjectData.received, function(projectId, data){
         var pReceived = 0;
         var pRejected = 0;
         $.each(data, function(idx, point){
-          var dReceived = point[1];
-          var dRejected = rawData.rejected[projectId][idx][1];
-          var ts = point[0] * 1000;
-          if (sReceived[ts] === undefined) {
-            sReceived[ts] = dReceived;
-            sRejected[ts] = dRejected;
-          } else {
-            sReceived[ts] += dReceived;
-            sRejected[ts] += dRejected;
-          }
-          pReceived += dReceived;
-          pRejected += dRejected;
+          pReceived += point[1];
+          pRejected += rawProjectData.rejected[projectId][idx][1];
         });
         projectTotals.push({
           id: projectId,
@@ -137,16 +189,7 @@
           rejected: pRejected,
           accepted: pReceived - pRejected
         });
-        orgTotal.received += pReceived;
-        orgTotal.rejected += pRejected;
-        orgTotal.accepted += pReceived - pRejected;
-      });
-      stats.rejected = $.map(sRejected, function(value, ts) { return [[ts, value || null]]; });
-      stats.accepted = $.map(sReceived, function(value, ts) {
-        // total number of events accepted (received - rejected)
-        return [[ts, value - sRejected[ts]]];
       });
-
       projectTotals.sort(function(a, b) { return b.received - a.received });
     }
 
