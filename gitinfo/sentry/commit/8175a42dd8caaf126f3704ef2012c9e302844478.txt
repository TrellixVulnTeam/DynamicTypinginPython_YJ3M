commit 8175a42dd8caaf126f3704ef2012c9e302844478
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue Jun 20 15:54:48 2017 +0200

    Added test for proguard file associations with versioned dsym files

diff --git a/tests/sentry/api/endpoints/test_dsym_files.py b/tests/sentry/api/endpoints/test_dsym_files.py
index 5b8d06f407..40c2847f3a 100644
--- a/tests/sentry/api/endpoints/test_dsym_files.py
+++ b/tests/sentry/api/endpoints/test_dsym_files.py
@@ -1,7 +1,5 @@
 from __future__ import absolute_import
 
-import six
-import json
 import zipfile
 from six import BytesIO
 
@@ -9,6 +7,7 @@ from django.core.files.uploadedfile import SimpleUploadedFile
 from django.core.urlresolvers import reverse
 
 from sentry.testutils import APITestCase
+from sentry.models import VersionDSymFile
 
 
 # This is obviously a freely generated UUID and not the checksum UUID.
@@ -55,3 +54,58 @@ class DSymFilesUploadTest(APITestCase):
         assert response.data[0]['objectName'] == 'proguard-mapping'
         assert response.data[0]['cpuName'] == 'any'
         assert response.data[0]['symbolType'] == 'proguard'
+
+    def test_associate_proguard_dsym(self):
+        project = self.create_project(name='foo')
+
+        url = reverse('sentry-api-0-dsym-files', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
+
+        self.login_as(user=self.user)
+
+        out = BytesIO()
+        f = zipfile.ZipFile(out, 'w')
+        f.writestr('proguard/%s.txt' % PROGUARD_UUID, PROGUARD_SOURCE)
+        f.close()
+
+        response = self.client.post(url, {
+            'file': SimpleUploadedFile('symbols.zip', out.getvalue(),
+                                       content_type='application/zip'),
+        }, format='multipart')
+
+        assert response.status_code == 201, response.content
+        assert len(response.data) == 1
+        assert response.data[0]['headers'] == {
+            'Content-Type': 'text/x-proguard+plain'
+        }
+        assert response.data[0]['sha1'] == 'e6d3c5185dac63eddfdc1a5edfffa32d46103b44'
+        assert response.data[0]['uuid'] == PROGUARD_UUID
+        assert response.data[0]['objectName'] == 'proguard-mapping'
+        assert response.data[0]['cpuName'] == 'any'
+        assert response.data[0]['symbolType'] == 'proguard'
+
+        url = reverse('sentry-api-0-associate-dsym-files', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
+        })
+
+        response = self.client.post(url, {
+            'checksums': ['e6d3c5185dac63eddfdc1a5edfffa32d46103b44'],
+            'platform': 'android',
+            'name': 'MyApp',
+            'appId': 'com.example.myapp',
+            'version': '1.0',
+            'build': '1',
+        }, format='json')
+
+        assert response.status_code == 200, response.content
+        assert len(response.data) == 1
+        assert response.data['associatedDsymFiles'][0]['uuid'] == PROGUARD_UUID
+
+        vdf = VersionDSymFile.objects.get()
+        assert vdf.version == '1.0'
+        assert vdf.build == '1'
+        assert vdf.dsym_app.app_id == 'com.example.myapp'
+        assert vdf.dsym_file.uuid == PROGUARD_UUID
