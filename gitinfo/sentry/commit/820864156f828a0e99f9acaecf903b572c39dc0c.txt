commit 820864156f828a0e99f9acaecf903b572c39dc0c
Author: Jess MacQueen <jess@getsentry.com>
Date:   Wed Sep 13 17:35:50 2017 -0700

    fix(store): Handle release being deleted prior to group creation
    
    fixes SENTRY-40C

diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index dc26fc4138..f4ec7b0a02 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -844,11 +844,22 @@ class EventManager(object):
         # should be better tested/reviewed
         if existing_group_id is None:
             kwargs['score'] = ScoreClause.calculate(1, kwargs['last_seen'])
+            # it's possible the release was deleted between
+            # when we queried for the release and now, so
+            # make sure it still exists
+            first_release = kwargs.pop('first_release', None)
+
             with transaction.atomic():
                 short_id = project.next_short_id()
                 group, group_is_new = Group.objects.create(
-                    project=project, short_id=short_id, **kwargs
+                    project=project,
+                    short_id=short_id,
+                    first_release_id=Release.objects.filter(
+                        id=first_release.id,
+                    ).values_list('id', flat=True).first() if first_release else None,
+                    **kwargs
                 ), True
+
         else:
             group = Group.objects.get(id=existing_group_id)
 
