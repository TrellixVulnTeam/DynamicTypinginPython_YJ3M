commit 353e7f725ab4f033e7669592485cb961586f7929
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Fri Sep 7 12:28:40 2018 -0700

    feat(discover): Implement download as CSV (#9659)

diff --git a/package.json b/package.json
index 2e3e92208f..79479e8920 100644
--- a/package.json
+++ b/package.json
@@ -55,6 +55,7 @@
     "moment": "2.22.0",
     "moment-timezone": "0.5.4",
     "node-libs-browser": "0.5.3",
+    "papaparse": "^4.6.0",
     "platformicons": "2.0.3",
     "po-catalog-loader": "2.0.0",
     "prop-types": "^15.6.0",
diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/result/index.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/result/index.jsx
index 54f6ed873c..f64e832e4d 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/result/index.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/result/index.jsx
@@ -5,16 +5,16 @@ import styled from 'react-emotion';
 import {Box, Flex} from 'grid-emotion';
 
 import {t} from 'app/locale';
+import Link from 'app/components/link';
 import BarChart from 'app/components/charts/barChart';
 import LineChart from 'app/components/charts/lineChart';
 import Panel from 'app/components/panels/panel';
 import space from 'app/styles/space';
 import Tooltip from 'app/components/charts/components/tooltip';
 
+import {getChartData, getChartDataByDay, formatTooltip, downloadAsCsv} from './utils';
 import Table from './table';
-import {getChartData, getChartDataByDay, formatTooltip} from './utils';
 import {Heading} from '../styles';
-
 import {NUMBER_OF_SERIES_BY_DAY} from '../data';
 
 export default class Result extends React.Component {
@@ -50,36 +50,47 @@ export default class Result extends React.Component {
   }
 
   renderToggle() {
+    const {data, query, chartData} = this.props;
+
     const options = [{id: 'table', name: t('Table')}];
 
-    if (this.props.query.aggregations.length) {
+    if (query.aggregations.length) {
       options.push({id: 'line', name: t('Line')}, {id: 'bar', name: t('Bar')});
     }
 
-    if (this.props.chartData) {
+    if (chartData) {
       options.push(
         {id: 'line-by-day', name: t('Line by Day')},
         {id: 'bar-by-day', name: t('Bar by Day')}
       );
     }
 
+    const linkClasses = 'btn btn-default btn-sm';
+
     return (
-      <div className="btn-group">
-        {options.map(opt => {
-          const active = opt.id === this.state.view;
-          return (
-            <a
-              key={opt.id}
-              className={classNames('btn btn-default btn-sm', {active})}
-              onClick={() => {
-                this.setState({view: opt.id});
-              }}
-            >
-              {opt.name}
-            </a>
-          );
-        })}
-      </div>
+      <Flex justify="flex-end">
+        <div className="btn-group">
+          {options.map(opt => {
+            const active = opt.id === this.state.view;
+            return (
+              <a
+                key={opt.id}
+                className={classNames('btn btn-default btn-sm', {active})}
+                onClick={() => {
+                  this.setState({view: opt.id});
+                }}
+              >
+                {opt.name}
+              </a>
+            );
+          })}
+        </div>
+        <Box ml={1}>
+          <Link className={linkClasses} onClick={() => downloadAsCsv(data)}>
+            {t('Export CSV')}
+          </Link>
+        </Box>
+      </Flex>
     );
   }
 
@@ -113,7 +124,7 @@ export default class Result extends React.Component {
           <Box flex="1">
             <Heading>{t('Result')}</Heading>
           </Box>
-          <Box justifySelf="flex-end">{this.renderToggle()}</Box>
+          {this.renderToggle()}
         </Flex>
 
         {view === 'table' && <Table data={data} query={query} />}
diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/result/utils.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/result/utils.jsx
index da6d0852d6..2138c8c96b 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/result/utils.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/result/utils.jsx
@@ -4,6 +4,7 @@ import React from 'react';
 import styled from 'react-emotion';
 import moment from 'moment';
 import {orderBy} from 'lodash';
+import Papa from 'papaparse';
 
 import {NUMBER_OF_SERIES_BY_DAY} from '../data';
 
@@ -231,3 +232,37 @@ const LightGray = styled.span`
 const DarkGray = styled.span`
   color: ${p => p.theme.gray5};
 `;
+
+/**
+ * Downloads a Snuba result object as CSV format
+ *
+ * @param {Object} result Result received from Snuba
+ * @param {Object} result.data Result data object from Snuba
+ * @param {String} result.meta Result metadata from Snuba
+ * @returns {Void}
+ */
+export function downloadAsCsv(result) {
+  const {meta, data} = result;
+  const headings = meta.map(({name}) => name);
+
+  const csvContent = Papa.unparse({
+    fields: headings,
+    data: data.map(row => {
+      return headings.map(col => disableMacros(row[col]));
+    }),
+  });
+
+  const encodedDataUrl = encodeURI(`data:text/csv;charset=utf8,${csvContent}`);
+
+  window.location.assign(encodedDataUrl);
+}
+
+function disableMacros(value) {
+  const unsafeCharacterRegex = /^[\=\+\-\@]/;
+
+  if (typeof value === 'string' && `${value}`.match(unsafeCharacterRegex)) {
+    return `'${value}`;
+  }
+
+  return value;
+}
diff --git a/tests/js/spec/views/organizationDiscover/result/utils.spec.jsx b/tests/js/spec/views/organizationDiscover/result/utils.spec.jsx
index 075d4ef1f3..5e2ec0b638 100644
--- a/tests/js/spec/views/organizationDiscover/result/utils.spec.jsx
+++ b/tests/js/spec/views/organizationDiscover/result/utils.spec.jsx
@@ -5,6 +5,7 @@ import {
   getChartDataByDay,
   getDisplayValue,
   getDisplayText,
+  downloadAsCsv,
 } from 'app/views/organizationDiscover/result/utils';
 
 describe('Utils', function() {
@@ -183,4 +184,51 @@ describe('Utils', function() {
       expect(getDisplayText(input)).toBe(expectedText);
     });
   });
+
+  describe('downloadAsCsv()', function() {
+    let locationSpy;
+    beforeEach(function() {
+      locationSpy = jest.spyOn(window.location, 'assign').mockImplementation(_ => _);
+    });
+    afterEach(function() {
+      jest.restoreAllMocks();
+    });
+    it('handles raw data', function() {
+      const result = {
+        meta: [{name: 'message'}, {name: 'environment'}],
+        data: [
+          {message: 'test 1', environment: 'prod'},
+          {message: 'test 2', environment: 'test'},
+        ],
+      };
+      downloadAsCsv(result);
+      expect(locationSpy).toHaveBeenCalledWith(
+        expect.stringContaining(
+          encodeURI('message,environment\r\ntest 1,prod\r\ntest 2,test')
+        )
+      );
+    });
+    it('handles aggregations', function() {
+      const result = {
+        meta: [{type: 'UInt64', name: 'count'}],
+        data: [{count: 3}],
+      };
+      downloadAsCsv(result);
+      expect(locationSpy).toHaveBeenCalledWith(
+        expect.stringContaining(encodeURI('count\r\n3'))
+      );
+    });
+    it('quotes unsafe strings', function() {
+      const result = {
+        meta: [{name: 'message'}],
+        data: [{message: '=HYPERLINK(http://some-bad-website)'}],
+      };
+      downloadAsCsv(result);
+      expect(locationSpy).toHaveBeenCalledWith(
+        expect.stringContaining(
+          encodeURI("message\r\n'=HYPERLINK(http://some-bad-website)")
+        )
+      );
+    });
+  });
 });
diff --git a/yarn.lock b/yarn.lock
index f4957555b2..365af63fa1 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -7257,6 +7257,10 @@ pako@~1.0.5:
   version "1.0.6"
   resolved "https://registry.yarnpkg.com/pako/-/pako-1.0.6.tgz#0101211baa70c4bca4a0f63f2206e97b7dfaf258"
 
+papaparse@^4.6.0:
+  version "4.6.0"
+  resolved "https://registry.yarnpkg.com/papaparse/-/papaparse-4.6.0.tgz#4e3b8d6bf9f7900da437912794ec292207526867"
+
 parse-asn1@^5.0.0:
   version "5.1.0"
   resolved "https://registry.yarnpkg.com/parse-asn1/-/parse-asn1-5.1.0.tgz#37c4f9b7ed3ab65c74817b5f2480937fbf97c712"
@@ -8217,9 +8221,9 @@ react-document-title@2.0.3:
     prop-types "^15.5.6"
     react-side-effect "^1.0.2"
 
-react-dom@16.3.2:
-  version "16.3.2"
-  resolved "https://registry.yarnpkg.com/react-dom/-/react-dom-16.3.2.tgz#cb90f107e09536d683d84ed5d4888e9640e0e4df"
+react-dom@16.3.3:
+  version "16.3.3"
+  resolved "https://registry.yarnpkg.com/react-dom/-/react-dom-16.3.3.tgz#af4c2aef9f6a66251a46da50253c860a67ae66d9"
   dependencies:
     fbjs "^0.8.16"
     loose-envify "^1.1.0"
