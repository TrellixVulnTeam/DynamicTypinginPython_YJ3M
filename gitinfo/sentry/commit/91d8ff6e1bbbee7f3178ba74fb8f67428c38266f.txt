commit 91d8ff6e1bbbee7f3178ba74fb8f67428c38266f
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Wed Jul 19 11:39:20 2017 -0700

    handle case where token is none in release webhook fixes SENTRY-2X0 (#5735)
    
    * handle case where token is none in release webhook fixes SENTRY-2X0
    
    * also add a test for no token
    
    * improve logging for release hook

diff --git a/src/sentry/web/frontend/release_webhook.py b/src/sentry/web/frontend/release_webhook.py
index 4c2092152f..d90b5f8656 100644
--- a/src/sentry/web/frontend/release_webhook.py
+++ b/src/sentry/web/frontend/release_webhook.py
@@ -77,13 +77,19 @@ class ReleaseWebhookView(View):
     def post(self, request, plugin_id, project_id, signature):
         project = Project.objects.get_from_cache(id=project_id)
 
-        token = ProjectOption.objects.get_value(project, 'sentry:release-token')
-
         logger.info('Incoming webhook for project_id=%s, plugin_id=%s',
                     project_id, plugin_id)
 
+        token = ProjectOption.objects.get_value(project, 'sentry:release-token')
+
+        if token is None:
+            logger.warn('No token for release hook project_id=%s, plugin_id=%s',
+                        project_id, plugin_id)
+            return HttpResponse(status=403)
+
         if not self.verify(plugin_id, project_id, token, signature):
-            logger.warn('Unable to verify signature for release hook')
+            logger.warn('Unable to verify signature for release hook project_id=%s, plugin_id=%s',
+                        project_id, plugin_id)
             return HttpResponse(status=403)
 
         if plugin_id == 'builtin':
diff --git a/tests/sentry/api/endpoints/test_project_release_token.py b/tests/sentry/api/endpoints/test_project_release_token.py
index 6e90f75215..bf7405afdb 100644
--- a/tests/sentry/api/endpoints/test_project_release_token.py
+++ b/tests/sentry/api/endpoints/test_project_release_token.py
@@ -45,6 +45,7 @@ class ReleaseTokenGetTest(APITestCase):
 
         assert response.status_code == 200, response.content
         assert response.data['token'] is not None
+        assert ProjectOption.objects.get_value(project, 'sentry:release-token') is not None
 
     def test_regenerates_token(self):
         project = self.create_project(
diff --git a/tests/sentry/web/frontend/test_release_webhook.py b/tests/sentry/web/frontend/test_release_webhook.py
index 10340ec495..a7d3d8c8d2 100644
--- a/tests/sentry/web/frontend/test_release_webhook.py
+++ b/tests/sentry/web/frontend/test_release_webhook.py
@@ -35,6 +35,16 @@ class ReleaseWebhookTest(TestCase):
             'signature': self.signature,
         })
 
+    def test_no_token(self):
+        project = self.create_project(team=self.team)
+        path = reverse('sentry-release-hook', kwargs={
+            'project_id': project.id,
+            'plugin_id': 'dummy',
+            'signature': self.signature,
+        })
+        resp = self.client.post(path)
+        assert resp.status_code == 403
+
     def test_invalid_signature(self):
         path = reverse('sentry-release-hook', kwargs={
             'project_id': self.project.id,
