commit abac84bb7c448d26fb14841354d3996e60fb586a
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Jan 3 17:47:33 2011 -0800

    Store installed apps versions with each message

diff --git a/sentry/client/base.py b/sentry/client/base.py
index 30f8f16aa1..66f469be68 100644
--- a/sentry/client/base.py
+++ b/sentry/client/base.py
@@ -13,7 +13,8 @@ from django.template import TemplateSyntaxError
 from django.views.debug import ExceptionReporter
 
 from sentry import conf
-from sentry.helpers import construct_checksum, varmap, transform, get_installed_apps, urlread, force_unicode
+from sentry.helpers import construct_checksum, varmap, transform, get_installed_apps, urlread, force_unicode, \
+                           get_versions
 
 logger = logging.getLogger('sentry.errors')
 
@@ -24,6 +25,13 @@ class SentryClient(object):
         kwargs.setdefault('level', logging.ERROR)
         kwargs.setdefault('server_name', conf.NAME)
 
+        # save versions of all installed apps
+        if 'data' not in kwargs or '__sentry__' not in (kwargs['data'] or {}):
+            if kwargs.get('data') is None:
+                kwargs['data'] = {}
+            kwargs['data']['__sentry__'] = {}
+        kwargs['data']['__sentry__']['versions'] = get_versions()
+
         if 'checksum' not in kwargs:
             checksum = construct_checksum(**kwargs)
         else:
diff --git a/sentry/helpers.py b/sentry/helpers.py
index acd764c785..fcc4ffce04 100644
--- a/sentry/helpers.py
+++ b/sentry/helpers.py
@@ -1,4 +1,5 @@
 import logging
+import sys
 import urllib
 import urllib2
 import uuid
@@ -174,3 +175,28 @@ def urlread(url, get={}, post={}, headers={}, timeout=None):
     except:
         response = urllib2.urlopen(req, urllib.urlencode(post)).read()
     return response
+
+def get_versions(module_list=None):
+    if not module_list:
+        module_list = settings.INSTALLED_APPS + ['django']
+    versions = {}
+    for app in module_list:
+        name = app.split('.')[-1].replace('_', ' ').capitalize()
+        __import__(app)
+        app = sys.modules[app]
+        if hasattr(app, 'get_version'):
+            get_version = app.get_version
+            if callable(get_version):
+                version = get_version()
+            else:
+                version = get_version
+        elif hasattr(app, 'VERSION'):
+            version = app.VERSION
+        elif hasattr(app, '__version__'):
+            version = app.__version__
+        else:
+            continue
+        if isinstance(version, (list, tuple)):
+            version = '.'.join(str(o) for o in version)
+        versions[name] = version
+    return versions
\ No newline at end of file
diff --git a/sentry/tests/tests.py b/sentry/tests/tests.py
index 9495af9b27..1f3b4bcd49 100644
--- a/sentry/tests/tests.py
+++ b/sentry/tests/tests.py
@@ -608,6 +608,19 @@ class SentryTestCase(TestCase):
         self.assertEquals(last.message, 'Test')
         self.assertEquals(last.data['uuid'], repr(uuid))
 
+    def testVersions(self):
+        import sentry
+        logger = logging.getLogger()
+        
+        self.setUpHandler()
+        
+        logger.error('Test')
+
+        self.assertEquals(Message.objects.count(), 1)
+        self.assertEquals(GroupedMessage.objects.count(), 1)
+        last = Message.objects.get()
+        self.assertEquals(last.data['__sentry__']['versions']['Sentry'], sentry.VERSION)
+
 class SentryViewsTest(TestCase):
     urls = 'sentry.tests.urls'
     fixtures = ['sentry/tests/fixtures/views.json']
@@ -913,6 +926,12 @@ class SentryHelpersTest(TestCase):
                     transform(fake_gettext_lazy("something")))),
             u'Igpay Atinlay')
 
+    def test_get_versions(self):
+        import sentry
+        from sentry.helpers import get_versions
+        versions = get_versions(['sentry'])
+        self.assertEquals(versions['Sentry'], sentry.VERSION)
+
 class SentryClientTest(TestCase):
     urls = 'sentry.tests.urls'
 
