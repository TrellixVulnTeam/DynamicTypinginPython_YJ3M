commit 2d359c1f73f83a1e907ee404114b62d7a7bd75d9
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Mon Jan 28 10:59:38 2019 +0100

    fix: Filter out more null-tags in save(), fix ordering bug (#11737)

diff --git a/src/sentry/api/serializers/models/event.py b/src/sentry/api/serializers/models/event.py
index 8fc8adcdef..b657e1907f 100644
--- a/src/sentry/api/serializers/models/event.py
+++ b/src/sentry/api/serializers/models/event.py
@@ -89,11 +89,14 @@ class EventSerializer(Serializer):
         meta = get_path(event.data, '_meta', 'tags') or {}
 
         tags = sorted(
-            [{
-                'key': k.split('sentry:', 1)[-1],
-                'value': v,
-                '_meta': meta.get(k) or get_path(meta, six.text_type(i), '1') or None,
-            } for i, (k, v) in enumerate(event.get_tags(sorted=False) or ())],
+            [
+                {
+                    'key': kv[0].split('sentry:', 1)[-1],
+                    'value': kv[1],
+                    '_meta': meta.get(kv[0]) or get_path(meta, six.text_type(i), '1') or None,
+                }
+                for i, kv in enumerate(event.data.get('tags') or ())
+                if kv is not None and kv[0] is not None and kv[1] is not None],
             key=lambda x: x['key']
         )
 
diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index 2c9483d1a2..94a595d9bb 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -1200,7 +1200,7 @@ class EventManager(object):
             Group.objects.add_tags,
             group,
             environment,
-            data['tags'],
+            event.get_tags(),
             _with_transaction=False)
 
         if not raw:
diff --git a/src/sentry/models/event.py b/src/sentry/models/event.py
index 5344394bc7..4344c98b60 100644
--- a/src/sentry/models/event.py
+++ b/src/sentry/models/event.py
@@ -204,12 +204,11 @@ class Event(Model):
     def interfaces(self):
         return self.get_interfaces()
 
-    def get_tags(self, sorted=True):
+    def get_tags(self):
         try:
             rv = [(t, v) for t, v in get_path(
-                self.data, 'tags', filter=True) or () if v is not None]
-            if sorted:
-                rv.sort()
+                self.data, 'tags', filter=True) or () if t is not None and v is not None]
+            rv.sort()
             return rv
         except ValueError:
             # at one point Sentry allowed invalid tag sets such as (foo, bar)
