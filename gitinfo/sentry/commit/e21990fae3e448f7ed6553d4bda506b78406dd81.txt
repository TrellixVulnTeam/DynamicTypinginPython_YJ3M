commit e21990fae3e448f7ed6553d4bda506b78406dd81
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Mon Nov 26 21:24:32 2018 +0100

    feat(attachments): Only delete attachments if the org has them enabled on processing (#9393)

diff --git a/src/sentry/tasks/store.py b/src/sentry/tasks/store.py
index 9cc0343e10..e41e75e89b 100644
--- a/src/sentry/tasks/store.py
+++ b/src/sentry/tasks/store.py
@@ -381,6 +381,7 @@ def save_event(cache_key=None, data=None, start_time=None, event_id=None,
     with configure_scope() as scope:
         scope.set_tag("project", project_id)
 
+    event = None
     try:
         manager = EventManager(data)
         event = manager.save(project_id, assume_normalized=True)
@@ -430,7 +431,12 @@ def save_event(cache_key=None, data=None, start_time=None, event_id=None,
     finally:
         if cache_key:
             default_cache.delete(cache_key)
-            attachment_cache.delete(cache_key)
+
+            # For the unlikely case that we did not manage to persist the
+            # event we also delete the key always.
+            if event is None or \
+               features.has('organizations:event-attachments', event.project.organization, actor=None):
+                attachment_cache.delete(cache_key)
 
         if start_time:
             metrics.timing(
