commit 89742db7537ddcad9d4bcc41216dd85de3073f8c
Author: Eric Feng <ehfeng@users.noreply.github.com>
Date:   Tue Aug 15 11:53:35 2017 -0700

    add plugin slug to urls (#5881)
    
    * add plugin slug to urls
    
    * matt comments
    
    * adding test
    
    * adding more cases
    
    * adding case where slug is blank

diff --git a/src/sentry/plugins/bases/notify.py b/src/sentry/plugins/bases/notify.py
index 1639101f4d..2c1a34ab92 100644
--- a/src/sentry/plugins/bases/notify.py
+++ b/src/sentry/plugins/bases/notify.py
@@ -8,6 +8,12 @@ sentry.plugins.bases.notify
 from __future__ import absolute_import, print_function
 
 import logging
+from six.moves.urllib.parse import (
+    urlparse,
+    urlencode,
+    urlunparse,
+    parse_qs,
+)
 
 from django import forms
 
@@ -44,6 +50,7 @@ class BaseNotificationUserOptionsForm(forms.Form):
 
 
 class NotificationPlugin(Plugin):
+    slug = ''
     description = (
         'Notify project members when a new event is seen for the first time, or when an '
         'already resolved event has changed back to unresolved.'
@@ -162,6 +169,18 @@ class NotificationPlugin(Plugin):
     def get_notification_doc_html(self, **kwargs):
         return ""
 
+    def add_notification_referrer_param(self, url):
+        if self.slug:
+            parsed_url = urlparse(url)
+            query = parse_qs(parsed_url.query)
+            query['referrer'] = self.slug
+
+            url_list = list(parsed_url)
+            url_list[4] = urlencode(query, doseq=True)
+            return urlunparse(url_list)
+
+        return url
+
 
 # Backwards-compatibility
 NotifyConfigurationForm = NotificationConfigurationForm
diff --git a/tests/sentry/plugins/bases/notify/__init__.py b/tests/sentry/plugins/bases/notify/__init__.py
new file mode 100644
index 0000000000..c3961685ab
--- /dev/null
+++ b/tests/sentry/plugins/bases/notify/__init__.py
@@ -0,0 +1 @@
+from __future__ import absolute_import
diff --git a/tests/sentry/plugins/bases/notify/tests.py b/tests/sentry/plugins/bases/notify/tests.py
new file mode 100644
index 0000000000..6a52775a72
--- /dev/null
+++ b/tests/sentry/plugins/bases/notify/tests.py
@@ -0,0 +1,24 @@
+from __future__ import absolute_import
+
+from sentry.plugins import NotificationPlugin
+from sentry.testutils import TestCase
+
+
+class NotifyPlugin(TestCase):
+    def test_add_notification_referrer_param(self):
+        n = NotificationPlugin()
+        n.slug = 'slack'
+        url = 'https://sentry.io/'
+        assert n.add_notification_referrer_param(url) == url + '?referrer=' + n.slug
+
+        url = 'https://sentry.io/?referrer=notslack'
+        assert n.add_notification_referrer_param(url) == 'https://sentry.io/?referrer=slack'
+
+        url = 'https://sentry.io/?utm_source=google'
+        assert n.add_notification_referrer_param(
+            url
+        ) == 'https://sentry.io/?referrer=slack&utm_source=google'
+
+        n.slug = ''
+        url = 'https://sentry.io/'
+        assert n.add_notification_referrer_param(url) == 'https://sentry.io/'
