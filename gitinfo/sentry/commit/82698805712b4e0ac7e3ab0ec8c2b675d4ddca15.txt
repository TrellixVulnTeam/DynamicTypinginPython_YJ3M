commit 82698805712b4e0ac7e3ab0ec8c2b675d4ddca15
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Apr 5 01:44:05 2012 -0700

    Clean up create project flow so its based on the team and not global

diff --git a/sentry/permissions.py b/sentry/permissions.py
index 92c961fcb8..0e44c119f1 100644
--- a/sentry/permissions.py
+++ b/sentry/permissions.py
@@ -9,7 +9,7 @@ from sentry.conf import settings
 from sentry.plugins import plugins
 
 
-def can_create_projects(user):
+def can_create_projects(user, team=None):
     """
     Returns a boolean describing whether a user has the ability to
     create new projects.
@@ -20,7 +20,7 @@ def can_create_projects(user):
     if user.has_perm('sentry.can_add_project'):
         return True
 
-    result = plugins.first('has_perm', user, 'add_project')
+    result = plugins.first('has_perm', user, 'add_project', team)
     if result is None:
         result = settings.ALLOW_PROJECT_CREATION
 
diff --git a/sentry/templates/sentry/admin/users/list.html b/sentry/templates/sentry/admin/users/list.html
index c3fa77078d..f9831743f5 100644
--- a/sentry/templates/sentry/admin/users/list.html
+++ b/sentry/templates/sentry/admin/users/list.html
@@ -36,14 +36,12 @@
                 <col>
                 <col style="width:150px;">
                 <col style="width:150px;">
-                <col style="width:50px;">
             </colgroup>
             <thead>
                 <tr>
                     <th><a href="?{{ sort_querystring }}&amp;sort=name">{% trans "Name" %}</a></th>
                     <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=joined">{% trans "Joined" %}</a></th>
                     <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=login">{% trans "Last Login" %}</a></th>
-                    <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=projects">{% trans "Projects" %}</a></th>
                 </tr>
             </thead>
             <tbody>
@@ -71,9 +69,6 @@
                         <td style="text-align:center; vertical-align:middle;">
                             {{ user.last_login|date }}
                         </td>
-                        <td style="text-align:center; vertical-align:middle;">
-                            <a href="{% url sentry-admin-list-user-projects user.pk %}">{{ user.num_projects }}</a>
-                        </td>
                     </tr>
                 {% endfor %}
             </tbody>
diff --git a/sentry/templates/sentry/header.html b/sentry/templates/sentry/header.html
index a9ffa70999..4df873ca68 100644
--- a/sentry/templates/sentry/header.html
+++ b/sentry/templates/sentry/header.html
@@ -28,31 +28,26 @@
                 <ul class="nav pull-right">
                     {% block account_nav %}
                         {% if request.user.is_authenticated %}
-                            <li class="dropdown">
-                                <a href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Projects" %} <span class="caret"></span></a>
-                                <ul class="dropdown-menu">
-                                    <li><a href="{% url sentry-project-list %}">{% trans "Manage" %}</a></li>
-                                    {% if PROJECT_LIST %}
-                                        <li class="divider"></li>
+                            {% if PROJECT_LIST %}
+                                <li class="dropdown">
+                                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Dashboard" %} <span class="caret"></span></a>
+                                    <ul class="dropdown-menu">
                                         {% for p in PROJECT_LIST %}
                                             <li{% if project == p %} class="active"{% endif %}><a href="{% url sentry p.pk %}">{{ p.name }}</a></li>
                                         {% endfor %}
-                                    {% endif %}
-                                    {% if can_create_projects %}
-                                        <li class="divider"></li>
-                                        <li><a href="{% url sentry-new-project %}">{% trans "Create a new project" %}</a></li>
-                                    {% endif %}
-                                </ul>
-                            </li>
+                                    </ul>
+                                </li>
+                            {% endif %}
                             <li class="dropdown">
                                 <a href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Account" %} <span class="caret"></span></a>
                                 <ul class="dropdown-menu">
-                                    <li><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
+                                    <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a></li>
                                     <li><a href="{% url sentry-team-list %}">{% trans "Teams" %}</a></li>
                                     {% if request.user.is_staff %}
                                         <li><a href="{% url sentry-admin-status %}">{% trans "Admin" %}</a></li>
                                     {% endif %}
                                     <li class="divider"></li>
+                                    <li><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
                                     <li><a href="{% url sentry-logout %}">{% trans "Logout" %}</a></li>
                                 </ul>
                             </li>
diff --git a/sentry/templates/sentry/projects/manage.html b/sentry/templates/sentry/projects/manage.html
index 0497e3093c..b7396ed984 100644
--- a/sentry/templates/sentry/projects/manage.html
+++ b/sentry/templates/sentry/projects/manage.html
@@ -62,39 +62,31 @@
                 {% endif %}
                 <h2>{% trans "Members" %}</h2>
             </div>
-            <ul class="nav nav-tabs">
-                <li class="active"><a href="#members" data-toggle="tab">Members</a></li>
-                <li><a href="#pending-members" data-toggle="tab">Pending ({{ pending_member_list|length }})</a></li>
-            </ul>
-            <div class="tab-content">
-                <div class="tab-pane active" id="members">
-                    <table class="table table-bordered table-striped">
-                        <colgroup>
-                            <col/>
-                            <col width="100px"/>
-                        </colgroup>
-                        <thead>
-                            <tr>
-                                <th>{% trans "User" %}</th>
-                                <th style="text-align:center">{% trans "Access" %}</th>
-                            </tr>
-                        </thead>
-                        <tbody>
-                            {% for member, user in member_list %}
-                                <tr>
-                                    <td>
-                                        <a href="{# {% url sentry-view-project-member project.pk member.pk %} #}">{{ user.username }}</a><br>
-                                        {{ user.email }}
-                                    </td>
-                                    <td style="text-align:center;">
-                                        {{ member.get_type_display }}
-                                    </td>
-                                </tr>
-                            {% endfor %}
-                        </tbody>
-                    </table>
-                </div>
-            </div>
+            <table class="table table-bordered table-striped">
+                <colgroup>
+                    <col/>
+                    <col width="100px"/>
+                </colgroup>
+                <thead>
+                    <tr>
+                        <th>{% trans "User" %}</th>
+                        <th style="text-align:center">{% trans "Access" %}</th>
+                    </tr>
+                </thead>
+                <tbody>
+                    {% for member, user in member_list %}
+                        <tr>
+                            <td>
+                                <a href="{# {% url sentry-view-project-member project.pk member.pk %} #}">{{ user.username }}</a><br>
+                                {{ user.email }}
+                            </td>
+                            <td style="text-align:center;">
+                                {{ member.get_type_display }}
+                            </td>
+                        </tr>
+                    {% endfor %}
+                </tbody>
+            </table>
         {% endblock %}
     </section>
 {% endblock %}
diff --git a/sentry/templates/sentry/projects/new.html b/sentry/templates/sentry/projects/new.html
index d06a9cfdb2..4e4999fded 100644
--- a/sentry/templates/sentry/projects/new.html
+++ b/sentry/templates/sentry/projects/new.html
@@ -1,4 +1,4 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/projects/base.html" %}
 
 {% load i18n %}
 
@@ -12,19 +12,20 @@
 
 {% block main %}
     <section class="body">
-        <p>{% trans "Use this page to create a new project within Sentry. Once done, you'll be able to add members (whether they're system or actual users), as well as configure your client to send messages to this project." %}</p>
-        <hr>
-        <form class="form-stacked" action="" method="post">
-            {% csrf_token %}
-            <fieldset>
-                <legend>{% trans "Project Details" %}</legend>
-                {% for field in form %}
-                    {% include "sentry/partial/_form_field.html" %}
+        {% if TEAM_LIST %}
+            <p>{% trans "Select a team you are a member of to create a project." %}</p>
+            <ul>
+                {% for team in TEAM_LIST %}
+                    <li><a href="{% url sentry-new-team-project team.slug %}">{{ team.name }}</a></li>
                 {% endfor %}
-            </fieldset>
-            <div class="actions">
-                <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
-            </div>
-        </form>
+            </ul>
+        {% else %}
+            {% if can_create_teams %}
+                {% url sentry-new-team as create_team_link %}
+                <p>{% blocktrans %}You must first <a href="{{ create_team_link }}">create a team</a> to create a project.{% endblocktrans %}</p>
+            {% else %}
+                <p>{% trans "You are not able to create a new project because you are not a member of any teams. Ask an administrator to add you to a team." %}</p>
+            {% endif %}
+        {% endif %}
     </section>
 {% endblock %}
diff --git a/sentry/templates/sentry/teams/manage.html b/sentry/templates/sentry/teams/manage.html
index e2562518c7..07bc32c8d7 100644
--- a/sentry/templates/sentry/teams/manage.html
+++ b/sentry/templates/sentry/teams/manage.html
@@ -38,6 +38,40 @@
                     {% endif %}
                 </fieldset>
             </form>
+            <div class="page-header">
+                {% if can_add_member %}
+                    <a href="{% url sentry-new-team-project team.slug %}" class="btn pull-right btn-primary">{% trans "New Project" %}</a>
+                {% endif %}
+                <h2>{% trans "Projects" %}</h2>
+            </div>
+            {% if project_list %}
+                <table class="table table-bordered table-striped">
+                    <colgroup>
+                        <col/>
+                        <col width="90px"/>
+                    </colgroup>
+                    <thead>
+                        <tr>
+                            <th>{% trans "Project" %}</th>
+                            <th style="text-align:center">{% trans "Actions" %}</th>
+                        </tr>
+                    </thead>
+                    <tbody>
+                        {% for project in project_list %}
+                            <tr>
+                                <td>
+                                    <a href="{% url sentry project.pk %}">{{ project.name }}</a><br>
+                                </td>
+                                <td style="text-align:center;">
+                                    <a href="{% url sentry-manage-project project.pk %}" class="btn btn-small">{% trans "Edit" %}</a>
+                                </td>
+                            </tr>
+                        {% endfor %}
+                    </tbody>
+                </table>
+            {% else %}
+                <p>{% trans "There are no projects managed by this team." %}</p>
+            {% endif %}
             <div class="page-header">
                 {% if can_add_member %}
                     <a href="{% url sentry-new-team-member team.slug %}" class="btn pull-right btn-primary">{% trans "New Member" %}</a>
@@ -45,8 +79,8 @@
                 <h2>{% trans "Members" %}</h2>
             </div>
             <ul class="nav nav-tabs">
-                <li class="active"><a href="#members" data-toggle="tab">Members</a></li>
-                <li><a href="#pending-members" data-toggle="tab">Pending ({{ pending_member_list|length }})</a></li>
+                <li class="active"><a href="#members" data-toggle="tab">{% trans "Members" %}</a></li>
+                <li><a href="#pending-members" data-toggle="tab">{% blocktrans with pending_member_list|length as count %}Pending ({{ count }}){% endblocktrans %}</a></li>
             </ul>
             <div class="tab-content">
                 <div class="tab-pane active" id="members">
diff --git a/sentry/templates/sentry/teams/new.html b/sentry/templates/sentry/teams/new.html
index 9317b52431..d06363e1b1 100644
--- a/sentry/templates/sentry/teams/new.html
+++ b/sentry/templates/sentry/teams/new.html
@@ -12,11 +12,12 @@
 {% block main %}
     <section class="body">
         <p>{% trans "Use this page to create a new team within Sentry. Once done, you'll be able to add members to the team." %}</p>
-        <hr>
+        <hr/>
         <form class="form-stacked" action="" method="post">
             {% csrf_token %}
             <fieldset>
                 <legend>{% trans "Team Details" %}</legend>
+                <br/>
                 {% for field in form %}
                     {% include "sentry/partial/_form_field.html" %}
                 {% endfor %}
diff --git a/sentry/templates/sentry/teams/projects/new.html b/sentry/templates/sentry/teams/projects/new.html
new file mode 100644
index 0000000000..c34c2643dd
--- /dev/null
+++ b/sentry/templates/sentry/teams/projects/new.html
@@ -0,0 +1,30 @@
+{% extends "sentry/teams/manage.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "New Project" %} | {{ block.super }}{% endblock %}
+
+{% block breadcrumb %}
+    {{ block.super }}
+    <li class="divider">/</li>
+    <li><a href="{% url sentry-new-team-project team.slug %}">{% trans "New Project" %}</a></li>
+{% endblock %}
+
+{% block main %}
+    <section class="body">
+        <p>{% trans "Use this page to create a new project within Sentry. Once done, you'll be able to configure your client to send messages to this project." %}</p>
+        <hr>
+        <form class="form-stacked" action="" method="post">
+            {% csrf_token %}
+            <fieldset>
+                <legend>{% trans "Project Details" %}</legend>
+                {% for field in form %}
+                    {% include "sentry/partial/_form_field.html" %}
+                {% endfor %}
+            </fieldset>
+            <div class="actions">
+                <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
+            </div>
+        </form>
+    </section>
+{% endblock %}
diff --git a/sentry/web/forms/__init__.py b/sentry/web/forms/__init__.py
index be8c30fb01..f37b532c13 100644
--- a/sentry/web/forms/__init__.py
+++ b/sentry/web/forms/__init__.py
@@ -56,16 +56,23 @@ class RemoveProjectForm(forms.Form):
 
 
 class NewProjectForm(forms.ModelForm):
+    name = forms.CharField(max_length=200, widget=forms.TextInput(attrs={'placeholder': _('e.g. My Project Name')}))
+    slug = forms.SlugField(help_text=_('A slug is a URL-safe word and must be unique across all projects.'),
+        widget=forms.TextInput(attrs={'placeholder': _('e.g. my-project-name')}))
+
     class Meta:
-        fields = ('name',)
+        fields = ('name', 'slug')
         model = Project
 
 
 class NewProjectAdminForm(forms.ModelForm):
+    name = forms.CharField(max_length=200, widget=forms.TextInput(attrs={'placeholder': _('e.g. My Project Name')}))
+    slug = forms.SlugField(help_text=_('A slug is a URL-safe word and must be unique across all projects.'),
+        widget=forms.TextInput(attrs={'placeholder': _('e.g. my-project-name')}))
     owner = UserField(required=False)
 
     class Meta:
-        fields = ('name', 'owner')
+        fields = ('name', 'slug', 'owner')
         model = Project
 
 
diff --git a/sentry/web/forms/teams.py b/sentry/web/forms/teams.py
index 0c637c2992..6c46c80ca6 100644
--- a/sentry/web/forms/teams.py
+++ b/sentry/web/forms/teams.py
@@ -17,12 +17,19 @@ class RemoveTeamForm(forms.Form):
 
 
 class NewTeamForm(forms.ModelForm):
+    name = forms.CharField(max_length=200, widget=forms.TextInput(attrs={'placeholder': _('e.g. My Team Name')}))
+    slug = forms.SlugField(help_text=_('A slug is a URL-safe word and must be unique across all teams.'),
+        widget=forms.TextInput(attrs={'placeholder': _('e.g. my-team-name')}))
+
     class Meta:
         fields = ('name', 'slug')
         model = Team
 
 
 class NewTeamAdminForm(forms.ModelForm):
+    name = forms.CharField(max_length=200, widget=forms.TextInput(attrs={'placeholder': _('e.g. My Team Name')}))
+    slug = forms.SlugField(help_text=_('A slug is a URL-safe word and must be unique across all teams.'),
+        widget=forms.TextInput(attrs={'placeholder': _('e.g. my-team-name')}))
     owner = UserField(required=False)
 
     class Meta:
diff --git a/sentry/web/frontend/admin.py b/sentry/web/frontend/admin.py
index 4351a05e7a..bcd3ac1dd2 100644
--- a/sentry/web/frontend/admin.py
+++ b/sentry/web/frontend/admin.py
@@ -80,8 +80,7 @@ def manage_projects(request):
 
 @requires_admin
 def manage_users(request):
-    user_list = User.objects.annotate(num_projects=Count('sentry_project_set'))\
-                .order_by('-date_joined')
+    user_list = User.objects.all().order_by('-date_joined')
 
     user_query = request.GET.get('uquery')
     if user_query:
@@ -97,8 +96,6 @@ def manage_users(request):
         order_by = '-last_login'
     elif sort == 'name':
         order_by = 'first_name'
-    elif sort == 'projects':
-        order_by = '-num_projects'
 
     user_list = user_list.order_by(order_by)
 
diff --git a/sentry/web/frontend/projects.py b/sentry/web/frontend/projects.py
index fc1f9469de..d03c2a988d 100644
--- a/sentry/web/frontend/projects.py
+++ b/sentry/web/frontend/projects.py
@@ -44,34 +44,11 @@ def project_list(request):
 
 
 @login_required
-@csrf_protect
 def new_project(request):
     if not can_create_projects(request.user):
         return HttpResponseRedirect(reverse('sentry'))
 
-    if request.user.has_perm('sentry.can_add_project'):
-        form_cls = NewProjectAdminForm
-        initial = {
-            'owner': request.user.username,
-        }
-    else:
-        form_cls = NewProjectForm
-        initial = {}
-
-    form = form_cls(request.POST or None, initial=initial)
-    if form.is_valid():
-        project = form.save(commit=False)
-        if not project.owner:
-            project.owner = request.user
-        project.save()
-        return HttpResponseRedirect(reverse('sentry-manage-project', args=[project.pk]))
-
-    context = csrf(request)
-    context.update({
-        'form': form,
-    })
-
-    return render_to_response('sentry/projects/new.html', context, request)
+    return render_to_response('sentry/projects/new.html', {}, request)
 
 
 @login_required
diff --git a/sentry/web/frontend/teams.py b/sentry/web/frontend/teams.py
index 38202cbf51..2fbbc0db9b 100644
--- a/sentry/web/frontend/teams.py
+++ b/sentry/web/frontend/teams.py
@@ -11,7 +11,7 @@ from django.http import HttpResponseRedirect
 from django.views.decorators.csrf import csrf_protect
 
 from sentry.models import PendingTeamMember, TeamMember, MEMBER_USER, MEMBER_OWNER
-from sentry.permissions import can_add_team_member, can_remove_team
+from sentry.permissions import can_add_team_member, can_remove_team, can_create_projects
 from sentry.plugins import plugins
 from sentry.web.decorators import login_required, has_team_access
 from sentry.web.forms.teams import NewTeamForm, NewTeamAdminForm, \
@@ -75,6 +75,9 @@ def manage_team(request, team):
         return HttpResponseRedirect(request.path + '?success=1')
 
     member_list = [(pm, pm.user) for pm in team.member_set.select_related('user')]
+    pending_member_list = [(pm, pm.email) for pm in team.pending_member_set.all()]
+
+    project_list = list(team.project_set.all())
 
     context = csrf(request)
     context.update({
@@ -84,6 +87,8 @@ def manage_team(request, team):
         'form': form,
         'team': team,
         'member_list': member_list,
+        'pending_member_list': pending_member_list,
+        'project_list': project_list,
     })
 
     return render_to_response('sentry/teams/manage.html', context, request)
@@ -310,3 +315,38 @@ def reinvite_pending_team_member(request, team, member_id):
     member.send_invite_email()
 
     return HttpResponseRedirect(reverse('sentry-manage-team', args=[team.slug]) + '?success=1')
+
+
+@csrf_protect
+@has_team_access(MEMBER_OWNER)
+def create_new_team_project(request, team):
+    from sentry.web.forms import NewProjectAdminForm, NewProjectForm
+
+    if not can_create_projects(request.user, team):
+        return HttpResponseRedirect(reverse('sentry'))
+
+    if request.user.has_perm('sentry.can_add_project'):
+        form_cls = NewProjectAdminForm
+        initial = {
+            'owner': request.user.username,
+        }
+    else:
+        form_cls = NewProjectForm
+        initial = {}
+
+    form = form_cls(request.POST or None, initial=initial)
+    if form.is_valid():
+        project = form.save(commit=False)
+        project.team = team
+        if not project.owner:
+            project.owner = request.user
+        project.save()
+        return HttpResponseRedirect(reverse('sentry-manage-project', args=[project.pk]))
+
+    context = csrf(request)
+    context.update({
+        'form': form,
+        'team': team,
+    })
+
+    return render_to_response('sentry/teams/projects/new.html', context, request)
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index b24d3f1660..45dd0bbbc2 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -67,20 +67,21 @@ urlpatterns = patterns('',
         name='sentry-remove-pending-team-member'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/members/pending/(?P<member_id>\d+)/reinvite/$', teams.reinvite_pending_team_member,
         name='sentry-reinvite-pending-team-member'),
+    url(r'^account/teams/(?P<team_slug>[\w_-]+)/projects/new/$', teams.create_new_team_project, name='sentry-new-team-project'),
     url(r'^accept/(?P<member_id>\d+)/(?P<token>\w+)/$', teams.accept_invite,
         name='sentry-accept-invite'),
 
     # Projects
 
-    url(r'^projects/$', projects.project_list, name='sentry-project-list'),
-    url(r'^projects/new/$', projects.new_project, name='sentry-new-project'),
-    url(r'^projects/(?P<project_id>\d+)/edit/$', projects.manage_project,
+    url(r'^account/projects/$', projects.project_list, name='sentry-project-list'),
+    url(r'^account/projects/new/$', projects.new_project, name='sentry-new-project'),
+    url(r'^account/projects/(?P<project_id>\d+)/edit/$', projects.manage_project,
         name='sentry-manage-project'),
-    url(r'^projects/(?P<project_id>\d+)/plugins/$', projects.manage_plugins,
+    url(r'^account/projects/(?P<project_id>\d+)/plugins/$', projects.manage_plugins,
         name='sentry-manage-project-plugins'),
-    url(r'^projects/(?P<project_id>\d+)/plugins/(?P<slug>[\w_-]+)/$', projects.configure_project_plugin,
+    url(r'^account/projects/(?P<project_id>\d+)/plugins/(?P<slug>[\w_-]+)/$', projects.configure_project_plugin,
         name='sentry-configure-project-plugin'),
-    url(r'^projects/(?P<project_id>\d+)/remove/$', projects.remove_project,
+    url(r'^account/projects/(?P<project_id>\d+)/remove/$', projects.remove_project,
         name='sentry-remove-project'),
 
     # Global
diff --git a/tests/sentry/web/frontend/projects/tests.py b/tests/sentry/web/frontend/projects/tests.py
index f4df5671f0..d7508a967a 100644
--- a/tests/sentry/web/frontend/projects/tests.py
+++ b/tests/sentry/web/frontend/projects/tests.py
@@ -7,7 +7,7 @@ import logging
 from django.contrib.auth.models import User
 from django.core.urlresolvers import reverse
 
-from sentry.models import Project, MEMBER_OWNER
+from sentry.models import Project, Team, MEMBER_OWNER
 
 from tests.base import TestCase
 
@@ -21,19 +21,21 @@ class NewProjectTest(TestCase):
         self.user = User(username="admin", email="admin@localhost", is_staff=True, is_superuser=True)
         self.user.set_password('admin')
         self.user.save()
+        self.team = Team.objects.create(name='foo', slug='foo', owner=self.user)
 
     def test_new_project(self):
+        path = reverse('sentry-new-team-project', args=[self.team.slug])
+
         self.client.login(username='admin', password='admin')
 
         # missing name
-        path = reverse('sentry-new-project')
-        resp = self.client.post(path, {})
+        resp = self.client.post(path)
         self.assertEquals(resp.status_code, 200)
 
         # valid params
-        path = reverse('sentry-new-project')
         resp = self.client.post(path, {
             'name': 'Test Project',
+            'slug': 'test',
         })
         self.assertNotEquals(resp.status_code, 200)
 
