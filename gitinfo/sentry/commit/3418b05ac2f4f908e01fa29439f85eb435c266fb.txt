commit 3418b05ac2f4f908e01fa29439f85eb435c266fb
Author: Ted Kaemming <ted@kaemming.com>
Date:   Tue Mar 14 13:05:56 2017 -0700

    Fix bad Redis command reference, ensure path is covered in tests.
    
    Nothing to see here ...

diff --git a/src/sentry/scripts/similarity/index.lua b/src/sentry/scripts/similarity/index.lua
index 437ec3fc80..a5b4b30baa 100644
--- a/src/sentry/scripts/similarity/index.lua
+++ b/src/sentry/scripts/similarity/index.lua
@@ -628,7 +628,7 @@ local commands = {
                         )
 
                         local buckets = redis.call(
-                            'HGETKEYS',
+                            'HKEYS',
                             source_bucket_frequency_key
                         )
 
diff --git a/tests/sentry/test_similarity.py b/tests/sentry/test_similarity.py
index 14f8e93850..08ccb3a95c 100644
--- a/tests/sentry/test_similarity.py
+++ b/tests/sentry/test_similarity.py
@@ -133,6 +133,11 @@ class MinHashIndexTestCase(TestCase):
         assert results[3][0] in ('3', '4')
         assert results[4][0] == '5'
 
+        index.delete('example', [('index', '3')])
+        assert [key for key, _ in index.query('example', '1', ['index'])[0]] == [
+            '1', '2', '4', '5'
+        ]
+
     def test_export_import(self):
         bands = 2
         retention = 12
