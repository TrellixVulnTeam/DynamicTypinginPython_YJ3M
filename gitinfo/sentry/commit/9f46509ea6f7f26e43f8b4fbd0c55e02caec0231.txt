commit 9f46509ea6f7f26e43f8b4fbd0c55e02caec0231
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Jul 15 10:31:17 2013 -0700

    Add custom create_user step for django-social-auth which repssects SOCIAL_AUTH_CREATE_USERS (fixes GH-582)

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index aa788d3f2c..7013617fd5 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -110,6 +110,7 @@ MIDDLEWARE_CLASSES = (
     'django.middleware.csrf.CsrfViewMiddleware',
     'django.contrib.auth.middleware.AuthenticationMiddleware',
     'sentry.middleware.SentryMiddleware',
+    'sentry.middleware.SentrySocialAuthExceptionMiddleware',
     'django.middleware.locale.LocaleMiddleware',
     'django.contrib.messages.middleware.MessageMiddleware',
 )
@@ -229,6 +230,15 @@ GITHUB_API_SECRET = ''
 TRELLO_API_KEY = ''
 TRELLO_API_SECRET = ''
 
+SOCIAL_AUTH_PIPELINE = (
+    'social_auth.backends.pipeline.social.social_auth_user',
+    'social_auth.backends.pipeline.user.get_username',
+    'sentry.utils.social_auth.create_user_if_enabled',
+    'social_auth.backends.pipeline.social.associate_user',
+    'social_auth.backends.pipeline.social.load_extra_data',
+    'social_auth.backends.pipeline.user.update_user_details'
+)
+
 SOCIAL_AUTH_CREATE_USERS = True
 
 import random
diff --git a/src/sentry/middleware.py b/src/sentry/middleware.py
index af1c6ca0d0..9804065d86 100644
--- a/src/sentry/middleware.py
+++ b/src/sentry/middleware.py
@@ -1,6 +1,7 @@
 from sentry.app import env
 from sentry.conf import settings
 from sentry.models import UserOption
+from sentry.utils.http import absolute_uri
 from django.core.urlresolvers import reverse
 
 
@@ -22,3 +23,11 @@ class SentryMiddleware(object):
         language = UserOption.objects.get_value(user=request.user, project=None, key='language', default=None)
         if language:
             request.session['django_language'] = language
+
+
+
+from social_auth.middleware import SocialAuthExceptionMiddleware
+
+class SentrySocialAuthExceptionMiddleware(SocialAuthExceptionMiddleware):
+    def get_redirect_uri(self, request, exception):
+        return absolute_uri(reverse('sentry-login'))
diff --git a/src/sentry/utils/social_auth.py b/src/sentry/utils/social_auth.py
new file mode 100644
index 0000000000..52d13e4591
--- /dev/null
+++ b/src/sentry/utils/social_auth.py
@@ -0,0 +1,31 @@
+"""
+sentry.utils.social_auth
+~~~~~~~~~~~~~~~~~~~~~~~~
+
+:copyright: (c) 2010-2013 by the Sentry Team, see AUTHORS for more details.
+:license: BSD, see LICENSE for more details.
+"""
+from __future__ import absolute_import
+
+from django.conf import settings
+
+from social_auth.backends.pipeline.user import create_user
+from social_auth.exceptions import SocialAuthBaseException
+
+
+class AuthNotAllowed(SocialAuthBaseException):
+    pass
+
+
+def create_user_if_enabled(*args, **kwargs):
+    """
+    A pipeline step for django-social-auth
+    Create user. Depends on get_username pipeline.
+    """
+    if not settings.SOCIAL_AUTH_CREATE_USERS:
+        user = kwargs.get('user')
+        if not user:
+            raise AuthNotAllowed('You must create an account before associating an identity.')
+        return user
+
+    return create_user(*args, **kwargs)
