commit 806297124a3eef46346a8c42d464c990ff6481b9
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri Dec 4 14:27:49 2015 -0800

    Add some hacks to support settings.{ALLOWED_HOSTS,SENTRY_URL_PREFIX}

diff --git a/src/sentry/runner/hacks.py b/src/sentry/runner/hacks.py
new file mode 100644
index 0000000000..33b6649f7f
--- /dev/null
+++ b/src/sentry/runner/hacks.py
@@ -0,0 +1,20 @@
+"""
+sentry.runner.hacks
+~~~~~~~~~~~~~~~~~~~
+
+:copyright: (c) 2015 by the Sentry Team, see AUTHORS for more details.
+:license: BSD, see LICENSE for more details.
+"""
+from __future__ import absolute_import, print_function
+
+from urlparse import urlparse
+from sentry import options
+
+
+class AllowedHosts(object):
+    def __iter__(self):
+        urlbits = urlparse(options.get('system.url-prefix'))
+        if urlbits.hostname:
+            yield urlbits.hostname
+        else:
+            yield '*'
diff --git a/src/sentry/runner/initializer.py b/src/sentry/runner/initializer.py
index 9dc82c7d18..e6c195d09e 100644
--- a/src/sentry/runner/initializer.py
+++ b/src/sentry/runner/initializer.py
@@ -207,16 +207,22 @@ def apply_legacy_settings(settings):
                       "Use SENTRY_OPTIONS instead, key 'system.url-prefix'", DeprecationWarning)
         settings.SENTRY_OPTIONS['system.url-prefix'] = settings.SENTRY_URL_PREFIX
 
+    if not hasattr(settings, 'SENTRY_URL_PREFIX'):
+        from sentry import options
+        url_prefix = options.get('system.url-prefix')
+        if not url_prefix:
+            # HACK: We need to have some value here for backwards compatibility
+            url_prefix = 'http://sentry.example.com'
+        settings.SENTRY_URL_PREFIX = url_prefix
+
     if settings.TIME_ZONE != 'UTC':
         # non-UTC timezones are not supported
         show_big_error('TIME_ZONE should be set to UTC')
 
     # Set ALLOWED_HOSTS if it's not already available
     if not settings.ALLOWED_HOSTS:
-        from urlparse import urlparse
-        urlbits = urlparse(settings.SENTRY_URL_PREFIX)
-        if urlbits.hostname:
-            settings.ALLOWED_HOSTS = (urlbits.hostname,)
+        from .hacks import AllowedHosts
+        settings.ALLOWED_HOSTS = AllowedHosts()
 
     if hasattr(settings, 'SENTRY_ALLOW_REGISTRATION'):
         import warnings
diff --git a/src/sentry/web/helpers.py b/src/sentry/web/helpers.py
index 33a8e22e6b..a51956dc44 100644
--- a/src/sentry/web/helpers.py
+++ b/src/sentry/web/helpers.py
@@ -53,7 +53,7 @@ def get_default_context(request, existing_context=None, team=None):
         'URL_PREFIX': options.get('system.url-prefix'),
         'SINGLE_ORGANIZATION': settings.SENTRY_SINGLE_ORGANIZATION,
         'PLUGINS': plugins,
-        'ALLOWED_HOSTS': settings.ALLOWED_HOSTS,
+        'ALLOWED_HOSTS': list(settings.ALLOWED_HOSTS),
     }
 
     if existing_context:
