commit 17f73ce0f7562fc5a68d39232057f8985f020fec
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Oct 13 16:44:08 2016 -0700

    Restructure email base template to ensure consistent footer display. (#4357)

diff --git a/src/sentry/templates/sentry/emails/base.html b/src/sentry/templates/sentry/emails/base.html
index 61bb2d7438..418cb03a06 100644
--- a/src/sentry/templates/sentry/emails/base.html
+++ b/src/sentry/templates/sentry/emails/base.html
@@ -33,6 +33,9 @@
           <p>This is the body of an email</p>
           {% endblock %}
         </div>
+      </div>
+      {% endblock %}
+      <div class="container">
         <div class="footer">
           {% block footer %}
           <a href="{% absolute_uri %}" style="float:right">Home</a>
@@ -44,7 +47,6 @@
           {% endblock %}
         </div>
       </div>
-      {% endblock %}
     </td>
   </tr>
 </table>
diff --git a/src/sentry/templates/sentry/emails/digests/body.html b/src/sentry/templates/sentry/emails/digests/body.html
index 40f5c0c8c1..e69a39d72d 100644
--- a/src/sentry/templates/sentry/emails/digests/body.html
+++ b/src/sentry/templates/sentry/emails/digests/body.html
@@ -52,18 +52,4 @@
     </div>
 {% endfor %}
 
-    <p>
-      <a href="{{ unsubscribe_link }}">Click to unsubscribe</a>
-    </p>
-
-<div class="container">
-  <div class="footer" style="margin-top: 30px">
-    {% block footer %}
-    <a href="{% absolute_uri %}" style="float:right">Home</a>
-    {% url 'sentry-account-settings-notifications' as settings_link %}
-    <a href="{% absolute_uri settings_link %}">Notification Settings</a>
-    {% endblock %}
-  </div>
-</div>
-
 {% endblock %}
diff --git a/src/sentry/templates/sentry/emails/reports/body.html b/src/sentry/templates/sentry/emails/reports/body.html
index 79f69fe9e1..037d6a812c 100644
--- a/src/sentry/templates/sentry/emails/reports/body.html
+++ b/src/sentry/templates/sentry/emails/reports/body.html
@@ -425,18 +425,5 @@
       </tr>
     </table>
   {% endif %}
-
-  {% comment %}
-  <div class="unsubscribe-box">
-    Not enjoying these? <a>Click to unsubscribe</a>.
-  </div>
-  {% endcomment %}
-</div>
-<div class="footer">
-  <div class="container">
-    <a href="{% absolute_uri %}" style="float:right">Home</a>
-    {% url 'sentry-account-settings-notifications' as settings_link %}
-    <a href="{% absolute_uri settings_link %}">Notification Settings</a>
-  </div>
 </div>
 {% endblock %}
diff --git a/src/sentry/web/frontend/debug/mail.py b/src/sentry/web/frontend/debug/mail.py
index f5e2a69a09..64c8ecb892 100644
--- a/src/sentry/web/frontend/debug/mail.py
+++ b/src/sentry/web/frontend/debug/mail.py
@@ -97,6 +97,11 @@ def make_group_generator(random, project):
         yield group
 
 
+def add_unsubscribe_link(context):
+    if 'unsubscribe_link' not in context:
+        context['unsubscribe_link'] = 'javascript:alert("This is a preview page, what did you expect to happen?");'
+
+
 # TODO(dcramer): use https://github.com/disqus/django-mailviews
 class MailPreview(object):
     def __init__(self, html_template, text_template, context=None, subject=None):
@@ -104,6 +109,7 @@ class MailPreview(object):
         self.text_template = text_template
         self.subject = subject
         self.context = context if context is not None else {}
+        add_unsubscribe_link(self.context)
 
     def text_body(self):
         return render_to_string(self.text_template, self.context)
@@ -129,13 +135,11 @@ class ActivityMailPreview(object):
 
     def get_context(self):
         context = self.email.get_base_context()
-        context.update({
-            'reason': get_random(self.request).choice(
-                GroupSubscriptionReason.descriptions.values()
-            ),
-            'unsubscribe_link': 'javascript:alert("This is a preview page, what did you expect to happen?");',
-        })
+        context['reason'] = get_random(self.request).choice(
+            GroupSubscriptionReason.descriptions.values()
+        )
         context.update(self.email.get_context())
+        add_unsubscribe_link(context)
         return context
 
     def text_body(self):
@@ -354,16 +358,19 @@ def digest(request):
     digest = build_digest(project, records, state)
     start, end, counts = get_digest_metadata(digest)
 
+    context = {
+        'project': project,
+        'counts': counts,
+        'digest': digest,
+        'start': start,
+        'end': end,
+    }
+    add_unsubscribe_link(context)
+
     return MailPreview(
         html_template='sentry/emails/digests/body.html',
         text_template='sentry/emails/digests/body.txt',
-        context={
-            'project': project,
-            'counts': counts,
-            'digest': digest,
-            'start': start,
-            'end': end,
-        },
+        context=context,
     ).render(request)
 
 
