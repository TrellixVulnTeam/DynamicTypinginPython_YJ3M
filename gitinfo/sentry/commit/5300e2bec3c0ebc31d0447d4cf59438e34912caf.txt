commit 5300e2bec3c0ebc31d0447d4cf59438e34912caf
Author: Ted Kaemming <ted@kaemming.com>
Date:   Wed Oct 7 17:37:04 2015 -0700

    Fix expiration logic.

diff --git a/src/sentry/tsdb/redis.py b/src/sentry/tsdb/redis.py
index 09ffdd6a33..1832f0f86f 100644
--- a/src/sentry/tsdb/redis.py
+++ b/src/sentry/tsdb/redis.py
@@ -186,12 +186,13 @@ class RedisTSDB(BaseTSDB):
             for model, key, values in items:
                 c = client.target_key(key)
                 for rollup, max_values in self.rollups:
-                    expire = rollup * max_values  # XXX: This logic can lead to incorrect expiry values.
-
                     m = self.get_model_key(key)
                     k = self.make_key(model, self.normalize_to_rollup(timestamp, rollup), m)
                     c.pfadd(k, m, *values)
-                    c.expire(k, expire)
+                    c.expireat(
+                        k,
+                        self.calculate_expiry(rollup, max_values, timestamp),
+                    )
 
         # TODO: Check to make sure these operations didn't fail, so we can
         # raise an error if there were issues.
