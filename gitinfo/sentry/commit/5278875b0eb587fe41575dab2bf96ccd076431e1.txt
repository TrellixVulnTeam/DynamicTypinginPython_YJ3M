commit 5278875b0eb587fe41575dab2bf96ccd076431e1
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Thu Apr 19 08:31:37 2018 -0700

    fix(api): Create audit log entry when editing member details (#8023)

diff --git a/src/sentry/api/endpoints/organization_member_details.py b/src/sentry/api/endpoints/organization_member_details.py
index e0580335de..9cfa140d41 100644
--- a/src/sentry/api/endpoints/organization_member_details.py
+++ b/src/sentry/api/endpoints/organization_member_details.py
@@ -214,6 +214,15 @@ class OrganizationMemberDetailsEndpoint(OrganizationEndpoint):
 
             om.update(role=result['role'])
 
+        self.create_audit_entry(
+            request=request,
+            organization=organization,
+            target_object=om.id,
+            target_user=om.user,
+            event=AuditLogEntryEvent.MEMBER_EDIT,
+            data=om.get_audit_log_data(),
+        )
+
         context = self._serialize_member(om, request, allowed_roles)
 
         return Response(context)
diff --git a/src/sentry/models/auditlogentry.py b/src/sentry/models/auditlogentry.py
index d197863b7b..e581878f67 100644
--- a/src/sentry/models/auditlogentry.py
+++ b/src/sentry/models/auditlogentry.py
@@ -6,6 +6,7 @@ sentry.models.auditlogentry
 :license: BSD, see LICENSE for more details.
 """
 from __future__ import absolute_import, print_function
+import six
 
 from django.db import models
 from django.utils import timezone
@@ -189,8 +190,10 @@ class AuditLogEntry(Model):
                 self.data.get('email') or self.target_user.get_display_name(),
             )
         elif self.event == AuditLogEntryEvent.MEMBER_EDIT:
-            return 'edited member %s' % (
+            return 'edited member %s (role: %s, teams: %s)' % (
                 self.data.get('email') or self.target_user.get_display_name(),
+                self.data.get('role') or 'N/A',
+                ', '.join(six.text_type(x) for x in self.data.get('team_slugs', [])) or 'N/A',
             )
         elif self.event == AuditLogEntryEvent.MEMBER_JOIN_TEAM:
             if self.target_user == self.actor:
diff --git a/src/sentry/models/organizationmember.py b/src/sentry/models/organizationmember.py
index a45ba20489..770ec62529 100644
--- a/src/sentry/models/organizationmember.py
+++ b/src/sentry/models/organizationmember.py
@@ -235,20 +235,21 @@ class OrganizationMember(Model):
 
     def get_audit_log_data(self):
         from sentry.models import Team
+        teams = list(Team.objects.filter(
+            id__in=OrganizationMemberTeam.objects.filter(
+                organizationmember=self,
+                is_active=True,
+            ).values_list('team', flat=True)
+        ).values('id', 'slug')
+        )
+
         return {
             'email':
             self.email,
             'user':
             self.user_id,
-            'teams':
-            list(
-                Team.objects.filter(
-                    id__in=OrganizationMemberTeam.objects.filter(
-                        organizationmember=self,
-                        is_active=True,
-                    ).values_list('team', flat=True)
-                ).values_list('id', flat=True)
-            ),
+            'teams': [t['id'] for t in teams],
+            'teams_slugs': [t['slug'] for t in teams],
             'has_global_access':
             self.has_global_access,
             'role':
