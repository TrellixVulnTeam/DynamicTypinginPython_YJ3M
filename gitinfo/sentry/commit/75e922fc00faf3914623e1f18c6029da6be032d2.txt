commit 75e922fc00faf3914623e1f18c6029da6be032d2
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Dec 26 13:49:10 2011 -0800

    Added edit/add/remove member pages and moved all member control to those pages

diff --git a/sentry/templates/sentry/layout.html b/sentry/templates/sentry/layout.html
index 90dbb68fbe..49cc34c65d 100644
--- a/sentry/templates/sentry/layout.html
+++ b/sentry/templates/sentry/layout.html
@@ -52,7 +52,7 @@
                                 <li class="dropdown" data-dropdown="dropdown">
                                     <a href="#" class="dropdown-toggle">{% trans "Account" %}</a>
                                     <ul class="dropdown-menu">
-                                        <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a></li>
+                                        <li><a href="{% url sentry-project-list %}">{% trans "Manage Projects" %}</a></li>
                                         <li class="divider"></li>
                                         <li><a href="{% url sentry-logout %}">{% trans "Logout" %}</a></li>
                                     </ul>
diff --git a/sentry/templates/sentry/projects/manage.html b/sentry/templates/sentry/projects/manage.html
index a98f3a3901..46e057024b 100644
--- a/sentry/templates/sentry/projects/manage.html
+++ b/sentry/templates/sentry/projects/manage.html
@@ -22,19 +22,21 @@
         <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a> <span class="divider">/</span></li>
         <li class="active">{% trans "Manage Project" %}</li>
     </ul>
-    <p>Here you can edit project information, as well as control the access list for a project with fine-grained permissions.</p>
+    <p>{% trans "Here you can edit project information, as well as control the access list for a project with fine-grained permissions." %}</p>
     <hr>
+    <div class="page-header">
+        <h2>{% trans "Project Details" %}</h2>
+    </div>
     {% if request.GET.success %}
-        <div class="alert-message success">Changes to your project were saved successfully.</div>
+        <div class="alert-message success">{% trans "Changes to your project were saved successfully." %}</div>
     {% else %}
-        {% if form.errors or pm_formset.errors %}
-            <div class="alert-message error">Please correct the errors below.</div>
+        {% if form.errors %}
+            <div class="alert-message error">{% trans "Please correct the errors below." %}</div>
         {% endif %}
     {% endif %}
     <form class="form-stacked" action="" method="post">
         {% csrf_token %}
         <fieldset>
-            <legend>{% trans "Project Details" %}</legend>
             {% for field in form %}
                 <div class="clearfix{% if field.errors %} error{% endif %}">
                     {{ field.label_tag }}
@@ -45,52 +47,50 @@
                 </div>
             {% endfor %}
         </fieldset>
-        <fieldset>
-            {{ pm_formset.management_form }}
-            <legend>{% trans "Access" %}</legend>
-            <table class="bordered-table zebra-striped">
-                <colgroup>
-                    <col width="100px"/>
-                    <col/>
-                    <col width="16px"/>
-                </colgroup>
-                <thead>
-                    <tr>
-                        <th>Username</th>
-                        <th>Access</th>
-                        <th>X</th>
-                    </tr>
-                </thead>
-                <tbody>
-                    {% for pm_form in pm_formset %}
-                        <tr>
-                            <td{% if pm_form.errors.user %} class="error"{% endif %}>
-                                {{ pm_form.user }}
-                                {% if pm_form.errors.user %}
-                                    <ul class="unstyled">
-                                        {% for error in pm_form.errors.user %}
-                                            <li>{{ error }}</li>
-                                        {% endfor %}
-                                    </ul>
-                                {% endif %}
-                            </td>
-                            <td>
-                                <div class="clearfix">
-                                    <label>{{ pm_form.is_superuser }} Superuser (all permissions)</label>
-                                </div>
-                                {{ pm_form.permissions }}
-                            </td>
-                            <td>
-                                {{ pm_form.id }}
-                                {{ pm_form.DELETE }}
-                            </td>
-                        </tr>
-                    {% endfor %}
-                </tbody>
-            </table>
-        </fieldset>
         <p class="actions">
             <button type="submit" class="btn primary">{% trans "Save Changes" %}</button>
         </p>
     </form>
+    <div class="page-header">
+        <a href="{% url sentry-new-project-member project.pk %}" class="btn pull-right small primary">+ New Member</a>
+        <h2>{% trans "Members" %}</h2>
+    </div>
+    <table class="bordered-table zebra-striped">
+        <colgroup>
+            <col width="100px"/>
+            <col/>
+            <col width="50px"/>
+        </colgroup>
+        <thead>
+            <tr>
+                <th>Username</th>
+                <th>Access</th>
+                <th>&nbsp;</th>
+            </tr>
+        </thead>
+        <tbody>
+            {% for member, user, permissions in member_list %}
+                <tr>
+                    <td><a href="{% url sentry-edit-project-member project.pk member.pk %}">{{ user.username }}</a></td>
+                    <td>
+                        {% if member.is_superuser %}
+                            <strong>superuser</strong>
+                        {% else %}
+                            {% for perm in permissions %}
+                                {{ perm }}
+                                {% if not loop.last %}, {% endif %}
+                            {% endfor %}
+                        {% endif %}
+                    </td>
+                    <td>
+                        {% if user == project.owner %}
+                            <em>owner</em>
+                        {% else %}
+                            <a href="" class="btn small danger">Delete</a>
+                        {% endif %}
+                    </td>
+                </tr>
+            {% endfor %}
+        </tbody>
+    </table>
 {% endblock %}
diff --git a/sentry/templates/sentry/projects/members/edit.html b/sentry/templates/sentry/projects/members/edit.html
new file mode 100644
index 0000000000..6627b36259
--- /dev/null
+++ b/sentry/templates/sentry/projects/members/edit.html
@@ -0,0 +1,65 @@
+{% extends "sentry/projects/manage.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Edit Member" %} | {{ block.super }}{% endblock %}
+
+{% block heading %}{% trans "Edit Member" %}{% endblock %}
+
+{% block main %}
+    <ul class="breadcrumb">
+        <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a> <span class="divider">/</span></li>
+        <li><a href="{% url sentry-manage-project project.pk %}">{% trans "Manage Project" %}</a> <span class="divider">/</span></li>
+        <li class="active">{% trans "Edit Member" %}</li>
+    </ul>
+    {% if request.GET.success %}
+        <div class="alert-message success">{% trans "Changes to your project were saved successfully." %}</div>
+    {% else %}
+        {% if form.errors %}
+            <div class="alert-message error">{% trans "Please correct the errors below." %}</div>
+        {% endif %}
+    {% endif %}
+    <form class="form-stacked" action="" method="post">
+        {% csrf_token %}
+        <fieldset>
+            <div class="page-header">
+                <h2>{% trans "Details" %}</h2>
+            </div>
+            <div class="clearfix">
+                <label>{% trans "User" %}</label>
+                <div class="input">{{ member.user.username }}</div>
+            </div>
+            <div class="clearfix">
+                <label>{% trans "Public Key" %}</label>
+                <div class="input">{{ member.public_key }}</div>
+            </div>
+            <div class="clearfix">
+                <label>{% trans "Secret Key" %}</label>
+                <div class="input">{{ member.secret_key }}</div>
+            </div>
+        </fieldset>
+        <fieldset>
+            <div class="page-header">
+                <h2>{% trans "Access" %}</h2>
+            </div>
+            <div class="clearfix{% if form.is_superuser.errors %} error{% endif %}">
+                <div class="input">
+                    <label>{{ form.is_superuser }} This member is a <strong>superuser</strong></label>
+                </div>
+                {% if form.is_superuser.help_text %}
+                    <span class="help-block">{{ form.is_superuser.help_text }}</span>
+                {% endif %}
+            </div>
+            <div class="clearfix{% if form.permissions.errors %} error{% endif %}">
+                {{ form.permissions.label_tag }}
+                <div class="input">{{ form.permissions }}</div>
+                {% if form.permissions.help_text %}
+                    <span class="help-block">{{ form.permissions.help_text }}</span>
+                {% endif %}
+            </div>
+        </fieldset>
+        <div class="actions">
+            <button type="submit" class="btn primary">{% trans "Save Changes" %}</button>
+        </div>
+    </form>
+{% endblock %}
diff --git a/sentry/templates/sentry/projects/members/new.html b/sentry/templates/sentry/projects/members/new.html
new file mode 100644
index 0000000000..b92b90241f
--- /dev/null
+++ b/sentry/templates/sentry/projects/members/new.html
@@ -0,0 +1,61 @@
+{% extends "sentry/projects/manage.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "New Member" %} | {{ block.super }}{% endblock %}
+
+{% block heading %}{% trans "New Member" %}{% endblock %}
+
+{% block main %}
+    <ul class="breadcrumb">
+        <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a> <span class="divider">/</span></li>
+        <li><a href="{% url sentry-manage-project project.pk %}">{% trans "Manage Project" %}</a> <span class="divider">/</span></li>
+        <li class="active">{% trans "New Member" %}</li>
+    </ul>
+    {% if form.errors %}
+        <div class="alert-message error">{% trans "Please correct the errors below." %}</div>
+    {% endif %}
+    <form class="form-stacked" action="" method="post">
+        {% csrf_token %}
+        <fieldset>
+            <div class="page-header">
+                <h2>{% trans "Details" %}</h2>
+            </div>
+            <div class="clearfix{% if form.user.errors %} error{% endif %}">
+                {{ form.user.label_tag }}
+                <div class="input">{{ form.user }}</div>
+                {% if form.user.help_text %}
+                    <span class="help-inline">{{ form.user.help_text }}</span>
+                {% endif %}
+                {% if form.user.errors %}
+                    {% for error in form.user.errors %}
+                        <span class="help-block error">{{ error }}</span>
+                    {% endfor %}
+                {% endif %}
+            </div>
+        </fieldset>
+        <fieldset>
+            <div class="page-header">
+                <h2>{% trans "Access" %}</h2>
+            </div>
+            <div class="clearfix{% if form.is_superuser.errors %} error{% endif %}">
+                <div class="input">
+                    <label>{{ form.is_superuser }} This member is a <strong>superuser</strong></label>
+                </div>
+                {% if form.is_superuser.help_text %}
+                    <span class="help-block">{{ form.is_superuser.help_text }}</span>
+                {% endif %}
+            </div>
+            <div class="clearfix{% if form.permissions.errors %} error{% endif %}">
+                {{ form.permissions.label_tag }}
+                <div class="input">{{ form.permissions }}</div>
+                {% if form.permissions.help_text %}
+                    <span class="help-block">{{ form.permissions.help_text }}</span>
+                {% endif %}
+            </div>
+        </fieldset>
+        <div class="actions">
+            <button type="submit" class="btn primary">{% trans "Save Changes" %}</button>
+        </div>
+    </form>
+{% endblock %}
diff --git a/sentry/templates/sentry/projects/members/remove.html b/sentry/templates/sentry/projects/members/remove.html
new file mode 100644
index 0000000000..5289741894
--- /dev/null
+++ b/sentry/templates/sentry/projects/members/remove.html
@@ -0,0 +1,22 @@
+{% extends "sentry/projects/manage.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Remove Member" %} | {{ block.super }}{% endblock %}
+
+{% block heading %}{% trans "Remove Member" %}{% endblock %}
+
+{% block main %}
+    <ul class="breadcrumb">
+        <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a> <span class="divider">/</span></li>
+        <li><a href="{% url sentry-manage-project project.pk %}">{% trans "Manage Project" %}</a> <span class="divider">/</span></li>
+        <li class="active">{% trans "Remove Member" %}</li>
+    </ul>
+    <form class="form-stacked" action="" method="post">
+        {% csrf_token %}
+        <div class="alert-message block-message error">{% trans "Are you sure you wish to remove this user? <strong>This change is permanent and will revoke their API keys immediately.</strong>" %}</div>
+        <div class="actions">
+            <button type="submit" class="btn danger">{% trans "Confirm" %}</button> <a href="{% url sentry-manage-project project.pk %}" class="btn">{% trans "Cancel" %}</a>
+        </div>
+    </form>
+{% endblock %}
diff --git a/sentry/templates/sentry/projects/new.html b/sentry/templates/sentry/projects/new.html
index c281d91e09..89e6f29f29 100644
--- a/sentry/templates/sentry/projects/new.html
+++ b/sentry/templates/sentry/projects/new.html
@@ -4,16 +4,14 @@
 
 {% block title %}{% trans "New Project" %} | {{ block.super }}{% endblock %}
 
-{% block heading %}
-    {% blocktrans with project.name as name %}New Project{% endblocktrans %}
-{% endblock %}
+{% block heading %}{% trans "New Project" %}{% endblock %}
 
 {% block main %}
     <ul class="breadcrumb">
         <li><a href="{% url sentry-project-list %}">{% trans "Projects" %}</a> <span class="divider">/</span></li>
         <li class="active">{% trans "New Project" %}</li>
     </ul>
-    <p>Use this page to create a new project within Sentry. Once done, you'll be able to add members (whether they're system or actual users), as well as configure your client to send messages to this project.</p>
+    <p>{% trans "Use this page to create a new project within Sentry. Once done, you'll be able to add members (whether they're system or actual users), as well as configure your client to send messages to this project." %}</p>
     <hr>
     <form class="form-stacked" action="" method="post">
         {% csrf_token %}
diff --git a/sentry/web/forms.py b/sentry/web/forms.py
index 8ff29d1a46..b7d7db582f 100644
--- a/sentry/web/forms.py
+++ b/sentry/web/forms.py
@@ -96,28 +96,17 @@ class EditProjectForm(forms.ModelForm):
         model = Project
 
 
-class ProjectMemberForm(forms.ModelForm):
-    user = UserField()
+class BaseProjectMemberForm(forms.ModelForm):
     permissions = forms.MultipleChoiceField(choices=PERMISSIONS, widget=BitFieldCheckboxSelectMultiple(), required=False)
-    is_superuser = forms.BooleanField(required=False)
+    is_superuser = forms.BooleanField(required=False, help_text="Grants the user all permissions")
 
     class Meta:
-        fields = ('is_superuser', 'permissions', 'user')
+        fields = ('is_superuser', 'permissions')
         model = ProjectMember
 
-    # def __init__(self, project, *args, **kwargs):
-    #     self.project = project
-    #     super(ProjectMemberForm, self).__init__(*args, **kwargs)
-
-    def clean_user(self):
-        value = self.cleaned_data['user']
-        if not value:
-            return None
-
-        # if self.project.member_set.filter(user=value).exists():
-        #     raise forms.ValidationError('User already a member of project')
-
-        return value
+    def __init__(self, project, *args, **kwargs):
+        self.project = project
+        super(BaseProjectMemberForm, self).__init__(*args, **kwargs)
 
     def clean_permissions(self):
         value = self.cleaned_data['permissions']
@@ -130,6 +119,27 @@ class ProjectMemberForm(forms.ModelForm):
         return int(result)
 
 
+EditProjectMemberForm = BaseProjectMemberForm
+
+
+class NewProjectMemberForm(BaseProjectMemberForm):
+    user = UserField()
+
+    class Meta:
+        fields = ('user', 'is_superuser', 'permissions')
+        model = ProjectMember
+
+    def clean_user(self):
+        value = self.cleaned_data['user']
+        if not value:
+            return None
+
+        if self.project.member_set.filter(user=value).exists():
+            raise forms.ValidationError('User already a member of project')
+
+        return value
+
+
 class ReplayForm(forms.Form):
     url = forms.URLField()
     method = forms.ChoiceField(choices=((k, k) for k in Http.METHODS))
diff --git a/sentry/web/frontend/projects.py b/sentry/web/frontend/projects.py
index a4674c8386..fd8c0cacbb 100644
--- a/sentry/web/frontend/projects.py
+++ b/sentry/web/frontend/projects.py
@@ -1,14 +1,13 @@
 from django.core.context_processors import csrf
 from django.core.urlresolvers import reverse
-from django.forms.models import modelformset_factory
-from django.http import HttpResponseRedirect
+from django.http import HttpResponseRedirect, HttpResponseForbidden
 from django.views.decorators.csrf import csrf_protect
 
-from sentry.models import ProjectMember
+from sentry.models import PERMISSIONS_DICT
 from sentry.web.decorators import login_required, can_manage, \
      permission_required
 from sentry.web.forms import EditProjectForm, NewProjectForm, \
-     ProjectMemberForm
+     EditProjectMemberForm, NewProjectMemberForm
 from sentry.web.helpers import render_to_response
 
 
@@ -46,40 +45,85 @@ def new_project(request):
 @can_manage
 @csrf_protect
 def manage_project(request, project):
-    ProjectMemberFormset = modelformset_factory(
-        model=ProjectMember,
-        form=ProjectMemberForm,
-        extra=1,
-        can_delete=True,
-    )
-
-    pm_formset_kwargs = dict(
-        prefix='pm:',
-        queryset=project.member_set.exclude(user=project.owner),
-    )
-
-    form = EditProjectForm(request.POST or None, instance=project, prefix='p:')
-    pm_formset = ProjectMemberFormset(
-        data=request.POST or None,
-        **pm_formset_kwargs
-    )
-
-    if all([f.is_valid() for f in [form, pm_formset]]):
-        if form.is_valid():
-            project = form.save()
-
-        if pm_formset.is_valid():
-            for instance in pm_formset.save(commit=False):
-                instance.project = project
-                instance.save()
+    form = EditProjectForm(request.POST or None, instance=project)
+
+    if form.is_valid():
+        project = form.save()
 
         return HttpResponseRedirect(request.path + '?success=1')
 
+    member_list = [
+        (pm, pm.user, [(k, PERMISSIONS_DICT[k]) for k, v in pm.permissions if v])
+        for pm in project.member_set.select_related('user')
+    ]
+
     context = csrf(request)
     context.update({
         'form': form,
-        'pm_formset': pm_formset,
         'project': project,
+        'member_list': member_list
     })
 
     return render_to_response('sentry/projects/manage.html', context, request)
+
+
+@csrf_protect
+@can_manage('add_member')
+def new_project_member(request, project):
+    form = NewProjectMemberForm(project, request.POST or None)
+    if form.is_valid():
+        pm = form.save(commit=False)
+        pm.project = project
+        pm.save()
+
+        return HttpResponseRedirect(reverse('sentry-edit-project-member', args=[project.pk, pm.id]))
+
+    context = csrf(request)
+    context.update({
+        'project': project,
+        'form': form,
+    })
+
+    return render_to_response('sentry/projects/members/new.html', context, request)
+
+
+@csrf_protect
+@can_manage('change_member')
+def edit_project_member(request, project, member_id):
+    member = project.member_set.get(pk=member_id)
+
+    form = EditProjectMemberForm(project, request.POST or None, instance=member)
+    if form.is_valid():
+        member = form.save(commit=True)
+
+        return HttpResponseRedirect(request.path + '?success=1')
+
+    context = csrf(request)
+    context.update({
+        'member': member,
+        'project': project,
+        'form': form,
+    })
+
+    return render_to_response('sentry/projects/members/edit.html', context, request)
+
+
+@csrf_protect
+@can_manage('delete_member')
+def remove_project_member(request, project, member_id):
+    member = project.member_set.get(pk=member_id)
+    if member.user == project.owner:
+        return HttpResponseForbidden()
+
+    if request.POST:
+        member.delete()
+
+        return HttpResponseRedirect(reverse('sentry-manage-project', args=[project.pk]))
+
+    context = csrf(request)
+    context.update({
+        'member': member,
+        'project': project,
+    })
+
+    return render_to_response('sentry/projects/members/remove.html', context, request)
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index b0b8c95998..7e21b4abb6 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -62,6 +62,9 @@ urlpatterns = patterns('',
     url(r'^projects$', projects.project_list, name='sentry-project-list'),
     url(r'^projects/new$', projects.new_project, name='sentry-new-project'),
     url(r'^projects/(?P<project_id>\d+)/edit$', projects.manage_project, name='sentry-manage-project'),
+    url(r'^projects/(?P<project_id>\d+)/members/new$', projects.new_project_member, name='sentry-new-project-member'),
+    url(r'^projects/(?P<project_id>\d+)/members/(?P<member_id>\d+)/edit$', projects.edit_project_member, name='sentry-edit-project-member'),
+    url(r'^projects/(?P<project_id>\d+)/members/(?P<member_id>\d+)/remove$', projects.remove_project_member, name='sentry-remove-project-member'),
 
     # Global
 
