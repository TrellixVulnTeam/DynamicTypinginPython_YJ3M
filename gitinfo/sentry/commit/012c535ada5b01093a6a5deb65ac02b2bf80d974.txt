commit 012c535ada5b01093a6a5deb65ac02b2bf80d974
Author: Mike Fotinakis <mike@fotinakis.com>
Date:   Wed Jun 15 18:09:44 2016 -0700

    Initial Percy integration and acceptance tests.

diff --git a/setup.py b/setup.py
index e4e8366e4c..dbbcc16e6b 100755
--- a/setup.py
+++ b/setup.py
@@ -82,6 +82,7 @@ tests_require = [
     'pytest-xdist>=1.11.0,<1.12.0',
     'python-coveralls',
     'responses',
+    'percy>=0.2.4',
 ]
 
 
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 94ef3d15ac..d7a7d0b558 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -596,6 +596,10 @@ NOCAPTCHA = True
 
 CAPTCHA_WIDGET_TEMPLATE = "sentry/partial/form_captcha.html"
 
+# Percy config for visual regression testing.
+
+PERCY_DEFAULT_TESTING_WIDTHS = (1280, 375)
+
 # Debugger
 
 DEBUG_TOOLBAR_PANELS = (
diff --git a/src/sentry/testutils/cases.py b/src/sentry/testutils/cases.py
index 7d61634b97..83533c4234 100644
--- a/src/sentry/testutils/cases.py
+++ b/src/sentry/testutils/cases.py
@@ -15,7 +15,6 @@ __all__ = (
 
 import base64
 import os.path
-import signal
 import urllib
 from contextlib import contextmanager
 
@@ -27,9 +26,8 @@ from django.core.urlresolvers import reverse
 from django.http import HttpRequest
 from django.test import TestCase, TransactionTestCase, LiveServerTestCase
 from django.utils.importlib import import_module
-from exam import before, after, fixture, Exam
+from exam import before, fixture, Exam
 from rest_framework.test import APITestCase as BaseAPITestCase
-from selenium import webdriver
 
 from sentry import auth
 from sentry.auth.providers.dummy import DummyProvider
@@ -247,23 +245,7 @@ class TransactionTestCase(BaseTestCase, TransactionTestCase):
 
 
 class LiveServerTestCase(BaseTestCase, LiveServerTestCase):
-    @before
-    def setup_browser(self):
-        # NOTE: this relies on the phantomjs-prebuilt dependency in package.json.
-        phantomjs_path = os.path.join(
-            settings.NODE_MODULES_ROOT,
-            'phantomjs-prebuilt',
-            'bin',
-            'phantomjs',
-        )
-        self.browser = webdriver.PhantomJS(executable_path=phantomjs_path)
-
-    @after
-    def teardown_browser(self):
-        self.browser.close()
-        # TODO: remove this when fixed in: https://github.com/seleniumhq/selenium/issues/767
-        self.browser.service.process.send_signal(signal.SIGTERM)
-        self.browser.quit()
+    pass
 
 
 class APITestCase(BaseTestCase, BaseAPITestCase):
diff --git a/tests/acceptance/test_acceptance.py b/tests/acceptance/test_acceptance.py
new file mode 100644
index 0000000000..fb9b63c8b5
--- /dev/null
+++ b/tests/acceptance/test_acceptance.py
@@ -0,0 +1,86 @@
+import signal
+import urllib
+import os
+
+import percy
+from django.conf import settings
+from selenium import webdriver
+from sentry.testutils import LiveServerTestCase
+
+
+class AcceptanceTest(LiveServerTestCase):
+    # Use class setup/teardown to hold Selenium and Percy state across all acceptance tests.
+    # For Selenium, this is done for performance to re-use the same browser across tests.
+    # For Percy, this is done to call initialize and then finalize at the very end after all tests.
+    #
+    # TODO: if acceptance tests are split across files, this will need to be refactored into a
+    # pytest plugin/fixture or something else that can manage global state.
+    @classmethod
+    def setUpClass(cls):
+        super(AcceptanceTest, cls).setUpClass()
+
+        # Initialize Selenium.
+        # NOTE: this relies on the phantomjs binary packaged from npm to be in the right
+        # location in node_modules.
+        phantomjs_path = os.path.join(settings.NODE_MODULES_ROOT, 'phantomjs', 'bin', 'phantomjs')
+        cls.browser = webdriver.PhantomJS(executable_path=phantomjs_path)
+
+        # Initialize Percy.
+        loader = percy.ResourceLoader(
+            root_dir=settings.STATIC_ROOT,
+            base_url=urllib.quote(settings.STATIC_URL),
+            webdriver=cls.browser,
+        )
+        percy_config = percy.Config(default_widths=settings.PERCY_DEFAULT_TESTING_WIDTHS)
+        cls.percy = percy.Runner(loader=loader, config=percy_config)
+        cls.percy.initialize_build()
+
+    @classmethod
+    def tearDownClass(cls):
+        # Teardown Selenium.
+        cls.browser.close()
+        # TODO: remove this when fixed in: https://github.com/seleniumhq/selenium/issues/767
+        cls.browser.service.process.send_signal(signal.SIGTERM)
+        cls.browser.quit()
+
+        # Finalize Percy build.
+        cls.percy.finalize_build()
+
+        super(AcceptanceTest, cls).tearDownClass()
+
+    def setUp(self):
+        super(AcceptanceTest, self).setUp()
+        # For convenience, grab a reference to the class-level webdriver and percy objects.
+        self.browser = self.__class__.browser
+        self.percy = self.__class__.percy
+
+        # Clear cookies before every test. This helps avoid problems with login captchas.
+        self.browser.delete_all_cookies()
+
+    # Login helper.
+    def login(self, browser, username, password):
+        browser.get(self.live_server_url)
+        browser.find_element_by_id('id_username').send_keys(username)
+        browser.find_element_by_id('id_password').send_keys(password)
+        browser.find_element_by_xpath("//button[contains(text(), 'Login')]").click()
+
+    def test_auth_page(self):
+        self.browser.get(self.live_server_url)
+        self.percy.snapshot(name='login')
+
+    def test_auth_failures(self):
+        self.login(self.browser, '', '')
+        self.percy.snapshot(name='login fields required')
+
+        self.login(self.browser, 'bad-username', 'bad-username')
+        self.percy.snapshot(name='login fields invalid')
+
+    def test_new_organization(self):
+        email = 'dummy@example.com'
+        password = 'dummy'
+        user = self.create_user(email=email)
+        user.set_password(password)
+        user.save()
+
+        self.login(self.browser, email, password)
+        self.percy.snapshot()
diff --git a/tests/acceptance/test_static.py b/tests/acceptance/test_static.py
deleted file mode 100644
index 263f39f480..0000000000
--- a/tests/acceptance/test_static.py
+++ /dev/null
@@ -1,6 +0,0 @@
-from sentry.testutils import LiveServerTestCase
-
-
-class StaticAcceptanceTest(LiveServerTestCase):
-    def test_static(self):
-        self.browser.get(self.live_server_url)
