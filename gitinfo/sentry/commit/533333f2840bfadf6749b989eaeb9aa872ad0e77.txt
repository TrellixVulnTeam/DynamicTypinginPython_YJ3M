commit 533333f2840bfadf6749b989eaeb9aa872ad0e77
Author: Bruno Garcia <github@brunogarcia.com>
Date:   Wed Mar 13 16:25:53 2019 +0100

    feat(sentrypad): Cap breadcrumbs per the largest count (#12392)
    
    * feat: Cap breadcrumbs per the largest count

diff --git a/src/sentry/lang/native/minidump.py b/src/sentry/lang/native/minidump.py
index 3cdfa313d4..8d15cae705 100644
--- a/src/sentry/lang/native/minidump.py
+++ b/src/sentry/lang/native/minidump.py
@@ -145,6 +145,10 @@ def merge_attached_breadcrumbs(mpack_breadcrumbs, data):
                           if isinstance(c, dict) and c.get('timestamp') is not None), None)
     new_crumb = next((c for c in reversed(breadcrumbs) if isinstance(
         c, dict) and c.get('timestamp') is not None), None)
+
+    # cap the breadcrumbs to the highest count of either file
+    cap = max(len(current_crumbs), len(breadcrumbs))
+
     if current_crumb is not None and new_crumb is not None:
         if dp.parse(current_crumb['timestamp']) > dp.parse(new_crumb['timestamp']):
             data['breadcrumbs'] = breadcrumbs + current_crumbs
@@ -153,6 +157,8 @@ def merge_attached_breadcrumbs(mpack_breadcrumbs, data):
     else:
         data['breadcrumbs'] = current_crumbs + breadcrumbs
 
+    data['breadcrumbs'] = data['breadcrumbs'][-cap:]
+
 
 def is_valid_module_id(id):
     return id is not None and id != '000000000000000000000000000000000'
diff --git a/tests/sentry/lang/native/test_minidump.py b/tests/sentry/lang/native/test_minidump.py
index 7d9b6f95a2..8cd0837802 100644
--- a/tests/sentry/lang/native/test_minidump.py
+++ b/tests/sentry/lang/native/test_minidump.py
@@ -1125,20 +1125,58 @@ def test_merge_attached_breadcrumbs_timestamp_ordered():
     merge_attached_breadcrumbs(MockFile(mpack_crumb1), event)
     assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:02Z'
 
-    mpack_crumb2 = msgpack.packb({'timestamp': '0001-01-01T01:00:01Z'})
-    merge_attached_breadcrumbs(MockFile(mpack_crumb2), event)
+    crumbs_file2 = bytearray()
+    crumbs_file2.extend(msgpack.packb({'timestamp': '0001-01-01T01:00:01Z'}))
+    # File with 2 items to extend cap
+    crumbs_file2.extend(msgpack.packb({'timestamp': '0001-01-01T01:00:01Z'}))
+    merge_attached_breadcrumbs(MockFile(crumbs_file2), event)
     assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:01Z'
     assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:02Z'
 
     mpack_crumb3 = msgpack.packb({'timestamp': '0001-01-01T01:00:03Z'})
     merge_attached_breadcrumbs(MockFile(mpack_crumb3), event)
-    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:01Z'
-    assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:02Z'
-    assert event['breadcrumbs'][2]['timestamp'] == '0001-01-01T01:00:03Z'
+    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:02Z'
+    assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:03Z'
 
     mpack_crumb4 = msgpack.packb({'timestamp': '0001-01-01T01:00:00Z'})
     merge_attached_breadcrumbs(MockFile(mpack_crumb4), event)
-    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:00Z'
+    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:02Z'
+    assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:03Z'
+
+
+def test_merge_attached_breadcrumbs_capped():
+    # Crumbs are capped by the largest file
+    event = {}
+
+    crumbs_file1 = bytearray()
+    for i in range(0, 2):
+        crumbs_file1.extend(msgpack.packb({'timestamp': '0001-01-01T01:00:01Z'}))
+
+    merge_attached_breadcrumbs(MockFile(crumbs_file1), event)
+    assert len(event['breadcrumbs']) == 2
+    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:01Z'
     assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:01Z'
+
+    crumbs_file2 = bytearray()
+    for i in range(0, 3):
+        crumbs_file2.extend(msgpack.packb({'timestamp': '0001-01-01T01:00:02Z'}))
+
+    merge_attached_breadcrumbs(MockFile(crumbs_file2), event)
+    assert len(event['breadcrumbs']) == 3
+    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:02Z'
+    assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:02Z'
     assert event['breadcrumbs'][2]['timestamp'] == '0001-01-01T01:00:02Z'
-    assert event['breadcrumbs'][3]['timestamp'] == '0001-01-01T01:00:03Z'
+
+    crumbs_file3 = msgpack.packb({'timestamp': '0001-01-01T01:00:03Z'})
+    merge_attached_breadcrumbs(MockFile(crumbs_file3), event)
+    assert len(event['breadcrumbs']) == 3
+    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:02Z'
+    assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:02Z'
+    assert event['breadcrumbs'][2]['timestamp'] == '0001-01-01T01:00:03Z'
+
+    crumbs_file4 = msgpack.packb({'timestamp': '0001-01-01T01:00:04Z'})
+    merge_attached_breadcrumbs(MockFile(crumbs_file4), event)
+    assert len(event['breadcrumbs']) == 3
+    assert event['breadcrumbs'][0]['timestamp'] == '0001-01-01T01:00:02Z'
+    assert event['breadcrumbs'][1]['timestamp'] == '0001-01-01T01:00:03Z'
+    assert event['breadcrumbs'][2]['timestamp'] == '0001-01-01T01:00:04Z'
