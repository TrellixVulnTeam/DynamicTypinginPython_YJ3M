commit 67c5bde9c6964b8467ce787de1f4e5e1ebcfcdba
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jun 20 15:22:49 2019 -0700

    feat(api): Allow member creation without email invites

diff --git a/src/sentry/api/endpoints/organization_member_index.py b/src/sentry/api/endpoints/organization_member_index.py
index dc8325418a..d244d61a9a 100644
--- a/src/sentry/api/endpoints/organization_member_index.py
+++ b/src/sentry/api/endpoints/organization_member_index.py
@@ -35,6 +35,7 @@ class OrganizationMemberSerializer(serializers.Serializer):
     email = AllowedEmailField(max_length=75, required=True)
     role = serializers.ChoiceField(choices=roles.get_choices(), required=True)
     teams = ListField(required=False, allow_null=False)
+    sendInvite = serializers.BooleanField(required=False, default=True, write_only=True)
 
 
 class OrganizationMemberIndexEndpoint(OrganizationEndpoint):
@@ -165,7 +166,7 @@ class OrganizationMemberIndexEndpoint(OrganizationEndpoint):
             with TimedRetryPolicy(10)(lock.acquire):
                 self.save_team_assignments(om, teams)
 
-        if settings.SENTRY_ENABLE_INVITES:
+        if settings.SENTRY_ENABLE_INVITES and result.get('sendInvite'):
             om.send_invite_email()
             member_invited.send_robust(member=om, user=request.user, sender=self,
                                        referrer=request.DATA.get('referrer'))
diff --git a/tests/sentry/api/endpoints/test_organization_member_index.py b/tests/sentry/api/endpoints/test_organization_member_index.py
index 61db1ae40a..f55dea182f 100644
--- a/tests/sentry/api/endpoints/test_organization_member_index.py
+++ b/tests/sentry/api/endpoints/test_organization_member_index.py
@@ -353,6 +353,7 @@ class OrganizationMemberListPostTest(APITestCase):
         )
         assert resp.status_code == 201
         om = OrganizationMember.objects.get(id=resp.data['id'])
+        assert om.user_id is None
         assert om.email == 'jane@gmail.com'
         assert om.role == 'member'
         assert list(om.teams.all()) == [self.team]
@@ -367,6 +368,25 @@ class OrganizationMemberListPostTest(APITestCase):
         )
         assert resp.status_code == 201
         om = OrganizationMember.objects.get(id=resp.data['id'])
+        assert om.user_id is None
         assert om.email == 'jane@gmail.com'
         assert om.role == 'member'
         assert list(om.teams.all()) == []
+
+    @patch.object(OrganizationMember, 'send_invite_email')
+    def test_no_email(self, mock_send_invite_email):
+        resp = self.get_response(
+            self.org.slug,
+            email='jane@gmail.com',
+            role='member',
+            teams=[self.team.slug],
+            sendInvite=False,
+        )
+        assert resp.status_code == 201
+        om = OrganizationMember.objects.get(id=resp.data['id'])
+        assert om.user_id is None
+        assert om.email == 'jane@gmail.com'
+        assert om.role == 'member'
+        assert list(om.teams.all()) == [self.team]
+
+        assert not mock_send_invite_email.mock_calls
