commit 3817a76324627dbf3a373d59bbc57ad2d9530cce
Author: Mark Story <mark@sentry.io>
Date:   Wed Jul 24 10:14:11 2019 -0400

    fix(azure) Display better error when adding webhooks fails (#14119)
    
    Some users don't have permission to add webhooks to their organizations.
    Show them a more helpful error page so they can resolve this problem on
    their own.
    
    Fixes SEN-445
    Fixes SENTRY-8J9

diff --git a/src/sentry/integrations/vsts/integration.py b/src/sentry/integrations/vsts/integration.py
index 67ee7eb620..2beeb38c16 100644
--- a/src/sentry/integrations/vsts/integration.py
+++ b/src/sentry/integrations/vsts/integration.py
@@ -393,11 +393,13 @@ class VstsIntegrationProvider(IntegrationProvider):
             subscription, shared_secret = webhook.create_subscription(
                 instance, oauth_data, self.oauth_redirect_url)
         except ApiError as e:
-            if e.code != 400 or 'permission' not in e.message:
-                raise e
-            raise IntegrationError(
-                'You do not have sufficent account access to create an integration.\nPlease check with the owner of this Azure DevOps account.'
-            )
+            if e.code == 400 or e.code == 403 or 'permission' in e.message:
+                raise IntegrationError(
+                    'You do not have sufficient account access to create webhooks '
+                    'on the selected Azure DevOps organization.\n'
+                    'Please check with the owner of this Azure DevOps account.'
+                )
+            raise e
 
         subscription_id = subscription['id']
         return subscription_id, shared_secret
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index 44ea728f1e..81e7467508 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -1,5 +1,8 @@
 from __future__ import absolute_import
 
+import pytest
+import six
+import responses
 from mock import patch, Mock
 
 from sentry.identity.vsts import VSTSIdentityProvider
@@ -165,6 +168,43 @@ class VstsIntegrationProviderTest(VstsIntegrationTestCase):
         assert integration_dict['user_identity']['scopes'] == sorted(
             VSTSIdentityProvider.oauth_scopes)
 
+    def test_build_integration__create_subscription_error(self):
+        responses.replace(
+            responses.POST,
+            u'https://{}.visualstudio.com/_apis/hooks/subscriptions'.format(
+                self.vsts_account_name.lower(),
+            ),
+            status=403,
+            json={
+                '$id': 1,
+                'message': 'The user bob is not authorized to access this resource',
+                'typeKey': 'UnauthorizedRequestException',
+                'errorCode': 0,
+                'eventId': 3000
+            }
+        )
+        state = {
+            'account': {
+                'accountName': self.vsts_account_name,
+                'accountId': self.vsts_account_id,
+            },
+            'base_url': self.vsts_base_url,
+            'identity': {
+                'data': {
+                    'access_token': self.access_token,
+                    'expires_in': '3600',
+                    'refresh_token': self.refresh_token,
+                    'token_type': 'jwt-bearer',
+                },
+            },
+        }
+
+        integration = VstsIntegrationProvider()
+
+        with pytest.raises(IntegrationError) as err:
+            integration.build_integration(state)
+        assert 'sufficient account access to create webhooks' in six.text_type(err)
+
     def test_webhook_subscription_created_once(self):
         self.assert_installation()
 
