commit 2de041f63db39aac916daddae8ccc665346141fd
Author: evanh <evanh@users.noreply.github.com>
Date:   Thu Dec 5 13:28:49 2019 -0800

    Fix for legacy browser filter changes in audit logs (#15943)
    
    Fixes ISSUE-590
    
    The value that was saved to audit logs can be a few different types depending on
    which filter is used, with legacy browser filters having a few different states.
    Change the save functionality to save better values in audit logs going forward
    and change the audit log display function to handle all the possible values.
    
    /cc @markstory @wmak

diff --git a/src/sentry/api/endpoints/project_filter_details.py b/src/sentry/api/endpoints/project_filter_details.py
index a671c9318b..48a04ff4a7 100644
--- a/src/sentry/api/endpoints/project_filter_details.py
+++ b/src/sentry/api/endpoints/project_filter_details.py
@@ -6,7 +6,6 @@ from sentry import message_filters
 from sentry.api.bases.project import ProjectEndpoint
 from sentry.api.exceptions import ResourceDoesNotExist
 from sentry.models.auditlogentry import AuditLogEntryEvent
-import six
 
 
 class ProjectFilterDetailsEndpoint(ProjectEndpoint):
@@ -38,16 +37,10 @@ class ProjectFilterDetailsEndpoint(ProjectEndpoint):
         audit_log_state = AuditLogEntryEvent.PROJECT_ENABLE
 
         if filter_id == "legacy-browsers":
-            if (
-                isinstance(current_state, bool)
-                or new_state == 0
-                or isinstance(new_state, six.binary_type)
-            ):
+            if isinstance(current_state, bool) or isinstance(new_state, bool):
                 returned_state = new_state
-
-                if isinstance(new_state, six.binary_type):
+                if not new_state:
                     audit_log_state = AuditLogEntryEvent.PROJECT_DISABLE
-                    returned_state = current_state
 
             elif current_state - new_state:
                 returned_state = current_state - new_state
diff --git a/src/sentry/message_filters.py b/src/sentry/message_filters.py
index e930808dd9..09f1831ddd 100644
--- a/src/sentry/message_filters.py
+++ b/src/sentry/message_filters.py
@@ -72,7 +72,7 @@ def set_filter_state(filter_id, project, state):
             project=project, key=u"filters:{}".format(filter_id), value=option_val
         )
 
-        return option_val
+        return option_val == "1" if option_val in ("0", "1") else option_val
 
     else:
         # all boolean filters
diff --git a/src/sentry/models/auditlogentry.py b/src/sentry/models/auditlogentry.py
index dc61ec515d..dc6e9ceb2c 100644
--- a/src/sentry/models/auditlogentry.py
+++ b/src/sentry/models/auditlogentry.py
@@ -279,14 +279,22 @@ class AuditLogEntry(Model):
             return "requested to transfer project %s" % (self.data["slug"],)
         elif self.event == AuditLogEntryEvent.PROJECT_ACCEPT_TRANSFER:
             return "accepted transfer of project %s" % (self.data["slug"],)
-        elif self.event == AuditLogEntryEvent.PROJECT_ENABLE:
-            if isinstance(self.data["state"], set):
-                return "enabled project filter %s" % (self.data["state"],)
-            return "enabled project filter %s" % (", ".join(self.data["state"]),)
-        elif self.event == AuditLogEntryEvent.PROJECT_DISABLE:
-            if isinstance(self.data["state"], set):
-                return "disabled project filter %s" % (self.data["state"],)
-            return "disabled project filter %s" % (", ".join(self.data["state"]),)
+        elif self.event in [AuditLogEntryEvent.PROJECT_ENABLE, AuditLogEntryEvent.PROJECT_DISABLE]:
+            verb = "enabled" if self.event == AuditLogEntryEvent.PROJECT_ENABLE else "disabled"
+
+            # Most logs will just be name of the filter, but legacy browser changes can be bool, str or sets
+            filter_name = self.data["state"]
+            if (
+                filter_name in ("0", "1")
+                or isinstance(filter_name, set)
+                or isinstance(filter_name, bool)
+            ):
+                message = "%s project filter legacy-browsers" % (verb,)
+                if isinstance(filter_name, set):
+                    message += ": %s" % (", ".join(filter_name),)
+                return message
+            else:
+                return "%s project filter %s" % (verb, filter_name)
 
         elif self.event == AuditLogEntryEvent.TAGKEY_REMOVE:
             return "removed tags matching %s = *" % (self.data["key"],)
