commit db7fd5299d32494e9239789392ea28453d45fa2e
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Sep 26 18:26:06 2017 -0700

    fix(slack): Correct verification integrity check

diff --git a/src/sentry/integrations/slack/event_endpoint.py b/src/sentry/integrations/slack/event_endpoint.py
index aa1e1d8ae2..e71411597e 100644
--- a/src/sentry/integrations/slack/event_endpoint.py
+++ b/src/sentry/integrations/slack/event_endpoint.py
@@ -55,7 +55,7 @@ class SlackEventEndpoint(Endpoint):
         url_list[4] = urlencode(query, doseq=True)
         return urlunparse(url_list)
 
-    def on_url_verification(self, request, integration, data):
+    def on_url_verification(self, request, data):
         return self.respond({
             'challenge': data['challenge'],
         })
@@ -133,6 +133,10 @@ class SlackEventEndpoint(Endpoint):
         if token != options.get('slack.verification-token'):
             logger.error('slack.event.invalid-token', extra=logging_data)
             return self.respond(status=400)
+        payload_type = data.get('type')
+        logger.info('slack.event.{}'.format(payload_type), extra=logging_data)
+        if payload_type == 'url_verification':
+            return self.on_url_verification(request, data)
 
         try:
             integration = Integration.objects.get(
@@ -145,11 +149,6 @@ class SlackEventEndpoint(Endpoint):
 
         logging_data['integration_id'] = integration.id
 
-        payload_type = data.get('type')
-        logger.info('slack.event.{}'.format(payload_type), extra=logging_data)
-        if payload_type == 'url_verification':
-            return self.on_url_verification(request, integration, data)
-
         event_data = data.get('event')
         if not event_data:
             logger.error('slack.event.invalid-event-data', extra=logging_data)
diff --git a/tests/sentry/integrations/slack/test_event_endpoint.py b/tests/sentry/integrations/slack/test_event_endpoint.py
index 5f32be241c..93ba4a90dd 100644
--- a/tests/sentry/integrations/slack/test_event_endpoint.py
+++ b/tests/sentry/integrations/slack/test_event_endpoint.py
@@ -84,18 +84,25 @@ class UrlVerificationEventTest(BaseEventTest):
     challenge = '3eZbrw1aBm2rZgRNFdxV2595E9CY3gmdALWMmHkvFXO7tYXAYM8P'
 
     def test_valid_token(self):
-        resp = self.post_webhook(
-            type='url_verification',
-            data={'challenge': self.challenge},
+        resp = self.client.post(
+            '/extensions/slack/event/',
+            {
+                'type': 'url_verification',
+                'challenge': self.challenge,
+                'token': options.get('slack.verification-token'),
+            }
         )
         assert resp.status_code == 200, resp.content
         assert resp.data['challenge'] == self.challenge
 
     def test_invalid_token(self):
-        resp = self.post_webhook(
-            type='url_verification',
-            data={'challenge': self.challenge},
-            token='fizzbuzz',
+        resp = self.client.post(
+            '/extensions/slack/event/',
+            {
+                'type': 'url_verification',
+                'challenge': self.challenge,
+                'token': 'fizzbuzz',
+            }
         )
         assert resp.status_code == 400, resp.content
 
