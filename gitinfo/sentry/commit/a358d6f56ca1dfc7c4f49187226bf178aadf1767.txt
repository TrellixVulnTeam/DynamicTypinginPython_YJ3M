commit a358d6f56ca1dfc7c4f49187226bf178aadf1767
Author: Ben Vinegar <ben@benv.ca>
Date:   Wed May 25 11:14:45 2016 -0700

    Add UserOption#is_user_subscribed_to_mail_alerts

diff --git a/src/sentry/models/useroption.py b/src/sentry/models/useroption.py
index 423bb13e3d..de3119276e 100644
--- a/src/sentry/models/useroption.py
+++ b/src/sentry/models/useroption.py
@@ -119,3 +119,14 @@ class UserOption(Model):
         unique_together = (('user', 'project', 'key',),)
 
     __repr__ = sane_repr('user_id', 'project_id', 'key', 'value')
+
+    @classmethod
+    def is_user_subscribed_to_mail_alerts(cls, user, project):
+        is_enabled = cls.objects.get_value(
+            user, project, 'mail:alert', None)
+        if is_enabled is None:
+            is_enabled = cls.objects.get_value(
+                user, None, 'subscribe_by_default', '1') == '1'
+        else:
+            is_enabled = bool(is_enabled)
+        return is_enabled
diff --git a/src/sentry/templates/sentry/project-notifications.html b/src/sentry/templates/sentry/project-notifications.html
index 7451ce026d..323077f48f 100644
--- a/src/sentry/templates/sentry/project-notifications.html
+++ b/src/sentry/templates/sentry/project-notifications.html
@@ -13,6 +13,15 @@
     {% csrf_token %}
     <input type="hidden" name="op" value="save-settings" />
 
+    {% if not is_user_subbed %}
+    <div class="box" style="border:0">
+      <div class="alert">
+        {% url 'sentry-account-settings-notifications' as account_notification_url %}
+        <p>You are currently not subscribed to this project. To subscribe, go to <a href="{{ account_notification_url }}">Account Notifications</a>.</p>
+      </div>
+    </div>
+    {% endif %}
+
     <div class="box">
       <div class="box-header">
         <h3>{% trans "Rules" %}</h3>
@@ -21,10 +30,6 @@
         {% url 'sentry-project-rules' organization.slug project.slug as link %}
         <p>{% blocktrans %}Sentry will notify users subscribed to this project based on the <a href="{{ link }}">rules configured for this project</a>.{% endblocktrans %}</p>
 
-        {% if not is_user_subbed %}
-        {% url 'sentry-account-settings-notifications' as account_notification_url %}
-        <p style="font-style:italic">You are currently not subscribed to this project. To subscribe, go to <a href="{{ account_notification_url }}">Account Notifications</a>.</p>
-        {% endif %}
       </div>
     </div>
 
diff --git a/src/sentry/web/forms/accounts.py b/src/sentry/web/forms/accounts.py
index eca7ba8cc7..d3e0280fb0 100644
--- a/src/sentry/web/forms/accounts.py
+++ b/src/sentry/web/forms/accounts.py
@@ -388,13 +388,7 @@ class ProjectEmailOptionsForm(forms.Form):
 
         super(ProjectEmailOptionsForm, self).__init__(*args, **kwargs)
 
-        is_enabled = UserOption.objects.get_value(
-            user, project, 'mail:alert', None)
-        if is_enabled is None:
-            is_enabled = UserOption.objects.get_value(
-                user, None, 'subscribe_by_default', '1') == '1'
-        else:
-            is_enabled = bool(is_enabled)
+        is_enabled = UserOption.is_user_subscribed_to_mail_alerts(user, project)
 
         self.fields['alert'].initial = is_enabled
         self.fields['email'].initial = UserOption.objects.get_value(
diff --git a/src/sentry/web/frontend/project_notifications.py b/src/sentry/web/frontend/project_notifications.py
index 3697e5f639..03fe08e79f 100644
--- a/src/sentry/web/frontend/project_notifications.py
+++ b/src/sentry/web/frontend/project_notifications.py
@@ -47,14 +47,6 @@ class ProjectNotificationsView(ProjectView):
         )
 
     def handle(self, request, organization, team, project):
-        is_user_subbed = UserOption.objects.get_value(
-            request.user, project, 'mail:alert', None)
-        if is_user_subbed is None:
-            is_user_subbed = UserOption.objects.get_value(
-                request.user, None, 'subscribe_by_default', '1') == '1'
-        else:
-            is_user_subbed = bool(is_user_subbed)
-
         op = request.POST.get('op')
         if op == 'enable':
             self._handle_enable_plugin(request, project)
@@ -148,6 +140,8 @@ class ProjectNotificationsView(ProjectView):
             elif plugin.can_configure_for_project(project):
                 other_plugins.append(plugin)
 
+        is_user_subbed = UserOption.is_user_subscribed_to_mail_alerts(request.user, project)
+
         context = {
             'page': 'notifications',
             'enabled_plugins': enabled_plugins,
