commit 6415513131e5a65104d5af77b3e6684828d42e3f
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu Jul 21 18:14:48 2016 +0500

    Handle already being enrolled to 2fa nicer

diff --git a/src/sentry/models/authenticator.py b/src/sentry/models/authenticator.py
index 039dda79ea..1971b2c923 100644
--- a/src/sentry/models/authenticator.py
+++ b/src/sentry/models/authenticator.py
@@ -243,7 +243,7 @@ class AuthenticatorInterface(object):
             )
         else:
             if not self.allow_multi_enrollment:
-                raise RuntimeError('Already enrolled')
+                raise Authenticator.AlreadyEnrolled()
             self.authenticator.config = self.config
             self.authenticator.save()
 
@@ -554,6 +554,9 @@ class Authenticator(BaseModel):
 
     objects = AuthenticatorManager()
 
+    class AlreadyEnrolled(Exception):
+        pass
+
     class Meta:
         app_label = 'sentry'
         db_table = 'auth_authenticator'
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index 19cd39e57f..f5ebc0c9b3 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -105,9 +105,16 @@ class TwoFactorSettingsView(BaseView):
         if not insecure \
            or (interface.is_backup_interface and
                Authenticator.objects.user_has_2fa(request.user)):
-            interface.enroll(request.user)
-            if Authenticator.objects.auto_add_recovery_codes(request.user):
-                next = reverse('sentry-account-settings-2fa-recovery')
+            try:
+                interface.enroll(request.user)
+            except Authenticator.AlreadyEnrolled:
+                # This can happen in some cases when races occur.  We have
+                # seen this when people press the submit button twice.  In
+                # that case just go to the overview page of 2fa
+                next = reverse('sentry-account-settings-2fa')
+            else:
+                if Authenticator.objects.auto_add_recovery_codes(request.user):
+                    next = reverse('sentry-account-settings-2fa-recovery')
         return HttpResponseRedirect(next)
 
     def configure(self, request, interface):
