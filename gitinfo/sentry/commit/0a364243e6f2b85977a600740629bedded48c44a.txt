commit 0a364243e6f2b85977a600740629bedded48c44a
Author: ted kaemming <t.kaemming+github@gmail.com>
Date:   Wed Oct 12 15:43:49 2016 -0700

    Update release notification emails. (#4343)

diff --git a/src/sentry/models/groupsubscription.py b/src/sentry/models/groupsubscription.py
index 2c93b867bb..905d440211 100644
--- a/src/sentry/models/groupsubscription.py
+++ b/src/sentry/models/groupsubscription.py
@@ -12,7 +12,9 @@ from sentry.db.models import (
 
 
 class GroupSubscriptionReason(object):
-    implicit = -1  # not for use as a persisted field value
+    committed = -2  # not for use as a persisted field value
+    implicit = -1   # not for use as a persisted field value
+
     unknown = 0
     comment = 1
     assigned = 2
@@ -22,6 +24,7 @@ class GroupSubscriptionReason(object):
     descriptions = {
         implicit: u"have opted to receive updates for all issues within "
                   "projects that you are a member of",
+        committed: u"were involved in a commit that is part of this release",
         comment: u"have commented on this issue",
         assigned: u"have been assigned to this issue",
         bookmark: u"have bookmarked this issue",
diff --git a/src/sentry/plugins/sentry_mail/activity/release.py b/src/sentry/plugins/sentry_mail/activity/release.py
index 6be666d836..d6186eef63 100644
--- a/src/sentry/plugins/sentry_mail/activity/release.py
+++ b/src/sentry/plugins/sentry_mail/activity/release.py
@@ -1,7 +1,7 @@
 from __future__ import absolute_import
 
 from sentry.db.models.query import in_iexact
-from sentry.models import Release, ReleaseCommit, User
+from sentry.models import GroupSubscriptionReason, Release, ReleaseCommit, User
 
 from .base import ActivityEmail
 
@@ -37,16 +37,20 @@ class ReleaseActivityEmail(ActivityEmail):
         ])
 
         if not email_list:
-            return set()
+            return {}
 
         # identify members which have been seen in the commit log and have
         # verified the matching email address
-        return set(User.objects.filter(
-            in_iexact('emails__email', email_list),
-            emails__is_verified=True,
-            sentry_orgmember_set__teams=project.team,
-            is_active=True,
-        ).distinct())
+        return {
+            user: GroupSubscriptionReason.committed
+            for user in
+            User.objects.filter(
+                in_iexact('emails__email', email_list),
+                emails__is_verified=True,
+                sentry_orgmember_set__teams=project.team,
+                is_active=True,
+            ).distinct()
+        }
 
     def get_context(self):
         return {
diff --git a/src/sentry/templates/sentry/debug/mail/preview.html b/src/sentry/templates/sentry/debug/mail/preview.html
index 99ba0525bc..f92bc956f5 100644
--- a/src/sentry/templates/sentry/debug/mail/preview.html
+++ b/src/sentry/templates/sentry/debug/mail/preview.html
@@ -8,7 +8,7 @@
         <option value="mail/assigned/">Assigned</option>
         <option value="mail/assigned/self/">Assigned (Self)</option>
         <option value="mail/note/">Note</option>
-        <option value="mail/release/">Release</option>
+        <option value="mail/new-release/">Release</option>
         <option value="mail/regression/">Regression</option>
         <option value="mail/regression/release/">Regression (w/ Release)</option>
         <option value="mail/resolved/">Resolved</option>
diff --git a/src/sentry/templates/sentry/emails/activity/generic.html b/src/sentry/templates/sentry/emails/activity/generic.html
index 0b3986b7a4..0b492e44cc 100644
--- a/src/sentry/templates/sentry/emails/activity/generic.html
+++ b/src/sentry/templates/sentry/emails/activity/generic.html
@@ -20,7 +20,9 @@
 
   {% endblock %}
 
-  {% include "sentry/emails/group_header.html" %}
+  {% if group %}
+    {% include "sentry/emails/group_header.html" %}
+  {% endif %}
 
   {% if reason %}
     <p class="via">
diff --git a/src/sentry/templates/sentry/emails/activity/release.html b/src/sentry/templates/sentry/emails/activity/release.html
index d91735fbd9..cb665401a7 100644
--- a/src/sentry/templates/sentry/emails/activity/release.html
+++ b/src/sentry/templates/sentry/emails/activity/release.html
@@ -1,13 +1,12 @@
-{% extends "sentry/emails/base.html" %}
+{% extends "sentry/emails/activity/generic.html" %}
 
 {% load sentry_helpers %}
 
-{% block header %}
+{% block action %}
     <a href="{{ release_link }}" class="btn">View Release</a>
-    {{ block.super }}
 {% endblock %}
 
-{% block main %}
+{% block activity %}
     <h2>
         Version {{ release.short_version }}
     </h2>
diff --git a/src/sentry/web/frontend/debug/debug_new_release_email.py b/src/sentry/web/frontend/debug/debug_new_release_email.py
index 187ff52286..82cd15573f 100644
--- a/src/sentry/web/frontend/debug/debug_new_release_email.py
+++ b/src/sentry/web/frontend/debug/debug_new_release_email.py
@@ -1,9 +1,13 @@
 from __future__ import absolute_import
 
+from datetime import datetime
+
+import pytz
 from django.views.generic import View
 
 from sentry.models import (
-    Commit, CommitAuthor, Organization, Team, Project, Release
+    Commit, CommitAuthor, GroupSubscriptionReason, Organization, Project,
+    Release, Team
 )
 from sentry.utils.http import absolute_uri
 
@@ -33,6 +37,7 @@ class DebugNewReleaseEmailView(View):
         release = Release(
             project=project,
             version='6c998f755f304593a4713abd123eaf8833a2de5e',
+            date_added=datetime(2016, 10, 12, 15, 39, tzinfo=pytz.utc)
         )
 
         release_link = absolute_uri('/{}/{}/releases/{}/'.format(
@@ -67,5 +72,8 @@ class DebugNewReleaseEmailView(View):
                 'release_link': release_link,
                 'project_link': project_link,
                 'commit_list': commit_list,
+                'reason': GroupSubscriptionReason.descriptions[
+                    GroupSubscriptionReason.committed
+                ],
             },
         ).render(request)
diff --git a/tests/sentry/plugins/mail/activity/test_release.py b/tests/sentry/plugins/mail/activity/test_release.py
index 39ccf80200..cf7d51a1bb 100644
--- a/tests/sentry/plugins/mail/activity/test_release.py
+++ b/tests/sentry/plugins/mail/activity/test_release.py
@@ -4,9 +4,10 @@ from __future__ import absolute_import
 
 from django.core import mail
 from django.utils import timezone
+
 from sentry.models import (
-    Activity, Commit, CommitAuthor, Release, ReleaseCommit, Repository,
-    UserEmail
+    Activity, Commit, CommitAuthor, GroupSubscriptionReason, Release,
+    ReleaseCommit, Repository, UserEmail
 )
 from sentry.plugins.sentry_mail.activity.release import ReleaseActivityEmail
 from sentry.testutils import TestCase
@@ -89,7 +90,9 @@ class ReleaseTestCase(TestCase):
             )
         )
 
-        assert email.get_participants() == set([self.user])
+        assert email.get_participants() == {
+            self.user: GroupSubscriptionReason.committed,
+        }
 
         context = email.get_context()
         assert context['commit_list'] == [self.commit, self.commit2]
