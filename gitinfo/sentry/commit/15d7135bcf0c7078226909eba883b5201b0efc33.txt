commit 15d7135bcf0c7078226909eba883b5201b0efc33
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 17 23:01:41 2013 -0800

    Bring context_line check back and correct fetch_source tests

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index a240dd8451..e9bcbd738e 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -133,7 +133,8 @@ def fetch_javascript_source(event, **kwargs):
     frames = [f for f in stacktrace['frames']
         if f.get('lineno') is not None
             and f.get('colno') is not None
-            and f.get('abs_path', '').startswith(('http://', 'https://'))]
+            and f.get('abs_path', '').startswith(('http://', 'https://'))
+            and f.get('context_line') is None]
     if not frames:
         logger.info('Event %r has no frames with enough context to fetch remote source', event.id)
         return
@@ -187,6 +188,7 @@ def fetch_javascript_source(event, **kwargs):
             except KeyError:
                 pass
             else:
+                # SourceMap's return zero-indexed lineno's
                 frame['lineno'] = state.src_line + 1
                 frame['colno'] = state.src_col
                 frame['name'] = state.name
diff --git a/tests/sentry/tasks/fetch_source/tests.py b/tests/sentry/tasks/fetch_source/tests.py
index 00da1d026c..40ea7bc751 100644
--- a/tests/sentry/tasks/fetch_source/tests.py
+++ b/tests/sentry/tasks/fetch_source/tests.py
@@ -46,11 +46,11 @@ class StoreEventTest(TestCase):
 
         frame_list = event.data['sentry.interfaces.Stacktrace']['frames']
         frame = frame_list[0]
-        assert frame['pre_context'] == ['h', 'e', 'l', 'l']
-        assert frame['context_line'] == 'o'
-        assert frame['post_context'] == [' ', 'w', 'o', 'r', 'l']
+        assert frame['pre_context'] == ['h', 'e', 'l']
+        assert frame['context_line'] == 'l'
+        assert frame['post_context'] == ['o', ' ', 'w', 'o', 'r']
 
         frame = frame_list[1]
-        assert frame['pre_context'] == ['h']
-        assert frame['context_line'] == 'e'
-        assert frame['post_context'] == ['l', 'l', 'o', ' ', 'w']
+        assert frame['pre_context'] == []
+        assert frame['context_line'] == 'h'
+        assert frame['post_context'] == ['e', 'l', 'l', 'o', ' ']
