commit 4327f191d4e8f424892a76ccc4778a52c73bd416
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Nov 21 09:58:47 2019 -0800

    feat(discover): Add prototype impact score

diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index 6875506d63..2afd5ab028 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -684,6 +684,16 @@ FIELD_ALIASES = {
     # Long term these will become more complex functions but these are
     # field aliases.
     "apdex": {"result_type": "number", "aggregations": [["apdex(duration, 300)", "", "apdex"]]},
+    "impact": {
+        "result_type": "number",
+        "aggregations": [
+            [
+                "(1 - ((countIf(duration < 300) + (countIf((duration > 300) AND (duration < 1200)) / 2)) / count())) + ((1 - 1 / sqrt(uniq(user))) * 3)",
+                "",
+                "impact",
+            ]
+        ],
+    },
     "p75": {
         "result_type": "duration",
         "aggregations": [["quantile(0.75)(duration)", "", "p75"]],
diff --git a/src/sentry/static/sentry/app/views/eventsV2/data.tsx b/src/sentry/static/sentry/app/views/eventsV2/data.tsx
index e227efbea6..2f88d23e12 100644
--- a/src/sentry/static/sentry/app/views/eventsV2/data.tsx
+++ b/src/sentry/static/sentry/app/views/eventsV2/data.tsx
@@ -21,9 +21,10 @@ import {generateEventDetailsRoute, generateEventSlug} from './eventDetails/utils
 export const PIN_ICON = `image://${pinIcon}`;
 export const AGGREGATE_ALIASES = [
   'apdex',
-  'p99',
-  'p95',
+  'impact',
   'p75',
+  'p95',
+  'p99',
   'last_seen',
   'latest_event',
 ] as const;
diff --git a/src/sentry/static/sentry/app/views/eventsV2/eventQueryParams.tsx b/src/sentry/static/sentry/app/views/eventsV2/eventQueryParams.tsx
index eb2971f747..13c6817ff3 100644
--- a/src/sentry/static/sentry/app/views/eventsV2/eventQueryParams.tsx
+++ b/src/sentry/static/sentry/app/views/eventsV2/eventQueryParams.tsx
@@ -141,7 +141,7 @@ export const FIELDS: {[key: string]: ColumnValueType} = {
   'transaction.duration': 'duration',
   'transaction.op': 'string',
   apdex: 'number',
-
+  impact: 'number',
   // duration aliases
   p75: 'duration',
   p95: 'duration',
@@ -156,6 +156,7 @@ export const TRACING_FIELDS = [
   'transaction.duration',
   'transaction.op',
   'apdex',
+  'impact',
   'p99',
   'p95',
   'p75',
diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index 6870823bc3..83a3f21ca6 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -336,7 +336,13 @@ def detect_dataset(query_args, aliased_conditions=False):
             if is_transaction:
                 return Dataset.Transactions
         # Check for transaction only field aliases
-        if isinstance(field[2], six.string_types) and field[2] in ("apdex", "p95", "p75", "p99"):
+        if isinstance(field[2], six.string_types) and field[2] in (
+            "apdex",
+            "impact",
+            "p75",
+            "p95",
+            "p99",
+        ):
             return Dataset.Transactions
 
     for field in query_args.get("groupby") or []:
diff --git a/tests/sentry/api/test_event_search.py b/tests/sentry/api/test_event_search.py
index 1c76ac8978..630b720d28 100644
--- a/tests/sentry/api/test_event_search.py
+++ b/tests/sentry/api/test_event_search.py
@@ -1036,12 +1036,17 @@ class ResolveFieldListTest(unittest.TestCase):
         assert result["groupby"] == ["title"]
 
     def test_field_alias_duration_expansion(self):
-        fields = ["avg(transaction.duration)", "apdex", "p75", "p95", "p99"]
+        fields = ["avg(transaction.duration)", "apdex", "impact", "p75", "p95", "p99"]
         result = resolve_field_list(fields, {})
         assert result["selected_columns"] == []
         assert result["aggregations"] == [
             ["avg", "transaction.duration", "avg_transaction_duration"],
             ["apdex(duration, 300)", "", "apdex"],
+            [
+                "(1 - ((countIf(duration < 300) + (countIf((duration > 300) AND (duration < 1200)) / 2)) / count())) + ((1 - 1 / sqrt(uniq(user))) * 3)",
+                "",
+                "impact",
+            ],
             ["quantile(0.75)(duration)", "", "p75"],
             ["quantile(0.95)(duration)", "", "p95"],
             ["quantile(0.99)(duration)", "", "p99"],
