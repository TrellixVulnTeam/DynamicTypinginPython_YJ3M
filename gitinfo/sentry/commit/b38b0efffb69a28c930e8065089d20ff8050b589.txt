commit b38b0efffb69a28c930e8065089d20ff8050b589
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Tue Oct 31 15:08:49 2017 -0500

    fix: Allow and prefer top-level 'transaction' key over 'culprit' (#6486)

diff --git a/src/sentry/constants.py b/src/sentry/constants.py
index 914c4a9fad..5dda39cb5a 100644
--- a/src/sentry/constants.py
+++ b/src/sentry/constants.py
@@ -143,7 +143,7 @@ HTTP_METHODS = ('GET', 'POST', 'PUT', 'OPTIONS', 'HEAD',
 CLIENT_RESERVED_ATTRS = (
     'project', 'errors', 'event_id', 'message', 'checksum', 'culprit', 'fingerprint', 'level',
     'time_spent', 'logger', 'server_name', 'site', 'received', 'timestamp', 'extra', 'modules',
-    'tags', 'platform', 'release', 'dist', 'environment',
+    'tags', 'platform', 'release', 'dist', 'environment', 'transaction',
 )
 
 # XXX: Must be all lowercase
diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index addd85426b..5b82c4ab46 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -282,6 +282,7 @@ class EventManager(object):
             data['event_id'] = uuid4().hex
 
         data.setdefault('culprit', None)
+        data.setdefault('transaction', None)
         data.setdefault('server_name', None)
         data.setdefault('site', None)
         data.setdefault('checksum', None)
@@ -401,6 +402,9 @@ class EventManager(object):
         if data['culprit']:
             data['culprit'] = trim(data['culprit'], MAX_CULPRIT_LENGTH)
 
+        if data['transaction']:
+            data['transaction'] = trim(data['transaction'], MAX_CULPRIT_LENGTH)
+
         return data
 
     def save(self, project, raw=False):
@@ -414,7 +418,9 @@ class EventManager(object):
         event_id = data.pop('event_id')
         level = data.pop('level')
 
-        culprit = data.pop('culprit', None)
+        culprit = data.pop('transaction', None)
+        if not culprit:
+            culprit = data.pop('culprit', None)
         logger_name = data.pop('logger', None)
         server_name = data.pop('server_name', None)
         site = data.pop('site', None)
diff --git a/tests/sentry/test_event_manager.py b/tests/sentry/test_event_manager.py
index cf26ffd33a..616476cb82 100644
--- a/tests/sentry/test_event_manager.py
+++ b/tests/sentry/test_event_manager.py
@@ -51,6 +51,17 @@ class EventManagerTest(TransactionTestCase):
 
         assert event1.group_id != event2.group_id
 
+    def test_transaction_over_culprit(self):
+        manager = EventManager(self.make_event(
+            culprit='foo',
+            transaction='bar'
+        ))
+        manager.normalize()
+        event1 = manager.save(1)
+
+        assert event1.transaction == 'bar'
+        assert event1.culprit == 'bar'
+
     @patch('sentry.signals.regression_signal.send')
     def test_broken_regression_signal(self, send):
         send.side_effect = Exception()
@@ -461,6 +472,13 @@ class EventManagerTest(TransactionTestCase):
         data = manager.normalize()
         assert len(data['culprit']) == MAX_CULPRIT_LENGTH
 
+    def test_long_transaction(self):
+        manager = EventManager(self.make_event(
+            transaction='x' * (MAX_CULPRIT_LENGTH + 1),
+        ))
+        data = manager.normalize()
+        assert len(data['transaction']) == MAX_CULPRIT_LENGTH
+
     def test_long_message(self):
         manager = EventManager(
             self.make_event(
