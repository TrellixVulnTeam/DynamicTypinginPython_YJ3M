commit 2c7aae73e8903ee47b7bf78d85697912e62916d6
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Nov 27 10:21:28 2012 -0800

    Improve efficiency of trends query by restricting project ids in subquery

diff --git a/src/sentry/manager.py b/src/sentry/manager.py
index f30b54b294..357996623b 100644
--- a/src/sentry/manager.py
+++ b/src/sentry/manager.py
@@ -706,7 +706,7 @@ class GroupManager(BaseManager, ChartMixin):
     def get_by_natural_key(self, project, logger, culprit, checksum):
         return self.get(project=project, logger=logger, view=culprit, checksum=checksum)
 
-    def get_accelerated(self, queryset=None, minutes=15):
+    def get_accelerated(self, project_ids, queryset=None, minutes=15):
         # mintues should
         from sentry.models import MessageCountByMinute
         mcbm_tbl = MessageCountByMinute._meta.db_table
@@ -749,6 +749,7 @@ class GroupManager(BaseManager, ChartMixin):
             FROM %(mcbm_tbl)s as a
             WHERE a.date >=  %(now)s - %(max_time)s
             AND a.date < %(now)s - %(min_time)s
+            AND a.project_id IN (%(project_ids)s)
             GROUP BY a.group_id) as z
         ON z.group_id = %(mcbm_tbl)s.group_id
         WHERE %(mcbm_tbl)s.date >= %(now)s - %(min_time)s
@@ -768,6 +769,7 @@ class GroupManager(BaseManager, ChartMixin):
             norm=normalization,
             epoch_clause=epoch_clause,
             now=now_clause,
+            project_ids=', '.join((str(int(x)) for x in project_ids)),
         )
         return RawQuerySet(self, query, params)
 
diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index 2de316de95..95da8eb695 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -483,7 +483,7 @@ def get_group_trends(request, project=None):
     )
 
     if has_trending():
-        group_list = list(Group.objects.get_accelerated(base_qs, minutes=(
+        group_list = list(Group.objects.get_accelerated(project_dict.keys(), base_qs, minutes=(
             minutes
         ))[:limit])
     else:
diff --git a/src/sentry/web/frontend/groups.py b/src/sentry/web/frontend/groups.py
index 49b22200b4..e131f32b60 100644
--- a/src/sentry/web/frontend/groups.py
+++ b/src/sentry/web/frontend/groups.py
@@ -130,7 +130,7 @@ def _get_group_list(request, project, view=None):
     elif sort == 'avgtime':
         event_list = event_list.filter(time_spent_count__gt=0)
     elif sort.startswith('accel_'):
-        event_list = Group.objects.get_accelerated(event_list, minutes=int(sort.split('_', 1)[1]))
+        event_list = Group.objects.get_accelerated([project.id], event_list, minutes=int(sort.split('_', 1)[1]))
 
     if score_clause:
         event_list = event_list.extra(
diff --git a/tests/sentry/manager/tests.py b/tests/sentry/manager/tests.py
index 38d310a662..70823139f0 100644
--- a/tests/sentry/manager/tests.py
+++ b/tests/sentry/manager/tests.py
@@ -243,5 +243,5 @@ class TrendsTest(TestCase):
             status=0,
         )
 
-        results = list(Group.objects.get_accelerated(base_qs)[:25])
+        results = list(Group.objects.get_accelerated([project.id], base_qs)[:25])
         self.assertEquals(results, [group, group2])
