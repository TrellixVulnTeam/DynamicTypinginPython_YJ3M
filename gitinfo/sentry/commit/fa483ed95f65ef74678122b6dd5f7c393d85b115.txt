commit fa483ed95f65ef74678122b6dd5f7c393d85b115
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jun 24 15:16:50 2015 -0700

    Improve support for single organization mode (fixes GH-1572)
    
    - Handle case when user cannot access any organizations
    - Automatically add users to organization upon registration

diff --git a/src/sentry/models/organization.py b/src/sentry/models/organization.py
index 4f8e8ab174..5f9195a8f7 100644
--- a/src/sentry/models/organization.py
+++ b/src/sentry/models/organization.py
@@ -103,6 +103,13 @@ class Organization(Model):
 
     __repr__ = sane_repr('owner_id', 'name', 'slug')
 
+    @classmethod
+    def get_default(cls):
+        """
+        Return the organization used in single organization mode.
+        """
+        return cls.objects.all()[0]
+
     def __unicode__(self):
         return u'%s (%s)' % (self.name, self.slug)
 
diff --git a/src/sentry/templates/sentry/no-organization-access.html b/src/sentry/templates/sentry/no-organization-access.html
new file mode 100644
index 0000000000..58d8653516
--- /dev/null
+++ b/src/sentry/templates/sentry/no-organization-access.html
@@ -0,0 +1,16 @@
+{% extends "sentry/bases/modal.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "No Organization Access" %} | {{ block.super }}{% endblock %}
+
+{% block wrapperclass %}windowed-small{% endblock %}
+
+{% block main %}
+  <section class="body">
+    <div class="page-header">
+      <h2>{% trans "No Organization Access" %}</h2>
+    </div>
+    <p>{% trans "You don't have access to any organizations within Sentry. Talk to a Sentry administrator about getting access." %}</p>
+  </section>
+{% endblock %}
diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index 3044d65955..97ac18ceba 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -22,7 +22,8 @@ from sudo.decorators import sudo_required
 
 from sentry import features
 from sentry.models import (
-    LostPasswordHash, Organization, Project, Team, UserOption
+    AuthProvider, LostPasswordHash, Organization, OrganizationMemberType,
+    Project, Team, UserOption
 )
 from sentry.plugins import plugins
 from sentry.web.decorators import login_required
@@ -49,6 +50,32 @@ def register(request):
     if form.is_valid():
         user = form.save()
 
+        # TODO(dcramer): ideally this would be handled by a special view
+        # specifically for organization registration
+        if settings.SENTRY_SINGLE_ORGANIZATION:
+            org = Organization.get_default()
+
+            defaults = {
+                'has_global_access': True,
+                'type': OrganizationMemberType.MEMBER,
+            }
+            try:
+                auth_provider = AuthProvider.objects.get(
+                    organization=org.id,
+                )
+            except AuthProvider.DoesNotExist:
+                pass
+            else:
+                defaults.update({
+                    'has_global_access': auth_provider.default_global_access,
+                    'type': auth_provider.default_role,
+                })
+
+            org.member_set.create(
+                user=user,
+                **defaults
+            )
+
         # can_register should only allow a single registration
         request.session.pop('can_register', None)
 
diff --git a/src/sentry/web/frontend/home.py b/src/sentry/web/frontend/home.py
index 0321339002..562bd1c2f3 100644
--- a/src/sentry/web/frontend/home.py
+++ b/src/sentry/web/frontend/home.py
@@ -3,6 +3,7 @@ from __future__ import absolute_import
 from django.core.urlresolvers import reverse
 from django.http import HttpResponseRedirect
 
+from sentry import features
 from sentry.web.frontend.base import BaseView
 
 
@@ -10,8 +11,10 @@ class HomeView(BaseView):
     def get(self, request):
         # TODO(dcramer): deal with case when the user cannot create orgs
         organization = self.get_active_organization(request)
-        if organization is None:
-            url = reverse('sentry-create-organization')
-        else:
+        if organization:
             url = reverse('sentry-organization-home', args=[organization.slug])
+        elif not features.has('organizations:create'):
+            return self.respond('sentry/no-organization-access.html')
+        else:
+            url = reverse('sentry-create-organization')
         return HttpResponseRedirect(url)
