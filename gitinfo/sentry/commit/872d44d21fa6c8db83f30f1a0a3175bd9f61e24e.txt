commit 872d44d21fa6c8db83f30f1a0a3175bd9f61e24e
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Feb 13 11:36:12 2017 -0800

    conf: Allow fetching the same env var multiple times

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index f7e0b9936e..e56195bef8 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -31,18 +31,32 @@ socket.setdefaulttimeout(5)
 def env(key, default='', type=None):
     "Extract an environment variable for use in configuration"
 
-    if 'SENTRY_RUNNING_UWSGI' in os.environ:
-        # We do this so when the process forks off into uwsgi
-        # we want to actually be popping off values. This is so that
-        # at runtime, the variables aren't actually available.
-        fn = os.environ.pop
-    else:
-        fn = os.environ.get
+    # First check an internal cache, so we can `pop` multiple times
+    # without actually losing the value.
+    try:
+        rv = env._cache[key]
+    except KeyError:
+        if 'SENTRY_RUNNING_UWSGI' in os.environ:
+            # We do this so when the process forks off into uwsgi
+            # we want to actually be popping off values. This is so that
+            # at runtime, the variables aren't actually available.
+            fn = os.environ.pop
+        else:
+            fn = os.environ.__getitem__
+
+        try:
+            rv = fn(key)
+            env._cache[key] = rv
+        except KeyError:
+            rv = default
 
     if type is None:
         type = type_from_value(default)
 
-    return type(fn(key, default))
+    return type(rv)
+
+
+env._cache = {}
 
 
 DEBUG = False
