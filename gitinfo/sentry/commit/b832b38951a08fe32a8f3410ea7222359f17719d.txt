commit b832b38951a08fe32a8f3410ea7222359f17719d
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Oct 12 13:44:09 2015 -0700

    Explicitly add team membership upon creation
    
    Refs GH-2158

diff --git a/src/sentry/api/endpoints/organization_teams.py b/src/sentry/api/endpoints/organization_teams.py
index a3b4de6960..ca957bc2d1 100644
--- a/src/sentry/api/endpoints/organization_teams.py
+++ b/src/sentry/api/endpoints/organization_teams.py
@@ -7,7 +7,10 @@ from sentry.api.base import DocSection
 from sentry.api.bases.organization import OrganizationEndpoint
 from sentry.api.serializers import serialize
 from sentry.api.serializers.models.team import TeamWithProjectsSerializer
-from sentry.models import AuditLogEntryEvent, Team, TeamStatus
+from sentry.models import (
+    AuditLogEntryEvent, OrganizationMember, OrganizationMemberTeam,
+    Team, TeamStatus
+)
 from sentry.utils.apidocs import scenario, attach_scenarios
 
 
@@ -91,6 +94,21 @@ class OrganizationTeamsEndpoint(OrganizationEndpoint):
                 organization=organization,
             )
 
+            if request.user.is_authenticated():
+                try:
+                    member = OrganizationMember.objects.get(
+                        user=request.user,
+                        organization=organization,
+                    )
+                except OrganizationMember.DoesNotExist:
+                    pass
+                else:
+                    OrganizationMemberTeam.objects.create(
+                        team=team,
+                        organizationmember=member,
+                        is_active=True,
+                    )
+
             self.create_audit_entry(
                 request=request,
                 organization=organization,
diff --git a/src/sentry/web/forms/add_team.py b/src/sentry/web/forms/add_team.py
index 350509d641..c27c3120d9 100644
--- a/src/sentry/web/forms/add_team.py
+++ b/src/sentry/web/forms/add_team.py
@@ -3,7 +3,10 @@ from __future__ import absolute_import
 from django import forms
 from django.utils.translation import ugettext_lazy as _
 
-from sentry.models import AuditLogEntry, AuditLogEntryEvent, Team
+from sentry.models import (
+    AuditLogEntry, AuditLogEntryEvent, OrganizationMember,
+    OrganizationMemberTeam, Team
+)
 
 
 class AddTeamForm(forms.ModelForm):
@@ -24,6 +27,20 @@ class AddTeamForm(forms.ModelForm):
         team.organization = organization
         team.save()
 
+        try:
+            member = OrganizationMember.objects.get(
+                user=actor,
+                organization=organization,
+            )
+        except OrganizationMember.DoesNotExist:
+            pass
+        else:
+            OrganizationMemberTeam.objects.create(
+                team=team,
+                organizationmember=member,
+                is_active=True,
+            )
+
         AuditLogEntry.objects.create(
             organization=organization,
             actor=actor,
diff --git a/tests/sentry/api/endpoints/test_organization_teams.py b/tests/sentry/api/endpoints/test_organization_teams.py
index 600a1f7e08..1a2dd7d44c 100644
--- a/tests/sentry/api/endpoints/test_organization_teams.py
+++ b/tests/sentry/api/endpoints/test_organization_teams.py
@@ -3,7 +3,7 @@ from __future__ import absolute_import
 from django.core.urlresolvers import reverse
 from exam import fixture
 
-from sentry.models import Team
+from sentry.models import OrganizationMember, OrganizationMemberTeam, Team
 from sentry.testutils import APITestCase
 
 
@@ -64,6 +64,17 @@ class OrganizationTeamsCreateTest(APITestCase):
         assert team.slug == 'foobar'
         assert team.organization == self.organization
 
+        member = OrganizationMember.objects.get(
+            user=self.user,
+            organization=self.organization,
+        )
+
+        assert OrganizationMemberTeam.objects.filter(
+            organizationmember=member,
+            team=team,
+            is_active=True,
+        ).exists()
+
     def test_without_slug(self):
         self.login_as(user=self.user)
 
diff --git a/tests/sentry/web/frontend/test_create_team.py b/tests/sentry/web/frontend/test_create_team.py
index d5603be8c1..0415238c83 100644
--- a/tests/sentry/web/frontend/test_create_team.py
+++ b/tests/sentry/web/frontend/test_create_team.py
@@ -2,7 +2,7 @@ from __future__ import absolute_import
 
 from django.core.urlresolvers import reverse
 
-from sentry.models import Team
+from sentry.models import OrganizationMember, OrganizationMemberTeam, Team
 from sentry.testutils import TestCase, PermissionTestCase
 
 
@@ -46,6 +46,17 @@ class CreateTeamTest(TestCase):
 
         team = Team.objects.get(organization=organization, name='bar')
 
+        member = OrganizationMember.objects.get(
+            user=self.user,
+            organization=organization,
+        )
+
+        assert OrganizationMemberTeam.objects.filter(
+            organizationmember=member,
+            team=team,
+            is_active=True,
+        ).exists()
+
         redirect_uri = reverse('sentry-create-project', args=[organization.slug])
         assert resp['Location'] == 'http://testserver%s?team=%s' % (
             redirect_uri, team.slug)
