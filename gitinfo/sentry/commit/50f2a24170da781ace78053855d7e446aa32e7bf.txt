commit 50f2a24170da781ace78053855d7e446aa32e7bf
Author: Daniel Griesser <daniel.griesser.86@gmail.com>
Date:   Mon Apr 1 09:45:48 2019 +0200

    feat: Update loader code to not overwrite window.Sentry (#12590)
    
    * feat: Update loader code to not overwrite window.Sentry
    
    * fix: Add var Sentry
    
    * ref: Emit warning for noop

diff --git a/src/sentry/templates/sentry/js-sdk-loader-noop.js.tmpl b/src/sentry/templates/sentry/js-sdk-loader-noop.js.tmpl
index 5df7576133..38c514ab37 100644
--- a/src/sentry/templates/sentry/js-sdk-loader-noop.js.tmpl
+++ b/src/sentry/templates/sentry/js-sdk-loader-noop.js.tmpl
@@ -1 +1,16 @@
-// nothing to see here
+function _sentry_noopWarning() {
+  console.warn("The Sentry loader you are trying to use isn't working anymore, check your configuration.");
+}
+var Sentry = {
+    addBreadcrumb: _sentry_noopWarning,
+    captureEvent: _sentry_noopWarning,
+    captureException: _sentry_noopWarning,
+    captureMessage: _sentry_noopWarning,
+    configureScope: _sentry_noopWarning,
+    forceLoad: _sentry_noopWarning,
+    init: _sentry_noopWarning,
+    onLoad: _sentry_noopWarning,
+    showReportDialog: _sentry_noopWarning,
+    withScope: _sentry_noopWarning,
+};
+_sentry_noopWarning();
diff --git a/src/sentry/templates/sentry/js-sdk-loader.js.tmpl b/src/sentry/templates/sentry/js-sdk-loader.js.tmpl
index 5fd0f987d8..82cd20ce59 100644
--- a/src/sentry/templates/sentry/js-sdk-loader.js.tmpl
+++ b/src/sentry/templates/sentry/js-sdk-loader.js.tmpl
@@ -1,5 +1,4 @@
-{% load sentry_helpers %}// Sentry Loader
-(function(
+{% load sentry_helpers %}(function(
   _window,
   _document,
   _script,
@@ -149,26 +148,27 @@
     }
   }
 
-  // We don't want to _window.Sentry = _window.Sentry || { ... } since we want to make sure
-  // that the first Sentry "instance" is our with onLoad
-  _window[_namespace] = {
-    onLoad: function (callback) {
-      onLoadCallbacks.push(callback);
-      if (lazy && !forceLoad) {
-        return;
-      }
-      injectSdk(onLoadCallbacks);
-    },
-    forceLoad: function() {
-      forceLoad = true;
-      if (lazy) {
-        setTimeout(function() {
-          injectSdk(onLoadCallbacks);
-        });
-      }
+  // We make sure we do not overwrite window.Sentry since there could be already integrations in there
+  _window[_namespace] = _window[_namespace] || {};
+
+  _window[_namespace].onLoad = function (callback) {
+    onLoadCallbacks.push(callback);
+    if (lazy && !forceLoad) {
+      return;
     }
+    injectSdk(onLoadCallbacks);
   };
 
+  _window[_namespace].forceLoad = function() {
+    forceLoad = true;
+    if (lazy) {
+      setTimeout(function() {
+        injectSdk(onLoadCallbacks);
+      });
+    }
+  };
+
+
   [
     'init',
     'addBreadcrumb',
diff --git a/src/sentry/templates/sentry/js-sdk-loader.min.js.tmpl b/src/sentry/templates/sentry/js-sdk-loader.min.js.tmpl
index 4767535168..a11271aad9 100644
--- a/src/sentry/templates/sentry/js-sdk-loader.min.js.tmpl
+++ b/src/sentry/templates/sentry/js-sdk-loader.min.js.tmpl
@@ -1,4 +1,4 @@
-{% load sentry_helpers %}(function(c,u,v,n,p,q,z,A,w){function h(a){if(!x){x=!0;var k=u.getElementsByTagName(v)[0],d=u.createElement(v);d.src=A;d.crossorigin="anonymous";d.addEventListener("load",function(){try{c[n]=r;c[p]=t;var b=c[q],d=b.init;b.init=function(a){for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&(w[b]=a[b]);d(w)};B(a,b)}catch(g){console.error(g)}});k.parentNode.insertBefore(d,k)}}function B(a,k){try{for(var d=m.data,b=0;b<a.length;b++)if("function"===typeof a[b])a[b]();var e=!1,g=c.__SENTRY__;"undefined"!==
-typeof g&&g.hub&&g.hub.getClient()&&(e=!0);g=!1;for(b=0;b<d.length;b++)if(d[b].f){g=!0;var f=d[b];!1===e&&"init"!==f.f&&k.init();e=!0;k[f.f].apply(k,f.a)}!1===e&&!1===g&&k.init();var h=c[n],l=c[p];for(b=0;b<d.length;b++)d[b].e&&h?h.apply(c,d[b].e):d[b].p&&l&&l.apply(c,[d[b].p])}catch(C){console.error(C)}}for(var e=!0,y=!1,l=0;l<document.scripts.length;l++)if(-1<document.scripts[l].src.indexOf(z)){e="no"!==document.scripts[l].getAttribute("data-lazy");break}var x=!1,f=[],m=function(a){(a.e||a.p||a.f&&
--1<a.f.indexOf("capture")||a.f&&-1<a.f.indexOf("showReportDialog"))&&e&&h(f);m.data.push(a)};m.data=[];c[q]={onLoad:function(a){f.push(a);e&&!y||h(f)},forceLoad:function(){y=!0;e&&setTimeout(function(){h(f)})}};"init addBreadcrumb captureMessage captureException captureEvent configureScope withScope showReportDialog".split(" ").forEach(function(a){c[q][a]=function(){m({f:a,a:arguments})}});var r=c[n];c[n]=function(a,e,d,b,f){m({e:[].slice.call(arguments)});r&&r.apply(c,arguments)};var t=c[p];c[p]=
-function(a){m({p:a.reason});t&&t.apply(c,arguments)};e||setTimeout(function(){h(f)})})(window,document,"script","onerror","onunhandledrejection","Sentry","{{ publicKey|safe }}","{{ jsSdkUrl|safe }}",{{ config|to_json|safe }});
+{% load sentry_helpers %}(function(c,u,v,n,p,e,z,A,w){function k(a){if(!x){x=!0;var l=u.getElementsByTagName(v)[0],d=u.createElement(v);d.src=A;d.crossorigin="anonymous";d.addEventListener("load",function(){try{c[n]=r;c[p]=t;var b=c[e],d=b.init;b.init=function(a){for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&(w[b]=a[b]);d(w)};B(a,b)}catch(g){console.error(g)}});l.parentNode.insertBefore(d,l)}}function B(a,l){try{for(var d=m.data,b=0;b<a.length;b++)if("function"===typeof a[b])a[b]();var e=!1,g=c.__SENTRY__;"undefined"!==
+typeof g&&g.hub&&g.hub.getClient()&&(e=!0);g=!1;for(b=0;b<d.length;b++)if(d[b].f){g=!0;var f=d[b];!1===e&&"init"!==f.f&&l.init();e=!0;l[f.f].apply(l,f.a)}!1===e&&!1===g&&l.init();var h=c[n],k=c[p];for(b=0;b<d.length;b++)d[b].e&&h?h.apply(c,d[b].e):d[b].p&&k&&k.apply(c,[d[b].p])}catch(C){console.error(C)}}for(var f=!0,y=!1,q=0;q<document.scripts.length;q++)if(-1<document.scripts[q].src.indexOf(z)){f="no"!==document.scripts[q].getAttribute("data-lazy");break}var x=!1,h=[],m=function(a){(a.e||a.p||a.f&&
+-1<a.f.indexOf("capture")||a.f&&-1<a.f.indexOf("showReportDialog"))&&f&&k(h);m.data.push(a)};m.data=[];c[e]=c[e]||{};c[e].onLoad=function(a){h.push(a);f&&!y||k(h)};c[e].forceLoad=function(){y=!0;f&&setTimeout(function(){k(h)})};"init addBreadcrumb captureMessage captureException captureEvent configureScope withScope showReportDialog".split(" ").forEach(function(a){c[e][a]=function(){m({f:a,a:arguments})}});var r=c[n];c[n]=function(a,e,d,b,f){m({e:[].slice.call(arguments)});r&&r.apply(c,arguments)};
+var t=c[p];c[p]=function(a){m({p:a.reason});t&&t.apply(c,arguments)};f||setTimeout(function(){k(h)})})(window,document,"script","onerror","onunhandledrejection","Sentry","{{ publicKey|safe }}","{{ jsSdkUrl|safe }}",{{ config|to_json|safe }});
