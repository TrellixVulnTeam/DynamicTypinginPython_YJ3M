commit 3a1b83a670c5c93f03a6d779602f6e9d902fa8d3
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Jan 11 14:36:28 2018 -0800

    ref(environments): Replace `EnvironmentMixin._get_environment_id_func` with `_get_environment_func` (#6957)

diff --git a/src/sentry/api/base.py b/src/sentry/api/base.py
index 2ed021d72e..d86fa97a9d 100644
--- a/src/sentry/api/base.py
+++ b/src/sentry/api/base.py
@@ -222,9 +222,9 @@ class Endpoint(APIView):
 
 
 class EnvironmentMixin(object):
-    def _get_environment_id_func(self, request, organization_id):
+    def _get_environment_func(self, request, organization_id):
         """\
-        Creates a function that when called returns the environment_id
+        Creates a function that when called returns the ``Environment``
         associated with a request object, or ``None`` if no environment was
         provided. If the environment doesn't exist, an ``Environment.DoesNotExist``
         exception will be raised.
@@ -236,7 +236,7 @@ class EnvironmentMixin(object):
         provided.)
         """
         return functools.partial(
-            self._get_environment_id_from_request,
+            self._get_environment_from_request,
             request,
             organization_id,
         )
diff --git a/src/sentry/api/bases/organizationissues.py b/src/sentry/api/bases/organizationissues.py
index 26fbdd46f6..2b29acde26 100644
--- a/src/sentry/api/bases/organizationissues.py
+++ b/src/sentry/api/bases/organizationissues.py
@@ -55,7 +55,7 @@ class OrganizationIssuesEndpoint(OrganizationMemberEndpoint, EnvironmentMixin):
         def on_results(results):
             results = serialize(
                 results, request.user, StreamGroupSerializer(
-                    environment_id_func=self._get_environment_id_func(request, organization.id),
+                    environment_func=self._get_environment_func(request, organization.id),
                     stats_period=stats_period,
                 )
             )
diff --git a/src/sentry/api/endpoints/group_details.py b/src/sentry/api/endpoints/group_details.py
index a571ff7c78..ad654d873e 100644
--- a/src/sentry/api/endpoints/group_details.py
+++ b/src/sentry/api/endpoints/group_details.py
@@ -178,7 +178,7 @@ class GroupDetailsEndpoint(GroupEndpoint, EnvironmentMixin):
             group,
             request.user,
             GroupSerializer(
-                environment_id_func=self._get_environment_id_func(
+                environment_func=self._get_environment_func(
                     request, group.project.organization_id)
             )
         )
@@ -317,7 +317,7 @@ class GroupDetailsEndpoint(GroupEndpoint, EnvironmentMixin):
             group,
             request.user,
             GroupSerializer(
-                environment_id_func=self._get_environment_id_func(
+                environment_func=self._get_environment_func(
                     request, group.project.organization_id)
             )
         )
diff --git a/src/sentry/api/endpoints/issues_resolved_in_release.py b/src/sentry/api/endpoints/issues_resolved_in_release.py
index 4e2d793199..86f610ba4c 100644
--- a/src/sentry/api/endpoints/issues_resolved_in_release.py
+++ b/src/sentry/api/endpoints/issues_resolved_in_release.py
@@ -65,7 +65,7 @@ class IssuesResolvedInReleaseEndpoint(ProjectEndpoint, EnvironmentMixin):
             list(groups),
             request.user,
             GroupSerializer(
-                environment_id_func=self._get_environment_id_func(request, project.organization_id)
+                environment_func=self._get_environment_func(request, project.organization_id)
             )
         )
 
diff --git a/src/sentry/api/endpoints/organization_activity.py b/src/sentry/api/endpoints/organization_activity.py
index 6a6d8fbaef..500a96b8e6 100644
--- a/src/sentry/api/endpoints/organization_activity.py
+++ b/src/sentry/api/endpoints/organization_activity.py
@@ -29,7 +29,7 @@ class OrganizationActivityEndpoint(OrganizationMemberEndpoint, EnvironmentMixin)
             paginator_cls=DateTimePaginator,
             order_by='-datetime',
             on_results=lambda x: serialize(x, request.user, OrganizationActivitySerializer(
-                environment_id_func=self._get_environment_id_func(
+                environment_func=self._get_environment_func(
                     request, organization.id)
             )),
         )
diff --git a/src/sentry/api/endpoints/organization_user_issues.py b/src/sentry/api/endpoints/organization_user_issues.py
index 3222159b74..4d46fa9e64 100644
--- a/src/sentry/api/endpoints/organization_user_issues.py
+++ b/src/sentry/api/endpoints/organization_user_issues.py
@@ -56,7 +56,7 @@ class OrganizationUserIssuesEndpoint(OrganizationEndpoint, EnvironmentMixin):
             groups, request.user, TagBasedStreamGroupSerializer(
                 stats_period=None,
                 tags=tags,
-                environment_id_func=self._get_environment_id_func(request, organization.id)
+                environment_func=self._get_environment_func(request, organization.id)
             )
         )
 
diff --git a/src/sentry/api/endpoints/organization_user_issues_search.py b/src/sentry/api/endpoints/organization_user_issues_search.py
index 4f4932a410..d403e01fc9 100644
--- a/src/sentry/api/endpoints/organization_user_issues_search.py
+++ b/src/sentry/api/endpoints/organization_user_issues_search.py
@@ -44,7 +44,7 @@ class OrganizationUserIssuesSearchEndpoint(OrganizationEndpoint, EnvironmentMixi
         ).order_by('-last_seen')[:limit]
 
         context = serialize(list(groups), request.user, GroupSerializer(
-            environment_id_func=self._get_environment_id_func(
+            environment_func=self._get_environment_func(
                 request, organization.id)
         ))
 
diff --git a/src/sentry/api/endpoints/project_group_index.py b/src/sentry/api/endpoints/project_group_index.py
index 81dfa76328..c818267078 100644
--- a/src/sentry/api/endpoints/project_group_index.py
+++ b/src/sentry/api/endpoints/project_group_index.py
@@ -274,7 +274,7 @@ class ProjectGroupIndexEndpoint(ProjectEndpoint, EnvironmentMixin):
 
         serializer = functools.partial(
             StreamGroupSerializer,
-            environment_id_func=self._get_environment_id_func(request, project.organization_id),
+            environment_func=self._get_environment_func(request, project.organization_id),
             stats_period=stats_period,
         )
 
diff --git a/src/sentry/api/endpoints/project_user_reports.py b/src/sentry/api/endpoints/project_user_reports.py
index dee8d351f9..678f93e78a 100644
--- a/src/sentry/api/endpoints/project_user_reports.py
+++ b/src/sentry/api/endpoints/project_user_reports.py
@@ -68,7 +68,7 @@ class ProjectUserReportsEndpoint(ProjectEndpoint, EnvironmentMixin):
             queryset=queryset,
             order_by='-date_added',
             on_results=lambda x: serialize(x, request.user, ProjectUserReportSerializer(
-                environment_id_func=self._get_environment_id_func(
+                environment_func=self._get_environment_func(
                     request, project.organization_id)
             )),
             paginator_cls=DateTimePaginator,
@@ -141,7 +141,7 @@ class ProjectUserReportsEndpoint(ProjectEndpoint, EnvironmentMixin):
         user_feedback_received.send(project=report.project, group=report.group, sender=self)
 
         return Response(serialize(report, request.user, ProjectUserReportSerializer(
-            environment_id_func=self._get_environment_id_func(
+            environment_func=self._get_environment_func(
                 request, project.organization_id)
         )))
 
diff --git a/src/sentry/api/endpoints/shared_group_details.py b/src/sentry/api/endpoints/shared_group_details.py
index 3e3720b5b0..44512ceae1 100644
--- a/src/sentry/api/endpoints/shared_group_details.py
+++ b/src/sentry/api/endpoints/shared_group_details.py
@@ -40,7 +40,7 @@ class SharedGroupDetailsEndpoint(Endpoint, EnvironmentMixin):
             group,
             request.user,
             SharedGroupSerializer(
-                environment_id_func=self._get_environment_id_func(
+                environment_func=self._get_environment_func(
                     request, group.project.organization_id)
             )
         )
diff --git a/src/sentry/api/endpoints/team_groups_new.py b/src/sentry/api/endpoints/team_groups_new.py
index b2c68526c6..affbc97616 100644
--- a/src/sentry/api/endpoints/team_groups_new.py
+++ b/src/sentry/api/endpoints/team_groups_new.py
@@ -47,7 +47,7 @@ class TeamGroupsNewEndpoint(TeamEndpoint, EnvironmentMixin):
                 group_list,
                 request.user,
                 GroupSerializer(
-                    environment_id_func=self._get_environment_id_func(request, team.organization_id)
+                    environment_func=self._get_environment_func(request, team.organization_id)
                 )
             )
         )
diff --git a/src/sentry/api/endpoints/team_groups_trending.py b/src/sentry/api/endpoints/team_groups_trending.py
index efd180db7d..d17473aa31 100644
--- a/src/sentry/api/endpoints/team_groups_trending.py
+++ b/src/sentry/api/endpoints/team_groups_trending.py
@@ -47,7 +47,7 @@ class TeamGroupsTrendingEndpoint(TeamEndpoint, EnvironmentMixin):
                 group_list,
                 request.user,
                 GroupSerializer(
-                    environment_id_func=self._get_environment_id_func(
+                    environment_func=self._get_environment_func(
                         request, team.organization_id)
                 )
             )
diff --git a/src/sentry/api/serializers/models/activity.py b/src/sentry/api/serializers/models/activity.py
index 860ebc8e2e..d6c863dc8e 100644
--- a/src/sentry/api/serializers/models/activity.py
+++ b/src/sentry/api/serializers/models/activity.py
@@ -10,8 +10,8 @@ from sentry.utils.functional import apply_values
 
 @register(Activity)
 class ActivitySerializer(Serializer):
-    def __init__(self, environment_id_func=None):
-        self.environment_id_func = environment_id_func
+    def __init__(self, environment_func=None):
+        self.environment_func = environment_func
 
     def get_attrs(self, item_list, user):
         # TODO(dcramer); assert on relations
@@ -117,7 +117,7 @@ class OrganizationActivitySerializer(ActivitySerializer):
             d['id']: d for d in serialize(
                 set([i.group for i in item_list if i.group_id]),
                 user,
-                GroupSerializer(environment_id_func=self.environment_id_func)
+                GroupSerializer(environment_func=self.environment_func)
             )
         }
 
diff --git a/src/sentry/api/serializers/models/group.py b/src/sentry/api/serializers/models/group.py
index 2b945ce403..ff2253edea 100644
--- a/src/sentry/api/serializers/models/group.py
+++ b/src/sentry/api/serializers/models/group.py
@@ -35,8 +35,8 @@ disabled = object()
 
 @register(Group)
 class GroupSerializer(Serializer):
-    def __init__(self, environment_id_func=None):
-        self.environment_id_func = environment_id_func if environment_id_func is not None else lambda: None
+    def __init__(self, environment_func=None):
+        self.environment_func = environment_func if environment_func is not None else lambda: None
 
     def _get_subscriptions(self, item_list, user):
         """
@@ -145,10 +145,11 @@ class GroupSerializer(Serializer):
         )
 
         try:
-            environment_id = self.environment_id_func()
+            environment = self.environment_func()
         except Environment.DoesNotExist:
             user_counts = {}
         else:
+            environment_id = environment and environment.id
             user_counts = tagstore.get_groups_user_counts(
                 item_list[0].project_id, [g.id for g in item_list], environment_id=environment_id)
 
@@ -336,8 +337,8 @@ class StreamGroupSerializer(GroupSerializer):
         '24h': StatsPeriod(24, timedelta(hours=1)),
     }
 
-    def __init__(self, environment_id_func=None, stats_period=None, matching_event_id=None):
-        super(StreamGroupSerializer, self).__init__(environment_id_func)
+    def __init__(self, environment_func=None, stats_period=None, matching_event_id=None):
+        super(StreamGroupSerializer, self).__init__(environment_func)
 
         if stats_period is not None:
             assert stats_period in self.STATS_PERIOD_CHOICES
@@ -359,17 +360,21 @@ class StreamGroupSerializer(GroupSerializer):
                 'end': now,
                 'rollup': int(interval.total_seconds()),
             }
+
             try:
+                environment = self.environment_func()
+            except Environment.DoesNotExist:
+                stats = {key: tsdb.make_series(0, **query_params) for key in group_ids}
+            else:
                 stats = tsdb.get_range(
                     model=tsdb.models.group,
                     keys=group_ids,
-                    environment_id=self.environment_id_func(),
+                    environment_id=environment and environment.id,
                     **query_params
                 )
-            except Environment.DoesNotExist:
-                stats = {key: tsdb.make_series(0, **query_params) for key in group_ids}
 
             for item in item_list:
+
                 attrs[item].update({
                     'stats': stats[item.id],
                 })
diff --git a/src/sentry/api/serializers/models/userreport.py b/src/sentry/api/serializers/models/userreport.py
index 09ad4ce338..4744493730 100644
--- a/src/sentry/api/serializers/models/userreport.py
+++ b/src/sentry/api/serializers/models/userreport.py
@@ -59,8 +59,8 @@ class UserReportSerializer(Serializer):
 
 
 class ProjectUserReportSerializer(UserReportSerializer):
-    def __init__(self, environment_id_func=None):
-        self.environment_id_func = environment_id_func
+    def __init__(self, environment_func=None):
+        self.environment_func = environment_func
 
     def get_attrs(self, item_list, user):
         from sentry.api.serializers import GroupSerializer
@@ -70,7 +70,7 @@ class ProjectUserReportSerializer(UserReportSerializer):
             d['id']: d for d in serialize(
                 set(i.group for i in item_list if i.group_id),
                 user,
-                GroupSerializer(environment_id_func=self.environment_id_func))
+                GroupSerializer(environment_func=self.environment_func))
         }
 
         attrs = super(ProjectUserReportSerializer, self).get_attrs(item_list, user)
diff --git a/tests/sentry/api/serializers/test_group.py b/tests/sentry/api/serializers/test_group.py
index d9213e0115..d516486173 100644
--- a/tests/sentry/api/serializers/test_group.py
+++ b/tests/sentry/api/serializers/test_group.py
@@ -285,7 +285,7 @@ class StreamGroupSerializerTestCase(TestCase):
             serialize(
                 [group],
                 serializer=StreamGroupSerializer(
-                    environment_id_func=lambda: environment.id,
+                    environment_func=lambda: environment,
                     stats_period='14d',
                 ),
             )
@@ -302,7 +302,7 @@ class StreamGroupSerializerTestCase(TestCase):
             serialize(
                 [group],
                 serializer=StreamGroupSerializer(
-                    environment_id_func=get_invalid_environment,
+                    environment_func=get_invalid_environment,
                     stats_period='14d',
                 )
             )
