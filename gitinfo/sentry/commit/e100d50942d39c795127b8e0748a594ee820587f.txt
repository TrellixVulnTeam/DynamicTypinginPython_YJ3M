commit e100d50942d39c795127b8e0748a594ee820587f
Author: Mark Story <mark@sentry.io>
Date:   Mon Jun 17 10:30:59 2019 -0400

    fix(gitlab) When gitlab requests fail respond with a 400 (#13691)
    
    Don't fail and create sentry issues when GitLab instances cannot be
    reached, timeout or otherwise behave poorly.
    
    Fixes SENTRY-B2C

diff --git a/src/sentry/integrations/gitlab/search.py b/src/sentry/integrations/gitlab/search.py
index ebb2f10aaf..a71e95b799 100644
--- a/src/sentry/integrations/gitlab/search.py
+++ b/src/sentry/integrations/gitlab/search.py
@@ -1,8 +1,10 @@
 from __future__ import absolute_import
 
+import six
 from rest_framework.response import Response
 
 from sentry.api.bases.integration import IntegrationEndpoint
+from sentry.integrations.exceptions import ApiError
 from sentry.models import Integration
 
 
@@ -37,7 +39,10 @@ class GitlabIssueSearchEndpoint(IntegrationEndpoint):
             except ValueError:
                 iids = None
 
-            response = installation.search_issues(query=query, project_id=project, iids=iids)
+            try:
+                response = installation.search_issues(query=query, project_id=project, iids=iids)
+            except ApiError as e:
+                return Response({'detail': six.text_type(e)}, status=400)
 
             return Response([{
                 'label': '(#%s) %s' % (i['iid'], i['title']),
@@ -45,7 +50,10 @@ class GitlabIssueSearchEndpoint(IntegrationEndpoint):
             } for i in response])
 
         elif field == 'project':
-            response = installation.search_projects(query)
+            try:
+                response = installation.search_projects(query)
+            except ApiError as e:
+                return Response({'detail': six.text_type(e)}, status=400)
             return Response([{
                 'label': project['name_with_namespace'],
                 'value': project['id'],
diff --git a/tests/sentry/integrations/gitlab/test_search.py b/tests/sentry/integrations/gitlab/test_search.py
index ed42c26388..35785c5e7a 100644
--- a/tests/sentry/integrations/gitlab/test_search.py
+++ b/tests/sentry/integrations/gitlab/test_search.py
@@ -255,7 +255,7 @@ class GitlabSearchTest(GitLabTestCase):
                 'project': '5',
             }
         )
-        assert resp.status_code == 503
+        assert resp.status_code == 400
 
     def test_projects_request_fails(self):
         responses.add(
@@ -269,4 +269,4 @@ class GitlabSearchTest(GitLabTestCase):
                 'query': 'GetSentry',
             }
         )
-        assert resp.status_code == 503
+        assert resp.status_code == 400
