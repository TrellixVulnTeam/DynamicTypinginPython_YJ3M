commit aca6466685c42237340b8c970599d710376fb6d9
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Sep 7 16:16:55 2017 -0700

    fix(api): Correct value for expires_in

diff --git a/src/sentry/web/frontend/oauth_authorize.py b/src/sentry/web/frontend/oauth_authorize.py
index 39fae9b7fd..cf22ac3be3 100644
--- a/src/sentry/web/frontend/oauth_authorize.py
+++ b/src/sentry/web/frontend/oauth_authorize.py
@@ -320,7 +320,7 @@ class OAuthAuthorizeView(AuthLoginView):
                 params['redirect_uri'],
                 {
                     'access_token': token.token,
-                    'expires_in': (timezone.now() - token.expires_at).total_seconds(),
+                    'expires_in': int((timezone.now() - token.expires_at).total_seconds()),
                     'expires_at': token.expires_at.strftime('%Y-%m-%dT%H:%M:%S.%fZ'),
                     'token_type': 'bearer',
                     'scope': ' '.join(token.get_scopes()),  # NOQA
diff --git a/src/sentry/web/frontend/oauth_token.py b/src/sentry/web/frontend/oauth_token.py
index 84a8d9b0ab..3fa78fe648 100644
--- a/src/sentry/web/frontend/oauth_token.py
+++ b/src/sentry/web/frontend/oauth_token.py
@@ -113,7 +113,7 @@ class OAuthTokenView(View):
                 {
                     'access_token': token.token,
                     'refresh_token': token.refresh_token,
-                    'expires_in': (timezone.now() - token.expires_at).total_seconds(),
+                    'expires_in': int((token.expires_at - timezone.now()).total_seconds()) if token.expires_at else None,
                     'expires_at': token.expires_at,
                     'token_type': 'bearer',
                     'scope': ' '.join(token.get_scopes()),  # NOQA
diff --git a/tests/sentry/web/frontend/test_oauth_authorize.py b/tests/sentry/web/frontend/test_oauth_authorize.py
index 1e28ea6cb1..8a7ceefda1 100644
--- a/tests/sentry/web/frontend/test_oauth_authorize.py
+++ b/tests/sentry/web/frontend/test_oauth_authorize.py
@@ -417,7 +417,7 @@ class OAuthAuthorizeTokenTest(TestCase):
         assert fragment['access_token'] == [token.token]
         assert fragment['token_type'] == ['bearer']
         assert 'refresh_token' not in fragment
-        assert fragment['expires_in']
+        assert isinstance(fragment['expires_in'], int)
         assert fragment['token_type'] == ['bearer']
 
     def test_minimal_params_code_deny_flow(self):
diff --git a/tests/sentry/web/frontend/test_oauth_token.py b/tests/sentry/web/frontend/test_oauth_token.py
index 3e90a631ae..a3898a18d7 100644
--- a/tests/sentry/web/frontend/test_oauth_token.py
+++ b/tests/sentry/web/frontend/test_oauth_token.py
@@ -138,7 +138,7 @@ class OAuthTokenCodeTest(TestCase):
 
         assert data['access_token'] == token.token
         assert data['refresh_token'] == token.refresh_token
-        assert data['expires_in']
+        assert isinstance(data['expires_in'], int)
         assert data['token_type'] == 'bearer'
         assert data['user']['id'] == six.text_type(token.user_id)
 
