commit 07a25c9c10b5811048ce40c5f839772bb845f422
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Fri Mar 4 13:25:01 2016 +0100

    Added callsign to project settings and set review flag.

diff --git a/src/sentry/api/endpoints/organization_shortids.py b/src/sentry/api/endpoints/organization_shortids.py
index a1cb5ceabf..eec263a2d5 100644
--- a/src/sentry/api/endpoints/organization_shortids.py
+++ b/src/sentry/api/endpoints/organization_shortids.py
@@ -28,7 +28,7 @@ class ShortIdsUpdateEndpoint(OrganizationEndpoint):
             if project is None:
                 continue
             project.callsign = callsign
-            project.update_option('sentry:reviewed-short-id', True)
+            project.update_option('sentry:reviewed-callsign', True)
             rv[project.id] = callsign
 
         return Response({
diff --git a/src/sentry/migrations/0242_prefill_callsigns.py b/src/sentry/migrations/0242_prefill_callsigns.py
index 977719d208..a42e97a111 100644
--- a/src/sentry/migrations/0242_prefill_callsigns.py
+++ b/src/sentry/migrations/0242_prefill_callsigns.py
@@ -91,7 +91,7 @@ class Migration(DataMigration):
                     ).update(callsign=callsigns[project.id])
                     ProjectOption.objects.filter(
                         project=project,
-                        key='sentry:reviewed-short-id'
+                        key='sentry:reviewed-callsign'
                     ).delete()
                 q = Group.objects.filter(
                     project=project,
@@ -125,7 +125,7 @@ class Migration(DataMigration):
             ).update(callsign=None)
             ProjectOption.objects.filter(
                 project__in=project_ids,
-                key='sentry:reviewed-short-id'
+                key='sentry:reviewed-callsign'
             ).delete()
             Group.objects.filter(
                 project_id__in=project_ids
diff --git a/src/sentry/static/sentry/app/views/requiredAdminActions/setCallsigns.jsx b/src/sentry/static/sentry/app/views/requiredAdminActions/setCallsigns.jsx
index 729d5db4fd..edba7e68a6 100644
--- a/src/sentry/static/sentry/app/views/requiredAdminActions/setCallsigns.jsx
+++ b/src/sentry/static/sentry/app/views/requiredAdminActions/setCallsigns.jsx
@@ -58,10 +58,6 @@ const SetCallsignsAction = React.createClass({
     };
   },
 
-  getProjectList() {
-    return getProjectInfoForReview(this.getOrganization()).projects;
-  },
-
   onSubmit(event) {
     this.setState({
       isLoading: true
diff --git a/src/sentry/templates/sentry/projects/manage.html b/src/sentry/templates/sentry/projects/manage.html
index 7d4e52fbd9..3db4940b74 100644
--- a/src/sentry/templates/sentry/projects/manage.html
+++ b/src/sentry/templates/sentry/projects/manage.html
@@ -39,6 +39,7 @@
       <div class="box-content with-padding">
         {{ form.name|as_crispy_field }}
         {{ form.slug|as_crispy_field }}
+        {{ form.callsign|as_crispy_field }}
         {{ form.team|as_crispy_field }}
       </div>
     </div>
diff --git a/src/sentry/web/frontend/project_settings.py b/src/sentry/web/frontend/project_settings.py
index 198322821c..ece666c4b0 100644
--- a/src/sentry/web/frontend/project_settings.py
+++ b/src/sentry/web/frontend/project_settings.py
@@ -1,5 +1,7 @@
 from __future__ import absolute_import
 
+import re
+
 from django import forms
 from django.contrib import messages
 from django.core.urlresolvers import reverse
@@ -20,6 +22,9 @@ from sentry.web.frontend.base import ProjectView
 BLANK_CHOICE = [("", "")]
 
 
+_callsign_re = re.compile(r'^[A-Z]{2,6}$')
+
+
 class EditProjectForm(forms.ModelForm):
     name = forms.CharField(label=_('Project Name'), max_length=200,
         widget=forms.TextInput(attrs={'placeholder': _('Production')}))
@@ -27,6 +32,8 @@ class EditProjectForm(forms.ModelForm):
         label=_('Short name'),
         help_text=_('A unique ID used to identify this project.'),
     )
+    callsign = forms.CharField(label=_('Callsign'),
+        help_text=_('A short (typically two) letter sequence to identify issues.'))
     team = CustomTypedChoiceField(choices=(), coerce=int, required=False)
     origins = OriginsField(label=_('Allowed Domains'), required=False,
         help_text=_('Separate multiple entries with a newline.'))
@@ -72,7 +79,7 @@ class EditProjectForm(forms.ModelForm):
     org_overrides = ('scrub_data', 'scrub_defaults', 'scrub_ip_address')
 
     class Meta:
-        fields = ('name', 'team', 'slug')
+        fields = ('name', 'team', 'slug', 'callsign')
         model = Project
 
     def __init__(self, request, organization, team_list, data, instance, *args, **kwargs):
@@ -157,6 +164,19 @@ class EditProjectForm(forms.ModelForm):
             raise forms.ValidationError('Another project is already using that slug')
         return slug
 
+    def clean_callsign(self):
+        callsign = self.cleaned_data.get('callsign').strip().upper()
+        if _callsign_re.match(callsign) is None:
+            raise forms.ValidationError('Callsign must be between 2 and 6 letters')
+        other = Project.objects.filter(
+            callsign=callsign,
+            organization=self.organization
+        ).exclude(id=self.instance.id).first()
+        if other is not None:
+            raise forms.ValidationError('Another project (%s) is already '
+                                        'using that callsign' % other.name)
+        return callsign
+
 
 class ProjectSettingsView(ProjectView):
     required_scope = 'project:write'
@@ -217,6 +237,8 @@ class ProjectSettingsView(ProjectView):
                 else:
                     project.update_option('sentry:%s' % (opt,), value)
 
+            project.update_option('sentry:reviewed-callsign', True)
+
             AuditLogEntry.objects.create(
                 organization=organization,
                 actor=request.user,
