commit 2cd2ce115878522a5ec13db78ab2dfe996d49e41
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Jul 6 12:41:39 2015 -0400

    Change behavior of sourcemap discovery so last pragma found wins

diff --git a/src/sentry/lang/javascript/processor.py b/src/sentry/lang/javascript/processor.py
index 57ab9399fc..540c94bf34 100644
--- a/src/sentry/lang/javascript/processor.py
+++ b/src/sentry/lang/javascript/processor.py
@@ -160,15 +160,16 @@ def discover_sourcemap(result):
         # are generous and assume it's somewhere either in the first or last 5 lines.
         # If it's somewhere else in the document, you're probably doing it wrong.
         if len(parsed_body) > 10:
-            possibilities = set(parsed_body[:5] + parsed_body[-5:])
+            possibilities = parsed_body[:5] + parsed_body[-5:]
         else:
-            possibilities = set(parsed_body)
+            possibilities = parsed_body
 
+        # We want to scan each line sequentially, and the last one found wins
+        # This behavior is undocumented, but matches what Chrome and Firefox do.
         for line in possibilities:
-            if line.startswith('//@ sourceMappingURL=') or line.startswith('//# sourceMappingURL='):
+            if line[:21] in ('//# sourceMappingURL=', '//@ sourceMappingURL='):
                 # We want everything AFTER the indicator, which is 21 chars long
                 sourcemap = line[21:].rstrip()
-                break
 
     if sourcemap:
         # fix url so its absolute
diff --git a/tests/sentry/lang/javascript/test_processor.py b/tests/sentry/lang/javascript/test_processor.py
index b3fe6a30d6..b504fc6f1f 100644
--- a/tests/sentry/lang/javascript/test_processor.py
+++ b/tests/sentry/lang/javascript/test_processor.py
@@ -99,6 +99,9 @@ class DiscoverSourcemapTest(TestCase):
         result = UrlResult('http://example.com', {}, 'console.log(true)\n//# sourceMappingURL=http://example.com/source.map.js')
         assert discover_sourcemap(result) == 'http://example.com/source.map.js'
 
+        result = UrlResult('http://example.com', {}, 'console.log(true)\n//# sourceMappingURL=http://example.com/source.map.js\n//# sourceMappingURL=http://example.com/source2.map.js')
+        assert discover_sourcemap(result) == 'http://example.com/source2.map.js'
+
 
 class GenerateModuleTest(TestCase):
     def test_simple(self):
