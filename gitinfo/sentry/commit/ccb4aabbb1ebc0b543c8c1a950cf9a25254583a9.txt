commit ccb4aabbb1ebc0b543c8c1a950cf9a25254583a9
Author: Filippo Pacifici <fpacifici@sentry.io>
Date:   Tue Jan 21 14:19:39 2020 -0800

    Convert impact expression to prefix (#16548)
    
    Snuba does not support the infix Clickhouse syntax when parsing aggregations. This means that the impact expression (seems the only case in Sentry) gets just passed to Clickhouse as it is. This has a few issues:
    Since this behavior is widespread in the Sentry codebase we provided a basic Clickhouse expression parser in the Snuba code base that is capable of parsing Clickhouse prefix notation. So I turned this into a prefix expression as a stop gap solution before we have a better syntax on Snuba or we move the impact function into snuba itself.

diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index 4f32066787..b1998b4ebd 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -821,7 +821,11 @@ FIELD_ALIASES = {
         "result_type": "number",
         "aggregations": [
             [
-                "(1 - ((countIf(duration < 300) + (countIf((duration > 300) AND (duration < 1200)) / 2)) / count())) + ((1 - 1 / sqrt(uniq(user))) * 3)",
+                # Snuba is not able to parse Clickhouse infix expressions. We should pass aggregations
+                # in a format Snuba can parse so query optimizations can be applied.
+                # It has a minimal prefix parser though to bridge the gap between the current state
+                # and when we will have an easier syntax.
+                "plus(minus(1, divide(plus(countIf(less(duration, 300)),divide(countIf(and(greater(duration, 300),less(duration, 1200))),2)),count())),multiply(minus(1,divide(1,sqrt(uniq(user)))),3))",
                 None,
                 "impact",
             ]
diff --git a/tests/sentry/api/test_event_search.py b/tests/sentry/api/test_event_search.py
index d8488eaced..b9c01b2072 100644
--- a/tests/sentry/api/test_event_search.py
+++ b/tests/sentry/api/test_event_search.py
@@ -1118,7 +1118,7 @@ class ResolveFieldListTest(unittest.TestCase):
             ["avg", "transaction.duration", "avg_transaction_duration"],
             ["apdex(duration, 300)", None, "apdex"],
             [
-                "(1 - ((countIf(duration < 300) + (countIf((duration > 300) AND (duration < 1200)) / 2)) / count())) + ((1 - 1 / sqrt(uniq(user))) * 3)",
+                "plus(minus(1, divide(plus(countIf(less(duration, 300)),divide(countIf(and(greater(duration, 300),less(duration, 1200))),2)),count())),multiply(minus(1,divide(1,sqrt(uniq(user)))),3))",
                 None,
                 "impact",
             ],
