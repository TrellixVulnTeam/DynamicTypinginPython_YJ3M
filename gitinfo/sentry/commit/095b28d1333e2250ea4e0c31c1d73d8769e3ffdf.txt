commit 095b28d1333e2250ea4e0c31c1d73d8769e3ffdf
Author: Bruno Garcia <github@brunogarcia.com>
Date:   Wed Dec 19 17:58:23 2018 +0100

    fix: use username as feedback user (#11099)

diff --git a/src/sentry/lang/native/unreal.py b/src/sentry/lang/native/unreal.py
index 3d7cb36ddd..deebbaa5f9 100644
--- a/src/sentry/lang/native/unreal.py
+++ b/src/sentry/lang/native/unreal.py
@@ -37,7 +37,6 @@ def merge_unreal_context_event(unreal_context, event, project):
         event['message'] = message
 
     username = runtime_prop.pop('username', None)
-    user = None
     if username is not None:
         set_path(event, 'user', 'username', value=username)
 
@@ -58,8 +57,8 @@ def merge_unreal_context_event(unreal_context, event, project):
     if user_desc is not None:
         event_id = event.setdefault('event_id', uuid.uuid4().hex)
         feedback_user = 'unknown'
-        if user is not None:
-            feedback_user = user.get('username', feedback_user)
+        if username is not None:
+            feedback_user = username
 
         UserReport.objects.create(
             project=project,
diff --git a/tests/sentry/lang/native/test_unreal.py b/tests/sentry/lang/native/test_unreal.py
index 34191604e2..d04333a9e0 100644
--- a/tests/sentry/lang/native/test_unreal.py
+++ b/tests/sentry/lang/native/test_unreal.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 import os
 import zipfile
+import uuid
 
 from six import BytesIO
 from django.core.urlresolvers import reverse
@@ -9,7 +10,7 @@ from django.core.files.uploadedfile import SimpleUploadedFile
 from sentry.testutils import TestCase
 from sentry.lang.native.minidump import MINIDUMP_ATTACHMENT_TYPE
 from sentry.lang.native.unreal import process_unreal_crash, unreal_attachment_type, merge_unreal_context_event, merge_unreal_logs_event
-from sentry.models import Event, EventAttachment
+from sentry.models import Event, EventAttachment, UserReport
 
 
 def get_unreal_crash_file():
@@ -55,6 +56,66 @@ class UnrealIntegrationTest(TestCase):
             assert 'YetAnother' == event['stacktrace']['frames'][2]['package']
             assert 'YetAnother' == event['stacktrace']['frames'][2]['package']
 
+    def test_merge_unreal_context_event_without_user(self):
+        expected_message = 'user comments'
+        context = {
+            'runtime_properties': {
+                'user_description': expected_message
+            }
+        }
+        event = {}
+        merge_unreal_context_event(context, event, self.project)
+
+        user_report = UserReport.objects.get(
+            event_id=event['event_id'],
+            project=self.project,
+        )
+        assert user_report.comments == expected_message
+        assert user_report.name == 'unknown'
+        assert event.get('user') is None
+
+    def test_merge_unreal_context_event_with_user(self):
+        expected_message = 'user comments'
+        expected_username = 'John Doe'
+        context = {
+            'runtime_properties': {
+                'username': expected_username,
+                'user_description': expected_message
+            }
+        }
+        event = {}
+        merge_unreal_context_event(context, event, self.project)
+
+        user_report = UserReport.objects.get(
+            event_id=event['event_id'],
+            project=self.project,
+        )
+        assert user_report.comments == expected_message
+        assert user_report.name == expected_username
+        assert event['user']['username'] == expected_username
+
+    def test_merge_unreal_context_event_without_user_description(self):
+        expected_username = 'Jane Doe'
+        context = {
+            'runtime_properties': {
+                'username': expected_username,
+            }
+        }
+        event = {
+            'event_id': uuid.uuid4().hex
+        }
+        merge_unreal_context_event(context, event, self.project)
+        try:
+            user_report = UserReport.objects.get(
+                event_id=event['event_id'],
+                project=self.project,
+            )
+        except UserReport.DoesNotExist:
+            user_report = None
+
+        assert user_report is None
+        assert event['user']['username'] == expected_username
+
     def test_merge_unreal_logs_event(self):
         with open(get_unreal_crash_file(), 'rb') as f:
             unreal_crash = process_unreal_crash(f.read())
