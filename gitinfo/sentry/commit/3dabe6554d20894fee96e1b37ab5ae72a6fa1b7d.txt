commit 3dabe6554d20894fee96e1b37ab5ae72a6fa1b7d
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Mon Jun 13 21:59:01 2016 +0200

    Defer password expiry for MFA

diff --git a/src/sentry/utils/auth.py b/src/sentry/utils/auth.py
index 22caecc1f5..4813a10c26 100644
--- a/src/sentry/utils/auth.py
+++ b/src/sentry/utils/auth.py
@@ -121,9 +121,6 @@ def login(request, user, passed_2fa=False, after_2fa=None):
     Optionally `after_2fa` can be set to a URL which will be used to override
     the regular session redirect target directly after the 2fa flow.
     """
-    if user.is_password_expired:
-        raise AuthUserPasswordExpired(user)
-
     has_2fa = Authenticator.objects.user_has_2fa(user)
     if has_2fa and not passed_2fa:
         request.session['_pending_2fa'] = [user.id, time.time()]
@@ -133,6 +130,16 @@ def login(request, user, passed_2fa=False, after_2fa=None):
 
     request.session.pop('_pending_2fa', None)
 
+    # Check for expired passwords here after we cleared the 2fa flow.
+    # While this means that users will have to pass 2fa before they can
+    # figure out that their passwords are expired this is still the more
+    # reasonable behavior.
+    #
+    # We also rememebr _after_2fa here so that we can continue the flow if
+    # someone does it in the same browser.
+    if user.is_password_expired:
+        raise AuthUserPasswordExpired(user)
+
     # If there is no authentication backend, just attach the first
     # one and hope it goes through.  This apparently is a thing we
     # have been doing for a long time, just moved it to a more
