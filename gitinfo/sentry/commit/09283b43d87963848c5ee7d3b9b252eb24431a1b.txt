commit 09283b43d87963848c5ee7d3b9b252eb24431a1b
Author: josh <josh@jrl.ninja>
Date:   Wed Jan 15 21:54:09 2020 +0000

    feat(py3): conditional backport installation (#16424)

diff --git a/requirements-base.txt b/requirements-base.txt
index e05b9abd8b..4e7e07f525 100644
--- a/requirements-base.txt
+++ b/requirements-base.txt
@@ -15,9 +15,9 @@ django-sudo>=3.0.0,<4.0.0
 Django>=1.10,<1.11
 djangorestframework==3.6.4
 email-reply-parser>=0.2.0,<0.3.0
-enum34>=1.1.6,<1.2.0
-functools32>=3.2.3,<3.3
-futures>=3.2.0,<4.0.0
+enum34>=1.1.6,<1.2.0 ; python_version < "3.4"
+functools32>=3.2.3,<3.3 ; python_version < "3.2"
+futures>=3.2.0,<4.0.0 ; python_version < "3.2"
 # optional but needed for google stuff below
 google-api-core==1.14.3
 google-auth==1.6.3
@@ -31,7 +31,7 @@ google-cloud-pubsub==0.35.4
 google-cloud-storage==1.13.3
 # broken on python3
 hiredis>=0.1.0,<0.2.0
-ipaddress>=1.0.16,<1.1.0
+ipaddress>=1.0.16,<1.1.0 ; python_version < "3.3"
 jsonschema==2.6.0
 kombu==3.0.35
 loremipsum>=1.0.5,<1.1.0
diff --git a/src/sentry/interfaces/schemas.py b/src/sentry/interfaces/schemas.py
index 8d4fe2168c..653a8c7a4b 100644
--- a/src/sentry/interfaces/schemas.py
+++ b/src/sentry/interfaces/schemas.py
@@ -1,6 +1,6 @@
 from __future__ import absolute_import
 
-from functools32 import lru_cache
+from sentry.utils.compat import functools
 from itertools import groupby
 import jsonschema
 import six
@@ -585,7 +585,7 @@ INTERFACE_SCHEMAS = {
 }
 
 
-@lru_cache(maxsize=100)
+@functools.lru_cache(maxsize=100)
 def validator_for_interface(name):
     if name not in INTERFACE_SCHEMAS:
         return None
diff --git a/src/sentry/loader/browsersdkversion.py b/src/sentry/loader/browsersdkversion.py
index 0bf617b801..057a8ddf31 100644
--- a/src/sentry/loader/browsersdkversion.py
+++ b/src/sentry/loader/browsersdkversion.py
@@ -7,7 +7,7 @@ import json
 import six
 
 from pkg_resources import parse_version
-from functools32 import lru_cache
+from sentry.utils.compat import functools
 
 import sentry
 
@@ -19,7 +19,7 @@ _version_regexp = re.compile(r"^\d+\.\d+\.\d+$")  # We really only want stable r
 LOADER_FOLDER = os.path.abspath(os.path.join(os.path.dirname(sentry.__file__), "loader"))
 
 
-@lru_cache(maxsize=10)
+@functools.lru_cache(maxsize=10)
 def load_registry(path):
     if "/" in path:
         return None
diff --git a/src/sentry/net/socket.py b/src/sentry/net/socket.py
index ac7042a7b8..c0e258c518 100644
--- a/src/sentry/net/socket.py
+++ b/src/sentry/net/socket.py
@@ -3,7 +3,7 @@ from __future__ import absolute_import
 import six
 import ipaddress
 import socket
-from functools32 import lru_cache
+from sentry.utils.compat import functools
 from ssl import wrap_socket
 from six.moves.urllib.parse import urlparse
 
@@ -18,7 +18,7 @@ DISALLOWED_IPS = frozenset(
 )
 
 
-@lru_cache(maxsize=100)
+@functools.lru_cache(maxsize=100)
 def is_ipaddress_allowed(ip):
     """
     Test if a given IP address is allowed or not
diff --git a/src/sentry/utils/compat/__init__.py b/src/sentry/utils/compat/__init__.py
index 260b580438..cea60bf22c 100644
--- a/src/sentry/utils/compat/__init__.py
+++ b/src/sentry/utils/compat/__init__.py
@@ -7,6 +7,12 @@ try:
 except ImportError:
     import pickle  # NOQA
 
+try:
+    # TODO: remove when we drop Python 2.7 compat
+    import functools32 as functools
+except ImportError:
+    import functools  # NOQA
+
 
 def _identity(x):
     return x
