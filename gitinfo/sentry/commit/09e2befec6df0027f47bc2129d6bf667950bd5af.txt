commit 09e2befec6df0027f47bc2129d6bf667950bd5af
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Fri Jul 20 10:43:45 2018 -0700

    feat(discover): Expose groupby in OrganizationDiscover endpoint (#9117)

diff --git a/src/sentry/api/endpoints/organization_discover.py b/src/sentry/api/endpoints/organization_discover.py
index 37e0944041..3c8df1c5d9 100644
--- a/src/sentry/api/endpoints/organization_discover.py
+++ b/src/sentry/api/endpoints/organization_discover.py
@@ -45,6 +45,11 @@ class DiscoverSerializer(serializers.Serializer):
         allow_null=True,
         default=[]
     )
+    groupby = ListField(
+        child=serializers.CharField(),
+        required=False,
+        allow_null=True,
+    )
 
     def __init__(self, *args, **kwargs):
         super(DiscoverSerializer, self).__init__(*args, **kwargs)
@@ -130,12 +135,19 @@ class OrganizationDiscoverEndpoint(OrganizationEndpoint):
 
         selected_columns = [] if has_aggregations else serialized.get('fields')
 
-        groupby = serialized.get('fields') if has_aggregations else []
+        # Make sure that all selected fields are in the group by clause if there
+        # are aggregations
+        groupby = serialized.get('groupby') or []
+        fields = serialized.get('fields') or []
+        if has_aggregations:
+            for field in fields:
+                if field not in groupby:
+                    groupby.append(field)
 
         results = self.do_query(
             serialized.get('start'),
             serialized.get('end'),
-            groupby,
+            groupby=groupby,
             selected_columns=selected_columns,
             conditions=serialized.get('conditions'),
             orderby=serialized.get('orderby'),
diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
index 0699997443..1d6e96409e 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
@@ -98,8 +98,7 @@ export default function createQueryBuilder(initial = {}, organization) {
 
     // Default to all fields if there are none selected, and no aggregation is
     // specified
-    const useDefaultFields =
-      !query.fields.length && !query.aggregations.length && !query.groupby;
+    const useDefaultFields = !query.fields.length && !query.aggregations.length;
 
     const fields = useDefaultFields ? getColumns().map(({name}) => name) : query.fields;
 
