commit 1a7b2e0ce87cc2011cad69734e787b6977d769c5
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Mon Jun 15 15:48:03 2020 +0200

    fix(relay): Update cache when dsns are updated (#19367)

diff --git a/src/sentry/models/projectkey.py b/src/sentry/models/projectkey.py
index 237e32e395..82f2d25062 100644
--- a/src/sentry/models/projectkey.py
+++ b/src/sentry/models/projectkey.py
@@ -23,6 +23,7 @@ from sentry.db.models import (
     JSONField,
     sane_repr,
 )
+from sentry.tasks.relay import schedule_update_config_cache
 
 _uuid4_re = re.compile(r"^[a-f0-9]{32}$")
 
@@ -34,6 +35,18 @@ class ProjectKeyStatus(object):
     INACTIVE = 1
 
 
+class ProjectKeyManager(BaseManager):
+    def post_save(self, instance, **kwargs):
+        schedule_update_config_cache(
+            project_id=instance.project_id, generate=True, update_reason="projectkey.post_save"
+        )
+
+    def post_delete(self, instance, **kwargs):
+        schedule_update_config_cache(
+            project_id=instance.project_id, generate=True, update_reason="projectkey.post_delete"
+        )
+
+
 class ProjectKey(Model):
     __core__ = True
 
@@ -63,7 +76,7 @@ class ProjectKey(Model):
     rate_limit_count = BoundedPositiveIntegerField(null=True)
     rate_limit_window = BoundedPositiveIntegerField(null=True)
 
-    objects = BaseManager(
+    objects = ProjectKeyManager(
         cache_fields=("public_key", "secret_key"),
         # store projectkeys in memcached for longer than other models,
         # specifically to make the relay_projectconfig endpoint faster.
diff --git a/src/sentry/tasks/relay.py b/src/sentry/tasks/relay.py
index e3d6506a99..d7a38ca2c1 100644
--- a/src/sentry/tasks/relay.py
+++ b/src/sentry/tasks/relay.py
@@ -4,7 +4,6 @@ import logging
 
 from django.conf import settings
 
-from sentry.models.projectkey import ProjectKey
 from sentry.tasks.base import instrumented_task
 from sentry.utils import metrics
 from sentry.relay import projectconfig_debounce_cache
@@ -28,7 +27,7 @@ def update_config_cache(generate, organization_id=None, project_id=None, update_
         invalidated.
     """
 
-    from sentry.models import Project
+    from sentry.models import Project, ProjectKey
     from sentry.relay import projectconfig_cache
     from sentry.relay.config import get_project_config
 
diff --git a/tests/sentry/tasks/test_relay.py b/tests/sentry/tasks/test_relay.py
index 7457fb3098..22c006c95e 100644
--- a/tests/sentry/tasks/test_relay.py
+++ b/tests/sentry/tasks/test_relay.py
@@ -8,6 +8,8 @@ from sentry.tasks.relay import schedule_update_config_cache
 from sentry.relay.projectconfig_cache.redis import RedisProjectConfigCache
 from sentry.relay.projectconfig_debounce_cache.redis import RedisProjectConfigDebounceCache
 
+from sentry.models import ProjectKey
+
 
 @pytest.fixture
 def redis_cache(monkeypatch):
@@ -183,3 +185,20 @@ def test_project_get_option_does_not_reload(default_project, task_runner, monkey
                 )
 
     update_config_cache.assert_not_called()  # noqa
+
+
+@pytest.mark.django_db
+def test_projectkeys(default_project, task_runner, redis_cache):
+    with task_runner():
+        ProjectKey.objects.filter(project=default_project).delete()
+        pk = ProjectKey(project=default_project)
+        pk.save()
+
+    (pk_json,) = redis_cache.get(default_project.id)["publicKeys"]
+    assert pk_json["publicKey"] == pk.public_key
+    assert pk_json["isEnabled"]
+
+    with task_runner():
+        pk.delete()
+
+    assert not redis_cache.get(default_project.id)["publicKeys"]
