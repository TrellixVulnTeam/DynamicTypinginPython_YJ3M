commit a98252125df39209521f24c49acce09f29653389
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Fri Sep 13 19:36:29 2019 +0300

    build(docker): Add support for tagging more branches (#14708)
    
    Mostly needed for single-tenant branch for now

diff --git a/docker/hooks/build b/docker/hooks/build
index 07e44d65de..8ba54e9af9 100755
--- a/docker/hooks/build
+++ b/docker/hooks/build
@@ -3,14 +3,18 @@
 set -e;
 
 if [[ -z "$SOURCE_COMMIT" ]]; then
-	export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
-	echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
+    export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
+    echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
 fi
 
 echo "SOURCE_COMMIT: $SOURCE_COMMIT";
 cd $(git rev-parse --show-toplevel);
 
 git archive --format=tar.gz -o context.tar.gz $SOURCE_COMMIT
-docker build --build-arg SOURCE_COMMIT="$SOURCE_COMMIT" -t "$DOCKER_REPO:$SOURCE_COMMIT" -t "$DOCKER_REPO:latest" -f "./docker/Dockerfile" - < context.tar.gz
-docker build -t "$DOCKER_REPO:$SOURCE_COMMIT-onbuild" -t "$DOCKER_REPO:latest-onbuild" -f "./docker/onbuild/Dockerfile" - < context.tar.gz
+docker build --build-arg SOURCE_COMMIT="$SOURCE_COMMIT" -t "$DOCKER_REPO:$SOURCE_COMMIT" -t "$DOCKER_REPO:$DOCKER_TAG" -f "./docker/Dockerfile" - < context.tar.gz
+
+if [ "$SOURCE_BRANCH" == "master" ]; then
+    docker build -t "$DOCKER_REPO:$SOURCE_COMMIT-onbuild" -t "$DOCKER_REPO:$DOCKER_TAG-onbuild" -f "./docker/onbuild/Dockerfile" - < context.tar.gz
+fi
+
 rm context.tar.gz || true
diff --git a/docker/hooks/post_push b/docker/hooks/post_push
index ca49b919e5..1cdddf3e65 100755
--- a/docker/hooks/post_push
+++ b/docker/hooks/post_push
@@ -3,11 +3,15 @@
 set -e;
 
 if [[ -z "$SOURCE_COMMIT" ]]; then
-	export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
-	echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
+    export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
+    echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
 fi
 
 echo "SOURCE_COMMIT: $SOURCE_COMMIT";
 
 docker push "$DOCKER_REPO:$SOURCE_COMMIT"
-docker push "$DOCKER_REPO:$SOURCE_COMMIT-onbuild"
+
+if [ "$SOURCE_BRANCH" == "master" ]; then
+    docker push "$DOCKER_REPO:$SOURCE_COMMIT-onbuild";
+    docker push "$DOCKER_REPO:$DOCKER_TAG-onbuild";
+fi
