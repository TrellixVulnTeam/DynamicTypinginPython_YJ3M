commit da8273c9ede480e3afddff3b985f112404ddf305
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Tue Nov 14 11:48:26 2017 -0600

    db: Remove EventTag relation to TagKey in deletions (to drop unncessary index)

diff --git a/src/sentry/tagstore/legacy/deletions.py b/src/sentry/tagstore/legacy/deletions.py
index cff982bcef..5fce861923 100644
--- a/src/sentry/tagstore/legacy/deletions.py
+++ b/src/sentry/tagstore/legacy/deletions.py
@@ -12,7 +12,7 @@ from sentry.deletions.base import ModelDeletionTask, ModelRelation
 
 class TagKeyDeletionTask(ModelDeletionTask):
     def get_child_relations(self, instance):
-        from .models import (EventTag, GroupTagKey, GroupTagValue, TagValue)
+        from .models import (GroupTagKey, GroupTagValue, TagValue)
 
         # in bulk
         model_list = (GroupTagValue, GroupTagKey, TagValue)
@@ -22,12 +22,6 @@ class TagKeyDeletionTask(ModelDeletionTask):
                 'key': instance.key,
             }) for m in model_list
         ]
-        relations.append(
-            ModelRelation(EventTag, {
-                'project_id': instance.project_id,
-                'key_id': instance.id,
-            })
-        )
         return relations
 
     def mark_deletion_in_progress(self, instance_list):
diff --git a/tests/sentry/deletions/test_tagkey.py b/tests/sentry/deletions/test_tagkey.py
index 0a8802ced8..7eebb282f5 100644
--- a/tests/sentry/deletions/test_tagkey.py
+++ b/tests/sentry/deletions/test_tagkey.py
@@ -83,9 +83,9 @@ class DeleteTagKeyTest(TestCase):
             assert False  # verify exception thrown
         except tagstore.TagKeyNotFound:
             pass
-        assert not tagstore.get_event_tag_qs(key_id=tk.id).exists()
 
         assert tagstore.get_tag_key(project2.id, key) is not None
         assert tagstore.get_group_tag_key(group2.id, key) is not None
         assert tagstore.get_group_tag_value(group2.id, key, value) is not None
+        assert tagstore.get_event_tag_qs(key_id=tk.id).exists()
         assert tagstore.get_event_tag_qs(key_id=tk2.id).exists()
diff --git a/tests/sentry/tasks/test_deletion.py b/tests/sentry/tasks/test_deletion.py
index adb3f9fd4f..2ea823cace 100644
--- a/tests/sentry/tasks/test_deletion.py
+++ b/tests/sentry/tasks/test_deletion.py
@@ -239,6 +239,7 @@ class DeleteTagKeyTest(TestCase):
         with self.tasks():
             delete_tag_key(object_id=tk.id)
 
+            assert tagstore.get_event_tag_qs(key_id=tk.id).exists()
             try:
                 tagstore.get_group_tag_value(group.id, key, value)
                 assert False  # verify exception thrown
@@ -254,7 +255,6 @@ class DeleteTagKeyTest(TestCase):
                 assert False  # verify exception thrown
             except tagstore.TagValueNotFound:
                 pass
-            assert not tagstore.get_event_tag_qs(key_id=tk.id).exists()
             try:
                 tagstore.get_tag_key(project.id, key)
                 assert False  # verify exception thrown
