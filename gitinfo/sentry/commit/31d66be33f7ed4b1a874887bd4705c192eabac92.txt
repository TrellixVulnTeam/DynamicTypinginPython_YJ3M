commit 31d66be33f7ed4b1a874887bd4705c192eabac92
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Mon Feb 6 16:57:06 2017 -0800

    handle generated release versions that are too long (#4872)

diff --git a/bin/merge_legacy_releases b/bin/merge_legacy_releases
index 90271acabe..a570a7bda0 100644
--- a/bin/merge_legacy_releases
+++ b/bin/merge_legacy_releases
@@ -47,7 +47,7 @@ def is_word_and_date(version):
 def update_version(release):
     old_version = release.version
     project_slug = release.projects.values_list('slug', flat=True)[0]
-    new_version = '%s-%s' % (project_slug, old_version)
+    new_version = ('%s-%s' % (project_slug, old_version))[:64]
     Release.objects.filter(
         id=release.id
     ).update(version=new_version)
diff --git a/src/sentry/models/release.py b/src/sentry/models/release.py
index 9d8a76692d..b41587af64 100644
--- a/src/sentry/models/release.py
+++ b/src/sentry/models/release.py
@@ -108,7 +108,7 @@ class Release(Model):
         if release in (None, -1):
             # TODO(dcramer): if the cache result is -1 we could attempt a
             # default create here instead of default get
-            project_version = '%s-%s' % (project.slug, version)
+            project_version = ('%s-%s' % (project.slug, version))[:64]
             releases = list(cls.objects.filter(
                 organization_id=project.organization_id,
                 version__in=[version, project_version],
diff --git a/src/sentry/south_migrations/0291_merge_legacy_releases.py b/src/sentry/south_migrations/0291_merge_legacy_releases.py
index b2b2ef0ed3..947c447d7a 100644
--- a/src/sentry/south_migrations/0291_merge_legacy_releases.py
+++ b/src/sentry/south_migrations/0291_merge_legacy_releases.py
@@ -95,7 +95,7 @@ def merge(to_release, from_releases, sentry_models):
 def update_version(release, sentry_models):
     old_version = release.version
     project_slug = release.projects.values_list('slug', flat=True)[0]
-    new_version = '%s-%s' % (project_slug, old_version)
+    new_version = ('%s-%s' % (project_slug, old_version))[:64]
     sentry_models.Release.objects.filter(
         id=release.id
     ).update(version=new_version)
diff --git a/tests/sentry/test_event_manager.py b/tests/sentry/test_event_manager.py
index 6bf35888f2..0c29952cdc 100644
--- a/tests/sentry/test_event_manager.py
+++ b/tests/sentry/test_event_manager.py
@@ -459,6 +459,22 @@ class EventManagerTest(TransactionTestCase):
         group = event.group
         assert group.first_release.version == 'foo-1.0'
 
+    def test_release_project_slug_long(self):
+        project = self.create_project(name='foo')
+        release = Release.objects.create(
+            version='foo-%s' % ('a' * 60,),
+            organization=project.organization
+        )
+        release.add_project(project)
+
+        manager = EventManager(self.make_event(release=('a' * 61)))
+        event = manager.save(project.id)
+
+        group = event.group
+        assert group.first_release.version == 'foo-%s' % ('a' * 60,)
+        release_tag = [v for k, v in event.tags if k == 'sentry:release'][0]
+        assert release_tag == 'foo-%s' % ('a' * 60,)
+
     def test_group_release_no_env(self):
         manager = EventManager(self.make_event(release='1.0'))
         event = manager.save(1)
