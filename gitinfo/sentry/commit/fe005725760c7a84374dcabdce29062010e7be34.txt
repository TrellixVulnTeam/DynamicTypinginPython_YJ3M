commit fe005725760c7a84374dcabdce29062010e7be34
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 17 19:46:35 2013 -0800

    Add scraping support on event creation

diff --git a/src/sentry/conf/defaults.py b/src/sentry/conf/defaults.py
index 7341a80e64..ccfa6ef86b 100644
--- a/src/sentry/conf/defaults.py
+++ b/src/sentry/conf/defaults.py
@@ -157,6 +157,9 @@ ALLOW_ORIGIN = None
 # Enable capturing of JavaScript errors (Sentry internal errors)
 USE_JS_CLIENT = False
 
+# Enable scraping of javascript context for source code
+SCRAPE_JAVASCRIPT_CONTEXT = True
+
 # The alias for the cache backend (MUST be a compatible backend string for < 1.3)
 CACHE_BACKEND = 'dummy://'
 
diff --git a/src/sentry/manager.py b/src/sentry/manager.py
index 83e44ee971..2390a3aa99 100644
--- a/src/sentry/manager.py
+++ b/src/sentry/manager.py
@@ -36,6 +36,7 @@ from sentry.constants import STATUS_RESOLVED, STATUS_UNRESOLVED
 from sentry.processors.base import send_group_processors
 from sentry.signals import regression_signal
 from sentry.tasks.index import index_event
+from sentry.tasks.fetch_source import fetch_javascript_source
 from sentry.utils.cache import cache, Lock
 from sentry.utils.dates import get_sql_date_trunc
 from sentry.utils.db import get_db_engine, has_charts, resolve_expression_node
@@ -525,6 +526,13 @@ class GroupManager(BaseManager, ChartMixin):
                 transaction.rollback_unless_managed(using=group._state.db)
                 logger.exception(u'Error indexing document: %s', e)
 
+        if settings.SCRAPE_JAVASCRIPT_CONTEXT and event.platform == 'javascript' and not is_sample:
+            try:
+                maybe_delay(fetch_javascript_source, event)
+            except Exception, e:
+                transaction.rollback_unless_managed(using=group._state.db)
+                logger.exception(u'Error fetching javascript source: %s', e)
+
         if is_new:
             try:
                 regression_signal.send_robust(sender=self.model, instance=group)
diff --git a/tests/sentry/manager/tests.py b/tests/sentry/manager/tests.py
index 166da75749..3c0cf1a584 100644
--- a/tests/sentry/manager/tests.py
+++ b/tests/sentry/manager/tests.py
@@ -216,6 +216,14 @@ class SentryManagerTest(TestCase):
         self.assertEquals(group.last_seen.replace(microsecond=0), event.datetime.replace(microsecond=0))
         self.assertEquals(group.message, 'foo bar')
 
+    @mock.patch('sentry.manager.maybe_delay')
+    def test_scrapes_javascript_source(self, maybe_delay):
+        from sentry.tasks.fetch_source import fetch_javascript_source
+        with self.Settings(SENTRY_SCRAPE_JAVASCRIPT_CONTEXT=True):
+            event = Group.objects.from_kwargs(1, message='hello', platform='javascript')
+
+            maybe_delay.assert_any_call(fetch_javascript_source, event)
+
     def test_add_tags(self):
         event = Group.objects.from_kwargs(1, message='rrr')
         group = event.group
