commit b8bf234b4ff6ec9d6baf0e895b923e358731fed4
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jun 26 18:54:58 2013 -0700

    Save and use email values

diff --git a/src/sentry/plugins/bases/notify.py b/src/sentry/plugins/bases/notify.py
index 15a37506e9..edd14176c8 100644
--- a/src/sentry/plugins/bases/notify.py
+++ b/src/sentry/plugins/bases/notify.py
@@ -69,20 +69,29 @@ class NotificationPlugin(Plugin):
 
         return member_set
 
-    def get_emails_for_users(self, user_ids):
+    def get_emails_for_users(self, user_ids, project=None):
         email_list = set()
         user_ids = set(user_ids)
 
-        # we cant use values on alert_queryset as the value field gets encoded
-        alert_queryset = UserOption.objects.filter(
-            user__in=user_ids,
-            key='alert_email',
-        )
-        for option in alert_queryset:
-            user_ids.remove(option.user_id)
-            email_list.add(option.value)
+        if project:
+            alert_queryset = UserOption.objects.filter(
+                project=project,
+                user__in=user_ids,
+                key='mail:email',
+            )
+            for option in alert_queryset:
+                user_ids.remove(option.user_id)
+                email_list.add(option.value)
+
+        if user_ids:
+            alert_queryset = UserOption.objects.filter(
+                user__in=user_ids,
+                key='alert_email',
+            )
+            for option in alert_queryset:
+                user_ids.remove(option.user_id)
+                email_list.add(option.value)
 
-        # if any didnt exist, grab their default email
         if user_ids:
             email_list |= set(User.objects.filter(
                 pk__in=user_ids, is_active=True
@@ -112,7 +121,8 @@ class NotificationPlugin(Plugin):
 
             if project and project.team:
                 member_set = self.get_sendable_users(project)
-                send_to_list |= set(self.get_emails_for_users(member_set))
+                send_to_list |= set(self.get_emails_for_users(
+                    member_set, project=project))
 
             send_to_list = filter(bool, send_to_list)
             cache.set(cache_key, send_to_list, 60)  # 1 minute cache
diff --git a/src/sentry/templates/sentry/account/notifications.html b/src/sentry/templates/sentry/account/notifications.html
index 29e685dacd..ddd0f7ef8a 100644
--- a/src/sentry/templates/sentry/account/notifications.html
+++ b/src/sentry/templates/sentry/account/notifications.html
@@ -19,6 +19,21 @@
         padding-bottom: 10px;
     }
     </style>
+    <script>
+    $(function(){
+        $('form a[data-toggle=change-target-value]').click(function(){
+            var $this = $(this);
+            var $target = $('#' + $this.data('target'));
+            var result = window.prompt('Enter an email address', $target.val());
+            $target.val(result || '');
+            if (result !== null) {
+                $this.text(result);
+            } else {
+                $this.html('<em>default</em>');
+            }
+        })
+    });
+    </script>
 
     <form action="" method="post">
         {% csrf_token %}
@@ -63,7 +78,10 @@
                     <tr>
                         <td>{{ form.alert }}</td>
                         <td><label for="{{ form.alert.auto_id }}">{{ project.name }}</label></td>
-                        <td style="text-align:right"><a href="#"><em>default</em></a></td>
+                        <td style="text-align:right">
+                            <a href="javascript:void(0)" data-target="{{ form.email.auto_id }}" data-toggle="change-target-value">{% if form.email.value %}{{ form.email.value }}{% else %}<em>default</em>{% endif %}</a>
+                            {{ form.email }}
+                        </td>
                     </tr>
                 {% endfor %}
                 </tbody></table>
diff --git a/src/sentry/web/forms/accounts.py b/src/sentry/web/forms/accounts.py
index 3eb10a08f6..2753cf61ce 100644
--- a/src/sentry/web/forms/accounts.py
+++ b/src/sentry/web/forms/accounts.py
@@ -158,7 +158,7 @@ class ChangePasswordRecoverForm(forms.Form):
 
 class ProjectEmailOptionsForm(forms.Form):
     alert = forms.BooleanField(required=False)
-    email = forms.EmailField(required=False)
+    email = forms.EmailField(required=False, widget=forms.HiddenInput())
 
     def __init__(self, project, user, *args, **kwargs):
         self.project = project
@@ -174,9 +174,15 @@ class ProjectEmailOptionsForm(forms.Form):
             is_enabled = bool(is_enabled)
 
         self.fields['alert'].initial = is_enabled
+        self.fields['email'].initial = UserOption.objects.get_value(
+            user, project, 'mail:email', None)
 
     def save(self):
         UserOption.objects.set_value(
             self.user, self.project, 'mail:alert',
             int(self.cleaned_data['alert']),
         )
+        UserOption.objects.set_value(
+            self.user, self.project, 'mail:email',
+            self.cleaned_data['email'],
+        )
diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index bba79f5a31..175e1f727b 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -7,8 +7,6 @@ sentry.web.frontend.accounts
 """
 import itertools
 
-from collections import defaultdict
-
 from django.conf import settings as dj_settings
 from django.contrib import messages
 from django.contrib.auth import login as login_user, authenticate
