commit 77d5d87dbecb21925b8f49f2d0be75df314d0e0d
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Wed Jan 16 11:52:57 2019 -0800

    ref(issues): Refactor group similarity components (#11539)
    
    Group similarity components no longer reference project state and
    conditionally render different links depending on whether we are in a
    single project or multi project context.

diff --git a/src/sentry/static/sentry/app/routes.jsx b/src/sentry/static/sentry/app/routes.jsx
index d00a5815ea..fd1d75ac5c 100644
--- a/src/sentry/static/sentry/app/routes.jsx
+++ b/src/sentry/static/sentry/app/routes.jsx
@@ -7,7 +7,7 @@ import ProjectGroupDetails from 'app/views/groupDetails/project/index';
 import ProjectGroupEvents from 'app/views/groupDetails/project/groupEvents';
 import ProjectGroupEventDetails from 'app/views/groupDetails/project/groupEventDetails';
 import ProjectGroupMergedView from 'app/views/groupDetails/shared/groupMerged';
-import ProjectGroupSimilarView from 'app/views/groupDetails/project/groupSimilar';
+import ProjectGroupSimilarView from 'app/views/groupDetails/shared/groupSimilar';
 import ProjectGroupTagValues from 'app/views/groupDetails/project/groupTagValues';
 import ProjectGroupTags from 'app/views/groupDetails/project/groupTags';
 import ProjectGroupUserFeedback from 'app/views/groupDetails/project/groupUserFeedback';
diff --git a/src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/index.jsx b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx
similarity index 86%
rename from src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/index.jsx
rename to src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx
index 5749f66795..db82de1ee3 100644
--- a/src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/index.jsx
+++ b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx
@@ -5,12 +5,12 @@ import Reflux from 'reflux';
 import createReactClass from 'create-react-class';
 import queryString from 'query-string';
 
+import SentryTypes from 'app/sentryTypes';
 import {t} from 'app/locale';
 import GroupingActions from 'app/actions/groupingActions';
 import GroupingStore from 'app/stores/groupingStore';
 import LoadingError from 'app/components/loadingError';
 import LoadingIndicator from 'app/components/loadingIndicator';
-import ProjectState from 'app/mixins/projectState';
 
 import SimilarList from './similarList';
 
@@ -18,10 +18,11 @@ const GroupGroupingView = createReactClass({
   displayName: 'GroupGroupingView',
 
   propTypes: {
+    project: SentryTypes.Project,
     query: PropTypes.string,
   },
 
-  mixins: [ProjectState, Reflux.listenTo(GroupingStore, 'onGroupingUpdate')],
+  mixins: [Reflux.listenTo(GroupingStore, 'onGroupingUpdate')],
 
   getInitialState() {
     return {
@@ -65,9 +66,10 @@ const GroupGroupingView = createReactClass({
     } else if (mergedParent && mergedParent !== this.props.params.groupId) {
       let {params} = this.props;
       // Merge success, since we can't specify target, we need to redirect to new parent
-      browserHistory.push(
-        `/${params.orgId}/${params.projectId}/issues/${mergedParent}/similar/`
-      );
+      let baseUrl = params.projectId
+        ? `/${params.orgId}/${params.projectId}/issues/`
+        : `/organizations/${params.orgId}/issues/`;
+      browserHistory.push(`${baseUrl}${mergedParent}/similar/`);
     }
   },
 
@@ -77,12 +79,15 @@ const GroupGroupingView = createReactClass({
       ...this.props.location.query,
       limit: 50,
     };
+
     return `/issues/${params.groupId}/${type}/?${queryString.stringify(queryParams)}`;
   },
 
-  fetchData() {
-    let projectFeatures = this.getProjectFeatures();
+  hasSimilarityFeature() {
+    return new Set(this.props.project.features).has('similarity-view');
+  },
 
+  fetchData() {
     this.setState({
       loading: true,
       error: false,
@@ -90,7 +95,7 @@ const GroupGroupingView = createReactClass({
 
     let reqs = [];
 
-    if (projectFeatures.has('similarity-view')) {
+    if (this.hasSimilarityFeature()) {
       reqs.push({
         endpoint: this.getEndpoint('similar'),
         dataKey: 'similar',
@@ -113,13 +118,12 @@ const GroupGroupingView = createReactClass({
   },
 
   render() {
-    let {orgId, projectId, groupId} = this.props.params;
+    let {orgId, groupId} = this.props.params;
     let isLoading = this.state.loading;
     let isError = this.state.error && !isLoading;
     let isLoadedSuccessfully = !isError && !isLoading;
-    let projectFeatures = this.getProjectFeatures();
     let hasSimilarItems =
-      projectFeatures.has('similarity-view') &&
+      this.hasSimilarityFeature() &&
       (this.state.similarItems.length >= 0 ||
         this.state.filteredSimilarItems.length >= 0) &&
       isLoadedSuccessfully;
@@ -147,7 +151,6 @@ const GroupGroupingView = createReactClass({
             filteredItems={this.state.filteredSimilarItems}
             onMerge={this.handleMerge}
             orgId={orgId}
-            projectId={projectId}
             groupId={groupId}
             pageLinks={this.state.similarLinks}
           />
diff --git a/src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarItem.jsx b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarItem.jsx
similarity index 100%
rename from src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarItem.jsx
rename to src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarItem.jsx
diff --git a/src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarList.jsx b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarList.jsx
similarity index 97%
rename from src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarList.jsx
rename to src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarList.jsx
index 007db8d239..27ff1447ea 100644
--- a/src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarList.jsx
+++ b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarList.jsx
@@ -22,9 +22,7 @@ const SimilarItemPropType = PropTypes.shape({
 
 class SimilarList extends React.Component {
   static propTypes = {
-    orgId: PropTypes.string.isRequired,
     groupId: PropTypes.string.isRequired,
-    projectId: PropTypes.string.isRequired,
     onMerge: PropTypes.func.isRequired,
     pageLinks: PropTypes.string,
     items: PropTypes.arrayOf(SimilarItemPropType),
diff --git a/src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarToolbar.jsx b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarToolbar.jsx
similarity index 100%
rename from src/sentry/static/sentry/app/views/groupDetails/project/groupSimilar/similarToolbar.jsx
rename to src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/similarToolbar.jsx
diff --git a/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap b/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap
index 74956a3aea..21f173bb0d 100644
--- a/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap
+++ b/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap
@@ -26,6 +26,21 @@ exports[`Issues Similar View renders with mocked data 1`] = `
       "projectId": "project-slug",
     }
   }
+  project={
+    Object {
+      "features": Array [
+        "similarity-view",
+      ],
+      "hasAccess": true,
+      "id": "2",
+      "isBookmarked": false,
+      "isMember": true,
+      "name": "Project Name",
+      "slug": "project-slug",
+      "teams": Array [],
+    }
+  }
+  query=""
 >
   <div>
     <div
@@ -281,7 +296,6 @@ exports[`Issues Similar View renders with mocked data 1`] = `
       }
       onMerge={[Function]}
       orgId="org-slug"
-      projectId="project-slug"
     >
       <div
         className="similar-list-container"
diff --git a/tests/js/spec/views/groupDetails/groupSimilar.spec.jsx b/tests/js/spec/views/groupDetails/groupSimilar.spec.jsx
index 21915d1987..f67f01b570 100644
--- a/tests/js/spec/views/groupDetails/groupSimilar.spec.jsx
+++ b/tests/js/spec/views/groupDetails/groupSimilar.spec.jsx
@@ -3,14 +3,11 @@ import React from 'react';
 
 import {mount, shallow} from 'enzyme';
 
-import GroupSimilarView from 'app/views/groupDetails/project/groupSimilar';
+import GroupSimilar from 'app/views/groupDetails/shared/groupSimilar';
 import issues from 'app-test/mocks/issues';
 
-jest.mock('app/mixins/projectState', () => {
-  return {
-    getFeatures: () => new Set([]),
-    getProjectFeatures: () => new Set(['similarity-view']),
-  };
+const project = TestStubs.Project({
+  features: ['similarity-view'],
 });
 
 const routerContext = TestStubs.routerContext([
@@ -47,7 +44,7 @@ describe('Issues Similar View', function() {
 
   it('renders initially with loading component', function() {
     let component = shallow(
-      <GroupSimilarView params={{groupId: 'group-id'}} location={{}} />,
+      <GroupSimilar project={project} params={{groupId: 'group-id'}} location={{}} />,
       routerContext
     );
 
@@ -56,7 +53,9 @@ describe('Issues Similar View', function() {
 
   it('renders with mocked data', async function() {
     let wrapper = mount(
-      <GroupSimilarView
+      <GroupSimilar
+        project={project}
+        query={''}
         params={{orgId: 'org-slug', projectId: 'project-slug', groupId: 'group-id'}}
         location={{}}
       />,
@@ -72,7 +71,8 @@ describe('Issues Similar View', function() {
 
   it('can merge and redirect to new parent', async function() {
     let wrapper = mount(
-      <GroupSimilarView
+      <GroupSimilar
+        project={project}
         params={{orgId: 'org-slug', projectId: 'project-slug', groupId: 'group-id'}}
         location={{}}
       />,
