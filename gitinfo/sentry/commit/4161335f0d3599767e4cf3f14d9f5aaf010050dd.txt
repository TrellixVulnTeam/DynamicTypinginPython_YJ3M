commit 4161335f0d3599767e4cf3f14d9f5aaf010050dd
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 14 13:58:27 2016 -0800

    Exclude DeleteAborted in retries

diff --git a/src/sentry/tasks/base.py b/src/sentry/tasks/base.py
index 9e037edb7a..02f1639923 100644
--- a/src/sentry/tasks/base.py
+++ b/src/sentry/tasks/base.py
@@ -59,12 +59,25 @@ def instrumented_task(name, stat_suffix=None, **kwargs):
     return wrapped
 
 
-def retry(func):
-    @wraps(func)
-    def wrapped(*args, **kwargs):
-        try:
-            return func(*args, **kwargs)
-        except Exception as exc:
-            Raven.captureException()
-            current.retry(exc=exc)
-    return wrapped
+def retry(func=None, on=(Exception, ), exclude=()):
+    """
+    >>> @retry(on=(Exception,), exclude=(AnotherException,))
+    >>> def my_task():
+    >>>     ...
+    """
+
+    if func:
+        return retry()(func)
+
+    def inner(func):
+        @wraps(func)
+        def wrapped(*args, **kwargs):
+            try:
+                return func(*args, **kwargs)
+            except exclude:
+                raise
+            except on as exc:
+                Raven.captureException()
+                current.retry(exc=exc)
+        return wrapped
+    return inner
diff --git a/src/sentry/tasks/deletion.py b/src/sentry/tasks/deletion.py
index 9492660503..78bc3d9c99 100644
--- a/src/sentry/tasks/deletion.py
+++ b/src/sentry/tasks/deletion.py
@@ -20,7 +20,7 @@ logger = get_task_logger(__name__)
 
 @instrumented_task(name='sentry.tasks.deletion.delete_organization', queue='cleanup',
                    default_retry_delay=60 * 5, max_retries=None)
-@retry
+@retry(exclude=(DeleteAborted,))
 def delete_organization(object_id, continuous=True, **kwargs):
     from sentry.models import (
         Organization, OrganizationMember, OrganizationStatus, Team, TeamStatus
@@ -58,7 +58,7 @@ def delete_organization(object_id, continuous=True, **kwargs):
 
 @instrumented_task(name='sentry.tasks.deletion.delete_team', queue='cleanup',
                    default_retry_delay=60 * 5, max_retries=None)
-@retry
+@retry(exclude=(DeleteAborted,))
 def delete_team(object_id, continuous=True, **kwargs):
     from sentry.models import Team, TeamStatus, Project, ProjectStatus
 
@@ -88,7 +88,7 @@ def delete_team(object_id, continuous=True, **kwargs):
 
 @instrumented_task(name='sentry.tasks.deletion.delete_project', queue='cleanup',
                    default_retry_delay=60 * 5, max_retries=None)
-@retry
+@retry(exclude=(DeleteAborted,))
 def delete_project(object_id, continuous=True, **kwargs):
     from sentry.models import (
         Project, ProjectKey, ProjectStatus, TagKey, TagValue, GroupTagKey,
@@ -138,7 +138,7 @@ def delete_project(object_id, continuous=True, **kwargs):
 
 @instrumented_task(name='sentry.tasks.deletion.delete_group', queue='cleanup',
                    default_retry_delay=60 * 5, max_retries=None)
-@retry
+@retry(exclude=(DeleteAborted,))
 def delete_group(object_id, continuous=True, **kwargs):
     from sentry.models import (
         EventMapping, Group, GroupHash, GroupRuleStatus, GroupStatus,
@@ -174,7 +174,7 @@ def delete_group(object_id, continuous=True, **kwargs):
 
 @instrumented_task(name='sentry.tasks.deletion.delete_tag_key', queue='cleanup',
                    default_retry_delay=60 * 5, max_retries=None)
-@retry
+@retry(exclude=(DeleteAborted,))
 def delete_tag_key(object_id, continuous=True, **kwargs):
     from sentry.models import (
         GroupTagKey, GroupTagValue, TagKey, TagKeyStatus, TagValue
