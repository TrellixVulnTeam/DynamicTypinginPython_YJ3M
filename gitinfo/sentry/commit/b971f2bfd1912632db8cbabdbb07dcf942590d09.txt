commit b971f2bfd1912632db8cbabdbb07dcf942590d09
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Fri Feb 8 16:52:54 2019 +0100

    fix: Perf improvements to clear_expired_raw_events (#11974)

diff --git a/src/sentry/tasks/reprocessing.py b/src/sentry/tasks/reprocessing.py
index 0406222280..77c7e48c37 100644
--- a/src/sentry/tasks/reprocessing.py
+++ b/src/sentry/tasks/reprocessing.py
@@ -64,13 +64,15 @@ def clear_expired_raw_events():
         #
         # Better to delete a few rows than none.
         while True:
-            result = model_cls.objects.filter(**filter)[:200]
-            if not result.exists():
+            # Django already loads this into memory, might as well do it
+            # explicitly. Makes check for result emptyness cheaper.
+            result = set(model_cls.objects.filter(**filter)[:200].values_list('pk', flat=True))
+            if not result:
                 break
 
             # Django ORM can't do delete with limit
             model_cls.objects.filter(
-                pk__in=result.values_list('pk')
+                pk__in=result
             ).delete()
 
     cutoff = timezone.now() - \
