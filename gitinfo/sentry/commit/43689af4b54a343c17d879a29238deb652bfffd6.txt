commit 43689af4b54a343c17d879a29238deb652bfffd6
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Fri May 24 09:44:40 2019 -0700

    feat(ui): Add chart icon for Incident closed [SEN-684] (#13367)
    
    Adds a green icon on Incident details chart for when Incident has been closed.
    
    Fixes SEN-684

diff --git a/src/sentry/static/sentry/app/views/organizationIncidents/details/body.jsx b/src/sentry/static/sentry/app/views/organizationIncidents/details/body.jsx
index 11026766a9..35213e5ea7 100644
--- a/src/sentry/static/sentry/app/views/organizationIncidents/details/body.jsx
+++ b/src/sentry/static/sentry/app/views/organizationIncidents/details/body.jsx
@@ -16,11 +16,34 @@ import theme from 'app/utils/theme';
 import Activity from './activity';
 import IncidentsSuspects from './suspects';
 import detectedSymbol from './detectedSymbol';
+import closedSymbol from './closedSymbol';
 
 const TABS = {
   activity: {name: t('Activity'), component: Activity},
 };
 
+/**
+ * So we'll have to see how this looks with real data, but echarts requires
+ * an explicit (x,y) value to draw a symbol (incident detected/closed bubble).
+ *
+ * This uses the closest date *without* going over.
+ *
+ * AFAICT we can't give it an x-axis value and have it draw on the line,
+ * so we probably need to calculate the y-axis value ourselves if we want it placed
+ * at the exact time.
+ */
+function getNearbyIndex(data, needle) {
+  // `data` is sorted, return the first index whose value (timestamp) is > `needle`
+  const index = data.findIndex(([ts]) => ts > needle);
+
+  // this shouldn't happen, as we try to buffer dates before start/end dates
+  if (index === 0) {
+    return 0;
+  }
+
+  return index !== -1 ? index - 1 : data.length - 1;
+}
+
 export default class DetailsBody extends React.Component {
   static propTypes = {
     incident: SentryTypes.Incident,
@@ -40,11 +63,6 @@ export default class DetailsBody extends React.Component {
     const {activeTab} = this.state;
     const ActiveComponent = TABS[activeTab].component;
 
-    const detectedTs = incident && moment.utc(incident.dateStarted).unix();
-    const closestTimestampIndex =
-      incident &&
-      (incident.eventStats.data.findIndex(([ts], i) => ts > detectedTs) ||
-        incident.eventStats.data.length - 1);
     const chartData =
       incident &&
       incident.eventStats.data.map(([ts, val], i) => {
@@ -53,7 +71,19 @@ export default class DetailsBody extends React.Component {
           val.length ? val.reduce((acc, {count} = {count: 0}) => acc + count, 0) : 0,
         ];
       });
-    const markPointCoordinate = chartData && chartData[closestTimestampIndex];
+
+    const detectedTs = incident && moment.utc(incident.dateDetected).unix();
+    const closedTs =
+      incident && incident.dateClosed && moment.utc(incident.dateClosed).unix();
+
+    const nearbyDetectedTimestampIndex =
+      detectedTs && getNearbyIndex(incident.eventStats.data, detectedTs);
+    const nearbyClosedTimestampIndex =
+      closedTs && getNearbyIndex(incident.eventStats.data, closedTs);
+
+    const detectedCoordinate = chartData && chartData[nearbyDetectedTimestampIndex];
+    const closedCoordinate =
+      chartData && closedTs && chartData[nearbyClosedTimestampIndex];
 
     return (
       <StyledPageContent>
@@ -89,12 +119,22 @@ export default class DetailsBody extends React.Component {
                     seriesName: t('Events'),
                     dataArray: chartData,
                     markPoint: MarkPoint({
-                      symbol: `image://${detectedSymbol}`,
                       data: [
                         {
+                          symbol: `image://${detectedSymbol}`,
                           name: t('Incident Detected'),
-                          coord: markPointCoordinate,
+                          coord: detectedCoordinate,
                         },
+                        ...(closedTs
+                          ? [
+                              {
+                                symbol: `image://${closedSymbol}`,
+                                symbolSize: 24,
+                                name: t('Incident Closed'),
+                                coord: closedCoordinate,
+                              },
+                            ]
+                          : []),
                       ],
                     }),
                   },
diff --git a/src/sentry/static/sentry/app/views/organizationIncidents/details/closedSymbol.jsx b/src/sentry/static/sentry/app/views/organizationIncidents/details/closedSymbol.jsx
new file mode 100644
index 0000000000..686f2c50e4
--- /dev/null
+++ b/src/sentry/static/sentry/app/views/organizationIncidents/details/closedSymbol.jsx
@@ -0,0 +1,4 @@
+const closedSymbol =
+  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGEAAABgCAMAAAA6hOw0AAABKVBMVEUAAABOsYlOxIlSuI9cwo9aupFawYpawZFRvI1XvYpXvY9Vuo5ZvopZvo5VvotVvo9YvotYvo9XvIpXv41Wwo1ZwpBVv49Yv4xYv41Xv4tXv45av4tXwYxWvItWv41Yv45YwYtXvYxXv4xXv49YvYtWv41Yv41WvoxYvoxYwIxWv45Zv4xZv45Yvo5YwI5Xv41Yvo9YwI1VvoxXvIxXvoxWvo1YvYxYv4xXvoxXwIxZvoxZwIxZwI5WvYtWv41XvoxXvo1ZvoxXv41WvYxWv4xYvYxYv4xWvY1Yvo1YwI5XvoxYvoxWv41Yv41Zv41XvoxYvo5YwI5XvY1Xvo1Xv41Xvo1Yvo1Wvo1Yvo1YwI1Xvo1Yvo1YwI5Xvo1Yvo1Yv41Xvo1Zvo1Yvo2junXyAAAAY3RSTlMADQ0ZGSUlJSYyMj8/P0tLS0tMTFNTVFRXWFhYW1xcY2NkZGRla2txcXFzc3N6ent9fX5+foKDg4qKioqKi4uSkpKTl5eXl5qamqKio6OjpKmpqqqvsLCxsbG5ubm8vLzBwckgUECPAAADb0lEQVR4AdXXBYLjOgwGYKfDDBpmpi7vMGPeMqeMuv8dlqG/67aOrUffAaLql+ykylLQOby9+zZV5K+KqTDcnuoJlJigf/stG7zdHW6TePzUHTcRTnkW6TkscivhsHI2csdWIscaAxEj4Ro9+PvFawRbHNtuW5wGMCD5NrbY0W5gl9AdO4tskmqL2EO5V7XSUWSzzF8Hyfl5+mpieePg8h03MOtUoHK5MUG6jcscm6zFL/BugxpYflYxl4hToHI8QU0sPDQ0MhpnyJcT1MLCMdfptS6Q3iALC89YU26wtIesOSZLDyuMokAZrDHKbZC1BX0aT00Z6QktUAyTL1ofi0grMEHxHOujaJHRMwIOJcLmGaXJwVXTlX2MQ54gF7i1Eb5ysMACOZnEjVpRNUKutUOOFiow7KBRC2fk7KBRE0eQEXl4D03gImFGMjn1GhfpGQGvUxEaj/MCeZmEJgKYM7Qg1MS0IaRlIsEmwvqQPpC3i7qYurnGQ/K2wTUG1VdTOGd/ef5jF4+bSEgYU6SPYY8EbGiDCAQ3ybBNvXgaKiTiPZ6IERyD9CC2lFrhPy5JxAP+4wRP9B6JSPIfb/D1do9ELMC6QoUN+QplqQqIayj1if+Y/59WeP03p/S3zGESJg1X630SsYTbKn/i4HK9/VtujX2oADffx7/l5uv+229v+TcQ6R+Wn/7utyis60fpMbyp+5oZl/+awVHznnBIw+qbomxMz7hG+/cKmyx5Nc0xnLfvelmyiVM9JIzJv4m5vBbSdyuCTZzqIX3XzmJNzDGEZP7Dnh+XWqSU+g5n7XmHP9RbwCb8c5qrmlowNFGZIydjeb0FbMJ/FC8ZWwDtRa6VHXdcVGwBrDB45l1gV2mCFPt1cc0g1a50XYzyc7GG/JyNGYEZvcSi622EGeE+oXOydFBllEooAKOIn9TcR9aU2pVZe4p1z1rWGDuvsq5XNdJVZPsa8Hwwo1SsEvxsgxpYv6xyvVWl4pbg/LOdMdKMrV8WmO0KYIkUm2WfHWwsztNX8/M7Dy4/VtlsSJnBuD2UelVr7SE7S7UrK6vs6FFCWepNOSU0o+wFmxzbDSYkPvBUr4ptJEaN0ipOwL+G1/NB72OL/HuVl/aR26aPd/35INH3+BUbRE9GEkpMondq+/A2Kn2PPXp1uD3Va/n0Lz+J4DdmmdHlAAAAAElFTkSuQmCC';
+
+export default closedSymbol;
