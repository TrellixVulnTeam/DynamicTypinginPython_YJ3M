commit 50a8c9667cd23c5fc6c891f3bccce8e21552143b
Author: Ted Kaemming <ted@kaemming.com>
Date:   Mon Oct 12 18:28:53 2015 -0700

    Test the message can be built.

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index 303b865029..b5e98dbf3d 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -7,12 +7,11 @@ sentry.plugins.sentry_mail.models
 """
 from __future__ import absolute_import
 
-import itertools
-
 import sentry
 
 from django.conf import settings
 from django.core.urlresolvers import reverse
+from django.template.loader import render_to_string
 from django.utils.encoding import force_text
 from django.utils.safestring import mark_safe
 
@@ -196,26 +195,16 @@ class MailPlugin(NotificationPlugin):
         )
 
     def notify_digest(self, project, digest):
-        # TODO: Probably just put this in a template?
-        # TODO: Maybe project should just be an attribute of the digest?
-        records = list(itertools.chain.from_iterable(digest.values()))
-        # TODO: Pluralization
-        subject = '[{project}] {n} events from {oldest.datetime} to {newest.datetime}]'.format(
-            project=project.get_full_name().encode('utf-8'),
-            n=len(records),
-            oldest=records[-1],
-            newest=records[0],
-        )
+        context = {
+            'digest': digest,
+        }
 
         self._send_mail(
-            subject=subject,
+            subject=render_to_string('sentry/emails/digests/subject.txt', context).rstrip(),
             template='sentry/emails/digests/body.txt',
             html_template='sentry/emails/digests/body.html',
             project=project,
-            context={
-                'project': project,
-                'digest': digest,
-            },
+            context=context,
         )
 
 
diff --git a/src/sentry/templates/sentry/emails/digests/subject.txt b/src/sentry/templates/sentry/emails/digests/subject.txt
new file mode 100644
index 0000000000..a6aa213b1d
--- /dev/null
+++ b/src/sentry/templates/sentry/emails/digests/subject.txt
@@ -0,0 +1 @@
+[{digest.project}] Notifications from {digest.start} to {digest.end}]
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index 24127a0164..ac55a368f2 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -9,6 +9,10 @@ from django.utils import timezone
 from exam import fixture
 from mock import Mock
 
+from sentry.digests.notifications import (
+    build_digest,
+    event_to_record,
+)
 from sentry.interfaces.stacktrace import Stacktrace
 from sentry.models import Event, Group, Rule
 from sentry.plugins import Notification
@@ -213,3 +217,16 @@ class MailPluginTest(TestCase):
 
         msg = mail.outbox[0]
         assert msg.subject == u'[Sentry] [foo Bar] ERROR: רונית מגן'
+
+    @mock.patch('sentry.plugins.sentry_mail.models.MailPlugin._send_mail')
+    def test_notify_digest(self, _send_mail):
+        project = self.event.project
+        rule = Rule(id=1, project=project, data={})
+        digest = build_digest(
+            project,
+            (
+                event_to_record(self.event, (rule,)),
+            ),
+        )
+        self.plugin.notify_digest(project, digest)
+        assert _send_mail.call_count is 1
