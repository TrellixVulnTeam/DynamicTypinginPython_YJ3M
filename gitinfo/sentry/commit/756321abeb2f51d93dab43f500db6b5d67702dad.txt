commit 756321abeb2f51d93dab43f500db6b5d67702dad
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri May 12 10:14:28 2017 -0700

    cleanup: allow specifying a db router as a filter

diff --git a/src/sentry/runner/commands/cleanup.py b/src/sentry/runner/commands/cleanup.py
index 2e9fcda043..51c8daa42e 100644
--- a/src/sentry/runner/commands/cleanup.py
+++ b/src/sentry/runner/commands/cleanup.py
@@ -38,8 +38,9 @@ def get_project(value):
 @click.option('--concurrency', type=int, default=1, show_default=True, help='The number of concurrent workers to run.')
 @click.option('--silent', '-q', default=False, is_flag=True, help='Run quietly. No output on success.')
 @click.option('--model', '-m', multiple=True)
+@click.option('--router', '-r', default=None, help='Database router')
 @configuration
-def cleanup(days, project, concurrency, silent, model):
+def cleanup(days, project, concurrency, silent, model, router):
     """Delete a portion of trailing data based on creation date.
 
     All data that is older than `--days` will be deleted.  The default for
@@ -53,19 +54,22 @@ def cleanup(days, project, concurrency, silent, model):
         raise click.Abort()
 
     from threading import Thread
+    from django.db import router as db_router
     from sentry.app import nodestore
     from sentry.db.deletion import BulkDeleteQuery
     from sentry.models import (
         ApiGrant, ApiToken, Event, EventMapping, Group, GroupRuleStatus,
-        GroupTagValue, LostPasswordHash, TagValue, GroupEmailThread,
+        GroupTagValue, LostPasswordHash, TagValue, GroupEmailThread, FileBlob,
     )
 
     models = {m.lower() for m in model}
 
     def is_filtered(model):
+        if router is not None and db_router.db_for_write(model) != router:
+            return True
         if not models:
             return False
-        return model.lower() not in models
+        return model.__name__.lower() not in models
 
     # these models should be safe to delete without cascades, in order
     BULK_DELETES = (
@@ -83,7 +87,7 @@ def cleanup(days, project, concurrency, silent, model):
     if not silent:
         click.echo('Removing expired values for LostPasswordHash')
 
-    if is_filtered('LostPasswordHash'):
+    if is_filtered(LostPasswordHash):
         if not silent:
             click.echo('>> Skipping LostPasswordHash')
     else:
@@ -95,7 +99,7 @@ def cleanup(days, project, concurrency, silent, model):
         if not silent:
             click.echo('Removing expired values for {}'.format(model.__name__))
 
-        if is_filtered(model.__name__):
+        if is_filtered(model):
             if not silent:
                 click.echo('>> Skipping {}'.format(model.__name__))
         else:
@@ -113,9 +117,6 @@ def cleanup(days, project, concurrency, silent, model):
     else:
         if not silent:
             click.echo("Removing old NodeStore values")
-        if is_filtered('NodeStore'):
-            if not silent:
-                click.echo('>> Skipping NodeStore')
         else:
             cutoff = timezone.now() - timedelta(days=days)
             try:
@@ -130,7 +131,7 @@ def cleanup(days, project, concurrency, silent, model):
                 days=days,
                 project=project or '*',
             ))
-        if is_filtered(model.__name__):
+        if is_filtered(model):
             if not silent:
                 click.echo('>> Skipping %s' % model.__name__)
         else:
@@ -145,7 +146,7 @@ def cleanup(days, project, concurrency, silent, model):
     # won't need a reference to an event for nearly as long
     if not silent:
         click.echo("Removing expired values for EventMapping")
-    if is_filtered('EventMapping'):
+    if is_filtered(EventMapping):
         if not silent:
             click.echo('>> Skipping EventMapping')
     else:
@@ -160,7 +161,7 @@ def cleanup(days, project, concurrency, silent, model):
     # recent (as there could be a race between blob creation and reference)
     if not silent:
         click.echo("Cleaning up unused FileBlob references")
-    if is_filtered('FileBlob'):
+    if is_filtered(FileBlob):
         if not silent:
             click.echo('>> Skipping FileBlob')
     else:
@@ -173,7 +174,7 @@ def cleanup(days, project, concurrency, silent, model):
                 days=days,
                 project=project or '*',
             ))
-        if is_filtered(model.__name__):
+        if is_filtered(model):
             if not silent:
                 click.echo('>> Skipping %s' % model.__name__)
         else:
