commit 67915c8e81e6d8429719c4ec1769036d2213e47a
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri Dec 1 14:13:26 2017 -0800

    fix(user report): Make sure Group is correctly paired in non-API
    endpoint

diff --git a/src/sentry/api/endpoints/project_user_reports.py b/src/sentry/api/endpoints/project_user_reports.py
index 4b70a11ed9..304155fb14 100644
--- a/src/sentry/api/endpoints/project_user_reports.py
+++ b/src/sentry/api/endpoints/project_user_reports.py
@@ -11,8 +11,9 @@ from sentry.api.bases.project import ProjectEndpoint
 from sentry.api.serializers import serialize, ProjectUserReportSerializer
 from sentry.api.paginator import DateTimePaginator
 from sentry.models import (Event, EventUser, Group, GroupStatus, UserReport)
-from sentry.utils.apidocs import scenario, attach_scenarios
+from sentry.signals import user_feedback_received
 from sentry.tasks.user_reports import backfill_group
+from sentry.utils.apidocs import scenario, attach_scenarios
 
 
 @scenario('CreateUserFeedback')
@@ -139,6 +140,8 @@ class ProjectUserReportsEndpoint(ProjectEndpoint):
                 countdown=30,
             )
 
+        user_feedback_received.send(project=report.project, group=report.group, sender=self)
+
         return Response(serialize(report, request.user, ProjectUserReportSerializer()))
 
     def find_event_user(self, report):
diff --git a/src/sentry/web/frontend/error_page_embed.py b/src/sentry/web/frontend/error_page_embed.py
index 223e42b837..d2420d579f 100644
--- a/src/sentry/web/frontend/error_page_embed.py
+++ b/src/sentry/web/frontend/error_page_embed.py
@@ -12,9 +12,10 @@ from django.utils.safestring import mark_safe
 from django.utils.translation import ugettext_lazy as _
 from django.views.decorators.csrf import csrf_exempt
 
-from sentry.models import (EventMapping, Group, ProjectKey, ProjectOption, UserReport)
+from sentry.models import (Group, ProjectKey, ProjectOption, UserReport)
 from sentry.web.helpers import render_to_response
 from sentry.signals import user_feedback_received
+from sentry.tasks.user_reports import backfill_group
 from sentry.utils import json
 from sentry.utils.http import is_valid_origin, origin_from_request
 from sentry.utils.validators import is_event_id
@@ -116,16 +117,11 @@ class ErrorPageEmbedView(View):
             report = form.save(commit=False)
             report.project = key.project
             report.event_id = event_id
+
             try:
-                mapping = EventMapping.objects.get(
-                    event_id=report.event_id,
-                    project_id=key.project_id,
-                )
-            except EventMapping.DoesNotExist:
-                # XXX(dcramer): the system should fill this in later
+                report.group = Group.objects.from_event_id(report.project, report.event_id)
+            except Group.DoesNotExist:
                 pass
-            else:
-                report.group = Group.objects.get(id=mapping.group_id)
 
             try:
                 with transaction.atomic():
@@ -147,6 +143,14 @@ class ErrorPageEmbedView(View):
                     date_added=timezone.now(),
                 )
 
+            if report.group_id is None:
+                backfill_group.apply_async(
+                    kwargs={
+                        'report_id': report.id,
+                    },
+                    countdown=30,
+                )
+
             user_feedback_received.send(project=report.project, group=report.group, sender=self)
 
             return self._json_response(request)
