commit 053309a60e368d64c8e571cbe5a6009d8f48ada4
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Thu Apr 6 12:41:52 2017 -0700

    don't silently fail when users are using api keys (#5210)

diff --git a/src/sentry/api/endpoints/organization_release_details.py b/src/sentry/api/endpoints/organization_release_details.py
index 23d0cabc05..969826dd81 100644
--- a/src/sentry/api/endpoints/organization_release_details.py
+++ b/src/sentry/api/endpoints/organization_release_details.py
@@ -162,7 +162,11 @@ class OrganizationReleaseDetailsEndpoint(OrganizationReleasesBaseEndpoint):
                 'commit': r['currentId'],
             } for r in result.get('headCommits', [])]
         if refs:
-            fetch_commits = request.user.is_authenticated() and not commit_list
+            if not request.user.is_authenticated():
+                return Response({
+                    'refs': ['You must use an authenticated API token to fetch refs']
+                }, status=400)
+            fetch_commits = not commit_list
             release.set_refs(refs, request.user, fetch_commits=fetch_commits)
 
         if (not was_released and release.date_released):
diff --git a/src/sentry/api/endpoints/organization_releases.py b/src/sentry/api/endpoints/organization_releases.py
index c9a2863c3b..42cf3690e6 100644
--- a/src/sentry/api/endpoints/organization_releases.py
+++ b/src/sentry/api/endpoints/organization_releases.py
@@ -184,7 +184,11 @@ class OrganizationReleasesEndpoint(OrganizationReleasesBaseEndpoint):
                     'commit': r['currentId'],
                 } for r in result.get('headCommits', [])]
             if refs:
-                fetch_commits = request.user.is_authenticated() and not commit_list
+                if not request.user.is_authenticated():
+                    return Response({
+                        'refs': ['You must use an authenticated API token to fetch refs']
+                    }, status=400)
+                fetch_commits = not commit_list
                 release.set_refs(refs, request.user, fetch_commits=fetch_commits)
 
             if not created and not new_projects:
