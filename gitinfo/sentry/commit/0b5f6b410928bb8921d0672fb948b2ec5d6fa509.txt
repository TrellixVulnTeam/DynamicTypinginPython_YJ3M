commit 0b5f6b410928bb8921d0672fb948b2ec5d6fa509
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Wed Apr 23 11:38:46 2014 -0700

    Try and always generate a better culprit

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index 8320e6cb32..cd574cb682 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -279,7 +279,7 @@ def expand_javascript_source(data, **kwargs):
         if not sourcemap:
             source_code[filename] = (result.body.splitlines(), None, None)
             for f in frames:
-                if f.abs_path == filename:
+                if not f.module and f.abs_path == filename:
                     f.module = generate_module(filename)
             continue
         else:
@@ -375,10 +375,10 @@ def expand_javascript_source(data, **kwargs):
         for exception, stacktrace in itertools.izip(data['sentry.interfaces.Exception']['values'], stacktraces):
             exception['stacktrace'] = stacktrace.serialize()
 
-        # Attempt to fix the culrpit now that we have useful information
-        culprit_frame = stacktraces[0].frames[-1]
-        if culprit_frame.module and culprit_frame.function:
-            data['culprit'] = truncatechars(generate_culprit(culprit_frame), MAX_CULPRIT_LENGTH)
+    # Attempt to fix the culrpit now that we have potentially useful information
+    culprit_frame = stacktraces[0].frames[-1]
+    if culprit_frame.module and culprit_frame.function:
+        data['culprit'] = truncatechars(generate_culprit(culprit_frame), MAX_CULPRIT_LENGTH)
 
 
 def generate_module(src):
