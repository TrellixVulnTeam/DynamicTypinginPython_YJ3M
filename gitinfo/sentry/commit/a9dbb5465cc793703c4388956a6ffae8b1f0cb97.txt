commit a9dbb5465cc793703c4388956a6ffae8b1f0cb97
Author: Tony <Zylphrex@users.noreply.github.com>
Date:   Mon Jun 15 15:21:37 2020 -0400

    feat(async-csv): Display SHA1 checksum on download page (#19289)

diff --git a/src/sentry/api/serializers/models/exporteddata.py b/src/sentry/api/serializers/models/exporteddata.py
index 7a60bbe8f7..da00afa10a 100644
--- a/src/sentry/api/serializers/models/exporteddata.py
+++ b/src/sentry/api/serializers/models/exporteddata.py
@@ -25,6 +25,13 @@ class ExportedDataSerializer(Serializer):
         return attrs
 
     def serialize(self, obj, attrs, user, **kwargs):
+        if obj.file is None:
+            checksum = None
+            file_name = None
+        else:
+            checksum = obj.file.checksum
+            file_name = obj.file.name
+
         return {
             "id": obj.id,
             "user": attrs["user"],
@@ -33,4 +40,6 @@ class ExportedDataSerializer(Serializer):
             "dateExpired": obj.date_expired,
             "query": {"type": ExportQueryType.as_str(obj.query_type), "info": obj.query_info},
             "status": obj.status,
+            "checksum": checksum,
+            "fileName": file_name,
         }
diff --git a/src/sentry/static/sentry/app/views/dataExport/dataDownload.tsx b/src/sentry/static/sentry/app/views/dataExport/dataDownload.tsx
index 22d1816ff8..51fc2642f9 100644
--- a/src/sentry/static/sentry/app/views/dataExport/dataDownload.tsx
+++ b/src/sentry/static/sentry/app/views/dataExport/dataDownload.tsx
@@ -8,7 +8,7 @@ import DateTime from 'app/components/dateTime';
 import AsyncView from 'app/views/asyncView';
 import Layout from 'app/views/auth/layout';
 import space from 'app/styles/space';
-import {t} from 'app/locale';
+import {t, tct} from 'app/locale';
 
 export enum DownloadStatus {
   Early = 'EARLY',
@@ -36,6 +36,7 @@ type Download = {
     info: object;
   };
   status: DownloadStatus;
+  checksum: string;
 };
 
 type Props = {} & RouteComponentProps<RouteParams, {}>;
@@ -108,6 +109,7 @@ class DataDownload extends AsyncView<Props, State> {
       </React.Fragment>
     );
   }
+
   renderExpired(): React.ReactNode {
     const {query} = this.state.download;
     const actionLink = this.getActionLink(query.type);
@@ -136,7 +138,7 @@ class DataDownload extends AsyncView<Props, State> {
   }
   renderValid(): React.ReactNode {
     const {
-      download: {dateExpired},
+      download: {dateExpired, checksum},
     } = this.state;
     const {orgId, dataExportId} = this.props.params;
     return (
@@ -158,6 +160,22 @@ class DataDownload extends AsyncView<Props, State> {
             <br />
             {this.renderDate(dateExpired)}
           </p>
+          <small>
+            <strong>SHA1:{checksum}</strong>
+          </small>
+          <p>
+            {tct('Need help verifying? [link].', {
+              link: (
+                <a
+                  href="https://docs.sentry.io/performance/discover/query-builder/#verifying-the-download"
+                  target="_blank"
+                  rel="noopener noreferrer"
+                >
+                  {t('Check out our docs.')}
+                </a>
+              ),
+            })}
+          </p>
         </Body>
       </React.Fragment>
     );
diff --git a/tests/sentry/data_export/endpoints/test_data_export.py b/tests/sentry/data_export/endpoints/test_data_export.py
index 31fef92216..3185742786 100644
--- a/tests/sentry/data_export/endpoints/test_data_export.py
+++ b/tests/sentry/data_export/endpoints/test_data_export.py
@@ -55,6 +55,8 @@ class DataExportTest(APITestCase):
             "dateExpired": None,
             "query": {"type": self.payload["query_type"], "info": self.payload["query_info"]},
             "status": ExportStatus.Early,
+            "checksum": None,
+            "fileName": None,
         }
 
     def test_progress_export(self):
@@ -82,6 +84,8 @@ class DataExportTest(APITestCase):
                 "info": data_export.query_info,
             },
             "status": data_export.status,
+            "checksum": None,
+            "fileName": None,
         }
 
     def test_export_too_many_fields(self):
diff --git a/tests/sentry/data_export/endpoints/test_data_export_details.py b/tests/sentry/data_export/endpoints/test_data_export_details.py
index 1f4052dae4..1689301db7 100644
--- a/tests/sentry/data_export/endpoints/test_data_export_details.py
+++ b/tests/sentry/data_export/endpoints/test_data_export_details.py
@@ -1,11 +1,14 @@
 from __future__ import absolute_import
 
+from hashlib import sha1
+
 import six
 from datetime import timedelta
 from django.utils import timezone
 
 from sentry.data_export.base import ExportStatus, ExportQueryType
 from sentry.data_export.models import ExportedData
+from sentry.models import File
 from sentry.testutils import APITestCase
 
 
@@ -67,3 +70,21 @@ class DataExportDetailsTest(APITestCase):
         assert response.data["dateExpired"] is not None
         assert response.data["dateExpired"] == self.data_export.date_expired
         assert response.data["status"] == ExportStatus.Expired
+
+    def test_no_file(self):
+        with self.feature("organizations:data-export"):
+            response = self.get_valid_response(self.organization.slug, self.data_export.id)
+        assert response.data["checksum"] is None
+        assert response.data["fileName"] is None
+
+    def test_file(self):
+        contents = b"test"
+        file = File.objects.create(
+            name="test.csv", type="export.csv", headers={"Content-Type": "text/csv"}
+        )
+        file.putfile(six.BytesIO(contents))
+        self.data_export.update(file=file)
+        with self.feature("organizations:data-export"):
+            response = self.get_valid_response(self.organization.slug, self.data_export.id)
+        assert response.data["checksum"] == sha1(contents).hexdigest()
+        assert response.data["fileName"] == "test.csv"
