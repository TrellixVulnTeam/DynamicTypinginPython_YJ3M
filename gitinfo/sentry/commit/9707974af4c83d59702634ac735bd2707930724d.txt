commit 9707974af4c83d59702634ac735bd2707930724d
Author: Jess MacQueen <jess@getsentry.com>
Date:   Wed Jul 5 17:28:16 2017 -0700

    add previous_group_id, don't allow null for project

diff --git a/src/sentry/api/endpoints/project_group_index.py b/src/sentry/api/endpoints/project_group_index.py
index 9f5e2e2e01..756c2190aa 100644
--- a/src/sentry/api/endpoints/project_group_index.py
+++ b/src/sentry/api/endpoints/project_group_index.py
@@ -5,7 +5,7 @@ import logging
 from uuid import uuid4
 
 import six
-from django.db import transaction
+from django.db import IntegrityError, transaction
 from django.utils import timezone
 from rest_framework import serializers
 from rest_framework.response import Response
@@ -464,15 +464,19 @@ class ProjectGroupIndexEndpoint(ProjectEndpoint):
         if discard:
             group_list = list(queryset)
             for group in group_list:
-                # TODO(jess): do we want a lock here to prevent
-                # multiple tombstones from being created from a group?
-                tombstone = GroupTombstone.objects.create(
-                    project_id=group.project_id,
-                    level=group.level,
-                    message=group.message,
-                    culprit=group.culprit,
-                    type=group.get_event_type(),
-                )
+                with transaction.atomic():
+                    try:
+                        tombstone = GroupTombstone.objects.create(
+                            previous_group_id=group.id,
+                            project_id=group.project_id,
+                            level=group.level,
+                            message=group.message,
+                            culprit=group.culprit,
+                            type=group.get_event_type(),
+                        )
+                    except IntegrityError:
+                        continue
+
                 GroupHash.objects.filter(
                     group=group,
                 ).update(
diff --git a/src/sentry/models/grouptombstone.py b/src/sentry/models/grouptombstone.py
index b02763b4e0..e19a1c831f 100644
--- a/src/sentry/models/grouptombstone.py
+++ b/src/sentry/models/grouptombstone.py
@@ -11,7 +11,8 @@ from sentry.db.models import BoundedPositiveIntegerField, FlexibleForeignKey, Mo
 class GroupTombstone(Model):
     __core__ = False
 
-    project = FlexibleForeignKey('sentry.Project', null=True)
+    previous_group_id = BoundedPositiveIntegerField(unique=True)
+    project = FlexibleForeignKey('sentry.Project')
     level = BoundedPositiveIntegerField(
         choices=LOG_LEVELS.items(), default=logging.ERROR, blank=True,
         db_index=True)
diff --git a/src/sentry/south_migrations/0338_auto__add_grouptombstone__add_field_grouphash_group_tombstone.py b/src/sentry/south_migrations/0338_auto__add_grouptombstone__add_field_grouphash_group_tombstone.py
index 13dd0b37fd..d9a61a55f2 100644
--- a/src/sentry/south_migrations/0338_auto__add_grouptombstone__add_field_grouphash_group_tombstone.py
+++ b/src/sentry/south_migrations/0338_auto__add_grouptombstone__add_field_grouphash_group_tombstone.py
@@ -11,7 +11,8 @@ class Migration(SchemaMigration):
         # Adding model 'GroupTombstone'
         db.create_table('sentry_grouptombstone', (
             ('id', self.gf('sentry.db.models.fields.bounded.BoundedBigAutoField')(primary_key=True)),
-            ('project', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.Project'], null=True)),
+            ('previous_group_id', self.gf('sentry.db.models.fields.bounded.BoundedPositiveIntegerField')(unique=True)),
+            ('project', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.Project'])),
             ('level', self.gf('sentry.db.models.fields.bounded.BoundedPositiveIntegerField')(default=40, db_index=True, blank=True)),
             ('message', self.gf('django.db.models.fields.TextField')()),
             ('culprit', self.gf('django.db.models.fields.CharField')(max_length=200, null=True, blank=True)),
@@ -49,12 +50,12 @@ class Migration(SchemaMigration):
         'sentry.apiapplication': {
             'Meta': {'object_name': 'ApiApplication'},
             'allowed_origins': ('django.db.models.fields.TextField', [], {'null': 'True', 'blank': 'True'}),
-            'client_id': ('django.db.models.fields.CharField', [], {'default': "'6ffc3c8514104dbb920f6d6e12bb44bb4202602d9a1246f09d00d8e10aa20709'", 'unique': 'True', 'max_length': '64'}),
-            'client_secret': ('sentry.db.models.fields.encrypted.EncryptedTextField', [], {'default': "'bd759bce2a3a497bb35f8a12468b92c4d4c6a65087764aba9f9f851c1dbd21a7'"}),
+            'client_id': ('django.db.models.fields.CharField', [], {'default': "'7251c039046e40738565f2fdd72d09fa8ef0b435bda148a698bcdf8c018d14b5'", 'unique': 'True', 'max_length': '64'}),
+            'client_secret': ('sentry.db.models.fields.encrypted.EncryptedTextField', [], {'default': "'d2337110b93f43f68b8f4d4846514223326e9721f8d74c9b8d780f41c20a39bd'"}),
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
             'homepage_url': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
-            'name': ('django.db.models.fields.CharField', [], {'default': "'Joint Orca'", 'max_length': '64', 'blank': 'True'}),
+            'name': ('django.db.models.fields.CharField', [], {'default': "'Star Glider'", 'max_length': '64', 'blank': 'True'}),
             'owner': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.User']"}),
             'privacy_url': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True'}),
             'redirect_uris': ('django.db.models.fields.TextField', [], {}),
@@ -73,8 +74,8 @@ class Migration(SchemaMigration):
         'sentry.apigrant': {
             'Meta': {'object_name': 'ApiGrant'},
             'application': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.ApiApplication']"}),
-            'code': ('django.db.models.fields.CharField', [], {'default': "'e9d42c025bd644b5a992cdba028bc4e7'", 'max_length': '64', 'db_index': 'True'}),
-            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 6, 30, 0, 0)', 'db_index': 'True'}),
+            'code': ('django.db.models.fields.CharField', [], {'default': "'ba21b4201e324c7ca99ddc481952d3b7'", 'max_length': '64', 'db_index': 'True'}),
+            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 7, 6, 0, 0)', 'db_index': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'redirect_uri': ('django.db.models.fields.CharField', [], {'max_length': '255'}),
             'scope_list': ('sentry.db.models.fields.array.ArrayField', [], {'of': ('django.db.models.fields.TextField', [], {})}),
@@ -97,12 +98,12 @@ class Migration(SchemaMigration):
             'Meta': {'object_name': 'ApiToken'},
             'application': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.ApiApplication']", 'null': 'True'}),
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 7, 30, 0, 0)', 'null': 'True'}),
+            'expires_at': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 8, 5, 0, 0)', 'null': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
-            'refresh_token': ('django.db.models.fields.CharField', [], {'default': "'6d62a08bec094e348896b4135dc9e122694e690708d040f4a271cfe5083a253e'", 'max_length': '64', 'unique': 'True', 'null': 'True'}),
+            'refresh_token': ('django.db.models.fields.CharField', [], {'default': "'b372b85325654177a3f8ac0b7b4d735a64647d266d3a4b0eadfd49e588c61876'", 'max_length': '64', 'unique': 'True', 'null': 'True'}),
             'scope_list': ('sentry.db.models.fields.array.ArrayField', [], {'of': ('django.db.models.fields.TextField', [], {})}),
             'scopes': ('django.db.models.fields.BigIntegerField', [], {'default': 'None'}),
-            'token': ('django.db.models.fields.CharField', [], {'default': "'0a18b5353a354ae8a705981d9702f8e176217f7c5a1f43d1aac73b1194719834'", 'unique': 'True', 'max_length': '64'}),
+            'token': ('django.db.models.fields.CharField', [], {'default': "'2930b02bf27c447eabd8a6840476edd8c6d7aa2a0fee4e47b8c465747c7bd7ac'", 'unique': 'True', 'max_length': '64'}),
             'user': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.User']"})
         },
         'sentry.auditlogentry': {
@@ -156,7 +157,7 @@ class Migration(SchemaMigration):
         'sentry.broadcast': {
             'Meta': {'object_name': 'Broadcast'},
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 7, 7, 0, 0)', 'null': 'True', 'blank': 'True'}),
+            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 7, 13, 0, 0)', 'null': 'True', 'blank': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_active': ('django.db.models.fields.BooleanField', [], {'default': 'True', 'db_index': 'True'}),
             'link': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True', 'blank': 'True'}),
@@ -499,7 +500,8 @@ class Migration(SchemaMigration):
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'level': ('sentry.db.models.fields.bounded.BoundedPositiveIntegerField', [], {'default': '40', 'db_index': 'True', 'blank': 'True'}),
             'message': ('django.db.models.fields.TextField', [], {}),
-            'project': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.Project']", 'null': 'True'}),
+            'previous_group_id': ('sentry.db.models.fields.bounded.BoundedPositiveIntegerField', [], {'unique': 'True'}),
+            'project': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.Project']"}),
             'type': ('django.db.models.fields.TextField', [], {})
         },
         'sentry.lostpasswordhash': {
@@ -774,8 +776,8 @@ class Migration(SchemaMigration):
             'app_label': ('django.db.models.fields.CharField', [], {'max_length': '64'}),
             'data': ('jsonfield.fields.JSONField', [], {'default': '{}'}),
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'date_scheduled': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 7, 30, 0, 0)'}),
-            'guid': ('django.db.models.fields.CharField', [], {'default': "'7924590213db400392d0806c60d4b68c'", 'unique': 'True', 'max_length': '32'}),
+            'date_scheduled': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2017, 8, 5, 0, 0)'}),
+            'guid': ('django.db.models.fields.CharField', [], {'default': "'71031fd4d1c94755822cad1c084a31cf'", 'unique': 'True', 'max_length': '32'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'in_progress': ('django.db.models.fields.BooleanField', [], {'default': 'False'}),
             'model_name': ('django.db.models.fields.CharField', [], {'max_length': '64'}),
@@ -851,7 +853,7 @@ class Migration(SchemaMigration):
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_verified': ('django.db.models.fields.BooleanField', [], {'default': 'False'}),
             'user': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'related_name': "'emails'", 'to': "orm['sentry.User']"}),
-            'validation_hash': ('django.db.models.fields.CharField', [], {'default': "u'DDf1pqvcDLDg2KPSAJNrvAuuiP91UUIf'", 'max_length': '32'})
+            'validation_hash': ('django.db.models.fields.CharField', [], {'default': "u'BnKyYfUnB168T5d2qQp0u1eeWv6BQNpV'", 'max_length': '32'})
         },
         'sentry.useroption': {
             'Meta': {'unique_together': "(('user', 'project', 'key'), ('user', 'organization', 'key'))", 'object_name': 'UserOption'},
