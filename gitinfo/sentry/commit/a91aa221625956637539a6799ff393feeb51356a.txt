commit a91aa221625956637539a6799ff393feeb51356a
Author: Matej Minar <matej.minar@sentry.io>
Date:   Fri Mar 20 18:59:39 2020 +0100

    feat(ui): Collapse commit authors in release v2 detail (#17811)
    
    * feat(ui): Collapse commit authors in release v2 detail
    
    * ref(ui): Changed variable name
    
    * ref(ui): Changed lodash's round to Math.round

diff --git a/src/sentry/static/sentry/app/views/releasesV2/detail/overview/commitAuthorBreakdown.tsx b/src/sentry/static/sentry/app/views/releasesV2/detail/overview/commitAuthorBreakdown.tsx
index 3e61aba301..410d07b4e4 100644
--- a/src/sentry/static/sentry/app/views/releasesV2/detail/overview/commitAuthorBreakdown.tsx
+++ b/src/sentry/static/sentry/app/views/releasesV2/detail/overview/commitAuthorBreakdown.tsx
@@ -1,6 +1,5 @@
 import React from 'react';
 import styled from '@emotion/styled';
-import round from 'lodash/round';
 
 import {t, tn} from 'app/locale';
 import space from 'app/styles/space';
@@ -10,6 +9,7 @@ import AsyncComponent from 'app/components/asyncComponent';
 import {percent} from 'app/utils';
 import {userDisplayName} from 'app/utils/formatters';
 import {Commit, User} from 'app/types';
+import Button from 'app/components/button';
 
 import {SectionHeading, Wrapper} from './styles';
 
@@ -21,17 +21,20 @@ type Props = {
   projectSlug: string;
   orgId: string;
   version: string;
-  commitCount: number;
 } & AsyncComponent['props'];
 
 type State = {
   commits: Commit[];
+  collapsed: boolean;
 } & AsyncComponent['state'];
 
 class CommitAuthorBreakdown extends AsyncComponent<Props, State> {
+  static MAX_WHEN_COLLAPSED = 5;
+
   getDefaultState() {
     return {
       ...super.getDefaultState(),
+      collapsed: true,
     };
   }
 
@@ -46,14 +49,22 @@ class CommitAuthorBreakdown extends AsyncComponent<Props, State> {
   }
 
   getDisplayPercent(authorCommitCount: number): string {
-    const {commitCount} = this.props;
+    const {commits} = this.state;
 
-    const calculatedPercent = round(percent(authorCommitCount, commitCount), 0);
+    const calculatedPercent = Math.round(percent(authorCommitCount, commits.length));
 
     return `${calculatedPercent < 1 ? '<1' : calculatedPercent}%`;
   }
 
+  onCollapseToggle = () => {
+    this.setState(state => ({
+      collapsed: !state.collapsed,
+    }));
+  };
+
   renderBody() {
+    const {collapsed} = this.state;
+
     // group commits by author
     const groupedAuthorCommits = this.state.commits?.reduce(
       (authorCommitsAccumulator, commit) => {
@@ -74,7 +85,7 @@ class CommitAuthorBreakdown extends AsyncComponent<Props, State> {
     );
 
     // sort authors by number of commits
-    const sortedAuthorsByNumberOfCommits = Object.values(groupedAuthorCommits).sort(
+    let sortedAuthorsByNumberOfCommits = Object.values(groupedAuthorCommits).sort(
       (a, b) => b.commitCount - a.commitCount
     );
 
@@ -82,6 +93,16 @@ class CommitAuthorBreakdown extends AsyncComponent<Props, State> {
       return null;
     }
 
+    // collapse them
+    const MAX = CommitAuthorBreakdown.MAX_WHEN_COLLAPSED;
+    const initialNumberOfAuthors = sortedAuthorsByNumberOfCommits.length;
+    const canExpand = initialNumberOfAuthors > MAX;
+    if (collapsed && canExpand) {
+      sortedAuthorsByNumberOfCommits = sortedAuthorsByNumberOfCommits.slice(0, MAX);
+    }
+    const collapsedNumberOfAuthors =
+      initialNumberOfAuthors - sortedAuthorsByNumberOfCommits.length;
+
     return (
       <Wrapper>
         <SectionHeading>{t('Commit Author Breakdown')}</SectionHeading>
@@ -98,6 +119,20 @@ class CommitAuthorBreakdown extends AsyncComponent<Props, State> {
             </Stats>
           </AuthorLine>
         ))}
+        {collapsedNumberOfAuthors > 0 && (
+          <StyledButton priority="link" onClick={this.onCollapseToggle}>
+            {tn(
+              'Show %s collapsed author',
+              'Show %s collapsed authors',
+              collapsedNumberOfAuthors
+            )}
+          </StyledButton>
+        )}
+        {collapsedNumberOfAuthors === 0 && canExpand && (
+          <StyledButton priority="link" onClick={this.onCollapseToggle}>
+            {t('Collapse')}
+          </StyledButton>
+        )}
       </Wrapper>
     );
   }
@@ -124,7 +159,8 @@ const StyledUserAvatar = styled(UserAvatar)`
 const AuthorName = styled('div')`
   font-weight: 600;
   color: ${p => p.theme.gray3};
-  ${overflowEllipsis}
+  padding-right: ${space(0.5)};
+  ${overflowEllipsis};
 `;
 
 const Stats = styled('div')`
@@ -144,4 +180,8 @@ const Percent = styled('div')`
   color: ${p => p.theme.gray4};
 `;
 
+const StyledButton = styled(Button)`
+  width: 100%;
+`;
+
 export default CommitAuthorBreakdown;
diff --git a/src/sentry/static/sentry/app/views/releasesV2/detail/overview/index.tsx b/src/sentry/static/sentry/app/views/releasesV2/detail/overview/index.tsx
index 5a58c43bc2..ef3e036a49 100644
--- a/src/sentry/static/sentry/app/views/releasesV2/detail/overview/index.tsx
+++ b/src/sentry/static/sentry/app/views/releasesV2/detail/overview/index.tsx
@@ -84,7 +84,6 @@ class ReleaseOverview extends React.Component<Props, State> {
                       <CommitAuthorBreakdown
                         version={version}
                         orgId={organization.slug}
-                        commitCount={commitCount}
                         projectSlug={project.slug}
                       />
                     )}
