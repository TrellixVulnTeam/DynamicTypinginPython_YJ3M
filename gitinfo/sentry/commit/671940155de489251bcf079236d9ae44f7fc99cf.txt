commit 671940155de489251bcf079236d9ae44f7fc99cf
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Nov 25 15:12:45 2012 -0800

    Clean up invite accept logic

diff --git a/src/sentry/templates/sentry/teams/members/accept_invite_unauthenticated.html b/src/sentry/templates/sentry/teams/members/accept_invite_unauthenticated.html
new file mode 100644
index 0000000000..7bb5373ee2
--- /dev/null
+++ b/src/sentry/templates/sentry/teams/members/accept_invite_unauthenticated.html
@@ -0,0 +1,18 @@
+{% extends "sentry/layout.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Team Invite" %} | {{ block.super }}{% endblock %}
+
+{% block page_header_block %}{% endblock %}
+{% block bodyclass %}{% endblock %}
+
+{% block main %}
+    <section class="body">
+        <p>{% blocktrans with team.name as team_name %}You have been invited to join the <strong>{{ team_name }}</strong> team.{% endblocktrans %}</p>
+
+        <p>{% trans "To continue, you must either login to your existing account, or create a new one." %}</p>
+
+        <p><a href="{% url sentry-login %}" class="btn btn-large btn-primary">Login</a> or <a href="{% url sentry-register %}" class="btn btn-large btn-primary">New account</a></p>
+    </section>
+{% endblock %}
diff --git a/src/sentry/web/frontend/teams.py b/src/sentry/web/frontend/teams.py
index bdea4f9f54..0d820ea6fa 100644
--- a/src/sentry/web/frontend/teams.py
+++ b/src/sentry/web/frontend/teams.py
@@ -182,14 +182,12 @@ def accept_invite(request, member_id, token):
         }
         return render_to_response('sentry/teams/members/accept_invite_unauthenticated.html', context, request)
 
-    if team.member_set.filter(
-            user=request.user,
-            type=pending_member.type,
-        ):
-        team.member_set.create(
-            user=request.user,
-            type=pending_member.type,
-        )
+    team.member_set.get_or_create(
+        user=request.user,
+        type=pending_member.type,
+    )
+
+    request.session.pop('can_register', None)
 
     pending_member.delete()
 
