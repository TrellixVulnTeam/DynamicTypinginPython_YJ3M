commit 29fe0e54068c5c73f8a9e97d4590d146dca9226c
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Apr 22 16:26:43 2015 -0700

    Move access requests into members tab

diff --git a/src/sentry/models/organizationaccessrequest.py b/src/sentry/models/organizationaccessrequest.py
index 62b74b9208..10c037c6ec 100644
--- a/src/sentry/models/organizationaccessrequest.py
+++ b/src/sentry/models/organizationaccessrequest.py
@@ -38,9 +38,9 @@ class OrganizationAccessRequest(Model):
             'name': user.get_display_name(),
             'organization': organization,
             'team': self.team,
-            'url': absolute_uri(reverse('sentry-organization-access-requests', kwargs={
+            'url': absolute_uri(reverse('sentry-organization-members', kwargs={
                 'organization_slug': organization.slug,
-            })),
+            }) + '?ref=access-requests'),
         }
 
         msg = MessageBuilder(
diff --git a/src/sentry/templates/sentry/organization-access-requests.html b/src/sentry/templates/sentry/organization-access-requests.html
deleted file mode 100644
index 4ae2f8ff78..0000000000
--- a/src/sentry/templates/sentry/organization-access-requests.html
+++ /dev/null
@@ -1,61 +0,0 @@
-{% extends "sentry/bases/modal.html" %}
-
-{% load i18n %}
-
-{% block title %}{% trans "Pending Access Requests" %} | {{ block.super }}{% endblock %}
-
-{% block inner %}
-  <div class="page-header">
-    <div class="pull-right">
-      <a href="{% url 'sentry-organization-home' organization.slug %}">Back to Organization Home</a>
-    </div>
-    <h2>{% trans "Pending Access Requests" %}</h2>
-  </div>
-
-  {% if request_list %}
-    <p>The following access requests are waiting approval by an organization admin.</p>
-
-    <ul class="access-request-list">
-      {% for access_request in request_list %}
-        <li>
-          <div class="pull-right">
-            <a href="#" class="btn btn-primary"
-               data-action="approve" data-id="{{ access_request.id }}">Approve</a>
-            <a href="#" class="btn btn-default"
-               data-action="deny" data-id="{{ access_request.id }}">Deny</a>
-          </div>
-          <strong>{{ access_request.member.user.get_display_name }}</strong> requests access to the <strong>{{ access_request.team.name }}</strong> team.
-        </li>
-      {% endfor %}
-    </ul>
-  {% else %}
-    <p>There are no pending access requests.</p>
-  {% endif %}
-
-  <script>
-  $(function(){
-    $('.access-request-list > li a').click(function(e){
-      var $el = $(this);
-      if (!$el.data('action')) {
-        return;
-      }
-      e.preventDefault();
-
-      $.ajax({
-        method: 'PUT',
-        url: app.config.urlPrefix + '/api/0/organizations/' + app.config.organizationId + '/access-requests/' + $el.data('id') + '/',
-        contentType: 'application/json',
-        data: JSON.stringify({
-          isApproved: $el.data('action') === 'approve'
-        }),
-        success: function() {
-          $el.parents('li').remove();
-        },
-        error: function() {
-          window.alert('We were unable to act on the access request. Maybe someone else beat you to it?');
-        }
-      });
-    });
-  });
-  </script>
-{% endblock %}
diff --git a/src/sentry/templates/sentry/organization-members.html b/src/sentry/templates/sentry/organization-members.html
index 1bba3b7441..92eb62eb95 100644
--- a/src/sentry/templates/sentry/organization-members.html
+++ b/src/sentry/templates/sentry/organization-members.html
@@ -17,6 +17,55 @@
 
   <br>
 
+  {% if request_list %}
+    <h3>Pending Accessing Requests</h3>
+
+    <ul class="access-request-list">
+      {% for access_request in request_list %}
+        <li>
+          <div class="pull-right">
+            <a href="#" class="btn btn-primary"
+               data-action="approve" data-id="{{ access_request.id }}">Approve</a>
+            <a href="#" class="btn btn-default"
+               data-action="deny" data-id="{{ access_request.id }}">Deny</a>
+          </div>
+          <strong>{{ access_request.member.user.get_display_name }}</strong> requests access to the <strong>{{ access_request.team.name }}</strong> team.
+        </li>
+      {% endfor %}
+    </ul>
+
+    <script>
+    $(function(){
+      $('.access-request-list > li a').click(function(e){
+        var $el = $(this);
+        if (!$el.data('action')) {
+          return;
+        }
+        e.preventDefault();
+
+        $.ajax({
+          method: 'PUT',
+          url: app.config.urlPrefix + '/api/0/organizations/' + app.config.organizationId + '/access-requests/' + $el.data('id') + '/',
+          contentType: 'application/json',
+          data: JSON.stringify({
+            isApproved: $el.data('action') === 'approve'
+          }),
+          success: function() {
+            $el.parents('li').remove();
+          },
+          error: function() {
+            window.alert('We were unable to act on the access request. Maybe someone else beat you to it?');
+          }
+        });
+      });
+    });
+    </script>
+  {% elif ref == 'access-requests' %}
+    <div class="alert alert-block alert-info">
+      <p>All pending access requests have been taken care of.</p>
+    </div>
+  {% endif %}
+
   <table class="table simple-list table-bordered member-list">
     <colgroup>
       <col width="30%"/>
diff --git a/src/sentry/web/frontend/organization_access_requests.py b/src/sentry/web/frontend/organization_access_requests.py
deleted file mode 100644
index ef122fff27..0000000000
--- a/src/sentry/web/frontend/organization_access_requests.py
+++ /dev/null
@@ -1,21 +0,0 @@
-from __future__ import absolute_import
-
-from sentry.models import (
-    OrganizationAccessRequest, OrganizationMemberType
-)
-from sentry.web.frontend.base import OrganizationView
-
-
-class OrganizationAccessRequestsView(OrganizationView):
-    required_access = OrganizationMemberType.ADMIN
-
-    def get(self, request, organization):
-        access_requests = OrganizationAccessRequest.objects.filter(
-            team__organization=organization,
-        ).select_related('team', 'member__user')
-
-        context = {
-            'request_list': list(access_requests),
-        }
-
-        return self.respond('sentry/organization-access-requests.html', context)
diff --git a/src/sentry/web/frontend/organization_members.py b/src/sentry/web/frontend/organization_members.py
index d857869adc..b9b0543238 100644
--- a/src/sentry/web/frontend/organization_members.py
+++ b/src/sentry/web/frontend/organization_members.py
@@ -3,8 +3,8 @@ from __future__ import absolute_import
 from collections import defaultdict
 
 from sentry.models import (
-    AuthProvider, OrganizationMember, OrganizationMemberTeam,
-    OrganizationMemberType
+    AuthProvider, OrganizationAccessRequest, OrganizationMember,
+    OrganizationMemberTeam, OrganizationMemberType
 )
 from sentry.web.frontend.base import OrganizationView
 
@@ -13,11 +13,14 @@ class OrganizationMembersView(OrganizationView):
     def handle(self, request, organization):
         if request.user.is_superuser:
             authorizing_access = OrganizationMemberType.OWNER
+            access_is_global = True
         else:
-            authorizing_access = OrganizationMember.objects.get(
+            member = OrganizationMember.objects.get(
                 user=request.user,
                 organization=organization,
-            ).type
+            )
+            authorizing_access = member.type
+            access_is_global = member.has_global_access
 
         queryset = OrganizationMemberTeam.objects.filter(
             organizationmember__organization=organization,
@@ -51,9 +54,19 @@ class OrganizationMembersView(OrganizationView):
                 and om.user is not None)
         )
 
+        # pending requests
+        if access_is_global and authorizing_access <= OrganizationMemberType.ADMIN:
+            access_requests = list(OrganizationAccessRequest.objects.filter(
+                team__organization=organization,
+            ).select_related('team', 'member__user'))
+        else:
+            access_requests = []
+
         context = {
             'org_has_sso': auth_provider is not None,
             'member_list': member_list,
+            'request_list': access_requests,
+            'ref': request.GET.get('ref'),
             'authorizing_access': authorizing_access,
             'member_can_leave': member_can_leave,
         }
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index f311465806..6d77aa1d0a 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -44,7 +44,6 @@ from sentry.web.frontend.help_page import HelpPageView
 from sentry.web.frontend.help_platform_details import HelpPlatformDetailsView
 from sentry.web.frontend.help_platform_index import HelpPlatformIndexView
 from sentry.web.frontend.mailgun_inbound_webhook import MailgunInboundWebhookView
-from sentry.web.frontend.organization_access_requests import OrganizationAccessRequestsView
 from sentry.web.frontend.organization_api_keys import OrganizationApiKeysView
 from sentry.web.frontend.organization_api_key_settings import OrganizationApiKeySettingsView
 from sentry.web.frontend.organization_audit_log import OrganizationAuditLogView
@@ -195,8 +194,6 @@ urlpatterns += patterns('',
         name='sentry-create-organization'),
     url(r'^organizations/(?P<organization_slug>[\w_-]+)/access-groups/$', AccessGroupMigrationView.as_view(),
         name='sentry-organization-access-group-migration'),
-    url(r'^organizations/(?P<organization_slug>[\w_-]+)/access-requests/$', OrganizationAccessRequestsView.as_view(),
-        name='sentry-organization-access-requests'),
     url(r'^organizations/(?P<organization_slug>[\w_-]+)/api-keys/$', OrganizationApiKeysView.as_view(),
         name='sentry-organization-api-keys'),
     url(r'^organizations/(?P<organization_slug>[\w_-]+)/api-keys/(?P<key_id>[\w_-]+)$', OrganizationApiKeySettingsView.as_view(),
