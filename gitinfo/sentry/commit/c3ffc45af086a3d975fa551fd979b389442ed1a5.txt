commit c3ffc45af086a3d975fa551fd979b389442ed1a5
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Tue Feb 12 16:58:30 2019 -0800

    fix(issues): Fix merging similar issues (#12037)
    
    `projectId` was defined in API call because we were only looking at projectId from URL. We can assume that all issues that are going to be merged belong to the same project.

diff --git a/src/sentry/static/sentry/app/stores/groupingStore.jsx b/src/sentry/static/sentry/app/stores/groupingStore.jsx
index 7ff41f818d..c9c259bbc6 100644
--- a/src/sentry/static/sentry/app/stores/groupingStore.jsx
+++ b/src/sentry/static/sentry/app/stores/groupingStore.jsx
@@ -280,7 +280,9 @@ const GroupingStore = Reflux.createStore({
     });
   },
 
-  onMerge({params, query}) {
+  // For cross-project views, we need to pass projectId instead of
+  // depending on router params (since we will only have orgId in that case)
+  onMerge({params, query, projectId}) {
     const ids = Array.from(this.mergeList.values());
 
     this.mergeDisabled = true;
@@ -293,11 +295,11 @@ const GroupingStore = Reflux.createStore({
       // Disable merge button
 
       if (params) {
-        const {orgId, groupId, projectId} = params;
+        const {orgId, groupId} = params;
         api.merge(
           {
             orgId,
-            projectId,
+            projectId: projectId || params.projectId,
             itemIds: [...ids, groupId],
             query,
           },
diff --git a/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx
index d6ff04b8b5..d1cbf9caaf 100644
--- a/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx
+++ b/src/sentry/static/sentry/app/views/groupDetails/shared/groupSimilar/index.jsx
@@ -110,9 +110,17 @@ const GroupGroupingView = createReactClass({
     const {query, params} = this.props;
 
     if (params) {
+      // You need at least 1 similarItem to be able to merge, so this should
+      // always exist.
+      //
+      // Similar issues API currently does not return issues across projects,
+      // so we can assume that the first issues project slug is the project in
+      // scope
+      const [firstIssue] = this.state.similarItems;
       GroupingActions.merge({
         params,
         query,
+        projectId: firstIssue.issue.project.slug,
       });
     }
   },
diff --git a/tests/js/mocks/issues.js b/tests/js/mocks/issues.js
index 5c7777ee80..27e0a176d3 100644
--- a/tests/js/mocks/issues.js
+++ b/tests/js/mocks/issues.js
@@ -19,11 +19,11 @@ export default [
     shareId: '312e323734',
     firstSeen: '2017-07-25T02:21:52Z',
     count: '2',
-    permalink: 'http://localhost:8000/sentry/internal/issues/274/',
+    permalink: 'http://localhost:8000/sentry/project-slug/issues/274/',
     level: 'error',
     isSubscribed: true,
     isBookmarked: false,
-    project: {name: 'Internal', slug: 'internal'},
+    project: {name: 'Internal', slug: 'project-slug'},
     statusDetails: {},
   },
   {
@@ -46,11 +46,11 @@ export default [
     shareId: '312e323735',
     firstSeen: '2017-07-25T02:20:35Z',
     count: '1',
-    permalink: 'http://localhost:8000/sentry/internal/issues/275/',
+    permalink: 'http://localhost:8000/sentry/project-slug/issues/275/',
     level: 'error',
     isSubscribed: true,
     isBookmarked: false,
-    project: {name: 'Internal', slug: 'internal'},
+    project: {name: 'Internal', slug: 'project-slug'},
     statusDetails: {},
   },
   {
@@ -76,11 +76,11 @@ export default [
     shareId: '312e323731',
     firstSeen: '2017-07-10T18:32:43Z',
     count: '90',
-    permalink: 'http://localhost:8000/sentry/internal/issues/271/',
+    permalink: 'http://localhost:8000/sentry/project-slug/issues/271/',
     level: 'error',
     isSubscribed: true,
     isBookmarked: false,
-    project: {name: 'Internal', slug: 'internal'},
+    project: {name: 'Internal', slug: 'project-slug'},
     statusDetails: {},
   },
   {
@@ -119,11 +119,11 @@ export default [
     shareId: '312e323136',
     firstSeen: '2017-07-25T02:20:35Z',
     count: '15',
-    permalink: 'http://localhost:8000/sentry/internal/issues/216/',
+    permalink: 'http://localhost:8000/sentry/project-slug/issues/216/',
     level: 'error',
     isSubscribed: true,
     isBookmarked: false,
-    project: {name: 'Internal', slug: 'internal'},
+    project: {name: 'Internal', slug: 'project-slug'},
     statusDetails: {},
   },
 ];
diff --git a/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap b/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap
index 7a55caabe2..cea315c0b7 100644
--- a/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap
+++ b/tests/js/spec/views/groupDetails/__snapshots__/groupSimilar.spec.jsx.snap
@@ -80,10 +80,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                 "value": "unmergedList is not defined",
               },
               "numComments": 0,
-              "permalink": "http://localhost:8000/sentry/internal/issues/274/",
+              "permalink": "http://localhost:8000/sentry/project-slug/issues/274/",
               "project": Object {
                 "name": "Internal",
-                "slug": "internal",
+                "slug": "project-slug",
               },
               "shareId": "312e323734",
               "shortId": "INTERNAL-4K",
@@ -130,10 +130,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                 "value": "Cannot read property 'size' of undefined",
               },
               "numComments": 0,
-              "permalink": "http://localhost:8000/sentry/internal/issues/275/",
+              "permalink": "http://localhost:8000/sentry/project-slug/issues/275/",
               "project": Object {
                 "name": "Internal",
-                "slug": "internal",
+                "slug": "project-slug",
               },
               "shareId": "312e323735",
               "shortId": "INTERNAL-4M",
@@ -204,10 +204,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                 "value": "Cannot read property 'stale' of undefined",
               },
               "numComments": 0,
-              "permalink": "http://localhost:8000/sentry/internal/issues/216/",
+              "permalink": "http://localhost:8000/sentry/project-slug/issues/216/",
               "project": Object {
                 "name": "Internal",
-                "slug": "internal",
+                "slug": "project-slug",
               },
               "shareId": "312e323136",
               "shortId": "INTERNAL-2S",
@@ -266,10 +266,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                 "value": "Cannot read property 'length' of undefined",
               },
               "numComments": 0,
-              "permalink": "http://localhost:8000/sentry/internal/issues/271/",
+              "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
               "project": Object {
                 "name": "Internal",
-                "slug": "internal",
+                "slug": "project-slug",
               },
               "shareId": "312e323731",
               "shortId": "INTERNAL-4G",
@@ -583,10 +583,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                   "value": "Cannot read property 'length' of undefined",
                 },
                 "numComments": 0,
-                "permalink": "http://localhost:8000/sentry/internal/issues/271/",
+                "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
                 "project": Object {
                   "name": "Internal",
-                  "slug": "internal",
+                  "slug": "project-slug",
                 },
                 "shareId": "312e323731",
                 "shortId": "INTERNAL-4G",
@@ -687,10 +687,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                   "value": "Cannot read property 'length' of undefined",
                                 },
                                 "numComments": 0,
-                                "permalink": "http://localhost:8000/sentry/internal/issues/271/",
+                                "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
                                 "project": Object {
                                   "name": "Internal",
-                                  "slug": "internal",
+                                  "slug": "project-slug",
                                 },
                                 "shareId": "312e323731",
                                 "shortId": "INTERNAL-4G",
@@ -724,10 +724,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                     "value": "Cannot read property 'length' of undefined",
                                   },
                                   "numComments": 0,
-                                  "permalink": "http://localhost:8000/sentry/internal/issues/271/",
+                                  "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
                                   "project": Object {
                                     "name": "Internal",
-                                    "slug": "internal",
+                                    "slug": "project-slug",
                                   },
                                   "shareId": "312e323731",
                                   "shortId": "INTERNAL-4G",
@@ -900,10 +900,10 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                                   "value": "Cannot read property 'length' of undefined",
                                                 },
                                                 "numComments": 0,
-                                                "permalink": "http://localhost:8000/sentry/internal/issues/271/",
+                                                "permalink": "http://localhost:8000/sentry/project-slug/issues/271/",
                                                 "project": Object {
                                                   "name": "Internal",
-                                                  "slug": "internal",
+                                                  "slug": "project-slug",
                                                 },
                                                 "shareId": "312e323731",
                                                 "shortId": "INTERNAL-4G",
@@ -1064,11 +1064,11 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                               }
                             }
                             numComments={0}
-                            permalink="http://localhost:8000/sentry/internal/issues/271/"
+                            permalink="http://localhost:8000/sentry/project-slug/issues/271/"
                             project={
                               Object {
                                 "name": "Internal",
-                                "slug": "internal",
+                                "slug": "project-slug",
                               }
                             }
                             shareId="312e323731"
@@ -1114,11 +1114,11 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                   "projectId": "project-slug",
                                 }
                               }
-                              permalink="http://localhost:8000/sentry/internal/issues/271/"
+                              permalink="http://localhost:8000/sentry/project-slug/issues/271/"
                               project={
                                 Object {
                                   "name": "Internal",
-                                  "slug": "internal",
+                                  "slug": "project-slug",
                                 }
                               }
                               router={
