commit a7c6f149e2327a3b9058eab727cfbb1c3c2fe259
Author: Mark Story <mark@sentry.io>
Date:   Tue Aug 27 10:09:12 2019 -0400

    fix(integrations) Fix Azure not handling expired/invalid tokens (#14509)
    
    Azure Devops users (or their administrator) can revoke their token and
    we need to handle that scenario.
    
    Fixes SENTRY-CCW
    Fixes ISSUE-586

diff --git a/src/sentry/integrations/vsts/integration.py b/src/sentry/integrations/vsts/integration.py
index a8771aa614..bbb95353b0 100644
--- a/src/sentry/integrations/vsts/integration.py
+++ b/src/sentry/integrations/vsts/integration.py
@@ -7,6 +7,7 @@ from django import forms
 from django.utils.translation import ugettext as _
 
 from sentry import http, features
+from sentry.auth.exceptions import IdentityNotValid
 from sentry.constants import ObjectStatus
 from sentry.models import (
     Integration as IntegrationModel,
@@ -173,8 +174,7 @@ class VstsIntegration(IntegrationInstallation, RepositoryMixin, VstsIssueSync):
 
             all_states = [(state, state) for state in all_states]
             disabled = False
-
-        except ApiError:
+        except (ApiError, IdentityNotValid):
             all_states = []
             disabled = True
 
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index a03379304c..bc793f3de0 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -308,6 +308,24 @@ class VstsIntegrationTest(VstsIntegrationTestCase):
             "sync_reverse_assignment",
         ]
 
+    def test_get_organization_config_failure(self):
+        self.assert_installation()
+        integration = Integration.objects.get(provider="vsts")
+        installation = integration.get_installation(integration.organizations.first().id)
+
+        # Set the `default_identity` property and force token expiration
+        installation.get_client()
+        installation.default_identity.data["expires"] = 1566851050
+
+        responses.replace(
+            responses.POST,
+            "https://app.vssps.visualstudio.com/oauth2/token",
+            status=400,
+            json={"$id": 1, "message": "The provided authorization grant failed"},
+        )
+        fields = installation.get_organization_config()
+        assert fields[0]["disabled"], "Fields should be disabled"
+
     def test_update_organization_config_remove_all(self):
         self.assert_installation()
 
