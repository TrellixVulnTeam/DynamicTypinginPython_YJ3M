commit e48cf75717c412e43f6971febd7ee8bf37dee963
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Thu Jan 24 14:57:20 2019 -0800

    feat(app-platform): Add uninstall webhook (#11451)
    
    * feat(app-platform): Add uninstall webhook

diff --git a/src/sentry/api/endpoints/sentry_app_installation_details.py b/src/sentry/api/endpoints/sentry_app_installation_details.py
index 718608ff77..131256e7d8 100644
--- a/src/sentry/api/endpoints/sentry_app_installation_details.py
+++ b/src/sentry/api/endpoints/sentry_app_installation_details.py
@@ -23,5 +23,8 @@ class SentryAppInstallationDetailsEndpoint(SentryAppInstallationBaseEndpoint):
                             actor=request.user):
             return Response(status=404)
 
-        Destroyer.run(install=installation)
+        Destroyer.run(
+            install=installation,
+            user=request.user,
+        )
         return Response(status=204)
diff --git a/src/sentry/mediators/sentry_app_installations/destroyer.py b/src/sentry/mediators/sentry_app_installations/destroyer.py
index b67215cb66..31292328eb 100644
--- a/src/sentry/mediators/sentry_app_installations/destroyer.py
+++ b/src/sentry/mediators/sentry_app_installations/destroyer.py
@@ -3,10 +3,12 @@ from __future__ import absolute_import
 from sentry.mediators import Mediator, Param
 from sentry.mediators import service_hooks
 from sentry.models import ServiceHook
+from sentry.mediators.sentry_app_installations.installation_notifier import InstallationNotifier
 
 
 class Destroyer(Mediator):
     install = Param('sentry.models.SentryAppInstallation')
+    user = Param('sentry.models.User')
 
     def call(self):
         self._destroy_authorization()
@@ -30,4 +32,9 @@ class Destroyer(Mediator):
             service_hooks.Destroyer.run(service_hook=hook)
 
     def _destroy_installation(self):
+        InstallationNotifier.run(
+            install=self.install,
+            user=self.user,
+            action='deleted',
+        )
         self.install.delete()
diff --git a/src/sentry/mediators/sentry_app_installations/installation_notifier.py b/src/sentry/mediators/sentry_app_installations/installation_notifier.py
index e7cd1963be..b37f015a17 100644
--- a/src/sentry/mediators/sentry_app_installations/installation_notifier.py
+++ b/src/sentry/mediators/sentry_app_installations/installation_notifier.py
@@ -1,6 +1,9 @@
 from __future__ import absolute_import
 
+import six
+
 from sentry.api.serializers import SentryAppInstallationSerializer, AppPlatformEvent
+from sentry.coreapi import APIUnauthorized
 from sentry.http import safe_urlopen, safe_urlread
 from sentry.mediators import Mediator, Param
 from sentry.utils.cache import memoize
@@ -9,10 +12,16 @@ from sentry.utils.cache import memoize
 class InstallationNotifier(Mediator):
     install = Param('sentry.models.SentryAppInstallation')
     user = Param('sentry.models.User')
+    action = Param(six.string_types)
 
     def call(self):
+        self._verify_action()
         self._send_webhook()
 
+    def _verify_action(self):
+        if self.action not in ['created', 'deleted']:
+            raise APIUnauthorized(u"Invalid action '{}'".format(self.action))
+
     def _send_webhook(self):
         safe_urlread(
             safe_urlopen(
@@ -33,7 +42,7 @@ class InstallationNotifier(Mediator):
 
         return AppPlatformEvent(
             resource='installation',
-            action='created',
+            action=self.action,
             install=self.install,
             data=data,
             actor=self.user,
diff --git a/src/sentry/mediators/sentry_apps/destroyer.py b/src/sentry/mediators/sentry_apps/destroyer.py
index a121aae263..aec32d67f9 100644
--- a/src/sentry/mediators/sentry_apps/destroyer.py
+++ b/src/sentry/mediators/sentry_apps/destroyer.py
@@ -16,7 +16,10 @@ class Destroyer(Mediator):
 
     def _destroy_sentry_app_installations(self):
         for install in self.sentry_app.installations.all():
-            sentry_app_installations.Destroyer.run(install=install)
+            sentry_app_installations.Destroyer.run(
+                install=install,
+                user=self.sentry_app.proxy_user,
+            )
 
     def _destroy_api_application(self):
         self.sentry_app.application.delete()
diff --git a/src/sentry/tasks/sentry_apps.py b/src/sentry/tasks/sentry_apps.py
index cf76024330..9a96ac48c2 100644
--- a/src/sentry/tasks/sentry_apps.py
+++ b/src/sentry/tasks/sentry_apps.py
@@ -166,6 +166,7 @@ def installation_webhook(installation_id, user_id, *args, **kwargs):
     InstallationNotifier.run(
         install=install,
         user=user,
+        action='created',
     )
 
 
diff --git a/tests/sentry/mediators/sentry_app_installations/test_destroyer.py b/tests/sentry/mediators/sentry_app_installations/test_destroyer.py
index 288f2ce357..91f9dc32a1 100644
--- a/tests/sentry/mediators/sentry_app_installations/test_destroyer.py
+++ b/tests/sentry/mediators/sentry_app_installations/test_destroyer.py
@@ -26,7 +26,10 @@ class TestDestroyer(TestCase):
             user=self.user,
         )
 
-        self.destroyer = Destroyer(install=self.install)
+        self.destroyer = Destroyer(
+            install=self.install,
+            user=self.user,
+        )
 
     def test_deletes_authorization(self):
         auth = self.install.authorization
diff --git a/tests/sentry/mediators/sentry_app_installations/test_installation_notifier.py b/tests/sentry/mediators/sentry_app_installations/test_installation_notifier.py
index 612082b247..ec3d1c94c1 100644
--- a/tests/sentry/mediators/sentry_app_installations/test_installation_notifier.py
+++ b/tests/sentry/mediators/sentry_app_installations/test_installation_notifier.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 from mock import patch
 
+from sentry.coreapi import APIUnauthorized
 from sentry.mediators import sentry_apps
 from sentry.mediators.sentry_app_installations import Creator, InstallationNotifier
 from sentry.testutils import TestCase
@@ -42,6 +43,7 @@ class TestInstallationNotifier(TestCase):
         InstallationNotifier.run(
             install=self.install,
             user=self.user,
+            action='created',
         )
 
         data = faux(safe_urlopen).kwargs['data']
@@ -76,3 +78,55 @@ class TestInstallationNotifier(TestCase):
             'Sentry-Hook-Timestamp',
             'Sentry-Hook-Signature',
         ))
+
+    @patch('sentry.mediators.sentry_app_installations.installation_notifier.safe_urlopen')
+    def test_uninstallation_enqueued(self, safe_urlopen):
+        InstallationNotifier.run(
+            install=self.install,
+            user=self.user,
+            action='deleted',
+        )
+
+        data = faux(safe_urlopen).kwargs['data']
+
+        assert data == json.dumps({
+            'action': 'deleted',
+            'installation': {
+                'uuid': self.install.uuid,
+            },
+            'data': {
+                'app': {
+                    'uuid': self.sentry_app.uuid,
+                    'slug': self.sentry_app.slug,
+                },
+                'organization': {
+                    'slug': self.org.slug,
+                },
+                'uuid': self.install.uuid,
+                'code': self.install.api_grant.code,
+            },
+            'actor': {
+                'id': self.user.id,
+                'name': self.user.name,
+                'type': 'user',
+            },
+        })
+
+        assert faux(safe_urlopen).kwarg_equals('headers', DictContaining(
+            'Content-Type',
+            'Request-ID',
+            'Sentry-Hook-Resource',
+            'Sentry-Hook-Timestamp',
+            'Sentry-Hook-Signature',
+        ))
+
+    @patch('sentry.mediators.sentry_app_installations.installation_notifier.safe_urlopen')
+    def test_invalid_installation_action(self, safe_urlopen):
+        with self.assertRaises(APIUnauthorized):
+            InstallationNotifier.run(
+                install=self.install,
+                user=self.user,
+                action='updated',
+            )
+
+        assert not safe_urlopen.called
diff --git a/tests/sentry/tasks/test_sentry_apps.py b/tests/sentry/tasks/test_sentry_apps.py
index c0321fc7b0..1b334416ee 100644
--- a/tests/sentry/tasks/test_sentry_apps.py
+++ b/tests/sentry/tasks/test_sentry_apps.py
@@ -228,6 +228,7 @@ class TestInstallationWebhook(TestCase):
         run.assert_called_with(
             install=self.install,
             user=self.user,
+            action='created',
         )
 
     def test_gracefully_handles_missing_install(self, run):
