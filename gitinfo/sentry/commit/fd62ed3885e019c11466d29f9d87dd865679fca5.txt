commit fd62ed3885e019c11466d29f9d87dd865679fca5
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Sep 23 12:42:49 2011 -0700

    Clean up message and group details pages.
    
    - Adds URL back to display.
    - Merges Exception information with generic summary information.
    - Fixes lastframe not displaying.
    - Moves Module Versions below Summary and changes display style to be inline.
    - Fixes Module Versions not showing on message page.

diff --git a/sentry/models.py b/sentry/models.py
index 53d63981f8..034a7fede0 100644
--- a/sentry/models.py
+++ b/sentry/models.py
@@ -25,7 +25,7 @@ from sentry.utils import cached_property, construct_checksum, transform, get_fil
                          MockDjangoRequest
 from sentry.utils.compat import pickle
 from sentry.utils.manager import GroupedMessageManager, SentryManager
-
+from sentry.templatetags.sentry_helpers import truncatechars
 from indexer.models import BaseIndex
 
 try:
@@ -55,7 +55,7 @@ class GzippedDictField(models.TextField):
     value is a dictionary.
     """
     __metaclass__ = models.SubfieldBase
- 
+
     def to_python(self, value):
         if isinstance(value, basestring) and value:
             try:
@@ -71,7 +71,7 @@ class GzippedDictField(models.TextField):
         if value is None:
             return
         return base64.b64encode(pickle.dumps(transform(value)).encode('zlib'))
- 
+
     def value_to_string(self, obj):
         value = self._get_val_from_obj(obj)
         return self.get_db_prep_value(value)
@@ -102,7 +102,7 @@ class MessageBase(Model):
         return '\n'.join(self.traceback.split('\n')[-5:])
     shortened_traceback.short_description = _('traceback')
     shortened_traceback.admin_order_field = 'traceback'
-    
+
     def error(self):
         if self.message:
             message = smart_unicode(self.message)
@@ -120,10 +120,10 @@ class MessageBase(Model):
     description.short_description = _('description')
 
     def has_two_part_message(self):
-        return '\n' in self.message.strip('\n')
-    
+        return '\n' in self.message.strip('\n') or len(self.message) > 100
+
     def message_top(self):
-        return self.message.split('\n')[0]
+        return truncatechars(self.message.split('\n')[0], 100)
 
 class GroupedMessage(MessageBase):
     status          = models.PositiveIntegerField(default=0, choices=STATUS_LEVELS, db_index=True)
@@ -132,7 +132,7 @@ class GroupedMessage(MessageBase):
     first_seen      = models.DateTimeField(default=datetime.now, db_index=True)
 
     score           = models.IntegerField(default=0)
-    
+
     objects         = GroupedMessageManager()
 
     class Meta:
@@ -163,7 +163,7 @@ class GroupedMessage(MessageBase):
 
         if not settings.ADMINS:
             return
-        
+
         message = self.message_set.order_by('-id')[0]
 
         obj_request = message.request
@@ -191,11 +191,11 @@ class GroupedMessage(MessageBase):
             'traceback': message.traceback,
             'link': link,
         })
-        
+
         send_mail(subject, body,
                   settings.SERVER_EMAIL, settings.ADMINS,
                   fail_silently=fail_silently)
-    
+
     @property
     def unique_urls(self):
         return self.messagefiltervalue_set.filter(key='url')\
@@ -252,7 +252,7 @@ class Message(MessageBase):
     @models.permalink
     def get_absolute_url(self):
         return ('sentry-group-message', (self.group_id, self.pk), {})
-    
+
     def shortened_url(self):
         if not self.url:
             return _('no data')
@@ -262,7 +262,7 @@ class Message(MessageBase):
         return url
     shortened_url.short_description = _('url')
     shortened_url.admin_order_field = 'url'
-    
+
     def full_url(self):
         return self.data.get('url') or self.url
     full_url.short_description = _('url')
@@ -301,10 +301,10 @@ class FilterValue(models.Model):
     """
     key = models.CharField(choices=FILTER_KEYS, max_length=32)
     value = models.CharField(max_length=200)
-    
+
     class Meta:
         unique_together = (('key', 'value'),)
-    
+
     def __unicode__(self):
         return u'key=%s, value=%s' % (self.key, self.value)
 
@@ -317,7 +317,7 @@ class MessageFilterValue(models.Model):
     times_seen = models.PositiveIntegerField(default=0)
     key = models.CharField(choices=FILTER_KEYS, max_length=32)
     value = models.CharField(max_length=200)
-    
+
     class Meta:
         unique_together = (('key', 'value', 'group'),)
 
@@ -328,14 +328,14 @@ class MessageFilterValue(models.Model):
 class MessageCountByMinute(Model):
     """
     Stores the total number of messages seen by a group at 5 minute intervals
-    
+
     e.g. if it happened at 08:34:55 the time would be normalized to 08:30:00
     """
-    
+
     group = models.ForeignKey(GroupedMessage)
     date = models.DateTimeField() # normalized to HH:MM:00
     times_seen = models.PositiveIntegerField(default=0)
-    
+
     class Meta:
         unique_together = (('group', 'date'),)
 
diff --git a/sentry/static/scripts/global.js b/sentry/static/scripts/global.js
index 05ec401482..c5e5e1558a 100644
--- a/sentry/static/scripts/global.js
+++ b/sentry/static/scripts/global.js
@@ -71,7 +71,7 @@ var Sentry = {};
             Sentry.options[k] = v;
         });
     };
-    
+
     Sentry.stream = {};
     Sentry.stream.clear = function() {
         if (confirm("Are you sure you want to mark all your stream as resolved?")) {
@@ -91,7 +91,7 @@ var Sentry = {};
     Sentry.stream.resolve = function(gid, remove){
         if (typeof(remove) == 'undefined') {
             remove = true;
-        } 
+        }
         $.ajax({
             url: Sentry.options.apiUrl,
             type: 'post',
@@ -113,7 +113,7 @@ var Sentry = {};
             }
         });
     };
-    
+
     Sentry.realtime = {};
     Sentry.realtime.status = false;
 
@@ -130,7 +130,7 @@ var Sentry = {};
         $('#sentry_realtime').text('Go Live');
         Sentry.realtime.status = false;
     };
-    
+
     Sentry.realtime.refresh = function(){
         data = getQueryParams();
         data.op = 'poll';
@@ -169,7 +169,7 @@ var Sentry = {};
                         Sentry.notifications.show({'type': 'html', 'url': url});
                     }
                 }
-                $('#message_list .fresh').css('background-color', '#ccc').animate({backgroundColor: '#fff'}, 1200, function() { 
+                $('#message_list .fresh').css('background-color', '#ccc').animate({backgroundColor: '#fff'}, 1200, function() {
                     $(this).removeClass('fresh');
                 });
                 // make sure we limit the number shown
@@ -184,7 +184,7 @@ var Sentry = {};
             }
         });
     };
-    
+
     Sentry.notifications = {};
     Sentry.notifications.status = false;
 
@@ -216,12 +216,12 @@ var Sentry = {};
         } else {
             note = window.webkitNotifications.createNotification(options.image || Sentry.options.defaultImage, options.title, options.body);
         }
-        note.ondisplay = function() { 
+        note.ondisplay = function() {
             setTimeout(function(){ note.cancel(); }, 10000);
         };
         note.show();
     };
-    
+
     $(document).ready(function(){
         $('#sentry_realtime').click(function(){
             if (Sentry.realtime.status) {
@@ -232,7 +232,7 @@ var Sentry = {};
         });
 
         setTimeout(Sentry.realtime.refresh, 3000);
-    
+
         if (window.webkitNotifications){
             Sentry.notifications.status = (window.webkitNotifications.checkPermission() > 0);
             $('<li><a id="sentry_notify" href="javascript:void()">' + (Sentry.notifications.status ? 'Disable Notifications' : 'Enable Notifications') + '</a></li>').click(function(){
@@ -243,7 +243,7 @@ var Sentry = {};
                 }
             }).prependTo('#account');
         }
-    
+
         $('#sidebar .filter-list').each(function(_, el){
             var el = $(el);
             if (el.find('li').length > 6) {
diff --git a/sentry/static/styles/global.css b/sentry/static/styles/global.css
index 9c849078e0..facf6c6257 100644
--- a/sentry/static/styles/global.css
+++ b/sentry/static/styles/global.css
@@ -533,7 +533,7 @@ dl.flat dd {
     margin-bottom: 10px;
 }
 .paging ul {
-    margin-bottom: 0; 
+    margin-bottom: 0;
 }
 .paging-wrap form { margin-bottom: 0; }
 .paging-meta, .sort-by, .realtime {
@@ -707,3 +707,7 @@ h2 .morelink { text-decoration: none; }
     padding-right: 0;
     margin-right: 0;
 }
+
+table.inline tr {
+    display: inline-block;
+}
diff --git a/sentry/templates/sentry/group/details.html b/sentry/templates/sentry/group/details.html
index 105defb1b6..dfaa48ef9c 100644
--- a/sentry/templates/sentry/group/details.html
+++ b/sentry/templates/sentry/group/details.html
@@ -20,7 +20,8 @@
             <li><a href="{{ link }}">{{ label }}</a></li>
         {% endfor %}
     </ul>
-    <h2>Meta</h2>
+
+    <h2>Aggregate Details</h2>
     <dl class="flat">
         <dt>{% trans "Logger:" %}</dt>
         <dd><a href="{% url sentry %}?logger={{ group.logger }}">{{ group.logger }}</a></dd>
@@ -33,25 +34,26 @@
         <dt>{% trans "Last Seen:" %}</dt>
         <dd title="{{ group.first_seen }}">{{ group.last_seen|timesince }}</dd>
     </dl>
-    
+
     {% for html in group|get_widgets:request %}
         {{ html|safe }}
     {% endfor %}
+
 {% endblock %}
 
 {% block main %}
     <ul class="messages" id="message_list">
         <li class="{% cycle 'row1' 'row2' %} level-{{ group.level }} active" id="group_{{ group.pk }}" data-sentry-count="{{ group.times_seen }}">
             <span class="count count-digits-{{ group.times_seen|num_digits }}">{{ group.times_seen }}</span>
-            <h3>{% if group.view %}{{ group.view }}{% else %}{{ group.message_top|truncatechars:100 }}{% endif %}</h3>
+            <h3>{% if group.view %}{{ group.view }}{% else %}{{ group.message_top }}{% endif %}</h3>
             <span class="last_seen" title="{{ group.last_seen }}">{{ group.last_seen|timesince }}</span>
             <span class="status status-{{ group.status }}">{{ group.get_status_display }}</span>
             <p class="message">
-                <span class="tag tag-level">{{ group.get_level_display }}</span> 
-                <span class="tag tag-logger">{{ group.logger }}</span> 
+                <span class="tag tag-level">{{ group.get_level_display }}</span>
+                <span class="tag tag-logger">{{ group.logger }}</span>
                 {% with group.get_version as version %}
                     {% if version %}
-                        <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span> 
+                        <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span>
                     {% endif %}
                 {% endwith %}
                 {% for tag in group|get_tags:request %}<span class="tag">{{ tag }}</span> {% endfor %}
@@ -70,32 +72,50 @@
             <li{% if is_active %} class="active"{% endif %}><a href="{{ link }}">{{ label }}</a></li>
         {% endfor %}
     </ul>
-    
+
     {% block inner %}
         <div id="details">
-            {% if group.has_two_part_message %}
-                <h2>{% trans "Full Message" %}</h2>
-                <pre id="full-message">{{ group.message }}</pre>
-            {% endif %}
-            
-            {% if exeption_type %}
-                <div id="summary">
-                  <h3>{{ exception_type }}: {{ exception_value|escape }}</h3>
-                  <table class="meta">
-                    <tr>
-                      <th>Exception Value:</th>
-                      <td><pre>{{ exception_value|escape }}</pre></td>
-                    </tr>
+            <div id="summary">
+                <h3>{% if exception_type %}{{ exception_type }}: {{ exception_value|escape }}{% else %}Summary{% endif %}</h3>
+                {% if group.has_two_part_message %}
+                    <pre id="full-message">{{ group.message }}</pre>
+                {% endif %}
+                <table class="meta">
+                    {% if exception_type %}
+                        <tr>
+                          <th>Exception Value:</th>
+                          <td><pre>{{ exception_value|escape }}</pre></td>
+                        </tr>
+                    {% endif %}
+                    {% if group.data.url %}
+                        <tr>
+                          <th>URL:</th>
+                          <td><a href="{{ group.data.url }}">{{ group.data.url|truncatechars:100 }}</a></td>
+                        </tr>
+                    {% endif %}
                     {% if lastframe %}
                     <tr>
-                      <th>Exception Location:</th>
+                      <th>Location:</th>
                       <td>{{ lastframe.filename|escape }} in {{ lastframe.function|escape }}, line {{ lastframe.lineno }}</td>
                     </tr>
                     {% endif %}
-                  </table>
+                </table>
+            </div>
+
+            {% if version_data %}
+                <div id="versioninfo">
+                    <h2>{% trans "Module Versions" %}</h2>
+                    <table class="inline">
+                        {% for k, v in version_data %}
+                            <tr>
+                                <th class="key">{{ k }}</th>
+                                <td class="values">{{ v }}</td>
+                            </tr>
+                        {% endfor %}
+                    </table>
                 </div>
             {% endif %}
-            
+
             {% if template_info %}
                 <div id="template">
                     <h2>Template error</h2>
@@ -113,7 +133,7 @@
                     </table>
                 </div>
             {% endif %}
-            
+
             {% if frames %}
                 <div id="traceback">
                   <h2>Traceback</h2>
@@ -168,7 +188,7 @@
                     <pre>{{ group.traceback }}</pre>
                 {% endif %}
             {% endif %}
-            
+
             {% if group|has_charts %}
                 <h2>{% trans "Frequency" %}</h2>
                 <div id="chart">
@@ -236,20 +256,6 @@
                     {% endfor %}
                 </table>
             </div>
-            
-            {% if version_data %}
-                <div id="versioninfo">
-                    <h2>{% trans "Module Versions" %}</h2>
-                    <table>
-                        {% for k, v in version_data %}
-                            <tr>
-                                <th class="key">{{ k }}</th>
-                                <td class="values">{{ v }}</td>
-                            </tr>
-                        {% endfor %}
-                    </table>
-                </div>
-            {% endif %}
         </div>
     {% endblock %}
     <script type="text/javascript">
diff --git a/sentry/templates/sentry/group/message.html b/sentry/templates/sentry/group/message.html
index 85a2ce7dc7..cd7d8479e2 100644
--- a/sentry/templates/sentry/group/message.html
+++ b/sentry/templates/sentry/group/message.html
@@ -9,7 +9,7 @@
     <ul class="messages" id="message_list">
         <li class="row1 active level-{{ message.level }}" data-sentry-count="{{ message.times_seen }}">
             <h3>
-                {{ message.message_top|truncatechars:100 }}
+                {{ message.message_top }}
                 {% if message.url %}
                      on {{ message.url }}
                 {% endif %}
@@ -23,7 +23,7 @@
                 <span class="tag tag-server">{{ message.server_name }}</span>
                 {% with message.get_version as version %}
                     {% if version %}
-                        <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span> 
+                        <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span>
                     {% endif %}
                 {% endwith %}
                 <span class="last_seen" title="{{ message.datetime }}">{{ message.datetime|timesince }}</span>
@@ -31,29 +31,47 @@
         </li>
     </ul>
 
-    {% if message.has_two_part_message %}
-        <h2>{% trans "Full Message" %}</h2>
-        <pre id="full-message">{{ message.message }}</pre>
-    {% endif %}
-
-    {% if exeption_type %}
-        <div id="summary">
-          <h3>{{ exception_type }}: {{ exception_value|escape }}</h3>
-          <table class="meta">
-            <tr>
-              <th>Exception Value:</th>
-              <td><pre>{{ exception_value|escape }}</pre></td>
-            </tr>
+    <div id="summary">
+        <h3>{% if exception_type %}{{ exception_type }}: {{ exception_value|escape }}{% else %}Summary{% endif %}</h3>
+        {% if group.has_two_part_message %}
+            <pre id="full-message">{{ group.message }}</pre>
+        {% endif %}
+        <table class="meta">
+            {% if exception_type %}
+                <tr>
+                  <th>Exception Value:</th>
+                  <td><pre>{{ exception_value|escape }}</pre></td>
+                </tr>
+            {% endif %}
+            {% if group.data.url %}
+                <tr>
+                  <th>URL:</th>
+                  <td><a href="{{ group.data.url }}">{{ group.data.url|truncatechars:100 }}</a></td>
+                </tr>
+            {% endif %}
             {% if lastframe %}
             <tr>
-              <th>Exception Location:</th>
+              <th>Location:</th>
               <td>{{ lastframe.filename|escape }} in {{ lastframe.function|escape }}, line {{ lastframe.lineno }}</td>
             </tr>
             {% endif %}
-          </table>
+        </table>
+    </div>
+
+    {% if version_data %}
+        <div id="versioninfo">
+            <h2>{% trans "Module Versions" %}</h2>
+            <table class="inline">
+                {% for k, v in version_data %}
+                    <tr>
+                        <th class="key">{{ k }}</th>
+                        <td class="values">{{ v }}</td>
+                    </tr>
+                {% endfor %}
+            </table>
         </div>
     {% endif %}
-    
+
     {% if template_info %}
         <div id="template">
             <h2>Template error</h2>
@@ -71,7 +89,7 @@
             </table>
         </div>
     {% endif %}
-    
+
     {% if frames %}
         <div id="traceback">
           <h2>Traceback</h2>
@@ -126,7 +144,7 @@
             <pre>{{ group.traceback }}</pre>
         {% endif %}
     {% endif %}
-    
+
     <div id="requestinfo">
         <h2>{% trans "Additional Data" %}</h2>
         <table>
diff --git a/sentry/templates/sentry/partial/_message.html b/sentry/templates/sentry/partial/_message.html
index d9853ea11b..5d33d56c66 100644
--- a/sentry/templates/sentry/partial/_message.html
+++ b/sentry/templates/sentry/partial/_message.html
@@ -2,7 +2,7 @@
 
 <li class="{% cycle 'row1' 'row2' %} level-{{ message.level }}{% if priority %} priority-{{ priority }}{% endif %}" id="message_{{ message.pk }}" data-sentry-count="{{ message.times_seen }}">
     <h3><a href="{% url sentry-group-message group.pk message.pk %}">
-        {{ message.message_top|truncatechars:100 }}
+        {{ message.message_top }}
         {% if message.url %}
              on {{ message.url }}
         {% endif %}
@@ -12,11 +12,11 @@
         {% if message.message_id %}
             <span class="tag tag-id">{{ message.message_id }}</span>
         {% endif %}
-        <span class="tag tag-level">{{ message.get_level_display }}</span> 
+        <span class="tag tag-level">{{ message.get_level_display }}</span>
         <span class="tag tag-server">{{ message.server_name }}</span>
         {% with message.get_version as version %}
             {% if version %}
-                <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span> 
+                <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span>
             {% endif %}
         {% endwith %}
         <span class="last_seen">{{ message.datetime|timesince }}</span>
diff --git a/sentry/web/views.py b/sentry/web/views.py
index 940e999fb9..8e0a336297 100644
--- a/sentry/web/views.py
+++ b/sentry/web/views.py
@@ -374,7 +374,12 @@ def group(request, group_id):
             template_info = get_template_info(sentry_data['template'], exc_value)
 
         if 'versions' in sentry_data:
-            version_data = sentry_data['versions'].iteritems()
+            version_data = sorted(sentry_data['versions'].iteritems())
+
+    if frames:
+        lastframe = frames[-1]
+    else:
+        lastframe = None
 
     return render_to_response('sentry/group/details.html', {
         'page': 'details',
@@ -383,6 +388,7 @@ def group(request, group_id):
         'user_data': user_data,
         'version_data': version_data,
         'frames': frames,
+        'lastframe': lastframe,
         'template_info': template_info,
         'request': request,
     })
@@ -412,6 +418,9 @@ def group_message_details(request, group_id, message_id):
     exc_type, exc_value = None, None
     # stack frames
     frames = None
+    lastframe = None
+    # module versions
+    version_data = None
     user_data = None
 
     if '__sentry__' in message.data:
@@ -438,13 +447,23 @@ def group_message_details(request, group_id, message_id):
         if 'template' in sentry_data:
             template_info = get_template_info(sentry_data['template'], exc_value)
 
+        if 'versions' in sentry_data:
+            version_data = sorted(sentry_data['versions'].iteritems())
+
+    if frames:
+        lastframe = frames[-1]
+    else:
+        lastframe = None
+
     return render_to_response('sentry/group/message.html', {
         'page': 'messages',
         'group': group,
         'message': message,
         'json_data': iter_data(message),
         'user_data': user_data,
+        'version_data': version_data,
         'frames': frames,
+        'lastframe': lastframe,
         'template_info': template_info,
         'request': request,
     })
