commit 7cd2c1e920c5c0fd61b6c8d327d506dc3aa6b5be
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Aug 1 23:28:07 2013 -0700

    Update tests and correct fetch_source

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index c37bb9bd8a..5c161f7a34 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -170,11 +170,13 @@ def expand_javascript_source(data, **kwargs):
         return
 
     # build list of frames that we can actually grab source for
-    frames = [
-        f for f in stacktrace.frames
-        if f.lineno is not None
-        and f.is_url()
-    ]
+    frames = []
+    for stacktrace in stacktraces:
+        frames.extend([
+            f for f in stacktrace.frames
+            if f.lineno is not None
+            and f.is_url()
+        ])
 
     if not frames:
         logger.debug('Event %r has no frames with enough context to fetch remote source', data['event_id'])
diff --git a/tests/sentry/tasks/fetch_source/tests.py b/tests/sentry/tasks/fetch_source/tests.py
index 122d91cc2f..04b8bf99f6 100644
--- a/tests/sentry/tasks/fetch_source/tests.py
+++ b/tests/sentry/tasks/fetch_source/tests.py
@@ -14,22 +14,26 @@ class ExpandJavascriptSourceTest(TestCase):
     @mock.patch('sentry.tasks.fetch_source.fetch_sourcemap')
     def test_calls_from_kwargs(self, fetch_sourcemap, fetch_url, update):
         data = {
-            'sentry.interfaces.Stacktrace': {
-                'frames': [
-                    {
-                        'abs_path': 'http://example.com/foo.js',
-                        'filename': 'foo.js',
-                        'lineno': 4,
-                        'colno': 0,
+            'sentry.interfaces.Exception': {
+                'values': [{
+                    'stacktrace': {
+                        'frames': [
+                            {
+                                'abs_path': 'http://example.com/foo.js',
+                                'filename': 'foo.js',
+                                'lineno': 4,
+                                'colno': 0,
+                            },
+                            {
+                                'abs_path': 'http://example.com/foo.js',
+                                'filename': 'foo.js',
+                                'lineno': 1,
+                                'colno': 0,
+                            },
+                        ],
                     },
-                    {
-                        'abs_path': 'http://example.com/foo.js',
-                        'filename': 'foo.js',
-                        'lineno': 1,
-                        'colno': 0,
-                    },
-                ],
-            },
+                }],
+            }
         }
         fetch_sourcemap.return_value = None
         fetch_url.return_value.body = '\n'.join('hello world')
@@ -38,7 +42,7 @@ class ExpandJavascriptSourceTest(TestCase):
 
         fetch_url.assert_called_once_with('http://example.com/foo.js')
 
-        frame_list = data['sentry.interfaces.Stacktrace']['frames']
+        frame_list = data['sentry.interfaces.Exception']['values'][0]['stacktrace']['frames']
         frame = frame_list[0]
         assert frame['pre_context'] == ['h', 'e', 'l']
         assert frame['context_line'] == 'l'
