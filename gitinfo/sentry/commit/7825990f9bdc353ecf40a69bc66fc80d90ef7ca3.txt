commit 7825990f9bdc353ecf40a69bc66fc80d90ef7ca3
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Thu May 17 11:51:27 2018 -0700

    fix(alerts): Fix viewing rule configs require write privs (#8475)
    
    Fixes JAVASCRIPT-3V9

diff --git a/src/sentry/static/sentry/app/views/settings/projectAlerts/projectAlertRules.jsx b/src/sentry/static/sentry/app/views/settings/projectAlerts/projectAlertRules.jsx
index 1453aec296..15bcaa5907 100644
--- a/src/sentry/static/sentry/app/views/settings/projectAlerts/projectAlertRules.jsx
+++ b/src/sentry/static/sentry/app/views/settings/projectAlerts/projectAlertRules.jsx
@@ -21,6 +21,8 @@ import EmptyStateWarning from 'app/components/emptyStateWarning';
 import EnvironmentStore from 'app/stores/environmentStore';
 import ListLink from 'app/components/listLink';
 import SettingsPageHeader from 'app/views/settings/components/settingsPageHeader';
+import SentryTypes from 'app/proptypes';
+import Tooltip from 'app/components/tooltip';
 import recreateRoute from 'app/utils/recreateRoute';
 import {conditionalGuideAnchor} from 'app/components/assistant/guideAnchor';
 
@@ -52,6 +54,7 @@ const RuleRow = createReactClass({
     data: PropTypes.object.isRequired,
     onDelete: PropTypes.func.isRequired,
     firstRule: PropTypes.bool,
+    canEdit: PropTypes.bool,
   },
 
   mixins: [ApiMixin],
@@ -87,7 +90,7 @@ const RuleRow = createReactClass({
   },
 
   render() {
-    const {data} = this.props;
+    const {data, canEdit} = this.props;
     const editLink = recreateRoute(`${data.id}/`, this.props);
 
     const env = EnvironmentStore.getByName(data.environment);
@@ -106,9 +109,20 @@ const RuleRow = createReactClass({
           </TextColorLink>
 
           <div>
-            <Button style={{marginRight: 5}} size="small" to={editLink}>
-              {t('Edit Rule')}
-            </Button>
+            <Tooltip
+              disabled={canEdit}
+              title={t('You do not have permission to view rule configuration.')}
+            >
+              <Button
+                data-test-id="edit-rule"
+                style={{marginRight: 5}}
+                disabled={!canEdit}
+                size="small"
+                to={editLink}
+              >
+                {t('Edit Rule')}
+              </Button>
+            </Tooltip>
 
             <Confirm
               message={t('Are you sure you want to remove this rule?')}
@@ -189,6 +203,10 @@ class ProjectAlertRules extends AsyncView {
     routes: PropTypes.array.isRequired,
   };
 
+  static contextTypes = {
+    organization: SentryTypes.Organization,
+  };
+
   getEndpoints() {
     let {orgId, projectId} = this.props.params;
     return [['ruleList', `/projects/${orgId}/${projectId}/rules/`]];
@@ -212,6 +230,9 @@ class ProjectAlertRules extends AsyncView {
 
   renderResults() {
     let {orgId, projectId} = this.props.params;
+    let {organization} = this.context;
+    let canEditRule = organization.access.includes('project:write');
+
     return (
       <div className="rules-list">
         {this.state.ruleList.map(rule => {
@@ -225,6 +246,7 @@ class ProjectAlertRules extends AsyncView {
               routes={this.props.routes}
               onDelete={this.handleDeleteRule.bind(this, rule)}
               firstRule={this.state.ruleList.indexOf(rule) === 0}
+              canEdit={canEditRule}
             />
           );
         })}
diff --git a/tests/js/spec/views/__snapshots__/projectAlertRules.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectAlertRules.spec.jsx.snap
index 9e6861362e..cd8d117272 100644
--- a/tests/js/spec/views/__snapshots__/projectAlertRules.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectAlertRules.spec.jsx.snap
@@ -306,6 +306,7 @@ exports[`projectAlertRules renders 1`] = `
         className="rules-list"
       >
         <RuleRow
+          canEdit={true}
           data={
             Object {
               "actions": Array [
@@ -393,21 +394,13 @@ exports[`projectAlertRules renders 1`] = `
                               </Link>
                             </TextColorLink>
                             <div>
-                              <Button
-                                disabled={false}
-                                size="small"
-                                style={
-                                  Object {
-                                    "marginRight": 5,
-                                  }
-                                }
-                                to="1/"
+                              <Tooltip
+                                disabled={true}
+                                title="You do not have permission to view rule configuration."
                               >
-                                <StyledButton
-                                  aria-label="Edit Rule"
+                                <Button
+                                  data-test-id="edit-rule"
                                   disabled={false}
-                                  onClick={[Function]}
-                                  role="button"
                                   size="small"
                                   style={
                                     Object {
@@ -416,9 +409,9 @@ exports[`projectAlertRules renders 1`] = `
                                   }
                                   to="1/"
                                 >
-                                  <Component
+                                  <StyledButton
                                     aria-label="Edit Rule"
-                                    className="css-dkprmi-StyledButton-getColors e17811v30"
+                                    data-test-id="edit-rule"
                                     disabled={false}
                                     onClick={[Function]}
                                     role="button"
@@ -430,12 +423,12 @@ exports[`projectAlertRules renders 1`] = `
                                     }
                                     to="1/"
                                   >
-                                    <Link
+                                    <Component
                                       aria-label="Edit Rule"
                                       className="css-dkprmi-StyledButton-getColors e17811v30"
+                                      data-test-id="edit-rule"
                                       disabled={false}
                                       onClick={[Function]}
-                                      onlyActiveOnIndex={false}
                                       role="button"
                                       size="small"
                                       style={
@@ -445,11 +438,13 @@ exports[`projectAlertRules renders 1`] = `
                                       }
                                       to="1/"
                                     >
-                                      <a
+                                      <Link
                                         aria-label="Edit Rule"
                                         className="css-dkprmi-StyledButton-getColors e17811v30"
+                                        data-test-id="edit-rule"
                                         disabled={false}
                                         onClick={[Function]}
+                                        onlyActiveOnIndex={false}
                                         role="button"
                                         size="small"
                                         style={
@@ -457,40 +452,56 @@ exports[`projectAlertRules renders 1`] = `
                                             "marginRight": 5,
                                           }
                                         }
+                                        to="1/"
                                       >
-                                        <ButtonLabel
+                                        <a
+                                          aria-label="Edit Rule"
+                                          className="css-dkprmi-StyledButton-getColors e17811v30"
+                                          data-test-id="edit-rule"
+                                          disabled={false}
+                                          onClick={[Function]}
+                                          role="button"
                                           size="small"
+                                          style={
+                                            Object {
+                                              "marginRight": 5,
+                                            }
+                                          }
                                         >
-                                          <Component
-                                            className="css-179w01k-ButtonLabel e17811v31"
+                                          <ButtonLabel
                                             size="small"
                                           >
-                                            <Flex
-                                              align="center"
+                                            <Component
                                               className="css-179w01k-ButtonLabel e17811v31"
                                               size="small"
                                             >
-                                              <Base
+                                              <Flex
                                                 align="center"
-                                                className="e17811v31 css-8mahft-ButtonLabel"
+                                                className="css-179w01k-ButtonLabel e17811v31"
                                                 size="small"
                                               >
-                                                <div
+                                                <Base
+                                                  align="center"
                                                   className="e17811v31 css-8mahft-ButtonLabel"
-                                                  is={null}
                                                   size="small"
                                                 >
-                                                  Edit Rule
-                                                </div>
-                                              </Base>
-                                            </Flex>
-                                          </Component>
-                                        </ButtonLabel>
-                                      </a>
-                                    </Link>
-                                  </Component>
-                                </StyledButton>
-                              </Button>
+                                                  <div
+                                                    className="e17811v31 css-8mahft-ButtonLabel"
+                                                    is={null}
+                                                    size="small"
+                                                  >
+                                                    Edit Rule
+                                                  </div>
+                                                </Base>
+                                              </Flex>
+                                            </Component>
+                                          </ButtonLabel>
+                                        </a>
+                                      </Link>
+                                    </Component>
+                                  </StyledButton>
+                                </Button>
+                              </Tooltip>
                               <Confirm
                                 cancelText="Cancel"
                                 confirmText="Confirm"
diff --git a/tests/js/spec/views/projectAlertRules.spec.jsx b/tests/js/spec/views/projectAlertRules.spec.jsx
index 6ed3f165bf..5fc1132cbb 100644
--- a/tests/js/spec/views/projectAlertRules.spec.jsx
+++ b/tests/js/spec/views/projectAlertRules.spec.jsx
@@ -41,4 +41,13 @@ describe('projectAlertRules', function() {
     wrapper.find('Modal Button[priority="primary"]').simulate('click');
     expect(deleteMock).toHaveBeenCalled();
   });
+
+  it('has disabled edit rule button without access', function() {
+    const wrapper = mount(
+      <ProjectAlertRules routes={[]} params={{orgId: 'org1', projectId: 'project1'}} />,
+      TestStubs.routerContext([{organization: TestStubs.Organization({access: []})}])
+    );
+
+    expect(wrapper.find('Button[data-test-id="edit-rule"]').prop('disabled')).toBe(true);
+  });
 });
