commit 36fb911ccd0997d1da996bf75d228b63c806d170
Author: Ben Vinegar <benvinegar@users.noreply.github.com>
Date:   Fri Jun 3 13:54:22 2016 -0700

    Fix raw_stacktrace processor breaking on individual frames w/o srcmap expansion (#3400)

diff --git a/src/sentry/lang/javascript/processor.py b/src/sentry/lang/javascript/processor.py
index 7a5061841d..e76cf70447 100644
--- a/src/sentry/lang/javascript/processor.py
+++ b/src/sentry/lang/javascript/processor.py
@@ -536,6 +536,9 @@ class SourceProcessor(object):
 
             raw_frames = []
             for frame in exc['stacktrace']['frames']:
+                if 'data' not in frame:
+                    continue
+
                 frame = frame['data']['raw']
 
                 if frame['lineno'] is not None:
diff --git a/tests/sentry/lang/javascript/test_plugin.py b/tests/sentry/lang/javascript/test_plugin.py
index c3779eb4e6..656e2cfadd 100644
--- a/tests/sentry/lang/javascript/test_plugin.py
+++ b/tests/sentry/lang/javascript/test_plugin.py
@@ -136,6 +136,8 @@ class JavascriptIntegrationTest(TestCase):
                       body=load_fixture('file2.js'))
         responses.add(responses.GET, 'http://example.com/file.sourcemap.js',
                       body=load_fixture('file.sourcemap.js'))
+        responses.add(responses.GET, 'http://example.com/index.html',
+                      body='Not Found', status=404)
 
         data = {
             'message': 'hello',
@@ -151,6 +153,16 @@ class JavascriptIntegrationTest(TestCase):
                                 'lineno': 1,
                                 'colno': 39,
                             },
+
+                            # NOTE: Intentionally source is not retrieved from this HTML file
+                            {
+                                'function': 'function: "HTMLDocument.<anonymous>"',
+                                'abs_path': "http//example.com/index.html",
+                                'filename': 'index.html',
+                                'lineno': 283,
+                                'colno': 17,
+                                'in_app': False,
+                            }
                         ],
                     },
                 }],
@@ -161,7 +173,7 @@ class JavascriptIntegrationTest(TestCase):
         assert resp.status_code, 200
 
         event = Event.objects.get()
-        assert not event.data['errors']
+        assert event.data['errors'] == [{'type': 'js_no_source', 'url': 'http//example.com/index.html'}]
 
         exception = event.interfaces['sentry.interfaces.Exception']
         frame_list = exception.values[0].stacktrace.frames
@@ -181,6 +193,10 @@ class JavascriptIntegrationTest(TestCase):
         assert raw_frame.post_context == ['//@ sourceMappingURL=file.sourcemap.js']
         assert raw_frame.lineno == 1
 
+        # Since we couldn't expand source for the 2nd frame, both
+        # its raw and original form should be identical
+        assert raw_frame_list[1] == frame_list[1]
+
     @responses.activate
     def test_expansion_via_release_artifacts(self):
         project = self.project
