commit 9a4a3f6f7171e65060aec5d72697a86f8e738d40
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Mon Jul 6 17:55:48 2020 -0700

    test(acceptance): Wait for images to load and input blur before snapshotting (#19730)
    
    This adds some methods to our selenium wrapper to wait for images to load before snapshotting. Also adds a method (which must be explicitly called) to force a blur on any focused elements.

diff --git a/src/sentry/utils/pytest/selenium.py b/src/sentry/utils/pytest/selenium.py
index 8bf9aa3728..baea2da3b9 100644
--- a/src/sentry/utils/pytest/selenium.py
+++ b/src/sentry/utils/pytest/selenium.py
@@ -190,6 +190,25 @@ class Browser(object):
 
         return self
 
+    def wait_for_images_loaded(self, timeout=10):
+        wait = WebDriverWait(self.driver, timeout)
+        wait.until(
+            lambda driver: driver.execute_script(
+                """return Object.values(document.querySelectorAll('img')).map(el => el.complete).every(i => i)"""
+            )
+        )
+
+        return self
+
+    def blur(self):
+        """
+        Find focused elements and call blur. Useful for snapshot testing that can potentially capture
+        the text cursor blinking
+        """
+        self.driver.execute_script("document.querySelectorAll(':focus').forEach(el => el.blur())")
+
+        return self
+
     @property
     def switch_to(self):
         return self.driver.switch_to
@@ -221,6 +240,9 @@ class Browser(object):
                 time.sleep(1)
 
         if os.environ.get("VISUAL_SNAPSHOT_ENABLE") == "1":
+            # wait for images to be loaded
+            self.wait_for_images_loaded()
+
             self.save_screenshot(
                 u".artifacts/visual-snapshots/acceptance/{}.png".format(slugify(name))
             )
diff --git a/tests/acceptance/test_incidents.py b/tests/acceptance/test_incidents.py
index 085e245071..dde8d2d5cc 100644
--- a/tests/acceptance/test_incidents.py
+++ b/tests/acceptance/test_incidents.py
@@ -49,4 +49,5 @@ class OrganizationIncidentsListTest(AcceptanceTestCase, SnubaTestCase):
             self.browser.wait_until_test_id("incident-title")
 
             self.browser.wait_until_not('[data-test-id="loading-placeholder"]')
+            self.browser.blur()
             self.browser.snapshot("incidents - details")
diff --git a/tests/acceptance/test_issue_details.py b/tests/acceptance/test_issue_details.py
index ff2e03b765..32d1c395b4 100644
--- a/tests/acceptance/test_issue_details.py
+++ b/tests/acceptance/test_issue_details.py
@@ -169,6 +169,7 @@ class IssueDetailsTest(AcceptanceTestCase, SnubaTestCase):
         self.page.go_to_subtab("Comments")
 
         self.browser.wait_until_test_id("activity-item")
+        self.browser.blur()
         self.browser.snapshot("issue activity python")
 
     def test_resolved(self):
