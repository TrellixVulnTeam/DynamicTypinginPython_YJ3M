commit 6abb248ad772378c434e0da9354d09360f13e047
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Wed Sep 19 09:20:23 2018 -0700

    ref(integrations): Add verify_ssl option to GHE (#9793)
    
    * add verify_ssl

diff --git a/src/sentry/integrations/github_enterprise/client.py b/src/sentry/integrations/github_enterprise/client.py
index 5ede54a6fa..42acd3b8cf 100644
--- a/src/sentry/integrations/github_enterprise/client.py
+++ b/src/sentry/integrations/github_enterprise/client.py
@@ -8,13 +8,12 @@ from sentry.integrations.github.client import GitHubClientMixin
 class GitHubEnterpriseAppsClient(GitHubClientMixin):
     base_url = None
 
-    def __init__(self, base_url, integration, app_id, private_key):
+    def __init__(self, base_url, integration, app_id, private_key, verify_ssl):
         self.base_url = u"https://{}/api/v3".format(base_url)
         self.integration = integration
         self.app_id = app_id
         self.private_key = private_key
-        # verify_ssl=false is for testing purposes and should be removed before release
-        super(GitHubEnterpriseAppsClient, self).__init__(verify_ssl=False)
+        super(GitHubEnterpriseAppsClient, self).__init__(verify_ssl=verify_ssl)
 
     def get_jwt(self):
         return get_jwt(github_id=self.app_id, github_private_key=self.private_key)
diff --git a/src/sentry/integrations/github_enterprise/integration.py b/src/sentry/integrations/github_enterprise/integration.py
index b6a02d2656..3d85372ea4 100644
--- a/src/sentry/integrations/github_enterprise/integration.py
+++ b/src/sentry/integrations/github_enterprise/integration.py
@@ -89,6 +89,7 @@ class GitHubEnterpriseIntegration(IntegrationInstallation, GitHubIssueBasic, Rep
             integration=self.model,
             private_key=self.model.metadata['installation']['private_key'],
             app_id=self.model.metadata['installation']['id'],
+            verify_ssl=self.model.metadata['installation']['verify_ssl'],
         )
 
     def get_repositories(self, query=None):
@@ -145,6 +146,14 @@ class InstallationForm(forms.Form):
             attrs={'placeholder': _('our-sentry-app')}
         )
     )
+    verify_ssl = forms.BooleanField(
+        label=_("Verify SSL"),
+        help_text=_('By default, we verify SSL certificates '
+                    'when delivering payloads to your GitHub '
+                    'Enterprise instance'),
+        widget=forms.CheckboxInput(),
+        required=False
+    )
     webhook_secret = forms.CharField(
         label="GitHub App Webhook Secret",
         help_text=_('We require a webhook secret to be '
@@ -185,6 +194,7 @@ class InstallationForm(forms.Form):
 
     def __init__(self, *args, **kwargs):
         super(InstallationForm, self).__init__(*args, **kwargs)
+        self.fields['verify_ssl'].initial = True
 
 
 class InstallationConfigView(PipelineView):
@@ -201,6 +211,7 @@ class InstallationConfigView(PipelineView):
                 "authorize_url": u"https://{}/login/oauth/authorize".format(form_data.get('url')),
                 "client_id": form_data.get('client_id'),
                 "client_secret": form_data.get('client_secret'),
+                "verify_ssl": form_data.get('verify_ssl'),
             })
 
             return pipeline.next_step()
@@ -232,7 +243,6 @@ class GitHubEnterpriseIntegrationProvider(GitHubIntegrationProvider):
         identity_pipeline_config = dict(
             oauth_scopes=(),
             redirect_url=absolute_uri('/extensions/github-enterprise/setup/'),
-            verify_ssl=False,
             **self.pipeline.fetch_state('oauth_config_information')
         )
 
@@ -264,7 +274,7 @@ class GitHubEnterpriseIntegrationProvider(GitHubIntegrationProvider):
                 'Authorization': 'Bearer %s' % get_jwt(github_id=installation_data['id'], github_private_key=installation_data['private_key']),
                 'Accept': 'application/vnd.github.machine-man-preview+json',
             },
-            verify=False
+            verify=installation_data['verify_ssl']
         )
         resp.raise_for_status()
         installation_resp = resp.json()
@@ -273,7 +283,7 @@ class GitHubEnterpriseIntegrationProvider(GitHubIntegrationProvider):
             u'https://{}/api/v3/user/installations'.format(installation_data['url']),
             params={'access_token': access_token},
             headers={'Accept': 'application/vnd.github.machine-man-preview+json'},
-            verify=False
+            verify=installation_data['verify_ssl']
         )
         resp.raise_for_status()
         user_installations_resp = resp.json()
diff --git a/tests/sentry/integrations/github_enterprise/test_integration.py b/tests/sentry/integrations/github_enterprise/test_integration.py
index 8d38535fe6..644e4571c1 100644
--- a/tests/sentry/integrations/github_enterprise/test_integration.py
+++ b/tests/sentry/integrations/github_enterprise/test_integration.py
@@ -21,7 +21,8 @@ class GitHubEnterpriseIntegrationTest(IntegrationTestCase):
         'client_id': 'client_id',
         'client_secret': 'client_secret',
         'webhook_secret': 'webhook_secret',
-        'private_key': 'private_key'
+        'private_key': 'private_key',
+        'verify_ssl': True,
     }
 
     @patch('sentry.integrations.github_enterprise.integration.get_jwt', return_value='jwt_token_1')
@@ -150,6 +151,7 @@ class GitHubEnterpriseIntegrationTest(IntegrationTestCase):
                 u'private_key': u'private_key',
                 u'url': u'35.232.149.196',
                 u'webhook_secret': u'webhook_secret',
+                u'verify_ssl': True,
             }
         }
         oi = OrganizationIntegration.objects.get(
diff --git a/tests/sentry/integrations/github_enterprise/test_issues.py b/tests/sentry/integrations/github_enterprise/test_issues.py
index 1c5eafc054..760c58cd39 100644
--- a/tests/sentry/integrations/github_enterprise/test_issues.py
+++ b/tests/sentry/integrations/github_enterprise/test_issues.py
@@ -29,7 +29,8 @@ class GitHubEnterpriseIssueBasicTest(TestCase):
                 'installation_id': 'installation_id',
                 'installation': {
                     'id': 2,
-                    'private_key': 'private_key'}}
+                    'private_key': 'private_key',
+                    'verify_ssl': True}}
         )
         self.model.add_organization(self.organization, self.user)
         self.integration = GitHubEnterpriseIntegration(self.model, self.organization.id)
diff --git a/tests/sentry/integrations/github_enterprise/test_webhooks.py b/tests/sentry/integrations/github_enterprise/test_webhooks.py
index e1eb507f3b..1b5c8ef74d 100644
--- a/tests/sentry/integrations/github_enterprise/test_webhooks.py
+++ b/tests/sentry/integrations/github_enterprise/test_webhooks.py
@@ -81,6 +81,7 @@ class PushEventWebhookTest(APITestCase):
             'name': 'test-app',
             'webhook_secret': 'b3002c3e321d4b7880360d397db2ccfd',
             'private_key': 'private_key',
+            'verify_ssl': True,
         }
 
         Repository.objects.create(
@@ -98,6 +99,7 @@ class PushEventWebhookTest(APITestCase):
                 'installation': {
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
@@ -152,6 +154,7 @@ class PushEventWebhookTest(APITestCase):
             'name': 'test-app',
             'webhook_secret': 'b3002c3e321d4b7880360d397db2ccfd',
             'private_key': 'private_key',
+            'verify_ssl': True,
         }
 
         integration = Integration.objects.create(
@@ -163,6 +166,7 @@ class PushEventWebhookTest(APITestCase):
                 'installation': {
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
@@ -233,6 +237,7 @@ class PushEventWebhookTest(APITestCase):
             'name': 'test-app',
             'webhook_secret': 'b3002c3e321d4b7880360d397db2ccfd',
             'private_key': 'private_key',
+            'verify_ssl': True,
         }
 
         Repository.objects.create(
@@ -250,6 +255,7 @@ class PushEventWebhookTest(APITestCase):
                 'installation': {
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
@@ -273,6 +279,7 @@ class PushEventWebhookTest(APITestCase):
                     'installation_id': '99',
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
@@ -318,6 +325,7 @@ class PullRequestEventWebhook(APITestCase):
             'name': 'test-app',
             'webhook_secret': 'b3002c3e321d4b7880360d397db2ccfd',
             'private_key': 'private_key',
+            'verify_ssl': True,
         }
 
         integration = Integration.objects.create(
@@ -329,6 +337,7 @@ class PullRequestEventWebhook(APITestCase):
                 'installation': {
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
@@ -378,6 +387,7 @@ class PullRequestEventWebhook(APITestCase):
             'name': 'test-app',
             'webhook_secret': 'b3002c3e321d4b7880360d397db2ccfd',
             'private_key': 'private_key',
+            'verify_ssl': True,
         }
 
         integration = Integration.objects.create(
@@ -389,6 +399,7 @@ class PullRequestEventWebhook(APITestCase):
                 'installation': {
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
@@ -437,6 +448,7 @@ class PullRequestEventWebhook(APITestCase):
             'name': 'test-app',
             'webhook_secret': 'b3002c3e321d4b7880360d397db2ccfd',
             'private_key': 'private_key',
+            'verify_ssl': True,
         }
 
         integration = Integration.objects.create(
@@ -448,6 +460,7 @@ class PullRequestEventWebhook(APITestCase):
                 'installation': {
                     'id': '2',
                     'private_key': 'private_key',
+                    'verify_ssl': True,
                 }
             }
         )
