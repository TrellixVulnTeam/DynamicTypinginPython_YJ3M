commit c7172df79cfd5a248228e4b18698112adb59f13d
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Jun 28 10:34:55 2013 -0700

    Handle cases where values are not set with alert emails

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index ecaf12c28b..8d724ac194 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -113,13 +113,14 @@ class MailPlugin(NotificationPlugin):
         email_list = set()
         user_ids = set(user_ids)
 
+        # XXX: It's possible that options have been set to an empty value
         if project:
             alert_queryset = UserOption.objects.filter(
                 project=project,
                 user__in=user_ids,
                 key='mail:email',
             )
-            for option in alert_queryset:
+            for option in (o for o in alert_queryset if o.value):
                 user_ids.remove(option.user_id)
                 email_list.add(option.value)
 
@@ -128,7 +129,7 @@ class MailPlugin(NotificationPlugin):
                 user__in=user_ids,
                 key='alert_email',
             )
-            for option in alert_queryset:
+            for option in (o for o in alert_queryset if o.value):
                 user_ids.remove(option.user_id)
                 email_list.add(option.value)
 
diff --git a/src/sentry/web/forms/accounts.py b/src/sentry/web/forms/accounts.py
index 607b183c9c..f63c4b1370 100644
--- a/src/sentry/web/forms/accounts.py
+++ b/src/sentry/web/forms/accounts.py
@@ -182,7 +182,11 @@ class ProjectEmailOptionsForm(forms.Form):
             self.user, self.project, 'mail:alert',
             int(self.cleaned_data['alert']),
         )
-        UserOption.objects.set_value(
-            self.user, self.project, 'mail:email',
-            self.cleaned_data['email'],
-        )
+        if self.cleaned_data['email']:
+            UserOption.objects.set_value(
+                self.user, self.project, 'mail:email',
+                self.cleaned_data['email'],
+            )
+        else:
+            UserOption.objects.unset_value(
+                self.user, self.project, 'mail:email')
