commit 8b5d7ea2eb2e45f9e59b3f6674883a94744f9646
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Jan 12 11:42:08 2015 -0600

    Handle X-Forwarded-For header (fixes GH-1254)

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 39d1f7c934..ba76428e09 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -118,6 +118,7 @@ TEMPLATE_LOADERS = (
 
 MIDDLEWARE_CLASSES = (
     'sentry.middleware.maintenance.ServicesUnavailableMiddleware',
+    'sentry.middleware.proxy.SetRemoteAddrFromForwardedFor',
     'sentry.middleware.debug.NoIfModifiedSinceMiddleware',
     'django.middleware.common.CommonMiddleware',
     'django.contrib.sessions.middleware.SessionMiddleware',
diff --git a/src/sentry/middleware/proxy.py b/src/sentry/middleware/proxy.py
new file mode 100644
index 0000000000..59e2c3d7b7
--- /dev/null
+++ b/src/sentry/middleware/proxy.py
@@ -0,0 +1,14 @@
+from __future__ import absolute_import
+
+
+class SetRemoteAddrFromForwardedFor(object):
+    def process_request(self, request):
+        try:
+            real_ip = request.META['HTTP_X_FORWARDED_FOR']
+        except KeyError:
+            pass
+        else:
+            # HTTP_X_FORWARDED_FOR can be a comma-separated list of IPs.
+            # Take just the first one.
+            real_ip = real_ip.split(",")[0]
+            request.META['REMOTE_ADDR'] = real_ip
