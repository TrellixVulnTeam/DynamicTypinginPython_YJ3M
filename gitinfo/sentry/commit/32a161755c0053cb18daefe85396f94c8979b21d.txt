commit 32a161755c0053cb18daefe85396f94c8979b21d
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Mar 1 02:49:48 2012 -0800

    Added user search/sort and improved project sort/search

diff --git a/sentry/templates/sentry/admin/projects/list.html b/sentry/templates/sentry/admin/projects/list.html
index d805cbcdad..97b569f050 100644
--- a/sentry/templates/sentry/admin/projects/list.html
+++ b/sentry/templates/sentry/admin/projects/list.html
@@ -17,17 +17,17 @@
     {% paginate project_list from request as project_list per_page 50 %}
 
     <section class="body">
-        {% if project_list.objects %}
-            <form class="btn-toolbar" method="GET" action="">
-                <input type="text" name="pquery" value="{% if project_query %}{{ project_query }}{% endif %}" placeholder="search by project name">
-                <div class="btn-group pull-right">
-                    <a class="btn prev{% if not project_list.paginator.has_previous %} disabled{% endif %}" href="?{{ project_list.query_string|escape }}&amp;p={{ project_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
-                    <a class="btn next{% if not project_list.paginator.has_next %} disabled{% endif %}" href="?{{ project_list.query_string|escape }}&amp;p={{ project_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
-                </div>
-            </form>
+        <form class="btn-toolbar" method="GET" action="">
+            <input type="text" name="pquery" value="{% if project_query %}{{ project_query }}{% endif %}" placeholder="search by project name">
+            <div class="btn-group pull-right">
+                <a class="btn prev{% if not project_list.paginator.has_previous %} disabled{% endif %}" href="?{{ project_list.query_string|escape }}&amp;p={{ project_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
+                <a class="btn next{% if not project_list.paginator.has_next %} disabled{% endif %}" href="?{{ project_list.query_string|escape }}&amp;p={{ project_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
+            </div>
+        </form>
 
-            {% querystring from request without sort as sort_querystring %}
+        {% querystring from request without sort as sort_querystring %}
 
+        {% if project_list.objects %}
             <table class="table table-bordered">
                 <colgroup>
                     <col>
@@ -68,10 +68,10 @@
                 </tbody>
             </table>
 
-            {{ project_list.paging }}
         {% else %}
             <p class="alert alert-notice">{% trans "There are no active projects in Sentry." %}</p>
         {% endif %}
 
+        {{ project_list.paging }}
     </section>
 {% endblock %}
diff --git a/sentry/templates/sentry/admin/users/list.html b/sentry/templates/sentry/admin/users/list.html
index 703e6edbb8..7959e89225 100644
--- a/sentry/templates/sentry/admin/users/list.html
+++ b/sentry/templates/sentry/admin/users/list.html
@@ -20,8 +20,16 @@
 {% block inner %}
     {% paginate user_list from request as user_list per_page 50 %}
 
+    <form class="btn-toolbar" method="GET" action="">
+        <input type="text" name="uquery" value="{% if user_query %}{{ user_query }}{% endif %}" placeholder="search by email address">
+        <div class="btn-group pull-right">
+            <a class="btn prev{% if not user_list.paginator.has_previous %} disabled{% endif %}" href="?{{ user_list.query_string|escape }}&amp;p={{ user_list.paginator.previous_page }}"><span>{% trans "Previous" %}</span></a>
+            <a class="btn next{% if not user_list.paginator.has_next %} disabled{% endif %}" href="?{{ user_list.query_string|escape }}&amp;p={{ user_list.paginator.next_page }}"><span>{% trans "Next" %}</span></a>
+        </div>
+    </form>
+
     {% if user_list.objects %}
-        {{ user_list.paging }}
+        {% querystring from request without sort as sort_querystring %}
 
         <table class="table table-bordered">
             <colgroup>
@@ -32,10 +40,10 @@
             </colgroup>
             <thead>
                 <tr>
-                    <th>{% trans "Name" %}</th>
-                    <th style="text-align:center;">{% trans "Joined" %}</th>
-                    <th style="text-align:center;">{% trans "Last Login" %}</th>
-                    <th style="text-align:center;">{% trans "Projects" %}</th>
+                    <th><a href="?{{ sort_querystring }}&amp;sort=name">{% trans "Name" %}</a></th>
+                    <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=joined">{% trans "Joined" %}</a></th>
+                    <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=login">{% trans "Last Login" %}</a></th>
+                    <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=projects">{% trans "Projects" %}</a></th>
                 </tr>
             </thead>
             <tbody>
@@ -71,9 +79,10 @@
             </tbody>
         </table>
 
-        {{ user_list.paging }}
-
     {% else %}
-        <p class="alert alert-notice">{% trans "There are no active users in Sentry." %}</p>
+        <p class="alert alert-notice">{% trans "There are no users matching your query in Sentry." %}</p>
     {% endif %}
+
+    {{ user_list.paging }}
+
 {% endblock %}
diff --git a/sentry/web/frontend/admin.py b/sentry/web/frontend/admin.py
index d20ff1e2be..5311c082a9 100644
--- a/sentry/web/frontend/admin.py
+++ b/sentry/web/frontend/admin.py
@@ -49,10 +49,6 @@ def configure_plugin(request, slug):
 
 @requires_admin
 def manage_projects(request):
-    sort = request.GET.get('sort')
-    if sort not in ('name', 'date', 'events'):
-        sort = 'date'
-
     project_list = Project.objects.filter(
         status=0,
     ).exclude(
@@ -64,7 +60,11 @@ def manage_projects(request):
 
     project_query = request.GET.get('pquery')
     if project_query:
-        project_list = project_list.filter(name__iexact=project_query)
+        project_list = project_list.filter(name__icontains=project_query)
+
+    sort = request.GET.get('sort')
+    if sort not in ('name', 'date', 'events'):
+        sort = 'date'
 
     if sort == 'date':
         order_by = '-date_added'
@@ -86,11 +86,32 @@ def manage_projects(request):
 
 @requires_admin
 def manage_users(request):
-    users = User.objects.annotate(num_projects=Count('sentry_project_set'))\
+    user_list = User.objects.annotate(num_projects=Count('sentry_project_set'))\
                 .order_by('-date_joined')
 
+    user_query = request.GET.get('uquery')
+    if user_query:
+        user_list = user_list.filter(email__icontains=user_query)
+
+    sort = request.GET.get('sort')
+    if sort not in ('name', 'joined', 'login', 'projects'):
+        sort = 'joined'
+
+    if sort == 'joined':
+        order_by = '-date_joined'
+    elif sort == 'login':
+        order_by = '-last_login'
+    elif sort == 'name':
+        order_by = 'first_name'
+    elif sort == 'projects':
+        order_by = '-num_projects'
+
+    user_list = user_list.order_by(order_by)
+
     return render_to_response('sentry/admin/users/list.html', {
-        'user_list': users,
+        'user_list': user_list,
+        'user_query': user_query,
+        'sort': sort,
     }, request)
 
 
