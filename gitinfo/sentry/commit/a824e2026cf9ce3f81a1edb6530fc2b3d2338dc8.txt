commit a824e2026cf9ce3f81a1edb6530fc2b3d2338dc8
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Wed May 25 20:24:12 2016 +0200

    Fix sudo in absence of u2f

diff --git a/src/sentry/web/frontend/sudo.py b/src/sentry/web/frontend/sudo.py
index f80bfc8752..39951948cd 100644
--- a/src/sentry/web/frontend/sudo.py
+++ b/src/sentry/web/frontend/sudo.py
@@ -13,20 +13,23 @@ class SudoView(BaseSudoView):
         if BaseSudoView.handle_sudo(self, request, redirect_to, context):
             return True
 
-        interface = Authenticator.objects.get_interface(request.user, 'u2f')
-
-        if interface.is_available and interface.is_enrolled:
-            challenge = interface.activate(request).challenge
-            if request.method == 'POST':
-                if 'challenge' in request.POST and 'response' in request.POST:
-                    try:
-                        challenge = json.loads(request.POST['challenge'])
-                        response = json.loads(request.POST['response'])
-                    except ValueError:
-                        pass
-                    else:
-                        if interface.validate_response(request, challenge, response):
-                            return True
-            context['u2f_challenge'] = challenge
-
+        try:
+            interface = Authenticator.objects.get_interface(request.user, 'u2f')
+            if not interface.is_enrolled:
+                raise LookupError()
+        except LookupError:
+            return False
+
+        challenge = interface.activate(request).challenge
+        if request.method == 'POST':
+            if 'challenge' in request.POST and 'response' in request.POST:
+                try:
+                    challenge = json.loads(request.POST['challenge'])
+                    response = json.loads(request.POST['response'])
+                except ValueError:
+                    pass
+                else:
+                    if interface.validate_response(request, challenge, response):
+                        return True
+        context['u2f_challenge'] = challenge
         return False
