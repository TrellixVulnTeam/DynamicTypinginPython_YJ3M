commit b0fa526b28df4a4b557c874298e9a2aa97ee3098
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Wed Mar 7 13:30:53 2018 -0600

    fix: Filter merge queries by project/project_id when possible (#7501)
    
    Fixes SENTRY-61R

diff --git a/src/sentry/tasks/merge.py b/src/sentry/tasks/merge.py
index 116bbcd361..13ebce936d 100644
--- a/src/sentry/tasks/merge.py
+++ b/src/sentry/tasks/merge.py
@@ -301,18 +301,28 @@ def merge_objects(models, group, new_group, limit=1000, logger=None, transaction
     has_more = False
     for model in models:
         all_fields = model._meta.get_all_field_names()
+
+        # not all models have a 'project' or 'project_id' field, but we make a best effort
+        # to filter on one if it is available
+        has_project = 'project_id' in all_fields or 'project' in all_fields
+        if has_project:
+            project_qs = model.objects.filter(project_id=group.project_id)
+        else:
+            project_qs = model.objects.all()
+
         has_group = 'group' in all_fields
         if has_group:
-            queryset = model.objects.filter(group=group)
+            queryset = project_qs.filter(group=group)
         else:
-            queryset = model.objects.filter(group_id=group.id)
+            queryset = project_qs.filter(group_id=group.id)
+
         for obj in queryset[:limit]:
             try:
                 with transaction.atomic(using=router.db_for_write(model)):
                     if has_group:
-                        model.objects.filter(id=obj.id).update(group=new_group)
+                        project_qs.filter(id=obj.id).update(group=new_group)
                     else:
-                        model.objects.filter(id=obj.id).update(group_id=new_group.id)
+                        project_qs.filter(id=obj.id).update(group_id=new_group.id)
             except IntegrityError:
                 delete = True
             else:
