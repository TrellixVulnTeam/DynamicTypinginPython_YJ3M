commit 9abbb0cde36cc959f2eb11528a231416e454ea7a
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Dec 30 01:50:39 2011 -0800

    Added queue status and changed default queue to 'sentry.default'

diff --git a/sentry/queue/client.py b/sentry/queue/client.py
index 887143126c..7accca6832 100644
--- a/sentry/queue/client.py
+++ b/sentry/queue/client.py
@@ -32,8 +32,8 @@ class Broker(object):
                 exchange=task_exchange,
                 serializer="pickle",
                 compression="bzip2",
-                queue='default',
-                routing_key='default',
+                queue='sentry.default',
+                routing_key='sentry.default',
             )
 
 broker = Broker(settings.QUEUE)
diff --git a/sentry/queue/queues.py b/sentry/queue/queues.py
index f8031e983f..e2af22dd97 100644
--- a/sentry/queue/queues.py
+++ b/sentry/queue/queues.py
@@ -7,7 +7,8 @@ sentry.queue.queues
 """
 from kombu import Exchange, Queue
 
+# All queues should be prefixed with "sentry."
 task_exchange = Exchange("tasks", type="direct")
 task_queues = [
-    Queue("default", task_exchange, routing_key="default"),
+    Queue("sentry.default", task_exchange, routing_key="sentry.default"),
 ]
diff --git a/sentry/templates/sentry/status.html b/sentry/templates/sentry/status.html
index abe52a920a..d943bdad81 100644
--- a/sentry/templates/sentry/status.html
+++ b/sentry/templates/sentry/status.html
@@ -12,6 +12,7 @@
         <ul class="tabs" data-tabs="tabs">
             <li class="active"><a href="#main">Environment</a></li>
             <li><a href="#packages">Packages</a></li>
+            <li><a href="#workers">Workers</a></li>
         </ul>
         <div class="tab-content">
             <div id="main" class="active">
@@ -97,6 +98,47 @@
                     </tbody>
                 </table>
             </div>
+            {% if worker_status %}
+            <div id="workers">
+                <div class="page-header">
+                    <h2>Background Processes</h2>
+                </div>
+                {% if background_procs %}
+                    <table class="vars bordered-table zebra-striped">
+                        <colgroup>
+                            <col style="width:220px">
+                        </colgroup>
+                        <tbody>
+                        </tbody>
+                    </table>
+                {% else %}
+                    <p>No information available.</p>
+                {% endif %}
+                <div class="page-header">
+                    <h2>Pending Tasks</h2>
+                </div>
+                <table class="vars bordered-table zebra-striped">
+                    <colgroup>
+                        <col>
+                        <col style="width:150px">
+                    </colgroup>
+                    <thead>
+                        <tr>
+                            <th>Queue</th>
+                            <th>Pending Tasks</th>
+                        </tr>
+                    </thead>
+                    <tbody>
+                        {% for queue, num_pending in pending_tasks %}
+                            <tr>
+                                <td>{{ queue }}</td>
+                                <td>{{ num_pending }}</td>
+                            </tr>
+                        {% endfor %}
+                    </tbody>
+                </table>
+            </div>
+            {% endif %}
         </div>
     </div>
 {% endblock %}
diff --git a/sentry/web/frontend/generic.py b/sentry/web/frontend/generic.py
index 28f61a4cda..5fa5b37eeb 100644
--- a/sentry/web/frontend/generic.py
+++ b/sentry/web/frontend/generic.py
@@ -2,8 +2,10 @@ import pkg_resources
 import sys
 
 from django.core.urlresolvers import reverse
+from django.db.models import Sum
 from django.http import HttpResponseRedirect, Http404, HttpResponseNotModified, \
   HttpResponse
+from djkombu.models import Queue
 
 from sentry import environment
 from sentry.conf import settings
@@ -32,12 +34,26 @@ def status(request):
             continue
         config.append((k, getattr(settings, k)))
 
+    worker_status = (settings.QUEUE['transport'] == 'djkombu.transport.DatabaseTransport')
+    if worker_status:
+        pending_tasks = list(Queue.objects.filter(
+            messages__visible=True,
+        ).annotate(num=Sum('messages__id')).values_list('name', 'num'))
+        # fetch queues which had no pending tasks
+        pending_tasks.extend((q, 0) for q in Queue.objects.exclude(
+            name__in=[p[0] for p in pending_tasks],
+        ).values_list('name', flat=True))
+    else:
+        pending_tasks = None
+
     return render_to_response('sentry/status.html', {
         'config': config,
         'environment': environment,
         'python_version': sys.version,
         'modules': sorted([(p.project_name, p.version) for p in pkg_resources.working_set]),
         'extensions': [(cls.title, cls.__module__.rsplit('.', 1)[0]) for cls in GroupActionProvider.plugins.itervalues()],
+        'pending_tasks': pending_tasks,
+        'worker_status': worker_status,
     }, request)
 
 
