commit c934e5ec101852a29e518055d8ef030c91251f97
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Oct 9 12:21:07 2015 -0700

    Add global asset version

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 91f5e05e05..778cdced9f 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -14,7 +14,6 @@ from django.conf.global_settings import *  # NOQA
 from datetime import timedelta
 
 import hashlib
-import json
 import os
 import os.path
 import socket
@@ -261,12 +260,17 @@ STATICFILES_FINDERS = (
     "django.contrib.staticfiles.finders.AppDirectoriesFinder",
 )
 
-ASSET_MANIFEST_PATH = os.path.join(STATIC_ROOT, 'sentry', 'dist', 'manifest.json')
-try:
-    with open(ASSET_MANIFEST_PATH) as manifest_file:
-        ASSET_MANIFEST = json.load(manifest_file)
-except IOError:
-    ASSET_MANIFEST = {}
+
+def get_asset_version():
+    path = os.path.join(STATIC_ROOT, 'sentry', 'dist', 'version')
+    try:
+        with open(path) as fp:
+            return fp.read().strip()
+    except IOError:
+        from time import time
+        return int(time())
+
+ASSET_VERSION = get_asset_version()
 
 # setup a default media root to somewhere useless
 MEDIA_ROOT = '/tmp/sentry-media'
diff --git a/src/sentry/templates/sentry/auth-link-identity.html b/src/sentry/templates/sentry/auth-link-identity.html
index 1fc28316f1..2c9beeec71 100644
--- a/src/sentry/templates/sentry/auth-link-identity.html
+++ b/src/sentry/templates/sentry/auth-link-identity.html
@@ -2,6 +2,7 @@
 
 {% load crispy_forms_tags %}
 {% load i18n %}
+{% load sentry_assets %}
 
 {% block title %}{% trans "Link Identity" %} | {{ block.super }}{% endblock %}
 
@@ -10,7 +11,7 @@
     {% csrf_token %}
 
     <div class="align-center">
-      <img src="{% url 'sentry-media' "sentry" "images/default-organization-logo.png" %}" class="org-avatar">
+      <img src="{% asset_url "sentry" "images/default-organization-logo.png" %}" class="org-avatar">
 
       <h3>{{ organization.name }}</h3>
     </div>
diff --git a/src/sentry/templates/sentry/auth-link-login.html b/src/sentry/templates/sentry/auth-link-login.html
index 4c054eb48d..dd88f70fab 100644
--- a/src/sentry/templates/sentry/auth-link-login.html
+++ b/src/sentry/templates/sentry/auth-link-login.html
@@ -2,12 +2,13 @@
 
 {% load crispy_forms_tags %}
 {% load i18n %}
+{% load sentry_assets %}
 
 {% block title %}{% trans "Login" %} | {{ block.super }}{% endblock %}
 
 {% block content %}
   <div class="align-center">
-    <img src="{% url 'sentry-media' "sentry" "images/default-organization-logo.png" %}" class="org-avatar">
+    <img src="{% asset_url "sentry" "images/default-organization-logo.png" %}" class="org-avatar">
 
     <h3>{{ organization.name }}</h3>
   </div>
diff --git a/src/sentry/templates/sentry/layout.html b/src/sentry/templates/sentry/layout.html
index 80c1b033c8..8ec5089a9f 100644
--- a/src/sentry/templates/sentry/layout.html
+++ b/src/sentry/templates/sentry/layout.html
@@ -16,20 +16,17 @@
   <meta name="robots" content="NONE,NOARCHIVE">
   <meta name="viewport" content="width=device-width, initial-scale=1">
 
-  <link href="{% url 'sentry-media' "sentry" "images/favicon.ico" %}" rel="shortcut icon" type="image/png"/>
+  <link href="{% asset_url "sentry" "images/favicon.ico" %}" rel="shortcut icon" type="image/png"/>
 
   {% block css %}
-  <link href="{% asset_url 'sentry-media' "sentry" "dist/sentry.css" %}" rel="stylesheet"/>
+  <link href="{% asset_url "sentry" "dist/sentry.css" %}" rel="stylesheet"/>
   {% endblock %}
 
   <title>{% block title %}Sentry{% endblock %}</title>
 
-  <!--[if lt IE 9]>
-  <script type="text/javascript" src="{% url 'sentry-media' "sentry" "scripts/lib/html5shiv.js" %}"></script>
-  <![endif]-->
   {% block scripts %}
-  <script src="{% asset_url 'sentry-media' "sentry" "dist/vendor.js" %}"></script>
-  <script src="{% asset_url 'sentry-media' "sentry" "dist/app.js" %}"></script>
+  <script src="{% asset_url "sentry" "dist/vendor.js" %}"></script>
+  <script src="{% asset_url "sentry" "dist/app.js" %}"></script>
 
   <script>
     for (var n in window.exports) {
@@ -44,7 +41,7 @@
 
     Sentry.ConfigStore.loadInitialData({% get_react_config %});
   </script>
-  <script src="{% url 'sentry-media' 'sentry' 'js/ads.js' %}"></script>
+  <script src="{% asset_url 'sentry' 'js/ads.js' %}"></script>
 
   {% include "sentry/includes/ravenjs.html" %}
   {% endblock %}
diff --git a/src/sentry/templates/sentry/organization-login.html b/src/sentry/templates/sentry/organization-login.html
index 3df208c809..638796572c 100644
--- a/src/sentry/templates/sentry/organization-login.html
+++ b/src/sentry/templates/sentry/organization-login.html
@@ -2,12 +2,13 @@
 
 {% load crispy_forms_tags %}
 {% load i18n %}
+{% load sentry_assets %}
 
 {% block title %}{% trans "Login" %} | {{ block.super }}{% endblock %}
 
 {% block content %}
   <div class="align-center">
-    <img src="{% url 'sentry-media' "sentry" "images/default-organization-logo.png" %}" class="org-avatar">
+    <img src="{% asset_url "sentry" "images/default-organization-logo.png" %}" class="org-avatar">
 
     <h3>{{ organization.name }}</h3>
   </div>
diff --git a/src/sentry/templatetags/sentry_assets.py b/src/sentry/templatetags/sentry_assets.py
index b13045dd0a..89b0b63686 100644
--- a/src/sentry/templatetags/sentry_assets.py
+++ b/src/sentry/templatetags/sentry_assets.py
@@ -1,42 +1,23 @@
 from __future__ import absolute_import
 
-from django.template import Library
-from django.template.defaulttags import URLNode, url
-
 from django.conf import settings
+from django.core.urlresolvers import reverse
+from django.template import Library
 
 register = Library()
 
 
-class AssetURLNode(URLNode):
-    def render(self, context):
-        path = super(AssetURLNode, self).render(context)
-        parts = path.rsplit('/', 1)
-        last = parts[-1]
-
-        try:
-            parts[-1] = settings.ASSET_MANIFEST[last]
-        except KeyError:
-            return path
-
-        return '/'.join(parts)
-
-
-@register.tag
-def asset_url(parser, token, node_cls=AssetURLNode):
+@register.simple_tag
+def asset_url(module, path):
     """
-        Just like the "url" templatetag, except replaces the filename part of
-        the url path with the versioned filename pulled from the asset manifest
-        generated by webpack.
+    Returns a versioned asset URL (located within Sentry's static files).
 
-        Example:
-          {% asset_url 'sentry-media' 'sentry' 'dist/sentry.css' %}
-          =>  "/_static/sentry/dist/sentry.74d127b78dc7daf2c51f.css"
+    Example:
+      {% asset_url 'sentry' 'dist/sentry.css' %}
+      =>  "/_static/74d127b78dc7daf2c51f/sentry/dist/sentry.css"
     """
-
-    node_instance = url(parser, token)
-
-    return node_cls(view_name=node_instance.view_name,
-        args=node_instance.args,
-        kwargs=node_instance.kwargs,
-        asvar=node_instance.asvar)
+    return reverse('sentry-media', kwargs={
+        'version': settings.ASSET_VERSION,
+        'module': module,
+        'path': path,
+    })
diff --git a/src/sentry/templatetags/sentry_react.py b/src/sentry/templatetags/sentry_react.py
index 3844d1ad68..d696824ffa 100644
--- a/src/sentry/templatetags/sentry_react.py
+++ b/src/sentry/templatetags/sentry_react.py
@@ -52,7 +52,7 @@ def get_react_config(context):
         'urlPrefix': settings.SENTRY_URL_PREFIX,
         'version': _get_version_info(),
         'features': enabled_features,
-        'mediaUrl': reverse('sentry-media', args=['sentry', '']),
+        'mediaUrl': reverse('sentry-media', args=[settings.ASSET_VERSION, 'sentry', '']),
     }
     if user and user.is_authenticated():
         context.update({
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index 93278d8573..3bd076b570 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -106,8 +106,9 @@ urlpatterns += patterns(
     url(r'^api/(?P<project_id>[\w_-]+)/store/$', api.StoreView.as_view(),
         name='sentry-api-store'),
 
-    url(r'^_static/(?P<module>[^/]+)/(?P<path>.*)$', generic.static_media,
+    url(r'^_static/(?P<version>[^/]+)/(?P<module>[^/]+)/(?P<path>.*)$', generic.static_media,
         name='sentry-media'),
+
     url(r'^templates/(?P<path>.*)$', generic.partial_static_media,
         name='sentry-partial-media'),
 
