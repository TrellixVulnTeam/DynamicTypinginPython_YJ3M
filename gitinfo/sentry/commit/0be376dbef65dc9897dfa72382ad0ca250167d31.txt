commit 0be376dbef65dc9897dfa72382ad0ca250167d31
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Mon Sep 18 15:38:42 2017 -0500

    fix: Skip some double deletions during cleanup (#6143)

diff --git a/src/sentry/deletions/base.py b/src/sentry/deletions/base.py
index 06c9d4314b..6d50123984 100644
--- a/src/sentry/deletions/base.py
+++ b/src/sentry/deletions/base.py
@@ -29,15 +29,17 @@ class BaseDeletionTask(object):
 
     DEFAULT_CHUNK_SIZE = 100
 
-    def __init__(self, manager, transaction_id=None, actor_id=None, chunk_size=DEFAULT_CHUNK_SIZE):
+    def __init__(self, manager, skip_models=None, transaction_id=None,
+                 actor_id=None, chunk_size=DEFAULT_CHUNK_SIZE):
         self.manager = manager
+        self.skip_models = set(skip_models) if skip_models else None
         self.transaction_id = transaction_id
         self.actor_id = actor_id
         self.chunk_size = chunk_size
 
     def __repr__(self):
-        return '<%s: transaction_id=%s actor_id=%s>' % (
-            type(self), self.transaction_id, self.actor_id,
+        return '<%s: skip_models=%s transaction_id=%s actor_id=%s>' % (
+            type(self), self.skip_models, self.transaction_id, self.actor_id,
         )
 
     def chunk(self):
@@ -58,6 +60,13 @@ class BaseDeletionTask(object):
             # ModelRelation(Model, {'parent_id__in': [i.id for id in instance_list]})
         ]
 
+    def filter_relations(self, child_relations):
+        if not self.skip_models or not child_relations:
+            return child_relations
+
+        return list(filter(lambda rel: rel.params.get('model')
+                           not in self.skip_models, child_relations))
+
     def delete_bulk(self, instance_list):
         """
         Delete a batch of objects bound to this task.
@@ -68,6 +77,7 @@ class BaseDeletionTask(object):
         self.mark_deletion_in_progress(instance_list)
 
         child_relations = self.get_child_relations_bulk(instance_list)
+        child_relations = self.filter_relations(child_relations)
         if child_relations:
             has_more = self.delete_children(child_relations)
             if has_more:
@@ -75,6 +85,7 @@ class BaseDeletionTask(object):
 
         for instance in instance_list:
             child_relations = self.get_child_relations(instance)
+            child_relations = self.filter_relations(child_relations)
             if child_relations:
                 has_more = self.delete_children(child_relations)
                 if has_more:
diff --git a/src/sentry/runner/commands/cleanup.py b/src/sentry/runner/commands/cleanup.py
index 4d29746243..f00fd84c38 100644
--- a/src/sentry/runner/commands/cleanup.py
+++ b/src/sentry/runner/commands/cleanup.py
@@ -198,6 +198,13 @@ def cleanup(days, project, concurrency, silent, model, router, timed):
                 model=model,
                 query=query,
                 order_by=order_by,
+                skip_models=[
+                    models.Event,
+                    models.EventTag,
+                    models.GroupEmailThread,
+                    models.GroupRuleStatus,
+                    models.GroupTagValue,
+                ],
                 transaction_id=uuid4().hex,
             )
 
