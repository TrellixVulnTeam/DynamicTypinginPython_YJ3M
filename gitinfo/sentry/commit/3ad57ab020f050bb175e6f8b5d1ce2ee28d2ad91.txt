commit 3ad57ab020f050bb175e6f8b5d1ce2ee28d2ad91
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Mon Mar 19 18:45:48 2018 -0500

    fix(tagstore): Override all delete methods to pass project_id (#7697)
    
    Fixes SENTRY-643

diff --git a/src/sentry/tagstore/v2/models/eventtag.py b/src/sentry/tagstore/v2/models/eventtag.py
index b7e6a313d2..f7c9b857b1 100644
--- a/src/sentry/tagstore/v2/models/eventtag.py
+++ b/src/sentry/tagstore/v2/models/eventtag.py
@@ -7,7 +7,7 @@ sentry.tagstore.v2.models.eventtag
 """
 from __future__ import absolute_import
 
-from django.db import models
+from django.db import models, router, connections
 from django.utils import timezone
 
 from sentry.db.models import (Model, BoundedBigIntegerField, FlexibleForeignKey, sane_repr)
@@ -32,3 +32,14 @@ class EventTag(Model):
         )
 
     __repr__ = sane_repr('event_id', 'key', 'value')
+
+    def delete(self):
+        using = router.db_for_read(EventTag)
+        cursor = connections[using].cursor()
+        cursor.execute(
+            """
+            DELETE FROM tagstore_eventtag
+            WHERE project_id = %s
+              AND id = %s
+        """, [self.project_id, self.id]
+        )
diff --git a/src/sentry/tagstore/v2/models/grouptagkey.py b/src/sentry/tagstore/v2/models/grouptagkey.py
index 340003ea74..9e8d639a96 100644
--- a/src/sentry/tagstore/v2/models/grouptagkey.py
+++ b/src/sentry/tagstore/v2/models/grouptagkey.py
@@ -39,7 +39,7 @@ class GroupTagKey(Model):
 
     __repr__ = sane_repr('project_id', 'group_id', '_key')
 
-    def delete_for_merge(self):
+    def delete(self):
         using = router.db_for_read(GroupTagKey)
         cursor = connections[using].cursor()
         cursor.execute(
diff --git a/src/sentry/tagstore/v2/models/grouptagvalue.py b/src/sentry/tagstore/v2/models/grouptagvalue.py
index 39dcd3b7a7..3331868558 100644
--- a/src/sentry/tagstore/v2/models/grouptagvalue.py
+++ b/src/sentry/tagstore/v2/models/grouptagvalue.py
@@ -45,7 +45,7 @@ class GroupTagValue(Model):
 
     __repr__ = sane_repr('project_id', 'group_id', '_key', '_value')
 
-    def delete_for_merge(self):
+    def delete(self):
         using = router.db_for_read(GroupTagValue)
         cursor = connections[using].cursor()
         cursor.execute(
diff --git a/src/sentry/tagstore/v2/models/tagkey.py b/src/sentry/tagstore/v2/models/tagkey.py
index bc08c2d136..7a045405f0 100644
--- a/src/sentry/tagstore/v2/models/tagkey.py
+++ b/src/sentry/tagstore/v2/models/tagkey.py
@@ -10,7 +10,7 @@ from __future__ import absolute_import, print_function
 
 import six
 
-from django.db import models
+from django.db import models, router, connections
 from django.utils.translation import ugettext_lazy as _
 
 from sentry.api.serializers import Serializer, register
@@ -49,6 +49,17 @@ class TagKey(Model):
 
     __repr__ = sane_repr('project_id', 'environment_id', 'key')
 
+    def delete(self):
+        using = router.db_for_read(TagKey)
+        cursor = connections[using].cursor()
+        cursor.execute(
+            """
+            DELETE FROM tagstore_tagkey
+            WHERE project_id = %s
+              AND id = %s
+        """, [self.project_id, self.id]
+        )
+
     def get_label(self):
         from sentry import tagstore
 
diff --git a/src/sentry/tagstore/v2/models/tagvalue.py b/src/sentry/tagstore/v2/models/tagvalue.py
index b030a5e0f7..e5a9f84982 100644
--- a/src/sentry/tagstore/v2/models/tagvalue.py
+++ b/src/sentry/tagstore/v2/models/tagvalue.py
@@ -9,7 +9,7 @@ from __future__ import absolute_import, print_function
 
 import six
 
-from django.db import models
+from django.db import models, router, connections
 from django.utils import timezone
 
 from sentry.api.serializers import Serializer, register
@@ -48,6 +48,17 @@ class TagValue(Model):
 
     __repr__ = sane_repr('project_id', '_key', 'value')
 
+    def delete(self):
+        using = router.db_for_read(TagValue)
+        cursor = connections[using].cursor()
+        cursor.execute(
+            """
+            DELETE FROM tagstore_tagvalue
+            WHERE project_id = %s
+              AND id = %s
+        """, [self.project_id, self.id]
+        )
+
     @property
     def key(self):
         if hasattr(self, '_set_key'):
diff --git a/src/sentry/tasks/merge.py b/src/sentry/tasks/merge.py
index 8a3e8aebb1..b7fbf790b8 100644
--- a/src/sentry/tasks/merge.py
+++ b/src/sentry/tasks/merge.py
@@ -334,11 +334,7 @@ def merge_objects(models, group, new_group, limit=1000, logger=None, transaction
                     obj.merge_counts(new_group)
 
                 obj_id = obj.id
-
-                if hasattr(model, 'delete_for_merge'):
-                    obj.delete_for_merge()
-                else:
-                    obj.delete()
+                obj.delete()
 
                 if logger is not None:
                     delete_logger.debug(
