commit 14d5536da308d297fb75468d679d1d48aba8a6d7
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Fri Apr 21 09:56:49 2017 +0200

    Improved reprocessing email styling and added debug view

diff --git a/src/sentry/plugins/sentry_mail/activity/new_processing_issues.py b/src/sentry/plugins/sentry_mail/activity/new_processing_issues.py
index 7caa96eb73..1d0da90cf4 100644
--- a/src/sentry/plugins/sentry_mail/activity/new_processing_issues.py
+++ b/src/sentry/plugins/sentry_mail/activity/new_processing_issues.py
@@ -1,16 +1,39 @@
 from __future__ import absolute_import
 
-from sentry.models import User, GroupSubscriptionReason
+from sentry.models import User, GroupSubscriptionReason, EventError
 from sentry.utils.http import absolute_uri
 
 from .base import ActivityEmail
 
 
+def summarize_issues(issues):
+    rv = []
+    for issue in issues:
+        extra_info = None
+        msg_d = dict(issue['data'])
+        msg_d['type'] = issue['type']
+
+        if 'image_path' in issue['data']:
+            extra_info = issue['data']['image_path'].rsplit('/', 1)[-1]
+            if 'image_arch' in issue['data']:
+                extra_info = '%s (%s)' % (
+                    extra_info,
+                    issue['data']['image_arch'],
+                )
+
+        rv.append({
+            'message': EventError.get_message(msg_d),
+            'extra_info': extra_info,
+        })
+    return rv
+
+
 class NewProcessingIssuesActivityEmail(ActivityEmail):
 
     def __init__(self, activity):
         ActivityEmail.__init__(self, activity)
         self.organization = self.project.organization
+        self.issues = summarize_issues(self.data['issues'])
 
     def get_participants(self):
         # XXX: We want to send an email to everybody who is subscribed to
@@ -31,7 +54,7 @@ class NewProcessingIssuesActivityEmail(ActivityEmail):
     def get_context(self):
         return {
             'project': self.project,
-            'issues': self.activity.data['issues'],
+            'issues': self.issues,
             'reprocessing_active': self.activity.data['reprocessing_active'],
             'info_url': absolute_uri('/{}/{}/settings/processing-issues/'.format(
                 self.organization.slug,
diff --git a/src/sentry/tasks/store.py b/src/sentry/tasks/store.py
index dce1b9abd7..7f150c9999 100644
--- a/src/sentry/tasks/store.py
+++ b/src/sentry/tasks/store.py
@@ -27,6 +27,10 @@ from sentry.models import ProjectOption, Activity, Project
 error_logger = logging.getLogger('sentry.errors.events')
 
 
+# Is reprocessing on or off by default?
+REPROCESSING_DEFAULT = True
+
+
 def should_process(data):
     """Quick check if processing is needed at all."""
     from sentry.plugins import plugins
@@ -182,7 +186,7 @@ def delete_raw_event(project_id, event_id, allow_hint_clear=False):
     # Clear the sent notification if we reprocessed everything
     # successfully and reprocessing is enabled
     reprocessing_active = ProjectOption.objects.get_value(
-        project_id, 'sentry:reprocessing_active', False)
+        project_id, 'sentry:reprocessing_active', REPROCESSING_DEFAULT)
     if reprocessing_active:
         sent_notification = ProjectOption.objects.get_value(
             project_id, 'sentry:sent_failed_event_hint', False)
@@ -201,7 +205,7 @@ def create_failed_event(cache_key, project_id, issues, event_id, start_time=None
     raw event.  Returns `True` if a failed event was inserted
     """
     reprocessing_active = ProjectOption.objects.get_value(
-        project_id, 'sentry:reprocessing_active', False)
+        project_id, 'sentry:reprocessing_active', REPROCESSING_DEFAULT)
 
     # The first time we encounter a failed event and the hint was cleared
     # we send a notification.
diff --git a/src/sentry/templates/sentry/debug/mail/preview.html b/src/sentry/templates/sentry/debug/mail/preview.html
index 15ef4778e3..b0a60afd18 100644
--- a/src/sentry/templates/sentry/debug/mail/preview.html
+++ b/src/sentry/templates/sentry/debug/mail/preview.html
@@ -15,6 +15,8 @@
         <option value="mail/resolved-in-release/">Resolved In Release</option>
         <option value="mail/resolved-in-release/upcoming/">Resolved In Release (Upcoming)</option>
         <option value="mail/unassigned/">Unassigned</option>
+        <option value="mail/new-processing-issues/">New Processing Issues</option>
+        <option value="mail/new-processing-issues-no-reprocessing/">New Processing Issues (No Reprocessing)</option>
       </optgroup>
       <optgroup label="Alerts">
         <option value="mail/alert/">Alert</option>
diff --git a/src/sentry/templates/sentry/emails/activity/new_processing_issues.html b/src/sentry/templates/sentry/emails/activity/new_processing_issues.html
index 5f5b0adf60..cfd074858a 100644
--- a/src/sentry/templates/sentry/emails/activity/new_processing_issues.html
+++ b/src/sentry/templates/sentry/emails/activity/new_processing_issues.html
@@ -8,42 +8,74 @@
 
 {% block activity %}
     <h2 style="margin-bottom: 10px">
-        Failed to Process Events in {{ project.organization.name }} / {{ project.name }}
+      Failed to Process Events
     </h2>
 
     <p class="muted">
-        Some events failed to process in your project "{{ project.name }}".
-        {% if reprocessing_active %}
-          Because reprocessing is enabled you will not see these events until
-          you corrected some issues that affect processing.
-        {% else %}
-          If you enable reprocessing you will not be receiving alert emails
-          for such events in the future until issues are resolved.  We
-          strongly recommend to enable reprocessing.
-        {% endif %}
+      Some events failed to process in your project "<a href="{{ project.get_absolute_url }}">{{ project.name }}</a>".
+      {% if reprocessing_active %}
+        Because reprocessing is enabled you will not see these events until
+        you corrected some issues that affect processing.
+      {% endif %}
     </p>
+    {% if not reprocessing_active %}
+    <p>
+      <strong>Tip:</strong> If you <a href="{{ info_url }}">enable reprocessing</a>
+      you will not be receiving alert emails for such events in the future
+      until issues are resolved.
+    </p>
+    {% endif %}
     <hr>
 
     <h6>Project Affected</h6>
     <div class="table-border">
       <table class="table projects">
         <tbody>
-            <tr>
-              <td>
-                <h5 style="margin-bottom: 0">
-                  <a href="{{ project.get_absolute_url }}">{{ project.name }}</a>
-                </h5>
-                <p class="muted" style="margin-bottom: 0">
-                  {% if issues|count == 1 %}one issue{% else %}{{ issues|count }} issues{% endif %}
-                </p>
-              </td>
-              <td style="text-align: right">
-                {% if reprocessing_active %}
-                <a href="{{ info_url }}" class="btn btn-sm btn-primary">View Issues</a>
-                {% endif %}
-              </td>
-            </tr>
+          <tr>
+            <td>
+              <h5 style="margin-bottom: 0">
+                <a href="{{ project.get_absolute_url }}">{{ project.name }}</a>
+              </h5>
+              <p class="muted" style="margin-bottom: 0">
+                {% if issues|length == 1 %}1 issue{% else %}{{ issues|length }} issues{% endif %}
+              </p>
+            </td>
+            <td style="text-align: right">
+              {% if reprocessing_active %}
+              <a href="{{ info_url }}" class="btn btn-sm btn-primary">Fix Issues</a>
+              {% endif %}
+            </td>
+          </tr>
         </tbody>
       </table>
     </div>
+
+    <h6>Issues</h6>
+    <div class="table-border">
+      <table class="table issues">
+        <tbody>
+          {% for issue in issues %}
+          <tr>
+            <td>
+              <p style="margin-bottom: 0">
+                <strong>{{ issue.message }}</strong>
+              </p>
+              {% if issue.extra_info %}
+                <p class="muted" style="margin-bottom: 0">{{ issue.extra_info }}</p>
+              {% endif %}
+            </td>
+          </tr>
+          {% endfor %}
+        </tbody>
+      </table>
+    </div>
+
+    {% if not reprocessing_active %}
+    <p>
+      Because reprocessing is not enabled we will not futher bother you about
+      issues like this.  We do however recommend to <a href="{{ info_url
+        }}">enable reprocessing in the project settings</a> for a better user
+      experience.
+    </p>
+    {% endif %}
 {% endblock %}
diff --git a/src/sentry/templates/sentry/emails/activity/new_processing_issues.txt b/src/sentry/templates/sentry/emails/activity/new_processing_issues.txt
index 52d80f3534..f17e28e135 100644
--- a/src/sentry/templates/sentry/emails/activity/new_processing_issues.txt
+++ b/src/sentry/templates/sentry/emails/activity/new_processing_issues.txt
@@ -1 +1,17 @@
 Some events failed to process in your project "{{ project.name }}".
+
+{% if reprocessing_active %}Because reprocessing is enabled you will not see these events until
+you corrected some issues that affect processing.
+
+{% endif %}Issues:
+{% for issue in issues %}
+* {{ issue.message }}{% if issue.extra_info %}
+  ({{ issue.extra_info }}){% endif %}
+{% endfor %}
+
+{% if not reprocessing_active %}Because reprocessing is not enabled we
+will not futher bother you about issues like this.  We do however
+recommend to enable reprocessing in the project settings
+({{ info_url }})
+for a better user experience.{% else %}You can fix these issues here:
+  {{ info_url }}{% endif %}
diff --git a/src/sentry/web/debug_urls.py b/src/sentry/web/debug_urls.py
index ca49c93df9..c89099c9a3 100644
--- a/src/sentry/web/debug_urls.py
+++ b/src/sentry/web/debug_urls.py
@@ -39,6 +39,10 @@ from sentry.web.frontend.debug.debug_resolved_in_release_email import (
 from sentry.web.frontend.debug.debug_unassigned_email import (
     DebugUnassignedEmailView
 )
+from sentry.web.frontend.debug.debug_new_processing_issues_email import (
+    DebugNewProcessingIssuesEmailView,
+    DebugNewProcessingIssuesNoReprocessingEmailView,
+)
 from sentry.web.frontend.debug import debug_auth_views
 from sentry.web.frontend.debug.debug_oauth_authorize import (
     DebugOAuthAuthorizeView,
@@ -92,6 +96,10 @@ urlpatterns = patterns(
         DebugMfaAddedEmailView.as_view()),
     url(r'^debug/mail/password-changed/$',
         DebugPasswordChangedEmailView.as_view()),
+    url(r'^debug/mail/new-processing-issues/$',
+        DebugNewProcessingIssuesEmailView.as_view()),
+    url(r'^debug/mail/new-processing-issues-no-reprocessing/$',
+        DebugNewProcessingIssuesNoReprocessingEmailView.as_view()),
     url(r'^debug/embed/error-page/$',
         DebugErrorPageEmbedView.as_view()),
     url(r'^debug/trigger-error/$',
diff --git a/src/sentry/web/frontend/debug/debug_new_processing_issues_email.py b/src/sentry/web/frontend/debug/debug_new_processing_issues_email.py
new file mode 100644
index 0000000000..efd51fedec
--- /dev/null
+++ b/src/sentry/web/frontend/debug/debug_new_processing_issues_email.py
@@ -0,0 +1,70 @@
+from __future__ import absolute_import
+
+from django.views.generic import View
+
+from sentry.models import (
+    GroupSubscriptionReason,
+    Organization, Project, Team
+)
+from sentry.utils.http import absolute_uri
+
+from .mail import MailPreview
+
+
+class DebugNewProcessingIssuesEmailView(View):
+    reprocessing_active = True
+
+    def get(self, request):
+        from sentry.plugins.sentry_mail.activity.new_processing_issues import summarize_issues
+        org = Organization(
+            id=1,
+            slug='organization',
+            name='My Company',
+        )
+        team = Team(
+            id=1,
+            slug='team',
+            name='My Team',
+            organization=org,
+        )
+        project = Project(
+            id=1,
+            organization=org,
+            team=team,
+            slug='project',
+            name='My Project',
+        )
+
+        return MailPreview(
+            html_template='sentry/emails/activity/new_processing_issues.html',
+            text_template='sentry/emails/activity/new_processing_issues.txt',
+            context={
+                'project': project,
+                'reason': GroupSubscriptionReason.descriptions[
+                    GroupSubscriptionReason.processing_issue
+                ],
+                'issues': summarize_issues([
+                    {'data': {'image_arch': 'arm64',
+                              'image_path': '/var/containers/Bundle/Application/FB14D416-DE4E-4224-9789-6B88E9C42601/CrashProbeiOS.app/CrashProbeiOS',
+                              'image_uuid': 'a2df1794-e0c7-371c-baa4-93eac340a78a'},
+                     'object': 'dsym:a2df1794-e0c7-371c-baa4-93eac340a78a',
+                     'scope': 'native',
+                     'type': 'native_missing_dsym'},
+                    {'data': {'image_arch': 'arm64',
+                              'image_path': '/var/containers/Bundle/Application/FB14D416-DE4E-4224-9789-6B88E9C42601/CrashProbeiOS.app/libCrashProbeiOS',
+                              'image_uuid': '12dc1b4c-a01b-463f-ae88-5cf0c31ae680'},
+                     'object': 'dsym:12dc1b4c-a01b-463f-ae88-5cf0c31ae680',
+                     'scope': 'native',
+                     'type': 'native_bad_dsym'},
+                ]),
+                'reprocessing_active': self.reprocessing_active,
+                'info_url': absolute_uri('/{}/{}/settings/processing-issues/'.format(
+                    org.slug,
+                    project.slug,
+                )),
+            },
+        ).render(request)
+
+
+class DebugNewProcessingIssuesNoReprocessingEmailView(DebugNewProcessingIssuesEmailView):
+    reprocessing_active = False
