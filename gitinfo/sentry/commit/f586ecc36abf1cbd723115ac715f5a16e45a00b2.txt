commit f586ecc36abf1cbd723115ac715f5a16e45a00b2
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue May 17 23:57:29 2016 +0200

    Show all 2fa wells in the config page.

diff --git a/src/sentry/models/authenticator.py b/src/sentry/models/authenticator.py
index c2785dc23d..87ba7edc4e 100644
--- a/src/sentry/models/authenticator.py
+++ b/src/sentry/models/authenticator.py
@@ -52,23 +52,24 @@ class AuthenticatorManager(BaseManager):
 
     def all_interfaces_for_user(self, user, return_missing=False):
         """Returns a correctly sorted list of all interfaces the user
-        has enabled.  If `return_missing` is set to `True` the return
-        value is a tuple of `(enrolled, unenrolled)` interfaces.
+        has enabled.  If `return_missing` is set to `True` then all
+        interfaces are returned even if not enabled.
         """
         _sort = lambda x: sorted(x, key=lambda x: (x.type == 0, x.type))
         rv = [x.interface for x in Authenticator.objects.filter(user=user)
               if x.interface.is_available]
         if not return_missing:
             return _sort(rv)
+
         rvm = dict(AUTHENTICATOR_INTERFACES)
-        for iface in rv:
-            rvm.pop(iface.interface_id, None)
-        others = []
-        for key, iface_cls in rvm.iteritems():
+        for iface_cls in rv:
+            rvm.pop(iface_cls.interface_id, None)
+        for iface_cls in rvm.itervalues():
             iface = iface_cls()
             if iface.is_available:
-                others.append(iface)
-        return _sort(rv), _sort(others)
+                rv.append(iface)
+
+        return _sort(rv)
 
     def is_missing_backup_interfaces(self, user):
         """This checks if the user provided should add a backup interface
diff --git a/src/sentry/templates/sentry/account/twofactor.html b/src/sentry/templates/sentry/account/twofactor.html
index 8d08eae105..ca1268bec1 100644
--- a/src/sentry/templates/sentry/account/twofactor.html
+++ b/src/sentry/templates/sentry/account/twofactor.html
@@ -16,30 +16,26 @@
     Two-factor authentication improves your security by requiring an authentication
     code in addition to your password.
   </p>
-  {% for auth in active_authenticators %}
-    <div class="well">
+  {% for auth in interfaces %}
+    <div class="well {% if auth.is_enrolled %}enrolled{% else %}not-enrolled{% endif %}">
       <h4>{{ auth.name }}</h4>
       <p>{{ auth.description }}</p>
-      {% if auth.configure_button %}
-        <a href="{{ auth.interface_id }}/" class="btn btn-default btn-sm">{{ auth.configure_button }}</a>
-      {% endif %}
-      {% if auth.remove_button %}
-        <form action="{{ auth.interface_id }}/" method="post" style="display: inline">
-          {% csrf_token %}
-          <button type="submit" name="remove"
-            class="btn btn-default btn-sm">{{ auth.remove_button }}</button>
-        </form>
+      {% if auth.is_enrolled %}
+        {% if auth.configure_button %}
+          <a href="{{ auth.interface_id }}/" class="btn btn-default btn-sm">{{ auth.configure_button }}</a>
+        {% endif %}
+        {% if auth.remove_button %}
+          <form action="{{ auth.interface_id }}/" method="post" style="display: inline">
+            {% csrf_token %}
+            <button type="submit" name="remove"
+              class="btn btn-default btn-sm">{{ auth.remove_button }}</button>
+          </form>
+        {% endif %}
+      {% else %}
+        <a href="{{ auth.interface_id }}/" class="btn btn-default btn-sm">Add</a>
       {% endif %}
     </div>
   {% endfor %}
-  {% if missing_authenticators %}
-    <h6>Add more methods:</h6>
-    <ul>
-      {% for auth in missing_authenticators %}
-        <li><a href="{{ auth.interface_id }}/">{{ auth.name }}</a></li>
-      {% endfor %}
-    </ul>
-  {% endif %}
 
   <form action="" method="post" class="form-stacked">
     {% csrf_token %}
diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index b30c17ce39..1bd9114ffe 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -144,7 +144,7 @@ def settings(request):
 @sudo_required
 @transaction.atomic
 def twofactor_settings(request):
-    active, missing = Authenticator.objects.all_interfaces_for_user(
+    interfaces = Authenticator.objects.all_interfaces_for_user(
         request.user, return_missing=True)
 
     if request.method == 'POST' and 'back' in request.POST:
@@ -153,9 +153,8 @@ def twofactor_settings(request):
     context = csrf(request)
     context.update({
         'page': 'settings',
-        'has_2fa': len(active) > 0,
-        'active_authenticators': active,
-        'missing_authenticators': missing,
+        'has_2fa': any(x.is_enrolled for x in interfaces),
+        'interfaces': interfaces,
         'is_missing_backup_interfaces':
             Authenticator.objects.is_missing_backup_interfaces(request.user)
     })
