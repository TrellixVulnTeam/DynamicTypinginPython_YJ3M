commit 8da9aad79408384b025101e8aad8095c40fe4d59
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Wed Nov 21 16:09:59 2018 -0600

    fix(snuba): Return empty results (rather than AssertionError) for out-of-range searches (#10719)

diff --git a/src/sentry/search/snuba/backend.py b/src/sentry/search/snuba/backend.py
index ad1da88486..057d13a0ac 100644
--- a/src/sentry/search/snuba/backend.py
+++ b/src/sentry/search/snuba/backend.py
@@ -184,17 +184,6 @@ class SnubaSearchBackend(ds.DjangoSearchBackend):
             )
 
         now = timezone.now()
-        # TODO: Presumably we want to search back to the project's full retention,
-        #       which may be higher than 90 days in the past, but apparently
-        #       `retention_window_start` can be None(?), so we need a fallback.
-        start = max(
-            filter(None, [
-                retention_window_start,
-                parameters.get('date_from'),
-                now - timedelta(days=90)
-            ])
-        )
-
         end = parameters.get('date_to')
         if not end:
             end = now + ALLOWED_FUTURE_DELTA
@@ -216,6 +205,36 @@ class SnubaSearchBackend(ds.DjangoSearchBackend):
                 paginator = DateTimePaginator(group_queryset, '-last_seen', **paginator_options)
                 return paginator.get_result(limit, cursor, count_hits=count_hits)
 
+        # TODO: Presumably we only want to search back to the project's max
+        # retention date, which may be closer than 90 days in the past, but
+        # apparently `retention_window_start` can be None(?), so we need a
+        # fallback.
+        retention_date = max(
+            filter(None, [
+                retention_window_start,
+                now - timedelta(days=90)
+            ])
+        )
+
+        start = max(
+            filter(None, [
+                retention_date,
+                parameters.get('date_from'),
+            ])
+        )
+
+        end = max([
+            retention_date,
+            end
+        ])
+
+        if start == retention_date and end == retention_date:
+            # Both `start` and `end` must have been trimmed to `retention_date`,
+            # so this entire search was against a time range that is outside of
+            # retention. We'll return empty results to maintain backwards compatability
+            # with Django search (for now).
+            return Paginator(Group.objects.none()).get_result()
+
         assert start < end
 
         # num_candidates is the number of Group IDs to send down to Snuba, if
diff --git a/tests/snuba/search/test_backend.py b/tests/snuba/search/test_backend.py
index 1ac5ec034b..c8bb3d8676 100644
--- a/tests/snuba/search/test_backend.py
+++ b/tests/snuba/search/test_backend.py
@@ -883,3 +883,12 @@ class SnubaSearchTest(SnubaTestCase):
             assert set(results) == set([self.group1, self.group2])
         finally:
             options.set('snuba.search.max-pre-snuba-candidates', prev_max_pre)
+
+    def test_search_out_of_range(self):
+        results = self.backend.query(
+            self.project,
+            date_from=datetime(2000, 1, 1, 0, 0, 0, tzinfo=pytz.utc),
+            date_to=datetime(2000, 1, 1, 1, 0, 0, tzinfo=pytz.utc),
+        )
+
+        assert set(results) == set([])
