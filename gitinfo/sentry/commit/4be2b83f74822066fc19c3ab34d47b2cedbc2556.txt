commit 4be2b83f74822066fc19c3ab34d47b2cedbc2556
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 17 19:36:49 2013 -0800

    User-agent and cache timeout

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index 8630a2d366..1d29113c3e 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -19,8 +19,12 @@ LINES_OF_CONTEXT = 5
 
 @lrucache.memoize
 def fetch_url(url, logger=None):
+    import sentry
+
     try:
-        req = urllib2.urlopen(url)
+        opener = urllib2.build_opener()
+        opener.addheaders = [('User-Agent', 'Sentry/%s' % sentry.VERSION)]
+        req = opener.open(url)
         result = req.read()
     except Exception:
         if logger:
@@ -75,11 +79,11 @@ def fetch_javascript_source(event, **kwargs):
 
     for filename in file_list:
         cache_key = 'remotesource:%s' % filename
-        # TODO: respect headers
+        # TODO: respect cache-contro/max-age headers to some extent
         result = cache.get(cache_key)
         if result is None:
             result = fetch_url(filename)
-            cache.set(cache_key, result)
+            cache.set(cache_key, result, 60 * 5)
 
         if result != BAD_SOURCE:
             result = result.splitlines()
diff --git a/tests/sentry/tasks/fetch_source/tests.py b/tests/sentry/tasks/fetch_source/tests.py
index 747e6d19e1..53fe3cb5cb 100644
--- a/tests/sentry/tasks/fetch_source/tests.py
+++ b/tests/sentry/tasks/fetch_source/tests.py
@@ -15,8 +15,8 @@ class StoreEventTest(TestCase):
         self.assertTrue(isinstance(fetch_javascript_source, Task))
 
     @mock.patch('sentry.models.Event.save')
-    @mock.patch('urllib2.urlopen')
-    def test_calls_from_kwargs(self, urlopen, save):
+    @mock.patch('urllib2.build_opener')
+    def test_calls_from_kwargs(self, build_opener, save):
         event = Event(data={
             'sentry.interfaces.Stacktrace': {
                 'frames': [
@@ -33,12 +33,13 @@ class StoreEventTest(TestCase):
                 ],
             },
         })
-        urlopen.return_value.read.return_value = '\n'.join('hello world')
+        build_opener.return_value.open.return_value.read.return_value = '\n'.join('hello world')
 
         fetch_javascript_source(event)
 
-        urlopen.assert_called_once_with('http://example.com/foo.js')
-        urlopen.return_value.read.assert_called_once_with()
+        build_opener.assert_called_once_with()
+        build_opener.return_value.open.assert_called_once_with('http://example.com/foo.js')
+        build_opener.return_value.open.return_value.read.assert_called_once_with()
         save.assert_called_once_with()
 
         frame_list = event.data['sentry.interfaces.Stacktrace']['frames']
