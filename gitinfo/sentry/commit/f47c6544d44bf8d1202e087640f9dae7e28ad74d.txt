commit f47c6544d44bf8d1202e087640f9dae7e28ad74d
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Thu Nov 29 08:43:35 2018 -0800

    fix(api): Fix error when fetching values for array columns
    
    fixes SENTRY-8G3

diff --git a/src/sentry/tagstore/snuba/backend.py b/src/sentry/tagstore/snuba/backend.py
index 976484eb8f..6bfbd674a1 100644
--- a/src/sentry/tagstore/snuba/backend.py
+++ b/src/sentry/tagstore/snuba/backend.py
@@ -534,6 +534,7 @@ class SnubaTagStorage(TagStorage):
             orderby=order_by,
             # TODO: This means they can't actually paginate all TagValues.
             limit=1000,
+            arrayjoin=snuba.get_arrayjoin(snuba_key),
             referrer='tagstore.get_tag_value_paginator_for_projects',
         )
 
diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index c7999f18ac..ba92e23f6d 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -5,6 +5,7 @@ from contextlib import contextmanager
 from datetime import datetime, timedelta
 from dateutil.parser import parse as parse_datetime
 import pytz
+import re
 import six
 import time
 import urllib3
@@ -181,6 +182,12 @@ def get_snuba_column_name(name):
     return SENTRY_SNUBA_MAP.get(name, u'tags[{}]'.format(name))
 
 
+def get_arrayjoin(column):
+    match = re.match(r'^(exception_stacks|exception_frames|contexts)\..+$', column)
+    if match:
+        return match.groups()[0]
+
+
 def transform_aliases_and_query(**kwargs):
     """
     Convert aliases in selected_columns, groupby, aggregation, conditions,
diff --git a/tests/snuba/api/endpoints/test_organization_tagkey_values.py b/tests/snuba/api/endpoints/test_organization_tagkey_values.py
index 4323e47f3b..23f5aeb5cf 100644
--- a/tests/snuba/api/endpoints/test_organization_tagkey_values.py
+++ b/tests/snuba/api/endpoints/test_organization_tagkey_values.py
@@ -175,3 +175,29 @@ class OrganizationTagKeyValuesTest(APITestCase, SnubaTestCase):
         response = self.client.get(url, format='json')
         assert response.status_code == 200, response.content
         assert len(response.data) == 0
+
+    def test_array_column(self):
+        user = self.create_user()
+        org = self.create_organization()
+        team = self.create_team(organization=org)
+        self.create_member(organization=org, user=user, teams=[team])
+
+        self.login_as(user=user)
+
+        project = self.create_project(organization=org, teams=[team])
+        group = self.create_group(project=project)
+
+        self.create_event('a' * 32, group=group, datetime=self.day_ago)
+        self.create_event('b' * 32, group=group, datetime=self.min_ago)
+        self.create_event('c' * 32, group=group, datetime=self.day_ago)
+
+        url = reverse(
+            'sentry-api-0-organization-tagkey-values',
+            kwargs={
+                'organization_slug': org.slug,
+                'key': 'error.type',
+            }
+        )
+
+        response = self.client.get(url, format='json')
+        assert response.status_code == 200, response.content
