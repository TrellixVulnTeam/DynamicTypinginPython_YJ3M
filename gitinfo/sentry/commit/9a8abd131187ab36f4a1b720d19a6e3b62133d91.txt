commit 9a8abd131187ab36f4a1b720d19a6e3b62133d91
Author: Tony <Zylphrex@users.noreply.github.com>
Date:   Mon Jun 29 19:56:00 2020 -0400

    tests: Improve timing stability in tests (#19618)
    
    `datetime.datetime` does not have a millisecond component, so by zeroing its
    microseconds, `before_now` only has a time resolution to the nearest second.
    This change adds back the milliseconds component while discarding the
    microseconds to increase resolution while maintaining stability.

diff --git a/src/sentry/testutils/helpers/datetime.py b/src/sentry/testutils/helpers/datetime.py
index 7b455e1c23..0ff24314fa 100644
--- a/src/sentry/testutils/helpers/datetime.py
+++ b/src/sentry/testutils/helpers/datetime.py
@@ -13,7 +13,7 @@ def iso_format(date):
 
 def before_now(**kwargs):
     date = datetime.utcnow() - timedelta(**kwargs)
-    return date.replace(microsecond=0)
+    return date - timedelta(microseconds=date.microsecond % 1000)
 
 
 def timestamp_format(datetime):
