commit c4adb5e032f8f656c9597a5b212ae8bde25652c8
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Sep 27 02:09:38 2011 -0700

    Ensure were validating the project parameter sent along with api credentials

diff --git a/sentry/web/views.py b/sentry/web/views.py
index 0edb9abe21..29b24a0b35 100644
--- a/sentry/web/views.py
+++ b/sentry/web/views.py
@@ -529,10 +529,13 @@ def store(request):
 
         if api_key:
             try:
-                secret_key = ProjectMember.objects.filter(api_key=api_key).values_list('secret_key', flat=True)[0]
-            except IndexError:
+                pm = ProjectMember.objects.get(api_key=api_key)
+            except ProjectMember.DoesNotExist:
                 return HttpResponseForbidden('Invalid signature')
+            project = pm.project
+            secret_key = pm.secret_key
         else:
+            project = None
             secret_key = settings.KEY
 
         format = 'json'
@@ -575,6 +578,8 @@ def store(request):
         if format not in ('pickle', 'json'):
             return HttpResponseBadRequest('Invalid format')
 
+        project = None
+
     logger = logging.getLogger('sentry.server')
 
     try:
@@ -623,6 +628,11 @@ def store(request):
                 logger.exception('Failed reading timestamp')
                 del data['timestamp']
 
+    # Confirm they're using either the master key, or their specified project matches with the
+    # signed project.
+    if project and str(data.get('project', '')) != str(project.pk):
+        return HttpResponseForbidden('Invalid credentials')
+
     GroupedMessage.objects.from_kwargs(**data)
 
     return HttpResponse()
