commit fa4b7d8e3344f462bc99d64c8f8ae6ad04959e87
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Fri Jun 15 11:14:06 2018 +0200

    feat: Count truncated floats in fingerprints for impact assessment (#8729)

diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index a10752a546..9bcb2a4d36 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -325,9 +325,27 @@ class EventManager(object):
         def to_values(v):
             return {'values': v} if v and isinstance(v, (tuple, list)) else v
 
+        def convert_fingerprint(values):
+            rv = values[:]
+            bad_float = False
+            for idx, item in enumerate(rv):
+                if isinstance(item, float) and \
+                   (abs(item) >= (1 << 53) or int(item) != item):
+                    bad_float = True
+                rv[idx] = text(item)
+            if bad_float:
+                metrics.incr(
+                    'events.bad_float_fingerprint',
+                    skip_internal=True,
+                    tags={
+                        'project_id': data.get('project'),
+                    },
+                )
+            return rv
+
         casts = {
             'environment': lambda v: text(v) if v is not None else v,
-            'fingerprint': lambda v: list(map(text, v)) if isinstance(v, list) and all(isinstance(f, fp_types) for f in v) else v,
+            'fingerprint': lambda v: convert_fingerprint(v) if isinstance(v, list) and all(isinstance(f, fp_types) for f in v) else v,
             'release': lambda v: text(v) if v is not None else v,
             'dist': lambda v: text(v).strip() if v is not None else v,
             'time_spent': lambda v: int(v) if v is not None else v,
