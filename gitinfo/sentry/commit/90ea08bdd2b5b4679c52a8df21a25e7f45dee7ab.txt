commit 90ea08bdd2b5b4679c52a8df21a25e7f45dee7ab
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Aug 7 08:59:45 2018 -0700

    Fix support for Django 1.6 on migrations

diff --git a/src/sentry/models/counter.py b/src/sentry/models/counter.py
index 81e8e031a9..b50db8e5ab 100644
--- a/src/sentry/models/counter.py
+++ b/src/sentry/models/counter.py
@@ -96,7 +96,7 @@ def increment_project_counter(project, delta=1):
 # this must be idempotent because it seems to execute twice
 # (at least during test runs)
 def create_counter_function(db, created_models, app, **kwargs):
-    if app.__name__ != 'sentry.models':
+    if app is None or app.__name__ != 'sentry.models':
         return
 
     if not is_postgres(db):
diff --git a/src/sentry/receivers/core.py b/src/sentry/receivers/core.py
index 5a8d85d6ef..1aba0b5e3a 100644
--- a/src/sentry/receivers/core.py
+++ b/src/sentry/receivers/core.py
@@ -37,7 +37,7 @@ def handle_db_failure(func):
 
 
 def create_default_projects(created_models, app, verbosity=2, **kwargs):
-    if app.__name__ != 'sentry.models':
+    if app is None or app.__name__ != 'sentry.models':
         return
 
     if Project not in created_models:
@@ -128,8 +128,8 @@ def set_sentry_version(latest=None, **kwargs):
     options.set('sentry:latest_version', (latest or current))
 
 
-def create_keys_for_project(instance, created, app, **kwargs):
-    if app.__name__ != 'sentry.models':
+def create_keys_for_project(instance, created, app=None, **kwargs):
+    if app is None or app.__name__ != 'sentry.models':
         return
 
     if not created or kwargs.get('raw'):
diff --git a/src/sentry/receivers/users.py b/src/sentry/receivers/users.py
index 0543610324..5e158fbd2b 100644
--- a/src/sentry/receivers/users.py
+++ b/src/sentry/receivers/users.py
@@ -8,8 +8,9 @@ from sentry.models import User
 
 def create_first_user(app, created_models, verbosity, db, **kwargs):
     # this is super confusing
-    if app.__name__ != 'sentry.models':
+    if app is None or app.__name__ != 'sentry.models':
         return
+
     if User not in created_models:
         return
 
diff --git a/src/sentry/runner/commands/upgrade.py b/src/sentry/runner/commands/upgrade.py
index e789af3dc0..8f46c3a1e3 100644
--- a/src/sentry/runner/commands/upgrade.py
+++ b/src/sentry/runner/commands/upgrade.py
@@ -8,21 +8,34 @@ sentry.runner.commands.upgrade
 from __future__ import absolute_import, print_function
 
 import click
+import django
+
+from django.conf import settings
 from sentry.runner.decorators import configuration
 
+DJANGO_17 = django.VERSION[0] > 1 or (django.VERSION[0] == 1 and django.VERSION[1] >= 7)
+
 
 def _upgrade(interactive, traceback, verbosity, repair):
     from django.core.management import call_command as dj_call_command
 
-    dj_call_command(
-        'migrate',
-        interactive=interactive,
-        traceback=traceback,
-        verbosity=verbosity,
-        migrate=True,
-        merge=True,
-        ignore_ghost_migrations=True,
-    )
+    if 'south' in settings.INSTALLED_APPS or DJANGO_17:
+        dj_call_command(
+            'migrate',
+            interactive=interactive,
+            traceback=traceback,
+            verbosity=verbosity,
+            migrate=True,
+            merge=True,
+            ignore_ghost_migrations=True,
+        )
+    else:
+        dj_call_command(
+            'syncdb',
+            interactive=interactive,
+            traceback=traceback,
+            verbosity=verbosity,
+        )
 
     if repair:
         from sentry.runner import call_command
