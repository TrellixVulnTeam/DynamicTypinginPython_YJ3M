commit 7c482e60a4e3528d3696d4a1411d060af38bfca4
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Tue Mar 13 10:24:06 2018 -0500

    fix(tagstore): Add partition key to tagstore v2 updates (#7592)
    
    Fixes SENTRY-62Y
    Fixes SENTRY-632

diff --git a/src/sentry/tagstore/v2/backend.py b/src/sentry/tagstore/v2/backend.py
index 9124e6ba8f..0abc6deefe 100644
--- a/src/sentry/tagstore/v2/backend.py
+++ b/src/sentry/tagstore/v2/backend.py
@@ -99,7 +99,10 @@ class V2TagStorage(TagStorage):
             def mark_deletion_in_progress(self, instance_list):
                 for instance in instance_list:
                     if instance.status != TagKeyStatus.DELETION_IN_PROGRESS:
-                        instance.update(status=TagKeyStatus.DELETION_IN_PROGRESS)
+                        TagKey.objects.filter(
+                            id=instance.id,
+                            project_id=instance.project_id,
+                        ).update(status=TagKeyStatus.DELETION_IN_PROGRESS)
 
         deletion_manager.register(TagKey, TagKeyDeletionTask)
 
@@ -778,7 +781,10 @@ class V2TagStorage(TagStorage):
         )
 
         for instance in gtk_qs:
-            instance.update(
+            GroupTagKey.objects.filter(
+                id=instance.id,
+                project_id=project_id,
+            ).update(
                 values_seen=GroupTagValue.objects.filter(
                     project_id=instance.project_id,
                     group_id=instance.group_id,
diff --git a/src/sentry/tagstore/v2/models/grouptagvalue.py b/src/sentry/tagstore/v2/models/grouptagvalue.py
index 717cc3c00b..13382cbc55 100644
--- a/src/sentry/tagstore/v2/models/grouptagvalue.py
+++ b/src/sentry/tagstore/v2/models/grouptagvalue.py
@@ -108,7 +108,11 @@ class GroupTagValue(Model):
                     _key_id=self._key_id,
                     _value_id=self._value_id,
                 )
-                new_obj.update(
+
+                GroupTagValue.objects.filter(
+                    id=new_obj.id,
+                    project_id=new_group.project_id,
+                ).update(
                     first_seen=min(new_obj.first_seen, self.first_seen),
                     last_seen=max(new_obj.last_seen, self.last_seen),
                     times_seen=new_obj.times_seen + self.times_seen,
