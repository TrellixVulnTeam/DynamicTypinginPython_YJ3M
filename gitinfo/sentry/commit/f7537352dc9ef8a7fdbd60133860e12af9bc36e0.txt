commit f7537352dc9ef8a7fdbd60133860e12af9bc36e0
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Mon Jul 30 15:16:00 2018 -0700

    fix(integrations): Disable and Reinstall for GHE (#9191)
    
    * fix(integrations): Disable and Reinstall for GHE

diff --git a/src/sentry/api/serializers/models/integration.py b/src/sentry/api/serializers/models/integration.py
index 06087b3ecd..f1b9f9e6a2 100644
--- a/src/sentry/api/serializers/models/integration.py
+++ b/src/sentry/api/serializers/models/integration.py
@@ -27,6 +27,7 @@ class IntegrationSerializer(Serializer):
                 'name': provider.name,
                 'canAdd': provider.can_add,
                 'canAddProject': provider.can_add_project,
+                'canDisable': provider.can_disable,
                 'features': [f.value for f in provider.features],
                 'aspects': provider.metadata.aspects,
             },
@@ -132,6 +133,7 @@ class IntegrationProviderSerializer(Serializer):
             'metadata': metadata,
             'canAdd': obj.can_add,
             'canAddProject': obj.can_add_project,
+            'canDisable': obj.can_disable,
             'features': [f.value for f in obj.features],
             'setupDialog': dict(
                 url='/organizations/{}/integrations/{}/setup/'.format(
diff --git a/src/sentry/integrations/base.py b/src/sentry/integrations/base.py
index 636346e01f..81e1b97d20 100644
--- a/src/sentry/integrations/base.py
+++ b/src/sentry/integrations/base.py
@@ -75,6 +75,9 @@ class IntegrationProvider(PipelineProvider):
     # can the integration be enabled specifically for projects?
     can_add_project = False
 
+    # can the integration be disabled ?
+    can_disable = False
+
     # if the integration has no application-style access token, associate
     # the installer's identity to the organization integration
     needs_default_identity = False
diff --git a/src/sentry/integrations/github/integration.py b/src/sentry/integrations/github/integration.py
index 15063870be..12f90ccc7d 100644
--- a/src/sentry/integrations/github/integration.py
+++ b/src/sentry/integrations/github/integration.py
@@ -108,6 +108,8 @@ class GitHubIntegrationProvider(IntegrationProvider):
         IntegrationFeatures.ISSUE_BASIC,
     ])
 
+    can_disable = True
+
     setup_dialog_config = {
         'width': 1030,
         'height': 1000,
diff --git a/src/sentry/integrations/github_enterprise/integration.py b/src/sentry/integrations/github_enterprise/integration.py
index c842c70081..caf468e11d 100644
--- a/src/sentry/integrations/github_enterprise/integration.py
+++ b/src/sentry/integrations/github_enterprise/integration.py
@@ -27,7 +27,15 @@ Define a relationship between Sentry and GitHub Enterprise.
  * Authorize repositories to be added for syncing commit data.
  * Create or link existing GitHub Enterprise issues.
 """
+disable_dialog = {
+    'actionText': 'Visit GitHub Enterprise',
+    'body': 'Before deleting this integration, you must uninstall it from your GitHub Enterprise instance. After uninstalling, your integration will be disabled at which point you can choose to delete this integration.'
+}
 
+removal_dialog = {
+    'actionText': 'Delete',
+    'body': 'Deleting this integration will delete all associated repositories and commit data. This action cannot be undone. Are you sure you want to delete your integration?'
+}
 
 metadata = IntegrationMetadata(
     description=DESCRIPTION.strip(),
@@ -35,7 +43,10 @@ metadata = IntegrationMetadata(
     noun=_('Installation'),
     issue_url='https://github.com/getsentry/sentry/issues/new?title=GitHub%20Integration:%20&labels=Component%3A%20Integrations',
     source_url='https://github.com/getsentry/sentry/tree/master/src/sentry/integrations/github_enterprise',
-    aspects={}
+    aspects={
+        'disable_dialog': disable_dialog,
+        'removal_dialog': removal_dialog,
+    },
 )
 
 
@@ -61,6 +72,13 @@ class GitHubEnterpriseIntegration(Integration, GitHubIssueBasic, RepositoryMixin
             data.append({'name': repo['name'], 'identifier': repo['full_name']})
         return data
 
+    def reinstall(self):
+        installation_id = self.model.external_id.split(':')[1]
+        metadata = self.model.metadata
+        metadata['installation_id'] = installation_id
+        self.model.update(metadata=metadata)
+        self.reinstall_repositories()
+
     def message_from_error(self, exc):
         if isinstance(exc, ApiError):
             message = API_ERRORS.get(exc.code)
@@ -236,7 +254,7 @@ class GitHubEnterpriseIntegrationProvider(GitHubIntegrationProvider):
             state['installation_id'])
 
         domain = urlparse(installation['account']['html_url']).netloc
-        return {
+        integration = {
             'name': installation['account']['login'],
             # installation id is not enough to be unique for self-hosted GH
             'external_id': '{}:{}'.format(domain, installation['id']),
@@ -250,6 +268,7 @@ class GitHubEnterpriseIntegrationProvider(GitHubIntegrationProvider):
                 'expires_at': None,
                 'icon': installation['account']['avatar_url'],
                 'domain_name': installation['account']['html_url'].replace('https://', ''),
+                'account_type': installation['account']['type'],
                 'installation_id': installation['id'],
                 'installation': installation_data
             },
@@ -262,6 +281,11 @@ class GitHubEnterpriseIntegrationProvider(GitHubIntegrationProvider):
             'idp_config': state['oauth_config_information']
         }
 
+        if state.get('reinstall_id'):
+            integration['reinstall_id'] = state['reinstall_id']
+
+        return integration
+
     def setup(self):
         from sentry.plugins import bindings
         bindings.add(
@@ -279,6 +303,9 @@ class GitHubEnterpriseInstallationRedirect(PipelineView):
 
     def dispatch(self, request, pipeline):
         installation_data = pipeline.fetch_state(key='installation_data')
+        if 'reinstall_id' in request.GET:
+            pipeline.bind_state('reinstall_id', request.GET['reinstall_id'])
+
         if 'installation_id' in request.GET:
             pipeline.bind_state('installation_id', request.GET['installation_id'])
             return pipeline.next_step()
diff --git a/src/sentry/static/sentry/app/views/organizationIntegrations/index.jsx b/src/sentry/static/sentry/app/views/organizationIntegrations/index.jsx
index 6b22299e8c..1803dde193 100644
--- a/src/sentry/static/sentry/app/views/organizationIntegrations/index.jsx
+++ b/src/sentry/static/sentry/app/views/organizationIntegrations/index.jsx
@@ -75,11 +75,12 @@ export default class OrganizationIntegrations extends AsyncComponent {
 
   handleDisableIntegration = integration => {
     let url;
+    let [domainName, orgName] = integration.domainName.split('/');
+
     if (integration.accountType === 'User') {
-      url = 'https://github.com/settings/installations';
+      url = `https://${domainName}/settings/installations`;
     } else {
-      let orgName = integration.domainName.split('/')[1];
-      url = `https://github.com/organizations/${orgName}/settings/installations`;
+      url = `https://${domainName}/organizations/${orgName}/settings/installations`;
     }
     window.open(url, '_blank');
   };
diff --git a/src/sentry/static/sentry/app/views/organizationIntegrations/installedIntegration.jsx b/src/sentry/static/sentry/app/views/organizationIntegrations/installedIntegration.jsx
index e4db7f1c2d..0b97e24036 100644
--- a/src/sentry/static/sentry/app/views/organizationIntegrations/installedIntegration.jsx
+++ b/src/sentry/static/sentry/app/views/organizationIntegrations/installedIntegration.jsx
@@ -148,7 +148,7 @@ export default class InstalledIntegration extends React.Component {
             )}
           </Box>
           <Box>
-            {integration.status === 'active' && integration.provider.key === 'github'
+            {integration.status === 'active' && integration.provider.canDisable
               ? this.renderDisableIntegration(integration)
               : this.renderRemoveIntegration(integration)}
           </Box>
diff --git a/tests/sentry/api/endpoints/test_group_integration_details.py b/tests/sentry/api/endpoints/test_group_integration_details.py
index a80d6a1836..88158f77c0 100644
--- a/tests/sentry/api/endpoints/test_group_integration_details.py
+++ b/tests/sentry/api/endpoints/test_group_integration_details.py
@@ -35,6 +35,7 @@ class GroupIntegrationDetailsTest(APITestCase):
                 'name': provider.name,
                 'canAdd': provider.can_add,
                 'canAddProject': provider.can_add_project,
+                'canDisable': provider.can_disable,
                 'features': [f.value for f in provider.features],
                 'aspects': provider.metadata.aspects,
             },
@@ -74,6 +75,7 @@ class GroupIntegrationDetailsTest(APITestCase):
                 'name': provider.name,
                 'canAdd': provider.can_add,
                 'canAddProject': provider.can_add_project,
+                'canDisable': provider.can_disable,
                 'features': [f.value for f in provider.features],
                 'aspects': provider.metadata.aspects,
             },
diff --git a/tests/sentry/api/endpoints/test_group_integrations.py b/tests/sentry/api/endpoints/test_group_integrations.py
index 937a638d7c..e063670dda 100644
--- a/tests/sentry/api/endpoints/test_group_integrations.py
+++ b/tests/sentry/api/endpoints/test_group_integrations.py
@@ -48,6 +48,7 @@ class GroupIntegrationsTest(APITestCase):
                 'name': provider.name,
                 'canAdd': provider.can_add,
                 'canAddProject': provider.can_add_project,
+                'canDisable': provider.can_disable,
                 'features': [f.value for f in provider.features],
                 'aspects': provider.metadata.aspects,
             },
diff --git a/tests/sentry/integrations/github_enterprise/test_integration.py b/tests/sentry/integrations/github_enterprise/test_integration.py
index b1c08499c0..208fac428f 100644
--- a/tests/sentry/integrations/github_enterprise/test_integration.py
+++ b/tests/sentry/integrations/github_enterprise/test_integration.py
@@ -89,6 +89,7 @@ class GitHubEnterpriseIntegrationTest(IntegrationTestCase):
                 'app_id': app_id,
                 'account': {
                     'login': 'Test Organization',
+                    'type': 'Organization',
                     'avatar_url': 'https://35.232.149.196/avatar.png',
                     'html_url': 'https://35.232.149.196/Test-Organization',
                 },
@@ -139,6 +140,7 @@ class GitHubEnterpriseIntegrationTest(IntegrationTestCase):
             u'expires_at': None,
             u'icon': u'https://35.232.149.196/avatar.png',
             u'domain_name': u'35.232.149.196/Test-Organization',
+            u'account_type': u'Organization',
             u'installation_id': u'install_id_1',
             u'installation': {
                 u'client_id': u'client_id',
