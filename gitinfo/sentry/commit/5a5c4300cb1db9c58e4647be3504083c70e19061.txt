commit 5a5c4300cb1db9c58e4647be3504083c70e19061
Author: ted kaemming <ted@kaemming.com>
Date:   Tue Mar 7 11:03:14 2017 -0800

    Correct interval expiration time and clarify retention behavior. (#5042)

diff --git a/src/sentry/scripts/similarity/index.lua b/src/sentry/scripts/similarity/index.lua
index d6587beb58..ea26bf47f5 100644
--- a/src/sentry/scripts/similarity/index.lua
+++ b/src/sentry/scripts/similarity/index.lua
@@ -142,7 +142,10 @@ local function get_active_indices(interval, retention, timestamp)
 end
 
 local function get_index_expiration_time(interval, retention, index)
-    return (index + retention) * interval
+    return (
+        (index + 1)  -- upper bound of this interval
+        + retention
+    ) * interval
 end
 
 
@@ -152,7 +155,7 @@ local configuration_parser = build_argument_parser({
     {"timestamp", parse_integer},
     {"bands", parse_integer},
     {"interval", parse_integer},
-    {"retention", parse_integer},
+    {"retention", parse_integer},  -- how many previous intervals to store (does not include current interval)
     {"scope", function (value)
         assert(value ~= nil)
         return value
diff --git a/src/sentry/similarity.py b/src/sentry/similarity.py
index 7d3077e4d0..f59889b517 100644
--- a/src/sentry/similarity.py
+++ b/src/sentry/similarity.py
@@ -350,7 +350,7 @@ features = FeatureSet(
         8,
         2,
         60 * 60 * 24 * 30,
-        4,
+        3,
     ),
     BidirectionalMapping({
         'exception:message:character-shingles': 'a',
