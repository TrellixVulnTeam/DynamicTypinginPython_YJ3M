commit afa3ea2da4b8190daa9c32f5751e3f8a4f1fa0fd
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Tue Jan 17 22:09:31 2017 -0800

    security: prevent bypassing password confirmation on totp form

diff --git a/src/sentry/web/forms/accounts.py b/src/sentry/web/forms/accounts.py
index d3ece95371..caefd3e837 100644
--- a/src/sentry/web/forms/accounts.py
+++ b/src/sentry/web/forms/accounts.py
@@ -653,3 +653,11 @@ class ConfirmPasswordForm(forms.Form):
 
         if not needs_password:
             del self.fields['password']
+
+    def clean_password(self):
+        value = self.cleaned_data.get('password')
+        if value and not self.user.check_password(value):
+            raise forms.ValidationError(_('The password you entered is not correct.'))
+        elif not value:
+            raise forms.ValidationError(_('You must confirm your current password to make changes.'))
+        return value
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index 183dcdaea8..a339af1d0b 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -87,11 +87,10 @@ class TwoFactorSettingsView(BaseView):
             form = ConfirmPasswordForm(request.user, request.POST)
             if 'password' in form.fields:
                 if form.is_valid():
-                    if request.user.check_password(form.cleaned_data['password']):
-                        self.delete_authenticator(interface)
-                        return HttpResponseRedirect(reverse('sentry-account-settings-2fa'))
-                    else:
-                        form.errors['__all__'] = ['Invalid password.']
+                    self.delete_authenticator(interface)
+                    return HttpResponseRedirect(reverse('sentry-account-settings-2fa'))
+                else:
+                    form.errors['__all__'] = ['Invalid password.']
             else:
                 self.delete_authenticator(interface)
                 return HttpResponseRedirect(reverse('sentry-account-settings-2fa'))
@@ -166,8 +165,8 @@ class TotpSettingsView(TwoFactorSettingsView):
         if 'otp' in request.POST:
             form = TwoFactorForm(request.POST)
             password_form = ConfirmPasswordForm(request.user, request.POST)
-            if 'password' in password_form.fields and password_form.is_valid():
-                if request.user.check_password(password_form.cleaned_data['password']):
+            if 'password' in password_form.fields:
+                if password_form.is_valid():
                     if form.is_valid() and interface.validate_otp(
                             form.cleaned_data['otp']):
                         return TwoFactorSettingsView.enroll(self, request, interface)
