commit 82f1b294b5f0ed59f47d5c677d5b85643282b351
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Sep 30 11:50:44 2015 -0700

    Various fixes to IP address normalization
    
    - Always store IP address as User even when interface not present
    - Only fetch IP from user in post process

diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index 6ef201f35a..ba13d219e9 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -302,6 +302,13 @@ class EventManager(object):
             exception['values'][0]['stacktrace'] = stacktrace
             del data['sentry.interfaces.Stacktrace']
 
+        if 'sentry.interfaces.Http' in data:
+            data.setdefault('sentry.interfaces.User', {})
+            data['sentry.interfaces.User'].setdefault(
+                'ip_address',
+                data['sentry.interfaces.Http'].get('env', {}).get('REMOTE_ADDR')
+            )
+
         if data['time_spent']:
             data['time_spent'] = int(data['time_spent'])
 
diff --git a/src/sentry/models/event.py b/src/sentry/models/event.py
index 39b9b3bac5..cead62a651 100644
--- a/src/sentry/models/event.py
+++ b/src/sentry/models/event.py
@@ -88,13 +88,13 @@ class Event(Model):
 
     @memoize
     def ip_address(self):
-        user_data = self.data.get('sentry.interfaces.User')
+        user_data = self.data.get('sentry.interfaces.User', self.data.get('user'))
         if user_data:
             value = user_data.get('ip_address')
             if value:
                 return value
 
-        http_data = self.data.get('sentry.interfaces.Http')
+        http_data = self.data.get('sentry.interfaces.Http', self.data.get('http'))
         if http_data and 'env' in http_data:
             value = http_data['env'].get('REMOTE_ADDR')
             if value:
diff --git a/src/sentry/tasks/post_process.py b/src/sentry/tasks/post_process.py
index 5d12ad8a7e..cb7508195e 100644
--- a/src/sentry/tasks/post_process.py
+++ b/src/sentry/tasks/post_process.py
@@ -105,7 +105,7 @@ def record_affected_user(event, **kwargs):
         ident=unicode(user_data.get('id')) if user_data.get('id') else None,
         email=user_data.get('email'),
         username=user_data.get('username'),
-        ip_address=event.ip_address,
+        ip_address=user_data.get('ip_address'),
     )
 
     try:
