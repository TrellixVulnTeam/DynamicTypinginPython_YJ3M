commit 6cfe19250206f510c7611f2a763016a2f06634e0
Author: William Mak <william@wmak.io>
Date:   Wed Feb 19 19:00:55 2020 -0500

    fix(discover) - Fixing csv exports containing #
    
    - Currently if a line includes # everything afterward gets truncated
      since it gets treated as an anchor tag in the url we send the user to.
      - I thought encodeURI would do this replacing for us TBH, but it looks
        like it only handles base urls well.

diff --git a/src/sentry/static/sentry/app/views/discover/result/utils.tsx b/src/sentry/static/sentry/app/views/discover/result/utils.tsx
index e0f9fa607e..ba74222ca1 100644
--- a/src/sentry/static/sentry/app/views/discover/result/utils.tsx
+++ b/src/sentry/static/sentry/app/views/discover/result/utils.tsx
@@ -366,7 +366,11 @@ export function downloadAsCsv(result: SnubaResult) {
     }),
   });
 
-  const encodedDataUrl = encodeURI(`data:text/csv;charset=utf8,${csvContent}`);
+  // Need to also manually replace # since encodeURI skips them
+  const encodedDataUrl = encodeURI(`data:text/csv;charset=utf8,${csvContent}`).replace(
+    /#/g,
+    '%23'
+  );
 
   window.location.assign(encodedDataUrl);
 }
diff --git a/src/sentry/static/sentry/app/views/eventsV2/utils.tsx b/src/sentry/static/sentry/app/views/eventsV2/utils.tsx
index 9faf4fb0d3..29a8af5437 100644
--- a/src/sentry/static/sentry/app/views/eventsV2/utils.tsx
+++ b/src/sentry/static/sentry/app/views/eventsV2/utils.tsx
@@ -335,7 +335,11 @@ export function downloadAsCsv(tableData, columnOrder, filename) {
     }),
   });
 
-  const encodedDataUrl = encodeURI(`data:text/csv;charset=utf8,${csvContent}`);
+  // Need to also manually replace # since encodeURI skips them
+  const encodedDataUrl = encodeURI(`data:text/csv;charset=utf8,${csvContent}`).replace(
+    /#/g,
+    '%23'
+  );
 
   // Create a download link then click it, this is so we can get a filename
   const link = document.createElement('a');
