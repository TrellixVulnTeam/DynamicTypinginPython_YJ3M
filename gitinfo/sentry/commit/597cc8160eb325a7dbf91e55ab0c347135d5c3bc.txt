commit 597cc8160eb325a7dbf91e55ab0c347135d5c3bc
Author: Tony <Zylphrex@users.noreply.github.com>
Date:   Tue Jun 9 14:19:40 2020 -0400

    fix(async-csv): Save the file size and checksum on assembly (#19247)

diff --git a/src/sentry/data_export/tasks.py b/src/sentry/data_export/tasks.py
index 145c5cb22d..f9311e3e25 100644
--- a/src/sentry/data_export/tasks.py
+++ b/src/sentry/data_export/tasks.py
@@ -235,6 +235,7 @@ def merge_export_blobs(data_export_id, **kwargs):
 
             file.size = size
             file.checksum = file_checksum.hexdigest()
+            file.save()
             data_export.finalize_upload(file=file)
 
             logger.info("dataexport.end", extra={"data_export_id": data_export_id})
diff --git a/tests/sentry/data_export/test_tasks.py b/tests/sentry/data_export/test_tasks.py
index 7213154e93..08de92c5c3 100644
--- a/tests/sentry/data_export/test_tasks.py
+++ b/tests/sentry/data_export/test_tasks.py
@@ -72,6 +72,8 @@ class AssembleDownloadTest(TestCase, SnubaTestCase):
         assert de.file is not None
         assert isinstance(de.file, File)
         assert de.file.headers == {"Content-Type": "text/csv"}
+        assert de.file.size is not None
+        assert de.file.checksum is not None
         # Convert raw csv to list of line-strings
         header, raw1, raw2 = de.file.getfile().read().strip().split("\r\n")
         assert header == "value,times_seen,last_seen,first_seen"
@@ -145,6 +147,8 @@ class AssembleDownloadTest(TestCase, SnubaTestCase):
         assert de.file is not None
         assert isinstance(de.file, File)
         assert de.file.headers == {"Content-Type": "text/csv"}
+        assert de.file.size is not None
+        assert de.file.checksum is not None
         # Convert raw csv to list of line-strings
         header = de.file.getfile().read().strip()
         assert header == "value,times_seen,last_seen,first_seen"
@@ -165,6 +169,8 @@ class AssembleDownloadTest(TestCase, SnubaTestCase):
         assert de.file is not None
         assert isinstance(de.file, File)
         assert de.file.headers == {"Content-Type": "text/csv"}
+        assert de.file.size is not None
+        assert de.file.checksum is not None
         # Convert raw csv to list of line-strings
         header, raw1, raw2, raw3 = de.file.getfile().read().strip().split("\r\n")
         assert header == "title"
@@ -205,6 +211,8 @@ class AssembleDownloadTest(TestCase, SnubaTestCase):
         assert de.file is not None
         assert isinstance(de.file, File)
         assert de.file.headers == {"Content-Type": "text/csv"}
+        assert de.file.size is not None
+        assert de.file.checksum is not None
         # Convert raw csv to list of line-strings
         # capping MAX_FILE_SIZE forces the last batch to be dropped, leaving 2 rows
         header, raw1, raw2 = de.file.getfile().read().strip().split("\r\n")
@@ -231,6 +239,8 @@ class AssembleDownloadTest(TestCase, SnubaTestCase):
         assert de.file is not None
         assert isinstance(de.file, File)
         assert de.file.headers == {"Content-Type": "text/csv"}
+        assert de.file.size is not None
+        assert de.file.checksum is not None
         # Convert raw csv to list of line-strings
         # capping MAX_FILE_SIZE forces the last batch to be dropped, leaving 2 rows
         header, raw1, raw2 = de.file.getfile().read().strip().split("\r\n")
