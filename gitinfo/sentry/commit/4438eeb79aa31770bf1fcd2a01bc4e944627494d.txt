commit 4438eeb79aa31770bf1fcd2a01bc4e944627494d
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Mon Feb 26 11:56:16 2018 -0800

    fix(projects): Make sure projects without teams still show up in org setting list (#7356)

diff --git a/src/sentry/static/sentry/app/stores/teamStore.jsx b/src/sentry/static/sentry/app/stores/teamStore.jsx
index 51ca819f66..6adce3aa77 100644
--- a/src/sentry/static/sentry/app/stores/teamStore.jsx
+++ b/src/sentry/static/sentry/app/stores/teamStore.jsx
@@ -13,6 +13,7 @@ const TeamStore = Reflux.createStore({
 
   reset() {
     this.items = [];
+    // TODO(jess): this is not going to make sense/be accurate in sentry 9
     this.projectMap = {}; // map of project ids => team ids
   },
 
@@ -55,6 +56,7 @@ const TeamStore = Reflux.createStore({
 
   onProject(projectIds) {
     let teamsChanged = new Set();
+
     projectIds.forEach((set, projectId) => {
       let teamId = this.projectMap[projectId];
       if (teamId === undefined) return;
@@ -62,7 +64,13 @@ const TeamStore = Reflux.createStore({
       // TODO: make copy of project? right now just assigning reference
       // to project form project store
       let project = ProjectsStore.getById(projectId);
-      team.project = project;
+      // so gross don't look, update projects in
+      // the team.projects list. this should be behavior
+      // we can completely deprecate after sentry 9
+      team.projects = team.projects.filter(p => {
+        return p.slug !== project.slug;
+      });
+      team.projects.push(project);
       teamsChanged.add(team.id);
     });
     this.trigger(teamsChanged);
diff --git a/src/sentry/static/sentry/app/views/organizationContext.jsx b/src/sentry/static/sentry/app/views/organizationContext.jsx
index f3a095f514..e94646d857 100644
--- a/src/sentry/static/sentry/app/views/organizationContext.jsx
+++ b/src/sentry/static/sentry/app/views/organizationContext.jsx
@@ -101,11 +101,7 @@ const OrganizationContext = createReactClass({
         setActiveOrganization(data);
 
         TeamStore.loadInitialData(data.teams);
-        ProjectsStore.loadInitialData(
-          data.teams.reduce((out, team) => {
-            return out.concat(team.projects);
-          }, [])
-        );
+        ProjectsStore.loadInitialData(data.projects);
       },
 
       error: (_, textStatus, errorThrown) => {
diff --git a/tests/js/setup.js b/tests/js/setup.js
index 5da47e2230..06a61b8d78 100644
--- a/tests/js/setup.js
+++ b/tests/js/setup.js
@@ -494,6 +494,7 @@ window.TestStubs = {
       features: [],
       onboardingTasks: [],
       teams: [],
+      projects: [],
       ...params,
     };
   },
diff --git a/tests/js/spec/views/__snapshots__/organizationProjects.spec.jsx.snap b/tests/js/spec/views/__snapshots__/organizationProjects.spec.jsx.snap
index 58f0718efe..de30531b81 100644
--- a/tests/js/spec/views/__snapshots__/organizationProjects.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/organizationProjects.spec.jsx.snap
@@ -312,6 +312,7 @@ exports[`OrganizationProjectsView render() Should render the projects in the sto
                                       "id": "3",
                                       "name": "Organization Name",
                                       "onboardingTasks": Array [],
+                                      "projects": Array [],
                                       "slug": "org-slug",
                                       "status": Object {
                                         "id": "active",
@@ -387,6 +388,7 @@ exports[`OrganizationProjectsView render() Should render the projects in the sto
                                                 "id": "3",
                                                 "name": "Organization Name",
                                                 "onboardingTasks": Array [],
+                                                "projects": Array [],
                                                 "slug": "org-slug",
                                                 "status": Object {
                                                   "id": "active",
diff --git a/tests/js/spec/views/__snapshots__/organizationRateLimits.spec.jsx.snap b/tests/js/spec/views/__snapshots__/organizationRateLimits.spec.jsx.snap
index 4ae55adaa5..82cc2f6623 100644
--- a/tests/js/spec/views/__snapshots__/organizationRateLimits.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/organizationRateLimits.spec.jsx.snap
@@ -99,6 +99,7 @@ exports[`OrganizationStats renders 1`] = `
         "id": "3",
         "name": "Organization Name",
         "onboardingTasks": Array [],
+        "projects": Array [],
         "slug": "org-slug",
         "status": Object {
           "id": "active",
@@ -163,6 +164,7 @@ exports[`OrganizationStats renders 1`] = `
           "id": "3",
           "name": "Organization Name",
           "onboardingTasks": Array [],
+          "projects": Array [],
           "slug": "org-slug",
           "status": Object {
             "id": "active",
diff --git a/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap b/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap
index 1eb12d6815..9161b441d1 100644
--- a/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap
@@ -213,6 +213,7 @@ exports[`OrganizationTeamProjects Should render 1`] = `
                                 "id": "3",
                                 "name": "Organization Name",
                                 "onboardingTasks": Array [],
+                                "projects": Array [],
                                 "slug": "org-slug",
                                 "status": Object {
                                   "id": "active",
@@ -288,6 +289,7 @@ exports[`OrganizationTeamProjects Should render 1`] = `
                                           "id": "3",
                                           "name": "Organization Name",
                                           "onboardingTasks": Array [],
+                                          "projects": Array [],
                                           "slug": "org-slug",
                                           "status": Object {
                                             "id": "active",
diff --git a/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
index 0cff2384f1..8580ef1f3e 100644
--- a/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
@@ -62,6 +62,7 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
             "id": "3",
             "name": "Organization Name",
             "onboardingTasks": Array [],
+            "projects": Array [],
             "slug": "org-slug",
             "status": Object {
               "id": "active",
@@ -596,6 +597,7 @@ exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
             "id": "3",
             "name": "Organization Name",
             "onboardingTasks": Array [],
+            "projects": Array [],
             "slug": "org-slug",
             "status": Object {
               "id": "active",
diff --git a/tests/js/spec/views/__snapshots__/projectAlertSettings.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectAlertSettings.spec.jsx.snap
index b8441eeca5..6ad1b99736 100644
--- a/tests/js/spec/views/__snapshots__/projectAlertSettings.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectAlertSettings.spec.jsx.snap
@@ -94,6 +94,7 @@ exports[`ProjectAlertSettings render() renders 1`] = `
           "id": "3",
           "name": "Organization Name",
           "onboardingTasks": Array [],
+          "projects": Array [],
           "slug": "org-slug",
           "status": Object {
             "id": "active",
diff --git a/tests/js/spec/views/__snapshots__/projectPluginDetails.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectPluginDetails.spec.jsx.snap
index 1dbf5a8f8f..a4bc079f5e 100644
--- a/tests/js/spec/views/__snapshots__/projectPluginDetails.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectPluginDetails.spec.jsx.snap
@@ -151,6 +151,7 @@ exports[`ProjectPluginDetails renders 1`] = `
       "id": "3",
       "name": "Organization Name",
       "onboardingTasks": Array [],
+      "projects": Array [],
       "slug": "org-slug",
       "status": Object {
         "id": "active",
@@ -201,6 +202,7 @@ exports[`ProjectPluginDetails renders 1`] = `
         "id": "3",
         "name": "Organization Name",
         "onboardingTasks": Array [],
+        "projects": Array [],
         "slug": "org-slug",
         "status": Object {
           "id": "active",
@@ -404,6 +406,7 @@ exports[`ProjectPluginDetails renders 1`] = `
                     "id": "3",
                     "name": "Organization Name",
                     "onboardingTasks": Array [],
+                    "projects": Array [],
                     "slug": "org-slug",
                     "status": Object {
                       "id": "active",
@@ -572,6 +575,7 @@ exports[`ProjectPluginDetails renders 1`] = `
                                   "id": "3",
                                   "name": "Organization Name",
                                   "onboardingTasks": Array [],
+                                  "projects": Array [],
                                   "slug": "org-slug",
                                   "status": Object {
                                     "id": "active",
