commit 8d6891b91d1f1bbcb4a3e0fe8902ce6214892442
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu Feb 9 11:58:58 2017 +0100

    Calculate instruction_offset somewhat more correctly now.

diff --git a/src/sentry/lang/native/plugin.py b/src/sentry/lang/native/plugin.py
index 12a88ff6f0..8668c5f70d 100644
--- a/src/sentry/lang/native/plugin.py
+++ b/src/sentry/lang/native/plugin.py
@@ -16,7 +16,6 @@ from sentry.lang.native.utils import \
     find_apple_crash_report_referenced_images, get_sdk_from_event, \
     find_stacktrace_referenced_images, get_sdk_from_apple_system_info, \
     APPLE_SDK_MAPPING
-from sentry.utils.native import parse_addr
 from sentry.stacktraces import StacktraceProcessor
 
 
@@ -426,6 +425,7 @@ class NativeStacktraceProcessor(StacktraceProcessor):
             'instruction_addr': self.find_best_instruction(
                 frame, stacktrace_info, idx),
             'symbol_name': frame.get('function'),
+            'symbol_addr': frame.get('symbol_addr'),
         }
         in_app = self.sym.is_in_app(sym_input_frame)
 
@@ -477,10 +477,9 @@ class NativeStacktraceProcessor(StacktraceProcessor):
             # find a different symbol than the client did.  However
             # our symbolizer cannot tell us where a symbol is so this
             # is the best we can do for now.  Maybe we kill it?
-            if frame.get('symbol_addr') is not None:
-                new_frame['instruction_offset'] = \
-                    parse_addr(frame['instruction_addr']) - \
-                    parse_addr(frame['symbol_addr'])
+            instruction_offset = sfrm.get('instruction_offset')
+            if instruction_offset is not None:
+                new_frame['instruction_offset'] = instruction_offset
             if sfrm.get('column') is not None:
                 new_frame['colno'] = sfrm['column']
             new_frame['package'] = sfrm['object_name'] \
diff --git a/src/sentry/lang/native/symbolizer.py b/src/sentry/lang/native/symbolizer.py
index 2ba6627b92..0e1bd15e13 100644
--- a/src/sentry/lang/native/symbolizer.py
+++ b/src/sentry/lang/native/symbolizer.py
@@ -214,6 +214,14 @@ class Symbolizer(object):
                ('/' not in rv['object_name'] and '/' in img['name']):
                 rv['object_name'] = img['name']
             rv['uuid'] = img['uuid']
+
+        symbol_addr = frame.get('symbol_addr')
+        if symbol_addr is not None:
+            symbol_addr = parse_addr(symbol_addr)
+            slide_value = img.get('image_vmaddr') or 0
+            rv['instruction_offset'] = parse_addr(frame['instruction_addr']) \
+                - slide_value - symbol_addr
+
         return rv
 
     def _get_frame_package(self, frame, img):
