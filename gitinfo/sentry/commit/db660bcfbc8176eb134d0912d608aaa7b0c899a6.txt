commit db660bcfbc8176eb134d0912d608aaa7b0c899a6
Author: Jess MacQueen <jess@getsentry.com>
Date:   Thu Mar 9 14:49:41 2017 -0800

    replace most static values in release email with real data

diff --git a/src/sentry/plugins/sentry_mail/activity/release.py b/src/sentry/plugins/sentry_mail/activity/release.py
index 639a782162..335ff409a9 100644
--- a/src/sentry/plugins/sentry_mail/activity/release.py
+++ b/src/sentry/plugins/sentry_mail/activity/release.py
@@ -2,7 +2,12 @@ from __future__ import absolute_import
 
 from sentry import features
 from sentry.db.models.query import in_iexact
-from sentry.models import GroupSubscriptionReason, Release, ReleaseCommit, User
+from sentry.models import (
+    CommitFileChange, Group, GroupSubscriptionReason,
+    GroupCommitResolution, Release, ReleaseCommit,
+    Repository, User
+)
+from sentry.utils.http import absolute_uri
 
 from .base import ActivityEmail
 
@@ -10,15 +15,15 @@ from .base import ActivityEmail
 class ReleaseActivityEmail(ActivityEmail):
     def __init__(self, activity):
         super(ReleaseActivityEmail, self).__init__(activity)
+        self.organization = self.project.organization
         try:
             self.release = Release.objects.get(
                 organization_id=self.project.organization_id,
-                projects=self.project,
                 version=activity.data['version'],
             )
         except Release.DoesNotExist:
             self.release = None
-            self.commit_list = []
+            self.repos = []
         else:
             self.commit_list = [
                 rc.commit
@@ -26,6 +31,25 @@ class ReleaseActivityEmail(ActivityEmail):
                     release=self.release,
                 ).select_related('commit', 'commit__author')
             ]
+            repos = {
+                r['id']: {
+                    'name': r['name'],
+                    'commits': [],
+                }
+                for r in Repository.objects.filter(
+                    organization_id=self.project.organization_id,
+                    id__in={c.repository_id for c in self.commit_list}
+                ).values('id', 'name')
+            }
+            for commit in self.commit_list:
+                repos[commit.repository_id].commits.append(commit)
+
+            self.repos = repos.values()
+
+            self.email_list = set([
+                c.author.email for c in self.commit_list
+                if c.author
+            ])
 
     def should_email(self):
         return bool(self.release)
@@ -33,12 +57,7 @@ class ReleaseActivityEmail(ActivityEmail):
     def get_participants(self):
         project = self.project
 
-        email_list = set([
-            c.author.email for c in self.commit_list
-            if c.author
-        ])
-
-        if not email_list:
+        if not self.email_list:
             return {}
 
         # identify members which have been seen in the commit log and have
@@ -46,7 +65,7 @@ class ReleaseActivityEmail(ActivityEmail):
         return {
             user: GroupSubscriptionReason.committed
             for user in User.objects.filter(
-                in_iexact('emails__email', email_list),
+                in_iexact('emails__email', self.email_list),
                 emails__is_verified=True,
                 sentry_orgmember_set__teams=project.team,
                 is_active=True,
@@ -55,8 +74,37 @@ class ReleaseActivityEmail(ActivityEmail):
         }
 
     def get_context(self):
+        # TODO(jess): this needs to be filtered by what users have access to
+        projects = list(self.release.projects.all())
+        file_count = CommitFileChange.objects.filter(
+            commit__in=self.commit_list,
+            organization_id=self.organization.id,
+        ).values('filename').distinct().count()
+        release_links = [
+            absolute_uri('/{}/{}/releases/{}/'.format(
+                self.organization.slug,
+                p.slug,
+                self.release.version,
+            )) for p in projects
+        ]
+        resolved_issue_counts = [
+            Group.objects.filter(
+                project=p,
+                id__in=GroupCommitResolution.objects.filter(
+                    commit_id__in=ReleaseCommit.objects.filter(
+                        release=self.release,
+                    ).values_list('commit_id', flat=True),
+                ).values_list('group_id', flat=True),
+            ).count() for p in projects
+        ]
+
         return {
-            'commit_list': self.commit_list,
+            'projects': zip(projects, release_links, resolved_issue_counts),
+            'project_count': len(projects),
+            'commit_count': len(self.commit_list),
+            'author_count': len(self.email_list),
+            'file_count': file_count,
+            'repos': self.repos,
             'release': self.release,
         }
 
diff --git a/src/sentry/templates/sentry/emails/activity/release.html b/src/sentry/templates/sentry/emails/activity/release.html
index 101b9b2108..1625520580 100644
--- a/src/sentry/templates/sentry/emails/activity/release.html
+++ b/src/sentry/templates/sentry/emails/activity/release.html
@@ -7,9 +7,10 @@
 
 {% block activity %}
     <h2 style="margin-bottom: 10px">
+        <!-- TODO(jess) update these static values -->
         Version {{ release.short_version }} was [deployed] to [production]
     </h2>
-    <p class="muted"><small><strong style="color: #72697d;">{{ release.date_added }}</strong> <span class="divider">&nbsp;</span>  23 commits, 2 authors, and 14 files changed across 2 projects</small></p>
+    <p class="muted"><small><strong style="color: #72697d;">{{ release.date_added }}</strong> <span class="divider">&nbsp;</span>  {{ commit_count }} commits, {{ author_count }} authors, and {{ file_count }} files changed across {{ project_count }} projects</small></p>
 
     <hr>
 
@@ -17,109 +18,58 @@
     <div class="table-border">
       <table class="table projects">
         <tbody>
-          <tr>
-            <td>
-              <h5 style="margin-bottom: 0">Frontend</h5>
-              <p class="muted" style="margin-bottom: 0">
-                2 Issues expected to be resolved
-              </p>
-            </td>
-            <td style="text-align: right">
-              <a href="{{ release_link }}" class="btn btn-sm btn-primary">View Release</a>
-            </td>
-          </tr>
-          <tr>
-            <td>
-              <h5 style="margin-bottom: 0">Backend</h5>
-              <p class="muted" style="margin-bottom: 0">
-                4 Issues expected to be resolved
-              </p>
-            </td>
-            <td style="text-align: right">
-              <a href="{{ release_link }}" class="btn btn-sm btn-primary">View Release</a>
-            </td>
-          </tr>
+          {% for project, release_link, resolved_issue_count in projects %}
+            <tr>
+              <td>
+                <h5 style="margin-bottom: 0">{{ project.name }}</h5>
+                <p class="muted" style="margin-bottom: 0">
+                  {{ resolved_issue_count }} Issues expected to be resolved
+                </p>
+              </td>
+              <td style="text-align: right">
+                <a href="{{ release_link }}" class="btn btn-sm btn-primary">View Release</a>
+              </td>
+            </tr>
+          {% endfor %}
         </tbody>
       </table>
     </div>
 
     <hr style="margin-top: 20px">
 
-    {% if commit_list %}
+    {% if repos %}
     <h6 style="margin-top: 10px">Commits</h6>
     <div class="table-border">
       <table class="table commit-list" style="margin-bottom: 0;">
-        <tr>
-          <th class="lowercase" colspan="3">getsentry/getsentry</th>
-        </tr>
-        {% for commit in commit_list %}
+        {% for repo in repos %}
           <tr>
-            <td>
-              {% if commit.message %}
-                  {{ commit.title }}
-              {% else %}
-                  No message provided
-              {% endif %}
-            </td>
-            <td>
-              <small>{{ commit.short_id }}</small>
-            </td>
-            <td>
-              {% if commit.author %}
-                  <small>{{ commit.author.name }}</small>
-              {% else %}
-                  <small>No author provided</small>
-              {% endif %}
-            </td>
-          </tr>
-        {% endfor %}
-        <tr>
-          <th class="lowercase" colspan="3">getsentry/sentry</th>
-        </tr>
-        {% for commit in commit_list %}
-          <tr>
-            <td>
-              {% if commit.message %}
-                  {{ commit.title }}
-              {% else %}
-                  No message provided
-              {% endif %}
-            </td>
-            <td>
-              <small>{{ commit.short_id }}</small>
-            </td>
-            <td>
-              {% if commit.author %}
-                  <small>{{ commit.author.name }}</small>
-              {% else %}
-                  <small>No author provided</small>
-              {% endif %}
-            </td>
+            <th class="lowercase" colspan="3">{{ repo.name }}</th>
           </tr>
+          {% for commit in repo.commits %}
+            <tr>
+              <td>
+                {% if commit.message %}
+                    {{ commit.title }}
+                {% else %}
+                    No message provided
+                {% endif %}
+              </td>
+              <td>
+                <small>{{ commit.short_id }}</small>
+              </td>
+              <td>
+                {% if commit.author %}
+                    <small>{{ commit.author.name }}</small>
+                {% else %}
+                    <small>No author provided</small>
+                {% endif %}
+              </td>
+            </tr>
+          {% endfor %}
         {% endfor %}
       </table>
     </div>
     {% else %}
       <p>It looks like there's no commit data wired up yet :(</p>
     {% endif %}
-
-    <!-- {% if commit_list %}
-        <ul class="commit-list">
-            {% for commit in commit_list %}
-                <li>
-                    {% if commit.message %}
-                        <strong>{{ commit.title }}</strong><br />
-                        <small>
-                            &mdash; {% if commit.author %}by {{ commit.author.name }}{% endif %}
-                            in {{ commit.short_id }}
-                        </small>
-                    {% else %}
-                        <small>{{ commit.short_id }}</small>
-                    {% endif %}
-                </li>
-            {% endfor %}
-        </ul>
-    {% else %}
-        <p>It looks like there's no commit data wired up yet :(</p>
-    {% endif %} -->
 {% endblock %}
diff --git a/src/sentry/web/frontend/debug/debug_new_release_email.py b/src/sentry/web/frontend/debug/debug_new_release_email.py
index 32654ba60b..00372d25d3 100644
--- a/src/sentry/web/frontend/debug/debug_new_release_email.py
+++ b/src/sentry/web/frontend/debug/debug_new_release_email.py
@@ -27,53 +27,77 @@ class DebugNewReleaseEmailView(View):
             name='My Team',
             organization=org,
         )
-        project = Project(
-            id=1,
-            organization=org,
-            team=team,
-            slug='project',
-            name='My Project',
-        )
+        projects = [
+            Project(
+                id=1,
+                organization=org,
+                team=team,
+                slug='project',
+                name='My Project',
+            ),
+            Project(
+                id=2,
+                organization=org,
+                team=team,
+                slug='another-project',
+                name='Another Project',
+            ),
+        ]
         release = Release(
-            organization_id=project.organization_id,
+            organization_id=org.id,
             version='6c998f755f304593a4713abd123eaf8833a2de5e',
             date_added=datetime(2016, 10, 12, 15, 39, tzinfo=pytz.utc)
         )
 
-        release_link = absolute_uri('/{}/{}/releases/{}/'.format(
-            org.slug,
-            project.slug,
-            release.version,
-        ))
-
-        project_link = absolute_uri('/{}/{}/'.format(
-            org.slug,
-            project.slug,
-        ))
-
-        commit_list = [
-            Commit(key='48b86fcd677da3dba5679d7a738240ce6fb74b20'),
-            Commit(
-                key='a53a2756bb8d111b43196210b34df90b87ed336b',
-                message='Update README.rst',
-                author=CommitAuthor(
-                    name='David Cramer',
-                    email='david@sentry.io',
-                )
-            ),
+        release_links = [
+            absolute_uri('/{}/{}/releases/{}/'.format(
+                org.slug,
+                p.slug,
+                release.version,
+            )) for p in projects
         ]
 
+        repos = [{
+            'name': 'getsentry/getsentry',
+            'commits': [
+                Commit(key='48b86fcd677da3dba5679d7a738240ce6fb74b20'),
+                Commit(
+                    key='a53a2756bb8d111b43196210b34df90b87ed336b',
+                    message='Fix billing',
+                    author=CommitAuthor(
+                        name='David Cramer',
+                        email='david@sentry.io',
+                    )
+                ),
+            ],
+        }, {
+            'name': 'getsentry/sentry',
+            'commits': [
+                Commit(key='3c8eb3b4af6ee2a29c68daa188fc730c8e4b39fd'),
+                Commit(
+                    key='631cd9096bd9811a046a472bb0aa8b573e86e1f1',
+                    message='Update README.rst',
+                    author=CommitAuthor(
+                        name='David Cramer',
+                        email='david@sentry.io',
+                    )
+                ),
+            ],
+        }]
+
         return MailPreview(
             html_template='sentry/emails/activity/release.html',
             text_template='sentry/emails/activity/release.txt',
             context={
                 'release': release,
-                'project': project,
-                'release_link': release_link,
-                'project_link': project_link,
-                'commit_list': commit_list,
+                'projects': zip(projects, release_links, [6, 1]),
+                'repos': repos,
                 'reason': GroupSubscriptionReason.descriptions[
                     GroupSubscriptionReason.committed
                 ],
+                'project_count': len(projects),
+                'commit_count': 4,
+                'author_count': 1,
+                'file_count': 5,
             },
         ).render(request)
