commit b9e7a0e0d4fdb6d2f0ed83d5a39b394827bfbbb0
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Tue Oct 22 01:51:30 2019 +0300

    build(docker): Push Docker images to Docker Hub (#15209)

diff --git a/docker/cloudbuild.yaml b/docker/cloudbuild.yaml
index 727c331df5..e1115dc9e1 100644
--- a/docker/cloudbuild.yaml
+++ b/docker/cloudbuild.yaml
@@ -4,7 +4,6 @@ steps:
     '--cache=true',
     '--build-arg', 'SOURCE_COMMIT=$COMMIT_SHA',
     '--destination=us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA',
-    '--destination=us.gcr.io/$PROJECT_ID/sentry:$SHORT_SHA',
     '-f', './docker/Dockerfile'
   ]
   timeout: 900s
@@ -24,26 +23,41 @@ steps:
     # TODO(byk): We may also build this part as a builder image everytime
     #            there's a push to onpremise and use that image for
     curl -L "https://github.com/getsentry/onpremise/archive/v10.tar.gz" | tar xzf - --strip-components=1
-    ./install.sh
-    docker-compose run --rm web createuser --superuser --email test@example.com --password test123TEST
     # The following trick is from https://stackoverflow.com/a/52400857/90297 with great gratuity
     echo '{"version": "3.4", "networks":{"default":{"external":{"name":"cloudbuild"}}}}' > docker-compose.override.yml
+    ./install.sh
+    docker-compose run --rm web createuser --superuser --email test@example.com --password test123TEST
     docker-compose up -d
     timeout 20 bash -c 'until $(curl -Isf -o /dev/null http://web:9000); do printf "."; sleep 0.5; done' || docker-compose logs web
     ./test.sh
   timeout: 1200s
-# Only tag "latest" when on master
 - name: 'gcr.io/cloud-builders/docker'
+  secretEnv: ['DOCKER_PASSWORD']
   entrypoint: 'bash'
   args:
   - '-e'
   - '-c'
   - |
+    # Need to pull the image first due to Kaniko
+    docker pull us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA
+    echo "$$DOCKER_PASSWORD" | docker login --username=sentrybuilder --password-stdin
+    docker tag us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA getsentry/sentry:$SHORT_SHA
+    docker push getsentry/sentry:$SHORT_SHA
+    docker tag us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA getsentry/sentry:$COMMIT_SHA
+    docker push getsentry/sentry:$COMMIT_SHA
+    # Only tag "latest" when on master
     if [ "$BRANCH_NAME" == "master" ]; then
-      docker tag us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA us.gcr.io/$PROJECT_ID/sentry:latest
-      docker push us.gcr.io/$PROJECT_ID/sentry:latest
+      docker tag us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA getsentry/sentry:latest
+      docker push getsentry/sentry:latest
     fi
 timeout: 2400s
 options:
   # We need more memory for Webpack builds & e2e onpremise tests
   machineType: 'N1_HIGHCPU_8'
+secrets:
+- kmsKeyName: projects/sentryio/locations/global/keyRings/service-credentials/cryptoKeys/cloudbuild
+  secretEnv:
+    DOCKER_PASSWORD: |
+      CiQAE8gN7y3OMxn+a1kofmK4Bi8jQZtdRFj2lYYwaZHVeIIBUzMSTQA9tvn8XCv2vqj6u8CHoeSP
+      TVW9pLvSCorKoeNtOp0eb+6V1yNJW/+JC07DNO1KLbTbodbuza6jKJHU5xeAJ4kGQI78UY5Vu1Gp
+      QcMK
