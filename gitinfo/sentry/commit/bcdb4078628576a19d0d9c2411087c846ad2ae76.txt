commit bcdb4078628576a19d0d9c2411087c846ad2ae76
Author: Anton Ovchinnikov <anton@tonyo.info>
Date:   Wed Oct 2 13:42:53 2019 +0200

    feat(simple-consumer): Add a metric for consumer capacity (#14901)
    
    * feat(simple-consumer): Add a metric for consumer capacity
    
    * fix: Check that commit_batch_size is a positive number

diff --git a/src/sentry/utils/kafka.py b/src/sentry/utils/kafka.py
index 39ec36f3e0..572bddefd8 100644
--- a/src/sentry/utils/kafka.py
+++ b/src/sentry/utils/kafka.py
@@ -76,6 +76,9 @@ class SimpleKafkaConsumer(object):
         self.initial_offset_reset = initial_offset_reset
         self.consumer_group = consumer_group
 
+        if self.commit_batch_size <= 0:
+            raise ValueError("Commit batch size must be a positive integer")
+
         cluster_name = settings.KAFKA_TOPICS[topic_name]["cluster"]
         bootstrap_servers = settings.KAFKA_CLUSTERS[cluster_name]["bootstrap.servers"]
 
@@ -161,6 +164,12 @@ class SimpleKafkaConsumer(object):
                 metrics.timing(
                     "simple_consumer.committed_batch.size", len(messages), tags=metrics_tags
                 )
+                # Value between 0.0 and 1.0 that can help to estimate the consumer bandwidth/usage
+                metrics.timing(
+                    "simple_consumer.batch_capacity.usage",
+                    1.0 * len(messages) / self.commit_batch_size,
+                    tags=metrics_tags,
+                )
 
         consumer.close()
         logger.debug(
