commit ba4e369beec721764453552dd0f0dc12077f17bd
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 18 11:43:06 2018 -0800

    feat(ci): Add coverage and junit results for js (#6929)

diff --git a/.babelrc b/.babelrc
index 7684309268..6ffd5e7adc 100644
--- a/.babelrc
+++ b/.babelrc
@@ -21,12 +21,16 @@
     [
       "babel-plugin-transform-builtin-extend",
       {
-        "globals": ["Array"]
+        "globals": ["Array", "Error"]
       }
-    ],
-    "idx"
+    ]
   ],
   "env": {
+    "production": {
+      "plugins": [
+        "idx"
+      ]
+    },
     "development": {
       "plugins": [
         ["emotion", {"sourceMap": true, "autoLabel": true}]
@@ -44,10 +48,9 @@
         [
           "babel-plugin-transform-builtin-extend",
           {
-            "globals": ["Array"]
+            "globals": ["Array", "Error"]
           }
-        ],
-        "idx"
+        ]
       ]
     }
   }
diff --git a/.eslintignore b/.eslintignore
index 0ce5b673fd..a9302d11ca 100644
--- a/.eslintignore
+++ b/.eslintignore
@@ -3,3 +3,4 @@
 **/tests/sentry/lang/javascript/fixtures/**/*
 **/tests/sentry/lang/javascript/example-project/**/*
 /examples/
+/scripts/
diff --git a/.gitignore b/.gitignore
index 97c6e1ede7..b4d21fde0d 100644
--- a/.gitignore
+++ b/.gitignore
@@ -13,6 +13,7 @@ pip-log.txt
 celerybeat-schedule
 sentry-package.json
 /htmlcov
+/coverage/
 /cover
 /build
 /dist
diff --git a/.travis.yml b/.travis.yml
index 6ef49caed2..1b61a5d9a1 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -30,6 +30,7 @@ env:
     - TRAVIS_NODE_VERSION=8.9.1
     - CXX=g++-4.8
     - SOUTH_TESTS_MIGRATE=1
+    - JEST_JUNIT_OUTPUT=jest.junit.xml
 install:
   - 'export PATH=$PATH:~/.bin'
   - nvm install $TRAVIS_NODE_VERSION
@@ -44,18 +45,24 @@ after_success:
   - codecov -e TEST_SUITE
   - npm install -g @zeus-ci/cli
   - zeus upload -t "text/xml+xunit" junit.xml
+  - zeus upload -t "text/xml+xunit" jest.junit.xml
   - zeus upload -t "text/xml+coverage" coverage.xml
+  - zeus upload -t "text/xml+coverage" coverage/cobertura-coverage.xml
   - zeus upload -t "text/html+pytest" pytest.html
   - zeus upload -t "text/plain+pycodestyle" flake8.pycodestyle.log
   - zeus upload -t "text/xml+checkstyle" eslint.checkstyle.xml
+  - zeus upload -t "application/webpack-stats+json" webpack-stats.json
 after_failure:
   - dmesg | tail -n 100
   - npm install -g @zeus-ci/cli
   - zeus upload -t "text/xml+xunit" junit.xml
+  - zeus upload -t "text/xml+xunit" jest.junit.xml
   - zeus upload -t "text/xml+coverage" coverage.xml
+  - zeus upload -t "text/xml+coverage" coverage/cobertura-coverage.xml
   - zeus upload -t "text/html+pytest" pytest.html
   - zeus upload -t "text/plain+pycodestyle" flake8.pycodestyle.log
   - zeus upload -t "text/xml+checkstyle" eslint.checkstyle.xml
+  - zeus upload -t "application/webpack-stats+json" webpack-stats.json
 # each attribute in the matrix will override the global attribute
 matrix:
   fast_finish: true
diff --git a/Makefile b/Makefile
index b5d1d1a3f4..939b0c42d7 100644
--- a/Makefile
+++ b/Makefile
@@ -123,7 +123,7 @@ test-cli:
 
 test-js:
 	@echo "--> Building static assets"
-	@${NPM_ROOT}/.bin/webpack
+	@${NPM_ROOT}/.bin/webpack --profile --json > webpack-stats.json
 	@echo "--> Running JavaScript tests"
 	@npm run test-ci
 	@echo ""
@@ -163,7 +163,7 @@ lint-python:
 
 lint-js:
 	@echo "--> Linting javascript"
-	bash -eo pipefail -c "bin/lint --js --parseable | tee eslint.codestyle.xml"
+	bash -eo pipefail -c "bin/lint --js --parseable | tee eslint.checkstyle.xml"
 	@echo ""
 
 coverage: develop
diff --git a/package.json b/package.json
index 9af03bbc93..eb660f210b 100644
--- a/package.json
+++ b/package.json
@@ -18,6 +18,7 @@
     "babel-plugin-transform-class-properties": "^6.24.1",
     "babel-plugin-transform-decorators-legacy": "^1.3.4",
     "babel-plugin-transform-object-rest-spread": "^6.20.2",
+    "babel-plugin-transform-runtime": "^6.23.0",
     "babel-polyfill": "6.20.0",
     "babel-preset-latest": "^6.16.0",
     "babel-preset-react": "^6.16.0",
@@ -92,11 +93,11 @@
   "APIMethod": "stub",
   "proxyURL": "http://localhost:8000",
   "scripts": {
-    "test": "npm run jest -- tests/js/spec",
-    "test-ci": "npm run test -- --runInBand",
+    "test": "node scripts/test.js",
+    "test-ci": "npm run test -- --runInBand --ci --coverage --testResultsProcessor=jest-junit",
     "test-watch": "npm run test -- --watch",
-    "jest": "NODE_ENV=test node_modules/.bin/jest",
-    "jest-debug": "NODE_ENV=test node --inspect-brk node_modules/.bin/jest --runInBand",
+    "jest": "node scripts/test.js",
+    "jest-debug": "node --inspect-brk scripts/test.js --runInBand",
     "lint": "node_modules/.bin/eslint tests/js src/sentry/static/sentry/app --ext .jsx",
     "dev-proxy": "node scripts/devproxy.js",
     "dev-server": "webpack-dev-server",
@@ -105,6 +106,14 @@
     "webpack-profile": "yarn -s webpack --profile --json > stats.json"
   },
   "jest": {
+    "collectCoverageFrom": [
+      "tests/js/spec/**/*.{js,jsx}",
+      "src/sentry/static/sentry/app/**/*.{js,jsx}"
+    ],
+    "coverageReporters": [
+      "lcov",
+      "cobertura"
+    ],
     "snapshotSerializers": [
       "enzyme-to-json/serializer"
     ],
@@ -121,6 +130,9 @@
       "<rootDir>/tests/js/setup.js"
     ],
     "setupTestFrameworkScriptFile": "<rootDir>/tests/js/setupFramework.js",
+    "testMatch": [
+      "<rootDir>/tests/js/**/?(*.)(spec|test).js?(x)"
+    ],
     "testPathIgnorePatterns": [
       "<rootDir>/tests/sentry/lang/javascript/"
     ],
@@ -148,6 +160,7 @@
     "eslint-plugin-react": "7.4.0",
     "jest": "22.1.2",
     "jest-glamor-react": "^3.1.2",
+    "jest-junit": "^3.4.1",
     "prettier": "1.7.4",
     "react-test-renderer": "15.6.2",
     "sinon": "1.17.2",
diff --git a/scripts/test.js b/scripts/test.js
new file mode 100644
index 0000000000..cc424cd814
--- /dev/null
+++ b/scripts/test.js
@@ -0,0 +1,24 @@
+'use strict';
+
+// Do this as the first thing so that any code reading it knows the right env.
+// process.env.BABEL_ENV = 'test';
+process.env.NODE_ENV = 'test';
+process.env.PUBLIC_URL = '';
+process.env.TZ = 'America/New_York';
+
+// Makes the script crash on unhandled rejections instead of silently
+// ignoring them. In the future, promise rejections that are not handled will
+// terminate the Node.js process with a non-zero exit code.
+process.on('unhandledRejection', err => {
+  throw err;
+});
+
+const jest = require('jest');
+const argv = process.argv.slice(2);
+
+// Watch unless on CI or in coverage mode
+if (!process.env.CI && argv.indexOf('--coverage') < 0) {
+  argv.push('--watch');
+}
+
+jest.run(argv);
diff --git a/webpack.config.js b/webpack.config.js
index 478b0d2253..fb0ad5ba52 100644
--- a/webpack.config.js
+++ b/webpack.config.js
@@ -15,7 +15,7 @@ if (process.env.SENTRY_STATIC_DIST_PATH) {
 }
 
 var IS_PRODUCTION = process.env.NODE_ENV === 'production';
-var IS_TEST = process.env.NODE_ENV === 'TEST' || process.env.TEST_SUITE;
+var IS_TEST = process.env.NODE_ENV === 'test' || process.env.TEST_SUITE;
 var WEBPACK_DEV_PORT = process.env.WEBPACK_DEV_PORT;
 var SENTRY_DEVSERVER_PORT = process.env.SENTRY_DEVSERVER_PORT;
 var USE_HOT_MODULE_RELOAD = !IS_PRODUCTION && WEBPACK_DEV_PORT && SENTRY_DEVSERVER_PORT;
diff --git a/yarn.lock b/yarn.lock
index 7b68be202e..e60fa6b85a 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -5176,6 +5176,14 @@ jest-jasmine2@^22.1.2:
     jest-snapshot "^22.1.2"
     source-map-support "^0.5.0"
 
+jest-junit@^3.4.1:
+  version "3.4.1"
+  resolved "https://registry.yarnpkg.com/jest-junit/-/jest-junit-3.4.1.tgz#0f0aea65551290cabdf9a29a1681edb4eba418c5"
+  dependencies:
+    mkdirp "^0.5.1"
+    strip-ansi "^4.0.0"
+    xml "^1.0.1"
+
 jest-leak-detector@^22.1.0:
   version "22.1.0"
   resolved "https://registry.yarnpkg.com/jest-leak-detector/-/jest-leak-detector-22.1.0.tgz#08376644cee07103da069baac19adb0299b772c2"
@@ -9543,6 +9551,10 @@ xml-name-validator@^2.0.1:
   version "2.0.1"
   resolved "https://registry.yarnpkg.com/xml-name-validator/-/xml-name-validator-2.0.1.tgz#4d8b8f1eccd3419aa362061becef515e1e559635"
 
+xml@^1.0.1:
+  version "1.0.1"
+  resolved "https://registry.yarnpkg.com/xml/-/xml-1.0.1.tgz#78ba72020029c5bc87b8a81a3cfcd74b4a2fc1e5"
+
 xtend@^4.0.0:
   version "4.0.1"
   resolved "https://registry.yarnpkg.com/xtend/-/xtend-4.0.1.tgz#a5c6d532be656e23db820efb943a1f04998d63af"
