commit c5ed5cc832758a01c83ec46403b6dad0fdcffe54
Author: William Mak <william@wmak.io>
Date:   Tue May 26 18:17:38 2020 -0400

    fix(discover): Allowing function style aggregates
    
    - This fixes an issue where `apdex(400):0` would become interpreted as
      `apdex(300)(400):0` instead, since the old function `apdex` would be
      found in the query and replaced

diff --git a/src/sentry/snuba/discover.py b/src/sentry/snuba/discover.py
index 298a99f17f..e2b923d5a6 100644
--- a/src/sentry/snuba/discover.py
+++ b/src/sentry/snuba/discover.py
@@ -525,7 +525,7 @@ def transform_deprecated_functions_in_query(query):
         if old_function + "()" in query:
             replacement = OLD_FUNCTIONS_TO_NEW[old_function]
             query = query.replace(old_function + "()", replacement)
-        elif old_function in query:
+        elif old_function + ":" in query:
             replacement = OLD_FUNCTIONS_TO_NEW[old_function]
             query = query.replace(old_function, replacement)
 
diff --git a/tests/snuba/api/endpoints/test_organization_events_v2.py b/tests/snuba/api/endpoints/test_organization_events_v2.py
index dfdc6e5310..7f9402b084 100644
--- a/tests/snuba/api/endpoints/test_organization_events_v2.py
+++ b/tests/snuba/api/endpoints/test_organization_events_v2.py
@@ -2055,6 +2055,23 @@ class OrganizationEventsV2EndpointTest(APITestCase, SnubaTestCase):
             assert data[0]["avg_transaction_duration"] == 5000
             assert data[0]["sum_transaction_duration"] == 10000
 
+        with self.feature(
+            {"organizations:discover-basic": True, "organizations:global-views": True}
+        ):
+            response = self.client.get(
+                self.url,
+                format="json",
+                data={
+                    "field": ["event.type", "apdex(400)"],
+                    "query": "event.type:transaction apdex(400):0",
+                },
+            )
+
+            assert response.status_code == 200, response.content
+            data = response.data["data"]
+            assert len(data) == 1
+            assert data[0]["apdex_400"] == 0
+
     def test_functions_in_orderby(self):
         self.login_as(user=self.user)
 
