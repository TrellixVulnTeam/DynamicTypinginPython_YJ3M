commit fdb206f8919b028cb887d17bebc4e588df2ee0a5
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Sep 24 21:29:46 2010 -0700

    Improve checksum to exclude the actual message itself

diff --git a/runtests.py b/runtests.py
index f3c42a5fb1..06bdae7134 100644
--- a/runtests.py
+++ b/runtests.py
@@ -43,6 +43,7 @@ if not settings.configured:
         BROKER_PASSWORD="guest",
         BROKER_VHOST="/",
         CELERY_ALWAYS_EAGER=True,
+        SENTRY_THRASHING_LIMIT=0,
     )
     import djcelery
     djcelery.setup_loader()
diff --git a/sentry/helpers.py b/sentry/helpers.py
index 80188cb3df..c80c3ca9c5 100644
--- a/sentry/helpers.py
+++ b/sentry/helpers.py
@@ -37,6 +37,8 @@ def get_db_engine(alias='default'):
 def construct_checksum(level=logging.ERROR, class_name='', traceback='', message='', **kwargs):
     checksum = md5_constructor(str(level))
     checksum.update(class_name or '')
+    if traceback:
+        traceback = '\n'.join(traceback.split('\n')[:-3])
     message = traceback or message
     if isinstance(message, unicode):
         message = message.encode('utf-8', 'replace')
diff --git a/sentry/tests/tests.py b/sentry/tests/tests.py
index 13ff8f3dd2..909233e05b 100644
--- a/sentry/tests/tests.py
+++ b/sentry/tests/tests.py
@@ -425,8 +425,8 @@ class SentryTestCase(TestCase):
     def testViewException(self):
         self.assertRaises(Exception, self.client.get, reverse('sentry-raise-exc'))
         
-        self.assertEquals(Message.objects.count(), 1)
         self.assertEquals(GroupedMessage.objects.count(), 1)
+        self.assertEquals(Message.objects.count(), 1)
         last = Message.objects.get()
         self.assertEquals(last.logger, 'root')
         self.assertEquals(last.class_name, 'Exception')
@@ -539,6 +539,13 @@ class SentryTestCase(TestCase):
         
         settings.EXCLUDE_PATHS = []
 
+    def testVaryingMessages(self):
+        self.assertRaises(Exception, self.client.get, reverse('sentry-raise-exc') + '?message=foo')
+        self.assertRaises(Exception, self.client.get, reverse('sentry-raise-exc') + '?message=bar')
+        self.assertRaises(Exception, self.client.get, reverse('sentry-raise-exc') + '?message=gra')
+
+        self.assertEquals(GroupedMessage.objects.count(), 1)
+
 class SentryViewsTest(TestCase):
     urls = 'sentry.tests.urls'
     fixtures = ['sentry/tests/fixtures/views.json']
diff --git a/sentry/tests/views.py b/sentry/tests/views.py
index 1876810758..ae5c01ed0b 100644
--- a/sentry/tests/views.py
+++ b/sentry/tests/views.py
@@ -1,5 +1,5 @@
 def raise_exc(request):
-    raise Exception('view exception')
+    raise Exception(request.GET.get('message', 'view exception'))
 
 def decorated_raise_exc(request):
     return raise_exc(request)
\ No newline at end of file
