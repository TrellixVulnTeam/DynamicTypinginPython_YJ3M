commit db52005ae8afd13208ba5e3c25c45b4eca27dd8e
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Mon May 6 16:17:21 2019 +0200

    fix: Add event size metric with event_id (#13062)
    
    * fix: Add event size metric with event_id
    
    * fix: Dont require event id and project id in event payload

diff --git a/src/sentry/eventstream/kafka/protocol.py b/src/sentry/eventstream/kafka/protocol.py
index 916a5400e0..2842a19614 100644
--- a/src/sentry/eventstream/kafka/protocol.py
+++ b/src/sentry/eventstream/kafka/protocol.py
@@ -6,6 +6,7 @@ from datetime import datetime
 
 from sentry.models import Event, EventDict
 from sentry.utils import json, metrics
+from sentry.utils.safe import get_path
 
 
 logger = logging.getLogger(__name__)
@@ -104,6 +105,16 @@ def get_task_kwargs_for_message(value):
     metrics.timing('evenstream.events.size.data', len(value))
     payload = json.loads(value)
 
+    event_id = get_path(payload, 2, 'event_id')
+    project_id = get_path(payload, 2, 'project_id')
+    metrics.incr(
+        'evenstream.events.size.data.mb_bucket.%s' % (len(value) // (10 ** 6),),
+        tags={
+            'project_id': project_id or 'None',
+            'event': '%s,%s' % (project_id, event_id)
+        }
+    )
+
     try:
         version = payload[0]
     except Exception:
