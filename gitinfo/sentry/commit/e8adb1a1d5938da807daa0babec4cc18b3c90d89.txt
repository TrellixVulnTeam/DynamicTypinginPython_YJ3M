commit e8adb1a1d5938da807daa0babec4cc18b3c90d89
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Tue Jan 2 10:41:27 2018 -0800

    feat: Better values for user notifications, apply defaults (#6827)

diff --git a/src/sentry/api/endpoints/user_notification_details.py b/src/sentry/api/endpoints/user_notification_details.py
index 4a4850fb20..929a41b299 100644
--- a/src/sentry/api/endpoints/user_notification_details.py
+++ b/src/sentry/api/endpoints/user_notification_details.py
@@ -3,12 +3,20 @@ from __future__ import absolute_import
 from collections import defaultdict
 
 from sentry.api.bases.user import UserEndpoint
-from sentry.models import UserOption
+from sentry.models import UserOption, UserOptionValue
 
 from sentry.api.serializers import serialize, Serializer
 
 from rest_framework.response import Response
 
+USER_OPTION_DEFAULTS = {
+    'deploy-emails': UserOptionValue.committed_deploys_only,  # '3'
+    'self_notifications': UserOptionValue.all_conversations,  # '0'
+    'self_assign_issue': UserOptionValue.all_conversations,  # '0'
+    'subscribe_by_default': UserOptionValue.participating_only,  # '1'
+    'workflow:notifications': UserOptionValue.all_conversations,  # '0
+}
+
 
 class UserNotificationsSerializer(Serializer):
     def get_attrs(self, item_list, user, *args, **kwargs):
@@ -24,16 +32,20 @@ class UserNotificationsSerializer(Serializer):
         return results
 
     def serialize(self, obj, attrs, user, *args, **kwargs):
-        data = {option.key: option.value for option in attrs}
 
+        raw_data = {option.key: option.value for option in attrs}
+
+        data = {}
+        for key in USER_OPTION_DEFAULTS:
+            data[key] = raw_data.get(key, USER_OPTION_DEFAULTS[key])
+
+        # for the boolean values, '1' is true, '0' is false
         return {
-            'alertEmail': data.get('alert_email'),
-            'deployEmails': data.get('deploy-emails'),
-            'seenReleaseBroadcast': data.get('seen_release_broadcast'),
-            'selfAssignIssue': data.get('self_assign_issue'),
-            'selfNotifications': data.get('self_notifications'),
-            'subscribeByDefault': data.get('subscribe_by_default'),
-            'workflowNotifications': data.get('workflow:notifications'),
+            'deployNotifications': int(data.get('deploy-emails')),
+            'personalActivityNotifications': bool(int(data.get('self_notifications'))),
+            'selfAssignOnResolve': bool(int(data.get('self_assign_issue'))),
+            'subscribeByDefault': bool(int(data.get('subscribe_by_default'))),
+            'workflowNotifications': int(data.get('workflow:notifications'))
         }
 
 
diff --git a/tests/sentry/api/endpoints/test_user_notifications.py b/tests/sentry/api/endpoints/test_user_notification_details.py
similarity index 68%
rename from tests/sentry/api/endpoints/test_user_notifications.py
rename to tests/sentry/api/endpoints/test_user_notification_details.py
index 08963d4224..c1995ca0ba 100644
--- a/tests/sentry/api/endpoints/test_user_notifications.py
+++ b/tests/sentry/api/endpoints/test_user_notification_details.py
@@ -50,3 +50,21 @@ class UserListTest(APITestCase):
         resp = self.client.get(url, format='json')
 
         assert resp.status_code == 200
+
+    def test_returns_correct_defaults(self):
+        user = self.create_user(email='a@example.com')
+
+        self.login_as(user=user)
+
+        url = reverse(
+            'sentry-api-0-user-notifications', kwargs={
+                'user_id': 'me',
+            }
+        )
+        resp = self.client.get(url, format='json')
+
+        assert resp.data.get('deployNotifications') == 3
+        assert resp.data.get('personalActivityNotifications') is False
+        assert resp.data.get('selfAssignOnResolve') is False
+        assert resp.data.get('subscribeByDefault') is True
+        assert resp.data.get('workflowNotifications') == 0
