commit 1e55adbf6088893de60769705c3bc79959a9bd4e
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Apr 5 01:23:10 2012 -0700

    Projects and teams are now much more cohesive

diff --git a/sentry/conf/defaults.py b/sentry/conf/defaults.py
index 3661112a60..5ad9d6dc89 100644
--- a/sentry/conf/defaults.py
+++ b/sentry/conf/defaults.py
@@ -120,6 +120,10 @@ VIEWS = (
 # to create new projects
 ALLOW_PROJECT_CREATION = False
 
+# Should users without 'sentry.add_team' permissions be allowed
+# to create new projects
+ALLOW_TEAM_CREATION = False
+
 # Should users without superuser permissions be allowed to
 # make projects public
 ALLOW_PUBLIC_PROJECTS = True
diff --git a/sentry/permissions.py b/sentry/permissions.py
index 14f54a7d4d..92c961fcb8 100644
--- a/sentry/permissions.py
+++ b/sentry/permissions.py
@@ -29,6 +29,26 @@ def can_create_projects(user):
     return True
 
 
+def can_create_teams(user):
+    """
+    Returns a boolean describing whether a user has the ability to
+    create new projects.
+    """
+    if not (user and user.is_authenticated()):
+        return False
+
+    if user.has_perm('sentry.can_add_team'):
+        return True
+
+    result = plugins.first('has_perm', user, 'add_team')
+    if result is None:
+        result = settings.ALLOW_TEAM_CREATION
+
+    if result is False:
+        return result
+    return True
+
+
 def can_set_public_projects(user):
     """
     Returns a boolean describing whether a user has the ability to
diff --git a/sentry/templates/sentry/header.html b/sentry/templates/sentry/header.html
index 5273eebc7c..a9ffa70999 100644
--- a/sentry/templates/sentry/header.html
+++ b/sentry/templates/sentry/header.html
@@ -48,8 +48,8 @@
                                 <a href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Account" %} <span class="caret"></span></a>
                                 <ul class="dropdown-menu">
                                     <li><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
+                                    <li><a href="{% url sentry-team-list %}">{% trans "Teams" %}</a></li>
                                     {% if request.user.is_staff %}
-                                        <li class="divider"></li>
                                         <li><a href="{% url sentry-admin-status %}">{% trans "Admin" %}</a></li>
                                     {% endif %}
                                     <li class="divider"></li>
diff --git a/sentry/templates/sentry/layout.html b/sentry/templates/sentry/layout.html
index df620508dc..ca2ca09ebd 100644
--- a/sentry/templates/sentry/layout.html
+++ b/sentry/templates/sentry/layout.html
@@ -76,12 +76,6 @@
 
                         <div class="sidebar">
                             {% block sidebar %}
-                                <h6>{% trans "Your Projects" %}</h6>
-                                <ul class="nav nav-tabs nav-stacked">
-                                    {% for p in PROJECT_LIST %}
-                                        <li{% if p == project %} class="active"{% endif %}><a href="{% url sentry-manage-project p.pk %}">{{ p.name }}</a></li>
-                                    {% endfor %}
-                                </ul>
                             {% endblock %}
                         </div>
                     {% endblock %}
diff --git a/sentry/templates/sentry/partial/_account_sidebar.html b/sentry/templates/sentry/partial/_account_sidebar.html
index a1f51e9016..230082989a 100644
--- a/sentry/templates/sentry/partial/_account_sidebar.html
+++ b/sentry/templates/sentry/partial/_account_sidebar.html
@@ -4,14 +4,41 @@
 <ul class="nav nav-tabs nav-stacked">
     <li{% if page == 'settings' %} class="active"{% endif %}><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
 </ul>
-<a href="{% url sentry-create-new-team %}" class="pull-right"><small>{% trans "New team" %}</small></a>
+
+<h6>{% trans "Projects" %}</h6>
+{% if PROJECT_LIST %}
+    <ul class="nav nav-tabs nav-stacked" style="margin-bottom:5px">
+        {% for p in PROJECT_LIST|slice:"10" %}
+            <li{% if p == project %} class="active"{% endif %}><a href="{% url sentry-manage-project p.pk %}">{{ p.name }}</a></li>
+        {% endfor %}
+    </ul>
+    <div style="text-align:right">
+        {% if can_create_projects %}
+            <a href="{% url sentry-new-project %}" class="btn btn-small">{% trans "New project" %}</a>
+        {% endif %}
+        {% if PROJECT_LIST|length > 10 %}
+            <a href="{% url sentry-project-list %}" class="btn btn-small">{% blocktrans with PROJECT_LIST|length as count %}View all <strong>{{ count }}</strong> projects{% endblocktrans %}</a>
+        {% endif %}
+    </div>
+{% else %}
+    <p>{% trans "You are not a part of any projects." %}</p>
+{% endif %}
+
 <h6>{% trans "Teams" %}</h6>
-{% if TEAMS %}
-    <ul class="nav nav-tabs nav-stacked">
-        {% for t in TEAMS %}
+{% if TEAM_LIST %}
+    <ul class="nav nav-tabs nav-stacked" style="margin-bottom:5px">
+        {% for t in TEAM_LIST|slice:"10" %}
             <li{% if team and team == t %} class="active"{% endif %}><a href="{% url sentry-manage-team t.slug %}">{{ t.name }}</a></li>
         {% endfor %}
     </ul>
+    <div style="text-align:right">
+        {% if can_create_teams %}
+            <a href="{% url sentry-new-team %}" class="btn btn-small">{% trans "New team" %}</a>
+        {% endif %}
+        {% if TEAM_LIST|length > 10 %}
+            <a href="{% url sentry-team-list %}" class="btn btn-small">{% blocktrans with TEAM_LIST|length as count %}View all <strong>{{ count }}</strong> teams{% endblocktrans %}</a>
+        {% endif %}
+    </div>
 {% else %}
     <p>{% trans "You are not a part of any teams." %}</p>
-{% endif %}
\ No newline at end of file
+{% endif %}
diff --git a/sentry/templates/sentry/projects/base.html b/sentry/templates/sentry/projects/base.html
new file mode 100644
index 0000000000..4ae0ac67ba
--- /dev/null
+++ b/sentry/templates/sentry/projects/base.html
@@ -0,0 +1,71 @@
+{% extends "sentry/layout.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Project List" %} | {{ block.super }}{% endblock %}
+
+{% block page_header %}
+    {% if can_create_projects %}
+        <a href="{% url sentry-new-project %}" class="btn pull-right btn-primary">{% trans "Create a new project" %}</a>
+    {% endif %}
+    {{ block.super }}
+{% endblock %}
+
+{% block heading %}
+    {% trans "Project List" %}
+{% endblock %}
+
+{% block main %}
+    <section class="body">
+        {% if PROJECT_LIST %}
+            <p>{% trans "The following is a list of projects that you are a member of." %}</p>
+            <table class="table table-bordered table-striped">
+                <colgroup>
+                    <col>
+                    <col style="width:100px;">
+                    <col style="width:150px;">
+                    <col style="width:100px;">
+                </colgroup>
+                <thead>
+                    <tr>
+                        <th>{% trans "Name" %}</th>
+                        <th style="text-align:center;">{% trans "Membership" %}</th>
+                        <th style="text-align:center;">{% trans "Owner" %}</th>
+                        <th style="text-align:center;">{% trans "Status" %}</th>
+                    </tr>
+                </thead>
+                <tbody>
+                    {% for project in PROJECT_LIST %}
+                        <tr>
+                            <td>
+                                <a href="{% url sentry-manage-project project.pk %}">{{ project.name }}</a><br/>
+                                {% if project.member_dsn %}
+                                    <small><code class="clippy">{{ project.member_dsn }}</code></small>
+                                {% endif %}
+                            </td>
+                            <td style="text-align:center;vertical-align:middle;">{{ project.member_type }}</td>
+                            <td style="text-align:center;vertical-align:middle;">
+                                {% if project.owner %}
+                                    {{ project.owner.username }}
+                                {% else %}
+                                    <em>{% trans "no owner" %}</em>
+                                {% endif %}
+                            </td>
+                            <td style="text-align:center;vertical-align:middle;">{{ project.get_status_display }}</td>
+                        </tr>
+                    {% endfor %}
+                </tbody>
+            </table>
+        {% else %}
+            {% if can_create_projects %}
+                <div class="alert alert-info">You do not have access to any projects. Would you like to <a href="{% url sentry-new-project %}">create a new project</a>?</div>
+            {% else %}
+                <div class="alert alert-notice">{% trans "You do not have access to any projects. Ask an administrator to add you as a member." %}</div>
+            {% endif %}
+        {% endif %}
+    </section>
+{% endblock %}
+
+{% block sidebar %}
+    {% include "sentry/partial/_account_sidebar.html" %}
+{% endblock %}
diff --git a/sentry/templates/sentry/projects/list.html b/sentry/templates/sentry/projects/list.html
index 490aebdb3c..c4011f2e6a 100644
--- a/sentry/templates/sentry/projects/list.html
+++ b/sentry/templates/sentry/projects/list.html
@@ -1,23 +1,14 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/projects/base.html" %}
 
 {% load i18n %}
 
 {% block title %}{% trans "Project List" %} | {{ block.super }}{% endblock %}
 
-{% block bodyclass %}{% endblock %}
-
-{% block page_header %}
-    {% if can_create_projects %}
-        <a href="{% url sentry-new-project %}" class="btn pull-right btn-primary">{% trans "Create a new project" %}</a>
-    {% endif %}
-    {{ block.super }}
-{% endblock %}
-
 {% block heading %}
     {% trans "Project List" %}
 {% endblock %}
 
-{% block content %}
+{% block main %}
     <section class="body">
         {% if PROJECT_LIST %}
             <p>{% trans "The following is a list of projects that you are a member of." %}</p>
diff --git a/sentry/templates/sentry/projects/manage.html b/sentry/templates/sentry/projects/manage.html
index 20c8193dfa..0497e3093c 100644
--- a/sentry/templates/sentry/projects/manage.html
+++ b/sentry/templates/sentry/projects/manage.html
@@ -1,4 +1,4 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/projects/base.html" %}
 
 {% load i18n %}
 {% load sentry_helpers %}
diff --git a/sentry/templates/sentry/projects/members/new.html b/sentry/templates/sentry/projects/members/new.html
deleted file mode 100644
index b0ae26adde..0000000000
--- a/sentry/templates/sentry/projects/members/new.html
+++ /dev/null
@@ -1,35 +0,0 @@
-{% extends "sentry/teams/manage.html" %}
-
-{% load i18n %}
-
-{% block title %}{% trans "New Member" %} | {{ block.super }}{% endblock %}
-
-{% block breadcrumb %}
-    {{ block.super }}
-    <li class="divider">/</li>
-    <li><a href="{% url sentry-new-team-member project.pk %}">{% trans "New Member" %}</a></li>
-{% endblock %}
-
-{% block main %}
-    <section class="body">
-        <ul class="nav nav-tabs">
-{#             <li class="active"><a href="#invite" data-toggle="tab">{% trans "Invite a new user" %}</a></li> #}
-            <li class="active"><a href="#add" data-toggle="tab">{% trans "Add an existing user" %}</a></li>
-        </ul>
-        <div class="tab-content">
-            <div class="tab-pane" id="invite">
-                <p>{% trans "Invite a member to join this project via their email address. If they do not already have an
-                    account they will first be asked to create one." %}</p>
-                {% with invite_form as form %}
-                    {% include "sentry/partial/_form.html" %}
-                {% endwith %}
-            </div>
-            <div class="tab-paneactive" id="add">
-                <p>{% trans "You may add a user by their username if they already have an account." %}</p>
-                {% with add_form as form %}
-                    {% include "sentry/partial/_form.html" %}
-                {% endwith %}
-            </div>
-        </div>
-    </section>
-{% endblock %}
diff --git a/sentry/templates/sentry/teams/base.html b/sentry/templates/sentry/teams/base.html
new file mode 100644
index 0000000000..0cb920c6eb
--- /dev/null
+++ b/sentry/templates/sentry/teams/base.html
@@ -0,0 +1,31 @@
+{% extends "sentry/layout.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Team List" %} | {{ block.super }}{% endblock %}
+
+{% block page_header %}
+    {% if can_create_projects %}
+        <a href="{% url sentry-new-team %}" class="btn pull-right btn-primary">{% trans "Create a new team" %}</a>
+    {% endif %}
+
+    <ul class="breadcrumb">
+        <li><a href="{% url sentry-team-list %}">{% trans "Teams" %}</a></li>
+        {% block breadcrumb %}
+        {% endblock %}
+    </ul>
+{% endblock %}
+
+{% block heading %}
+    {% trans "Team List" %}
+{% endblock %}
+
+{% block main %}
+    <section class="body">
+        {% block inner %}{% endblock %}
+    </section>
+{% endblock %}
+
+{% block sidebar %}
+    {% include "sentry/partial/_account_sidebar.html" %}
+{% endblock %}
diff --git a/sentry/templates/sentry/teams/list.html b/sentry/templates/sentry/teams/list.html
new file mode 100644
index 0000000000..e89b54b8a3
--- /dev/null
+++ b/sentry/templates/sentry/teams/list.html
@@ -0,0 +1,46 @@
+{% extends "sentry/teams/base.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Team List" %} | {{ block.super }}{% endblock %}
+
+{% block heading %}
+    {% trans "Team List" %}
+{% endblock %}
+
+{% block inner %}
+    {% if TEAM_LIST %}
+        <p>{% trans "The following is a list of teams that you are a member of." %}</p>
+        <table class="table table-bordered table-striped">
+            <colgroup>
+                <col>
+                <col style="width:100px;">
+                <col style="width:150px;">
+            </colgroup>
+            <thead>
+                <tr>
+                    <th>{% trans "Name" %}</th>
+                    <th style="text-align:center;">{% trans "Owner" %}</th>
+                </tr>
+            </thead>
+            <tbody>
+                {% for team in TEAM_LIST %}
+                    <tr>
+                        <td>
+                            <a href="{% url sentry-manage-team team.slug %}">{{ team.name }}</a><br/>
+                        </td>
+                        <td style="text-align:center;vertical-align:middle;">
+                            {{ team.owner.username }}
+                        </td>
+                    </tr>
+                {% endfor %}
+            </tbody>
+        </table>
+    {% else %}
+        {% if can_create_teams %}
+            <div class="alert alert-info">You are not a member of any teams. Would you like to <a href="{% url sentry-new-team %}">create a new team</a>?</div>
+        {% else %}
+            <div class="alert alert-notice">{% trans "You are not a member of any teams. Ask an administrator to add you to a team." %}</div>
+        {% endif %}
+    {% endif %}
+{% endblock %}
diff --git a/sentry/templates/sentry/teams/manage.html b/sentry/templates/sentry/teams/manage.html
index f3f75faab9..e2562518c7 100644
--- a/sentry/templates/sentry/teams/manage.html
+++ b/sentry/templates/sentry/teams/manage.html
@@ -1,4 +1,4 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/teams/list.html" %}
 
 {% load i18n %}
 {% load sentry_helpers %}
@@ -6,14 +6,9 @@
 
 {% block title %}{% blocktrans with team.name as name %}Manage Team: {{ name }}{% endblocktrans %} | {{ block.super }}{% endblock %}
 
-{% block page_header %}
-    <ul class="breadcrumb">
-        <li><a href="#">{% trans "Teams" %}</a></li>
-        {% block breadcrumb %}
-            <li class="divider">/</li>
-            <li><a href="{% url sentry-manage-team team.slug %}">{{ team.name }}</a></li>
-        {% endblock %}
-    </ul>
+{% block breadcrumb %}
+    <li class="divider">/</li>
+    <li><a href="{% url sentry-manage-team team.slug %}">{{ team.name }}</a></li>
 {% endblock %}
 
 {% block main %}
@@ -139,7 +134,3 @@
         {% endblock %}
     </section>
 {% endblock %}
-
-{% block sidebar %}
-    {% include "sentry/partial/_account_sidebar.html" %}
-{% endblock %}
diff --git a/sentry/templates/sentry/teams/new.html b/sentry/templates/sentry/teams/new.html
index 0c29c8cf2b..9317b52431 100644
--- a/sentry/templates/sentry/teams/new.html
+++ b/sentry/templates/sentry/teams/new.html
@@ -1,17 +1,12 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/teams/base.html" %}
 
 {% load i18n %}
 
 {% block title %}{% trans "New Team" %} | {{ block.super }}{% endblock %}
 
-{% block page_header %}
-    <ul class="breadcrumb">
-        <li><a href="#">{% trans "Teams" %}</a></li>
-        {% block breadcrumb %}
-            <li class="divider">/</li>
-            <li><a href="{% url sentry-new-project %}">{% trans "New Team" %}</a></li>
-        {% endblock %}
-    </ul>
+{% block breadcrumb %}
+    <li class="divider">/</li>
+    <li><a href="{% url sentry-new-project %}">{% trans "New Team" %}</a></li>
 {% endblock %}
 
 {% block main %}
@@ -32,7 +27,3 @@
         </form>
     </section>
 {% endblock %}
-
-{% block sidebar %}
-    {% include "sentry/partial/_account_sidebar.html" %}
-{% endblock %}
\ No newline at end of file
diff --git a/sentry/web/frontend/teams.py b/sentry/web/frontend/teams.py
index bdab40a183..38202cbf51 100644
--- a/sentry/web/frontend/teams.py
+++ b/sentry/web/frontend/teams.py
@@ -27,6 +27,11 @@ def _can_add_team_member(user, team):
     return True
 
 
+@login_required
+def team_list(request):
+    return render_to_response('sentry/teams/list.html', {}, request)
+
+
 @login_required
 @csrf_protect
 def create_new_team(request):
diff --git a/sentry/web/helpers.py b/sentry/web/helpers.py
index 2359960ad4..3d1570accc 100644
--- a/sentry/web/helpers.py
+++ b/sentry/web/helpers.py
@@ -18,7 +18,7 @@ from django.utils.safestring import mark_safe
 from sentry.conf import settings
 from sentry.models import Project, View, \
   MEMBER_USER, Option, ProjectOption, Team
-from sentry.permissions import can_create_projects
+from sentry.permissions import can_create_projects, can_create_teams
 
 logger = logging.getLogger('sentry.errors')
 
@@ -116,11 +116,12 @@ def get_default_context(request, existing_context=None):
         context.update({
             'request': request,
             'can_create_projects': can_create_projects(request.user),
+            'can_create_teams': can_create_teams(request.user),
         })
         if not existing_context or 'PROJECT_LIST' not in existing_context:
             context['PROJECT_LIST'] = get_project_list(request.user).values()
-        if not existing_context or 'TEAMS' not in existing_context:
-            context['TEAMS'] = get_team_list(request.user).values()
+        if not existing_context or 'TEAM_LIST' not in existing_context:
+            context['TEAM_LIST'] = get_team_list(request.user).values()
 
     return context
 
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index 519e4c64fd..b24d3f1660 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -47,7 +47,8 @@ urlpatterns = patterns('',
 
     # Teams
 
-    url(r'^account/teams/new/$', teams.create_new_team, name='sentry-create-new-team'),
+    url(r'^account/teams/$', teams.team_list, name='sentry-team-list'),
+    url(r'^account/teams/new/$', teams.create_new_team, name='sentry-new-team'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/edit/$', teams.manage_team,
         name='sentry-manage-team'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/remove/$', teams.remove_team,
