commit 5052ed620157740e2362561cefb615fd272adc4a
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Sat May 14 15:10:38 2016 +0200

    Nuke 2fa backup interfaces when last authenticator was removed.

diff --git a/src/sentry/models/authenticator.py b/src/sentry/models/authenticator.py
index d353142b7f..0bd84937a2 100644
--- a/src/sentry/models/authenticator.py
+++ b/src/sentry/models/authenticator.py
@@ -76,6 +76,7 @@ class AuthenticatorInterface(object):
     interface_id = None
     name = None
     description = None
+    backup_interface = False
     enroll_button = _('Enroll')
     configure_button = _('Configure')
     remove_button = _('Remove')
@@ -125,6 +126,7 @@ class RecoveryCodeInterface(AuthenticatorInterface):
                     'receive two-factor authentication codes.')
     enroll_button = _('Activate')
     configure_button = _('View Codes')
+    backup_interface = True
 
     def __init__(self, authenticator=None):
         AuthenticatorInterface.__init__(self, authenticator)
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index f9bd60edc3..3715cb3d15 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -37,12 +37,33 @@ class TwoFactorSettingsView(BaseView):
         context['page'] = 'settings'
         return context
 
+    def delete_authenticator(self, interface):
+        if interface.authenticator is None:
+            return
+
+        user = interface.authenticator.user
+        interface.authenticator.delete()
+
+        # If this was an authenticator that was a backup interface we just
+        # deleted, then nothing happens.
+        if interface.backup_interface:
+            return
+
+        # If however if we delete an actual authenticator and all that
+        # remainds are backup interfaces, then we kill them in the
+        # process.
+        interfaces = Authenticator.objects.all_interfaces_for_user(user)
+        backup_interfaces = [x for x in interfaces if x.backup_interface]
+        if len(backup_interfaces) == len(interfaces):
+            for iface in backup_interfaces:
+                iface.authenticator.delete()
+
     def remove(self, request, interface):
         if 'no' in request.POST or \
            not interface.is_enrolled:
             return HttpResponseRedirect(reverse('sentry-account-settings-2fa'))
         elif 'yes' in request.POST:
-            interface.authenticator.delete()
+            self.delete_authenticator(interface)
             return HttpResponseRedirect(reverse('sentry-account-settings-2fa'))
         context = self.make_context(request, interface)
         return render_to_response('sentry/account/twofactor/remove.html',
