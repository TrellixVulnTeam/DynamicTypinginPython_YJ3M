commit 2750dd657ae773bb0e6c383c7b54221ed2c7c3e5
Author: Jess MacQueen <jess@getsentry.com>
Date:   Thu Dec 14 16:57:20 2017 -0800

    fix(projects): Create many to many relationship when changing a project's team

diff --git a/src/sentry/api/endpoints/project_details.py b/src/sentry/api/endpoints/project_details.py
index 27061f2d6a..19a6396a8a 100644
--- a/src/sentry/api/endpoints/project_details.py
+++ b/src/sentry/api/endpoints/project_details.py
@@ -20,7 +20,7 @@ from sentry.api.serializers.models.project import DetailedProjectSerializer
 from sentry.api.serializers.rest_framework import ListField, OriginField
 from sentry.models import (
     AuditLogEntryEvent, Group, GroupStatus, Project, ProjectBookmark, ProjectStatus,
-    UserOption, Team,
+    ProjectTeam, UserOption, Team,
 )
 from sentry.tasks.deletion import delete_project
 from sentry.utils.apidocs import scenario, attach_scenarios
@@ -242,6 +242,7 @@ class ProjectDetailsEndpoint(ProjectEndpoint):
             project.name = result['name']
             changed = True
 
+        old_team_id = None
         if result.get('team'):
             team_list = [
                 t for t in Team.objects.get_for_user(
@@ -257,6 +258,7 @@ class ProjectDetailsEndpoint(ProjectEndpoint):
                         'detail': ['The new team is not found.']
                     }, status=400
                 )
+            old_team_id = project.team_id
             project.team = team_list[0]
             changed = True
 
@@ -266,6 +268,11 @@ class ProjectDetailsEndpoint(ProjectEndpoint):
 
         if changed:
             project.save()
+            if old_team_id is not None:
+                ProjectTeam.objects.filter(
+                    project=project,
+                    team_id=old_team_id,
+                ).update(team=project.team)
 
         if result.get('isBookmarked'):
             try:
diff --git a/tests/sentry/api/endpoints/test_project_details.py b/tests/sentry/api/endpoints/test_project_details.py
index 57d4c4a61e..e5e30b1d59 100644
--- a/tests/sentry/api/endpoints/test_project_details.py
+++ b/tests/sentry/api/endpoints/test_project_details.py
@@ -92,6 +92,7 @@ class ProjectUpdateTest(APITestCase):
         assert resp.status_code == 200, resp.content
         project = Project.objects.get(id=project.id)
         assert project.team == team
+        assert project.teams.first() == team
 
     def test_team_changes_not_found(self):
         project = self.create_project()
