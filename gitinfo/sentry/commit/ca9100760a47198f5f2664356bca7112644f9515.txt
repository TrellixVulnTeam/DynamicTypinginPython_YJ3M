commit ca9100760a47198f5f2664356bca7112644f9515
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Wed Aug 8 15:25:07 2018 -0700

    fix(integrations): Validate integration configuration data
    
    fixes SENTRY-73N

diff --git a/src/sentry/api/endpoints/organization_integration_details.py b/src/sentry/api/endpoints/organization_integration_details.py
index ac70304f77..039b20bb80 100644
--- a/src/sentry/api/endpoints/organization_integration_details.py
+++ b/src/sentry/api/endpoints/organization_integration_details.py
@@ -6,6 +6,7 @@ from sentry.api.bases.organization import (
     OrganizationEndpoint, OrganizationIntegrationsPermission
 )
 from sentry.api.serializers import serialize
+from sentry.integrations.exceptions import IntegrationError
 from sentry.models import Integration, OrganizationIntegration, ProjectIntegration
 
 
@@ -47,6 +48,9 @@ class OrganizationIntegrationDetailsEndpoint(OrganizationEndpoint):
             raise Http404
 
         installation = integration.get_installation(organization.id)
-        installation.update_organization_config(request.DATA)
+        try:
+            installation.update_organization_config(request.DATA)
+        except IntegrationError as e:
+            return self.respond({'detail': e.message}, status=400)
 
         return self.respond(status=200)
diff --git a/src/sentry/integrations/jira/integration.py b/src/sentry/integrations/jira/integration.py
index e32672ee1b..6a4c4c73ac 100644
--- a/src/sentry/integrations/jira/integration.py
+++ b/src/sentry/integrations/jira/integration.py
@@ -148,6 +148,10 @@ class JiraIntegration(Integration, IssueSyncMixin):
         if 'sync_status_forward' in data:
             project_mappings = data.pop('sync_status_forward')
 
+            if any(not mapping['on_unresolve'] or not mapping['on_resolve']
+                    for mapping in project_mappings.values()):
+                raise IntegrationError('Resolve and unresolve status are required.')
+
             data['sync_status_forward'] = bool(project_mappings)
 
             IntegrationExternalProject.objects.filter(
diff --git a/src/sentry/integrations/vsts/integration.py b/src/sentry/integrations/vsts/integration.py
index f2f7eb7452..61b15de254 100644
--- a/src/sentry/integrations/vsts/integration.py
+++ b/src/sentry/integrations/vsts/integration.py
@@ -166,6 +166,10 @@ class VstsIntegration(Integration, RepositoryMixin, VstsIssueSync):
     def update_organization_config(self, data):
         if 'sync_status_forward' in data:
             project_ids_and_statuses = data.pop('sync_status_forward')
+            if any(not mapping['on_unresolve'] or not mapping['on_resolve']
+                    for mapping in project_ids_and_statuses.values()):
+                raise IntegrationError('Resolve and unresolve status are required.')
+
             data['sync_status_forward'] = bool(project_ids_and_statuses)
 
             IntegrationExternalProject.objects.filter(
diff --git a/tests/sentry/integrations/jira/test_integration.py b/tests/sentry/integrations/jira/test_integration.py
index f347e8997e..7609cfef34 100644
--- a/tests/sentry/integrations/jira/test_integration.py
+++ b/tests/sentry/integrations/jira/test_integration.py
@@ -5,6 +5,7 @@ import mock
 
 from django.core.urlresolvers import reverse
 
+from sentry.integrations.exceptions import IntegrationError
 from sentry.models import (
     ExternalIssue, Integration, IntegrationExternalProject, OrganizationIntegration
 )
@@ -517,6 +518,23 @@ class JiraIntegrationTest(APITestCase):
 
         installation = integration.get_installation(org.id)
 
+        # test validation
+        data = {
+            'sync_comments': True,
+            'sync_forward_assignment': True,
+            'sync_reverse_assignment': True,
+            'sync_status_reverse': True,
+            'sync_status_forward': {
+                10100: {
+                    'on_resolve': '',
+                    'on_unresolve': '3',
+                },
+            },
+        }
+
+        with self.assertRaises(IntegrationError):
+            installation.update_organization_config(data)
+
         data = {
             'sync_comments': True,
             'sync_forward_assignment': True,
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index 9aa527fb96..3c84cd6868 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 
 from sentry.identity.vsts import VSTSIdentityProvider
+from sentry.integrations.exceptions import IntegrationError
 from sentry.integrations.vsts import VstsIntegration, VstsIntegrationProvider
 from sentry.models import (
     Integration, IntegrationExternalProject, OrganizationIntegration, Repository
@@ -192,6 +193,18 @@ class VstsIntegrationTest(VstsIntegrationTestCase):
         model = Integration.objects.get(provider='vsts')
         integration = VstsIntegration(model, self.organization.id)
 
+        # test validation
+        data = {
+            'sync_status_forward': {
+                1: {
+                    'on_resolve': '',
+                    'on_unresolve': 'UnresolvedStatus1',
+                },
+            },
+        }
+        with self.assertRaises(IntegrationError):
+            integration.update_organization_config(data)
+
         data = {
             'sync_status_forward': {
                 1: {
