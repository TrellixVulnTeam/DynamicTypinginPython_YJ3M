commit ed169e9f11d8ae99d471225bfe32a894528b7bd7
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Dec 10 10:47:33 2014 -0800

    Various improvements to migrations

diff --git a/src/sentry/migrations/0132_add_default_orgs.py b/src/sentry/migrations/0132_add_default_orgs.py
index d0f5657bb1..fe8307a0ad 100644
--- a/src/sentry/migrations/0132_add_default_orgs.py
+++ b/src/sentry/migrations/0132_add_default_orgs.py
@@ -7,17 +7,20 @@ from django.db import models
 class Migration(DataMigration):
 
     def forwards(self, orm):
+        from sentry.utils.query import RangeQuerySetWrapper
+
         Organization = orm['sentry.Organization']
         Team = orm['sentry.Team']
 
         user_orgs = {}
         team_list = Team.objects.select_related('owner')
-        for team in team_list.iterator():
+        for team in RangeQuerySetWrapper(team_list):
             if team.owner not in user_orgs:
-                user_orgs[team.owner] = Organization.objects.create(
+                user_orgs[team.owner] = org = Organization.objects.create(
                     name=team.name.strip() or 'Default',
                     owner=team.owner,
                 )
+                print 'Added organization %s (%s)' % (org.name, org.slug)
 
             team.organization = user_orgs[team.owner]
             team.save()
diff --git a/src/sentry/migrations/0133_add_org_members.py b/src/sentry/migrations/0133_add_org_members.py
index c85c94da4d..cce02ada6a 100644
--- a/src/sentry/migrations/0133_add_org_members.py
+++ b/src/sentry/migrations/0133_add_org_members.py
@@ -7,12 +7,16 @@ from django.db import models
 class Migration(DataMigration):
 
     def forwards(self, orm):
+        from sentry.utils.query import RangeQuerySetWrapper
+
         OrganizationMember = orm['sentry.OrganizationMember']
         Team = orm['sentry.Team']
 
+        queryset = Team.objects.select_related('organization')
+
         existing = set()
 
-        for team in Team.objects.select_related('organization').iterator():
+        for team in RangeQuerySetWrapper(queryset):
             if team.owner_id in existing:
                 continue
 
diff --git a/src/sentry/migrations/0138_migrate_team_members.py b/src/sentry/migrations/0138_migrate_team_members.py
index d023194210..365c4c59cd 100644
--- a/src/sentry/migrations/0138_migrate_team_members.py
+++ b/src/sentry/migrations/0138_migrate_team_members.py
@@ -8,6 +8,8 @@ from django.db import models
 class Migration(DataMigration):
 
     def forwards(self, orm):
+        from sentry.utils.query import RangeQuerySetWrapper
+
         Organization = orm['sentry.Organization']
         OrganizationMember = orm['sentry.OrganizationMember']
         PendingTeamMember = orm['sentry.PendingTeamMember']
@@ -16,7 +18,7 @@ class Migration(DataMigration):
 
         teams_by_org = defaultdict(list)
 
-        for org in Organization.objects.iterator():
+        for org in RangeQuerySetWrapper(Organization.objects.all()):
             for team in Team.objects.filter(organization=org):
                 teams_by_org[org].append(team)
 
diff --git a/src/sentry/migrations/0141_fill_org_slugs.py b/src/sentry/migrations/0141_fill_org_slugs.py
index c4fb30708a..6f5e992ed9 100644
--- a/src/sentry/migrations/0141_fill_org_slugs.py
+++ b/src/sentry/migrations/0141_fill_org_slugs.py
@@ -9,10 +9,14 @@ class Migration(DataMigration):
     def forwards(self, orm):
         from sentry.constants import RESERVED_ORGANIZATION_SLUGS
         from sentry.db.models.utils import slugify_instance
+        from sentry.utils.query import RangeQuerySetWrapper
 
         Organization = orm['sentry.Organization']
 
-        for org in Organization.objects.filter(slug__isnull=True).iterator():
+        queryset = Organization.objects.filter(slug__isnull=True)
+
+        for org in RangeQuerySetWrapper(queryset):
+            print 'Updating organization', org.id
             slugify_instance(org, org.name, RESERVED_ORGANIZATION_SLUGS)
             org.save()
 
diff --git a/src/sentry/migrations/0143_fill_project_orgs.py b/src/sentry/migrations/0143_fill_project_orgs.py
index 571fa428ce..dcace38e86 100644
--- a/src/sentry/migrations/0143_fill_project_orgs.py
+++ b/src/sentry/migrations/0143_fill_project_orgs.py
@@ -9,6 +9,7 @@ class Migration(DataMigration):
     def forwards(self, orm):
         from sentry.constants import RESERVED_ORGANIZATION_SLUGS
         from sentry.db.models.utils import slugify_instance
+        from sentry.utils.query import RangeQuerySetWrapper
 
         Project = orm['sentry.Project']
 
@@ -16,7 +17,8 @@ class Migration(DataMigration):
             organization__isnull=True
         ).select_related('team', 'team__organization')
 
-        for project in queryset:
+        for project in RangeQuerySetWrapper(queryset):
+            print 'Updating project', project.id
             project.organization = project.team.organization
             # we also need to update the slug here based on the new constraints
             slugify_instance(project, project.name, (
