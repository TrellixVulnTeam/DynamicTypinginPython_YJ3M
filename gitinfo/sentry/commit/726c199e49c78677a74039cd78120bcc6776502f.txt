commit 726c199e49c78677a74039cd78120bcc6776502f
Author: Mark Story <mark@sentry.io>
Date:   Fri Mar 27 10:28:05 2020 -0400

    fix(search) Don't double wrap tags expressions. (#17948)
    
    When we get a `tags[foo]` from the user we shouldn't wrap it again.

diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index b4e416b560..c36b40a3fa 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -264,7 +264,7 @@ def get_snuba_column_name(name, dataset=Dataset.Events):
     if name in no_conversion:
         return name
 
-    if not name or QUOTED_LITERAL_RE.match(name):
+    if not name or name.startswith("tags[") or QUOTED_LITERAL_RE.match(name):
         return name
 
     return DATASETS[dataset].get(name, u"tags[{}]".format(name))
diff --git a/tests/sentry/utils/test_snuba.py b/tests/sentry/utils/test_snuba.py
index f0dcc17d6f..6d55d0147e 100644
--- a/tests/sentry/utils/test_snuba.py
+++ b/tests/sentry/utils/test_snuba.py
@@ -158,9 +158,9 @@ class SnubaUtilsTest(TestCase):
         assert get_snuba_column_name("'thing'") == "'thing'"
         assert get_snuba_column_name("id") == "event_id"
         assert get_snuba_column_name("geo.region") == "geo_region"
-        # This is odd behavior but captures what we do currently.
-        assert get_snuba_column_name("tags[sentry:user]") == "tags[tags[sentry:user]]"
+        assert get_snuba_column_name("tags[sentry:user]") == "tags[sentry:user]"
         assert get_snuba_column_name("organization") == "tags[organization]"
+        assert get_snuba_column_name("unknown-key") == "tags[unknown-key]"
 
 
 class PrepareQueryParamsTest(TestCase):
