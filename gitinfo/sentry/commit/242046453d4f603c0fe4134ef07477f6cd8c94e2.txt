commit 242046453d4f603c0fe4134ef07477f6cd8c94e2
Author: Ben Vinegar <benvinegar@users.noreply.github.com>
Date:   Thu Jun 30 15:19:10 2016 -0700

    Render "message" as final crumb when no exception (#3610)

diff --git a/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs.jsx b/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs.jsx
index 311c5c6450..a56b6fdde9 100644
--- a/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs.jsx
+++ b/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs.jsx
@@ -70,6 +70,43 @@ const BreadcrumbsInterface = React.createClass({
     }).reverse(); // un-reverse rendered result
   },
 
+  getVirtualCrumb() {
+    let evt = this.props.event;
+    let crumb;
+
+    let exception = evt.entries.find(entry => entry.type === 'exception');
+    if (exception) {
+      let {type, value, module} = exception.data.values[0];
+      crumb = {
+        type: 'error',
+        level: 'error',
+        category: moduleToCategory(module || null) || 'exception',
+        data: {
+          type: type,
+          value: value
+        }
+      };
+    } else if (evt.message) {
+      let levelTag = evt.tags.find(t => t.key === 'level');
+      let level = levelTag && levelTag.value;
+      crumb = {
+        type: 'message',
+        level: level,
+        category: 'message',
+        message: evt.message
+      };
+    }
+
+    if (crumb) {
+      Object.assign(crumb, {
+        timestamp: evt.dateCreated,
+        last: true
+      });
+    }
+
+    return crumb;
+  },
+
   render() {
     let group = this.props.group;
     let evt = this.props.event;
@@ -85,22 +122,11 @@ const BreadcrumbsInterface = React.createClass({
 
     let all = data.values;
 
-    // Add the error event as the final breadcrumb
-    // TODO: what about non-exceptions (e.g. generic messages)?
-    let exception = evt.entries.find(entry => entry.type === 'exception');
-    if (exception) {
-      let {type, value, module} = exception.data.values[0];
+    // Add the error event as the final (virtual) breadcrumb
+    let virtualCrumb = this.getVirtualCrumb();
+    if (virtualCrumb) {
       // make copy of values array / don't mutate props
-      all = all.slice(0).concat([{
-        type: 'error',
-        level: 'error',
-        category: moduleToCategory(module || null) || 'error',
-        data: {
-          type: type,
-          value: value
-        },
-        timestamp: evt.dateCreated
-      }]);
+      all = all.slice(0).concat([virtualCrumb]);
     }
 
     // cap max number of breadcrumbs to show
diff --git a/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs/breadcrumb.jsx b/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs/breadcrumb.jsx
index 385f68ee11..ffb7ec584a 100644
--- a/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs/breadcrumb.jsx
+++ b/src/sentry/static/sentry/app/components/events/interfaces/breadcrumbs/breadcrumb.jsx
@@ -18,16 +18,25 @@ const Breadcrumb = React.createClass({
 
   getClassName() {
     let {crumb} = this.props;
-    let rv = 'crumb crumb-default crumb-' + crumb.level;
+
+    // use Set to avoid duplicate crumb classes (was previously adding
+    // values like "crumb-default" as many as three times)
+    let classes = new Set(['crumb', 'crumb-default', 'crumb-' + crumb.level]);
+
     if (crumb.type !== 'default') {
-      rv += ' crumb-' + crumb.type.replace(/[\s_]+/g, '-').toLowerCase();
+      classes.add('crumb-' + crumb.type.replace(/[\s_]+/g, '-').toLowerCase());
     }
+
     // special case for 'ui.' category breadcrumbs
     // TODO: find a better way to customize UI around non-schema data
     if (crumb.category && crumb.category.slice(0, 3) === 'ui.') {
-      rv += ' crumb-user';
+      classes.add('crumb-user');
+    }
+
+    if (crumb.last) {
+      classes.add('crumb-last');
     }
-    return rv;
+    return [...classes].join(' ');
   },
 
   renderType() {
diff --git a/src/sentry/static/sentry/less/group-detail.less b/src/sentry/static/sentry/less/group-detail.less
index 88162ece85..67ef21b570 100644
--- a/src/sentry/static/sentry/less/group-detail.less
+++ b/src/sentry/static/sentry/less/group-detail.less
@@ -2112,12 +2112,12 @@ ul.crumbs {
       &:before {
         background: #F1D8D5;
       }
+    }
 
-      &:last-child {
-        &:before {
-           bottom: auto;
-           height: 20px;
-        }
+    &.crumb-last {
+      &:before {
+         bottom: auto;
+         height: 20px;
       }
     }
   }
