commit dafbd038aaf437f275b57024c8db7329d46cd14b
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Wed May 25 16:47:59 2016 -0700

    Fix SSO flow when linking to a deleted account (#3342)
    
    When a user has an SSO identity associated with an account, and this
    account becomes disabled, it becomes impossible to reassociate an
    identity with a new account.
    
    This change makes it so that a the AuthIdentity is just taken over as if
    it were being merged without prompting.

diff --git a/src/sentry/auth/helper.py b/src/sentry/auth/helper.py
index c474d4b36f..2fda982288 100644
--- a/src/sentry/auth/helper.py
+++ b/src/sentry/auth/helper.py
@@ -184,7 +184,7 @@ class AuthHelper(object):
     @transaction.atomic
     def _handle_attach_identity(self, identity, member=None):
         """
-        Given an already authenticated user, attach or re-attach and identity.
+        Given an already authenticated user, attach or re-attach an identity.
         """
         auth_provider = self.auth_provider
         request = self.request
@@ -509,12 +509,19 @@ class AuthHelper(object):
         )
         with TimedRetryPolicy(5)(lock.acquire):
             try:
-                auth_identity = AuthIdentity.objects.get(
+                auth_identity = AuthIdentity.objects.select_related('user').get(
                     auth_provider=auth_provider,
                     ident=identity['id'],
                 )
             except AuthIdentity.DoesNotExist:
                 return self._handle_unknown_identity(identity)
+
+            # If the User attached to this AuthIdentity is not active,
+            # we want to clobber the old account and take it over, rather
+            # than prompting to merge, which may be confusing.
+            if not auth_identity.user.is_active:
+                auth_identity = self._handle_attach_identity(identity)
+
             return self._handle_existing_identity(auth_identity, identity)
 
     @transaction.atomic
