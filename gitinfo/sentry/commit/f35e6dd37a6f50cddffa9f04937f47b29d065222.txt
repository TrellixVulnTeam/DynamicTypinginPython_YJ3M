commit f35e6dd37a6f50cddffa9f04937f47b29d065222
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Sep 1 23:23:26 2016 -0700

    Optimize path for ReleaseEnvironment updates

diff --git a/src/sentry/models/releaseenvironment.py b/src/sentry/models/releaseenvironment.py
index 0e90eefaa0..41401148ff 100644
--- a/src/sentry/models/releaseenvironment.py
+++ b/src/sentry/models/releaseenvironment.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 
-from django.db import models
+from datetime import timedelta
+from django.db import IntegrityError, models, transaction
 from django.utils import timezone
 
 from sentry.utils.cache import cache
@@ -39,20 +40,35 @@ class ReleaseEnvironment(Model):
 
         instance = cache.get(cache_key)
         if instance is None:
-            instance, created = cls.objects.get_or_create(
-                project_id=project.id,
-                release_id=release.id,
-                environment_id=environment.id,
-                defaults={
-                    'first_seen': datetime,
-                    'last_seen': datetime,
-                },
-            )
+            try:
+                with transaction.atomic():
+                    instance, created = cls.objects.create(
+                        release_id=release.id,
+                        project_id=project.id,
+                        environment_id=environment.id,
+                        first_seen=datetime,
+                        last_seen=datetime,
+                    ), True
+            except IntegrityError:
+                instance, created = cls.objects.get(
+                    release_id=release.id,
+                    project_id=project.id,
+                    environment_id=environment.id,
+                ), False
             cache.set(cache_key, instance, 3600)
         else:
             created = False
 
-        # TODO(dcramer): this would be good to buffer
-        if not created:
-            instance.update(last_seen=datetime)
+        # TODO(dcramer): this would be good to buffer, but until then we minimize
+        # updates to once a minute, and allow Postgres to optimistically skip
+        # it even if we can't
+        if not created and instance.last_seen < datetime - timedelta(seconds=60):
+            cls.objects.filter(
+                id=instance.id,
+                last_seen__lt=datetime - timedelta(seconds=60),
+            ).update(
+                last_seen=datetime,
+            )
+            instance.last_seen = datetime
+            cache.set(cache_key, instance, 3600)
         return instance
diff --git a/tests/sentry/models/test_releaseenvironment.py b/tests/sentry/models/test_releaseenvironment.py
index e08a555c68..4dd60584e8 100644
--- a/tests/sentry/models/test_releaseenvironment.py
+++ b/tests/sentry/models/test_releaseenvironment.py
@@ -1,5 +1,6 @@
 from __future__ import absolute_import
 
+from datetime import timedelta
 from django.utils import timezone
 
 from sentry.models import Environment, Release, ReleaseEnvironment
@@ -9,7 +10,7 @@ from sentry.testutils import TestCase
 class GetOrCreateTest(TestCase):
     def test_simple(self):
         project = self.create_project()
-        now = timezone.now()
+        datetime = timezone.now()
 
         release = Release.objects.create(
             project=project,
@@ -23,9 +24,34 @@ class GetOrCreateTest(TestCase):
             project=project,
             release=release,
             environment=env,
-            datetime=now,
+            datetime=datetime,
         )
 
         assert relenv.project_id == project.id
         assert relenv.release_id == release.id
         assert relenv.environment_id == env.id
+
+        datetime_new = datetime + timedelta(days=1)
+
+        relenv = ReleaseEnvironment.get_or_create(
+            project=project,
+            release=release,
+            environment=env,
+            datetime=datetime_new,
+        )
+
+        assert relenv.first_seen == datetime
+        assert relenv.last_seen == datetime_new
+
+        datetime_new2 = datetime_new + timedelta(seconds=1)
+
+        # this should not update immediately as the window is too close
+        relenv = ReleaseEnvironment.get_or_create(
+            project=project,
+            release=release,
+            environment=env,
+            datetime=datetime_new2,
+        )
+
+        assert relenv.first_seen == datetime
+        assert relenv.last_seen == datetime_new
