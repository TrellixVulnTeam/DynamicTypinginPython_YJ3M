commit 366219befe0e568750e45544be4b8ce105192069
Author: Colleen O'Rourke <elena.colleen@gmail.com>
Date:   Thu Sep 27 12:01:31 2018 -0700

    Ref/sentry staff audit log (#9885)
    
    * Show when a superuser has done something in the audit log

diff --git a/src/sentry/api/serializers/models/user.py b/src/sentry/api/serializers/models/user.py
index b58c14f92b..c937189c9b 100644
--- a/src/sentry/api/serializers/models/user.py
+++ b/src/sentry/api/serializers/models/user.py
@@ -75,6 +75,7 @@ class UserSerializer(Serializer):
             'lastLogin': obj.last_login,
             'has2fa': attrs['has2fa'],
             'lastActive': obj.last_active,
+            'isSuperuser': obj.is_superuser,
         }
 
         if obj == user:
diff --git a/src/sentry/static/sentry/app/views/settings/organizationAuditLog/auditLogList.jsx b/src/sentry/static/sentry/app/views/settings/organizationAuditLog/auditLogList.jsx
index e50ddaafd1..75626182b7 100644
--- a/src/sentry/static/sentry/app/views/settings/organizationAuditLog/auditLogList.jsx
+++ b/src/sentry/static/sentry/app/views/settings/organizationAuditLog/auditLogList.jsx
@@ -51,7 +51,6 @@ class AuditLogList extends React.Component {
   render() {
     let {pageLinks, entries, eventType, eventTypes, onEventSelect} = this.props;
     let hasEntries = entries && entries.length > 0;
-
     let options = [
       {value: '', label: t('Any action'), clearableVaue: false},
       ...eventTypes.map(type => ({label: type, value: type, clearableValue: false})),
@@ -102,7 +101,11 @@ class AuditLogList extends React.Component {
                         )}
                       </div>
                       <NameContainer>
-                        <Name>{entry.actor.name}</Name>
+                        <Name data-test-id="actor-name">
+                          {entry.actor.isSuperuser
+                            ? `${entry.actor.name} (Sentry Staff)`
+                            : entry.actor.name}
+                        </Name>
                         <Note>{entry.note}</Note>
                       </NameContainer>
                     </UserInfo>
diff --git a/tests/js/setup.js b/tests/js/setup.js
index cf5a91fb36..3079610645 100644
--- a/tests/js/setup.js
+++ b/tests/js/setup.js
@@ -212,49 +212,7 @@ window.TestStubs = {
       dateCreated: '2018-02-21T03:04:23.157Z',
       ipAddress: '127.0.0.1',
       id: '465',
-      actor: {
-        username: 'billy@sentry.io',
-        emails: [
-          {is_verified: true, id: '5', email: 'billy@sentry.io'},
-          {is_verified: false, id: '17', email: 'billy36@sentry.io'},
-          {is_verified: false, id: '11', email: 'awerawer@awe.com'},
-          {is_verified: false, id: '28', email: 'test@test.com'},
-          {is_verified: true, id: '10', email: 'billy2@sentry.io'},
-        ],
-        isManaged: false,
-        lastActive: '2018-02-21T17:40:31.555Z',
-        identities: [
-          {
-            name: '79684',
-            dateVerified: '2018-02-21T17:09:46.248Z',
-            provider: {id: 'github', name: 'GitHub'},
-            dateSynced: '2018-02-21T17:09:46.248Z',
-            organization: {slug: 'default', name: 'default'},
-            id: '1',
-          },
-        ],
-        id: '1',
-        isActive: true,
-        has2fa: true,
-        name: 'billy vong',
-        avatarUrl:
-          'https://secure.gravatar.com/avatar/7b544e8eb9d08ed777be5aa82121155a?s=32&d=mm',
-        dateJoined: '2018-01-10T00:19:59Z',
-        options: {
-          timezone: 'America/Los_Angeles',
-          seenReleaseBroadcast: true,
-          stacktraceOrder: -1,
-          language: 'en',
-          clock24Hours: false,
-        },
-        avatar: {
-          avatarUuid: '483ed7478a2248d59211f538c2997e0b',
-          avatarType: 'letter_avatar',
-        },
-        lastLogin: '2018-02-14T07:09:37.536Z',
-        permissions: [],
-        email: 'billy@sentry.io',
-      },
+      actor: TestStubs.User({isSuperuser: true}),
       event: 'project.edit',
     },
     {
@@ -265,49 +223,7 @@ window.TestStubs = {
       dateCreated: '2018-02-16T23:45:59.813Z',
       ipAddress: '127.0.0.1',
       id: '408',
-      actor: {
-        username: 'billy@sentry.io',
-        emails: [
-          {is_verified: true, id: '5', email: 'billy@sentry.io'},
-          {is_verified: false, id: '17', email: 'billy36@sentry.io'},
-          {is_verified: false, id: '11', email: 'awerawer@awe.com'},
-          {is_verified: false, id: '28', email: 'test@test.com'},
-          {is_verified: true, id: '10', email: 'billy2@sentry.io'},
-        ],
-        isManaged: false,
-        lastActive: '2018-02-21T17:40:31.555Z',
-        identities: [
-          {
-            name: '79684',
-            dateVerified: '2018-02-21T17:09:46.248Z',
-            provider: {id: 'github', name: 'GitHub'},
-            dateSynced: '2018-02-21T17:09:46.248Z',
-            organization: {slug: 'default', name: 'default'},
-            id: '1',
-          },
-        ],
-        id: '1',
-        isActive: true,
-        has2fa: true,
-        name: 'billy vong',
-        avatarUrl:
-          'https://secure.gravatar.com/avatar/7b544e8eb9d08ed777be5aa82121155a?s=32&d=mm',
-        dateJoined: '2018-01-10T00:19:59Z',
-        options: {
-          timezone: 'America/Los_Angeles',
-          seenReleaseBroadcast: true,
-          stacktraceOrder: -1,
-          language: 'en',
-          clock24Hours: false,
-        },
-        avatar: {
-          avatarUuid: '483ed7478a2248d59211f538c2997e0b',
-          avatarType: 'letter_avatar',
-        },
-        lastLogin: '2018-02-14T07:09:37.536Z',
-        permissions: [],
-        email: 'billy@sentry.io',
-      },
+      actor: TestStubs.User({isSuperuser: false}),
       event: 'org.edit',
     },
   ],
diff --git a/tests/js/spec/views/settings/__snapshots__/auditLogView.spec.jsx.snap b/tests/js/spec/views/settings/__snapshots__/auditLogView.spec.jsx.snap
index b0cdb870ce..6aea60bf97 100644
--- a/tests/js/spec/views/settings/__snapshots__/auditLogView.spec.jsx.snap
+++ b/tests/js/spec/views/settings/__snapshots__/auditLogView.spec.jsx.snap
@@ -9,72 +9,19 @@ exports[`OrganizationAuditLog renders 1`] = `
       Array [
         Object {
           "actor": Object {
-            "avatar": Object {
-              "avatarType": "letter_avatar",
-              "avatarUuid": "483ed7478a2248d59211f538c2997e0b",
+            "email": "foo@example.com",
+            "flags": Object {
+              "newsletter_consent_prompt": false,
             },
-            "avatarUrl": "https://secure.gravatar.com/avatar/7b544e8eb9d08ed777be5aa82121155a?s=32&d=mm",
-            "dateJoined": "2018-01-10T00:19:59Z",
-            "email": "billy@sentry.io",
-            "emails": Array [
-              Object {
-                "email": "billy@sentry.io",
-                "id": "5",
-                "is_verified": true,
-              },
-              Object {
-                "email": "billy36@sentry.io",
-                "id": "17",
-                "is_verified": false,
-              },
-              Object {
-                "email": "awerawer@awe.com",
-                "id": "11",
-                "is_verified": false,
-              },
-              Object {
-                "email": "test@test.com",
-                "id": "28",
-                "is_verified": false,
-              },
-              Object {
-                "email": "billy2@sentry.io",
-                "id": "10",
-                "is_verified": true,
-              },
-            ],
-            "has2fa": true,
+            "hasPasswordAuth": true,
             "id": "1",
-            "identities": Array [
-              Object {
-                "dateSynced": "2018-02-21T17:09:46.248Z",
-                "dateVerified": "2018-02-21T17:09:46.248Z",
-                "id": "1",
-                "name": "79684",
-                "organization": Object {
-                  "name": "default",
-                  "slug": "default",
-                },
-                "provider": Object {
-                  "id": "github",
-                  "name": "GitHub",
-                },
-              },
-            ],
-            "isActive": true,
-            "isManaged": false,
-            "lastActive": "2018-02-21T17:40:31.555Z",
-            "lastLogin": "2018-02-14T07:09:37.536Z",
-            "name": "billy vong",
+            "isAuthenticated": true,
+            "isSuperuser": true,
+            "name": "Foo Bar",
             "options": Object {
-              "clock24Hours": false,
-              "language": "en",
-              "seenReleaseBroadcast": true,
-              "stacktraceOrder": -1,
-              "timezone": "America/Los_Angeles",
+              "timezone": "UTC",
             },
-            "permissions": Array [],
-            "username": "billy@sentry.io",
+            "username": "foo@example.com",
           },
           "data": Object {
             "id": 2,
@@ -93,72 +40,19 @@ exports[`OrganizationAuditLog renders 1`] = `
         },
         Object {
           "actor": Object {
-            "avatar": Object {
-              "avatarType": "letter_avatar",
-              "avatarUuid": "483ed7478a2248d59211f538c2997e0b",
+            "email": "foo@example.com",
+            "flags": Object {
+              "newsletter_consent_prompt": false,
             },
-            "avatarUrl": "https://secure.gravatar.com/avatar/7b544e8eb9d08ed777be5aa82121155a?s=32&d=mm",
-            "dateJoined": "2018-01-10T00:19:59Z",
-            "email": "billy@sentry.io",
-            "emails": Array [
-              Object {
-                "email": "billy@sentry.io",
-                "id": "5",
-                "is_verified": true,
-              },
-              Object {
-                "email": "billy36@sentry.io",
-                "id": "17",
-                "is_verified": false,
-              },
-              Object {
-                "email": "awerawer@awe.com",
-                "id": "11",
-                "is_verified": false,
-              },
-              Object {
-                "email": "test@test.com",
-                "id": "28",
-                "is_verified": false,
-              },
-              Object {
-                "email": "billy2@sentry.io",
-                "id": "10",
-                "is_verified": true,
-              },
-            ],
-            "has2fa": true,
+            "hasPasswordAuth": true,
             "id": "1",
-            "identities": Array [
-              Object {
-                "dateSynced": "2018-02-21T17:09:46.248Z",
-                "dateVerified": "2018-02-21T17:09:46.248Z",
-                "id": "1",
-                "name": "79684",
-                "organization": Object {
-                  "name": "default",
-                  "slug": "default",
-                },
-                "provider": Object {
-                  "id": "github",
-                  "name": "GitHub",
-                },
-              },
-            ],
-            "isActive": true,
-            "isManaged": false,
-            "lastActive": "2018-02-21T17:40:31.555Z",
-            "lastLogin": "2018-02-14T07:09:37.536Z",
-            "name": "billy vong",
+            "isAuthenticated": true,
+            "isSuperuser": false,
+            "name": "Foo Bar",
             "options": Object {
-              "clock24Hours": false,
-              "language": "en",
-              "seenReleaseBroadcast": true,
-              "stacktraceOrder": -1,
-              "timezone": "America/Los_Angeles",
+              "timezone": "UTC",
             },
-            "permissions": Array [],
-            "username": "billy@sentry.io",
+            "username": "foo@example.com",
           },
           "data": Object {
             "accountRateLimit": "from 1000 to 0",
diff --git a/tests/js/spec/views/settings/auditLogView.spec.jsx b/tests/js/spec/views/settings/auditLogView.spec.jsx
index 13afebff5e..29f001956d 100644
--- a/tests/js/spec/views/settings/auditLogView.spec.jsx
+++ b/tests/js/spec/views/settings/auditLogView.spec.jsx
@@ -1,5 +1,5 @@
 import React from 'react';
-import {shallow} from 'enzyme';
+import {shallow, mount} from 'enzyme';
 
 import {Client} from 'app/api';
 import OrganizationAuditLog from 'app/views/settings/organizationAuditLog';
@@ -23,7 +23,6 @@ describe('OrganizationAuditLog', function() {
       <OrganizationAuditLog location={{query: ''}} params={{orgId: org.slug}} />,
       TestStubs.routerContext()
     );
-
     wrapper.setState({loading: false});
     wrapper.update();
     setTimeout(() => {
@@ -32,4 +31,23 @@ describe('OrganizationAuditLog', function() {
       done();
     });
   });
+
+  it('displays whether an action was done by a superuser', function() {
+    let wrapper = mount(
+      <OrganizationAuditLog location={{query: ''}} params={{orgId: org.slug}} />,
+      TestStubs.routerContext()
+    );
+    expect(
+      wrapper
+        .find('div[data-test-id="actor-name"]')
+        .at(0)
+        .text()
+    ).toEqual(expect.stringContaining('(Sentry Staff)'));
+    expect(
+      wrapper
+        .find('div[data-test-id="actor-name"]')
+        .at(1)
+        .text()
+    ).toEqual(expect.not.stringContaining('(Sentry Staff)'));
+  });
 });
diff --git a/tests/sentry/api/serializers/test_user.py b/tests/sentry/api/serializers/test_user.py
index 4b1a417221..564b541563 100644
--- a/tests/sentry/api/serializers/test_user.py
+++ b/tests/sentry/api/serializers/test_user.py
@@ -30,6 +30,7 @@ class UserSerializerTest(TestCase):
         assert len(result['emails']) == 1
         assert result['emails'][0]['email'] == user.email
         assert result['emails'][0]['is_verified']
+        assert result['isSuperuser'] is False
 
     def test_no_useremail(self):
         user = self.create_user()
@@ -40,6 +41,13 @@ class UserSerializerTest(TestCase):
         result = serialize(user)
         assert len(result['emails']) == 0
 
+    def test_is_superuser(self):
+        """Test that the user is a superuser"""
+        user = self.create_user(is_superuser=True)
+
+        result = serialize(user)
+        assert result['isSuperuser'] is True
+
 
 class DetailedUserSerializerTest(TestCase):
     def test_simple(self):
