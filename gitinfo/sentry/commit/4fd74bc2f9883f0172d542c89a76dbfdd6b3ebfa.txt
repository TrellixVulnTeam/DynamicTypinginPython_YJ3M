commit 4fd74bc2f9883f0172d542c89a76dbfdd6b3ebfa
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Wed Mar 28 22:50:36 2018 +0200

    feat: Improved session handling for account recover (#7833)

diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index 14c071d524..bfc85bd9e1 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -137,7 +137,10 @@ def recover_confirm(request, user_id, hash, mode='recover'):
                     password=form.cleaned_data['password'],
                 )
 
-                login_user(request, user)
+                # Only log the user in if there is no two-factor on the
+                # account.
+                if not Authenticator.objects.user_has_2fa(user):
+                    login_user(request, user)
 
                 password_hash.delete()
 
@@ -527,7 +530,8 @@ def show_emails(request):
             new_primary_email = UserEmail.objects.get(user=user, email__iexact=new_primary)
             if not new_primary_email.is_verified:
                 messages.add_message(
-                    request, messages.ERROR, _("Cannot make an unverified address your primary email")
+                    request, messages.ERROR, _(
+                        "Cannot make an unverified address your primary email")
                 )
                 return HttpResponseRedirect(request.path)
             # update notification settings for those set to primary email with new primary email
diff --git a/tests/sentry/web/frontend/accounts/tests.py b/tests/sentry/web/frontend/accounts/tests.py
index b43c3bfb40..f9e2239757 100644
--- a/tests/sentry/web/frontend/accounts/tests.py
+++ b/tests/sentry/web/frontend/accounts/tests.py
@@ -12,7 +12,7 @@ from exam import fixture
 from social_auth.models import UserSocialAuth
 
 from sentry.models import (
-    UserEmail, LostPasswordHash, User, UserOption
+    UserEmail, LostPasswordHash, User, UserOption, TotpInterface
 )
 from sentry.testutils import TestCase
 
@@ -382,6 +382,23 @@ class RecoverPasswordConfirmTest(TestCase):
         assert user.session_nonce != old_nonce
         assert not LostPasswordHash.objects.filter(user=user).exists()
 
+    def test_normal_signin(self):
+        resp = self.client.post(self.path, {
+            'password': 'bar',
+            'confirm_password': 'bar'
+        })
+        assert resp.status_code == 302
+        assert self.client.session.get('_auth_user_id') is not None
+
+    def test_2fa_no_signin(self):
+        TotpInterface().enroll(self.user)
+        resp = self.client.post(self.path, {
+            'password': 'bar',
+            'confirm_password': 'bar'
+        })
+        assert resp.status_code == 302
+        assert self.client.session.get('_auth_user_id') is None
+
 
 class ConfirmEmailSendTest(TestCase):
     @mock.patch('sentry.models.User.send_confirm_emails')
