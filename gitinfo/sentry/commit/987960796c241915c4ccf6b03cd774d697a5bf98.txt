commit 987960796c241915c4ccf6b03cd774d697a5bf98
Author: Dan Fuller <dfuller@sentry.io>
Date:   Tue Dec 18 10:34:05 2018 -0800

    fix(api): Fix bug in OrganizationProjectsEndpoint when authenticating via ApiKey
    
    Fixes SENTRY-8ST

diff --git a/src/sentry/api/endpoints/organization_projects.py b/src/sentry/api/endpoints/organization_projects.py
index 47e1fb723f..da904cc027 100644
--- a/src/sentry/api/endpoints/organization_projects.py
+++ b/src/sentry/api/endpoints/organization_projects.py
@@ -82,6 +82,8 @@ class OrganizationProjectsEndpoint(OrganizationEndpoint, EnvironmentMixin):
                 organization=organization,
             ).prefetch_related('teams')
 
+        order_by = ['slug']
+
         if request.user.is_authenticated():
             queryset = queryset.extra(
                 select={
@@ -93,6 +95,7 @@ class OrganizationProjectsEndpoint(OrganizationEndpoint, EnvironmentMixin):
                 },
                 select_params=(request.user.id,),
             )
+            order_by.insert(0, '-is_bookmarked')
 
         query = request.GET.get('query')
         if query:
@@ -111,7 +114,7 @@ class OrganizationProjectsEndpoint(OrganizationEndpoint, EnvironmentMixin):
         return self.paginate(
             request=request,
             queryset=queryset,
-            order_by=('-is_bookmarked', 'slug'),
+            order_by=order_by,
             on_results=lambda x: serialize(x, request.user, ProjectSummarySerializer(
                 environment_id=self._get_environment_id_from_request(
                     request,
diff --git a/tests/sentry/api/endpoints/test_organization_projects.py b/tests/sentry/api/endpoints/test_organization_projects.py
index 6d940e54c4..c3c755e32b 100644
--- a/tests/sentry/api/endpoints/test_organization_projects.py
+++ b/tests/sentry/api/endpoints/test_organization_projects.py
@@ -1,7 +1,10 @@
 from __future__ import absolute_import
 
+from base64 import b64encode
+
 from exam import fixture
 
+from sentry.models import ApiKey
 from sentry.testutils import APITestCase
 
 
@@ -105,3 +108,17 @@ class OrganizationProjectsTest(APITestCase):
         self.create_project_bookmark(projects[1], user=other_user)
         response = self.client.get(self.path)
         self.check_valid_response(response, [project for project in projects])
+
+    def test_api_key(self):
+        key = ApiKey.objects.create(
+            organization=self.org,
+            scope_list=['org:read'],
+        )
+
+        project = self.create_project(teams=[self.team])
+
+        response = self.client.get(
+            self.path,
+            HTTP_AUTHORIZATION='Basic ' + b64encode(u'{}:'.format(key.key)),
+        )
+        self.check_valid_response(response, [project])
