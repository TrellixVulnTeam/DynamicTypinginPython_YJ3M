commit 185f24991d26c2bbdcd6b819b8aa39d433d10f09
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jun 5 11:25:36 2014 -0700

    Attempt to prevent bad domains from halting workers

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index 615ceaa0e2..94fb6288da 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -15,7 +15,7 @@ import base64
 from os.path import splitext
 from collections import namedtuple
 from simplejson import JSONDecodeError
-from urlparse import urljoin, urlsplit
+from urlparse import urlparse, urljoin, urlsplit
 
 from sentry.constants import SOURCE_FETCH_TIMEOUT, MAX_CULPRIT_LENGTH
 from sentry.http import safe_urlopen
@@ -161,6 +161,13 @@ def fetch_url(url):
         hashlib.md5(url.encode('utf-8')).hexdigest(),)
     result = cache.get(cache_key)
     if result is None:
+        # lock down domains that are problematic
+        domain = urlparse(url).netloc
+        domain_key = 'source:%s' % (hashlib.md5(domain.encode('utf-8')).hexdigest(),)
+        domain_result = cache.get(domain_key)
+        if domain_result:
+            return BAD_SOURCE
+
         result = fetch_url_content(url)
         if result == BAD_SOURCE:
             timeout = 300
@@ -168,6 +175,9 @@ def fetch_url(url):
             timeout = 60
         cache.set(cache_key, result, timeout)
 
+        if result == BAD_SOURCE:
+            cache.set(domain_key, 1, timeout)
+
     if result == BAD_SOURCE:
         return result
 
