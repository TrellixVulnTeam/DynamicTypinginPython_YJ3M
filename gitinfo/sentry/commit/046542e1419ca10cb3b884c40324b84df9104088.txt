commit 046542e1419ca10cb3b884c40324b84df9104088
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Wed Mar 13 22:30:29 2019 +0100

    feat(releases): Avoid a bad left outer join on release files

diff --git a/src/sentry/api/endpoints/organization_release_files.py b/src/sentry/api/endpoints/organization_release_files.py
index e8bb573ab1..1dd872fbb7 100644
--- a/src/sentry/api/endpoints/organization_release_files.py
+++ b/src/sentry/api/endpoints/organization_release_files.py
@@ -11,12 +11,32 @@ from sentry.api.content_negotiation import ConditionalContentNegotiation
 from sentry.api.exceptions import ResourceDoesNotExist
 from sentry.api.paginator import OffsetPaginator
 from sentry.api.serializers import serialize
-from sentry.models import File, Release, ReleaseFile
+from sentry.models import File, Release, ReleaseFile, Distribution
 
 ERR_FILE_EXISTS = 'A file matching this name already exists for the given release'
 _filename_re = re.compile(r"[\n\t\r\f\v\\]")
 
 
+def load_dist(results):
+    # Dists are pretty uncommon.  In case they do appear load them now
+    # as trying to join this on the DB does terrible things with large
+    # offsets (it would otherwise generate a left outer join).
+    dists = dict.fromkeys(x.dist_id for x in results)
+    if not dists:
+        return results
+
+    for dist in Distribution.objects.filter(pk__in=dists.keys()):
+        dists[dist.id] = dist
+
+    for result in results:
+        if result.dist_id is not None:
+            dist = dists.get(result.dist_id)
+            if dist is not None:
+                result.dist = dist
+
+    return results
+
+
 class OrganizationReleaseFilesEndpoint(OrganizationReleasesBaseEndpoint):
     doc_section = DocSection.RELEASES
     content_negotiation_class = ConditionalContentNegotiation
@@ -46,14 +66,14 @@ class OrganizationReleaseFilesEndpoint(OrganizationReleasesBaseEndpoint):
 
         file_list = ReleaseFile.objects.filter(
             release=release,
-        ).select_related('file', 'dist').order_by('name')
+        ).select_related('file').order_by('name')
 
         return self.paginate(
             request=request,
             queryset=file_list,
             order_by='name',
             paginator_cls=OffsetPaginator,
-            on_results=lambda x: serialize(x, request.user),
+            on_results=lambda r: serialize(load_dist(r), request.user),
         )
 
     def post(self, request, organization, version):
diff --git a/src/sentry/api/endpoints/project_release_files.py b/src/sentry/api/endpoints/project_release_files.py
index a93f470ab2..f60cf3fc98 100644
--- a/src/sentry/api/endpoints/project_release_files.py
+++ b/src/sentry/api/endpoints/project_release_files.py
@@ -12,6 +12,7 @@ from sentry.api.content_negotiation import ConditionalContentNegotiation
 from sentry.api.exceptions import ResourceDoesNotExist
 from sentry.api.paginator import OffsetPaginator
 from sentry.api.serializers import serialize
+from sentry.api.endpoints.organization_release_files import load_dist
 from sentry.models import File, Release, ReleaseFile
 from sentry.utils.apidocs import scenario, attach_scenarios
 
@@ -80,14 +81,14 @@ class ProjectReleaseFilesEndpoint(ProjectEndpoint):
 
         file_list = ReleaseFile.objects.filter(
             release=release,
-        ).select_related('file', 'dist').order_by('name')
+        ).select_related('file').order_by('name')
 
         return self.paginate(
             request=request,
             queryset=file_list,
             order_by='name',
             paginator_cls=OffsetPaginator,
-            on_results=lambda x: serialize(x, request.user),
+            on_results=lambda r: serialize(load_dist(r), request.user),
         )
 
     @attach_scenarios([upload_file_scenario])
