commit ccb4a2cef1be854a0d41af1b33236e0bf2d71e7c
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu May 19 16:02:31 2016 +0200

    Validate system prefix in signed links

diff --git a/src/sentry/utils/linksign.py b/src/sentry/utils/linksign.py
index fc49e05971..b3a5751974 100644
--- a/src/sentry/utils/linksign.py
+++ b/src/sentry/utils/linksign.py
@@ -1,6 +1,7 @@
 from django.core import signing
 from django.core.urlresolvers import reverse
 
+from sentry import options
 from sentry.models import User
 from sentry.utils.http import absolute_uri
 from sentry.utils.numbers import base36_encode, base32_decode
@@ -25,7 +26,7 @@ def generate_signed_link(user, viewname, args=None, kwargs=None):
         user_id = user
 
     path = reverse(viewname, args=args, kwargs=kwargs)
-    item = '%s|%s' % (path, user_id)
+    item = '%s|%s|%s' % (options.get('system.url-prefix'), path, user_id)
     signature = ':'.join(get_signer().sign(item).rsplit(':', 2)[1:])
 
     return '%s?_=%s:%s' % (
@@ -43,13 +44,15 @@ def process_signature(request, max_age=60 * 60 * 24 * 2):
     if not sig or sig.count(':') < 2:
         return None
 
-    signed_data = '%s|%s' % (request.path, sig)
+    signed_data = '%s|%s|%s' % (request.build_absolute_uri('/').rstrip('/'),
+                                request.path, sig)
+    print signed_data
     try:
         data = get_signer().unsign(signed_data, max_age=max_age)
     except signing.BadSignature:
         return None
 
-    signed_path, user_id = data.rsplit('|', 1)
+    _, signed_path, user_id = data.rsplit('|', 2)
     if signed_path != request.path:
         return None
 
diff --git a/tests/sentry/utils/test_linksign.py b/tests/sentry/utils/test_linksign.py
index 32a0c2bdcc..0e1ef05395 100644
--- a/tests/sentry/utils/test_linksign.py
+++ b/tests/sentry/utils/test_linksign.py
@@ -2,26 +2,34 @@
 
 from __future__ import absolute_import
 
+from django.test.client import RequestFactory
+
 from sentry.testutils import TestCase
 from sentry.utils import linksign
-from django.test.client import RequestFactory
 
 
 class LinkSignTestCase(TestCase):
 
     def test_link_signing(self):
+        rf = RequestFactory()
+
         url = linksign.generate_signed_link(self.user, 'sentry')
         assert url.startswith('http://')
 
-        req = RequestFactory().get('/' + url.split('/', 3)[-1])
+        req = rf.get('/' + url.split('/', 3)[-1])
         signed_user = linksign.process_signature(req)
         assert signed_user
         assert signed_user.id == self.user.id
 
-        req = RequestFactory().get('/what' + url.split('/', 3)[-1])
+        req = rf.get('/what' + url.split('/', 3)[-1])
+        signed_user = linksign.process_signature(req)
+        assert signed_user is None
+
+        req = rf.get('/' + url.split('/', 3)[-1] + 'garbage')
         signed_user = linksign.process_signature(req)
         assert signed_user is None
 
-        req = RequestFactory().get('/' + url.split('/', 3)[-1] + 'garbage')
+        rf.defaults['SERVER_NAME'] = 'something-else'
+        req = rf.get('/' + url.split('/', 3)[-1])
         signed_user = linksign.process_signature(req)
         assert signed_user is None
