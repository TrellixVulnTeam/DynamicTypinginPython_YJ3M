commit 9e546b6033f58a0b6ef99381f7885c36d6e8ba16
Author: rbas <rbas.cz@gmail.com>
Date:   Fri May 25 12:07:21 2012 +0200

    Fix problem with encoding in Event message
    
    fix #422

diff --git a/sentry/plugins/sentry_mail/models.py b/sentry/plugins/sentry_mail/models.py
index 51cc4fc794..0bf835d02b 100644
--- a/sentry/plugins/sentry_mail/models.py
+++ b/sentry/plugins/sentry_mail/models.py
@@ -125,7 +125,7 @@ class MailProcessor(NotifyPlugin):
                 continue
             interface_list.append((interface.get_title(), body))
 
-        subject = '[%s] %s: %s' % (project.name.encode('utf-8'), event.get_level_display().upper(), event.error().encode('utf-8').split('\n')[0])
+        subject = '[%s] %s: %s' % (project.name.encode('utf-8'), event.get_level_display().upper().encode('utf-8'), event.error().encode('utf-8').split('\n')[0])
 
         link = '%s/%s/group/%d/' % (settings.URL_PREFIX, group.project.slug, group.id)
 
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index 22f64bc800..9dba5a72fc 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -106,6 +106,33 @@ class MailProcessorTest(TestCase):
         stacktrace.get_title.assert_called_once_with()
         stacktrace.to_string.assert_called_once_with(event)
 
+    @mock.patch('sentry.plugins.sentry_mail.models.MailProcessor._send_mail')
+    def test_notify_users_renders_interfaces_with_utf8_fix_issue_422(self, _send_mail):
+        group = Group()
+        group.first_seen = datetime.datetime.now()
+        group.last_seen = group.first_seen
+        group.id = 2
+        group.project_id = 1
+
+        stacktrace = Mock(spec=Stacktrace)
+        stacktrace.to_string.return_value = u'רונית מגן'
+        stacktrace.get_title.return_value = 'Stacktrace'
+
+        event = Event()
+        event.group = group
+        event.message = 'Soubor ji\xc5\xbe existuje'
+        event.logger = 'root'
+        event.site = None
+        event.interfaces = {'sentry.interfaces.Stacktrace': stacktrace}
+
+        with self.Settings(SENTRY_URL_PREFIX='http://example.com'):
+            p = MailProcessor(send_to=['foo@example.com'])
+            p.notify_users(group, event)
+
+        stacktrace.get_title.assert_called_once_with()
+        stacktrace.to_string.assert_called_once_with(event)
+
+
     @mock.patch('sentry.plugins.sentry_mail.models.MailProcessor._send_mail')
     def test_notify_users_does_email(self, _send_mail):
         project = Project(id=1, name='Project Name')
