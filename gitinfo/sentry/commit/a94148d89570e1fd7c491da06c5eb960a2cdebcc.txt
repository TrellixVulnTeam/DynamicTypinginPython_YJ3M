commit a94148d89570e1fd7c491da06c5eb960a2cdebcc
Author: Dan Fuller <dfuller@sentry.io>
Date:   Thu Jun 20 13:19:20 2019 -0700

    fix(api): Fix bug when mentioning a user who is already subscribed to an incident (SEN-784)
    
    If a user is already subscribed to an incident and are mentioned we attempt to subscribe them again,
    which causes an integrity error.

diff --git a/src/sentry/incidents/logic.py b/src/sentry/incidents/logic.py
index 76363e790c..e5bae6dbc3 100644
--- a/src/sentry/incidents/logic.py
+++ b/src/sentry/incidents/logic.py
@@ -207,10 +207,15 @@ def create_incident_activity(
     )
 
     if mentioned_user_ids:
-        IncidentSubscription.objects.bulk_create([
-            IncidentSubscription(incident=incident, user_id=mentioned_user_id)
-            for mentioned_user_id in mentioned_user_ids
-        ])
+        user_ids_to_subscribe = set(mentioned_user_ids) - set(IncidentSubscription.objects.filter(
+            incident=incident,
+            user_id__in=mentioned_user_ids,
+        ).values_list('user_id', flat=True))
+        if user_ids_to_subscribe:
+            IncidentSubscription.objects.bulk_create([
+                IncidentSubscription(incident=incident, user_id=mentioned_user_id)
+                for mentioned_user_id in user_ids_to_subscribe
+            ])
     send_subscriber_notifications.apply_async(
         kwargs={'activity_id': activity.id},
         countdown=10,
diff --git a/tests/sentry/incidents/test_logic.py b/tests/sentry/incidents/test_logic.py
index 2547e7dba1..a55d1acb68 100644
--- a/tests/sentry/incidents/test_logic.py
+++ b/tests/sentry/incidents/test_logic.py
@@ -389,7 +389,12 @@ class CreateIncidentActivityTest(TestCase, BaseIncidentsTest):
     def test_mentioned_user_ids(self):
         incident = self.create_incident()
         mentioned_member = self.create_user()
-        comment = 'hello **@%s**' % mentioned_member.username
+        subscribed_mentioned_member = self.create_user()
+        IncidentSubscription.objects.create(incident=incident, user=subscribed_mentioned_member)
+        comment = 'hello **@%s** and **@%s**' % (
+            mentioned_member.username,
+            subscribed_mentioned_member.username,
+        )
         with self.assertChanges(
             lambda: IncidentSubscription.objects.filter(
                 incident=incident,
@@ -404,7 +409,7 @@ class CreateIncidentActivityTest(TestCase, BaseIncidentsTest):
                 IncidentActivityType.COMMENT,
                 user=self.user,
                 comment=comment,
-                mentioned_user_ids=[mentioned_member.id],
+                mentioned_user_ids=[mentioned_member.id, subscribed_mentioned_member.id],
             )
         assert activity.incident == incident
         assert activity.type == IncidentActivityType.COMMENT.value
