commit e112b9b51884b01b8f79629ed1a68789a31c3079
Author: Bruno Garcia <github@brunogarcia.com>
Date:   Fri May 11 09:50:09 2018 +0200

    Cast 'retry_after' to integer (#8374)
    
    * fix: parse retry after value to integer resolves #7919
    * fix: round up value

diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index 3df9cd91d9..055efb06d6 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -1,6 +1,8 @@
 from __future__ import absolute_import, print_function
 
 import base64
+import math
+
 import jsonschema
 import logging
 import os
@@ -136,7 +138,7 @@ class APIView(BaseView):
             response['X-Sentry-Error'] = context['error']
 
             if isinstance(e, APIRateLimited) and e.retry_after is not None:
-                response['Retry-After'] = six.text_type(e.retry_after)
+                response['Retry-After'] = six.text_type(int(math.ceil(e.retry_after)))
 
         except Exception as e:
             # TODO(dcramer): test failures are not outputting the log message
diff --git a/tests/sentry/web/api/tests.py b/tests/sentry/web/api/tests.py
index 3876c09888..95c644783a 100644
--- a/tests/sentry/web/api/tests.py
+++ b/tests/sentry/web/api/tests.py
@@ -8,6 +8,7 @@ from django.core.urlresolvers import reverse
 from exam import fixture
 from mock import Mock
 
+from sentry.coreapi import APIRateLimited
 from sentry.models import ProjectKey
 from sentry.signals import event_accepted, event_dropped, event_filtered
 from sentry.testutils import (assert_mock_called_once_with_partial, TestCase)
@@ -746,3 +747,14 @@ class RobotsTxtTest(TestCase):
         resp = self.client.get(self.path)
         assert resp.status_code == 200
         assert resp['Content-Type'] == 'text/plain'
+
+
+def rate_limited_dispatch(*args, **kwargs):
+    raise APIRateLimited(retry_after=42.42)
+
+
+class APIViewTest(TestCase):
+    @mock.patch('sentry.web.api.APIView._dispatch', new=rate_limited_dispatch)
+    def test_retry_after_int(self):
+        resp = self._postWithHeader({})
+        assert resp['Retry-After'] == '43'
