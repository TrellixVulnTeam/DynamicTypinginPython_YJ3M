commit ac5951f67a90d66c22dd93da8bb5ceff21371905
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Aug 30 21:06:39 2010 -0700

    Change priority calc to use with_priority helper

diff --git a/dblog/templates/dblog/group.html b/dblog/templates/dblog/group.html
index 19bfebe8b0..615ff51bde 100644
--- a/dblog/templates/dblog/group.html
+++ b/dblog/templates/dblog/group.html
@@ -1,5 +1,7 @@
 {% extends "dblog/index.html" %}
 
+{% load dblog_helpers %}
+
 {% block title %}{{ message.error }} | Django DB Log{% endblock %}
 
 {% block body %}
@@ -12,16 +14,16 @@
 		<h2>URLs</h2>
 		
 		<ul class="url-list">
-			{% for link in unique_urls %}
-				<li><span class="count">{{ link.times_seen }}</span> <a href="{{ link.url }}">{{ link.url }}</a></li>
+			{% for link, priority in unique_urls|with_priority:"times_seen" %}
+				<li class="priority-{{ priority }}"><span class="count">{{ link.times_seen }}</span> <a href="{{ link.url }}">{{ link.url }}</a></li>
 			{% endfor %}
 		</ul>
 
 		<h2>Servers</h2>
 		
 		<ul class="server-list">
-			{% for server in unique_servers %}
-				<li><span class="count">{{ server.times_seen }}</span> {{ server.server_name }}</li>
+			{% for server, priority in unique_servers|with_priority:"times_seen" %}
+				<li class="priority-{{ priority }}"><span class="count">{{ server.times_seen }}</span> {{ server.server_name }}</li>
 			{% endfor %}
 		</ul>
 	</div>
diff --git a/dblog/templates/dblog/index.html b/dblog/templates/dblog/index.html
index 174a658024..e749654b08 100644
--- a/dblog/templates/dblog/index.html
+++ b/dblog/templates/dblog/index.html
@@ -1,4 +1,5 @@
 {% load paging_extras %}
+{% load dblog_helpers %}
 
 <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd"> 
 <html lang="en">
@@ -155,17 +156,17 @@
 			.messages .traceback { display: none; }
 			.messages li { padding: 8px; }
 			.messages .row1 { background: #f9f9f9; }
-			.messages .priority-veryhigh .count {
+			.priority-veryhigh .count {
 				background: red;
 			}
-			.messages .priority-high .count {
+			.priority-high .count {
 				background: #ff5400;
 			}
-			.messages .priority-medium .count {
+			.priority-medium .count {
 				background: #ff7800;
 			}
-			.messages .priority-low .count,
-			.messages .priority-verylow .count {
+			.priority-low .count,
+			.priority-verylow .count {
 				background: #ffb400;
 			}
 			.messages .last_seen { color: #bbb; font-size: 0.9em; margin-left: 5px; }
@@ -221,8 +222,8 @@
 			{% paginate message_list from request as message_list per_page 25 %}
 			{{ message_list.paging }}
 			<ul class="messages">
-				{% for message in message_list.objects %}
-					<li class="{% cycle 'row1' 'row2' %} level-{{ message.level }} priority-{{ message.priority }}" onclick="window.location.href='{% url dblog-group message.pk %}'">
+				{% for message, priority in message_list.objects|with_priority %}
+					<li class="{% cycle 'row1' 'row2' %} level-{{ message.level }} priority-{{ priority }}" onclick="window.location.href='{% url dblog-group message.pk %}'">
 						<span class="count">{{ message.times_seen }}</span>
 						<h3>{{ message.view }}</h3>
 						<span class="last_seen">{{ message.last_seen|timesince }} ago</span>
diff --git a/dblog/templatetags/dblog_helpers.py b/dblog/templatetags/dblog_helpers.py
new file mode 100644
index 0000000000..cc8136951a
--- /dev/null
+++ b/dblog/templatetags/dblog_helpers.py
@@ -0,0 +1,25 @@
+from django import template
+register = template.Library()
+
+def with_priority(result_list, key='score'):
+    if isinstance(result_list[0], dict):
+        _get = lambda x, k: x[k]
+    else:
+        _get = lambda x, k: getattr(x, k)
+
+    min_, max_ = min([_get(r, key) for r in result_list]), max([_get(r, key) for r in result_list])
+    mid = (max_ - min_) / 4
+    for result in result_list:
+        val = _get(result, key)
+        if val > max_ - mid:
+            priority = 'veryhigh'
+        elif val > max_ - mid * 2:
+            priority = 'high'
+        elif val > max_ - mid * 3:
+            priority = 'medium'
+        elif val > max_ - mid * 4:
+            priority = 'low'
+        else:
+            priority = 'verylow'
+        yield result, priority
+with_priority = register.filter(with_priority)
\ No newline at end of file
diff --git a/dblog/views.py b/dblog/views.py
index 2248ca5a41..35488be020 100644
--- a/dblog/views.py
+++ b/dblog/views.py
@@ -50,19 +50,6 @@ def index(request):
     if server_name:
         message_list = message_list.filter(server_name=server_name)
 
-    # for m in message_list:
-    #     score = log(m.score)
-    #     if score > 2:
-    #         m.priority = 'high'
-    #     elif score > 1:
-    #         m.priority = 'medium'
-    #     elif score >= 0:
-    #         m.priority = 'low'
-    #     elif score < 0:
-    #         m.priority = 'verylow'
-    #     else:
-    #         m.priority = 'veryhigh'
-
     return render_to_response('dblog/index.html', locals())
 
 def group(request, group_id):
