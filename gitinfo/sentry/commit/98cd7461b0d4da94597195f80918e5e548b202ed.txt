commit 98cd7461b0d4da94597195f80918e5e548b202ed
Author: ted kaemming <ted@kaemming.com>
Date:   Wed Nov 1 11:22:38 2017 -0700

    ref(environments): Add `Environment.get_for_organization_id` method (#6490)

diff --git a/src/sentry/models/environment.py b/src/sentry/models/environment.py
index e1a7e1de43..d796c43084 100644
--- a/src/sentry/models/environment.py
+++ b/src/sentry/models/environment.py
@@ -47,9 +47,29 @@ class Environment(Model):
     def get_cache_key(cls, organization_id, name):
         return 'env:2:%s:%s' % (organization_id, md5_text(name).hexdigest())
 
+    @classmethod
+    def get_name_or_default(cls, name):
+        return name or ''
+
+    @classmethod
+    def get_for_organization_id(cls, organization_id, name):
+        name = cls.get_name_or_default(name)
+
+        cache_key = cls.get_cache_key(organization_id, name)
+
+        env = cache.get(cache_key)
+        if env is None:
+            env = cls.objects.get(
+                name=name,
+                organization_id=organization_id,
+            )
+            cache.set(cache_key, env, 3600)
+
+        return env
+
     @classmethod
     def get_or_create(cls, project, name):
-        name = name or ''
+        name = cls.get_name_or_default(name)
 
         cache_key = cls.get_cache_key(project.organization_id, name)
 
diff --git a/tests/sentry/models/test_environment.py b/tests/sentry/models/test_environment.py
index 65cda9eba4..fab8e18d41 100644
--- a/tests/sentry/models/test_environment.py
+++ b/tests/sentry/models/test_environment.py
@@ -1,5 +1,7 @@
 from __future__ import absolute_import
 
+import pytest
+
 from sentry.models import Environment
 from sentry.testutils import TestCase
 
@@ -8,6 +10,12 @@ class GetOrCreateTest(TestCase):
     def test_simple(self):
         project = self.create_project()
 
+        with pytest.raises(Environment.DoesNotExist):
+            Environment.get_for_organization_id(
+                project.organization_id,
+                'prod',
+            )
+
         env = Environment.get_or_create(
             project=project,
             name='prod',
@@ -22,3 +30,9 @@ class GetOrCreateTest(TestCase):
         )
 
         assert env2.id == env.id
+
+        with self.assertNumQueries(0):
+            assert Environment.get_for_organization_id(
+                project.organization_id,
+                'prod',
+            ).id == env.id
