commit 5e720a70ea51d016956e116ca8ce71e66e23e321
Author: josh <josh@jrl.ninja>
Date:   Sat Feb 15 00:13:06 2020 +0000

    perf(direnv): faster devservices check and small quality of life improvements (#17072)

diff --git a/.envrc b/.envrc
index 84e9f90793..bb779b5fcf 100644
--- a/.envrc
+++ b/.envrc
@@ -106,6 +106,9 @@ fi
 
 info "Activating virtualenv."
 source .venv/bin/activate
+# XXX: ideally, direnv is able to export PS1 as modified by sourcing venvs
+#      but we'd have to patch direnv, and ".venv" isn't descriptive anyways
+unset PS1
 [ "$(command -v python)" != "${PWD}/.venv/bin/python" ] && die "Failed to activate virtualenv."
 
 python -c "import sys; sys.exit(sys.version_info[:2] != (2, 7))" || \
@@ -138,17 +141,16 @@ rm -f .git/hooks/pre-commit.legacy
 
 info "Checking devservices..."
 
-# XXX: these container names are hardcoded for now
 # NOTE: sentry_symbolicator isn't started up by devservices, and is behind a config flag, so we're not checking for it
-for container in \
-    sentry_postgres     \
-    sentry_clickhouse   \
-    sentry_snuba        \
-    sentry_redis        ;
-    do
-    docker exec "$container" true || die "The docker container ${container} doesn't seem to be running.
+required_devservices="sentry_clickhouse\n
+sentry_postgres\n
+sentry_redis\n
+sentry_snuba"
+
+# need to ensure the required ones are running, so test that it's a subset of the running containers
+[ -n "$(comm -23 <(echo $required_devservices) <(docker ps --format '{{.Names}}' | sort | uniq -u))" ] && \
+    die "The required devservices don't seem to be running.
 Please run sentry devservices up."
-done
 
 
 ### database ###
@@ -199,10 +201,13 @@ fi
 cat <<EOF
 ${green}${bold}direnv: SUCCESS!
 ${reset}
+EOF
+
+if [ ! -n "${SENTRY_SILENCE_DIRENV_NOTICE:-}" ]; then
+    cat <<EOF
 direnv tooling is in an ALPHA state!
 If you're having trouble, or have questions, please ask in #discuss-dev-tooling
 and/or reach out to @josh.
 
-You can safely ignore the followiing "PS1 cannot be exported" message.
-
 EOF
+fi
