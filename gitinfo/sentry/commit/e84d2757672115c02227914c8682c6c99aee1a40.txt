commit e84d2757672115c02227914c8682c6c99aee1a40
Author: Daniel Griesser <daniel.griesser.86@gmail.com>
Date:   Tue Nov 19 14:33:27 2019 +0100

    feat(apm): Add sample rate and auto xhr tracking (#15668)
    
    * feat: Add sample rate and auto xhr tracking
    
    * meta: Bump deps

diff --git a/package.json b/package.json
index e1245f04f2..ecd4c56a56 100644
--- a/package.json
+++ b/package.json
@@ -17,8 +17,8 @@
     "@babel/preset-react": "^7.7.0",
     "@babel/preset-typescript": "^7.7.2",
     "@babel/runtime": "~7.7.2",
-    "@sentry/browser": "5.10.0-beta.0",
-    "@sentry/integrations": "5.10.0-beta.0",
+    "@sentry/browser": "5.10.0-beta.2",
+    "@sentry/integrations": "5.10.0-beta.2",
     "@types/classnames": "^2.2.0",
     "@types/clipboard": "^2.0.1",
     "@types/color": "^3.0.0",
diff --git a/src/sentry/static/sentry/app/api.tsx b/src/sentry/static/sentry/app/api.tsx
index 320200a9a8..b68c6f1adc 100644
--- a/src/sentry/static/sentry/app/api.tsx
+++ b/src/sentry/static/sentry/app/api.tsx
@@ -3,7 +3,6 @@ import isNil from 'lodash/isNil';
 import get from 'lodash/get';
 import $ from 'jquery';
 import * as Sentry from '@sentry/browser';
-import {TransactionActivity} from '@sentry/integrations';
 
 import {
   PROJECT_MOVED,
@@ -268,14 +267,6 @@ export class Client {
       }
     }
 
-    const xhrActivity = TransactionActivity.pushActivity('xhr', {
-      data: {
-        request_data: data,
-      },
-      op: 'http',
-      description: `${method} ${fullUrl}`,
-    });
-
     const errorObject = new Error();
 
     this.activeRequests[id] = new Request(
@@ -343,8 +334,6 @@ export class Client {
           );
         },
         complete: (jqXHR: JQueryXHR, textStatus: string) => {
-          TransactionActivity.popActivity(xhrActivity);
-
           return this.wrapCallback<[JQueryXHR, string]>(id, options.complete, true)(
             jqXHR,
             textStatus
diff --git a/src/sentry/static/sentry/app/bootstrap.jsx b/src/sentry/static/sentry/app/bootstrap.jsx
index e1e9ad299b..80f662d8bd 100644
--- a/src/sentry/static/sentry/app/bootstrap.jsx
+++ b/src/sentry/static/sentry/app/bootstrap.jsx
@@ -12,7 +12,12 @@ import ReactDOM from 'react-dom';
 import Reflux from 'reflux';
 import * as Router from 'react-router';
 import * as Sentry from '@sentry/browser';
-import {ExtraErrorData, Tracing, TransactionActivity} from '@sentry/integrations';
+import {
+  ExtraErrorData,
+  Tracing,
+  TransactionActivity,
+  TransactionActivityHandlers,
+} from '@sentry/integrations';
 import createReactClass from 'create-react-class';
 import jQuery from 'jquery';
 import moment from 'moment';
@@ -22,7 +27,19 @@ import ConfigStore from 'app/stores/configStore';
 import Main from 'app/main';
 import ajaxCsrfSetup from 'app/utils/ajaxCsrfSetup';
 import plugins from 'app/plugins';
-import {startApm} from 'app/utils/apm';
+
+// App setup
+if (window.__initialData) {
+  ConfigStore.loadInitialData(window.__initialData);
+}
+
+// APM -------------------------------------------------------------
+const config = ConfigStore.getConfig();
+// This is just a simple gatekeeper to not enable apm for whole sentry.io at first
+const forceTracingEnabled = config && config.isApmDataSamplingEnabled ? 1 : 0;
+
+const tracesSampleRate = Math.max(0.1, forceTracingEnabled);
+// -------------------------------^ 10% Sample rate for enabling transactions in frontend
 
 // SDK INIT  --------------------------------------------------------
 Sentry.init({
@@ -35,7 +52,15 @@ Sentry.init({
     new Tracing({
       tracingOrigins: ['localhost', 'sentry.io', /^\//],
     }),
-    new TransactionActivity(),
+    new Sentry.Integrations.Breadcrumbs({
+      // This handlers will be removed here in a future version
+      // What they do is auto instrument history and XHR API
+      // creating Transactions and Spans out of it
+      handlers: TransactionActivityHandlers,
+    }),
+    new TransactionActivity({
+      tracesSampleRate,
+    }),
   ],
 });
 
@@ -56,22 +81,6 @@ jQuery.ajaxSetup({
   beforeSend: ajaxCsrfSetup,
 });
 
-// App setup
-if (window.__initialData) {
-  ConfigStore.loadInitialData(window.__initialData);
-}
-
-// APM -------------------------------------------------------------
-const config = ConfigStore.getConfig();
-// This is just a simple gatekeeper to not enable apm for whole sentry.io at first
-if (config && config.isApmDataSamplingEnabled) {
-  startApm();
-}
-// -----------------------------------------------------------------
-
-// these get exported to a global variable, which is important as its the only
-// way we can call into scoped objects
-
 const render = Component => {
   const rootEl = document.getElementById('blk_router');
 
diff --git a/src/sentry/static/sentry/app/utils/apm.jsx b/src/sentry/static/sentry/app/utils/apm.jsx
index 098e13513f..84f58ae351 100644
--- a/src/sentry/static/sentry/app/utils/apm.jsx
+++ b/src/sentry/static/sentry/app/utils/apm.jsx
@@ -8,17 +8,3 @@ export function setTransactionName(name) {
   TransactionActivity.updateTransactionName(name);
   Sentry.setTag('ui.route', name);
 }
-
-/**
- * This is called only when our application is initialized. Creates a transaction
- * and creates a router listener to create a new transaction as user navigates.
- */
-export function startApm() {
-  // `${window.location.href}` will be used a temp transaction name
-  // Internally once our <App> is mounted and the Router is initalized
-  // we call `setTransactionName` to update the full URL to the route name
-  TransactionActivity.startIdleTransaction(`${window.location.href}`, {
-    op: 'pageload',
-    sampled: true,
-  });
-}
diff --git a/yarn.lock b/yarn.lock
index f15acdc191..8e21d5bd3d 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -1830,65 +1830,65 @@
     hey-listen "^1.0.8"
     style-value-types "^3.1.4"
 
-"@sentry/browser@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/browser/-/browser-5.10.0-beta.0.tgz#5f65a032fede5288814e0a2ab045159b78fa8482"
-  integrity sha512-IYhUAoYTrO9mlYwYNK1kaxfyUGrdMwauxKrY4l92z8bSExFEax/KqPsfPnfZdx5v9w4b9l+hKNe/7qYOH2Fryg==
-  dependencies:
-    "@sentry/core" "5.10.0-beta.0"
-    "@sentry/types" "5.10.0-beta.0"
-    "@sentry/utils" "5.10.0-beta.0"
+"@sentry/browser@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/browser/-/browser-5.10.0-beta.2.tgz#f5f341fdcff476772b8e38dfe92327598273d2f7"
+  integrity sha512-bFFrEcdG4zBgEfoCW5dJqIlp1RI/xmZjeMkezcBersor9Xx1rugUKYzaNbgons11nQK+gqhBRd/vkxrjDCEy2A==
+  dependencies:
+    "@sentry/core" "5.10.0-beta.2"
+    "@sentry/types" "5.10.0-beta.2"
+    "@sentry/utils" "5.10.0-beta.2"
     tslib "^1.9.3"
 
-"@sentry/core@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/core/-/core-5.10.0-beta.0.tgz#f96d07a74ddeb13d0bc1e774409556a50b042358"
-  integrity sha512-vc84lh1/AbPTvHTpPK1SN9EXaLqUzm4RQcURqPxC2fUo38zGRBU36GLlYBzYp4aZNdXAj3pgtO1JV3yHNGWaug==
+"@sentry/core@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/core/-/core-5.10.0-beta.2.tgz#5e89fe7cf27314cca40d4a3e7f404ede72451dd0"
+  integrity sha512-RkVOnoQAqUp8BsV04jvrgjrnQWJZcTsHadifSEF7oXQIoc3CgPjR6TvNMfq8mOAbfeMSjy76F/nIQaK4NNyqcQ==
   dependencies:
-    "@sentry/hub" "5.10.0-beta.0"
-    "@sentry/minimal" "5.10.0-beta.0"
-    "@sentry/types" "5.10.0-beta.0"
-    "@sentry/utils" "5.10.0-beta.0"
+    "@sentry/hub" "5.10.0-beta.2"
+    "@sentry/minimal" "5.10.0-beta.2"
+    "@sentry/types" "5.10.0-beta.2"
+    "@sentry/utils" "5.10.0-beta.2"
     tslib "^1.9.3"
 
-"@sentry/hub@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/hub/-/hub-5.10.0-beta.0.tgz#b58c8049782866207322153f1b100cd54347c2f5"
-  integrity sha512-40PN15dc1FECXaaCOs6k6I97YjtjVR28x5U0JeQs18bZyarpUixj3bTMi8xcMpHREg5NJEwmGoyrBARqYG6p2Q==
+"@sentry/hub@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/hub/-/hub-5.10.0-beta.2.tgz#7e287037ebff26b0f03479f9af82a1aa43024dc5"
+  integrity sha512-Yp1tAbc7lH1xuZWbf/k7UL+AkznFz8AhgFu9d3cV8iORIyVnhwsqtByVTnqtY1BbnFh/s4JYDQePeO+h0mDpcw==
   dependencies:
-    "@sentry/types" "5.10.0-beta.0"
-    "@sentry/utils" "5.10.0-beta.0"
+    "@sentry/types" "5.10.0-beta.2"
+    "@sentry/utils" "5.10.0-beta.2"
     tslib "^1.9.3"
 
-"@sentry/integrations@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/integrations/-/integrations-5.10.0-beta.0.tgz#81179bf295598669951a13d2ff2448f82b37750a"
-  integrity sha512-+/xxSkby0lLbzA8VOrHL/LF4AM8Zqa76EVP3hIcxGuh22LiGwJzARrrxcz64Bx3G/JqpjvzA/XfS3M4EnLnqIg==
+"@sentry/integrations@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/integrations/-/integrations-5.10.0-beta.2.tgz#26eff74507b544912a99cdec99c7d4b7ec0bf8db"
+  integrity sha512-gf+8g2aEUKND7mCRY06PiUYgaM++yh+1rFP3s8xKJQOFK6RvzhZhoqPU+LzH6nXmJV9uQKHdY9EJwOnFmF4vag==
   dependencies:
-    "@sentry/types" "5.10.0-beta.0"
-    "@sentry/utils" "5.10.0-beta.0"
+    "@sentry/types" "5.10.0-beta.2"
+    "@sentry/utils" "5.10.0-beta.2"
     tslib "^1.9.3"
 
-"@sentry/minimal@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/minimal/-/minimal-5.10.0-beta.0.tgz#0bf7834b0346454b9cc73cfbbc4535cad273ba1b"
-  integrity sha512-5qqO3Bq3d5B0Qh4hrF+vi0GcsjihEZ/tGwjqDwsKIzrkvByL1WTr5E4VHCg8pAzltgIQtvvQQDGdKwMz28s3rw==
+"@sentry/minimal@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/minimal/-/minimal-5.10.0-beta.2.tgz#fb8b0e14dfc0395bbec7f826d1e27151ea7df16f"
+  integrity sha512-YIhPZLarT3MTiE0rSp2GoCJFD5jnVITFpbGtLXYX6dA7LsevT8aAf/1GPGmxgQDsDqoVjSTlGBylsAa2XWXT+g==
   dependencies:
-    "@sentry/hub" "5.10.0-beta.0"
-    "@sentry/types" "5.10.0-beta.0"
+    "@sentry/hub" "5.10.0-beta.2"
+    "@sentry/types" "5.10.0-beta.2"
     tslib "^1.9.3"
 
-"@sentry/types@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/types/-/types-5.10.0-beta.0.tgz#c065ca0f61ef289c7fe3ec744907f030439f94ee"
-  integrity sha512-KaOOvzEAYpKRJ7arMpjzCGzazU+YnQcPWfbBVuwWN+Ofaz6oDaJ4DU1iEKopWg35gW6hwZyUb2/MrQm8N118Ew==
+"@sentry/types@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/types/-/types-5.10.0-beta.2.tgz#c8410406405eb1fadadbc990caa464667b27a18f"
+  integrity sha512-gUdSyMfV/PSstUrR9DkGRdMuGVU474knxvL2Jr3EpauX5id7UcxFfXK2X48DFp9oueyoKFpBVvMkEH5zP5NOgw==
 
-"@sentry/utils@5.10.0-beta.0":
-  version "5.10.0-beta.0"
-  resolved "https://registry.yarnpkg.com/@sentry/utils/-/utils-5.10.0-beta.0.tgz#2070e2fe3b209bcc18bd931f46060540c2b159c2"
-  integrity sha512-6r5wdgC8iEIe37sSe4t2dg4li5KLb5RysrwhSD8FBvinJSSQAIbKsVMtcj6Ydh02KBk12KGDLiZXRrutriXOIw==
+"@sentry/utils@5.10.0-beta.2":
+  version "5.10.0-beta.2"
+  resolved "https://registry.yarnpkg.com/@sentry/utils/-/utils-5.10.0-beta.2.tgz#5e220b32f89a3f8b63277f00c0d3ddd2298d298f"
+  integrity sha512-cK9MEJF9ZZcLov48AxZRDHDvt1WxZkvRaZXoPaZueR7bDeRFU1Qr3Y8vjl5ve2U13SQIjTjbCc1Lw8uM288sig==
   dependencies:
-    "@sentry/types" "5.10.0-beta.0"
+    "@sentry/types" "5.10.0-beta.2"
     tslib "^1.9.3"
 
 "@storybook/addon-a11y@^4.1.3":
