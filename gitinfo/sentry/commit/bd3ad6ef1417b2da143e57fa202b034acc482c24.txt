commit bd3ad6ef1417b2da143e57fa202b034acc482c24
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Wed Aug 21 20:19:18 2019 +0200

    fix(devserver): Fix webpack proxy failing with uwsgi http (#14468)
    
    Follow up to #14462. Webpack watcher modify the backend port
    _after_ we set the uwsgi override binding, breaking it due to
    port collision. This patch moves the binding override to right
    before the server creation to fix the issue.

diff --git a/src/sentry/runner/commands/devserver.py b/src/sentry/runner/commands/devserver.py
index 951fa4e77b..12117d7da1 100644
--- a/src/sentry/runner/commands/devserver.py
+++ b/src/sentry/runner/commands/devserver.py
@@ -71,12 +71,6 @@ def devserver(reload, watchers, workers, experimental_spa, styleguide, prefix, e
             )
 
     uwsgi_overrides = {
-        # Make sure uWSGI spawns an HTTP server for us as we don't
-        # have a proxy/load-balancer in front in dev mode.
-        'http': '%s:%s' % (parsed_url.hostname, parsed_url.port),
-        'protocol': 'uwsgi',
-        # This is needed to prevent https://git.io/fj7Lw
-        'uwsgi-socket': None,
         'http-keepalive': True,
         # Make sure we reload really quickly for local dev in case it
         # doesn't want to shut down nicely on it's own, NO MERCY
@@ -115,6 +109,8 @@ def devserver(reload, watchers, workers, experimental_spa, styleguide, prefix, e
         proxy_port = port
         port = port + 1
 
+        uwsgi_overrides['protocol'] = 'http'
+
         os.environ["SENTRY_WEBPACK_PROXY_PORT"] = "%s" % proxy_port
         os.environ["SENTRY_BACKEND_PORT"] = "%s" % port
 
@@ -125,6 +121,17 @@ def devserver(reload, watchers, workers, experimental_spa, styleguide, prefix, e
         )
 
         daemons = [w for w in daemons if w[0] != "webpack"] + [("webpack", webpack_config)]
+    else:
+        # If we are the bare http server, use the http option with uwsgi protocol
+        # See https://uwsgi-docs.readthedocs.io/en/latest/HTTP.html
+        uwsgi_overrides.update({
+            # Make sure uWSGI spawns an HTTP server for us as we don't
+            # have a proxy/load-balancer in front in dev mode.
+            'http': '%s:%s' % (host, port),
+            'protocol': 'uwsgi',
+            # This is needed to prevent https://git.io/fj7Lw
+            'uwsgi-socket': None,
+        })
 
     if workers:
         if settings.CELERY_ALWAYS_EAGER:
