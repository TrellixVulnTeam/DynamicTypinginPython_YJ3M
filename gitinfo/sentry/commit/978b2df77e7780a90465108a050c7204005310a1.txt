commit 978b2df77e7780a90465108a050c7204005310a1
Author: William Mak <william@wmak.io>
Date:   Fri Mar 27 15:18:23 2020 -0400

    feat(performance) - Allowing queries for key transactions

diff --git a/src/sentry/discover/endpoints/discover_key_transactions.py b/src/sentry/discover/endpoints/discover_key_transactions.py
index 84aa01dbc8..4a7724d98c 100644
--- a/src/sentry/discover/endpoints/discover_key_transactions.py
+++ b/src/sentry/discover/endpoints/discover_key_transactions.py
@@ -73,7 +73,7 @@ class KeyTransactionEndpoint(KeyTransactionBase):
 
         results = query(
             fields,
-            None,
+            request.GET.get("query"),
             params,
             orderby=orderby,
             referrer="discover.key_transactions",
diff --git a/tests/snuba/api/endpoints/test_discover_key_transactions.py b/tests/snuba/api/endpoints/test_discover_key_transactions.py
index 79358c06d4..d008a56113 100644
--- a/tests/snuba/api/endpoints/test_discover_key_transactions.py
+++ b/tests/snuba/api/endpoints/test_discover_key_transactions.py
@@ -293,6 +293,51 @@ class KeyTransactionTest(APITestCase):
         assert len(data) == 1
         assert data[0]["transaction"] == event_data["transaction"]
 
+    @patch("django.utils.timezone.now")
+    def test_get_transaction_with_query(self, mock_now):
+        mock_now.return_value = before_now().replace(tzinfo=pytz.utc)
+        start_timestamp = iso_format(before_now(minutes=1))
+        end_timestamp = iso_format(before_now(minutes=1))
+        event_data = load_data("transaction")
+        event_data.update({"start_timestamp": start_timestamp, "timestamp": end_timestamp})
+
+        transactions = [("127.0.0.1", "/foo_transaction/"), ("192.168.0.1", "/blah_transaction/")]
+
+        for ip_address, transaction in transactions:
+            event_data["transaction"] = transaction
+            event_data["user"]["ip_address"] = ip_address
+            self.store_event(data=event_data, project_id=self.project.id)
+            KeyTransaction.objects.create(
+                owner=self.user,
+                organization=self.org,
+                transaction=event_data["transaction"],
+                project=self.project,
+            )
+
+        with self.feature("organizations:performance-view"):
+            url = reverse("sentry-api-0-organization-key-transactions", args=[self.org.slug])
+            response = self.client.get(
+                url,
+                {
+                    "project": [self.project.id],
+                    "orderby": "transaction",
+                    "query": "user:{}".format(event_data["user"]["ip_address"]),
+                    "field": [
+                        "transaction",
+                        "transaction_status",
+                        "project",
+                        "rpm()",
+                        "error_rate()",
+                        "percentile(transaction.duration, 0.95)",
+                    ],
+                },
+            )
+
+        assert response.status_code == 200
+        data = response.data["data"]
+        assert len(data) == 1
+        assert data[0]["transaction"] == event_data["transaction"]
+
     @patch("django.utils.timezone.now")
     def test_get_transaction_with_backslash_and_quotes(self, mock_now):
         mock_now.return_value = before_now().replace(tzinfo=pytz.utc)
