commit b3535b654a9c0b8db2fea53e385a64575eabe817
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Thu Nov 28 10:38:56 2019 +0100

    ref: Cache projectkeys more aggressively (#15796)

diff --git a/src/sentry/api/endpoints/relay_projectconfigs.py b/src/sentry/api/endpoints/relay_projectconfigs.py
index 92dfcd3cea..3050936dee 100644
--- a/src/sentry/api/endpoints/relay_projectconfigs.py
+++ b/src/sentry/api/endpoints/relay_projectconfigs.py
@@ -60,7 +60,7 @@ class RelayProjectConfigsEndpoint(Endpoint):
 
         with Hub.current.start_span(op="relay_fetch_keys"):
             project_keys = {}
-            for key in ProjectKey.objects.filter(project_id__in=project_ids):
+            for key in ProjectKey.objects.get_many_from_cache(project_ids, key="project_id"):
                 project_keys.setdefault(key.project_id, []).append(key)
 
         metrics.timing("relay_project_configs.projects_requested", len(project_ids))
diff --git a/src/sentry/models/projectkey.py b/src/sentry/models/projectkey.py
index 13633bcff1..f6f3582901 100644
--- a/src/sentry/models/projectkey.py
+++ b/src/sentry/models/projectkey.py
@@ -63,7 +63,12 @@ class ProjectKey(Model):
     rate_limit_count = BoundedPositiveIntegerField(null=True)
     rate_limit_window = BoundedPositiveIntegerField(null=True)
 
-    objects = BaseManager(cache_fields=("public_key", "secret_key"))
+    objects = BaseManager(
+        cache_fields=("public_key", "secret_key"),
+        # store projectkeys in memcached for longer than other models,
+        # specifically to make the relay_projectconfig endpoint faster.
+        cache_ttl=60 * 30,
+    )
 
     data = JSONField()
 
