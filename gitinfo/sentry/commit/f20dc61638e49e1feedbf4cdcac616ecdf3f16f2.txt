commit f20dc61638e49e1feedbf4cdcac616ecdf3f16f2
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Thu Oct 17 23:24:02 2019 +0300

    build(gcr): Move to Google Cloud Build from Docker Hub autobuiâ€¦ (#15116)

diff --git a/docker/cloudbuild.yaml b/docker/cloudbuild.yaml
new file mode 100644
index 0000000000..f74f4107aa
--- /dev/null
+++ b/docker/cloudbuild.yaml
@@ -0,0 +1,51 @@
+steps:
+# Prime the cache if available
+- name: 'gcr.io/cloud-builders/docker'
+  entrypoint: 'bash'
+  args:
+    - '-c'
+    - 'docker pull us.gcr.io/$PROJECT_ID/sentry:latest || true'
+# Build the main getsentry/sentry image
+- name: 'gcr.io/cloud-builders/docker'
+  args: [
+    'build',
+    '--build-arg', 'SOURCE_COMMIT=$COMMIT_SHA',
+    '--cache-from', 'us.gcr.io/$PROJECT_ID/sentry:latest',
+    '-t', 'us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA',
+    '-t', 'us.gcr.io/$PROJECT_ID/sentry:$SHORT_SHA',
+    '-t', 'us.gcr.io/$PROJECT_ID/sentry:latest',
+    '-f', './docker/Dockerfile', '.'
+  ]
+# Derive the -onbuild variant
+- name: 'gcr.io/cloud-builders/docker'
+  args: [
+    'build',
+    '-t', 'us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA-onbuild',
+    '-t', 'us.gcr.io/$PROJECT_ID/sentry:$SHORT_SHA-onbuild',
+    '-t', 'us.gcr.io/$PROJECT_ID/sentry:latest-onbuild',
+    '-f', './docker/onbuild/Dockerfile', '.'
+  ]
+# Smoke tests
+- name: 'us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA'
+  args: ['config', 'get', 'system.secret-key']
+  env:
+    - SENTRY_SKIP_BACKEND_VALIDATION=1
+    - SENTRY_SECRET_KEY=abc
+    - SENTRY_REDIS_HOST=localhost
+ # Only tag "latest" when on master
+- name: 'gcr.io/cloud-builders/docker'
+  entrypoint: 'bash'
+  args:
+  - '-e'
+  - '-c'
+  - |
+    if [ "$BRANCH_NAME" == "master" ]; then
+      docker push us.gcr.io/$PROJECT_ID/sentry:latest
+      docker push us.gcr.io/$PROJECT_ID/sentry:latest-onbuild
+    fi
+timeout: 1200s
+images:
+- 'us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA'
+- 'us.gcr.io/$PROJECT_ID/sentry:$COMMIT_SHA-onbuild'
+- 'us.gcr.io/$PROJECT_ID/sentry:$SHORT_SHA'
+- 'us.gcr.io/$PROJECT_ID/sentry:$SHORT_SHA-onbuild'
diff --git a/docker/docker-compose.test.yml b/docker/docker-compose.test.yml
deleted file mode 100644
index a632e5cb46..0000000000
--- a/docker/docker-compose.test.yml
+++ /dev/null
@@ -1,9 +0,0 @@
-version: '3.4'
-services:
-  sut:
-    image: getsentry/sentry:git
-    environment:
-      - SENTRY_SKIP_BACKEND_VALIDATION=1
-      - SENTRY_SECRET_KEY=abc
-      - SENTRY_REDIS_HOST=localhost
-    command: config get system.secret-key
diff --git a/docker/hooks/build b/docker/hooks/build
deleted file mode 100755
index 8ba54e9af9..0000000000
--- a/docker/hooks/build
+++ /dev/null
@@ -1,20 +0,0 @@
-#!/bin/bash
-
-set -e;
-
-if [[ -z "$SOURCE_COMMIT" ]]; then
-    export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
-    echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
-fi
-
-echo "SOURCE_COMMIT: $SOURCE_COMMIT";
-cd $(git rev-parse --show-toplevel);
-
-git archive --format=tar.gz -o context.tar.gz $SOURCE_COMMIT
-docker build --build-arg SOURCE_COMMIT="$SOURCE_COMMIT" -t "$DOCKER_REPO:$SOURCE_COMMIT" -t "$DOCKER_REPO:$DOCKER_TAG" -f "./docker/Dockerfile" - < context.tar.gz
-
-if [ "$SOURCE_BRANCH" == "master" ]; then
-    docker build -t "$DOCKER_REPO:$SOURCE_COMMIT-onbuild" -t "$DOCKER_REPO:$DOCKER_TAG-onbuild" -f "./docker/onbuild/Dockerfile" - < context.tar.gz
-fi
-
-rm context.tar.gz || true
diff --git a/docker/hooks/post_push b/docker/hooks/post_push
deleted file mode 100755
index 1cdddf3e65..0000000000
--- a/docker/hooks/post_push
+++ /dev/null
@@ -1,17 +0,0 @@
-#!/bin/bash
-
-set -e;
-
-if [[ -z "$SOURCE_COMMIT" ]]; then
-    export SOURCE_COMMIT="${SOURCE_COMMIT:-$(git rev-parse HEAD)}";
-    echo "Updating SOURCE_COMMIT from 'git rev-parse HEAD'";
-fi
-
-echo "SOURCE_COMMIT: $SOURCE_COMMIT";
-
-docker push "$DOCKER_REPO:$SOURCE_COMMIT"
-
-if [ "$SOURCE_BRANCH" == "master" ]; then
-    docker push "$DOCKER_REPO:$SOURCE_COMMIT-onbuild";
-    docker push "$DOCKER_REPO:$DOCKER_TAG-onbuild";
-fi
diff --git a/docker/test.dockerfile b/docker/test.dockerfile
deleted file mode 100644
index f4e4756522..0000000000
--- a/docker/test.dockerfile
+++ /dev/null
@@ -1,7 +0,0 @@
-FROM debian:buster-slim
-
-RUN apt-get update && apt-get install -y --no-install-recommends \
-    curl \
-  && rm -rf /var/lib/apt/lists/*
-
-COPY onpremise/test.sh test.sh
