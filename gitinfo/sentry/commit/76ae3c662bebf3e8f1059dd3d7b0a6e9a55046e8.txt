commit 76ae3c662bebf3e8f1059dd3d7b0a6e9a55046e8
Author: Daniel Griesser <daniel.griesser.86@gmail.com>
Date:   Wed Jan 11 12:31:47 2017 +0100

    Fix BadHeaderError (#4743)
    
    * Add strip() to filename
    
    * Improve sanitization of filename in header
    
    * Join with space to allow space in filename

diff --git a/src/sentry/api/endpoints/release_file_details.py b/src/sentry/api/endpoints/release_file_details.py
index 58d50ad72b..7db5f69859 100644
--- a/src/sentry/api/endpoints/release_file_details.py
+++ b/src/sentry/api/endpoints/release_file_details.py
@@ -80,7 +80,7 @@ class ReleaseFileDetailsEndpoint(ProjectEndpoint):
             content_type=file.headers.get('content-type', 'application/octet-stream'),
         )
         response['Content-Length'] = file.size
-        response['Content-Disposition'] = 'attachment; filename="%s"' % posixpath.basename(releasefile.name)
+        response['Content-Disposition'] = 'attachment; filename="%s"' % posixpath.basename(" ".join(releasefile.name.split()))
         return response
 
     @attach_scenarios([retrieve_file_scenario])
diff --git a/tests/sentry/api/endpoints/test_release_file_details.py b/tests/sentry/api/endpoints/test_release_file_details.py
index 438e5e9b4d..f84859faa4 100644
--- a/tests/sentry/api/endpoints/test_release_file_details.py
+++ b/tests/sentry/api/endpoints/test_release_file_details.py
@@ -58,7 +58,7 @@ class ReleaseFileDetailsTest(APITestCase):
 
         from six import BytesIO
         f = File.objects.create(
-            name='application.js',
+            name='applicatiosn.js',
             type='release.file',
         )
         f.putfile(BytesIO('File contents here'))
@@ -68,7 +68,7 @@ class ReleaseFileDetailsTest(APITestCase):
             project=project,
             release=release,
             file=f,
-            name='http://example.com/application.js'
+            name='  http://example.com/appli\n\rcatios n.js\n\n\r  '
         )
 
         url = reverse('sentry-api-0-release-file-details', kwargs={
@@ -80,7 +80,7 @@ class ReleaseFileDetailsTest(APITestCase):
 
         response = self.client.get(url + '?download=1')
         assert response.status_code == 200, response.content
-        assert response.get('Content-Disposition') == 'attachment; filename="application.js"'
+        assert response.get('Content-Disposition') == 'attachment; filename="appli catios n.js"'
         assert response.get('Content-Length') == six.text_type(f.size)
         assert response.get('Content-Type') == 'application/octet-stream'
         assert 'File contents here' == BytesIO(b"".join(response.streaming_content)).getvalue()
