commit 224ae5787e10963bcf258371b748e78ec27aac84
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Apr 5 00:49:58 2012 -0700

    More team management code

diff --git a/sentry/models.py b/sentry/models.py
index 76d2b92621..2c9e8c6307 100644
--- a/sentry/models.py
+++ b/sentry/models.py
@@ -22,7 +22,7 @@ from django.contrib.auth.models import User
 from django.core.urlresolvers import reverse
 from django.db import models
 from django.db.models import F
-from django.db.models.signals import post_syncdb, post_save, post_delete
+from django.db.models.signals import post_syncdb, post_save, pre_delete
 from django.template.defaultfilters import slugify
 from django.utils.datastructures import SortedDict
 from django.utils.encoding import smart_unicode
@@ -852,7 +852,7 @@ post_save.connect(
     dispatch_uid="create_key_for_team_member",
     weak=False,
 )
-post_delete.connect(
+pre_delete.connect(
     remove_key_for_team_member,
     sender=TeamMember,
     dispatch_uid="remove_key_for_team_member",
diff --git a/sentry/permissions.py b/sentry/permissions.py
index 5af8564aae..14f54a7d4d 100644
--- a/sentry/permissions.py
+++ b/sentry/permissions.py
@@ -57,6 +57,8 @@ def can_add_team_member(user, team):
 
 
 def can_remove_team(user, team):
+    if team.project_set.exists():
+        return False
     result = plugins.first('has_perm', user, 'remove_team', team)
     if result is False and not user.has_perm('sentry.can_remove_team'):
         return False
diff --git a/sentry/templates/sentry/partial/_account_sidebar.html b/sentry/templates/sentry/partial/_account_sidebar.html
index 8ce18299a1..a1f51e9016 100644
--- a/sentry/templates/sentry/partial/_account_sidebar.html
+++ b/sentry/templates/sentry/partial/_account_sidebar.html
@@ -2,14 +2,14 @@
 
 <h6>{% trans "Account" %}</h6>
 <ul class="nav nav-tabs nav-stacked">
-    <li><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
+    <li{% if page == 'settings' %} class="active"{% endif %}><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
 </ul>
 <a href="{% url sentry-create-new-team %}" class="pull-right"><small>{% trans "New team" %}</small></a>
 <h6>{% trans "Teams" %}</h6>
 {% if TEAMS %}
     <ul class="nav nav-tabs nav-stacked">
-        {% for team in TEAMS %}
-            <li><a href="{% url sentry-manage-team team.slug %}">{{ team.name }}</a></li>
+        {% for t in TEAMS %}
+            <li{% if team and team == t %} class="active"{% endif %}><a href="{% url sentry-manage-team t.slug %}">{{ t.name }}</a></li>
         {% endfor %}
     </ul>
 {% else %}
diff --git a/sentry/templates/sentry/teams/manage.html b/sentry/templates/sentry/teams/manage.html
index b631614f54..f3f75faab9 100644
--- a/sentry/templates/sentry/teams/manage.html
+++ b/sentry/templates/sentry/teams/manage.html
@@ -6,33 +6,20 @@
 
 {% block title %}{% blocktrans with team.name as name %}Manage Team: {{ name }}{% endblocktrans %} | {{ block.super }}{% endblock %}
 
-{% block breadcrumb %}
-    {{ block.super }}
-    <li class="divider">/</li>
-    <li><a href="{% url sentry-manage-team team.slug %}">{% trans "Manage" %}</a></li>
+{% block page_header %}
+    <ul class="breadcrumb">
+        <li><a href="#">{% trans "Teams" %}</a></li>
+        {% block breadcrumb %}
+            <li class="divider">/</li>
+            <li><a href="{% url sentry-manage-team team.slug %}">{{ team.name }}</a></li>
+        {% endblock %}
+    </ul>
 {% endblock %}
 
 {% block main %}
     <section class="body">
-        <ul class="nav nav-tabs">
-            <li{% if page == 'details' %} class="active"{% endif %}>
-                <a href="{% url sentry-manage-team team.slug %}">{% trans "Details" %}</a>
-            </li>
-            {% for p in team|get_plugins %}
-                <li{% if page == 'plugin' and plugin.slug == p.slug %} class="active"{% endif %}>
-                    <a href="{% url sentry-configure-team-plugin team.slug p.slug %}">{{ p.get_title }}</a>
-                </li>
-            {% endfor %}
-            <li class="pull-right{% if page == 'plugins' %} active{% endif %}">
-                <a href="{% url sentry-manage-team-plugins team.slug %}">{% trans "Manage Plugins" %}</a>
-            </li>
-        </ul>
         {% block inner %}
             <p>{% trans "Here you can edit team information, as well as control the access list for a team with fine-grained permissions." %}</p>
-            <hr>
-            <div class="page-header">
-                <h2>{% trans "Team Details" %}</h2>
-            </div>
             {% if request.GET.success %}
                 <div class="alert alert-success">{% trans "Changes to your team were saved successfully." %}</div>
             {% else %}
@@ -49,7 +36,11 @@
                 </fieldset>
                 <fieldset class="form-actions">
                     <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
-                    <a href="{% url sentry-remove-team team.slug %}" class="btn btn-danger">{% trans "Remove Team" %}</a>
+                    {% if can_remove_team %}
+                        <a href="{% url sentry-remove-team team.slug %}" class="btn btn-danger">{% trans "Remove Team" %}</a>
+                    {% else %}
+                        <a class="btn btn-danger disabled">{% trans "Cannot remove teams assigned to projects" %}</a>
+                    {% endif %}
                 </fieldset>
             </form>
             <div class="page-header">
@@ -148,3 +139,7 @@
         {% endblock %}
     </section>
 {% endblock %}
+
+{% block sidebar %}
+    {% include "sentry/partial/_account_sidebar.html" %}
+{% endblock %}
diff --git a/sentry/templates/sentry/teams/remove.html b/sentry/templates/sentry/teams/remove.html
new file mode 100644
index 0000000000..2bc5d53ecb
--- /dev/null
+++ b/sentry/templates/sentry/teams/remove.html
@@ -0,0 +1,36 @@
+{% extends "sentry/teams/manage.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Remove Team" %} | {{ block.super }}{% endblock %}
+
+{% block breadcrumb %}
+    {{ block.super }}
+    <li class="divider">/</li>
+    <li><a href="{% url sentry-remove-team team.slug %}">{% trans "Remove Team" %}</a></li>
+{% endblock %}
+
+{% block main %}
+    <section class="body">
+        <form action="" method="post">
+            <p>{% trans "Are you sure you wish to remove this team? This change is permanent!" %}</p>
+            {% csrf_token %}
+            {% if form.non_field_errors %}
+                <div class="alert alert-block alert-error">
+                    <p>{% trans "There were errors saving your changes:" %}</p>
+                    <ul>
+                        {% for error in form.non_field_errors %}
+                            <li>{{ error }}</li>
+                        {% endfor %}
+                    </ul>
+                </div>
+            {% endif %}
+            {% for field in form %}
+                {% include "sentry/partial/_form_field.html" %}
+            {% endfor %}
+            <fieldset class="form-actions">
+                <button type="submit" class="btn btn-danger">{% trans "Confirm" %}</button> <a href="{% url sentry-manage-team team.slug %}" class="btn">{% trans "Cancel" %}</a>
+            </fieldset>
+        </form>
+    </section>
+{% endblock %}
diff --git a/sentry/web/forms/__init__.py b/sentry/web/forms/__init__.py
index 3e775e8727..be8c30fb01 100644
--- a/sentry/web/forms/__init__.py
+++ b/sentry/web/forms/__init__.py
@@ -23,9 +23,11 @@ class RemoveProjectForm(forms.Form):
         ('3', _('Hide this project.')),
     ), widget=forms.RadioSelect(renderer=RadioFieldRenderer))
     project = forms.ChoiceField(choices=(), required=False)
+    password = forms.CharField(label=_("Password"), widget=forms.PasswordInput, help_text=_("Confirm your identify by entering your password."))
 
-    def __init__(self, project_list, *args, **kwargs):
+    def __init__(self, user, project_list, *args, **kwargs):
         super(RemoveProjectForm, self).__init__(*args, **kwargs)
+        self.user = user
         if not project_list:
             del self.fields['project']
             self.fields['removal_type'].choices = filter(lambda x: x[0] != '2', self.fields['removal_type'].choices)
@@ -43,6 +45,15 @@ class RemoveProjectForm(forms.Form):
         project_id = self.cleaned_data['project']
         return Project.objects.get_from_cache(id=project_id)
 
+    def clean_password(self):
+        """
+        Validates that the old_password field is correct.
+        """
+        old_password = self.cleaned_data["old_password"]
+        if not self.user.check_password(old_password):
+            raise forms.ValidationError(_("Your password was entered incorrectly. Please enter it again."))
+        return old_password
+
 
 class NewProjectForm(forms.ModelForm):
     class Meta:
diff --git a/sentry/web/forms/teams.py b/sentry/web/forms/teams.py
index 525a3f95e5..0c637c2992 100644
--- a/sentry/web/forms/teams.py
+++ b/sentry/web/forms/teams.py
@@ -12,6 +12,10 @@ from sentry.web.forms.fields import UserField
 from django.utils.translation import ugettext_lazy as _
 
 
+class RemoveTeamForm(forms.Form):
+    pass
+
+
 class NewTeamForm(forms.ModelForm):
     class Meta:
         fields = ('name', 'slug')
@@ -77,6 +81,6 @@ class NewTeamMemberForm(BaseTeamMemberForm):
             return None
 
         if self.project.member_set.filter(user=value).exists():
-            raise forms.ValidationError(_('User already a member of project'))
+            raise forms.ValidationError(_('User is already a member of this team'))
 
-        return value
\ No newline at end of file
+        return value
diff --git a/sentry/web/frontend/accounts.py b/sentry/web/frontend/accounts.py
index 69a9d8cf2e..a61c73149c 100644
--- a/sentry/web/frontend/accounts.py
+++ b/sentry/web/frontend/accounts.py
@@ -63,5 +63,6 @@ def settings(request):
     context = csrf(request)
     context.update({
         'form': form,
+        'page': 'settings',
     })
     return render_to_response('sentry/account/settings.html', context, request)
diff --git a/sentry/web/frontend/projects.py b/sentry/web/frontend/projects.py
index 1c4bff74c8..5193172e26 100644
--- a/sentry/web/frontend/projects.py
+++ b/sentry/web/frontend/projects.py
@@ -83,7 +83,7 @@ def remove_project(request, project):
 
     project_list = filter(lambda x: x != project, get_project_list(request.user).itervalues())
 
-    form = RemoveProjectForm(project_list, request.POST or None)
+    form = RemoveProjectForm(request.user, project_list, request.POST or None)
 
     if form.is_valid():
         removal_type = form.cleaned_data['removal_type']
diff --git a/sentry/web/frontend/teams.py b/sentry/web/frontend/teams.py
index a87010fb74..bdab40a183 100644
--- a/sentry/web/frontend/teams.py
+++ b/sentry/web/frontend/teams.py
@@ -15,7 +15,8 @@ from sentry.permissions import can_add_team_member, can_remove_team
 from sentry.plugins import plugins
 from sentry.web.decorators import login_required, has_team_access
 from sentry.web.forms.teams import NewTeamForm, NewTeamAdminForm, \
-  EditTeamForm, EditTeamMemberForm, NewTeamMemberForm, InviteTeamMemberForm
+  EditTeamForm, EditTeamMemberForm, NewTeamMemberForm, InviteTeamMemberForm, \
+  RemoveTeamForm
 from sentry.web.helpers import render_to_response
 
 
@@ -54,7 +55,6 @@ def create_new_team(request):
     return render_to_response('sentry/teams/new.html', context, request)
 
 
-@login_required
 @has_team_access(MEMBER_OWNER)
 @csrf_protect
 def manage_team(request, team):
@@ -62,7 +62,7 @@ def manage_team(request, team):
     if result is False and not request.user.has_perm('sentry.can_change_team'):
         return HttpResponseRedirect(reverse('sentry'))
 
-    form = EditTeamForm(request, request.POST or None, instance=team)
+    form = EditTeamForm(request.POST or None, instance=team)
 
     if form.is_valid():
         team = form.save()
@@ -84,6 +84,27 @@ def manage_team(request, team):
     return render_to_response('sentry/teams/manage.html', context, request)
 
 
+@has_team_access(MEMBER_OWNER)
+@csrf_protect
+def remove_team(request, team):
+    if not can_remove_team(request.user, team):
+        return HttpResponseRedirect(reverse('sentry'))
+
+    form = RemoveTeamForm(request.POST or None)
+
+    if form.is_valid():
+        team.delete()
+        return HttpResponseRedirect(reverse('sentry-team-list'))
+
+    context = csrf(request)
+    context.update({
+        'form': form,
+        'team': team,
+    })
+
+    return render_to_response('sentry/teams/remove.html', context, request)
+
+
 @csrf_protect
 @has_team_access(MEMBER_OWNER)
 def new_team_member(request, team):
@@ -284,4 +305,3 @@ def reinvite_pending_team_member(request, team, member_id):
     member.send_invite_email()
 
     return HttpResponseRedirect(reverse('sentry-manage-team', args=[team.slug]) + '?success=1')
-
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index ebde4837bd..519e4c64fd 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -50,6 +50,8 @@ urlpatterns = patterns('',
     url(r'^account/teams/new/$', teams.create_new_team, name='sentry-create-new-team'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/edit/$', teams.manage_team,
         name='sentry-manage-team'),
+    url(r'^account/teams/(?P<team_slug>[\w_-]+)/remove/$', teams.remove_team,
+        name='sentry-remove-team'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/members/new/$', teams.new_team_member,
         name='sentry-new-team-member'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/members/(?P<member_id>\d+)/edit/$', teams.edit_team_member,
