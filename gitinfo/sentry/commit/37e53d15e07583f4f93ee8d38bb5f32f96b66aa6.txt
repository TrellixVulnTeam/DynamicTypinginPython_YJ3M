commit 37e53d15e07583f4f93ee8d38bb5f32f96b66aa6
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Wed Apr 3 21:00:50 2019 +0200

    build: Restructure symbolicator tests to not be mocked (#12617)
    
    * build: Restructure symbolicator tests to not be mocked
    
    * ref: Restore test order to minimize diff
    
    * ref: Rewrite snapshots to unbreak source paths
    
    * fix: Add missing services to travis
    
    * build: Try to fix networking stuff in travis
    
    * fix: Pass right arguments to docker run
    
    * fix: Add name for symbolicator build
    
    * fix: Fix testsuite in face of symbolicator changes
    
    * fix: Revert accidental changes to pytest plugin
    
    * build: Pin symbolicator image
    
    * fix: Remove flaky test

diff --git a/.travis.yml b/.travis.yml
index 909bdbf9e5..f33b88c50c 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -243,6 +243,23 @@ matrix:
         - nvm install
         - npm install -g "yarn@${YARN_VERSION}"
 
+    - python: 2.7
+      name: 'Symbolicator Integration'
+      env: TEST_SUITE=symbolicator
+      services:
+        - docker
+        - memcached
+        - redis-server
+        - postgresql
+      before_install:
+        - docker run -d --network host --name symbolicator us.gcr.io/sentryio/symbolicator:088c09f8b1c00bdb8e0009a985f6a0d4abd9b372 run
+        - docker ps -a
+      install:
+        - python setup.py install_egg_info
+        - pip install -e ".[dev,tests,optional]"
+      before_script:
+        - psql -c 'create database sentry;' -U postgres
+
     # snuba in testing
     - python: 2.7
       name: 'Snuba Integration'
diff --git a/Makefile b/Makefile
index 2298f7a80d..032abbbaa6 100644
--- a/Makefile
+++ b/Makefile
@@ -145,6 +145,11 @@ test-snuba:
 	py.test tests/snuba tests/sentry/eventstream/kafka -vv --cov . --cov-report="xml:.artifacts/snuba.coverage.xml" --junit-xml=".artifacts/snuba.junit.xml"
 	@echo ""
 
+test-symbolicator:
+	@echo "--> Running symbolicator tests"
+	py.test tests/symbolicator -vv --cov . --cov-report="xml:.artifacts/symbolicator.coverage.xml" --junit-xml=".artifacts/symbolicator.junit.xml"
+	@echo ""
+
 test-acceptance: node-version-check
 	sentry init
 	make build-platform-assets
@@ -182,7 +187,7 @@ publish:
 	python setup.py sdist bdist_wheel upload
 
 
-.PHONY: develop develop-only test build test reset-db clean setup-git update-submodules node-version-check install-system-pkgs install-yarn-pkgs install-sentry-dev build-js-po locale update-transifex build-platform-assets test-cli test-js test-styleguide test-python test-snuba test-acceptance lint lint-python lint-js publish
+.PHONY: develop develop-only test build test reset-db clean setup-git update-submodules node-version-check install-system-pkgs install-yarn-pkgs install-sentry-dev build-js-po locale update-transifex build-platform-assets test-cli test-js test-styleguide test-python test-snuba test-symbolicator test-acceptance lint lint-python lint-js publish
 
 
 ############################
@@ -196,12 +201,13 @@ travis-noop:
 .PHONY: travis-test-lint
 travis-test-lint: lint-python lint-js
 
-.PHONY: travis-test-sqlite travis-test-postgres travis-test-mysql travis-test-acceptance travis-test-snuba travis-test-js travis-test-cli travis-test-dist
+.PHONY: travis-test-sqlite travis-test-postgres travis-test-mysql travis-test-acceptance travis-test-snuba travis-test-symbolicator travis-test-js travis-test-cli travis-test-dist
 travis-test-sqlite: test-python
 travis-test-postgres: test-python
 travis-test-mysql: test-python
 travis-test-acceptance: test-acceptance
 travis-test-snuba: test-snuba
+travis-test-symbolicator: test-symbolicator
 travis-test-js: test-js
 travis-test-cli: test-cli
 travis-test-dist:
@@ -212,7 +218,7 @@ travis-test-dist:
 	SENTRY_BUILD=$(TRAVIS_COMMIT) SENTRY_LIGHT_BUILD=0 python setup.py -q sdist bdist_wheel
 	@ls -lh dist/
 
-.PHONY: scan-python travis-scan-sqlite travis-scan-postgres travis-scan-mysql travis-scan-acceptance travis-scan-snuba travis-scan-js travis-scan-cli travis-scan-dist travis-scan-lint
+.PHONY: scan-python travis-scan-sqlite travis-scan-postgres travis-scan-mysql travis-scan-acceptance travis-scan-snuba travis-scan-symbolicator travis-scan-js travis-scan-cli travis-scan-dist travis-scan-lint
 scan-python:
 	@echo "--> Running Python vulnerability scanner"
 	$(PIP) install safety
@@ -224,6 +230,7 @@ travis-scan-postgres: scan-python
 travis-scan-mysql: scan-python
 travis-scan-acceptance: travis-noop
 travis-scan-snuba: scan-python
+travis-scan-symbolicator: travis-noop
 travis-scan-js: travis-noop
 travis-scan-cli: travis-noop
 travis-scan-dist: travis-noop
diff --git a/requirements-test.txt b/requirements-test.txt
index 2f012bfc80..a11304b5aa 100644
--- a/requirements-test.txt
+++ b/requirements-test.txt
@@ -1,4 +1,3 @@
-betamax>=0.8.1,<0.9.0
 # cassandra
 blist
 # TODO(dcramer): figure out why Travis needs this
diff --git a/src/sentry/lang/native/plugin.py b/src/sentry/lang/native/plugin.py
index 21ff8f39ea..ac691f54e0 100644
--- a/src/sentry/lang/native/plugin.py
+++ b/src/sentry/lang/native/plugin.py
@@ -255,6 +255,8 @@ class NativeStacktraceProcessor(StacktraceProcessor):
             status = fetched_debug_file.pop('status')
             # Set image data from symbolicator as symbolicator might know more
             # than the SDK, especially for minidumps
+            if fetched_debug_file.get('arch') == 'unknown':
+                fetched_debug_file.pop('arch')
             image.update(fetched_debug_file)
 
             if status in ('found', 'unused'):
diff --git a/src/sentry/options/defaults.py b/src/sentry/options/defaults.py
index 88ee554e1f..04faf62004 100644
--- a/src/sentry/options/defaults.py
+++ b/src/sentry/options/defaults.py
@@ -118,7 +118,7 @@ register(
 register('symbolicator.enabled', default=False, flags=FLAG_ALLOW_EMPTY | FLAG_PRIORITIZE_DISK)
 register(
     'symbolicator.options',
-    default={'url': 'http://127.0.0.1:3021'},
+    default={'url': 'http://localhost:3021'},
     flags=FLAG_ALLOW_EMPTY | FLAG_PRIORITIZE_DISK,
 )
 
diff --git a/src/sentry/utils/pytest/sentry.py b/src/sentry/utils/pytest/sentry.py
index bdc9f888ac..c147aefe15 100644
--- a/src/sentry/utils/pytest/sentry.py
+++ b/src/sentry/utils/pytest/sentry.py
@@ -3,7 +3,6 @@ from __future__ import absolute_import
 import pytest
 import mock
 import os
-import betamax
 
 from django.conf import settings
 from sentry_sdk import Hub
@@ -199,10 +198,6 @@ def pytest_configure(config):
     from sentry import http
     http.DISALLOWED_IPS = set()
 
-    with betamax.Betamax.configure() as config:
-        config.cassette_library_dir = 'tests/betamax/'
-        config.default_cassette_options['match_requests_on'] = ['method', 'path']
-
 
 def register_extensions():
     from sentry.plugins import plugins
diff --git a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_debug_id_resolving.json b/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_debug_id_resolving.json
deleted file mode 100644
index b74ee3d554..0000000000
--- a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_debug_id_resolving.json
+++ /dev/null
@@ -1 +0,0 @@
-{"http_interactions": [{"request": {"body": {"string": "{\"sources\": [{\"url\": \"http://localhost:8081/api/0/projects/baz/bar/files/dsyms/\", \"token\": \"1046795e1f8f4e23a819b0afd5d1edce\", \"type\": \"sentry\", \"id\": \"sentry-project-difs\"}, {\"layout\": \"symstore\", \"url\": \"https://msdl.microsoft.com/download/symbols/\", \"filetypes\": [\"pdb\", \"pe\"], \"is_public\": true, \"type\": \"http\", \"id\": \"microsoft\"}], \"signal\": null, \"request\": {\"timeout\": 5}, \"modules\": [{\"code_file\": \"C:\\\\projects\\\\breakpad-tools\\\\windows\\\\Release\\\\crash.exe\", \"debug_id\": \"3249d99d-0c40-4931-8610-f4e4fb0b6936-1\", \"type\": \"symbolic\", \"image_addr\": \"0x2a0000\", \"image_size\": 36864}], \"stacktraces\": [{\"frames\": [{\"trust\": null, \"instruction_addr\": \"0x2a2a3d\"}], \"registers\": {}}]}", "encoding": "utf-8"}, "headers": {"Content-Length": ["682"], "Accept-Encoding": ["gzip, deflate"], "Accept": ["*/*"], "User-Agent": ["python-requests/2.20.1"], "Connection": ["keep-alive"], "Content-Type": ["application/json"]}, "method": "POST", "uri": "http://127.0.0.1:3021/symbolicate?timeout=5&scope=12"}, "response": {"body": {"base64_string": "H4sIAAAAAAAE/6WRwW6DMAyG3yXnUdHCUOG6N9h1VMgkhmYEByVBbVfx7jMUqu02aZySH/v3l9934QOE0YtCSNsPBgMq8SK8bgmMKGg0hm8BZBccSOS6j7toHPTrUZMPbpRBW6pAKcc+8fUAB0hmmwFkBy2y+FaU5eDsJ8rgy7J2CN0AKgrWGr5fNCl74cM7GgSPZSkd+PMOr8gwBqh9otz62jKY6EET/2tGWobziE3RBon5VmUnh4HroPbVAOHMqvwbykJQlrPr6mE0IVlRJK8cya3/9d58H/MU63SrCUylSeFVFDEXbvH6hVxLmBOeTtPpRfRWjWYN8rmGxo6k2CvcBmTarY0VcHLmH6kjeyEWFNZjW2nFZckhzVWeqyiWaRylebKPjtk+jpoU06aO6yxPsmjPPdIqXFpoWe3DouHMtoTlXPAQxH+2pnve/M+MYv4Y4KF7/YWcZHbM0uk0fQPIYjMjhgIAAA==", "encoding": null}, "headers": {"date": ["Mon, 01 Apr 2019 09:52:40 GMT"], "content-length": ["361"], "content-type": ["application/json"], "content-encoding": ["gzip"]}, "status": {"message": "OK", "code": 200}, "url": "http://127.0.0.1:3021/symbolicate?timeout=5&scope=12"}, "recorded_at": "2019-04-01T09:52:40"}], "recorded_with": "betamax/0.8.1"}
diff --git a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_missing_dsym.json b/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_missing_dsym.json
deleted file mode 100644
index 5691d73fbc..0000000000
--- a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_missing_dsym.json
+++ /dev/null
@@ -1 +0,0 @@
-{"http_interactions": [{"request": {"body": {"string": "{\"sources\": [{\"url\": \"http://localhost:8081/api/0/projects/baz/bar/files/dsyms/\", \"token\": \"f19caa13ba80489fbf3685e421b71d56\", \"type\": \"sentry\", \"id\": \"sentry-project-difs\"}, {\"layout\": \"symstore\", \"url\": \"https://msdl.microsoft.com/download/symbols/\", \"filetypes\": [\"pdb\", \"pe\"], \"is_public\": true, \"type\": \"http\", \"id\": \"microsoft\"}], \"signal\": null, \"request\": {\"timeout\": 5}, \"modules\": [{\"code_file\": \"Foo.app/Contents/Foo\", \"arch\": \"x86_64\", \"image_vmaddr\": \"0x100000000\", \"image_addr\": \"0x100000000\", \"image_size\": 4096, \"type\": \"macho\", \"debug_id\": \"502fc0a5-1ec1-3e47-9998-684fa139dca7\"}], \"stacktraces\": [{\"frames\": [{\"trust\": null, \"instruction_addr\": \"0x100000fa0\"}], \"registers\": {}}]}", "encoding": "utf-8"}, "headers": {"Content-Length": ["694"], "Accept-Encoding": ["gzip, deflate"], "Accept": ["*/*"], "User-Agent": ["python-requests/2.20.1"], "Connection": ["keep-alive"], "Content-Type": ["application/json"]}, "method": "POST", "uri": "http://127.0.0.1:3021/symbolicate?timeout=5&scope=13"}, "response": {"body": {"base64_string": "H4sIAAAAAAAE/21Ry27CMBD8lz2TkpQQCNdK/YkKWYsfwcJeR7EjQVH+vUsSc6pPnn3M7sw+ISZMY4QTyOB7p5NWsIFoO0IHJxqdY5RQ3tKAUnPdzxPMgH79WoppGGWygQQqNTBPea/K1zNYMlOP8oadzlQOqcv/+PCX8B5iRpppctZYp4nnZIyXKHpM14ydJU0hI+Za5y8rh8F2ltAJS0rf4VTOKhah3sZoqRNKX8ZOGJ4D03k6b8AHNbpV2NuWf6o3kB49SwKP8hpYJA6S94L7sRFNzVjNzFaxG/vy08gS90WlZVXsdH0o2rY9Fs2xNljtWiXxwB0yKC1eDTQ7vhDMq603kK+CJQDfIXxg32+/AiVNKW45wBzWs9GrC5CvwJd4p6L95a3rsm2m8/QHhiAHbPoBAAA=", "encoding": null}, "headers": {"date": ["Mon, 01 Apr 2019 09:52:43 GMT"], "content-length": ["311"], "content-type": ["application/json"], "content-encoding": ["gzip"]}, "status": {"message": "OK", "code": 200}, "url": "http://127.0.0.1:3021/symbolicate?timeout=5&scope=13"}, "recorded_at": "2019-04-01T09:52:43"}], "recorded_with": "betamax/0.8.1"}
diff --git a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_real_resolving.json b/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_real_resolving.json
deleted file mode 100644
index a8bdff4159..0000000000
--- a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_real_resolving.json
+++ /dev/null
@@ -1 +0,0 @@
-{"http_interactions": [{"request": {"body": {"string": "{\"sources\": [{\"url\": \"http://localhost:8081/api/0/projects/baz/bar/files/dsyms/\", \"token\": \"ebf401209574487ea7fb5f051739ca9d\", \"type\": \"sentry\", \"id\": \"sentry-project-difs\"}, {\"layout\": \"symstore\", \"url\": \"https://msdl.microsoft.com/download/symbols/\", \"filetypes\": [\"pdb\", \"pe\"], \"is_public\": true, \"type\": \"http\", \"id\": \"microsoft\"}], \"signal\": null, \"request\": {\"timeout\": 5}, \"modules\": [{\"code_file\": \"Foo.app/Contents/Foo\", \"arch\": \"x86_64\", \"image_vmaddr\": \"0x100000000\", \"image_addr\": \"0x100000000\", \"image_size\": 4096, \"type\": \"macho\", \"debug_id\": \"502fc0a5-1ec1-3e47-9998-684fa139dca7\"}], \"stacktraces\": [{\"frames\": [{\"trust\": null, \"instruction_addr\": \"0x100000fa0\"}], \"registers\": {}}]}", "encoding": "utf-8"}, "headers": {"Content-Length": ["694"], "Accept-Encoding": ["gzip, deflate"], "Accept": ["*/*"], "User-Agent": ["python-requests/2.20.1"], "Connection": ["keep-alive"], "Content-Type": ["application/json"]}, "method": "POST", "uri": "http://127.0.0.1:3021/symbolicate?timeout=5&scope=14"}, "response": {"body": {"base64_string": "H4sIAAAAAAAE/21R0W7CMAz8lzxT2o5SaF8n7ScmVBknLRGJEzWJBEP997kUNgmRp/hsn8/nmwgRYgqiFeisNyoqKVYi6IHAiJaSMRxFwHMcARXXfd9EP4J9fDWFOCaM2lEHUo7MU1zKYn49FMzkAc8wKMa/nFuD9/mno6gohpwBLjBAA2eRv+Fqj46nCguaOO4T4czM6SeijSIezshJGePWcxscQ+chnhjMo/X5f8ZoUuREW/IOV/teoBv1oAlMp0mqi2gLrn1asgjSCLMr02E6rIR1MpnH8n/W9S6RZMHx6hWrsIAnxyGMOIu67OuurjiW6piGTksu2RYfPRawzUqFZbZR1S5rmmaf1fuqh3LTSIQdd6CT6t5A90MsBL02PGVBcC5YAMF+vjNYW/b/dXc+ENMvqaB/mK8qmno6TL8VmA1fEQIAAA==", "encoding": null}, "headers": {"date": ["Mon, 01 Apr 2019 09:52:45 GMT"], "content-length": ["328"], "content-type": ["application/json"], "content-encoding": ["gzip"]}, "status": {"message": "OK", "code": 200}, "url": "http://127.0.0.1:3021/symbolicate?timeout=5&scope=14"}, "recorded_at": "2019-04-01T09:52:45"}], "recorded_with": "betamax/0.8.1"}
diff --git a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_real_resolving_with_multiple_requests.json b/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_real_resolving_with_multiple_requests.json
deleted file mode 100644
index d4583f3e7d..0000000000
--- a/tests/betamax/tests.sentry.lang.native.test_plugin.SymbolicatorResolvingIntegrationTest.test_real_resolving_with_multiple_requests.json
+++ /dev/null
@@ -1 +0,0 @@
-{"http_interactions": [{"request": {"body": {"string": "{\"sources\": [{\"url\": \"http://localhost:8081/api/0/projects/baz/bar/files/dsyms/\", \"token\": \"64df1a49430f46d985cae3980ba129ef\", \"type\": \"sentry\", \"id\": \"sentry-project-difs\"}, {\"layout\": \"symstore\", \"url\": \"https://msdl.microsoft.com/download/symbols/\", \"filetypes\": [\"pdb\", \"pe\"], \"is_public\": true, \"type\": \"http\", \"id\": \"microsoft\"}], \"signal\": null, \"request\": {\"timeout\": 0}, \"modules\": [{\"code_file\": \"Foo.app/Contents/Foo\", \"arch\": \"x86_64\", \"image_vmaddr\": \"0x100000000\", \"image_addr\": \"0x100000000\", \"image_size\": 4096, \"type\": \"macho\", \"debug_id\": \"502fc0a5-1ec1-3e47-9998-684fa139dca7\"}], \"stacktraces\": [{\"frames\": [{\"trust\": null, \"instruction_addr\": \"0x100000fa0\"}], \"registers\": {}}]}", "encoding": "utf-8"}, "headers": {"Content-Length": ["694"], "Accept-Encoding": ["gzip, deflate"], "Accept": ["*/*"], "User-Agent": ["python-requests/2.20.1"], "Connection": ["keep-alive"], "Content-Type": ["application/json"]}, "method": "POST", "uri": "http://127.0.0.1:3021/symbolicate?timeout=0&scope=15"}, "response": {"body": {"string": "{\"status\":\"pending\",\"request_id\":\"b907f7ab-d8c3-4169-9b08-453591101f2c\",\"retry_after\":30}", "encoding": null}, "headers": {"date": ["Mon, 01 Apr 2019 09:52:47 GMT"], "content-length": ["89"], "content-type": ["application/json"]}, "status": {"message": "OK", "code": 200}, "url": "http://127.0.0.1:3021/symbolicate?timeout=0&scope=15"}, "recorded_at": "2019-04-01T09:52:47"}, {"request": {"body": {"string": "", "encoding": "utf-8"}, "headers": {"Connection": ["keep-alive"], "Accept-Encoding": ["gzip, deflate"], "Accept": ["*/*"], "User-Agent": ["python-requests/2.20.1"]}, "method": "GET", "uri": "http://127.0.0.1:3021/requests/b907f7ab-d8c3-4169-9b08-453591101f2c?timeout=0"}, "response": {"body": {"string": "{\"status\":\"pending\",\"request_id\":\"b907f7ab-d8c3-4169-9b08-453591101f2c\",\"retry_after\":30}", "encoding": null}, "headers": {"date": ["Mon, 01 Apr 2019 09:52:47 GMT"], "content-length": ["89"], "content-type": ["application/json"]}, "status": {"message": "OK", "code": 200}, "url": "http://127.0.0.1:3021/requests/b907f7ab-d8c3-4169-9b08-453591101f2c?timeout=0"}, "recorded_at": "2019-04-01T09:52:47"}, {"request": {"body": {"string": "", "encoding": "utf-8"}, "headers": {"Connection": ["keep-alive"], "Accept-Encoding": ["gzip, deflate"], "Accept": ["*/*"], "User-Agent": ["python-requests/2.20.1"]}, "method": "GET", "uri": "http://127.0.0.1:3021/requests/b907f7ab-d8c3-4169-9b08-453591101f2c?timeout=0"}, "response": {"body": {"base64_string": "H4sIAAAAAAAE/21R0W7CMAz8lzxT2o5SaF8n7ScmVBknLRGJEzWJBEP997kUNgmRp/hsn8/nmwgRYgqiFeisNyoqKVYi6IHAiJaSMRxFwHMcARXXfd9EP4J9fDWFOCaM2lEHUo7MU1zKYn49FMzkAc8wKMa/nFuD9/mno6gohpwBLjBAA2eRv+Fqj46nCguaOO4T4czM6SeijSIezshJGePWcxscQ+chnhjMo/X5f8ZoUuREW/IOV/teoBv1oAlMp0mqi2gLrn1asgjSCLMr02E6rIR1MpnH8n/W9S6RZMHx6hWrsIAnxyGMOIu67OuurjiW6piGTksu2RYfPRawzUqFZbZR1S5rmmaf1fuqh3LTSIQdd6CT6t5A90MsBL02PGVBcC5YAMF+vjNYW/b/dXc+ENMvqaB/mK8qmno6TL8VmA1fEQIAAA==", "encoding": null}, "headers": {"date": ["Mon, 01 Apr 2019 09:52:47 GMT"], "content-length": ["328"], "content-type": ["application/json"], "content-encoding": ["gzip"]}, "status": {"message": "OK", "code": 200}, "url": "http://127.0.0.1:3021/requests/b907f7ab-d8c3-4169-9b08-453591101f2c?timeout=0"}, "recorded_at": "2019-04-01T09:52:47"}], "recorded_with": "betamax/0.8.1"}
diff --git a/tests/sentry/lang/native/fixtures/hello.dsym b/tests/symbolicator/fixtures/hello.dsym
similarity index 100%
rename from tests/sentry/lang/native/fixtures/hello.dsym
rename to tests/symbolicator/fixtures/hello.dsym
diff --git a/tests/sentry/lang/native/fixtures/linux.cficache b/tests/symbolicator/fixtures/linux.cficache
similarity index 100%
rename from tests/sentry/lang/native/fixtures/linux.cficache
rename to tests/symbolicator/fixtures/linux.cficache
diff --git a/tests/sentry/lang/native/fixtures/linux.dmp b/tests/symbolicator/fixtures/linux.dmp
similarity index 100%
rename from tests/sentry/lang/native/fixtures/linux.dmp
rename to tests/symbolicator/fixtures/linux.dmp
diff --git a/tests/sentry/lang/native/fixtures/macos.dmp b/tests/symbolicator/fixtures/macos.dmp
similarity index 100%
rename from tests/sentry/lang/native/fixtures/macos.dmp
rename to tests/symbolicator/fixtures/macos.dmp
diff --git a/tests/sentry/lang/native/fixtures/windows.dmp b/tests/symbolicator/fixtures/windows.dmp
similarity index 100%
rename from tests/sentry/lang/native/fixtures/windows.dmp
rename to tests/symbolicator/fixtures/windows.dmp
diff --git a/tests/sentry/lang/native/fixtures/windows.sym b/tests/symbolicator/fixtures/windows.sym
similarity index 100%
rename from tests/sentry/lang/native/fixtures/windows.sym
rename to tests/symbolicator/fixtures/windows.sym
diff --git a/tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
similarity index 94%
rename from tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
rename to tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
index 8fd0ceec85..8661578b98 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T13:57:47.289476Z'
+created: '2019-04-02T14:12:16.040240Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 contexts:
   device:
diff --git a/tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
similarity index 94%
rename from tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
rename to tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
index 7e38dcc265..8a1bd626b8 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T13:57:48.442366Z'
+created: '2019-04-02T14:12:16.775814Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 culprit: unknown
 debug_meta:
diff --git a/tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
similarity index 93%
rename from tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
rename to tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
index e626c36399..b984a7eabb 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T13:57:49.268992Z'
+created: '2019-04-02T14:12:17.205926Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 culprit: main
 debug_meta:
diff --git a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
similarity index 94%
rename from tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
rename to tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
index 7bbe2f7aab..593fcd4be5 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T16:17:33.768481Z'
+created: '2019-04-03T16:41:36.274604Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 contexts:
   device:
@@ -15,7 +15,7 @@ contexts:
 culprit: main
 debug_meta:
   images:
-  - arch: unknown
+  - arch: x86
     code_file: C:\projects\breakpad-tools\windows\Release\crash.exe
     code_id: null
     debug_file: null
diff --git a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
similarity index 94%
rename from tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
rename to tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
index 0f0428c498..0f7f17b81c 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T16:44:06.691058Z'
+created: '2019-04-02T14:12:18.601497Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 culprit: unknown
 debug_meta:
diff --git a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
similarity index 93%
rename from tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
rename to tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
index 192aeb9acd..a43d505a46 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T16:17:40.223840Z'
+created: '2019-04-02T14:12:19.202363Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 culprit: main
 debug_meta:
diff --git a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving_with_multiple_requests.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving_with_multiple_requests.pysnap
similarity index 93%
rename from tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving_with_multiple_requests.pysnap
rename to tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving_with_multiple_requests.pysnap
index e9d0e0db57..5be344a7fb 100644
--- a/tests/sentry/lang/native/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving_with_multiple_requests.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving_with_multiple_requests.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-04-01T16:17:43.289893Z'
+created: '2019-04-02T14:12:19.938357Z'
 creator: sentry
-source: tests/sentry/lang/native/test_plugin.py
+source: tests/symbolicator/test_native_plugin.py
 ---
 culprit: main
 debug_meta:
diff --git a/tests/sentry/lang/native/snapshots/test_minidump/test_minidump_linux.pysnap b/tests/symbolicator/snapshots/test_minidump/test_minidump_linux.pysnap
similarity index 98%
rename from tests/sentry/lang/native/snapshots/test_minidump/test_minidump_linux.pysnap
rename to tests/symbolicator/snapshots/test_minidump/test_minidump_linux.pysnap
index d49b25f58f..0216611cef 100644
--- a/tests/sentry/lang/native/snapshots/test_minidump/test_minidump_linux.pysnap
+++ b/tests/symbolicator/snapshots/test_minidump/test_minidump_linux.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-03-21T13:58:25.633488Z'
+created: '2019-04-02T14:12:11.021596Z'
 creator: sentry
-source: tests/sentry/lang/native/test_minidump.py
+source: tests/symbolicator/test_minidump.py
 ---
 contexts:
   device:
diff --git a/tests/sentry/lang/native/snapshots/test_minidump/test_minidump_macos.pysnap b/tests/symbolicator/snapshots/test_minidump/test_minidump_macos.pysnap
similarity index 99%
rename from tests/sentry/lang/native/snapshots/test_minidump/test_minidump_macos.pysnap
rename to tests/symbolicator/snapshots/test_minidump/test_minidump_macos.pysnap
index f9385847c3..7eb0315580 100644
--- a/tests/sentry/lang/native/snapshots/test_minidump/test_minidump_macos.pysnap
+++ b/tests/symbolicator/snapshots/test_minidump/test_minidump_macos.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-03-21T13:58:25.667837Z'
+created: '2019-04-02T14:12:11.068611Z'
 creator: sentry
-source: tests/sentry/lang/native/test_minidump.py
+source: tests/symbolicator/test_minidump.py
 ---
 contexts:
   device:
diff --git a/tests/sentry/lang/native/snapshots/test_minidump/test_minidump_windows.pysnap b/tests/symbolicator/snapshots/test_minidump/test_minidump_windows.pysnap
similarity index 98%
rename from tests/sentry/lang/native/snapshots/test_minidump/test_minidump_windows.pysnap
rename to tests/symbolicator/snapshots/test_minidump/test_minidump_windows.pysnap
index ba65ef822a..fc46f3eb94 100644
--- a/tests/sentry/lang/native/snapshots/test_minidump/test_minidump_windows.pysnap
+++ b/tests/symbolicator/snapshots/test_minidump/test_minidump_windows.pysnap
@@ -1,7 +1,7 @@
 ---
-created: '2019-03-21T13:58:25.694809Z'
+created: '2019-04-02T14:12:11.098942Z'
 creator: sentry
-source: tests/sentry/lang/native/test_minidump.py
+source: tests/symbolicator/test_minidump.py
 ---
 contexts:
   device:
diff --git a/tests/sentry/lang/native/test_cfi.py b/tests/symbolicator/test_cfi.py
similarity index 100%
rename from tests/sentry/lang/native/test_cfi.py
rename to tests/symbolicator/test_cfi.py
diff --git a/tests/sentry/lang/native/test_minidump.py b/tests/symbolicator/test_minidump.py
similarity index 100%
rename from tests/sentry/lang/native/test_minidump.py
rename to tests/symbolicator/test_minidump.py
diff --git a/tests/sentry/lang/native/test_plugin.py b/tests/symbolicator/test_native_plugin.py
similarity index 98%
rename from tests/sentry/lang/native/test_plugin.py
rename to tests/symbolicator/test_native_plugin.py
index 41cedb0851..664da1deea 100644
--- a/tests/sentry/lang/native/test_plugin.py
+++ b/tests/symbolicator/test_native_plugin.py
@@ -3,8 +3,8 @@ from __future__ import absolute_import
 import os
 import pytest
 import zipfile
-
 from mock import patch
+
 from six import BytesIO
 
 from django.conf import settings
@@ -17,6 +17,7 @@ from sentry.models import Event, EventAttachment, File, ProjectDebugFile
 
 from symbolic import parse_addr, SymbolicError, SymCache
 
+
 REAL_RESOLVING_EVENT_DATA = {
     "platform": "cocoa",
     "debug_meta": {
@@ -1121,6 +1122,7 @@ class ResolvingIntegrationTestBase(object):
         assert resp.status_code == 200
 
         event = Event.objects.get()
+        assert event.data['culprit'] == 'main'
         snapshot_data = dict(event.data)
         del snapshot_data['event_id']
         del snapshot_data['timestamp']
@@ -1195,6 +1197,7 @@ class ResolvingIntegrationTestBase(object):
         assert resp.status_code == 200
 
         event = Event.objects.get()
+        assert event.data['culprit'] == 'main'
         snapshot_data = dict(event.data)
         del snapshot_data['event_id']
         del snapshot_data['timestamp']
@@ -1210,6 +1213,7 @@ class ResolvingIntegrationTestBase(object):
         assert resp.status_code == 200
 
         event = Event.objects.get()
+        assert event.data['culprit'] == 'unknown'
         snapshot_data = dict(event.data)
         del snapshot_data['event_id']
         del snapshot_data['timestamp']
@@ -1317,18 +1321,11 @@ class SymbolicResolvingIntegrationTest(ResolvingIntegrationTestBase, TestCase):
 
 class SymbolicatorResolvingIntegrationTest(ResolvingIntegrationTestBase, TransactionTestCase):
     @pytest.fixture(autouse=True)
-    def initialize(self, live_server, monkeypatch, betamax_recorder):
-        self.live_server = live_server
-        self.monkeypatch = monkeypatch
-        self.betamax_recorder = betamax_recorder
-
-        monkeypatch.setattr('sentry.lang.native.symbolicator.Session',
-                            lambda: betamax_recorder.session)
-        monkeypatch.setattr('sentry.lang.native.plugin._is_symbolicator_enabled',
-                            lambda _: True)
-
+    def initialize(self, live_server):
         with patch('sentry.lang.native.symbolizer.Symbolizer._symbolize_app_frame') \
-                as symbolize_app_frame, \
+            as symbolize_app_frame, \
+                patch('sentry.lang.native.plugin._is_symbolicator_enabled', return_value=True), \
+                patch('sentry.auth.system.is_internal_ip', return_value=True), \
                 self.options({"system.url-prefix": live_server.url}):
 
             # Run test case:
@@ -1337,11 +1334,6 @@ class SymbolicatorResolvingIntegrationTest(ResolvingIntegrationTestBase, Transac
             # Teardown:
             assert not symbolize_app_frame.called
 
-    def test_real_resolving_with_multiple_requests(self):
-        self.monkeypatch.setattr('sentry.lang.native.symbolicator.SYMBOLICATOR_TIMEOUT', 0)
-        self.test_real_resolving()
-        assert len(self.betamax_recorder.current_cassette.interactions) > 2
-
 
 class ExceptionMechanismIntegrationTest(TestCase):
 
