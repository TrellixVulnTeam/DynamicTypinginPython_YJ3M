commit 856c6935f9b169c0c9cee1f02d5ea050fd64d52f
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Wed Aug 22 16:39:44 2018 -0700

    feat(jira): Add feature flag for new jira integration

diff --git a/src/sentry/api/endpoints/organization_config_integrations.py b/src/sentry/api/endpoints/organization_config_integrations.py
index 2034b7487a..835296f425 100644
--- a/src/sentry/api/endpoints/organization_config_integrations.py
+++ b/src/sentry/api/endpoints/organization_config_integrations.py
@@ -24,6 +24,9 @@ class OrganizationConfigIntegrationsEndpoint(OrganizationEndpoint):
         has_github_apps = features.has('organizations:github-apps',
                                        organization,
                                        actor=request.user)
+        has_jira = features.has('organizations:jira-integration',
+                                organization,
+                                actor=request.user)
 
         providers = []
         for provider in integrations.all():
@@ -34,6 +37,8 @@ class OrganizationConfigIntegrationsEndpoint(OrganizationEndpoint):
                 internal_integrations.remove('github_enterprise')
             if has_github_apps:
                 internal_integrations.remove('github')
+            if has_jira:
+                internal_integrations.remove('jira')
             if not has_catchall and provider.key in internal_integrations:
                 continue
 
diff --git a/src/sentry/api/serializers/models/organization.py b/src/sentry/api/serializers/models/organization.py
index 56ed19a7df..743ee86180 100644
--- a/src/sentry/api/serializers/models/organization.py
+++ b/src/sentry/api/serializers/models/organization.py
@@ -125,6 +125,8 @@ class DetailedOrganizationSerializer(OrganizationSerializer):
             feature_list.append('github-enterprise')
         if features.has('organizations:bitbucket-integration', obj, actor=user):
             feature_list.append('bitbucket-integration')
+        if features.has('organizations:jira-integration', obj, actor=user):
+            feature_list.append('jira-integration')
         if features.has('organizations:suggested-commits', obj, actor=user):
             feature_list.append('suggested-commits')
         if features.has('organizations:new-teams', obj, actor=user):
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 929bbbc7fb..08b1234bae 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -776,6 +776,7 @@ SENTRY_FEATURES = {
     'organizations:new-issue-ui': False,
     'organizations:github-enterprise': False,
     'organizations:bitbucket-integration': False,
+    'organizations:jira-integration': False,
     'organizations:new-teams': True,
     'organizations:unreleased-changes': False,
     'organizations:suggested-commits': True,
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index 016ef21e82..f83548a54a 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -25,6 +25,7 @@ default_manager.add('organizations:internal-catchall', OrganizationFeature)  # N
 default_manager.add('organizations:new-issue-ui', OrganizationFeature)  # NOQA
 default_manager.add('organizations:github-enterprise', OrganizationFeature)  # NOQA
 default_manager.add('organizations:bitbucket-integration', OrganizationFeature)  # NOQA
+default_manager.add('organizations:jira-integration', OrganizationFeature)  # NOQA
 default_manager.add('organizations:new-teams', OrganizationFeature)  # NOQA
 default_manager.add('organizations:unreleased-changes', OrganizationFeature)  # NOQA
 default_manager.add('organizations:environments', OrganizationFeature)  # NOQA
diff --git a/src/sentry/integrations/jira/configure.py b/src/sentry/integrations/jira/configure.py
index 061c511038..d87ac5f315 100644
--- a/src/sentry/integrations/jira/configure.py
+++ b/src/sentry/integrations/jira/configure.py
@@ -4,7 +4,7 @@ from django import forms
 from django.core.urlresolvers import reverse
 from django.views.generic import View
 
-from sentry import roles
+from sentry import features, roles
 from sentry.integrations.atlassian_connect import AtlassianConnectValidationError, get_integration_from_request
 from sentry.utils.http import absolute_uri
 from sentry.web.helpers import render_to_response
@@ -55,12 +55,18 @@ class JiraConfigureView(View):
                 'login_url': absolute_uri(reverse('sentry-login')),
             })
 
-        organizations = request.user.get_orgs().filter(
+        organizations = list(request.user.get_orgs().filter(
             id__in=OrganizationMember.objects.filter(
                 role__in=[r.id for r in roles.get_all() if r.is_global],
                 user=request.user,
             ).values('organization'),
-        )
+        ))
+
+        # TODO(jess): remove after wide release
+        organizations = [
+            o for o in organizations if features.has(
+                'organizations:jira-integration', o, actor=request.user)
+        ]
         form = JiraConfigForm(organizations, request.POST)
 
         if request.method == 'GET' or not form.is_valid():
diff --git a/src/sentry/templates/sentry/integrations/jira-config.html b/src/sentry/templates/sentry/integrations/jira-config.html
index 06c25efe8f..d02d4f2632 100644
--- a/src/sentry/templates/sentry/integrations/jira-config.html
+++ b/src/sentry/templates/sentry/integrations/jira-config.html
@@ -34,7 +34,7 @@
 
   {% if login_required %}
     <div class="aui-message aui-message-info">
-        <p>Please login to your Sentry account to access the Sentry Add-on configuration</p>
+      <p>Please login to your Sentry account to access the Sentry Add-on configuration</p>
     </div>
     <div class="signin">
       <a class="aui-button aui-button-default" href="{{ login_url }}" target="_blank">
@@ -53,6 +53,10 @@
         integration for your organization.
       </p>
     </div>
+    {% else %}
+      <div class="aui-message aui-message-info">
+        <p>This feature is only available to Early Adopters. Visit your organization settings in Sentry to opt in to Early Adopter features.</p>
+      </div>
     {% endif %}
 
     <form class="aui top-label" action="" method="post">
