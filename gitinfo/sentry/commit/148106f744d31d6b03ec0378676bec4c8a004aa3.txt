commit 148106f744d31d6b03ec0378676bec4c8a004aa3
Author: jeffkwoh <23180853+jeffkwoh@users.noreply.github.com>
Date:   Wed Apr 1 01:00:20 2020 +0800

    feat(plugin): Make Mail Plugin non-configurable (#17842)
    
    * feat(plugin): Remove mail as a configurable plugin
    
    * Move logic to `can_configure_for_project`
    
    Co-authored-by: Dan Fuller <dfuller@sentry.io>

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index 135e2a09fe..e668290e04 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -418,6 +418,12 @@ class MailPlugin(NotificationPlugin):
         if name == "user-reports.created":
             self.handle_user_report(payload, **kwargs)
 
+    def can_configure_for_project(self, project):
+        return (
+            super(MailPlugin, self).can_configure_for_project(project)
+            and not project.flags.has_issue_alerts_targeting
+        )
+
 
 # Legacy compatibility
 MailProcessor = MailPlugin
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index abeec6246a..d25d146915 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -662,3 +662,17 @@ class MailPluginOwnersTest(TestCase):
             data=self.make_event_data("foo.cbl"), project_id=self.project.id
         )
         self.assert_notify(event_all_users, [self.user.email])
+
+
+class TestCanConfigureForProject(TestCase):
+    @fixture
+    def plugin(self):
+        return MailPlugin()
+
+    def test_does_not_have_alerts_targeting(self):
+        self.project.flags.has_issue_alerts_targeting = False
+        assert self.plugin.can_configure_for_project(self.project)
+
+    def test_has_alerts_targeting(self):
+        self.project.flags.has_issue_alerts_targeting = True
+        assert not self.plugin.can_configure_for_project(self.project)
