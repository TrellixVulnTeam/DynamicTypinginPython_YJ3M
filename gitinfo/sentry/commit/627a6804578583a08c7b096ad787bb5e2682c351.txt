commit 627a6804578583a08c7b096ad787bb5e2682c351
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Oct 31 15:34:11 2016 -0700

    [api] give internal client access to session (#4458)
    
    Fixes SENTRY-2BP

diff --git a/src/sentry/api/client.py b/src/sentry/api/client.py
index 1ab75e90c2..e4095ee075 100644
--- a/src/sentry/api/client.py
+++ b/src/sentry/api/client.py
@@ -60,11 +60,13 @@ class ApiClient(object):
                 mock_request.is_superuser = lambda: request.is_superuser()
             else:
                 mock_request.is_superuser = lambda: is_superuser
+            mock_request.session = request.session
         else:
             mock_request.auth = auth
             mock_request.user = user
             mock_request.is_sudo = lambda: is_sudo
             mock_request.is_superuser = lambda: is_superuser
+            mock_request.session = {}
 
         if request:
             # superuser checks require access to IP
diff --git a/tests/integration/test_api.py b/tests/integration/test_api.py
index 068cfa00fe..79f8a7851a 100644
--- a/tests/integration/test_api.py
+++ b/tests/integration/test_api.py
@@ -18,6 +18,8 @@ class AuthenticationTest(AuthProviderTestCase):
                                     teams=[team])
         setattr(member.flags, 'sso:linked', True)
         member.save()
+        group = self.create_group(project=project)
+        self.create_event(group=group)
 
         auth_provider = AuthProvider.objects.create(
             organization=organization,
@@ -36,6 +38,9 @@ class AuthenticationTest(AuthProviderTestCase):
             '/api/0/organizations/{}/'.format(organization.slug),
             '/api/0/projects/{}/{}/'.format(organization.slug, project.slug),
             '/api/0/teams/{}/{}/'.format(organization.slug, team.slug),
+            '/api/0/issues/{}/'.format(group.id),
+            # this uses the internal API, which once upon a time was broken
+            '/api/0/issues/{}/events/latest/'.format(group.id),
         )
 
         for path in paths:
