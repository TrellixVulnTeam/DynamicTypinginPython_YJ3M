commit 03c34bb3f22ac4b64218db24df68e10ba3d3b57b
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Fri Jan 18 10:20:29 2019 -0800

    feat(sentry10): Single project selection mode (#11575)
    
    Enforce single project selection mode via the GlobalSelectionHeader if
    users do not have the "global-views" feature. If no project is specified
    in the query users will be automatically directed to their first one.

diff --git a/src/sentry/static/sentry/app/components/organizations/globalSelectionHeader/globalSelectionHeader.jsx b/src/sentry/static/sentry/app/components/organizations/globalSelectionHeader/globalSelectionHeader.jsx
index 9be9de5e11..d4aeca73e5 100644
--- a/src/sentry/static/sentry/app/components/organizations/globalSelectionHeader/globalSelectionHeader.jsx
+++ b/src/sentry/static/sentry/app/components/organizations/globalSelectionHeader/globalSelectionHeader.jsx
@@ -126,6 +126,8 @@ class GlobalSelectionHeader extends React.Component {
       return;
     }
 
+    const hasMultipleProjectFeature = this.hasMultipleProjectSelection();
+
     const stateFromRouter = GlobalSelectionHeader.getStateFromRouter(this.props);
     // We should update store if there are any relevant URL parameters when component
     // is mounted
@@ -137,17 +139,39 @@ class GlobalSelectionHeader extends React.Component {
 
       // environment/project here can be null i.e. if only period is set in url params
       updateEnvironments(environment || []);
-      updateProjects(project || []);
+
+      const requestedProjects = project || [];
+
+      if (hasMultipleProjectFeature) {
+        updateProjects(requestedProjects);
+      } else {
+        const allowedProjects =
+          requestedProjects.length > 0
+            ? requestedProjects.slice(0, 1)
+            : this.getFirstProject();
+        updateProjects(allowedProjects);
+        updateParams({project: allowedProjects}, this.getRouter());
+      }
     } else {
       // Otherwise, we can update URL with values from store
       //
       // e.g. when switching to a new view that uses this component,
       // update URL parameters to reflect current store
       const {datetime, environments, projects} = this.props.selection;
-      updateParams(
-        {project: projects, environment: environments, ...datetime},
-        this.getRouter()
-      );
+
+      if (hasMultipleProjectFeature) {
+        updateParams(
+          {project: projects, environment: environments, ...datetime},
+          this.getRouter()
+        );
+      } else {
+        const allowedProjects = this.getFirstProject();
+        updateProjects(allowedProjects);
+        updateParams(
+          {project: allowedProjects, environment: environments, ...datetime},
+          this.getRouter()
+        );
+      }
     }
   }
 
@@ -190,6 +214,10 @@ class GlobalSelectionHeader extends React.Component {
     this.updateStoreIfChange(prevProps, this.props);
   }
 
+  hasMultipleProjectSelection = () => {
+    return new Set(this.props.organization.features).has('global-views');
+  };
+
   didQueryChange = (prevProps, nextProps) => {
     const urlParamKeys = Object.values(URL_PARAM);
     return !isEqual(
@@ -285,6 +313,12 @@ class GlobalSelectionHeader extends React.Component {
     );
   };
 
+  getFirstProject = () => {
+    return this.getProjects()
+      .map(p => parseInt(p.id, 10))
+      .slice(0, 1);
+  };
+
   render() {
     const {
       className,
@@ -304,6 +338,7 @@ class GlobalSelectionHeader extends React.Component {
             value={this.state.projects || this.props.selection.projects}
             onChange={this.handleChangeProjects}
             onUpdate={this.handleUpdateProjects}
+            multi={this.hasMultipleProjectSelection()}
           />
         </HeaderItemPosition>
 
diff --git a/src/sentry/static/sentry/app/components/organizations/multipleProjectSelector.jsx b/src/sentry/static/sentry/app/components/organizations/multipleProjectSelector.jsx
index 667b588702..39602c6dd5 100644
--- a/src/sentry/static/sentry/app/components/organizations/multipleProjectSelector.jsx
+++ b/src/sentry/static/sentry/app/components/organizations/multipleProjectSelector.jsx
@@ -20,6 +20,11 @@ export default class MultipleProjectSelector extends React.PureComponent {
     projects: PropTypes.array,
     onChange: PropTypes.func,
     onUpdate: PropTypes.func,
+    multi: PropTypes.bool,
+  };
+
+  static defaultProps = {
+    multi: true,
   };
 
   constructor() {
@@ -87,12 +92,8 @@ export default class MultipleProjectSelector extends React.PureComponent {
     this.setState({hasChanges: true});
   };
 
-  hasMultiSelect = () => {
-    return new Set(this.props.organization.features).has('global-views');
-  };
-
   render() {
-    const {value, projects} = this.props;
+    const {value, projects, multi} = this.props;
     const selectedProjectIds = new Set(value);
 
     const selected = projects.filter(project =>
@@ -102,7 +103,7 @@ export default class MultipleProjectSelector extends React.PureComponent {
     return (
       <StyledProjectSelector
         {...this.props}
-        multi={this.hasMultiSelect()}
+        multi={multi}
         selectedProjects={selected}
         projects={projects}
         onSelect={this.handleQuickSelect}
@@ -132,6 +133,7 @@ export default class MultipleProjectSelector extends React.PureComponent {
               isOpen={isOpen}
               onSubmit={() => this.handleUpdate(actions)}
               onClear={this.handleClear}
+              allowClear={multi}
               {...getActorProps()}
             >
               {title}
diff --git a/src/sentry/static/sentry/app/components/projectSelector.jsx b/src/sentry/static/sentry/app/components/projectSelector.jsx
index 15f6f801ac..a00b1abfba 100644
--- a/src/sentry/static/sentry/app/components/projectSelector.jsx
+++ b/src/sentry/static/sentry/app/components/projectSelector.jsx
@@ -32,10 +32,6 @@ class ProjectSelector extends React.Component {
     // Allow selecting multiple projects?
     multi: PropTypes.bool,
 
-    // Disable selecting a single project, every action should trigger multi select
-    // XXX(billy): This is unused as of 11/1/2018, could be due for a cleanup
-    multiOnly: PropTypes.bool,
-
     // Use this if the component should be a controlled component
     selectedProjects: PropTypes.arrayOf(SentryTypes.Project),
 
@@ -72,12 +68,20 @@ class ProjectSelector extends React.Component {
 
   getActiveProject() {
     const {projectId} = this.props;
-    return this.getProjects().find(({slug}) => slug === projectId);
+
+    const projects = this.getProjects();
+
+    return projects.find(({slug}) => slug === projectId);
   }
 
   getProjects() {
     const {organization, projects} = this.props;
-    return projects || organization.projects.filter(project => project.isMember);
+    const projectList =
+      projects || organization.projects.filter(project => project.isMember);
+
+    return sortArray(projectList, project => {
+      return [!project.isBookmarked, project.name];
+    });
   }
 
   isControlled = () => typeof this.props.selectedProjects !== 'undefined';
@@ -108,14 +112,10 @@ class ProjectSelector extends React.Component {
   }
 
   handleSelect = ({value: project}) => {
-    const {multiOnly, onSelect} = this.props;
+    const {onSelect} = this.props;
 
-    if (!multiOnly) {
-      this.setState({activeProject: project});
-      onSelect(project);
-    } else {
-      this.handleMultiSelect(project);
-    }
+    this.setState({activeProject: project});
+    onSelect(project);
   };
 
   handleMultiSelect = (project, e) => {
@@ -154,7 +154,6 @@ class ProjectSelector extends React.Component {
       organization: org,
       menuFooter,
       multi,
-      multiOnly,
       className,
       rootClassName,
       onClose,
@@ -173,7 +172,7 @@ class ProjectSelector extends React.Component {
     return (
       <DropdownAutoComplete
         alignMenu="left"
-        closeOnSelect={!multiOnly}
+        closeOnSelect={true}
         blendCorner={false}
         searchPlaceholder={t('Filter projects')}
         onSelect={this.handleSelect}
diff --git a/src/sentry/static/sentry/app/stores/globalSelectionStore.jsx b/src/sentry/static/sentry/app/stores/globalSelectionStore.jsx
index 2fd0bac37a..16b7d48bcf 100644
--- a/src/sentry/static/sentry/app/stores/globalSelectionStore.jsx
+++ b/src/sentry/static/sentry/app/stores/globalSelectionStore.jsx
@@ -22,10 +22,6 @@ const getDefaultSelection = () => {
   };
 };
 
-/**
- * Store for global selections
- * Currently stores active project ids for Discover and EventStream
- */
 const GlobalSelectionStore = Reflux.createStore({
   init() {
     this.reset();
diff --git a/tests/js/spec/components/organizations/globalSelectionHeader.spec.jsx b/tests/js/spec/components/organizations/globalSelectionHeader.spec.jsx
index 8cf621c979..f4ac02f0e7 100644
--- a/tests/js/spec/components/organizations/globalSelectionHeader.spec.jsx
+++ b/tests/js/spec/components/organizations/globalSelectionHeader.spec.jsx
@@ -21,6 +21,7 @@ const changeQuery = (routerContext, query) => ({
 
 describe('GlobalSelectionHeader', function() {
   const {organization, router, routerContext} = initializeOrg({
+    organization: TestStubs.Organization({features: ['global-views']}),
     router: {
       location: {query: {}},
     },
@@ -177,4 +178,39 @@ describe('GlobalSelectionHeader', function() {
       projects: [],
     });
   });
+
+  describe('Single project selection mode', function() {
+    it('selects first project if more than one is requested', function() {
+      const initializationObj = initializeOrg({
+        router: {
+          location: {query: {project: [1, 2]}},
+        },
+      });
+
+      mount(
+        <GlobalSelectionHeader organization={initializationObj.organization} />,
+        initializationObj.routerContext
+      );
+
+      expect(globalActions.updateProjects).toHaveBeenCalledWith([1]);
+    });
+
+    it('selects first project if none (i.e. all) is requested', function() {
+      const project = TestStubs.Project({id: '3'});
+      const org = TestStubs.Organization({projects: [project]});
+      const initializationObj = initializeOrg({
+        organization: org,
+        router: {
+          location: {query: {}},
+        },
+      });
+
+      mount(
+        <GlobalSelectionHeader organization={initializationObj.organization} />,
+        initializationObj.routerContext
+      );
+
+      expect(globalActions.updateProjects).toHaveBeenCalledWith([3]);
+    });
+  });
 });
diff --git a/tests/js/spec/views/organizationDashboard/dashboard.spec.jsx b/tests/js/spec/views/organizationDashboard/dashboard.spec.jsx
index eeab7c5feb..cf37992592 100644
--- a/tests/js/spec/views/organizationDashboard/dashboard.spec.jsx
+++ b/tests/js/spec/views/organizationDashboard/dashboard.spec.jsx
@@ -13,7 +13,7 @@ describe('OrganizationDashboard', function() {
   const {organization, router, routerContext} = initializeOrg({
     projects: [{isMember: true}, {isMember: true, slug: 'new-project', id: 3}],
     organization: {
-      features: ['sentry10'],
+      features: ['sentry10', 'global-views'],
     },
     router: {
       location: {
diff --git a/tests/js/spec/views/releases/list/__snapshots__/organizationReleases.spec.jsx.snap b/tests/js/spec/views/releases/list/__snapshots__/organizationReleases.spec.jsx.snap
index 55cf561fd3..7640205dd6 100644
--- a/tests/js/spec/views/releases/list/__snapshots__/organizationReleases.spec.jsx.snap
+++ b/tests/js/spec/views/releases/list/__snapshots__/organizationReleases.spec.jsx.snap
@@ -25,6 +25,7 @@ exports[`OrganizationReleases renders 1`] = `
       ],
       "features": Array [
         "sentry10",
+        "global-views",
       ],
       "id": "3",
       "name": "Organization Name",
@@ -79,6 +80,7 @@ exports[`OrganizationReleases renders 1`] = `
         ],
         "features": Array [
           "sentry10",
+          "global-views",
         ],
         "id": "3",
         "name": "Organization Name",
@@ -136,6 +138,7 @@ exports[`OrganizationReleases renders 1`] = `
               ],
               "features": Array [
                 "sentry10",
+                "global-views",
               ],
               "id": "3",
               "name": "Organization Name",
@@ -184,6 +187,7 @@ exports[`OrganizationReleases renders 1`] = `
                 ],
                 "features": Array [
                   "sentry10",
+                  "global-views",
                 ],
                 "id": "3",
                 "name": "Organization Name",
@@ -238,6 +242,7 @@ exports[`OrganizationReleases renders 1`] = `
                   ],
                   "features": Array [
                     "sentry10",
+                    "global-views",
                   ],
                   "id": "3",
                   "name": "Organization Name",
@@ -284,6 +289,7 @@ exports[`OrganizationReleases renders 1`] = `
                     ],
                     "features": Array [
                       "sentry10",
+                      "global-views",
                     ],
                     "id": "3",
                     "name": "Organization Name",
@@ -379,6 +385,7 @@ exports[`OrganizationReleases renders 1`] = `
                       ],
                       "features": Array [
                         "sentry10",
+                        "global-views",
                       ],
                       "id": "3",
                       "name": "Organization Name",
@@ -479,6 +486,7 @@ exports[`OrganizationReleases renders 1`] = `
                             className="css-5udiwc-HeaderItemPosition e165b9e40"
                           >
                             <MultipleProjectSelector
+                              multi={true}
                               onChange={[Function]}
                               onUpdate={[Function]}
                               organization={
@@ -496,6 +504,7 @@ exports[`OrganizationReleases renders 1`] = `
                                   ],
                                   "features": Array [
                                     "sentry10",
+                                    "global-views",
                                   ],
                                   "id": "3",
                                   "name": "Organization Name",
@@ -536,7 +545,7 @@ exports[`OrganizationReleases renders 1`] = `
                               value={Array []}
                             >
                               <StyledProjectSelector
-                                multi={false}
+                                multi={true}
                                 onChange={[Function]}
                                 onClose={[Function]}
                                 onMultiSelect={[Function]}
@@ -557,6 +566,7 @@ exports[`OrganizationReleases renders 1`] = `
                                     ],
                                     "features": Array [
                                       "sentry10",
+                                      "global-views",
                                     ],
                                     "id": "3",
                                     "name": "Organization Name",
@@ -600,7 +610,7 @@ exports[`OrganizationReleases renders 1`] = `
                               >
                                 <ProjectSelector
                                   className="css-iw79rr-StyledProjectSelector ewlipse0"
-                                  multi={false}
+                                  multi={true}
                                   onChange={[Function]}
                                   onClose={[Function]}
                                   onMultiSelect={[Function]}
@@ -621,6 +631,7 @@ exports[`OrganizationReleases renders 1`] = `
                                       ],
                                       "features": Array [
                                         "sentry10",
+                                        "global-views",
                                       ],
                                       "id": "3",
                                       "name": "Organization Name",
@@ -806,6 +817,7 @@ exports[`OrganizationReleases renders 1`] = `
                                                   >
                                                     <StyledHeaderItem
                                                       active={false}
+                                                      allowClear={true}
                                                       hasChanges={false}
                                                       hasSelected={false}
                                                       icon={
@@ -829,6 +841,7 @@ exports[`OrganizationReleases renders 1`] = `
                                                     >
                                                       <ForwardRef
                                                         active={false}
+                                                        allowClear={true}
                                                         className="css-22y332-StyledHeaderItem ewlipse1"
                                                         hasChanges={false}
                                                         hasSelected={false}
@@ -1032,6 +1045,7 @@ exports[`OrganizationReleases renders 1`] = `
                                   ],
                                   "features": Array [
                                     "sentry10",
+                                    "global-views",
                                   ],
                                   "id": "3",
                                   "name": "Organization Name",
@@ -1077,6 +1091,7 @@ exports[`OrganizationReleases renders 1`] = `
                                     ],
                                     "features": Array [
                                       "sentry10",
+                                      "global-views",
                                     ],
                                     "id": "3",
                                     "name": "Organization Name",
@@ -1119,6 +1134,7 @@ exports[`OrganizationReleases renders 1`] = `
                                       ],
                                       "features": Array [
                                         "sentry10",
+                                        "global-views",
                                       ],
                                       "id": "3",
                                       "name": "Organization Name",
@@ -1161,6 +1177,7 @@ exports[`OrganizationReleases renders 1`] = `
                                         ],
                                         "features": Array [
                                           "sentry10",
+                                          "global-views",
                                         ],
                                         "id": "3",
                                         "name": "Organization Name",
diff --git a/tests/js/spec/views/releases/list/organizationReleases.spec.jsx b/tests/js/spec/views/releases/list/organizationReleases.spec.jsx
index d8ad98d672..91035323bb 100644
--- a/tests/js/spec/views/releases/list/organizationReleases.spec.jsx
+++ b/tests/js/spec/views/releases/list/organizationReleases.spec.jsx
@@ -10,7 +10,7 @@ describe('OrganizationReleases', function() {
   beforeEach(function() {
     const organization = TestStubs.Organization({
       projects: [TestStubs.Project()],
-      features: ['sentry10'],
+      features: ['sentry10', 'global-views'],
     });
 
     MockApiClient.addMockResponse({
diff --git a/tests/js/spec/views/userFeedback/__snapshots__/organizationUserFeedback.spec.jsx.snap b/tests/js/spec/views/userFeedback/__snapshots__/organizationUserFeedback.spec.jsx.snap
index 8b5337d5a5..652ec7dcd6 100644
--- a/tests/js/spec/views/userFeedback/__snapshots__/organizationUserFeedback.spec.jsx.snap
+++ b/tests/js/spec/views/userFeedback/__snapshots__/organizationUserFeedback.spec.jsx.snap
@@ -449,6 +449,7 @@ exports[`OrganizationUserFeedback renders 1`] = `
                           className="css-5udiwc-HeaderItemPosition e165b9e40"
                         >
                           <MultipleProjectSelector
+                            multi={false}
                             onChange={[Function]}
                             onUpdate={[Function]}
                             organization={
@@ -678,6 +679,7 @@ exports[`OrganizationUserFeedback renders 1`] = `
                                                 >
                                                   <StyledHeaderItem
                                                     active={false}
+                                                    allowClear={false}
                                                     hasChanges={false}
                                                     hasSelected={false}
                                                     icon={
@@ -701,6 +703,7 @@ exports[`OrganizationUserFeedback renders 1`] = `
                                                   >
                                                     <ForwardRef
                                                       active={false}
+                                                      allowClear={false}
                                                       className="css-22y332-StyledHeaderItem ewlipse1"
                                                       hasChanges={false}
                                                       hasSelected={false}
@@ -725,7 +728,7 @@ exports[`OrganizationUserFeedback renders 1`] = `
                                                     >
                                                       <HeaderItem
                                                         active={false}
-                                                        allowClear={true}
+                                                        allowClear={false}
                                                         className="css-22y332-StyledHeaderItem ewlipse1"
                                                         hasChanges={false}
                                                         hasSelected={false}
