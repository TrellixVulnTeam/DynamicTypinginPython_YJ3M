commit 7a0ccfbdb6aea54028c8f067b2ca9921108dc50c
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Tue Sep 5 09:29:14 2017 -0500

    fix: Clean up DSym files when a Project is deleted. (#6023)
    
    Fixes GH-5265

diff --git a/src/sentry/deletions/defaults/project.py b/src/sentry/deletions/defaults/project.py
index 7300da02ef..2b9cc04311 100644
--- a/src/sentry/deletions/defaults/project.py
+++ b/src/sentry/deletions/defaults/project.py
@@ -42,7 +42,7 @@ class ProjectDeletionTask(ModelDeletionTask):
         # in bulk
         # Release needs to handle deletes after Group is cleaned up as the foreign
         # key is protected
-        model_list = (models.Group, models.ReleaseProject)
+        model_list = (models.Group, models.ReleaseProject, models.ProjectDSymFile)
         relations.extend(
             [ModelRelation(m, {'project_id': instance.id}, ModelDeletionTask) for m in model_list]
         )
diff --git a/src/sentry/models/dsymfile.py b/src/sentry/models/dsymfile.py
index 3fe99b113c..2425f33817 100644
--- a/src/sentry/models/dsymfile.py
+++ b/src/sentry/models/dsymfile.py
@@ -183,6 +183,10 @@ class ProjectDSymFile(Model):
         ct = self.file.headers.get('Content-Type').lower()
         return KNOWN_DSYM_TYPES.get(ct, 'unknown')
 
+    def delete(self, *args, **kwargs):
+        super(ProjectDSymFile, self).delete(*args, **kwargs)
+        self.file.delete()
+
 
 def _create_dsym_from_uuid(project, dsym_type, cpu_name, uuid, fileobj, basename):
     """This creates a mach dsym file or proguard mapping from the given
diff --git a/tests/sentry/deletions/test_project.py b/tests/sentry/deletions/test_project.py
index b8d1ea80d5..201831ab15 100644
--- a/tests/sentry/deletions/test_project.py
+++ b/tests/sentry/deletions/test_project.py
@@ -2,7 +2,8 @@ from __future__ import absolute_import
 
 from sentry.models import (
     Commit, CommitAuthor, Environment, EnvironmentProject, GroupAssignee, GroupMeta,
-    GroupResolution, Project, Release, ReleaseCommit, Repository, ScheduledDeletion
+    GroupResolution, Project, Release, ReleaseCommit, Repository, ScheduledDeletion,
+    ProjectDSymFile, File
 )
 from sentry.tasks.deletion import run_deletion
 from sentry.testutils import TestCase
@@ -45,6 +46,17 @@ class DeleteProjectTest(TestCase):
             commit=commit,
             order=0,
         )
+        file = File.objects.create(
+            name='dsym-file',
+            type='project.dsym',
+        )
+        dsym_file = ProjectDSymFile.objects.create(
+            file=file,
+            uuid='uuid',
+            cpu_name='cpu',
+            object_name='object',
+            project=project,
+        )
 
         deletion = ScheduledDeletion.schedule(project, days=0)
         deletion.update(in_progress=True)
@@ -60,3 +72,5 @@ class DeleteProjectTest(TestCase):
         assert Release.objects.filter(id=release.id).exists()
         assert ReleaseCommit.objects.filter(release_id=release.id).exists()
         assert Commit.objects.filter(id=commit.id).exists()
+        assert not ProjectDSymFile.objects.filter(id=dsym_file.id).exists()
+        assert not File.objects.filter(id=file.id).exists()
