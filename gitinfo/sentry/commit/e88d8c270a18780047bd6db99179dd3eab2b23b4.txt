commit e88d8c270a18780047bd6db99179dd3eab2b23b4
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Nov 10 12:07:56 2015 -0800

    Extend file locks

diff --git a/src/sentry/models/file.py b/src/sentry/models/file.py
index b8fc601b52..fb7a52377e 100644
--- a/src/sentry/models/file.py
+++ b/src/sentry/models/file.py
@@ -91,7 +91,10 @@ class FileBlob(Model):
         self.size = size
         self.checksum = checksum.hexdigest()
 
-        with Lock('fileblob:upload:{}'.format(self.checksum)):
+        lock_key = 'fileblob:upload:{}'.format(self.checksum)
+        # TODO(dcramer): the database here is safe, but if this lock expires
+        # and duplicate files are uploaded then we need to prune one
+        with Lock(lock_key, timeout=600):
             # test for presence
             try:
                 existing = FileBlob.objects.get(checksum=self.checksum)
@@ -156,7 +159,7 @@ class File(Model):
             return
 
         lock_key = 'fileblob:convert:{}'.format(self.checksum)
-        with Lock(lock_key):
+        with Lock(lock_key, timeout=60):
             blob, created = FileBlob.objects.get_or_create(
                 checksum=self.checksum,
                 defaults={
