commit 8120fc528f858b0e2378d8a1b0fe7e0811bdb141
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jan 28 01:03:16 2014 -0800

    Break up middleware

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 9c9443c86a..01255e3bf1 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -115,8 +115,8 @@ MIDDLEWARE_CLASSES = (
     'django.contrib.sessions.middleware.SessionMiddleware',
     'django.middleware.csrf.CsrfViewMiddleware',
     'django.contrib.auth.middleware.AuthenticationMiddleware',
-    'sentry.middleware.SentryMiddleware',
-    'sentry.middleware.SentrySocialAuthExceptionMiddleware',
+    'sentry.middleware.locale.SentryLocaleMiddleware',
+    'sentry.middleware.social_auth.SentrySocialAuthExceptionMiddleware',
     'django.middleware.locale.LocaleMiddleware',
     'django.contrib.messages.middleware.MessageMiddleware',
 )
diff --git a/src/sentry/middleware/__init__.py b/src/sentry/middleware/__init__.py
new file mode 100644
index 0000000000..d9326d1674
--- /dev/null
+++ b/src/sentry/middleware/__init__.py
@@ -0,0 +1,9 @@
+"""
+sentry.middleware
+~~~~~~~~~~~~~~~~~
+
+:copyright: (c) 2010-2014 by the Sentry Team, see AUTHORS for more details.
+:license: BSD, see LICENSE for more details.
+"""
+
+from __future__ import absolute_import
diff --git a/src/sentry/middleware/locale.py b/src/sentry/middleware/locale.py
new file mode 100644
index 0000000000..0c27e5631e
--- /dev/null
+++ b/src/sentry/middleware/locale.py
@@ -0,0 +1,43 @@
+"""
+sentry.middleware.locale
+~~~~~~~~~~~~~~~~~~~~~~~~
+
+:copyright: (c) 2010-2014 by the Sentry Team, see AUTHORS for more details.
+:license: BSD, see LICENSE for more details.
+"""
+
+from __future__ import absolute_import
+
+import pytz
+
+from django.conf import settings
+from django.core.urlresolvers import reverse
+
+from sentry.app import env
+from sentry.models import UserOption
+
+
+class SentryLocaleMiddleware(object):
+    def process_request(self, request):
+        # HACK: bootstrap some env crud if we haven't yet
+        if not settings.SENTRY_URL_PREFIX:
+            settings.SENTRY_URL_PREFIX = request.build_absolute_uri(reverse('sentry')).strip('/')
+
+        # bind request to env
+        env.request = request
+
+        self.load_user_conf(request)
+
+    def load_user_conf(self, request):
+        if not request.user.is_authenticated():
+            return
+
+        language = UserOption.objects.get_value(
+            user=request.user, project=None, key='language', default=None)
+        if language:
+            request.session['django_language'] = language
+
+        timezone = UserOption.objects.get_value(
+            user=request.user, project=None, key='timezone', default=None)
+        if timezone:
+            request.timezone = pytz.timezone(timezone)
diff --git a/src/sentry/middleware/social_auth.py b/src/sentry/middleware/social_auth.py
new file mode 100644
index 0000000000..f0f89a292f
--- /dev/null
+++ b/src/sentry/middleware/social_auth.py
@@ -0,0 +1,19 @@
+"""
+sentry.middleware.social_auth
+~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
+
+:copyright: (c) 2010-2014 by the Sentry Team, see AUTHORS for more details.
+:license: BSD, see LICENSE for more details.
+"""
+
+from __future__ import absolute_import
+
+from django.core.urlresolvers import reverse
+from social_auth.middleware import SocialAuthExceptionMiddleware
+
+from sentry.utils.http import absolute_uri
+
+
+class SentrySocialAuthExceptionMiddleware(SocialAuthExceptionMiddleware):
+    def get_redirect_uri(self, request, exception):
+        return absolute_uri(reverse('sentry-login'))
