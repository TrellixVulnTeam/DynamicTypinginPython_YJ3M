commit 9c04d102492834c1ce763573c9cbf30b4b839c9a
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Wed Mar 7 15:36:11 2018 -0600

    fix: Temporarily disable cleanup for tagstore v2 (#7505)

diff --git a/src/sentry/tagstore/base.py b/src/sentry/tagstore/base.py
index f61307d82f..087356d41e 100644
--- a/src/sentry/tagstore/base.py
+++ b/src/sentry/tagstore/base.py
@@ -113,13 +113,7 @@ class TagStorage(Service):
         ])
 
     def setup_cleanup(self, tagvalue_model, grouptagvalue_model, eventtag_model):
-        from sentry.runner.commands import cleanup
-
-        cleanup.EXTRA_BULK_QUERY_DELETES += [
-            (grouptagvalue_model, 'last_seen', None),
-            (tagvalue_model, 'last_seen', None),
-            (eventtag_model, 'date_added', 'date_added'),
-        ]
+        pass
 
     def setup_merge(self, grouptagkey_model, grouptagvalue_model):
         from sentry.tasks import merge
diff --git a/src/sentry/tagstore/legacy/backend.py b/src/sentry/tagstore/legacy/backend.py
index 5a73d65390..6bd5b6cf50 100644
--- a/src/sentry/tagstore/legacy/backend.py
+++ b/src/sentry/tagstore/legacy/backend.py
@@ -57,6 +57,15 @@ class LegacyTagStorage(TagStorage):
             grouptagvalue_model=GroupTagValue,
         )
 
+    def setup_cleanup(self, tagvalue_model, grouptagvalue_model, eventtag_model):
+        from sentry.runner.commands import cleanup
+
+        cleanup.EXTRA_BULK_QUERY_DELETES += [
+            (grouptagvalue_model, 'last_seen', None),
+            (tagvalue_model, 'last_seen', None),
+            (eventtag_model, 'date_added', 'date_added'),
+        ]
+
     def setup_deletions(self, **kwargs):
         super(LegacyTagStorage, self).setup_deletions(**kwargs)
 
diff --git a/src/sentry/tagstore/v2/backend.py b/src/sentry/tagstore/v2/backend.py
index d26e595a48..faf7e783a7 100644
--- a/src/sentry/tagstore/v2/backend.py
+++ b/src/sentry/tagstore/v2/backend.py
@@ -63,6 +63,10 @@ class V2TagStorage(TagStorage):
             grouptagvalue_model=GroupTagValue,
         )
 
+    def setup_cleanup(self, tagvalue_model, grouptagvalue_model, eventtag_model):
+        # TODO: fix for sharded DB
+        pass
+
     def setup_deletions(self, **kwargs):
         super(V2TagStorage, self).setup_deletions(**kwargs)
 
diff --git a/tests/sentry/runner/commands/test_cleanup.py b/tests/sentry/runner/commands/test_cleanup.py
index 30044be127..8beecaf93d 100644
--- a/tests/sentry/runner/commands/test_cleanup.py
+++ b/tests/sentry/runner/commands/test_cleanup.py
@@ -2,6 +2,8 @@
 
 from __future__ import absolute_import
 
+import pytest
+
 from django.conf import settings
 
 from sentry.models import Event, Group
@@ -27,6 +29,10 @@ class SentryCleanupTest(CliTestCase):
 
     command = cleanup
 
+    @pytest.mark.skipif(
+        settings.SENTRY_TAGSTORE == 'sentry.tagstore.v2.V2TagStorage',
+        reason='Cleanup is temporarily disabled for tagstore v2'
+    )
     def test_simple(self):
         rv = self.invoke('--days=1')
         assert rv.exit_code == 0, rv.output
@@ -34,6 +40,10 @@ class SentryCleanupTest(CliTestCase):
         for model in ALL_MODELS:
             assert model.objects.count() == 0
 
+    @pytest.mark.skipif(
+        settings.SENTRY_TAGSTORE == 'sentry.tagstore.v2.V2TagStorage',
+        reason='Cleanup is temporarily disabled for tagstore v2'
+    )
     def test_project(self):
         orig_counts = {}
         for model in ALL_MODELS:
