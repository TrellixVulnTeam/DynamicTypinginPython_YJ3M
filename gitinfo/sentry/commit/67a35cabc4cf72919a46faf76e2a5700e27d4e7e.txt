commit 67a35cabc4cf72919a46faf76e2a5700e27d4e7e
Author: Jess MacQueen <jess@getsentry.com>
Date:   Mon Nov 13 18:37:18 2017 -0800

    fix(repos): Don't block repo deletion even if webhooks can't be deleted
    
    fixes GH-6535

diff --git a/src/sentry/models/repository.py b/src/sentry/models/repository.py
index 2a4b072b14..0fc5656288 100644
--- a/src/sentry/models/repository.py
+++ b/src/sentry/models/repository.py
@@ -46,10 +46,11 @@ class Repository(Model):
         new_context = {
             'repo': self,
             'error_message': error_message,
+            'provider_name': self.get_provider().name,
         }
 
         return MessageBuilder(
-            subject='Unable to Delete Repository',
+            subject='Unable to Delete Repository Webhooks',
             context=new_context,
             template='sentry/emails/unable-to-delete-repo.txt',
             html_template='sentry/emails/unable-to-delete-repo.html',
@@ -68,10 +69,10 @@ def on_delete(instance, actor=None, **kwargs):
             error = exc.message
         else:
             error = 'An unknown error occurred'
+
         if actor is not None:
             msg = instance.generate_delete_fail_email(error)
             msg.send_async(to=[actor.email])
-        raise
 
 
 pending_delete.connect(on_delete, sender=Repository, weak=False)
diff --git a/src/sentry/templates/sentry/emails/unable-to-delete-repo.html b/src/sentry/templates/sentry/emails/unable-to-delete-repo.html
index 9315e0f9dc..59d974eb4f 100644
--- a/src/sentry/templates/sentry/emails/unable-to-delete-repo.html
+++ b/src/sentry/templates/sentry/emails/unable-to-delete-repo.html
@@ -1,9 +1,10 @@
 {% extends "sentry/emails/base.html" %}
 
 {% block main %}
-  <h3>Unable to Delete Repository</h3>
-  <p>We were unable to delete your repository (<em>{{ repo.name }}</em>) due to the following error:</p>
+  <h3>Unable to Delete Repository Webhooks</h3>
+  <p>We were unable to delete webhooks in {{ provider_name }} for your repository (<em>{{ repo.name }}</em>) due to the following error:</p>
   <p>{{ error_message }}</p>
+  <p>You will need to remove these webhooks manually in {{ provider_name }} in order to stop sending commit data to Sentry.</p>
 {% endblock %}
 
 {% block footer %}{% endblock %}
diff --git a/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt b/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt
index 57133fc7ab..3f08ec3385 100644
--- a/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt
+++ b/src/sentry/templates/sentry/emails/unable-to-delete-repo.txt
@@ -1,6 +1,7 @@
 Unable to Delete Repo
 ---------------------
 
-We were unable to delete your repository ({{ repo.name }}) due to the following error:
-
+We were unable to delete webhooks in {{ provider_name }} for your repository (<em>{{ repo.name }}</em>) due to the following error:
 {{ error_message }}
+
+You will need to remove these webhooks manually in {{ provider_name }} in order to stop sending commit data to Sentry.
diff --git a/src/sentry/web/frontend/debug/debug_unable_to_delete_repository.py b/src/sentry/web/frontend/debug/debug_unable_to_delete_repository.py
index 370e566c5a..db8421cfb0 100644
--- a/src/sentry/web/frontend/debug/debug_unable_to_delete_repository.py
+++ b/src/sentry/web/frontend/debug/debug_unable_to_delete_repository.py
@@ -1,15 +1,23 @@
 from __future__ import absolute_import, print_function
 
+import types
+
 from django.views.generic import View
 
 from sentry.models import Repository
+from sentry.plugins.providers.dummy import DummyRepositoryProvider
 
 from .mail import MailPreview
 
 
 class DebugUnableToDeleteRepository(View):
     def get(self, request):
-        repo = Repository(name='getsentry/sentry')
+
+        def mock_get_provider(self):
+            return DummyRepositoryProvider('dummy')
+
+        repo = Repository(name='getsentry/sentry', provider='dummy')
+        repo.get_provider = types.MethodType(mock_get_provider, repo)
 
         email = repo.generate_delete_fail_email(
             'An internal server error occurred'
diff --git a/tests/sentry/deletions/test_repository.py b/tests/sentry/deletions/test_repository.py
index 0b89b132f6..e23f8e5c99 100644
--- a/tests/sentry/deletions/test_repository.py
+++ b/tests/sentry/deletions/test_repository.py
@@ -58,14 +58,14 @@ class DeleteRepositoryTest(TestCase):
         deletion = ScheduledDeletion.schedule(repo, actor=self.user, days=0)
         deletion.update(in_progress=True)
 
-        with self.assertRaises(PluginError):
-            with self.tasks():
-                run_deletion(deletion.id)
+        with self.tasks():
+            run_deletion(deletion.id)
 
         msg = mail.outbox[-1]
-        assert msg.subject == 'Unable to Delete Repository'
+        assert msg.subject == 'Unable to Delete Repository Webhooks'
         assert msg.to == [self.user.email]
         assert 'foo' in msg.body
+        assert not Repository.objects.filter(id=repo.id).exists()
 
     @patch('sentry.plugins.providers.dummy.repository.DummyRepositoryProvider.delete_repository')
     def test_delete_fail_email_random(self, mock_delete_repo):
@@ -81,11 +81,11 @@ class DeleteRepositoryTest(TestCase):
         deletion = ScheduledDeletion.schedule(repo, actor=self.user, days=0)
         deletion.update(in_progress=True)
 
-        with self.assertRaises(Exception):
-            with self.tasks():
-                run_deletion(deletion.id)
+        with self.tasks():
+            run_deletion(deletion.id)
 
         msg = mail.outbox[-1]
-        assert msg.subject == 'Unable to Delete Repository'
+        assert msg.subject == 'Unable to Delete Repository Webhooks'
         assert msg.to == [self.user.email]
         assert 'secrets' not in msg.body
+        assert not Repository.objects.filter(id=repo.id).exists()
