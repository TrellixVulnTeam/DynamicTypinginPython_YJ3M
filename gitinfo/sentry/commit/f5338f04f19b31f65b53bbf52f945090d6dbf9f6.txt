commit f5338f04f19b31f65b53bbf52f945090d6dbf9f6
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Wed Apr 24 11:37:09 2019 -0700

    fix(discover): Handle custom tags with error.* or stack.* format (#12896)
    
    Check the list of built in Snuba fields before treating custom tags with
    the error.* or stack.* format as built in fields. This caused conditions
    in this format on these fields to fail.
    
    Fixes ISSUE-438, SENTRY-95K

diff --git a/src/sentry/api/endpoints/organization_discover_query.py b/src/sentry/api/endpoints/organization_discover_query.py
index d49156372e..9acb461d9b 100644
--- a/src/sentry/api/endpoints/organization_discover_query.py
+++ b/src/sentry/api/endpoints/organization_discover_query.py
@@ -15,6 +15,7 @@ from sentry.api.paginator import GenericOffsetPaginator
 from sentry.api.utils import get_date_range_from_params, InvalidParams
 from sentry.models import Project, ProjectStatus
 from sentry.utils import snuba
+from sentry.utils.snuba import SENTRY_SNUBA_MAP
 from sentry import features
 
 
@@ -141,7 +142,10 @@ class DiscoverQuerySerializer(serializers.Serializer):
 
     def get_array_field(self, field):
         pattern = r"^(error|stack)\..+"
-        return re.search(pattern, field)
+        term = re.search(pattern, field)
+        if term and SENTRY_SNUBA_MAP.get(field):
+            return term
+        return None
 
     def get_condition(self, condition):
         array_field = self.get_array_field(condition[0])
diff --git a/tests/snuba/api/endpoints/test_organization_discover_query.py b/tests/snuba/api/endpoints/test_organization_discover_query.py
index 09da54353b..e6f3876995 100644
--- a/tests/snuba/api/endpoints/test_organization_discover_query.py
+++ b/tests/snuba/api/endpoints/test_organization_discover_query.py
@@ -30,7 +30,7 @@ class OrganizationDiscoverQueryTest(APITestCase, SnubaTestCase):
             group=self.group,
             platform="python",
             datetime=one_second_ago,
-            tags={'environment': 'production', 'sentry:release': 'foo'},
+            tags={'environment': 'production', 'sentry:release': 'foo', 'error.custom': 'custom'},
             data={
                 'message': 'message!',
                 'exception': {
@@ -294,6 +294,22 @@ class OrganizationDiscoverQueryTest(APITestCase, SnubaTestCase):
         assert response.status_code == 200, response.content
         assert len(response.data['data']) == 0
 
+    def test_array_condition_custom_tag(self):
+        with self.feature('organizations:discover'):
+            url = reverse('sentry-api-0-organization-discover-query', args=[self.org.slug])
+            response = self.client.post(url, {
+                'projects': [self.project.id],
+                'conditions': [['error.custom', '!=', 'custom']],
+                'fields': ['message'],
+                'start': (datetime.now() - timedelta(seconds=10)).strftime('%Y-%m-%dT%H:%M:%S'),
+                'end': (datetime.now()).strftime('%Y-%m-%dT%H:%M:%S'),
+                'orderby': '-timestamp',
+                'range': None,
+            })
+
+        assert response.status_code == 200, response.content
+        assert len(response.data['data']) == 0
+
     def test_select_project_name(self):
         with self.feature('organizations:discover'):
             url = reverse('sentry-api-0-organization-discover-query', args=[self.org.slug])
