commit 2b91bff16ba9da6b2d40dbb6799156d78965d32f
Author: Chris Fuller <cfuller@sentry.io>
Date:   Wed Apr 15 16:19:48 2020 -0400

    fix(workflow): Only include users to an alert's viewing history if member of org + project (#18280)
    
    * Adding org and project level checks for alert seenBy

diff --git a/src/sentry/incidents/logic.py b/src/sentry/incidents/logic.py
index 00adce3997..c0f8ebcfed 100644
--- a/src/sentry/incidents/logic.py
+++ b/src/sentry/incidents/logic.py
@@ -177,11 +177,25 @@ def set_incident_seen(incident, user=None):
     """
     Updates the incident to be seen
     """
-    incident_seen, created = IncidentSeen.objects.create_or_update(
-        incident=incident, user=user, values={"last_seen": timezone.now()}
-    )
 
-    return incident_seen
+    is_org_member = incident.organization.has_access(user)
+
+    if is_org_member:
+        is_project_member = False
+        for incident_project in IncidentProject.objects.filter(incident=incident).select_related(
+            "project"
+        ):
+            if incident_project.project.member_set.filter(user=user).exists():
+                is_project_member = True
+                break
+
+        if is_project_member:
+            incident_seen, created = IncidentSeen.objects.create_or_update(
+                incident=incident, user=user, values={"last_seen": timezone.now()}
+            )
+            return incident_seen
+
+    return False
 
 
 @transaction.atomic
