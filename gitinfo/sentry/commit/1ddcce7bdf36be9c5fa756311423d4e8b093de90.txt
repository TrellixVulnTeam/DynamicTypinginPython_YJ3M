commit 1ddcce7bdf36be9c5fa756311423d4e8b093de90
Author: Chris Fuller <chris@iprogramstuff.com>
Date:   Thu Aug 15 14:55:40 2019 -0700

    fix(api): Adding dynamic limit calculation for snuba TS query. (#14407)
    
    Fixes an issue when there were more than 1000 results, causing data loss and incorrect API response. The limit was defaulting to 1000, but we required more (say, 2400). We now calculate the limit and send in the query call.

diff --git a/src/sentry/tsdb/snuba.py b/src/sentry/tsdb/snuba.py
index dd1bc90f70..8e768193b6 100644
--- a/src/sentry/tsdb/snuba.py
+++ b/src/sentry/tsdb/snuba.py
@@ -76,6 +76,7 @@ class SnubaTSDB(BaseTSDB):
         rollup, series = self.get_optimal_rollup_series(start, end, rollup)
         start = to_datetime(series[0])
         end = to_datetime(series[-1] + rollup)
+        limit = min(10000, len(keys) * ((end - start).total_seconds() / rollup))
 
         if keys:
             result = snuba.query(
@@ -86,6 +87,7 @@ class SnubaTSDB(BaseTSDB):
                 filter_keys=keys_map,
                 aggregations=aggregations,
                 rollup=rollup,
+                limit=limit,
                 referrer='tsdb',
                 is_grouprelease=(model == TSDBModel.frequent_releases_by_group)
             )
diff --git a/tests/snuba/tsdb/test_tsdb_backend.py b/tests/snuba/tsdb/test_tsdb_backend.py
index d3900dcad7..6e5d221752 100644
--- a/tests/snuba/tsdb/test_tsdb_backend.py
+++ b/tests/snuba/tsdb/test_tsdb_backend.py
@@ -8,6 +8,7 @@ import requests
 import six
 
 from django.conf import settings
+from mock import patch
 
 from sentry.models import GroupHash, GroupRelease, Release
 from sentry.tsdb.base import TSDBModel
@@ -493,3 +494,32 @@ class SnubaTSDBTest(TestCase, SnubaTestCase):
         results = self.db.get_distinct_counts_union(TSDBModel.users_affected_by_project,
                                                     [project_id], dts[0], dts[-1])
         assert has_shape(results, 1)
+
+    def test_calculated_limit(self):
+
+        with patch('sentry.tsdb.snuba.snuba') as snuba:
+            # 24h test
+            rollup = 3600
+            end = self.now
+            start = end + timedelta(days=-1, seconds=rollup)
+            self.db.get_data(TSDBModel.group,
+                             [1, 2, 3, 4, 5], start, end,
+                             rollup=rollup)
+            assert snuba.query.call_args[1]['limit'] == 120
+
+            # 14 day test
+            rollup = 86400
+            start = end + timedelta(days=-14, seconds=rollup)
+            self.db.get_data(TSDBModel.group,
+                             [1, 2, 3, 4, 5], start, end,
+                             rollup=rollup)
+            assert snuba.query.call_args[1]['limit'] == 70
+
+            # 1h test
+            rollup = 3600
+            end = self.now
+            start = end + timedelta(hours=-1, seconds=rollup)
+            self.db.get_data(TSDBModel.group,
+                             [1, 2, 3, 4, 5], start, end,
+                             rollup=rollup)
+            assert snuba.query.call_args[1]['limit'] == 5
