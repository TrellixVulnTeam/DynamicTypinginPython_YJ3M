commit 5b0218e9d63949d224b4d6e00997d06bdfff3974
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Thu Jan 9 11:30:20 2020 -0800

    fix(saml2): Improve error message on attribute mapping (#16347)

diff --git a/src/sentry/auth/helper.py b/src/sentry/auth/helper.py
index 0e820579d5..fd000af390 100644
--- a/src/sentry/auth/helper.py
+++ b/src/sentry/auth/helper.py
@@ -4,6 +4,7 @@ import logging
 
 from uuid import uuid4
 
+import six
 from django.conf import settings
 from django.contrib import messages
 from django.core.urlresolvers import reverse
@@ -637,8 +638,8 @@ class AuthHelper(object):
 
         try:
             identity = self.provider.build_identity(data)
-        except IdentityNotValid:
-            return self.error(ERR_INVALID_IDENTITY)
+        except IdentityNotValid as error:
+            return self.error(six.text_type(error) or ERR_INVALID_IDENTITY)
 
         if self.state.flow == self.FLOW_LOGIN:
             # create identity and authenticate the user
diff --git a/src/sentry/auth/providers/saml2/provider.py b/src/sentry/auth/providers/saml2/provider.py
index 4930894186..5707b35a60 100644
--- a/src/sentry/auth/providers/saml2/provider.py
+++ b/src/sentry/auth/providers/saml2/provider.py
@@ -299,7 +299,12 @@ class SAML2Provider(Provider):
 
         # Email and identifier MUST be correctly mapped
         if not attributes[Attributes.IDENTIFIER] or not attributes[Attributes.USER_EMAIL]:
-            raise IdentityNotValid
+            raise IdentityNotValid(
+                _(
+                    "Failed to map SAML attributes. Assertion returned the following attribute keys: %(keys)s"
+                )
+                % {"keys": raw_attributes.keys()}
+            )
 
         name = (attributes[k] for k in (Attributes.FIRST_NAME, Attributes.LAST_NAME))
         name = " ".join(filter(None, name))
diff --git a/src/sentry/static/sentry/app/views/app.jsx b/src/sentry/static/sentry/app/views/app.jsx
index 8def0f99dc..75b5052d25 100644
--- a/src/sentry/static/sentry/app/views/app.jsx
+++ b/src/sentry/static/sentry/app/views/app.jsx
@@ -114,6 +114,7 @@ class App extends React.Component {
       AlertActions.addAlert({
         message: msg.message,
         type: msg.level,
+        neverExpire: true,
       });
     });
 
