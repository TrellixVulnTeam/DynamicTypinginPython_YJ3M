commit 049ef422a0223c746f7dc840eb0d61c9fe9fd115
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Dec 26 18:47:31 2011 -0800

    Added duration output to details and event lists

diff --git a/sentry/models.py b/sentry/models.py
index 3926ba2593..442db77daa 100644
--- a/sentry/models.py
+++ b/sentry/models.py
@@ -253,6 +253,12 @@ class Group(MessageBase):
         module = self.data.get('module', 'ver')
         return module, self.data['version']
 
+    @property
+    def avg_time_spent(self):
+        if not self.time_spent_count:
+            return
+        return float(self.time_spent_total / self.time_spent_count)
+
 
 class Event(MessageBase):
     event_id = models.CharField(max_length=32, null=True, unique=True, db_column="message_id")
diff --git a/sentry/static/styles/global.css b/sentry/static/styles/global.css
index 8124a4a1cd..a29245da9a 100644
--- a/sentry/static/styles/global.css
+++ b/sentry/static/styles/global.css
@@ -284,14 +284,17 @@ dl.flat dd {
     position: absolute;
 }
 
-.messages .last_seen {
+.messages .last_seen,
+.messages .time_spent {
     color: #bbb;
     font-size: 0.9em;
-    margin-left: 5px;
+    margin-left: 8px;
+    margin-top: 3px;
     white-space: nowrap;
     vertical-align: middle;
     display: inline-block;
 }
+
 .messages .status { margin-left: 5px; text-transform: uppercase; font-size: 0.9em; }
 .messages .status-0 { display: none; }
 .messages .status-1 { color: red; }
@@ -305,7 +308,10 @@ dl.flat dd {
 .messages li:hover h3 a {
     color: #0099dc;
 }
-.messages li:hover .last_seen, .messages .active .last_seen { color: #777; }
+.messages li:hover .last_seen,
+.messages .active .last_seen,
+.messages li:hover .time_spent,
+.messages .active .time_spent { color: #777; }
 
 .button {
     cursor: pointer;
diff --git a/sentry/templates/sentry/groups/details.html b/sentry/templates/sentry/groups/details.html
index fd4c63d1a6..0554054454 100644
--- a/sentry/templates/sentry/groups/details.html
+++ b/sentry/templates/sentry/groups/details.html
@@ -34,6 +34,8 @@
         <dd title="{{ group.first_seen }}">{{ group.first_seen|timesince }}</dd>
         <dt>{% trans "Last Seen:" %}</dt>
         <dd title="{{ group.first_seen }}">{{ group.last_seen|timesince }}</dd>
+        <dt>{% trans "Avg Duration:" %}</dt>
+        <dd>{% if group.avg_time_spent %}{{ group.avg_time_spent }}{% else %}<em>n/a</em>{% endif %}</dd>
         <dt>{% trans "Checksum:" %}</dt>
         <dd>{{ group.checksum }}</dd>
     </dl>
diff --git a/sentry/templates/sentry/partial/_event.html b/sentry/templates/sentry/partial/_event.html
index b7760eb420..5a568ffe05 100644
--- a/sentry/templates/sentry/partial/_event.html
+++ b/sentry/templates/sentry/partial/_event.html
@@ -3,6 +3,9 @@
 <li class="{% cycle 'row1' 'row2' %} level-{{ event.level }}{% if priority %} priority-{{ priority }}{% endif %}" id="message_{{ event.pk }}">
     <h3><a href="{% url sentry-group-event event.project_id event.group_id event.pk %}">{% if event.view %}{{ event.view }}{% else %}{{ event.message_top|truncatechars:100 }}{% endif %}</a></h3>
     <span class="last_seen">{{ event.datetime|timesince }}</span>
+    {% if event.time_spent %}
+        <span class="time_spent">{{ event.time_spent|duration }}</span>
+    {% endif %}
     <span class="status status-{{ event.status }}">{{ event.get_status_display }}</span>
     <p class="message" title="{{ event.message }}">
         <span class="tag tag-level">{{ event.get_level_display }}</span>
diff --git a/sentry/templates/sentry/partial/_group.html b/sentry/templates/sentry/partial/_group.html
index c44665e48a..a7f352c4e0 100644
--- a/sentry/templates/sentry/partial/_group.html
+++ b/sentry/templates/sentry/partial/_group.html
@@ -4,6 +4,9 @@
     <span class="count">{{ group.times_seen }}</span>
     <h3><a href="{% url sentry-group group.project_id group.pk %}">{% if group.view %}{{ group.view }}{% else %}{{ group.message_top|truncatechars:100 }}{% endif %}</a></h3>
     <span class="last_seen">{{ group.last_seen|timesince }}</span>
+    {% if group.avg_time_spent %}
+        <span class="time_spent">{{ group.avg_time_spent|duration }}</span>
+    {% endif %}
     <span class="status status-{{ group.status }}">{{ group.get_status_display }}</span>
     <p class="message" title="{{ group.message }}">
         <span class="tag tag-level">{{ group.get_level_display }}</span>
diff --git a/sentry/templatetags/sentry_helpers.py b/sentry/templatetags/sentry_helpers.py
index 7b343ad952..7e46436524 100644
--- a/sentry/templatetags/sentry_helpers.py
+++ b/sentry/templatetags/sentry_helpers.py
@@ -169,6 +169,28 @@ def timesince(value):
     return value + _(' ago')
 
 
+@register.filter
+def duration(value):
+    if not value:
+        return '0s'
+    hours, minutes, seconds = 0, 0, 0
+    if value > 3600:
+        hours = value / 3600
+        value = value % 3600
+    if value > 60:
+        minutes = value / 60
+        value = value % 60
+    seconds = value / 60
+    output = []
+    if hours:
+        output.append('%sh' % hours[-2:])
+    if minutes:
+        output.append('%sm' % minutes[-2:])
+    if seconds:
+        output.append('%ss' % seconds[-2:])
+    return ''.join(output)
+
+
 @register.filter(name='truncatechars')
 @stringfilter
 def truncatechars(value, arg):
