commit 947f5aa0e1b2a7d014c65c38c1971dbe565254d9
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Tue Apr 16 09:38:12 2019 -0700

    fix(account-settings): Fix removing an API Application [SEN-492] (#12791)
    
    Fixes JAVASCRIPT-9RZ

diff --git a/src/sentry/static/sentry/app/views/settings/account/apiApplications.jsx b/src/sentry/static/sentry/app/views/settings/account/apiApplications.jsx
index f03fe917b8..49386ad10f 100644
--- a/src/sentry/static/sentry/app/views/settings/account/apiApplications.jsx
+++ b/src/sentry/static/sentry/app/views/settings/account/apiApplications.jsx
@@ -12,7 +12,6 @@ import {
   removeIndicator,
 } from 'app/actionCreators/indicator';
 import {t} from 'app/locale';
-import withApi from 'app/utils/withApi';
 import AsyncView from 'app/views/asyncView';
 import Button from 'app/components/button';
 import EmptyMessage from 'app/views/settings/components/emptyMessage';
@@ -95,6 +94,7 @@ const ApiApplicationRow = createReactClass({
         <Flex align="center">
           <Box pl={2}>
             <a
+              aria-label="Remove"
               onClick={this.handleRemove}
               className={btnClassName}
               disabled={this.state.loading}
@@ -123,7 +123,7 @@ class ApiApplications extends AsyncView {
 
   handleCreateApplication = () => {
     const indicator = addLoadingMessage();
-    this.props.api.request('/api-applications/', {
+    this.api.request('/api-applications/', {
       method: 'POST',
       success: app => {
         addSuccessMessage(t('Created a new API Application'));
@@ -148,7 +148,6 @@ class ApiApplications extends AsyncView {
       <Button
         priority="primary"
         size="small"
-        className="ref-create-application"
         onClick={this.handleCreateApplication}
         icon="icon-circle-add"
       >
@@ -176,6 +175,7 @@ class ApiApplications extends AsyncView {
               this.state.appList.map(app => {
                 return (
                   <ApiApplicationRow
+                    api={this.api}
                     key={app.id}
                     app={app}
                     onRemove={this.handleRemoveApplication}
@@ -194,6 +194,4 @@ class ApiApplications extends AsyncView {
   }
 }
 
-export {ApiApplications};
-
-export default withApi(ApiApplications);
+export default ApiApplications;
diff --git a/src/sentry/static/sentry/app/views/settings/components/emptyMessage.jsx b/src/sentry/static/sentry/app/views/settings/components/emptyMessage.jsx
index 22318952cd..ff58af3d0a 100644
--- a/src/sentry/static/sentry/app/views/settings/components/emptyMessage.jsx
+++ b/src/sentry/static/sentry/app/views/settings/components/emptyMessage.jsx
@@ -51,7 +51,7 @@ const Action = styled.div`
 
 const EmptyMessage = ({title, description, icon, children, action, size}) => {
   return (
-    <Wrapper size={size}>
+    <Wrapper data-test-id="empty-message" size={size}>
       {icon && <StyledInlineSvg src={icon} size="36px" />}
       {title && <Title>{title}</Title>}
       {description && <Description>{description}</Description>}
diff --git a/tests/acceptance/test_api.py b/tests/acceptance/test_api.py
index a47d114b67..fc4a252bae 100644
--- a/tests/acceptance/test_api.py
+++ b/tests/acceptance/test_api.py
@@ -36,7 +36,7 @@ class ApiApplicationTest(AcceptanceTestCase):
         self.browser.wait_until_not('.loading')
         self.browser.snapshot('api applications - no applications')
 
-        self.browser.click_when_visible('.ref-create-application')
+        self.browser.click_when_visible('[aria-label="Create New Application"]')
         self.browser.wait_until_not('.loading')
         self.browser.snapshot('api applications - new application')
 
@@ -45,3 +45,9 @@ class ApiApplicationTest(AcceptanceTestCase):
         self.browser.click_when_visible('.ref-toast')
         self.browser.wait_until_not('.ref-toast')
         self.browser.snapshot('api applications - single application')
+
+        self.browser.get(self.path)
+        self.browser.wait_until_not('.loading')
+        self.browser.click_when_visible('[aria-label="Remove"]')
+        self.browser.wait_until_not('.ref-toast')
+        self.browser.wait_until_test_id('empty-message')
diff --git a/tests/js/fixtures/apiApplication.jsx b/tests/js/fixtures/apiApplication.jsx
new file mode 100644
index 0000000000..1233a7bc21
--- /dev/null
+++ b/tests/js/fixtures/apiApplication.jsx
@@ -0,0 +1,13 @@
+export function ApiApplication(params = {}) {
+  return {
+    allowedOrigins: [],
+    clientID: 'aowekr12903i9i423094i23904j',
+    clientSecret: null,
+    homepageUrl: null,
+    id: '123',
+    name: 'Adjusted Shrimp',
+    privacyUrl: null,
+    redirectUris: [],
+    ...params,
+  };
+}
diff --git a/tests/js/spec/views/__snapshots__/projectEnvironments.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectEnvironments.spec.jsx.snap
index 593423da74..f5ef6c5f64 100644
--- a/tests/js/spec/views/__snapshots__/projectEnvironments.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectEnvironments.spec.jsx.snap
@@ -366,9 +366,12 @@ exports[`ProjectEnvironments render active renders empty message 1`] = `
               className="css-9vq8an-textStyles"
             >
               <EmptyMessage>
-                <Wrapper>
+                <Wrapper
+                  data-test-id="empty-message"
+                >
                   <div
                     className="css-ev9qm0-Wrapper eh488yo0"
+                    data-test-id="empty-message"
                   >
                     <Description
                       noMargin={true}
@@ -1891,9 +1894,12 @@ exports[`ProjectEnvironments render hidden renders empty message 1`] = `
               className="css-9vq8an-textStyles"
             >
               <EmptyMessage>
-                <Wrapper>
+                <Wrapper
+                  data-test-id="empty-message"
+                >
                   <div
                     className="css-ev9qm0-Wrapper eh488yo0"
+                    data-test-id="empty-message"
                   >
                     <Description
                       noMargin={true}
diff --git a/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap b/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap
index df86bcd709..3ae2670d37 100644
--- a/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap
+++ b/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap
@@ -629,9 +629,12 @@ exports[`InviteMember should render roles when available and allowed, and handle
                     className="css-9vq8an-textStyles"
                   >
                     <EmptyMessage>
-                      <Wrapper>
+                      <Wrapper
+                        data-test-id="empty-message"
+                      >
                         <div
                           className="css-ev9qm0-Wrapper eh488yo0"
+                          data-test-id="empty-message"
                         >
                           <Description
                             noMargin={true}
diff --git a/tests/js/spec/views/settings/account/apiApplications.spec.jsx b/tests/js/spec/views/settings/account/apiApplications.spec.jsx
new file mode 100644
index 0000000000..057bb3653f
--- /dev/null
+++ b/tests/js/spec/views/settings/account/apiApplications.spec.jsx
@@ -0,0 +1,82 @@
+import React from 'react';
+
+import {initializeOrg} from 'app-test/helpers/initializeOrg';
+import {mount} from 'enzyme';
+import ApiApplications from 'app/views/settings/account/apiApplications';
+
+describe('ApiApplications', function() {
+  let requestMock;
+  let wrapper;
+  const {router, routerContext} = initializeOrg();
+
+  const createWrapper = props => {
+    wrapper = mount(<ApiApplications {...props} />, routerContext);
+  };
+
+  beforeEach(function() {
+    MockApiClient.clearMockResponses();
+    requestMock = MockApiClient.addMockResponse({
+      url: '/api-applications/',
+      body: [TestStubs.ApiApplication()],
+    });
+  });
+
+  afterEach(function() {
+    if (wrapper) {
+      wrapper.unmount();
+      wrapper = null;
+    }
+  });
+
+  it('renders empty', async function() {
+    requestMock = MockApiClient.addMockResponse({
+      url: '/api-applications/',
+      body: [],
+    });
+    createWrapper();
+    expect(wrapper.find('EmptyMessage')).toHaveLength(1);
+  });
+
+  it('renders', async function() {
+    createWrapper();
+
+    expect(requestMock).toHaveBeenCalled();
+
+    expect(wrapper.find('ApiApplicationRow')).toHaveLength(1);
+  });
+
+  it('creates application', async function() {
+    const createApplicationRequest = MockApiClient.addMockResponse({
+      url: '/api-applications/',
+      body: TestStubs.ApiApplication({
+        id: '234',
+      }),
+      method: 'POST',
+    });
+    createWrapper();
+
+    wrapper.find('Button').simulate('click');
+    expect(createApplicationRequest).toHaveBeenCalledWith(
+      '/api-applications/',
+      expect.objectContaining({method: 'POST'})
+    );
+    expect(router.push).toHaveBeenLastCalledWith(
+      '/settings/account/api/applications/234/'
+    );
+  });
+
+  it('deletes application', async function() {
+    const deleteApplicationRequest = MockApiClient.addMockResponse({
+      url: '/api-applications/123/',
+      method: 'DELETE',
+    });
+    createWrapper();
+
+    wrapper.find('a[aria-label="Remove"]').simulate('click');
+    expect(deleteApplicationRequest).toHaveBeenCalledWith(
+      '/api-applications/123/',
+      expect.objectContaining({method: 'DELETE'})
+    );
+    expect(wrapper.find('EmptyMessage')).toHaveLength(1);
+  });
+});
diff --git a/tests/js/spec/views/settings/organizationDeveloperSettings/__snapshots__/index.spec.jsx.snap b/tests/js/spec/views/settings/organizationDeveloperSettings/__snapshots__/index.spec.jsx.snap
index 7247c26ba7..6f6834610d 100644
--- a/tests/js/spec/views/settings/organizationDeveloperSettings/__snapshots__/index.spec.jsx.snap
+++ b/tests/js/spec/views/settings/organizationDeveloperSettings/__snapshots__/index.spec.jsx.snap
@@ -294,9 +294,12 @@ exports[`Organization Developer Settings when no Apps exist displays empty state
                     className="css-9vq8an-textStyles"
                   >
                     <EmptyMessage>
-                      <Wrapper>
+                      <Wrapper
+                        data-test-id="empty-message"
+                      >
                         <div
                           className="css-ev9qm0-Wrapper eh488yo0"
+                          data-test-id="empty-message"
                         >
                           <Description
                             noMargin={true}
