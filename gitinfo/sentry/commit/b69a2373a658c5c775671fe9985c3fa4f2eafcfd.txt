commit b69a2373a658c5c775671fe9985c3fa4f2eafcfd
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Mar 11 20:04:02 2014 -0700

    Optimize for chained exceptions with spotty data

diff --git a/src/sentry/interfaces.py b/src/sentry/interfaces.py
index d8fb105d5e..5b9f13c704 100644
--- a/src/sentry/interfaces.py
+++ b/src/sentry/interfaces.py
@@ -889,9 +889,21 @@ class Exception(Interface):
         return output
 
     def get_composite_hash(self, interfaces):
+        # optimize around the fact that some exceptions might have stacktraces
+        # while others may not and we ALWAYS want stacktraces over values
         output = []
         for value in self.values:
-            output.extend(value.get_composite_hash(interfaces))
+            if not value.stacktrace:
+                continue
+            stack_hash = value.stacktrace.get_hash()
+            if stack_hash:
+                output.extend(stack_hash)
+                output.append(value.type)
+
+        if not output:
+            for value in self.values:
+                output.extend(value.get_composite_hash(interfaces))
+
         return output
 
     def get_context(self, event, is_public=False, **kwargs):
