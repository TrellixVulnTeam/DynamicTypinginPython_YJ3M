commit bc066bd25a21ae1b0b701b9517c827ad6b8e34a5
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Apr 7 23:25:27 2013 -0700

    Better visuals for substacks and correct expansion

diff --git a/src/sentry/interfaces.py b/src/sentry/interfaces.py
index b8f12797c3..0cbdaffcea 100644
--- a/src/sentry/interfaces.py
+++ b/src/sentry/interfaces.py
@@ -534,6 +534,7 @@ class Stacktrace(Interface):
             'system_frames': system_frames,
             'event': event,
             'frames': frames,
+            'stack_id': 'stacktrace_1',
         }
         if with_stacktrace:
             context['stacktrace'] = self.get_traceback(event, newest_first=newest_first)
@@ -771,13 +772,14 @@ class Exception(Interface):
         }
 
         exceptions = []
-        for e in self.values:
+        for num, e in enumerate(self.values):
             context = e.get_context(**context_kwargs)
             if e.stacktrace:
                 context['stacktrace'] = e.stacktrace.get_context(
                     with_stacktrace=False, **context_kwargs)
             else:
                 context['stacktrace'] = {}
+            context['stack_id'] = 'exception_%d' % (num,)
             exceptions.append(context)
         return {
             'newest_first': newest_first,
diff --git a/src/sentry/static/sentry/less/sentry.less b/src/sentry/static/sentry/less/sentry.less
index 92b4fbe9fe..b98adaf67a 100644
--- a/src/sentry/static/sentry/less/sentry.less
+++ b/src/sentry/static/sentry/less/sentry.less
@@ -1243,21 +1243,38 @@ ul.traceback {
   margin-bottom: 0;
 }
 
-.module-traceback h3 {
+.traceback > h3 {
   margin-top: 0;
   font-weight: normal;
+
   span {
     font-weight: bold;
   }
 }
-.module-traceback p {
+.traceback > p {
   color: #666;
   font-size: 0.9em;
   margin-left: 15px;
 }
-.module-traceback .traceback {
+.traceback > .traceback {
   margin-top: 10px;
 }
+.subtraceback {
+  padding-left: 20px;
+  border-left: 2px solid #dee3e9;
+  position: relative;
+
+  > h3:before {
+    display: block;
+    content: "";
+    width: 15px;
+    height: 0;
+    border-bottom: 2px solid #dee3e9;
+    position: absolute;
+    left: 0;
+    top: 12px;
+  }
+}
 
 .frame {
   overflow: hidden;
diff --git a/src/sentry/static/sentry/styles/global.min.css b/src/sentry/static/sentry/styles/global.min.css
index 177f20da84..95861958f6 100644
--- a/src/sentry/static/sentry/styles/global.min.css
+++ b/src/sentry/static/sentry/styles/global.min.css
@@ -7468,21 +7468,36 @@ ul.traceback {
   margin-left: 0;
   margin-bottom: 0;
 }
-.module-traceback h3 {
+.traceback > h3 {
   margin-top: 0;
   font-weight: normal;
 }
-.module-traceback h3 span {
+.traceback > h3 span {
   font-weight: bold;
 }
-.module-traceback p {
+.traceback > p {
   color: #666;
   font-size: 0.9em;
   margin-left: 15px;
 }
-.module-traceback .traceback {
+.traceback > .traceback {
   margin-top: 10px;
 }
+.subtraceback {
+  padding-left: 20px;
+  border-left: 2px solid #dee3e9;
+  position: relative;
+}
+.subtraceback > h3:before {
+  display: block;
+  content: "";
+  width: 15px;
+  height: 0;
+  border-bottom: 2px solid #dee3e9;
+  position: absolute;
+  left: 0;
+  top: 12px;
+}
 .frame {
   overflow: hidden;
   position: relative;
diff --git a/src/sentry/static/sentry/styles/sentry.css b/src/sentry/static/sentry/styles/sentry.css
index 177f20da84..95861958f6 100644
--- a/src/sentry/static/sentry/styles/sentry.css
+++ b/src/sentry/static/sentry/styles/sentry.css
@@ -7468,21 +7468,36 @@ ul.traceback {
   margin-left: 0;
   margin-bottom: 0;
 }
-.module-traceback h3 {
+.traceback > h3 {
   margin-top: 0;
   font-weight: normal;
 }
-.module-traceback h3 span {
+.traceback > h3 span {
   font-weight: bold;
 }
-.module-traceback p {
+.traceback > p {
   color: #666;
   font-size: 0.9em;
   margin-left: 15px;
 }
-.module-traceback .traceback {
+.traceback > .traceback {
   margin-top: 10px;
 }
+.subtraceback {
+  padding-left: 20px;
+  border-left: 2px solid #dee3e9;
+  position: relative;
+}
+.subtraceback > h3:before {
+  display: block;
+  content: "";
+  width: 15px;
+  height: 0;
+  border-bottom: 2px solid #dee3e9;
+  position: absolute;
+  left: 0;
+  top: 12px;
+}
 .frame {
   overflow: hidden;
   position: relative;
diff --git a/src/sentry/templates/sentry/partial/interfaces/chained_exception.html b/src/sentry/templates/sentry/partial/interfaces/chained_exception.html
index 6395be562b..24aa5805da 100644
--- a/src/sentry/templates/sentry/partial/interfaces/chained_exception.html
+++ b/src/sentry/templates/sentry/partial/interfaces/chained_exception.html
@@ -20,19 +20,23 @@
             {% endif %}</small>
         </h2>
     </div>
-    <div class="module-content module-traceback">
+    <div class="module-content">
         {% for exception in exceptions %}
-            {% if not forloop.first %}
-                <h3>Caused by <span title="{{ exception.fullname }}">{{ exception.exception_type }}</span></h3>
-            {% else %}
-                <h3><span title="{{ exception.fullname }}">{{ exception.exception_type }}</span></h3>
-            {% endif %}
-            {% if exception.exception_value %}
-                <p>{{ exception.exception_value }}</p>
-            {% endif %}
-            {% with exception.stacktrace.frames as frames %}
-                {% include "sentry/partial/interfaces/stacktrace_inner.html" %}
-            {% endwith %}
+            <div class="traceback{% if not forloop.first %} subtraceback{% endif %}">
+                {% if not forloop.first %}
+                    <h3>Caused by <span title="{{ exception.fullname }}">{{ exception.exception_type }}</span></h3>
+                {% else %}
+                    <h3><span title="{{ exception.fullname }}">{{ exception.exception_type }}</span></h3>
+                {% endif %}
+                {% if exception.exception_value %}
+                    <p>{{ exception.exception_value }}</p>
+                {% endif %}
+                {% with exception.stacktrace.frames as frames %}
+                    {% with exception.stack_id as stack_id %}
+                        {% include "sentry/partial/interfaces/stacktrace_inner.html" %}
+                    {% endwith %}
+                {% endwith %}
+            </div>
         {% endfor %}
     </div>
 </div>
diff --git a/src/sentry/templates/sentry/partial/interfaces/stacktrace_inner.html b/src/sentry/templates/sentry/partial/interfaces/stacktrace_inner.html
index 11779b013f..8854f6d4a6 100644
--- a/src/sentry/templates/sentry/partial/interfaces/stacktrace_inner.html
+++ b/src/sentry/templates/sentry/partial/interfaces/stacktrace_inner.html
@@ -3,7 +3,7 @@
 
 <ul class="traceback">
     {% for frame in frames %}
-        <li class="frame{% if not frame.in_app %} system-frame{% endif %} frame-{{ forloop.counter0 }}">
+        <li class="frame{% if not frame.in_app %} system-frame{% endif %} frame-{{ stack_id }}-{{ forloop.counter0 }}">
             <p>
                 {% if frame.filename %}
                     {% if frame.is_url %}
@@ -66,14 +66,14 @@
 
             {% if frame.context or frame.vars %}
                 <div class="commands">
-                    <a href="javascript:void(0)" onclick="$('.frame-{{ forloop.counter0 }}').toggleClass('expanded')" title="{% trans "Toggle Context" %}" rel="tooltip" class="tip">{% if frame.vars %}<i class="icon-info-sign"></i> {% endif %}{% if frame.context %}<i class="icon-tasks"></i> {% endif %}</a>
+                    <a href="javascript:void(0)" onclick="$('.frame-{{ stack_id }}-{{ forloop.counter0 }}').toggleClass('expanded')" title="{% trans "Toggle Context" %}" rel="tooltip" class="tip">{% if frame.vars %}<i class="icon-info-sign"></i> {% endif %}{% if frame.context %}<i class="icon-tasks"></i> {% endif %}</a>
                 </div>
             {% endif %}
 
             {% if frame.context %}
                 <ol start="{{ frame.start_lineno }}" class="context">
                 {% for num, line in frame.context %}
-                    <li{% if num == frame.lineno %} class="active"{% else %} class="expandable"{% endif %} onclick="$('.frame-{{ forloop.parentloop.counter0 }}').toggleClass('expanded')">{{ line }}</li>
+                    <li{% if num == frame.lineno %} class="active"{% else %} class="expandable"{% endif %} onclick="$('.frame-{{ stack_id }}-{{ forloop.parentloop.counter0 }}').toggleClass('expanded')">{{ line }}</li>
                 {% endfor %}
                 </ol>
             {% elif not frame.context_line|is_none %}
