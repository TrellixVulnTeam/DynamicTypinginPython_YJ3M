commit 42a5aeb5374f4f583f46cd7c4b6fedcb0e30046e
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Dec 4 21:28:49 2012 -0800

    Improve charts everywhere

diff --git a/src/sentry/static/sentry/less/sentry.less b/src/sentry/static/sentry/less/sentry.less
index a0e264b23d..0711ac7a4c 100644
--- a/src/sentry/static/sentry/less/sentry.less
+++ b/src/sentry/static/sentry/less/sentry.less
@@ -426,8 +426,37 @@ footer {
   }
 }
 
+.chart {
+  position: relative;
+
+  > .title {
+    font-size: 2em;
+    text-transform: uppercase;
+    position: absolute;
+    left: 1px;
+    top: 1px;
+    color: #dfe3e9;
+    .opacity(70);
+    background: #fff;
+    padding: 5px 8px;
+    line-height: 100%;
+  }
+
+  > .legend {
+    position: absolute;
+    left: 0;
+    top: 0;
+    width: 40px;
+    padding-left: 10px;
+    height: 100%;
+    text-align: left;
+    color: @linkColor;
+  }
+}
 .sparkline {
-  > span {
+  position: relative;
+
+  > a {
     position: relative;
     float: left;
     height: 100%;
diff --git a/src/sentry/static/sentry/scripts/app.js b/src/sentry/static/sentry/scripts/app.js
index 0bae5ea404..0a851b77f9 100644
--- a/src/sentry/static/sentry/scripts/app.js
+++ b/src/sentry/static/sentry/scripts/app.js
@@ -96,6 +96,8 @@
                 this.group_list.config.realtime = this.control.hasClass('realtime-pause');
                 this.updateStreamOptions();
             }, this));
+
+            app.charts.render('#chart');
         },
 
         updateStreamOptions: function(){
@@ -124,6 +126,15 @@
 
     });
 
+    app.GroupDetailsPage = BasePage.extend({
+
+        initialize: function(data){
+            BasePage.prototype.initialize.call(this, data);
+
+            app.charts.render('#chart');
+        }
+
+    });
 
     app.WallPage = BasePage.extend({
 
diff --git a/src/sentry/static/sentry/scripts/charts.js b/src/sentry/static/sentry/scripts/charts.js
index 53f1d0fb35..7c3a423ac3 100644
--- a/src/sentry/static/sentry/scripts/charts.js
+++ b/src/sentry/static/sentry/scripts/charts.js
@@ -10,26 +10,33 @@
         render: function(el) {
             var $el = $('#chart');
             var url = $el.attr('data-api-url');
+            var title = $(el).attr('data-title');
+            var $spark = $el.find('.sparkline');
+
+            $spark.height($el.height());
 
-            $el.height($el.parent().height());
             $.ajax({
                 url: $el.attr('data-api-url'),
                 type: 'get',
                 dataType: 'json',
                 data: {
-                    days: 7,
+                    days: $el.attr('data-days') || 7,
                     gid: $el.attr('data-group') || undefined
                 },
                 success: function(resp) {
-                    $el.empty();
-                    var data = [];
+                    var data = [], maxval = 10;
+                    $spark.empty();
                     $.each(resp, function(_, val){
+                        var date = new Date(val[0]);
                         data.push({
                             y: val[1],
-                            label: app.utils.prettyDate(new Date(val[0]))
+                            label: app.utils.prettyDate(date)
                         });
+                        if (val[1] > maxval) {
+                            maxval = val[1];
+                        }
                     });
-                    app.charts.createSparkline($el, data);
+                    app.charts.createSparkline($spark, data);
                 }
             });
         },
@@ -37,9 +44,9 @@
         createSparkline: function(el, points){
             // TODO: maxval could default to # of hours since first_seen / times_seen
             var $el = $(el),
-                existing = $el.find('> span'),
+                existing = $el.children(),
                 maxval = 10,
-                point, pct, child, point_width;
+                title, point, pct, child, point_width;
 
             for (var i=0; i<points.length; i++) {
                 point = points[i];
@@ -56,13 +63,19 @@
             point_width = app.utils.floatFormat(100.0 / points.length, 2) + '%';
 
             // TODO: we should only remove nodes that are no longer valid
-            for (i=0; (point = points[i]); i++) {
+            for (i=0; i<points.length; i++) {
+                point = points[i];
                 pct = app.utils.floatFormat(point.y / maxval * 99, 2) + '%';
-                child = existing[i];
-                if (child === undefined) {
-                    $('<span style="width:' + point_width + ';"><span style="height:' + pct + '" title="' + (point.label || point.y) + '">' + point.y + '</span></span>').appendTo($el);
+                title = point.y + ' events';
+                if (point.label) {
+                    title = title + '<br>(' + point.label + ')';
+                }
+                if (existing.get(i) === undefined) {
+                    $('<a style="width:' + point_width + ';" rel="tooltip" title="' + title + '"><span style="height:' + pct + '">' + point.y + '</span></a>').tooltip({
+                        placement: 'bottom'
+                    }).appendTo($el);
                 } else {
-                    $(child).find('span').css('height', pct).text(point.y).attr('title', (point.label || point.y));
+                    $(existing[i]).find('span').css('height', pct).text(point.y).attr('title', (point.label || point.y));
                 }
             }
         }
diff --git a/src/sentry/templates/sentry/dashboard.html b/src/sentry/templates/sentry/dashboard.html
index df7e78ec2f..272927a14f 100644
--- a/src/sentry/templates/sentry/dashboard.html
+++ b/src/sentry/templates/sentry/dashboard.html
@@ -9,8 +9,9 @@
 {% block main %}
     <section class="body">
         {% if PROJECT_LIST %}
-            <div style="height:200px;">
-                <div id="chart" class="sparkline" data-api-url="{% url sentry-api-chart %}">
+            <div style="height:50px;" id="chart" class="chart" data-api-url="{% url sentry-api-chart %}" data-title="{% trans "Events in the last 24 hours" %}">
+                <div class="sparkline">
+                    <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
                     <span class="loading">{% trans "Loading historical data..." %}</span>
                 </div>
             </div>
diff --git a/src/sentry/templates/sentry/groups/details.html b/src/sentry/templates/sentry/groups/details.html
index d35c794a50..4c32611588 100644
--- a/src/sentry/templates/sentry/groups/details.html
+++ b/src/sentry/templates/sentry/groups/details.html
@@ -158,10 +158,10 @@
                     <div class="page-header">
                         <h2>{% trans "Frequency" %}</h2>
                     </div>
-                    <div class="module-content" style="height: 120px;">
-                        <div id="chart" data-api-url="{% url sentry-api-chart project_id=project.slug %}" data-group="{{ group.id|safe }}">
+                    <div style="height:50px;" id="chart" class="chart" data-api-url="{% url sentry-api-chart project_id=project.slug %}" data-group="{{ group.id|safe }}">
+                        <div class="sparkline">
+                            <span class="loading">{% trans "Loading historical data..." %}</span>
                             <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
-                            <p>{% trans "Loading..." %}</p>
                         </div>
                     </div>
                 </div>
@@ -175,7 +175,7 @@
 {% block content_after %}
     <script type="text/javascript">
     $(document).ready(function() {
-        Sentry.charts.render("#chart");
+        new app.GroupDetailsPage();
         $('#public-status .action').click(function(){
             var $this = $(this);
             $.ajax({
diff --git a/src/sentry/templates/sentry/groups/group_list.html b/src/sentry/templates/sentry/groups/group_list.html
index 541260d6c0..ee1f505a75 100644
--- a/src/sentry/templates/sentry/groups/group_list.html
+++ b/src/sentry/templates/sentry/groups/group_list.html
@@ -26,6 +26,13 @@
 {% block breadcrumb %}{% endblock %}
 
 {% block sidebar %}
+    <div style="height:50px;" id="chart" class="chart" data-api-url="{% url sentry-api-chart %}" data-days="1" data-title="{% trans "Events in the last 24 hours" %}">
+        <div class="sparkline">
+            <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
+            <span class="loading">{% trans "Loading historical data..." %}</span>
+        </div>
+    </div>
+
     <form method="get">
         {% if request.user.is_authenticated %}
             {% querystring from request without bookmarks as bookmark_querystring %}
