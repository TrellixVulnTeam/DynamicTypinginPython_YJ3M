commit b49cca1cd77542c563ee7edef66aa97acc3fcb8f
Author: Lauryn Brown <lauryndbrown@gmail.com>
Date:   Wed Aug 15 13:21:46 2018 -0700

    fix(vsts): Fixed missing or malformed subscriptions for VSTS (#9355)

diff --git a/src/sentry/integrations/vsts/integration.py b/src/sentry/integrations/vsts/integration.py
index e037a42ade..30c9475120 100644
--- a/src/sentry/integrations/vsts/integration.py
+++ b/src/sentry/integrations/vsts/integration.py
@@ -288,8 +288,12 @@ class VstsIntegrationProvider(IntegrationProvider):
             },
         }
 
-        if not IntegrationModel.objects.filter(
-                provider='vsts', external_id=account['AccountId']).exists():
+        try:
+            assert 'subscription' in IntegrationModel.objects.get(
+                provider='vsts',
+                external_id=account['AccountId']
+            ).metadata
+        except (IntegrationModel.DoesNotExist, AssertionError):
             subscription_id, subscription_secret = self.create_subscription(
                 instance, account['AccountId'], oauth_data)
             integration['metadata']['subscription'] = {
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index 3c84cd6868..c485cfbced 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -114,6 +114,32 @@ class VstsIntegrationProviderTest(VstsIntegrationTestCase):
         data = VstsIntegrationProvider().build_integration(state)
         assert 'subscription' not in data['metadata']
 
+    def test_fix_subscription(self):
+        external_id = '1234567890'
+        Integration.objects.create(
+            metadata={},
+            provider='vsts',
+            external_id=external_id,
+        )
+        data = VstsIntegrationProvider().build_integration({
+            'account': {
+                'AccountName': self.vsts_account_name,
+                'AccountId': external_id,
+            },
+            'instance': '{}.visualstudio.com'.format(self.vsts_account_name),
+            'identity': {
+                'data': {
+                    'access_token': self.access_token,
+                    'expires_in': '3600',
+                    'refresh_token': self.refresh_token,
+                    'token_type': 'jwt-bearer',
+                },
+            },
+        })
+        assert external_id == data['external_id']
+        subscription = data['metadata']['subscription']
+        assert subscription['id'] is not None and subscription['secret'] is not None
+
 
 class VstsIntegrationTest(VstsIntegrationTestCase):
     def test_get_organization_config(self):
