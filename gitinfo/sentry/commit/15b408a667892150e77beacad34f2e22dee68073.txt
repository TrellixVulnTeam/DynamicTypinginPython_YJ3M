commit 15b408a667892150e77beacad34f2e22dee68073
Author: Stephen Cefali <scefali@sentry.io>
Date:   Tue Oct 22 10:25:20 2019 -0700

    check if is_sentry_app exists before using it (#15211)

diff --git a/src/sentry/api/bases/sentryapps.py b/src/sentry/api/bases/sentryapps.py
index 91af2e5368..cc733d4925 100644
--- a/src/sentry/api/bases/sentryapps.py
+++ b/src/sentry/api/bases/sentryapps.py
@@ -264,7 +264,12 @@ class SentryAppInstallationPermission(SentryPermission):
 
     def has_permission(self, request, *args, **kwargs):
         # To let the app mark the installation as installed, we don't care about permissions
-        if request.user.is_sentry_app and request.method == "PUT":
+        if (
+            hasattr(request, "user")
+            and hasattr(request.user, "is_sentry_app")
+            and request.user.is_sentry_app
+            and request.method == "PUT"
+        ):
             return True
         return super(SentryAppInstallationPermission, self).has_permission(request, *args, **kwargs)
 
diff --git a/tests/sentry/api/endpoints/test_organization_sentry_app_installation_details.py b/tests/sentry/api/endpoints/test_organization_sentry_app_installation_details.py
index 1e46318830..6a8cf69c62 100644
--- a/tests/sentry/api/endpoints/test_organization_sentry_app_installation_details.py
+++ b/tests/sentry/api/endpoints/test_organization_sentry_app_installation_details.py
@@ -142,3 +142,12 @@ class MarkInstalledSentryAppInstallationsTest(SentryAppInstallationDetailsTest):
             format="json",
         )
         assert response.status_code == 403
+
+    def test_sentry_app_installation_mark_installed_no_token(self):
+        self.url = reverse(
+            "sentry-api-0-sentry-app-installation-details", args=[self.installation.uuid]
+        )
+
+        response = self.client.put(self.url, data={"status": "installed"}, format="json")
+
+        assert response.status_code == 401
