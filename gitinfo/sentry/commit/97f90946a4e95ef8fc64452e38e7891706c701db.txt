commit 97f90946a4e95ef8fc64452e38e7891706c701db
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Oct 5 16:36:18 2016 -0700

    [ci] improve matrix builds on travis (#4277)
    
    - only run relevant services
    - minify / compress assets (greatly reduces memory requirements)
    - switch to phantomjs
    - fix cli build (was not running)

diff --git a/.travis.yml b/.travis.yml
index 4405a07a77..28798627ad 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -1,45 +1,64 @@
 sudo: false
 language: python
-addons:
-  firefox: "39.0"
-services:
-  - memcached
-  - mysql
-  - riak
-  - postgresql
-  - redis-server
-  - cassandra
-python:
-  - "2.7"
-  # - "3.4"
-  # - "3.5"
 cache:
   directories:
     - node_modules
     - $HOME/.cache/pip/wheels
-    - "$HOME/virtualenv/python2.7.9"
 branches:
   only:
   - master
 env:
-  matrix:
-    - TEST_SUITE=sqlite DB=sqlite
-    - TEST_SUITE=postgres DB=postgres
-    - TEST_SUITE=mysql DB=mysql
-    - TEST_SUITE=acceptance
-    - TEST_SUITE=js
-    - TEST_SUITE=cli
-    - TEST_SUITE=dist
   global:
+    - NODE_ENV=production
     - PIP_DISABLE_PIP_VERSION_CHECK=on
     - SENTRY_LIGHT_BUILD=1
     - SENTRY_SKIP_BACKEND_VALIDATION=1
-    - SELENIUM_DRIVER=firefox
 install:
   - make travis-install-$TEST_SUITE
+before_script:
   - pip freeze
 script:
   - make travis-lint-$TEST_SUITE
   - make travis-test-$TEST_SUITE
 after_success:
   - codecov -e TEST_SUITE
+after_failure:
+  - dmesg
+# each attribute in the matrix will override the global attribute
+matrix:
+  fast_finish: true
+  include:
+    # only the sqlite suite runs cassandra/riak tests
+    - python: 2.7
+      env: TEST_SUITE=sqlite DB=sqlite
+      services:
+        - memcached
+        - riak
+        - redis-server
+        - cassandra
+    - python: 2.7
+      env: TEST_SUITE=postgres DB=postgres
+      services:
+        - memcached
+        - redis-server
+        - postgresql
+    - python: 2.7
+      env: TEST_SUITE=mysql DB=mysql
+      services:
+        - memcached
+        - mysql
+        - redis-server
+    - python: 2.7
+      env: TEST_SUITE=acceptance
+      services:
+        - memcached
+        - redis-server
+        - postgresql
+    - python: 2.7
+      env: TEST_SUITE=js
+    - python: 2.7
+      env: TEST_SUITE=cli
+      services:
+        - postgresql
+    - python: 2.7
+      env: TEST_SUITE=dist
diff --git a/Makefile b/Makefile
index 4f3e5b5245..70fd431742 100644
--- a/Makefile
+++ b/Makefile
@@ -97,7 +97,7 @@ test-cli:
 
 test-js:
 	@echo "--> Building static assets"
-	@${NPM_ROOT}/.bin/webpack
+	@${NPM_ROOT}/.bin/webpack -p
 	@echo "--> Running JavaScript tests"
 	@npm run test
 	@echo ""
@@ -109,9 +109,9 @@ test-python:
 
 test-acceptance:
 	@echo "--> Building static assets"
-	@${NPM_ROOT}/.bin/webpack
+	@${NPM_ROOT}/.bin/webpack -p
 	@echo "--> Running acceptance tests"
-	py.test tests/acceptance || exit 1
+	py.test tests/acceptance
 	@echo ""
 
 test-python-coverage:
@@ -156,14 +156,13 @@ travis-upgrade-pip:
 travis-setup-cassandra:
 	echo "create keyspace sentry with replication = {'class' : 'SimpleStrategy', 'replication_factor': 1};" | cqlsh --cqlversion=3.1.7
 	echo 'create table nodestore (key text primary key, value blob, flags int);' | cqlsh -k sentry --cqlversion=3.1.7
-travis-install-python: travis-upgrade-pip install-python install-python-tests travis-setup-cassandra
+travis-install-python: travis-upgrade-pip install-python install-python-tests
 	python -m pip install codecov
 travis-noop:
 	@echo "nothing to do here."
 
 .PHONY: travis-upgrade-pip travis-setup-cassandra travis-install-python travis-noop
 
-# Install steps
 travis-install-sqlite: travis-install-python
 travis-install-postgres: travis-install-python dev-postgres
 	psql -c 'create database sentry;' -U postgres
@@ -172,7 +171,7 @@ travis-install-mysql: travis-install-python
 	echo 'create database sentry;' | mysql -uroot
 travis-install-acceptance: install-npm travis-install-postgres
 travis-install-js: travis-upgrade-pip install-python install-python-tests install-npm
-travis-install-cli: travis-install-python
+travis-install-cli: travis-install-postgres
 travis-install-dist: travis-upgrade-pip install-python install-python-tests
 
 .PHONY: travis-install-sqlite travis-install-postgres travis-install-js travis-install-cli travis-install-dist
@@ -194,7 +193,7 @@ travis-test-postgres: test-python-coverage
 travis-test-mysql: test-python-coverage
 travis-test-acceptance: test-acceptance
 travis-test-js: test-js
-travis-test-ci: test-ci
+travis-test-cli: test-cli
 travis-test-dist:
 	SENTRY_BUILD=$(TRAVIS_COMMIT) SENTRY_LIGHT_BUILD=0 python setup.py sdist bdist_wheel
 	@ls -lh dist/
diff --git a/setup.py b/setup.py
index e6f9021c88..f6f20556d3 100755
--- a/setup.py
+++ b/setup.py
@@ -70,9 +70,11 @@ dev_requires = [
 ]
 
 tests_require = [
-    'blist',  # used by cassandra
+    # cassandra
+    'blist',
     'casscache',
     'cqlsh',
+    # /cassandra
     'datadog',
     'pytest-cov>=1.8.0,<1.9.0',
     'pytest-timeout>=0.5.0,<0.6.0',
@@ -123,7 +125,7 @@ install_requires = [
     'raven>=5.21.0,<6.0.0',
     'redis>=2.10.3,<2.11.0',
     'requests[security]>=2.9.1,<2.12.0',
-    'selenium>=2.53,<2.60',
+    'selenium==3.0.0b3',
     'simplejson>=3.2.0,<3.9.0',
     'six>=1.10.0,<1.11.0',
     'setproctitle>=1.1.7,<1.2.0',
@@ -188,9 +190,9 @@ setup(
     zip_safe=False,
     install_requires=install_requires,
     extras_require={
-        'tests': tests_require,
         'dev': dev_requires,
         'postgres': install_requires,
+        'tests': tests_require,
     },
     cmdclass=cmdclass,
     license='BSD',
