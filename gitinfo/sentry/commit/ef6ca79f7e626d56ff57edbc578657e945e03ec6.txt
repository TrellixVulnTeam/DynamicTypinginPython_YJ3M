commit ef6ca79f7e626d56ff57edbc578657e945e03ec6
Author: Stephen Cefali <scefali@sentry.io>
Date:   Wed Jun 24 16:07:40 2020 -0700

    fix(integrations): pull referrer directly from window.location for integration analytics (#19514)

diff --git a/src/sentry/static/sentry/app/utils/integrationUtil.tsx b/src/sentry/static/sentry/app/utils/integrationUtil.tsx
index b1f64ad21e..e9e5971e34 100644
--- a/src/sentry/static/sentry/app/utils/integrationUtil.tsx
+++ b/src/sentry/static/sentry/app/utils/integrationUtil.tsx
@@ -1,5 +1,6 @@
 import capitalize from 'lodash/capitalize';
 import React from 'react';
+import qs from 'query-string';
 
 import HookStore from 'app/stores/hookStore';
 import {
@@ -79,7 +80,6 @@ export type SingleIntegrationEvent = {
   plan?: string;
   //include the status since people might do weird things testing unpublished integrations
   integration_status?: SentryAppStatus;
-  referrer?: string; //where did the user come from
 };
 
 type MultipleIntegrationsEvent = {
@@ -149,9 +149,20 @@ export const trackIntegrationEvent = (
     );
   }
 
-  //Amplitude has it's own referrer which intefers with our custom referrer
-  const {referrer: custom_referrer} = analyticsParams;
-  delete analyticsParams.referrer;
+  let custom_referrer: string | undefined;
+
+  try {
+    //pull the referrer from the query parameter of the page
+    const {referrer} = qs.parse(window.location.search) || {};
+    if (typeof referrer === 'string') {
+      // Amplitude has its own referrer which inteferes with our custom referrer
+      custom_referrer = referrer;
+    }
+  } catch {
+    // ignore if this fails to parse
+    // this can happen if we have an invalid query string
+    // e.g. unencoded "%"
+  }
 
   const params = {
     analytics_session_id: sessionId,
diff --git a/src/sentry/static/sentry/app/views/organizationIntegrations/abstractIntegrationDetailedView.tsx b/src/sentry/static/sentry/app/views/organizationIntegrations/abstractIntegrationDetailedView.tsx
index d019260157..95e4d4f5e7 100644
--- a/src/sentry/static/sentry/app/views/organizationIntegrations/abstractIntegrationDetailedView.tsx
+++ b/src/sentry/static/sentry/app/views/organizationIntegrations/abstractIntegrationDetailedView.tsx
@@ -209,7 +209,6 @@ class AbstractIntegrationDetailedView<
       integration: this.integrationSlug,
       integration_type: this.integrationType,
       already_installed: this.installationStatus !== 'Not Installed', //pending counts as installed here
-      referrer: this.props.location.query.referrer,
       ...options,
     };
     //type cast here so TS won't complain
