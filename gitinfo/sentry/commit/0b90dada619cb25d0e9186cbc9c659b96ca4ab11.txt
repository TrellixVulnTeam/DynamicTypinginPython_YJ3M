commit 0b90dada619cb25d0e9186cbc9c659b96ca4ab11
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Wed Sep 19 16:10:31 2018 -0700

    fix(integrations): Use timestamp returned by gh when backfilling commits (#9808)

diff --git a/src/sentry/integrations/github/repository.py b/src/sentry/integrations/github/repository.py
index 1930069c32..5a673c6233 100644
--- a/src/sentry/integrations/github/repository.py
+++ b/src/sentry/integrations/github/repository.py
@@ -1,8 +1,11 @@
 from __future__ import absolute_import
 
+import dateutil.parser
 import logging
 import six
 
+from django.utils import timezone
+
 from sentry.integrations.exceptions import ApiError, IntegrationError
 from sentry.models import Integration
 from sentry.plugins import providers
@@ -70,6 +73,9 @@ class GitHubRepositoryProvider(providers.IntegrationRepositoryProvider):
                 'author_email': c['commit']['author'].get('email'),
                 'author_name': c['commit']['author'].get('name'),
                 'message': c['commit']['message'],
+                'timestamp': dateutil.parser.parse(
+                    c['commit']['author'].get('date'),
+                ).astimezone(timezone.utc) if c['commit']['author'].get('date') else None,
             } for c in commit_list
         ]
 
diff --git a/src/sentry/models/release.py b/src/sentry/models/release.py
index d41bc8e606..2d7508cad9 100644
--- a/src/sentry/models/release.py
+++ b/src/sentry/models/release.py
@@ -423,6 +423,8 @@ class Release(Model):
                             update_kwargs['message'] = defaults['message']
                         if commit.author_id is None and defaults['author'] is not None:
                             update_kwargs['author'] = defaults['author']
+                        if defaults.get('date_added') is not None:
+                            update_kwargs['date_added'] = defaults['date_added']
                         if update_kwargs:
                             commit.update(**update_kwargs)
 
diff --git a/tests/sentry/api/endpoints/test_organization_releases.py b/tests/sentry/api/endpoints/test_organization_releases.py
index 989e7726d7..417f1aad5d 100644
--- a/tests/sentry/api/endpoints/test_organization_releases.py
+++ b/tests/sentry/api/endpoints/test_organization_releases.py
@@ -234,14 +234,16 @@ class OrganizationReleaseCreateTest(APITestCase):
             )
 
         release_commits1 = list(
-            ReleaseCommit.objects.filter(release=release).values_list('commit__key', flat=True)
+            ReleaseCommit.objects.filter(
+                release=release).order_by('order').values_list(
+                'commit__key', flat=True)
         )
 
         # check that commits are overwritten
         assert release_commits1 == [
-            u'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',
             u'62de626b7c7cfb8e77efb4273b1a3df4123e6216',
             u'58de626b7c7cfb8e77efb4273b1a3df4123e6345',
+            u'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',
         ]
 
         # should be 201 because project was added
@@ -278,14 +280,16 @@ class OrganizationReleaseCreateTest(APITestCase):
                 )
 
         release_commits2 = list(
-            ReleaseCommit.objects.filter(release=release).values_list('commit__key', flat=True)
+            ReleaseCommit.objects.filter(
+                release=release).order_by('order').values_list(
+                'commit__key', flat=True)
         )
 
         # check that commits are overwritten
         assert release_commits2 == [
-            u'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',
             u'cccccccccccccccccccccccccccccccccccccccc',
             u'dddddddddddddddddddddddddddddddddddddddd',
+            u'aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa',
         ]
 
         assert response2.status_code == 208, response.content
diff --git a/tests/sentry/integrations/github/test_repository.py b/tests/sentry/integrations/github/test_repository.py
index 6eb1fa750a..6e92ebef40 100644
--- a/tests/sentry/integrations/github/test_repository.py
+++ b/tests/sentry/integrations/github/test_repository.py
@@ -1,9 +1,12 @@
 from __future__ import absolute_import
 
+import datetime
 import responses
 
 from exam import fixture
 from mock import patch
+
+from django.utils import timezone
 from sentry.models import Integration, Repository
 from sentry.testutils import PluginTestCase
 from sentry.utils import json
@@ -92,7 +95,8 @@ class GitHubAppsProviderTest(PluginTestCase):
                 'author_name': 'Monalisa Octocat',
                 'message': 'Fix all the bugs',
                 'id': '6dcb09b5b57875f334f61aebed695e2e4193db5e',
-                'repository': 'example-repo'
+                'repository': 'example-repo',
+                'timestamp': datetime.datetime(2011, 4, 14, 16, 0, 49, tzinfo=timezone.utc),
             }
         ]
 
