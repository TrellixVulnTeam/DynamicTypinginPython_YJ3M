commit 0b8908c851c81cff44aff0f01c0105f513e2ca51
Author: David Cramer <dcramer@gmail.com>
Date:   Wed May 11 14:04:57 2011 -0700

    Ensure we're using Model._state correctly

diff --git a/sentry/templatetags/sentry_helpers.py b/sentry/templatetags/sentry_helpers.py
index 5952ce43d5..d4fe13545f 100644
--- a/sentry/templatetags/sentry_helpers.py
+++ b/sentry/templatetags/sentry_helpers.py
@@ -61,7 +61,12 @@ def chart_data(group, max_days=90):
     today = datetime.datetime.now().replace(microsecond=0, second=0, minute=0)
     min_date = today - datetime.timedelta(hours=hours)
 
-    conn = connections[getattr(group, '_state', 'default')]
+    if hasattr(group, '_state'):
+        db = group._state.db
+    else:
+        db = 'default'
+
+    conn = connections[db]
 
     if get_db_engine(getattr(conn, 'alias', 'default')).startswith('oracle'):
         method = conn.ops.date_trunc_sql('hh24', 'datetime')
