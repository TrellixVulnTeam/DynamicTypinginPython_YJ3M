commit 0a2ded59496904f5c9fc8bc31a7f54ab1cad2802
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Sep 4 11:22:11 2011 -0700

    Add some basic test coverage for plugins and fix with_priority sort bugs

diff --git a/example_project/urls.py b/example_project/urls.py
index 7e85f284ec..cf368f9caa 100644
--- a/example_project/urls.py
+++ b/example_project/urls.py
@@ -1,5 +1,6 @@
 from django.conf.urls.defaults import *
 
 urlpatterns = patterns('',
+    url(r'^debug/', include('tests.urls')),
     url(r'^', include('sentry.web.urls')),
 )
diff --git a/runtests.py b/runtests.py
index 840dc2328d..96f4943d43 100644
--- a/runtests.py
+++ b/runtests.py
@@ -39,6 +39,7 @@ if not settings.configured:
 
             # included plugin tests
             'sentry.plugins.sentry_servers',
+            'sentry.plugins.sentry_sites',
             'sentry.plugins.sentry_urls',
             'sentry.plugins.sentry_redmine',
 
diff --git a/sentry/plugins/sentry_servers/templates/sentry/plugins/sentry_servers/widget.html b/sentry/plugins/sentry_servers/templates/sentry/plugins/sentry_servers/widget.html
index 765681c28d..1db7693ecb 100644
--- a/sentry/plugins/sentry_servers/templates/sentry/plugins/sentry_servers/widget.html
+++ b/sentry/plugins/sentry_servers/templates/sentry/plugins/sentry_servers/widget.html
@@ -5,7 +5,7 @@
         <h2>Servers</h2>
 
         <ul class="server-list">
-            {% for server, priority in unique_servers|with_priority:"times_seen" %}
+            {% for server, priority in unique_servers|with_priority:1 %}
                 <li class="priority-{{ priority }}"><span class="count">{{ server.1 }}</span> <a href="{% url sentry %}?server_name={{ server.0 }}">{{ server.0 }}</a></li>
             {% endfor %}
         </ul>
diff --git a/sentry/plugins/sentry_sites/templates/sentry/plugins/sentry_sites/widget.html b/sentry/plugins/sentry_sites/templates/sentry/plugins/sentry_sites/widget.html
index 4fff6d10fe..91cb45610a 100644
--- a/sentry/plugins/sentry_sites/templates/sentry/plugins/sentry_sites/widget.html
+++ b/sentry/plugins/sentry_sites/templates/sentry/plugins/sentry_sites/widget.html
@@ -5,7 +5,7 @@
         <h2>Sites</h2>
 
         <ul class="server-list">
-            {% for site, priority in unique_sites|with_priority:"times_seen" %}
+            {% for site, priority in unique_sites|with_priority:1 %}
                 <li class="priority-{{ priority }}"><span class="count">{{ site.1 }}</span> <a href="{% url sentry %}?site={{ site.0 }}">{{ site.0 }}</a></li>
             {% endfor %}
         </ul>
diff --git a/sentry/plugins/sentry_urls/templates/sentry/plugins/sentry_urls/widget.html b/sentry/plugins/sentry_urls/templates/sentry/plugins/sentry_urls/widget.html
index a55ad62ef9..3e16d94cfe 100644
--- a/sentry/plugins/sentry_urls/templates/sentry/plugins/sentry_urls/widget.html
+++ b/sentry/plugins/sentry_urls/templates/sentry/plugins/sentry_urls/widget.html
@@ -5,7 +5,7 @@
         <h2>URLs</h2>
 
         <ul class="url-list">
-            {% for link, priority in unique_urls|with_priority:"times_seen" %}
+            {% for link, priority in unique_urls|with_priority:1 %}
                 <li class="priority-{{ priority }}"><span class="count">{{ link.1 }}</span> <a href="{{ link.0 }}">{{ link.0 }}</a></li>
             {% endfor %}
         </ul>
diff --git a/sentry/templatetags/sentry_helpers.py b/sentry/templatetags/sentry_helpers.py
index da348ec53f..e7456dbc24 100644
--- a/sentry/templatetags/sentry_helpers.py
+++ b/sentry/templatetags/sentry_helpers.py
@@ -41,7 +41,7 @@ def is_dict(value):
 @register.filter
 def with_priority(result_list, key='score'):
     if result_list:
-        if isinstance(result_list[0], dict):
+        if isinstance(result_list[0], (dict, list, tuple)):
             _get = lambda x, k: x[k]
         else:
             _get = lambda x, k: getattr(x, k)
diff --git a/tests/tests.py b/tests/tests.py
index 2247c18b30..d0f9e68547 100644
--- a/tests/tests.py
+++ b/tests/tests.py
@@ -26,8 +26,8 @@ from sentry.client.models import get_client
 from sentry.conf import settings
 from sentry.models import Message, GroupedMessage, MessageCountByMinute, \
                           FilterValue, MessageFilterValue
-from sentry.utils import json
-from sentry.utils import transform, get_signature, get_auth_header
+from sentry.utils import json, transform, get_signature, get_auth_header, \
+                         MockDjangoRequest
 from sentry.utils.compat import pickle
 
 from tests.models import TestModel, DuplicateKeyModel
@@ -73,7 +73,7 @@ class BaseTestCase(TestCase):
         )
         return resp
 
-class SentryTestCase(BaseTestCase):
+class SentryTest(BaseTestCase):
     ## Fixture setup/teardown
 
     def setUp(self):
@@ -1519,3 +1519,16 @@ class SentrySearchTest(BaseTestCase):
         qs = get_search_query_set('error')
         self.assertEquals(qs.count(), 1)
         self.assertEquals(qs[0:1][0].message, 'test search error')
+
+class SentryPluginTest(BaseTestCase):
+    def test_registration(self):
+        from sentry.plugins import GroupActionProvider
+        self.assertEquals(len(GroupActionProvider.plugins), 4)
+    
+    def test_get_widgets(self):
+        from sentry.templatetags.sentry_helpers import get_widgets
+        get_client().create_from_text('hi')
+        
+        group = GroupedMessage.objects.get()
+        widgets = list(get_widgets(group, MockDjangoRequest()))
+        self.assertEquals(len(widgets), 3)
\ No newline at end of file
