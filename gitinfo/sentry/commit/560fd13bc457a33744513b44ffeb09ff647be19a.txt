commit 560fd13bc457a33744513b44ffeb09ff647be19a
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Feb 9 13:36:47 2015 -0800

    Assert we get a valid Content-Encoding

diff --git a/src/sentry/http.py b/src/sentry/http.py
index 8f33a6c688..683bed8c14 100644
--- a/src/sentry/http.py
+++ b/src/sentry/http.py
@@ -82,16 +82,20 @@ def safe_urlopen(url, data=None, headers=DEFAULT_HEADERS,
     return opener.open(req, timeout=timeout)
 
 
-def safe_urlread(request):
-    body = request.read()
+def safe_urlread(response):
+    body = response.read()
+
+    if 'content-encoding' in response.headers:
+        # Make sure we only handle gzip Content-Encoding
+        content_encoding = response.headers['content-encoding']
+        assert content_encoding == 'gzip', content_encoding
 
-    if request.headers.get('content-encoding') == 'gzip':
         # Content doesn't *have* to respect the Accept-Encoding header
         # and may send gzipped data regardless.
         # See: http://stackoverflow.com/questions/2423866/python-decompressing-gzip-chunk-by-chunk/2424549#2424549
         body = zlib.decompress(body, 16 + zlib.MAX_WBITS)
 
-    content_type = request.headers.get('content-type')
+    content_type = response.headers.get('content-type')
     if content_type is None:
         # If there is no content_type header at all, quickly assume default utf-8 encoding
         encoding = DEFAULT_ENCODING
