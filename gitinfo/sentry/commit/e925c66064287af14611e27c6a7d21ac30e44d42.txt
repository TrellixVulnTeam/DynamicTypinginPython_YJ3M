commit e925c66064287af14611e27c6a7d21ac30e44d42
Author: Megan Heskett <meg.heskett@gmail.com>
Date:   Thu Jul 5 11:08:48 2018 -0700

    Get device name before deletion (#8925)

diff --git a/src/sentry/api/endpoints/user_authenticator_details.py b/src/sentry/api/endpoints/user_authenticator_details.py
index 7950d49012..bb13eae701 100644
--- a/src/sentry/api/endpoints/user_authenticator_details.py
+++ b/src/sentry/api/endpoints/user_authenticator_details.py
@@ -114,12 +114,11 @@ class UserAuthenticatorDetailsEndpoint(UserEndpoint):
 
         # Remove a single device and not entire authentication method
         if interface.interface_id == 'u2f' and interface_device_id is not None:
+            device_name = interface.get_device_name(interface_device_id)
             # Can't remove if this is the last device, will return False if so
             if not interface.remove_u2f_device(interface_device_id):
                 return Response(status=status.HTTP_500_INTERNAL_SERVER_ERROR)
-
             interface.authenticator.save()
-            device_name = interface.get_device_name(interface_device_id)
 
             capture_security_activity(
                 account=user,
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index 44e2a959ac..f203ecbc8e 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -278,23 +278,23 @@ class U2fSettingsView(TwoFactorSettingsView):
         # 'remove' in the form and bring up the remove screen for the
         # entire authentication method.
         key_handle = request.POST.get('key_handle')
-        if key_handle and 'remove' in request.POST and \
-           interface.remove_u2f_device(key_handle):
-            interface.authenticator.save()
+        if key_handle:
             device_name = interface.get_device_name(key_handle)
+            if 'remove' in request.POST and interface.remove_u2f_device(key_handle):
+                interface.authenticator.save()
 
-            capture_security_activity(
-                account=request.user,
-                type='mfa-removed',
-                actor=request.user,
-                ip_address=request.META['REMOTE_ADDR'],
-                context={
-                    'authenticator': interface.authenticator,
-                    'device_name': device_name
-                },
-                send_email=True,
-            )
-            return HttpResponseRedirect(request.path)
+                capture_security_activity(
+                    account=request.user,
+                    type='mfa-removed',
+                    actor=request.user,
+                    ip_address=request.META['REMOTE_ADDR'],
+                    context={
+                        'authenticator': interface.authenticator,
+                        'device_name': device_name
+                    },
+                    send_email=True,
+                )
+                return HttpResponseRedirect(request.path)
 
         return TwoFactorSettingsView.configure(self, request, interface)
 
