commit 316baeacc6c26fdb5c8cb3ff82fc8c27249adf58
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Aug 28 00:14:43 2013 -0700

    Record user-less IPs as unique users

diff --git a/src/sentry/models.py b/src/sentry/models.py
index 1748ea803c..e9795f0cc8 100644
--- a/src/sentry/models.py
+++ b/src/sentry/models.py
@@ -518,6 +518,12 @@ class EventBase(Model):
     def team(self):
         return self.project.team
 
+    @property
+    def ip_address(self):
+        http_data = self.data.get('sentry.interfaces.Http')
+        if http_data and 'env' in http_data:
+            return http_data['env'].get('REMOTE_ADDR')
+
     @property
     def user_ident(self):
         """
@@ -545,12 +551,9 @@ class EventBase(Model):
             if ident:
                 return 'username:%s' % (ident,)
 
-        http_data = self.data.get('sentry.interfaces.Http')
-        if http_data:
-            if 'env' in http_data:
-                ident = http_data['env'].get('REMOTE_ADDR')
-                if ident:
-                    return 'ip:%s' % (ident,)
+        ident = self.ip_address
+        if ident:
+            return 'ip:%s' % (ident,)
 
         return None
 
diff --git a/src/sentry/tasks/post_process.py b/src/sentry/tasks/post_process.py
index 5b4e6f7a0d..7e9ddb7e73 100644
--- a/src/sentry/tasks/post_process.py
+++ b/src/sentry/tasks/post_process.py
@@ -47,20 +47,19 @@ def record_affected_user(group, event, **kwargs):
     if not settings.SENTRY_ENABLE_EXPLORE_USERS:
         return
 
-    data = event.data.get('sentry.interfaces.User')
-    if not data:
-        return
-
     user_ident = event.user_ident
     if not user_ident:
         return
 
+    user_data = event.data.get('sentry.interfaces.User')
+
     Group.objects.add_tags(group, [
         ('sentry:user', user_ident, {
-            'id': data.get('id'),
-            'email': data.get('email'),
-            'username': data.get('username'),
-            'data': data.get('data'),
+            'id': user_data.get('id'),
+            'email': user_data.get('email'),
+            'username': user_data.get('username'),
+            'data': user_data.get('data'),
+            'ip': event.ip_address,
         })
     ])
 
