commit c913e591182cf607f6878662ccc5ff8682c04d8b
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Jan 11 18:40:14 2016 -0800

    Correct IntegrityError handling

diff --git a/src/sentry/tasks/merge.py b/src/sentry/tasks/merge.py
index 15b6072233..812229067d 100644
--- a/src/sentry/tasks/merge.py
+++ b/src/sentry/tasks/merge.py
@@ -77,15 +77,15 @@ def merge_objects(models, group, new_group, limit=1000,
             logger.info('Merging %r objects where %r into %r', model, group,
                         new_group)
         for obj in model.objects.filter(group=group)[:limit]:
-            with transaction.atomic(using=router.db_for_write(model)):
-                try:
+            try:
+                with transaction.atomic(using=router.db_for_write(model)):
                     model.objects.filter(
                         id=obj.id
                     ).update(group=new_group)
-                except IntegrityError:
-                    delete = True
-                else:
-                    delete = False
+            except IntegrityError:
+                delete = True
+            else:
+                delete = False
             if delete:
                 obj.delete()
             has_more = True
