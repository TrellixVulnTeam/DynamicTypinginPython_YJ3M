commit 57c1fbaa0a51397aba45b656db9489397eb8b3f5
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Apr 20 10:19:13 2018 -0700

    fix(auth): Invalidate superuser when user data changes

diff --git a/src/sentry/auth/superuser.py b/src/sentry/auth/superuser.py
index 2de351aac7..1a1c3c9d68 100644
--- a/src/sentry/auth/superuser.py
+++ b/src/sentry/auth/superuser.py
@@ -66,6 +66,19 @@ class Superuser(object):
             )
         self._populate(current_datetime=current_datetime)
 
+    @property
+    def is_active(self):
+        # if we've been logged out
+        if not self.request.user.is_authenticated():
+            return False
+        # if superuser status was changed
+        if not self.request.user.is_superuser:
+            return False
+        # if the user has changed
+        if six.text_type(self.request.user.id) != self.uid:
+            return False
+        return self._is_active
+
     def is_privileged_request(self):
         allowed_ips = self.allowed_ips
         # if there's no IPs configured, we allow assume its the same as *
@@ -215,7 +228,7 @@ class Superuser(object):
         # do we have a valid superuser session?
         self.is_valid = True
         # is the session active? (it could be valid, but inactive)
-        self.is_active = self.is_privileged_request()
+        self._is_active = self.is_privileged_request()
         self.request.session[SESSION_KEY] = {
             'exp': self.expires.strftime('%s'),
             'idl': (current_datetime + IDLE_MAX_AGE).strftime('%s'),
@@ -228,7 +241,7 @@ class Superuser(object):
         self.uid = None
         self.expires = None
         self.token = None
-        self.is_active = False
+        self._is_active = False
         self.is_valid = False
         self.request.session.pop(SESSION_KEY, None)
 
diff --git a/tests/sentry/auth/test_superuser.py b/tests/sentry/auth/test_superuser.py
index 915f6d4810..d73d743ebd 100644
--- a/tests/sentry/auth/test_superuser.py
+++ b/tests/sentry/auth/test_superuser.py
@@ -3,6 +3,7 @@ from __future__ import absolute_import
 import six
 
 from datetime import timedelta
+from django.contrib.auth.models import AnonymousUser
 from django.core import signing
 from django.utils import timezone
 from mock import Mock
@@ -108,6 +109,10 @@ class SuperuserTestCase(TestCase):
         superuser = Superuser(request, allowed_ips=(), current_datetime=self.current_datetime)
         superuser.set_logged_in(user, current_datetime=self.current_datetime)
 
+        # request.user wasn't set
+        assert not superuser.is_active
+
+        request.user = user
         assert superuser.is_active
 
         data = request.session.get(SESSION_KEY)
@@ -148,3 +153,20 @@ class SuperuserTestCase(TestCase):
             path=COOKIE_PATH,
             domain=COOKIE_DOMAIN,
         )
+
+    def test_changed_user(self):
+        request = self.build_request()
+        superuser = Superuser(request, allowed_ips=())
+        assert superuser.is_active
+
+        # anonymous
+        request.user = AnonymousUser()
+        assert not superuser.is_active
+
+        # a non-superuser
+        request.user = self.create_user('baz@example.com')
+        assert not superuser.is_active
+
+        # a superuser
+        request.user.update(is_superuser=True)
+        assert not superuser.is_active
