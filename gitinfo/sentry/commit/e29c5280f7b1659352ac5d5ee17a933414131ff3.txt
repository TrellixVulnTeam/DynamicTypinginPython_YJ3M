commit e29c5280f7b1659352ac5d5ee17a933414131ff3
Author: Daniel Griesser <daniel.griesser.86@gmail.com>
Date:   Wed Feb 22 14:20:09 2017 +0100

    Convert CELERY_IMPORTS to set so plugins can add their imports
    
    Load plugin celery queues, imports in initalizer

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 5a43457e4c..22bf6cca20 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -432,7 +432,7 @@ CELERY_DEFAULT_ROUTING_KEY = "default"
 CELERY_CREATE_MISSING_QUEUES = True
 CELERY_REDIRECT_STDOUTS = False
 CELERYD_HIJACK_ROOT_LOGGER = False
-CELERY_IMPORTS = (
+CELERY_IMPORTS = [
     'sentry.tasks.auth',
     'sentry.tasks.auto_resolve_issues',
     'sentry.tasks.beacon',
@@ -450,8 +450,7 @@ CELERY_IMPORTS = (
     'sentry.tasks.process_buffer',
     'sentry.tasks.reports',
     'sentry.tasks.store',
-    'sentry_plugins.itunesconnect.tasks.itunesconnect',
-)
+]
 CELERY_QUEUES = [
     Queue('alerts', routing_key='alerts'),
     Queue('auth', routing_key='auth'),
@@ -470,7 +469,6 @@ CELERY_QUEUES = [
     Queue('search', routing_key='search'),
     Queue('stats', routing_key='stats'),
     Queue('update', routing_key='update'),
-    Queue('itunesconnect', routing_key='itunesconnect'),
 ]
 
 for queue in CELERY_QUEUES:
diff --git a/src/sentry/runner/initializer.py b/src/sentry/runner/initializer.py
index 502cb83ae2..f1a766b59b 100644
--- a/src/sentry/runner/initializer.py
+++ b/src/sentry/runner/initializer.py
@@ -49,8 +49,17 @@ def init_plugin(plugin):
         for cls in plugin.get_custom_contexts() or ():
             contexttype(cls)
 
-    if (hasattr(plugin, 'get_task') and plugin.is_enabled()):
-        settings.CELERYBEAT_SCHEDULE.update(plugin.get_task())
+    if (hasattr(plugin, 'get_celerybeat_schedule') and plugin.is_enabled()):
+        settings.CELERYBEAT_SCHEDULE.update(plugin.get_celerybeat_schedule())
+
+    if (hasattr(plugin, 'get_celery_imports') and plugin.is_enabled()):
+        settings.CELERY_IMPORTS.append(plugin.get_celery_imports())
+
+    if (hasattr(plugin, 'get_celery_queues') and plugin.is_enabled()):
+        from kombu import Queue
+        for queue in plugin.get_celery_queues():
+            # queue[0] == name, queue[1] == routing_key
+            settings.CELERY_QUEUES.append(Queue(queue[0], routing_key=queue[1]))
 
 
 def initialize_receivers():
