commit eb10941f390c58ef0bd52994f7a860afcc6007eb
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Feb 26 22:09:19 2013 -0800

    Dont use RangeQuerySet in deletions

diff --git a/src/sentry/tasks/cleanup.py b/src/sentry/tasks/cleanup.py
index 6c11a49327..4bc959eac9 100644
--- a/src/sentry/tasks/cleanup.py
+++ b/src/sentry/tasks/cleanup.py
@@ -10,7 +10,7 @@ from celery.task import task
 
 
 @task(ignore_result=True)
-def cleanup(days=30, project=None, **kwargs):
+def cleanup(days=30, project=None, chunk_size=1000, **kwargs):
     """
     Deletes a portion of the trailing data in Sentry based on
     their creation dates. For example, if ``days`` is 30, this
@@ -27,7 +27,6 @@ def cleanup(days=30, project=None, **kwargs):
     from sentry.models import (Group, Event, GroupCountByMinute,
         GroupTag, FilterValue, ProjectCountByMinute, Alert,
         SearchDocument, Activity, AffectedUserByGroup, LostPasswordHash)
-    from sentry.utils.query import RangeQuerySetWrapper
 
     GENERIC_DELETES = (
         (SearchDocument, 'date_changed'),
@@ -55,9 +54,10 @@ def cleanup(days=30, project=None, **kwargs):
         if project:
             qs = qs.filter(project=project)
         # XXX: we step through because the deletion collector will pull all relations into memory
-        for obj in RangeQuerySetWrapper(qs):
-            log.info("Removing %r", obj)
-            obj.delete()
+        while qs.exists():
+            for obj in list(qs[:chunk_size]):
+                log.info("Removing %r", obj)
+                obj.delete()
 
     log.info("Removing expired values for %r", LostPasswordHash)
     LostPasswordHash.objects.filter(
