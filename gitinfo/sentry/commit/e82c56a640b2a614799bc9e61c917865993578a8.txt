commit e82c56a640b2a614799bc9e61c917865993578a8
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri Sep 11 13:01:39 2015 -0700

    Fix query for MySQL

diff --git a/src/sentry/api/endpoints/project_tagkey_values.py b/src/sentry/api/endpoints/project_tagkey_values.py
index cefffa6b64..33e9df00dd 100644
--- a/src/sentry/api/endpoints/project_tagkey_values.py
+++ b/src/sentry/api/endpoints/project_tagkey_values.py
@@ -5,6 +5,7 @@ from sentry.api.bases.project import ProjectEndpoint
 from sentry.api.exceptions import ResourceDoesNotExist
 from sentry.api.serializers import serialize
 from sentry.models import TagKey, TagKeyStatus, TagValue
+from sentry.utils.db import is_postgres
 
 
 class ProjectTagKeyValuesEndpoint(ProjectEndpoint):
@@ -38,15 +39,22 @@ class ProjectTagKeyValuesEndpoint(ProjectEndpoint):
         except TagKey.DoesNotExist:
             raise ResourceDoesNotExist
 
+        base_queryset = TagValue.objects.filter(
+            project=project,
+            key=tagkey.key,
+        )
+
         query = request.GET.get('query')
         if query:
-            # not quite optimal, but best we can do with ORM
-            queryset = TagValue.objects.filter(
-                id__in=TagValue.objects.filter(
-                    project=project,
-                    key=tagkey.key,
-                ).order_by('-times_seen')[:10000]
-            ).filter(value__istartswith=query)
+            if is_postgres():
+                # not quite optimal, but best we can do with ORM
+                queryset = TagValue.objects.filter(
+                    id__in=base_queryset.order_by('-times_seen')[:10000]
+                )
+            else:
+                # MySQL can't handle an `IN` with a `LIMIT` clause
+                queryset = base_queryset
+            queryset = queryset.filter(value__istartswith=query)
 
         else:
             queryset = TagValue.objects.filter(
