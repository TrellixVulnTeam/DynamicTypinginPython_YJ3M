commit c99c015a6bedc19c5fbf4b517a5bc324259e599f
Author: Chris Fuller <cfuller@sentry.io>
Date:   Thu Feb 27 11:40:02 2020 -0500

    fix(workflow): Only update chart when query is finished (#17253)
    
    * fix smartsearchbar on blur callback to return current value of input when blurring, update filter on blur or "search" e.g. if user presses enter
    
    Co-authored-by: Billy Vong <billyvg@users.noreply.github.com>

diff --git a/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx b/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx
index db638d2306..f566381268 100644
--- a/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx
+++ b/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx
@@ -312,13 +312,14 @@ class SmartSearchBar extends React.Component {
     });
   };
 
-  onQueryBlur = () => {
+  onQueryBlur = e => {
     // wait 200ms before closing dropdown in case blur was a result of
     // clicking a menu option
+    const value = e.target.value;
     this.blurTimeout = setTimeout(() => {
       this.blurTimeout = null;
       this.setState({dropdownVisible: false});
-      callIfFunction(this.props.onBlur);
+      callIfFunction(this.props.onBlur, value);
     }, DROPDOWN_BLUR_DURATION);
   };
 
diff --git a/src/sentry/static/sentry/app/views/settings/incidentRules/ruleConditionsForm.tsx b/src/sentry/static/sentry/app/views/settings/incidentRules/ruleConditionsForm.tsx
index 7fc17a0e8d..915fff4685 100644
--- a/src/sentry/static/sentry/app/views/settings/incidentRules/ruleConditionsForm.tsx
+++ b/src/sentry/static/sentry/app/views/settings/incidentRules/ruleConditionsForm.tsx
@@ -33,6 +33,7 @@ type Props = {
   organization: Organization;
   projectSlug: string;
   disabled: boolean;
+  onFilterUpdate: (query: string) => void;
 };
 
 type State = {
@@ -67,7 +68,7 @@ class RuleConditionsForm extends React.PureComponent<Props, State> {
   }
 
   render() {
-    const {organization, disabled} = this.props;
+    const {organization, disabled, onFilterUpdate} = this.props;
 
     return (
       <Panel>
@@ -123,9 +124,15 @@ class RuleConditionsForm extends React.PureComponent<Props, State> {
                 useFormWrapper={false}
                 organization={organization}
                 onChange={onChange}
-                onBlur={onBlur}
                 onKeyDown={onKeyDown}
-                onSearch={query => onChange(query, {})}
+                onBlur={query => {
+                  onFilterUpdate(query);
+                  onBlur(query);
+                }}
+                onSearch={query => {
+                  onFilterUpdate(query);
+                  onChange(query, {});
+                }}
               />
             )}
           </FormField>
diff --git a/src/sentry/static/sentry/app/views/settings/incidentRules/ruleForm/index.tsx b/src/sentry/static/sentry/app/views/settings/incidentRules/ruleForm/index.tsx
index d7ae637865..50d67c8744 100644
--- a/src/sentry/static/sentry/app/views/settings/incidentRules/ruleForm/index.tsx
+++ b/src/sentry/static/sentry/app/views/settings/incidentRules/ruleForm/index.tsx
@@ -263,11 +263,15 @@ class RuleFormContainer extends AsyncComponent<Props, State> {
   }
 
   handleFieldChange = (name: string, value: unknown) => {
-    if (['query', 'timeWindow', 'aggregation'].includes(name)) {
+    if (['timeWindow', 'aggregation'].includes(name)) {
       this.setState({[name]: value});
     }
   };
 
+  handleFilterUpdate = query => {
+    this.setState({query});
+  };
+
   handleSubmit = async (
     _data: Partial<IncidentRule>,
     _onSubmitSuccess,
@@ -444,6 +448,7 @@ class RuleFormContainer extends AsyncComponent<Props, State> {
               projectSlug={params.projectId}
               organization={organization}
               disabled={!hasAccess}
+              onFilterUpdate={this.handleFilterUpdate}
             />
 
             <Triggers
diff --git a/tests/js/spec/components/smartSearchBar.spec.jsx b/tests/js/spec/components/smartSearchBar.spec.jsx
index 4197648137..ffd84dbf28 100644
--- a/tests/js/spec/components/smartSearchBar.spec.jsx
+++ b/tests/js/spec/components/smartSearchBar.spec.jsx
@@ -243,7 +243,7 @@ describe('SmartSearchBar', function() {
       searchBar.state.dropdownVisible = true;
 
       jest.useFakeTimers();
-      searchBar.onQueryBlur();
+      searchBar.onQueryBlur({target: {value: 'test'}});
       jest.advanceTimersByTime(201); // doesn't close until 200ms
 
       expect(searchBar.state.dropdownVisible).toBe(false);
