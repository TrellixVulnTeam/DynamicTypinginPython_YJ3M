commit f041ebc388ab2832a52d58546a3ef21c8ff533ff
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Oct 19 19:20:08 2013 -0700

    Move node cleanup to backend

diff --git a/src/sentry/nodestore/base.py b/src/sentry/nodestore/base.py
index 13911cd118..5105ecbefa 100644
--- a/src/sentry/nodestore/base.py
+++ b/src/sentry/nodestore/base.py
@@ -62,3 +62,6 @@ class NodeStorage(object):
 
     def generate_id(self):
         return uuid.uuid4().hex
+
+    def cleanup(self, cutoff_timestamp):
+        raise NotImplementedError
diff --git a/src/sentry/nodestore/django/backend.py b/src/sentry/nodestore/django/backend.py
index 49310e2184..d4c612cc64 100644
--- a/src/sentry/nodestore/django/backend.py
+++ b/src/sentry/nodestore/django/backend.py
@@ -41,3 +41,6 @@ class DjangoNodeStorage(NodeStorage):
                 'timestamp': timezone.now(),
             },
         )
+
+    def cleanup(self, cutoff_timestamp):
+        Node.objects.filter(timestamp__lte=cutoff_timestamp).delete()
diff --git a/src/sentry/nodestore/multi/backend.py b/src/sentry/nodestore/multi/backend.py
index 6c225795b5..0656f744cf 100644
--- a/src/sentry/nodestore/multi/backend.py
+++ b/src/sentry/nodestore/multi/backend.py
@@ -78,3 +78,14 @@ class MultiNodeStorage(NodeStorage):
 
         if should_raise:
             raise
+
+    def cleanup(self, cutoff_timestamp):
+        should_raise = False
+        for backend in self.backends:
+            try:
+                backend.cleanup(cutoff_timestamp)
+            except Exception:
+                should_raise = True
+
+        if should_raise:
+            raise
diff --git a/src/sentry/nodestore/riak/backend.py b/src/sentry/nodestore/riak/backend.py
index 2b9ad2faa2..0ad5951c5f 100644
--- a/src/sentry/nodestore/riak/backend.py
+++ b/src/sentry/nodestore/riak/backend.py
@@ -53,3 +53,8 @@ class RiakNodeStorage(NodeStorage):
     def set(self, id, data):
         obj = self.bucket.new(key=id, data=data)
         obj.store()
+
+    def cleanup(self, cutoff_timestamp):
+        # TODO(dcramer): we should either index timestamps or have this run
+        # a map/reduce (probably the latter)
+        raise NotImplementedError
diff --git a/src/sentry/tasks/cleanup.py b/src/sentry/tasks/cleanup.py
index 2e9e0ee376..04ffbffe6c 100644
--- a/src/sentry/tasks/cleanup.py
+++ b/src/sentry/tasks/cleanup.py
@@ -23,12 +23,12 @@ def cleanup(days=30, project=None, chunk_size=1000, **kwargs):
 
     from django.utils import timezone
 
+    from sentry import app
     # TODO: TagKey and GroupTagKey need cleaned up
     from sentry.models import (
         Group, Event, GroupCountByMinute, EventMapping,
         GroupTag, TagValue, ProjectCountByMinute, Alert,
         SearchDocument, Activity, LostPasswordHash)
-    from sentry.nodestore.django.models import Node
 
     GENERIC_DELETES = (
         (SearchDocument, 'date_changed'),
@@ -53,8 +53,12 @@ def cleanup(days=30, project=None, chunk_size=1000, **kwargs):
         date_added__lte=timezone.now() - datetime.timedelta(days=1)
     ).delete()
 
+    # TODO: we should move this into individual backends
     log.info("Removing old Node values")
-    Node.objects.filter(timestamp__lte=ts)
+    try:
+        app.nodestore.cleanup(ts)
+    except NotImplementedError:
+        log.warning("Node backend does not support cleanup operation")
 
     # Remove types which can easily be bound to project + date
     for model, date_col in GENERIC_DELETES:
