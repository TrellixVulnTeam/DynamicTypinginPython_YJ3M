commit 076efce0ab47446f306e91a60dda30abb5410fa8
Author: Jess MacQueen <jess@getsentry.com>
Date:   Thu May 5 18:10:38 2016 -0700

    fix detetion of file/avatars when users are deleted

diff --git a/src/sentry/migrations/0249_auto__add_useravatar.py b/src/sentry/migrations/0249_auto__add_useravatar.py
index 2675b2b7db..1ec0c2252e 100644
--- a/src/sentry/migrations/0249_auto__add_useravatar.py
+++ b/src/sentry/migrations/0249_auto__add_useravatar.py
@@ -12,7 +12,7 @@ class Migration(SchemaMigration):
         db.create_table('sentry_useravatar', (
             ('id', self.gf('sentry.db.models.fields.bounded.BoundedBigAutoField')(primary_key=True)),
             ('user', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(related_name='avatar', unique=True, to=orm['sentry.User'])),
-            ('file', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.File'], unique=True, null=True)),
+            ('file', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.File'], unique=True, null=True, on_delete=models.SET_NULL)),
             ('ident', self.gf('django.db.models.fields.CharField')(max_length=36, unique=True, null=True, db_index=True)),
             ('avatar_type', self.gf('django.db.models.fields.CharField')(default='letter_avatar', max_length=20)),
         ))
@@ -89,7 +89,7 @@ class Migration(SchemaMigration):
         'sentry.broadcast': {
             'Meta': {'object_name': 'Broadcast'},
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2016, 5, 11, 0, 0)', 'null': 'True', 'blank': 'True'}),
+            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2016, 5, 13, 0, 0)', 'null': 'True', 'blank': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_active': ('django.db.models.fields.BooleanField', [], {'default': 'True', 'db_index': 'True'}),
             'link': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True', 'blank': 'True'}),
@@ -566,7 +566,7 @@ class Migration(SchemaMigration):
         'sentry.useravatar': {
             'Meta': {'object_name': 'UserAvatar'},
             'avatar_type': ('django.db.models.fields.CharField', [], {'default': "'letter_avatar'", 'max_length': '20'}),
-            'file': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.File']", 'unique': 'True', 'null': 'True'}),
+            'file': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.File']", 'unique': 'True', 'null': 'True', 'on_delete': 'models.SET_NULL'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'ident': ('django.db.models.fields.CharField', [], {'max_length': '36', 'unique': 'True', 'null': 'True', 'db_index': 'True'}),
             'user': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'related_name': "'avatar'", 'unique': 'True', 'to': "orm['sentry.User']"})
diff --git a/src/sentry/migrations/0250_default_users_to_gravatar.py b/src/sentry/migrations/0250_default_users_to_gravatar.py
index f7725bed77..cd52dc5e70 100644
--- a/src/sentry/migrations/0250_default_users_to_gravatar.py
+++ b/src/sentry/migrations/0250_default_users_to_gravatar.py
@@ -82,7 +82,7 @@ class Migration(DataMigration):
         'sentry.broadcast': {
             'Meta': {'object_name': 'Broadcast'},
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2016, 5, 11, 0, 0)', 'null': 'True', 'blank': 'True'}),
+            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2016, 5, 13, 0, 0)', 'null': 'True', 'blank': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_active': ('django.db.models.fields.BooleanField', [], {'default': 'True', 'db_index': 'True'}),
             'link': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True', 'blank': 'True'}),
@@ -559,7 +559,7 @@ class Migration(DataMigration):
         'sentry.useravatar': {
             'Meta': {'object_name': 'UserAvatar'},
             'avatar_type': ('django.db.models.fields.CharField', [], {'default': "'letter_avatar'", 'max_length': '20'}),
-            'file': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.File']", 'unique': 'True', 'null': 'True'}),
+            'file': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.File']", 'unique': 'True', 'null': 'True', 'on_delete': 'models.SET_NULL'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'ident': ('django.db.models.fields.CharField', [], {'max_length': '36', 'unique': 'True', 'null': 'True', 'db_index': 'True'}),
             'user': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'related_name': "'avatar'", 'unique': 'True', 'to': "orm['sentry.User']"})
diff --git a/src/sentry/models/user.py b/src/sentry/models/user.py
index d05418bbac..3614ee6ed9 100644
--- a/src/sentry/models/user.py
+++ b/src/sentry/models/user.py
@@ -63,6 +63,7 @@ class User(BaseModel, AbstractBaseUser):
     def delete(self):
         if self.username == 'sentry':
             raise Exception('You cannot delete the "sentry" user as it is required by Sentry.')
+        self.avatar.first().delete()
         return super(User, self).delete()
 
     def save(self, *args, **kwargs):
diff --git a/src/sentry/models/useravatar.py b/src/sentry/models/useravatar.py
index 3c6fe5f222..839f8122b3 100644
--- a/src/sentry/models/useravatar.py
+++ b/src/sentry/models/useravatar.py
@@ -1,7 +1,6 @@
 from __future__ import absolute_import
 
 import StringIO
-import base64
 import uuid
 
 from PIL import Image
@@ -27,7 +26,7 @@ class UserAvatar(Model):
     ALLOWED_SIZES = (20, 48, 52, 64, 80, 96)
 
     user = FlexibleForeignKey('sentry.User', unique=True, related_name='avatar')
-    file = FlexibleForeignKey('sentry.File', unique=True, null=True)
+    file = FlexibleForeignKey('sentry.File', unique=True, null=True, on_delete=models.SET_NULL)
     ident = models.CharField(max_length=36, unique=True, db_index=True, null=True)
     avatar_type = models.CharField(max_length=20, choices=AVATAR_TYPES, default='letter_avatar')
 
@@ -40,6 +39,11 @@ class UserAvatar(Model):
             self.ident = uuid.uuid4()
         return super(UserAvatar, self).save(*args, **kwargs)
 
+    def delete(self, *args, **kwargs):
+        if self.file:
+            self.file.delete()
+        return super(UserAvatar, self).delete(*args, **kwargs)
+
     def get_cache_key(self, size):
         return 'avatar:%s:%s' % (self.user_id, size)
 
