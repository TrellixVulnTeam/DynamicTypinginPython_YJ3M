commit a4ebc44d8aa6e036e456381b1b84b2da6c6336de
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Wed May 23 10:08:58 2018 -0700

    fix(dashboard): Only return latest deploy for each environment (#8517)

diff --git a/src/sentry/api/serializers/models/project.py b/src/sentry/api/serializers/models/project.py
index a4c416a739..8b3fb7730f 100644
--- a/src/sentry/api/serializers/models/project.py
+++ b/src/sentry/api/serializers/models/project.py
@@ -272,14 +272,21 @@ class ProjectSummarySerializer(ProjectWithTeamSerializer):
                 'id',
                 'date_finished'))
 
-        deploys_by_project = defaultdict(list)
+        deploys_by_project = defaultdict(dict)
 
         for rpe in release_project_envs:
-            deploys_by_project[rpe['project__id']].append({
-                'version': rpe['release__version'],
-                'environment': rpe['environment__name'],
-                'dateFinished': deploys[rpe['last_deploy_id']],
-            })
+            env_name = rpe['environment__name']
+            project_id = rpe['project__id']
+            date_finished = deploys[rpe['last_deploy_id']]
+
+            if (
+                env_name not in deploys_by_project[project_id] or
+                deploys_by_project[project_id][env_name]['dateFinished'] < date_finished
+            ):
+                deploys_by_project[project_id][env_name] = {
+                    'version': rpe['release__version'],
+                    'dateFinished': date_finished
+                }
 
         for item in item_list:
             attrs[item]['deploys'] = deploys_by_project.get(item.id)
diff --git a/tests/sentry/api/serializers/test_project.py b/tests/sentry/api/serializers/test_project.py
index 7b8751c799..edd22ece48 100644
--- a/tests/sentry/api/serializers/test_project.py
+++ b/tests/sentry/api/serializers/test_project.py
@@ -3,11 +3,14 @@
 from __future__ import absolute_import
 
 import six
+import datetime
+from django.utils import timezone
 
 from sentry.api.serializers import serialize
 from sentry.api.serializers.models.project import (
-    ProjectWithOrganizationSerializer, ProjectWithTeamSerializer
+    ProjectWithOrganizationSerializer, ProjectWithTeamSerializer, ProjectSummarySerializer
 )
+from sentry.models import Deploy, Environment, Release, ReleaseProjectEnvironment
 from sentry.testutils import TestCase
 
 
@@ -145,6 +148,45 @@ class ProjectWithTeamSerializerTest(TestCase):
             'name': team.name}
 
 
+class ProjectSummarySerializerTest(TestCase):
+    def test_simple(self):
+        date = datetime.datetime(2018, 1, 12, 3, 8, 25, tzinfo=timezone.utc)
+        user = self.create_user(username='foo')
+        organization = self.create_organization(owner=user)
+        team = self.create_team(organization=organization)
+        project = self.create_project(teams=[team], organization=organization, name='foo')
+
+        release = Release.objects.create(
+            organization_id=organization.id,
+            version='1',
+        )
+
+        environment = Environment.objects.create(
+            organization_id=organization.id,
+            name='production',
+        )
+
+        deploy = Deploy.objects.create(
+            environment_id=environment.id,
+            organization_id=organization.id,
+            release=release,
+            date_finished=date
+        )
+
+        ReleaseProjectEnvironment.objects.create(
+            project_id=project.id,
+            release_id=release.id,
+            environment_id=environment.id,
+            last_deploy_id=deploy.id
+        )
+
+        result = serialize(project, user, ProjectSummarySerializer())
+
+        assert result['latestDeploys'] == {
+            'production': {'dateFinished': date, 'version': '1'}
+        }
+
+
 class ProjectWithOrganizationSerializerTest(TestCase):
     def test_simple(self):
         user = self.create_user(username='foo')
