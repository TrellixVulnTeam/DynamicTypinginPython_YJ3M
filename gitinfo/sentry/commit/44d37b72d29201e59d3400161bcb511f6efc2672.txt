commit 44d37b72d29201e59d3400161bcb511f6efc2672
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Thu Dec 6 16:21:07 2018 -0800

    feat(settings): Expose disabled Auth page to members (#10954)

diff --git a/src/sentry/api/endpoints/organization_auth_providers.py b/src/sentry/api/endpoints/organization_auth_providers.py
index 37c285967b..6008c7f406 100644
--- a/src/sentry/api/endpoints/organization_auth_providers.py
+++ b/src/sentry/api/endpoints/organization_auth_providers.py
@@ -4,12 +4,12 @@ from rest_framework.response import Response
 
 from sentry.auth import manager
 from sentry.auth.providers.saml2 import SAML2Provider
-from sentry.api.bases.organization import OrganizationEndpoint, OrganizationAdminPermission
+from sentry.api.bases.organization import OrganizationEndpoint, OrganizationAuthProviderPermission
 from sentry.api.serializers import serialize
 
 
 class OrganizationAuthProvidersEndpoint(OrganizationEndpoint):
-    permission_classes = (OrganizationAdminPermission, )
+    permission_classes = (OrganizationAuthProviderPermission, )
 
     def get(self, request, organization):
         """
diff --git a/src/sentry/static/sentry/app/views/settings/organization/navigationConfiguration.jsx b/src/sentry/static/sentry/app/views/settings/organization/navigationConfiguration.jsx
index 9d9353f8f5..f5b1e7eba5 100644
--- a/src/sentry/static/sentry/app/views/settings/organization/navigationConfiguration.jsx
+++ b/src/sentry/static/sentry/app/views/settings/organization/navigationConfiguration.jsx
@@ -38,7 +38,6 @@ const organizationNavigation = [
       {
         path: `${pathPrefix}/auth/`,
         title: t('Auth'),
-        show: ({access}) => access.has('org:admin'),
         description: t('Configure single sign-on'),
       },
       {
diff --git a/src/sentry/static/sentry/app/views/settings/organizationAuth/index.jsx b/src/sentry/static/sentry/app/views/settings/organizationAuth/index.jsx
index a46c8c9268..d4ec66133c 100644
--- a/src/sentry/static/sentry/app/views/settings/organizationAuth/index.jsx
+++ b/src/sentry/static/sentry/app/views/settings/organizationAuth/index.jsx
@@ -1,8 +1,8 @@
 import React from 'react';
 
 import {t} from 'app/locale';
-import IndicatorStore from 'app/stores/indicatorStore';
 import AsyncView from 'app/views/asyncView';
+import IndicatorStore from 'app/stores/indicatorStore';
 import SentryTypes from 'app/sentryTypes';
 
 import OrganizationAuthList from './organizationAuthList';
@@ -13,8 +13,11 @@ class OrganizationAuth extends AsyncView {
   };
 
   componentWillUpdate(nextProps, nextState) {
-    if (nextState.provider) {
-      // If SSO provider is configured, keep showing loading while we redirect to django configuration view
+    const access = this.context.organization.access;
+
+    if (nextState.provider && access.includes('org:admin')) {
+      // If SSO provider is configured, keep showing loading while we redirect
+      // to django configuration view
       window.location.assign(`/organizations/${this.props.params.orgId}/auth/configure/`);
     }
   }
@@ -90,18 +93,25 @@ class OrganizationAuth extends AsyncView {
 
   renderBody() {
     let {providerList, provider} = this.state;
+    let access = this.context.organization.access;
 
-    if (!provider) {
-      return (
-        <OrganizationAuthList
-          providerList={providerList}
-          onConfigure={this.handleConfigure}
-        />
-      );
+    if (access.includes('org:admin') && provider) {
+      // If SSO provider is configured, keep showing loading while we redirect
+      // to django configuration view
+      return this.renderLoading();
     }
 
-    // If SSO provider is configured, keep showing loading while we redirect to django configuration view
-    return this.renderLoading();
+    let activeProvider = providerList.find(
+      p => provider && p.key === provider.provider_name
+    );
+
+    return (
+      <OrganizationAuthList
+        activeProvider={activeProvider}
+        providerList={providerList}
+        onConfigure={this.handleConfigure}
+      />
+    );
 
     /* For now this is in django
     if (provider) {
diff --git a/src/sentry/static/sentry/app/views/settings/organizationAuth/organizationAuthList.jsx b/src/sentry/static/sentry/app/views/settings/organizationAuth/organizationAuthList.jsx
index 8833217d15..6cfcc0e365 100644
--- a/src/sentry/static/sentry/app/views/settings/organizationAuth/organizationAuthList.jsx
+++ b/src/sentry/static/sentry/app/views/settings/organizationAuth/organizationAuthList.jsx
@@ -7,6 +7,7 @@ import {descopeFeatureName} from 'app/utils';
 import {t, tct} from 'app/locale';
 import EmptyMessage from 'app/views/settings/components/emptyMessage';
 import ExternalLink from 'app/components/externalLink';
+import PermissionAlert from 'app/views/settings/organization/permissionAlert';
 import SentryTypes from 'app/sentryTypes';
 import SettingsPageHeader from 'app/views/settings/components/settingsPageHeader';
 import getCookie from 'app/utils/getCookie';
@@ -20,9 +21,11 @@ class OrganizationAuthList extends React.Component {
 
   static propTypes = {
     providerList: PropTypes.arrayOf(SentryTypes.AuthProvider).isRequired,
+    activeProvider: PropTypes.object,
   };
 
   render() {
+    const {activeProvider} = this.props;
     const {organization} = this.context;
     const features = organization.features;
 
@@ -48,18 +51,20 @@ class OrganizationAuthList extends React.Component {
     return (
       <div className="sso">
         <SettingsPageHeader title="Authentication" />
+        <PermissionAlert />
         <Panel>
           <PanelHeader>{t('Choose a provider')}</PanelHeader>
           <PanelBody>
-            <PanelAlert type="info">
-              {tct(
-                `Get started with Single Sign-on for your organization by
-                selecting a provider. Read more in our [link:SSO documentation].`,
-                {
-                  link: <ExternalLink href="https://docs.sentry.io/learn/sso/" />,
-                }
-              )}
-            </PanelAlert>
+            {!activeProvider && (
+              <PanelAlert type="info">
+                {tct(
+                  'Get started with Single Sign-on for your organization by selecting a provider. Read more in our [link:SSO documentation].',
+                  {
+                    link: <ExternalLink href="https://docs.sentry.io/learn/sso/" />,
+                  }
+                )}
+              </PanelAlert>
+            )}
 
             {warn2FADisable && (
               <PanelAlert m={0} mb={0} type="warning">
@@ -76,12 +81,16 @@ class OrganizationAuthList extends React.Component {
               <input
                 type="hidden"
                 name="csrfmiddlewaretoken"
-                value={getCookie(CSRF_COOKIE_NAME)}
+                value={getCookie(CSRF_COOKIE_NAME) || ''}
               />
               <input type="hidden" name="init" value="1" />
 
               {providerList.map(provider => (
-                <ProviderItem key={provider.key} provider={provider} />
+                <ProviderItem
+                  key={provider.key}
+                  provider={provider}
+                  active={activeProvider && provider.key === activeProvider.key}
+                />
               ))}
               {providerList.length === 0 && (
                 <EmptyMessage>
diff --git a/src/sentry/static/sentry/app/views/settings/organizationAuth/providerItem.jsx b/src/sentry/static/sentry/app/views/settings/organizationAuth/providerItem.jsx
index 12bfb32529..ef75a12b23 100644
--- a/src/sentry/static/sentry/app/views/settings/organizationAuth/providerItem.jsx
+++ b/src/sentry/static/sentry/app/views/settings/organizationAuth/providerItem.jsx
@@ -5,6 +5,7 @@ import styled from 'react-emotion';
 
 import {PanelItem} from 'app/components/panels';
 import {t} from 'app/locale';
+import Access from 'app/components/acl/access';
 import Button from 'app/components/button';
 import Feature from 'app/components/acl/feature';
 import FeatureDisabled from 'app/components/acl/featureDisabled';
@@ -16,6 +17,7 @@ export default class ProviderItem extends React.PureComponent {
   static propTypes = {
     provider: SentryTypes.AuthProvider.isRequired,
     onConfigure: PropTypes.func.isRequired,
+    active: PropTypes.bool,
   };
 
   static defaultProps = {
@@ -29,20 +31,24 @@ export default class ProviderItem extends React.PureComponent {
   renderDisabledLock = p => <LockedFeature provider={p.provider} features={p.features} />;
 
   renderInstallButton = ({provider, hasFeature}) => (
-    <Button
-      type="submit"
-      name="provider"
-      size="small"
-      value={provider.key}
-      disabled={!hasFeature}
-      onClick={this.handleConfigure}
-    >
-      {t('Configure')}
-    </Button>
+    <Access access={['org:admin']}>
+      {({hasAccess}) => (
+        <Button
+          type="submit"
+          name="provider"
+          size="small"
+          value={provider.key}
+          disabled={!hasFeature || !hasAccess}
+          onClick={this.handleConfigure}
+        >
+          {t('Configure')}
+        </Button>
+      )}
+    </Access>
   );
 
   render() {
-    const {provider} = this.props;
+    const {provider, active} = this.props;
 
     return (
       <Feature
@@ -65,7 +71,11 @@ export default class ProviderItem extends React.PureComponent {
             <Box flex={1}>{!hasFeature && renderDisabled({provider, features})}</Box>
 
             <Box>
-              {(renderInstallButton || this.renderInstallButton)({provider, hasFeature})}
+              {active ? (
+                <ActiveIndicator />
+              ) : (
+                (renderInstallButton || this.renderInstallButton)({provider, hasFeature})
+              )}
             </Box>
           </PanelItem>
         )}
@@ -91,6 +101,14 @@ const ProviderDescription = styled('div')`
   font-size: 0.8em;
 `;
 
+const ActiveIndicator = styled(p => <div className={p.className}>Active</div>)`
+  background: ${p => p.theme.green};
+  color: #fff;
+  padding: 8px 12px;
+  border-radius: 2px;
+  font-size: 0.8em;
+`;
+
 const DisabledHovercard = styled(Hovercard)`
   width: 350px;
 `;
diff --git a/tests/js/fixtures/authProviders.js b/tests/js/fixtures/authProviders.js
index 9b421ac8dc..c83e23c7b0 100644
--- a/tests/js/fixtures/authProviders.js
+++ b/tests/js/fixtures/authProviders.js
@@ -8,8 +8,8 @@ export function AuthProviders(params = []) {
     },
     {
       disables2FA: true,
-      key: 'dummy',
-      name: 'Dummy',
+      key: 'dummy2',
+      name: 'Dummy SAML',
       requiredFeature: 'organizations:sso-saml2',
     },
     ...params,
diff --git a/tests/js/spec/views/settings/__snapshots__/organizationAuthList.spec.jsx.snap b/tests/js/spec/views/settings/__snapshots__/organizationAuthList.spec.jsx.snap
index 906dfc81b7..b1876b0579 100644
--- a/tests/js/spec/views/settings/__snapshots__/organizationAuthList.spec.jsx.snap
+++ b/tests/js/spec/views/settings/__snapshots__/organizationAuthList.spec.jsx.snap
@@ -7,6 +7,13 @@ exports[`OrganizationAuthList renders 1`] = `
   <SettingsPageHeading
     title="Authentication"
   />
+  <PermissionAlert
+    access={
+      Array [
+        "org:write",
+      ]
+    }
+  />
   <Panel>
     <PanelHeader>
       Choose a provider
@@ -25,8 +32,7 @@ exports[`OrganizationAuthList renders 1`] = `
           <span
             key="0"
           >
-            Get started with Single Sign-on for your organization by
-                selecting a provider. Read more in our 
+            Get started with Single Sign-on for your organization by selecting a provider. Read more in our 
           </span>
           <ExternalLink
             href="https://docs.sentry.io/learn/sso/"
@@ -54,7 +60,7 @@ exports[`OrganizationAuthList renders 1`] = `
         <input
           name="csrfmiddlewaretoken"
           type="hidden"
-          value={null}
+          value=""
         />
         <input
           name="init"
@@ -74,13 +80,13 @@ exports[`OrganizationAuthList renders 1`] = `
           }
         />
         <ProviderItem
-          key="dummy"
+          key="dummy2"
           onConfigure={[Function]}
           provider={
             Object {
               "disables2FA": true,
-              "key": "dummy",
-              "name": "Dummy",
+              "key": "dummy2",
+              "name": "Dummy SAML",
               "requiredFeature": "organizations:sso-saml2",
             }
           }
@@ -98,6 +104,13 @@ exports[`OrganizationAuthList renders with no providers 1`] = `
   <SettingsPageHeading
     title="Authentication"
   />
+  <PermissionAlert
+    access={
+      Array [
+        "org:write",
+      ]
+    }
+  />
   <Panel>
     <PanelHeader>
       Choose a provider
@@ -116,8 +129,7 @@ exports[`OrganizationAuthList renders with no providers 1`] = `
           <span
             key="0"
           >
-            Get started with Single Sign-on for your organization by
-                selecting a provider. Read more in our 
+            Get started with Single Sign-on for your organization by selecting a provider. Read more in our 
           </span>
           <ExternalLink
             href="https://docs.sentry.io/learn/sso/"
@@ -145,7 +157,7 @@ exports[`OrganizationAuthList renders with no providers 1`] = `
         <input
           name="csrfmiddlewaretoken"
           type="hidden"
-          value={null}
+          value=""
         />
         <input
           name="init"
diff --git a/tests/js/spec/views/settings/organizationAuthList.spec.jsx b/tests/js/spec/views/settings/organizationAuthList.spec.jsx
index f5b098ec80..33f45d0a6b 100644
--- a/tests/js/spec/views/settings/organizationAuthList.spec.jsx
+++ b/tests/js/spec/views/settings/organizationAuthList.spec.jsx
@@ -1,5 +1,5 @@
 import React from 'react';
-import {shallow} from 'enzyme';
+import {shallow, mount} from 'enzyme';
 
 import OrganizationAuthList from 'app/views/settings/organizationAuth/organizationAuthList';
 
@@ -28,6 +28,24 @@ describe('OrganizationAuthList', function() {
     expect(wrapper).toMatchSnapshot();
   });
 
+  it('renders for members', function() {
+    let wrapper = mount(
+      <OrganizationAuthList
+        orgId="org-slug"
+        onSendReminders={() => {}}
+        providerList={TestStubs.AuthProviders()}
+        activeProvider={TestStubs.AuthProviders()[0]}
+      />,
+      TestStubs.routerContext([
+        {
+          organization: TestStubs.Organization({access: ['org:read']}),
+        },
+      ])
+    );
+
+    expect(wrapper.find('ProviderItem ActiveIndicator')).toHaveLength(1);
+  });
+
   describe('with 2fa warning', function() {
     const require2fa = {require2FA: true};
     const withSAML = {features: ['sso-saml2']};
diff --git a/tests/sentry/api/endpoints/test_organization_auth_providers.py b/tests/sentry/api/endpoints/test_organization_auth_providers.py
index b774f803e3..339c2bd583 100644
--- a/tests/sentry/api/endpoints/test_organization_auth_providers.py
+++ b/tests/sentry/api/endpoints/test_organization_auth_providers.py
@@ -13,22 +13,14 @@ class OrganizationAuthProvidersPermissionTest(PermissionTestCase):
             args=[self.organization.slug]
         )
 
-    def test_teamless_admin_cannot_load(self):
-        with self.feature('organizations:sso-basic'):
-            self.assert_teamless_admin_cannot_access(self.path)
-
-    def test_team_admin_cannot_load(self):
-        with self.feature('organizations:sso-basic'):
-            self.assert_team_admin_cannot_access(self.path)
-
-    def test_manager_cannot_load(self):
-        with self.feature('organizations:sso-basic'):
-            self.assert_role_cannot_access(self.path, 'manager')
-
     def test_owner_can_load(self):
         with self.feature('organizations:sso-basic'):
             self.assert_owner_can_access(self.path)
 
+    def test_member_can_get(self):
+        with self.feature('organizations:sso-basic'):
+            self.assert_member_can_access(self.path)
+
 
 class OrganizationAuthProviders(APITestCase):
     def test_get_list_of_auth_providers(self):
