commit 480179ac52b83a140a8c8cbcd021f230bba4cced
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Dec 1 15:24:43 2014 -0800

    Optimize org member addition

diff --git a/src/sentry/migrations/0132_add_org_members.py b/src/sentry/migrations/0132_add_org_members.py
index 81e70ac2e5..dd5c828e75 100644
--- a/src/sentry/migrations/0132_add_org_members.py
+++ b/src/sentry/migrations/0132_add_org_members.py
@@ -7,17 +7,21 @@ from django.db import models
 class Migration(DataMigration):
 
     def forwards(self, orm):
-        Organization = orm['sentry.Organization']
         OrganizationMember = orm['sentry.OrganizationMember']
-        TeamMember = orm['sentry.TeamMember']
+        Team = orm['sentry.Team']
 
-        for org in Organization.objects.all().iterator():
-            for team in org.team_set.all().iterator():
-                OrganizationMember.objects.get_or_create(
-                    organization=org,
-                    user=team.owner,
-                    defaults={'type': 0},  # ADMIN
-                )
+        existing = set()
+
+        for team in Team.objects.select_related('organization').iterator():
+            if team.owner_id in existing:
+                continue
+
+            OrganizationMember.objects.get_or_create(
+                organization=team.organization,
+                user=team.owner,
+                defaults={'type': 0},  # ADMIN
+            )
+            existing.add(team.owner_id)
 
     def backwards(self, orm):
         pass
