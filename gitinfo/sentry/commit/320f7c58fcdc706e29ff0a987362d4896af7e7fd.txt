commit 320f7c58fcdc706e29ff0a987362d4896af7e7fd
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Oct 5 13:08:59 2016 -0700

    [emails] fix re-setting of verification hash (#4273)

diff --git a/src/sentry/models/useremail.py b/src/sentry/models/useremail.py
index 2d7be1f904..e0c7581bba 100644
--- a/src/sentry/models/useremail.py
+++ b/src/sentry/models/useremail.py
@@ -20,7 +20,8 @@ class UserEmail(Model):
     user = FlexibleForeignKey(settings.AUTH_USER_MODEL,
                               related_name='emails')
     email = models.EmailField(_('email address'))
-    validation_hash = models.CharField(max_length=32)
+    validation_hash = models.CharField(
+        max_length=32, default=lambda: get_random_string(32, CHARACTERS))
     date_hash_added = models.DateTimeField(default=timezone.now)
     is_verified = models.BooleanField(
         _('verified'), default=False,
@@ -33,11 +34,6 @@ class UserEmail(Model):
 
     __repr__ = sane_repr('user_id', 'email')
 
-    def __init__(self, *args, **kwargs):
-        super(UserEmail, self).__init__(*args, **kwargs)
-        if not self.validation_hash:
-            self.set_hash()
-
     def set_hash(self):
         self.date_hash_added = timezone.now()
         self.validation_hash = get_random_string(32, CHARACTERS)
diff --git a/tests/sentry/models/test_useremail.py b/tests/sentry/models/test_useremail.py
new file mode 100644
index 0000000000..b54a7ae304
--- /dev/null
+++ b/tests/sentry/models/test_useremail.py
@@ -0,0 +1,14 @@
+from __future__ import absolute_import
+
+from sentry.models import UserEmail
+from sentry.testutils import TestCase
+
+
+class UserEmailTest(TestCase):
+    def test_hash_does_not_reset(self):
+        user = self.create_user('foo@example.com')
+        email = UserEmail.objects.get_or_create(user=user)[0]
+        email2 = UserEmail.objects.get(id=email.id)
+
+        assert email.validation_hash
+        assert email.validation_hash == email2.validation_hash
