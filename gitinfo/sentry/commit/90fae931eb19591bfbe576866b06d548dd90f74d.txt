commit 90fae931eb19591bfbe576866b06d548dd90f74d
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Fri Jul 10 21:30:23 2020 +0300

    fix(relay): Fix internal ip check for is_internal_relay (#19798)
    
    `settings.INTERNAL_IPS` is meant to be a list of IP networks, not individual IPs, hence the `is_internal_relay` check was not working (see getsentry/onpremise#572). This PR fixes the issue by replacing the manual and incorrect check with `sentry.auth.system.is_internal_ip`. This also means we are now checking against `INTERNAL_SYSTEM_IPS` instead of `INTERNAL_IPS` which is more accurate.

diff --git a/src/sentry/api/endpoints/relay_register.py b/src/sentry/api/endpoints/relay_register.py
index e0798eeed1..bdb05251f2 100644
--- a/src/sentry/api/endpoints/relay_register.py
+++ b/src/sentry/api/endpoints/relay_register.py
@@ -11,6 +11,7 @@ from django.utils import timezone
 from sentry.cache import default_cache
 from sentry.utils import json
 from sentry.models import Relay
+from sentry.auth.system import is_internal_ip
 from sentry.api.base import Endpoint
 from sentry.api.serializers import serialize
 from sentry.relay.utils import get_header_relay_id, get_header_relay_signature
@@ -42,13 +43,10 @@ def is_internal_relay(request, public_key):
     """
     Checks if the relay is allowed to register, otherwise raises an exception
     """
-    if (
-        settings.DEBUG
-        or request.META.get("REMOTE_ADDR", None) in settings.INTERNAL_IPS
-        or public_key in settings.SENTRY_RELAY_WHITELIST_PK
-    ):
+    if settings.DEBUG or public_key in settings.SENTRY_RELAY_WHITELIST_PK:
         return True
-    return False
+
+    return is_internal_ip(is_internal_ip)
 
 
 class RelayRegisterChallengeEndpoint(Endpoint):
