commit 599ac0c30f23363e8090588ef883e6183b021f68
Author: ted kaemming <ted@kaemming.com>
Date:   Fri Jun 2 11:24:11 2017 -0700

    Get event environment from tags, not data, when unmerging. (#5505)
    
    My previous assumption here was incorrect. The way environment is
    actually processed during ingestion is:
    
    1. https://github.com/getsentry/sentry/blob/a5767ca6f26db209adcc105ebdc1b7083a6b3687/src/sentry/event_manager.py#L306-L311
       If there is a tag that has the `environment` key, set it on the
       `data` mapping instead of passing it through as a tag. If there is an
       existing `environment` attribute, it gets overwritten here.
    2. https://github.com/getsentry/sentry/blob/a5767ca6f26db209adcc105ebdc1b7083a6b3687/src/sentry/event_manager.py#L419
       https://github.com/getsentry/sentry/blob/a5767ca6f26db209adcc105ebdc1b7083a6b3687/src/sentry/event_manager.py#L459-L460
       When saving, remove `environment` from the `data` mapping (so it is
       not set as a top level key on the `Event.data` attribute) and store
       it as a local variable, then put it *back* as a tag on the event.

diff --git a/src/sentry/tasks/unmerge.py b/src/sentry/tasks/unmerge.py
index 106b2375e7..0678672679 100644
--- a/src/sentry/tasks/unmerge.py
+++ b/src/sentry/tasks/unmerge.py
@@ -329,6 +329,17 @@ def repair_tag_data(caches, project, events):
                     )
 
 
+def get_environment(event):
+    environment = event.get_tag('environment')
+
+    # NOTE: ``GroupRelease.environment`` is not nullable, but an empty
+    # string is OK.
+    if environment is None:
+        environment = ''
+
+    return environment
+
+
 def collect_release_data(caches, project, events):
     results = {}
 
@@ -338,18 +349,9 @@ def collect_release_data(caches, project, events):
         if not release:
             continue
 
-        # XXX: It's not really clear what the canonical source is for
-        # environment between the tag and the data attribute, but I'm going
-        # with data attribute for now. Right now it seems like they are
-        # intended to both be present and the same value, but I'm not really
-        # sure that has always been the case for existing values.
-        # NOTE: ``GroupRelease.environment`` is not nullable, but an empty
-        # string is OK.
-        environment = event.data.get('environment', '')
-
         key = (
             event.group_id,
-            environment,
+            get_environment(event),
             caches['Release'](
                 project.organization_id,
                 release,
@@ -428,7 +430,7 @@ def collect_tsdb_data(caches, project, events):
 
         environment = caches['Environment'](
             project.organization_id,
-            event.data.get('environment', ''),
+            get_environment(event),
         )
 
         frequencies[event.datetime][tsdb.models.frequent_environments_by_group][event.group_id][environment.id] += 1
@@ -439,7 +441,7 @@ def collect_tsdb_data(caches, project, events):
             # similar comment above during creation.
             grouprelease = caches['GroupRelease'](
                 event.group_id,
-                event.data.get('environment', ''),
+                get_environment(event),
                 caches['Release'](
                     project.organization_id,
                     release,
