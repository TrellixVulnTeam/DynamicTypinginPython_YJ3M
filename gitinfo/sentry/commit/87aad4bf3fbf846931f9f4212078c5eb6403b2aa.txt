commit 87aad4bf3fbf846931f9f4212078c5eb6403b2aa
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Nov 21 00:47:22 2016 -0800

    mail: prevent a newline from existing in mail subject (#4575)
    
    Fixes SENTRY-223

diff --git a/src/sentry/utils/email.py b/src/sentry/utils/email.py
index 1f0651898f..e397d22fdd 100644
--- a/src/sentry/utils/email.py
+++ b/src/sentry/utils/email.py
@@ -336,7 +336,7 @@ class MessageBuilder(object):
                 headers.setdefault('References', thread.msgid)
 
         msg = EmailMultiAlternatives(
-            subject=subject,
+            subject=subject.splitlines()[0],
             body=self.__render_text_body(),
             from_email=self.from_email,
             to=(to,),
diff --git a/tests/sentry/utils/email/tests.py b/tests/sentry/utils/email/tests.py
index a437a161cf..a2c7d3849a 100644
--- a/tests/sentry/utils/email/tests.py
+++ b/tests/sentry/utils/email/tests.py
@@ -299,6 +299,17 @@ class MessageBuilderTest(TestCase):
 
         assert 'List-Id' not in message
 
+    def test_stripped_newline(self):
+        msg = MessageBuilder(
+            subject='Foo\r\nBar',
+            body='hello world',
+            html_body='<b>hello world</b',
+        )
+        msg.send(['foo@example.com'])
+
+        assert len(mail.outbox) == 1
+        assert mail.outbox[0].subject == 'Foo'
+
 
 class MiscTestCase(TestCase):
     def test_get_from_email_domain(self):
