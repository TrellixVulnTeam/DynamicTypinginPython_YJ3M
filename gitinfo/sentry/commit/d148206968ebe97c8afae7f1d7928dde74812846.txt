commit d148206968ebe97c8afae7f1d7928dde74812846
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Apr 25 11:20:23 2019 -0700

    feat(api): Expose role and scope queries on members

diff --git a/src/sentry/api/endpoints/organization_member_index.py b/src/sentry/api/endpoints/organization_member_index.py
index 536a5820f3..0f7d85c10b 100644
--- a/src/sentry/api/endpoints/organization_member_index.py
+++ b/src/sentry/api/endpoints/organization_member_index.py
@@ -67,6 +67,13 @@ class OrganizationMemberIndexEndpoint(OrganizationEndpoint):
                     queryset = queryset.filter(Q(email__in=value) |
                                                Q(user__email__in=value) |
                                                Q(user__emails__email__in=value))
+
+                elif key == 'scope':
+                    queryset = queryset.filter(role__in=[r.id for r in roles.with_any_scope(value)])
+
+                elif key == 'role':
+                    queryset = queryset.filter(role__in=value)
+
                 elif key == 'query':
                     value = ' '.join(value)
                     queryset = queryset.filter(Q(email__icontains=value) |
diff --git a/src/sentry/roles/__init__.py b/src/sentry/roles/__init__.py
index 4bb538fbad..e3c8b96513 100644
--- a/src/sentry/roles/__init__.py
+++ b/src/sentry/roles/__init__.py
@@ -13,3 +13,4 @@ get_choices = default_manager.get_choices
 get_default = default_manager.get_default
 get_top_dog = default_manager.get_top_dog
 with_scope = default_manager.with_scope
+with_any_scope = default_manager.with_any_scope
diff --git a/src/sentry/roles/manager.py b/src/sentry/roles/manager.py
index 27e149c230..b233e0a948 100644
--- a/src/sentry/roles/manager.py
+++ b/src/sentry/roles/manager.py
@@ -72,3 +72,8 @@ class RoleManager(object):
         for role in self.get_all():
             if role.has_scope(scope):
                 yield role
+
+    def with_any_scope(self, scopes):
+        for role in self.get_all():
+            if any(role.has_scope(scope) for scope in scopes):
+                yield role
diff --git a/tests/sentry/api/endpoints/test_organization_member_index.py b/tests/sentry/api/endpoints/test_organization_member_index.py
index 6d6de2e0bd..215ae4d62c 100644
--- a/tests/sentry/api/endpoints/test_organization_member_index.py
+++ b/tests/sentry/api/endpoints/test_organization_member_index.py
@@ -74,6 +74,31 @@ class OrganizationMemberListTest(APITestCase):
         assert len(response.data) == 1
         assert response.data[0]['email'] == self.owner_user.email
 
+    def test_scope_query(self):
+        response = self.client.get(self.url + "?query=scope:\"invalid:scope\"")
+
+        assert response.status_code == 200
+        assert len(response.data) == 0
+
+        response = self.client.get(self.url + "?query=scope:\"org:admin\"")
+
+        assert response.status_code == 200
+        assert len(response.data) == 1
+        assert response.data[0]['email'] == self.owner_user.email
+
+    def test_role_query(self):
+        response = self.client.get(self.url + "?query=role:member")
+
+        assert response.status_code == 200
+        assert len(response.data) == 1
+        assert response.data[0]['email'] == self.user_2.email
+
+        response = self.client.get(self.url + "?query=role:owner")
+
+        assert response.status_code == 200
+        assert len(response.data) == 1
+        assert response.data[0]['email'] == self.owner_user.email
+
     def test_owner_invites(self):
         self.login_as(user=self.owner_user)
         response = self.client.post(
