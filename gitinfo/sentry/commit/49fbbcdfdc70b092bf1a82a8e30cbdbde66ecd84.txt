commit 49fbbcdfdc70b092bf1a82a8e30cbdbde66ecd84
Author: evanh <evanh@users.noreply.github.com>
Date:   Tue Jun 23 13:25:06 2020 -0400

    fix(discover) use built in failure rate column (#19348)
    
    Instead of hacking failure rate in the sentry side, use the function provided by
    snuba.

diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index da618ea2be..b55eabce52 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -1193,7 +1193,7 @@ FUNCTIONS = {
     "failure_rate": {
         "name": "failure_rate",
         "args": [],
-        "transform": "divide(countIf(and(notEquals(transaction_status, 0), notEquals(transaction_status, 2))), count())",
+        "transform": "failure_rate()",
         "result_type": "percentage",
     },
     # The user facing signature for this function is histogram(<column>, <num_buckets>)
diff --git a/tests/sentry/snuba/test_discover.py b/tests/sentry/snuba/test_discover.py
index 7a8abbfe93..19238fdef1 100644
--- a/tests/sentry/snuba/test_discover.py
+++ b/tests/sentry/snuba/test_discover.py
@@ -612,11 +612,7 @@ class QueryTransformTest(TestCase):
         mock_query.assert_called_with(
             selected_columns=["transaction"],
             aggregations=[
-                [
-                    "divide(countIf(and(notEquals(transaction_status, 0), notEquals(transaction_status, 2))), count())",
-                    None,
-                    "failure_rate",
-                ],
+                ["failure_rate()", None, "failure_rate"],
                 ["argMax", ["event_id", "timestamp"], "latest_event"],
                 ["argMax", ["project_id", "timestamp"], "projectid"],
                 [
