commit 3f20c5d42f836fd37e2367e599c16e3f721236d8
Author: Thomas Grainger <tagrain@gmail.com>
Date:   Wed Mar 1 06:21:10 2017 +0000

    add verify_tls option for sourcemap scaping Fixes #4500 (#4795)
    
    * carrying GH-4795
    
    * Rename option to `verify_ssl` to match how we reference internally to
    avoid using both `verify_ssl` and `verify_tls`.
    * Add the form element to the HTML page so it can be edited.
    
    * update CHANGES

diff --git a/CHANGES b/CHANGES
index 9ccc290671..c1ab62cfca 100644
--- a/CHANGES
+++ b/CHANGES
@@ -16,6 +16,7 @@ Version 8.14 (Unreleased)
 - Various visual improvements to notifications, including the addition of
   transactions.
 - Plugins can now add tasks that run in sentry as celery workers.
+- Added the ability to verify TLS connections when fetching artifacts.
 
 API Changes
 ~~~~~~~~~~~
diff --git a/src/sentry/lang/javascript/processor.py b/src/sentry/lang/javascript/processor.py
index ce4760b4e8..4b7f8cadb3 100644
--- a/src/sentry/lang/javascript/processor.py
+++ b/src/sentry/lang/javascript/processor.py
@@ -302,7 +302,9 @@ def fetch_file(url, project=None, release=None, allow_scraping=True):
 
     if result is None:
         headers = {}
+        verify_ssl = False
         if project and is_valid_origin(url, project=project):
+            verify_ssl = bool(project.get_option('sentry:verify_ssl', False))
             token = project.get_option('sentry:token')
             if token:
                 token_header = project.get_option(
@@ -312,7 +314,7 @@ def fetch_file(url, project=None, release=None, allow_scraping=True):
                 headers[token_header] = token
 
         with metrics.timer('sourcemaps.fetch'):
-            result = http.fetch_file(url, headers=headers)
+            result = http.fetch_file(url, headers=headers, verify_ssl=verify_ssl)
             z_body = zlib.compress(result.body)
             cache.set(cache_key, (url, result.headers, z_body, result.status, result.encoding), 60)
 
diff --git a/src/sentry/templates/sentry/projects/manage.html b/src/sentry/templates/sentry/projects/manage.html
index 2dd5bb8dda..541b0c0199 100644
--- a/src/sentry/templates/sentry/projects/manage.html
+++ b/src/sentry/templates/sentry/projects/manage.html
@@ -85,6 +85,7 @@
         {{ form.scrape_javascript|as_crispy_field }}
         {{ form.token|as_crispy_field }}
         {{ form.token_header|as_crispy_field }}
+        {{ form.verify_ssl|as_crispy_field }}
       </div>
     </div>
 
diff --git a/src/sentry/web/frontend/project_settings.py b/src/sentry/web/frontend/project_settings.py
index 693a4a08ef..d5b83e8975 100644
--- a/src/sentry/web/frontend/project_settings.py
+++ b/src/sentry/web/frontend/project_settings.py
@@ -44,6 +44,11 @@ class EditProjectForm(forms.ModelForm):
         }),
         required=False,
     )
+    verify_ssl = forms.BooleanField(
+        label=_('Verify TLS/SSL'),
+        help_text=_('Outbound requests will verify TLS (sometimes known as SSL) connections.'),
+        required=False,
+    )
     resolve_age = RangeField(label=_('Auto resolve'), required=False,
         min_value=0, max_value=168, step_value=1,
         help_text=_('Automatically resolve an issue if it hasn\'t been seen for this amount of time.'))
@@ -243,6 +248,7 @@ class ProjectSettingsView(ProjectView):
                 'origins': '\n'.join(project.get_option('sentry:origins', ['*'])),
                 'token': security_token,
                 'token_header': project.get_option('sentry:token_header'),
+                'verify_ssl': bool(project.get_option('sentry:verify_ssl', False)),
                 'resolve_age': int(project.get_option('sentry:resolve_age', 0)),
                 'scrub_data': bool(project.get_option('sentry:scrub_data', True)),
                 'scrub_defaults': bool(project.get_option('sentry:scrub_defaults', True)),
@@ -265,6 +271,7 @@ class ProjectSettingsView(ProjectView):
                 'origins',
                 'token',
                 'token_header',
+                'verify_ssl',
                 'resolve_age',
                 'scrub_data',
                 'scrub_defaults',
