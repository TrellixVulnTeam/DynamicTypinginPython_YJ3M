commit 1374018a9651f484e5ece2370c7adf52d4d19ebe
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jun 8 17:00:10 2016 -0700

    Handle re-assigning an existing identity on login

diff --git a/src/sentry/auth/helper.py b/src/sentry/auth/helper.py
index 5c04e01029..f44c6267df 100644
--- a/src/sentry/auth/helper.py
+++ b/src/sentry/auth/helper.py
@@ -7,7 +7,7 @@ from uuid import uuid4
 from django.conf import settings
 from django.contrib import messages
 from django.core.urlresolvers import reverse
-from django.db import transaction
+from django.db import IntegrityError, transaction
 from django.http import HttpResponseRedirect
 from django.utils import timezone
 from django.utils.translation import ugettext_lazy as _
@@ -289,12 +289,22 @@ class AuthHelper(object):
             is_managed=True,
         )
 
-        auth_identity = AuthIdentity.objects.create(
-            auth_provider=auth_provider,
-            user=user,
-            ident=identity['id'],
-            data=identity.get('data', {}),
-        )
+        try:
+            with transaction.atomic():
+                auth_identity = AuthIdentity.objects.create(
+                    auth_provider=auth_provider,
+                    user=user,
+                    ident=identity['id'],
+                    data=identity.get('data', {}),
+                )
+        except IntegrityError:
+            AuthIdentity.objects.get(
+                auth_provider=auth_provider,
+                ident=identity['id'],
+            ).update(
+                user=user,
+                data=identity.get('data', {}),
+            )
 
         self._handle_new_membership(auth_identity)
 
