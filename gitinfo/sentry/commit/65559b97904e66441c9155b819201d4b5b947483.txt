commit 65559b97904e66441c9155b819201d4b5b947483
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jan 23 17:17:14 2013 -0800

    Automatically set abs_path/filename for javascript frames

diff --git a/src/sentry/interfaces.py b/src/sentry/interfaces.py
index 8e016a9dc3..604286e1b0 100644
--- a/src/sentry/interfaces.py
+++ b/src/sentry/interfaces.py
@@ -302,6 +302,13 @@ class Stacktrace(Interface):
             if 'in_app' in frame:
                 frame['in_app'] = bool(frame['in_app'])
 
+            abs_path = frame.get('abs_path') or frame['filename']
+            if abs_path.startswith(('http:', 'https:')):
+                urlparts = urlparse.urlparse(abs_path)
+                if urlparts.path:
+                    frame['abs_path'] = abs_path
+                    frame['filename'] = urlparts.path
+
     def serialize(self):
         return {
             'frames': self.frames,
diff --git a/tests/sentry/interfaces/stacktrace/tests.py b/tests/sentry/interfaces/stacktrace/tests.py
index 0853fd28f2..cc2195f2ed 100644
--- a/tests/sentry/interfaces/stacktrace/tests.py
+++ b/tests/sentry/interfaces/stacktrace/tests.py
@@ -23,6 +23,33 @@ class StacktraceTest(TestCase):
             'filename': 'foo.py',
         }])
 
+    def test_coerces_url_filenames(self):
+        interface = Stacktrace(frames=[{
+            'lineno': 1,
+            'filename': 'http://foo.com/foo.js',
+        }])
+        frame = interface.frames[0]
+        assert frame['filename'] == '/foo.js'
+        assert frame['abs_path'] == 'http://foo.com/foo.js'
+
+    def test_coerces_url_abs_paths(self):
+        interface = Stacktrace(frames=[{
+            'lineno': 1,
+            'filename': 'foo.js',
+            'abs_path': 'http://foo.com/foo.js',
+        }])
+        frame = interface.frames[0]
+        assert frame['filename'] == '/foo.js'
+        assert frame['abs_path'] == 'http://foo.com/foo.js'
+
+    def test_ignores_results_with_empty_path(self):
+        interface = Stacktrace(frames=[{
+            'lineno': 1,
+            'filename': 'http://foo.com',
+        }])
+        frame = interface.frames[0]
+        assert frame['filename'] == 'http://foo.com'
+
     def test_serialize_returns_frames(self):
         interface = Stacktrace(frames=[{
             'lineno': 1,
