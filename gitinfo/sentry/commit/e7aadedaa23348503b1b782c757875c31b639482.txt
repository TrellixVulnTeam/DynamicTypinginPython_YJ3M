commit e7aadedaa23348503b1b782c757875c31b639482
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Wed Jan 29 12:25:43 2020 -0800

    build(webpack): Track webpack asset sizes (#16662)
    
    This is something maybe silly we (@ckj) wanted to simply track asset sizes over time. There's obviously a lot of limitations at play here but there's low costs involved imo. We may in the future add tracking build durations (for travis and local dev).

diff --git a/build-utils/sentry-instrumentation.js b/build-utils/sentry-instrumentation.js
new file mode 100644
index 0000000000..49417fe63b
--- /dev/null
+++ b/build-utils/sentry-instrumentation.js
@@ -0,0 +1,88 @@
+/*eslint-env node*/
+/*eslint import/no-nodejs-modules:0 */
+
+const IS_TRAVIS = process.env.TRAVIS_COMMIT;
+
+class SentryInstrumentation {
+  constructor() {
+    // Only run if SENTRY_INSTRUMENTATION` is set or when in travis, only in the javascript suite
+    if (process.env.SENTRY_INSTRUMENTATION || process.env.TEST_SUITE === 'js') {
+      this.Sentry = require('@sentry/node');
+      require('@sentry/apm');
+
+      this.Sentry.init({
+        dsn: 'https://3d282d186d924374800aa47006227ce9@sentry.io/2053674',
+        environment: process.env.TRAVIS_BRANCH ? 'travis' : 'local',
+      });
+    }
+  }
+
+  apply(compiler) {
+    compiler.hooks.done.tapAsync('SentryInstrumentation', async ({compilation}, done) => {
+      if (!this.Sentry) {
+        done();
+        return;
+      }
+
+      if (IS_TRAVIS) {
+        this.Sentry.setTag('travis_branch', process.env.TRAVIS_BRANCH);
+        this.Sentry.setTag('travis_commit', process.env.TRAVIS_COMMIT);
+      }
+
+      const hub = this.Sentry.getCurrentHub();
+
+      this.Sentry.setTag('webpack-hash', compilation.hash);
+
+      [...compilation.entrypoints].forEach(([entrypointName, entry]) =>
+        entry.chunks.forEach(chunk =>
+          chunk.files
+            .filter(assetName => !assetName.endsWith('.map'))
+            .forEach(assetName => {
+              const asset = compilation.assets[assetName];
+              const sizeInKb = asset.size() / 1024;
+
+              const transaction = hub.startSpan({
+                op: 'webpack-asset',
+                transaction: assetName,
+                description: `webpack bundle size for ${entrypointName} -> ${assetName}`,
+                data: {
+                  entrypointName,
+                  file: assetName,
+                  size: `${Math.round(sizeInKb)} KB`,
+                },
+                sampled: true,
+              });
+
+              const start = transaction.startTimestamp;
+
+              hub.configureScope(scope => scope.setSpan(transaction));
+
+              const span = this.Sentry.getCurrentHub().startSpan({
+                op: 'asset',
+                startTimestamp: start,
+                description: assetName,
+                data: {
+                  entrypointName,
+                  file: assetName,
+                  size: `${Math.round(sizeInKb)} KB`,
+                },
+                sampled: true,
+              });
+              span.startTimestamp = start;
+              span.finish();
+              span.timestamp = start + sizeInKb / 1000;
+              transaction.finish(true);
+            })
+        )
+      );
+
+      const client = this.Sentry.getCurrentHub().getClient();
+      if (client) {
+        await client.close();
+      }
+
+      done();
+    });
+  }
+}
+module.exports = SentryInstrumentation;
diff --git a/package.json b/package.json
index a8851907fb..5aa01066ea 100644
--- a/package.json
+++ b/package.json
@@ -126,6 +126,7 @@
   },
   "devDependencies": {
     "@babel/plugin-transform-react-jsx-source": "^7.2.0",
+    "@sentry/node": "^5.11.1",
     "@storybook/addon-a11y": "^5.3.3",
     "@storybook/addon-actions": "^5.3.3",
     "@storybook/addon-docs": "^5.3.3",
diff --git a/webpack.config.js b/webpack.config.js
index 76ab495b8d..9d5c0372b8 100644
--- a/webpack.config.js
+++ b/webpack.config.js
@@ -6,6 +6,7 @@ const fs = require('fs');
 const {CleanWebpackPlugin} = require('clean-webpack-plugin'); // installed via npm
 const webpack = require('webpack');
 const LastBuiltPlugin = require('./build-utils/last-built-plugin');
+const SentryInstrumentation = require('./build-utils/sentry-instrumentation');
 const OptionalLocaleChunkPlugin = require('./build-utils/optional-locale-chunk-plugin');
 const IntegrationDocsFetchPlugin = require('./build-utils/integration-docs-fetch-plugin');
 const ExtractTextPlugin = require('mini-css-extract-plugin');
@@ -317,6 +318,8 @@ let appConfig = {
      */
     new FixStyleOnlyEntriesPlugin(),
 
+    new SentryInstrumentation(),
+
     ...localeRestrictionPlugins,
   ],
   resolve: {
diff --git a/yarn.lock b/yarn.lock
index 21fd566e64..2d722b8eb7 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -1436,6 +1436,21 @@
     "@sentry/types" "5.11.0"
     tslib "^1.9.3"
 
+"@sentry/node@^5.11.1":
+  version "5.11.2"
+  resolved "https://registry.yarnpkg.com/@sentry/node/-/node-5.11.2.tgz#575c320b624c218d2155183f6bbe82b732bfb1f2"
+  integrity sha512-jYq9u76BdAbOKPuYg39Xh/+797MevzjMkCIC9cw/bQxAm6nHc3FXeKqd79O33jO4Jag0JL+Bz/0JidgrKgKgXg==
+  dependencies:
+    "@sentry/apm" "5.11.2"
+    "@sentry/core" "5.11.2"
+    "@sentry/hub" "5.11.2"
+    "@sentry/types" "5.11.0"
+    "@sentry/utils" "5.11.1"
+    cookie "^0.3.1"
+    https-proxy-agent "^4.0.0"
+    lru_map "^0.3.3"
+    tslib "^1.9.3"
+
 "@sentry/types@5.11.0":
   version "5.11.0"
   resolved "https://registry.yarnpkg.com/@sentry/types/-/types-5.11.0.tgz#40f0f3174362928e033ddd9725d55e7c5cb7c5b6"
@@ -2858,6 +2873,11 @@ address@1.1.2, address@^1.0.1:
   resolved "https://registry.yarnpkg.com/address/-/address-1.1.2.tgz#bf1116c9c758c51b7a933d296b72c221ed9428b6"
   integrity sha512-aT6camzM4xEA54YVJYSqxz1kv4IHnQZRtThJJHhUMRExaU5spC7jX5ugSwTaTgJliIgs4VhZOk7htClvQ/LmRA==
 
+agent-base@5:
+  version "5.1.1"
+  resolved "https://registry.yarnpkg.com/agent-base/-/agent-base-5.1.1.tgz#e8fb3f242959db44d63be665db7a8e739537a32c"
+  integrity sha512-TMeqbNl2fMW0nMjTEPOwe3J/PRFP4vqeoNuQMG0HlMrtm5QxKqdvAkZ1pRBQ/ulIyDD5Yq0nJ7YbdD8ey0TO3g==
+
 agentkeepalive@^2.2.0:
   version "2.2.0"
   resolved "https://registry.yarnpkg.com/agentkeepalive/-/agentkeepalive-2.2.0.tgz#c5d1bd4b129008f1163f236f86e5faea2026e2ef"
@@ -4719,6 +4739,11 @@ cookie@0.4.0:
   resolved "https://registry.yarnpkg.com/cookie/-/cookie-0.4.0.tgz#beb437e7022b3b6d49019d088665303ebe9c14ba"
   integrity sha512-+Hp8fLp57wnUSt0tY0tHEXh4voZRDnoIrZPqlo3DPiI4y9lwg/jqx+1Om94/W6ZaPDOUbnjOt/99w66zk+l1Xg==
 
+cookie@^0.3.1:
+  version "0.3.1"
+  resolved "https://registry.yarnpkg.com/cookie/-/cookie-0.3.1.tgz#e7e0a1f9ef43b4c8ba925c5c5a96e806d16873bb"
+  integrity sha1-5+Ch+e9DtMi6klxcWpboBtFoc7s=
+
 copy-concurrently@^1.0.0:
   version "1.0.5"
   resolved "https://registry.yarnpkg.com/copy-concurrently/-/copy-concurrently-1.0.5.tgz#92297398cae34937fcafd6ec8139c18051f0b5e0"
@@ -5170,6 +5195,13 @@ debug@2.6.9, debug@^2.2.0, debug@^2.3.3, debug@^2.6.0, debug@^2.6.8, debug@^2.6.
   dependencies:
     ms "2.0.0"
 
+debug@4, debug@^4.0.1, debug@^4.1.0, debug@^4.1.1:
+  version "4.1.1"
+  resolved "https://registry.yarnpkg.com/debug/-/debug-4.1.1.tgz#3b72260255109c6b589cee050f1d516139664791"
+  integrity sha512-pYAIzeRo8J6KPEaJ0VWOh5Pzkbw/RetuzehGM7QRRX5he4fPHx2rdKMB256ehJCkX+XRQm16eZLqLNS8RSZXZw==
+  dependencies:
+    ms "^2.1.1"
+
 debug@=3.1.0:
   version "3.1.0"
   resolved "https://registry.yarnpkg.com/debug/-/debug-3.1.0.tgz#5bb5a0672628b64149566ba16819e61518c67261"
@@ -5184,13 +5216,6 @@ debug@^3.0.0, debug@^3.0.1, debug@^3.1.1, debug@^3.2.5:
   dependencies:
     ms "^2.1.1"
 
-debug@^4.0.1, debug@^4.1.0, debug@^4.1.1:
-  version "4.1.1"
-  resolved "https://registry.yarnpkg.com/debug/-/debug-4.1.1.tgz#3b72260255109c6b589cee050f1d516139664791"
-  integrity sha512-pYAIzeRo8J6KPEaJ0VWOh5Pzkbw/RetuzehGM7QRRX5he4fPHx2rdKMB256ehJCkX+XRQm16eZLqLNS8RSZXZw==
-  dependencies:
-    ms "^2.1.1"
-
 decamelize-keys@^1.0.0:
   version "1.1.0"
   resolved "https://registry.yarnpkg.com/decamelize-keys/-/decamelize-keys-1.1.0.tgz#d171a87933252807eb3cb61dc1c1445d078df2d9"
@@ -7525,6 +7550,14 @@ https-browserify@^1.0.0:
   resolved "https://registry.yarnpkg.com/https-browserify/-/https-browserify-1.0.0.tgz#ec06c10e0a34c0f2faf199f7fd7fc78fffd03c73"
   integrity sha1-7AbBDgo0wPL68Zn3/X/Hj//QPHM=
 
+https-proxy-agent@^4.0.0:
+  version "4.0.0"
+  resolved "https://registry.yarnpkg.com/https-proxy-agent/-/https-proxy-agent-4.0.0.tgz#702b71fb5520a132a66de1f67541d9e62154d82b"
+  integrity sha512-zoDhWrkR3of1l9QAL8/scJZyLu8j/gBkcwcaQOZh7Gyh/+uJQzGVETdgT30akuwkpL8HTRfssqI3BZuV18teDg==
+  dependencies:
+    agent-base "5"
+    debug "4"
+
 iconv-lite@0.4.24, iconv-lite@^0.4.24, iconv-lite@~0.4.13:
   version "0.4.24"
   resolved "https://registry.yarnpkg.com/iconv-lite/-/iconv-lite-0.4.24.tgz#2022b4b25fbddc21d2f524974a474aafe733908b"
@@ -9303,6 +9336,11 @@ lru-cache@^5.1.1:
   dependencies:
     yallist "^3.0.2"
 
+lru_map@^0.3.3:
+  version "0.3.3"
+  resolved "https://registry.yarnpkg.com/lru_map/-/lru_map-0.3.3.tgz#b5c8351b9464cbd750335a79650a0ec0e56118dd"
+  integrity sha1-tcg1G5Rky9dQM1p5ZQoOwOVhGN0=
+
 make-dir@^2.0.0, make-dir@^2.1.0:
   version "2.1.0"
   resolved "https://registry.yarnpkg.com/make-dir/-/make-dir-2.1.0.tgz#5f0310e18b8be898cc07009295a30ae41e91e6f5"
