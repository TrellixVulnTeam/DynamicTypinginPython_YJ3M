commit bd440c4a450f965c542283e4e5e38cc6c22b7f48
Author: Dan Fuller <dfuller@sentry.io>
Date:   Thu Dec 13 16:51:00 2018 -0800

    fix(api): Fix bug in `OrganizationEndpoint.get_project_ids` when request.user is None
    
    Turns out that user can be `None` as well as `Anonymous` due to the way our `ApiClient` works, so guard against that.
    
    Fixes SENTRY-8QJ

diff --git a/src/sentry/api/bases/organization.py b/src/sentry/api/bases/organization.py
index 38c4e7ad34..582408504d 100644
--- a/src/sentry/api/bases/organization.py
+++ b/src/sentry/api/bases/organization.py
@@ -138,7 +138,8 @@ class OrganizationEndpoint(Endpoint):
         requested_projects = project_ids.copy()
 
         om_role = None
-        if request.user.is_authenticated():
+        user = getattr(request, 'user', None)
+        if user and user.is_authenticated():
             try:
                 om_role = OrganizationMember.objects.filter(
                     user=request.user,
@@ -148,7 +149,7 @@ class OrganizationEndpoint(Endpoint):
                 pass
 
         if (
-            request.user.is_superuser
+            user and user.is_superuser
             or (om_role and roles.get(om_role).is_global)
             or include_allow_joinleave and organization.flags.allow_joinleave
             or force_global_perms
@@ -161,7 +162,7 @@ class OrganizationEndpoint(Endpoint):
             qs = Project.objects.filter(
                 organization=organization,
                 teams__in=OrganizationMemberTeam.objects.filter(
-                    organizationmember__user=request.user,
+                    organizationmember__user=user,
                     organizationmember__organization=organization,
                 ).values_list('team'),
                 status=ProjectStatus.VISIBLE,
@@ -275,7 +276,10 @@ class OrganizationReleasesBaseEndpoint(OrganizationEndpoint):
             has_valid_api_key = request.auth.has_scope('project:releases') or \
                 request.auth.has_scope('project:write')
 
-        if not (has_valid_api_key or request.user.is_authenticated()):
+        if not (
+            has_valid_api_key
+            or getattr(request, 'user', None) and request.user.is_authenticated()
+        ):
             return []
 
         return super(OrganizationReleasesBaseEndpoint, self).get_project_ids(
diff --git a/tests/sentry/api/bases/test_organization.py b/tests/sentry/api/bases/test_organization.py
index 8448924a00..943b06f790 100644
--- a/tests/sentry/api/bases/test_organization.py
+++ b/tests/sentry/api/bases/test_organization.py
@@ -204,6 +204,15 @@ class GetProjectIdsTest(BaseOrganizationEndpointTest):
             project_ids=[self.project_1.id, self.project_2.id],
         )
 
+    def test_none_user(self):
+        request = RequestFactory().get('/')
+        result = self.endpoint.get_project_ids(request, self.org)
+        assert [] == result
+
+        request.user = None
+        result = self.endpoint.get_project_ids(request, self.org)
+        assert [] == result
+
 
 class GetEnvironmentsTest(BaseOrganizationEndpointTest):
     def setUp(self):
