commit 4704856b2e0d8c5aaedd8544ba685b07c2cd2793
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Thu Feb 25 12:43:33 2016 -0800

    Make sure we send proper upstream headers
    
    Use Transfer-Encoding: chunked when streaming, and Content-Length
    otherwise
    
    Fixes GH-2755

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index a29f27217a..5490278e53 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -197,6 +197,7 @@ TEMPLATE_LOADERS = (
 )
 
 MIDDLEWARE_CLASSES = (
+    'sentry.middleware.proxy.ContentLengthHeaderMiddleware',
     'sentry.middleware.maintenance.ServicesUnavailableMiddleware',
     'sentry.middleware.env.SentryEnvMiddleware',
     'sentry.middleware.proxy.SetRemoteAddrFromForwardedFor',
diff --git a/src/sentry/middleware/proxy.py b/src/sentry/middleware/proxy.py
index 59e2c3d7b7..080eecfa1d 100644
--- a/src/sentry/middleware/proxy.py
+++ b/src/sentry/middleware/proxy.py
@@ -12,3 +12,16 @@ class SetRemoteAddrFromForwardedFor(object):
             # Take just the first one.
             real_ip = real_ip.split(",")[0]
             request.META['REMOTE_ADDR'] = real_ip
+
+
+class ContentLengthHeaderMiddleware(object):
+    """
+    Ensure that we have a proper Content-Length/Transfer-Encoding header
+    """
+
+    def process_response(self, request, response):
+        if response.streaming:
+            response['Transfer-Encoding'] = 'chunked'
+        else:
+            response['Content-Length'] = str(len(response.content))
+        return response
