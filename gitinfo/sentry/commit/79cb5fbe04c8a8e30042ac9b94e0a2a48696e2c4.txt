commit 79cb5fbe04c8a8e30042ac9b94e0a2a48696e2c4
Author: Chris Fuller <cfuller@sentry.io>
Date:   Fri Feb 28 15:58:19 2020 -0500

    fix(workflow): Updating slack alert time window to be more accurate (i.e. correct?) (#17375)
    
    * Updating slack alert time window

diff --git a/src/sentry/incidents/logic.py b/src/sentry/incidents/logic.py
index 275a657573..d47f1e44e9 100644
--- a/src/sentry/incidents/logic.py
+++ b/src/sentry/incidents/logic.py
@@ -366,13 +366,13 @@ def get_alert_rule_environment_names(alert_rule):
     return [x.environment.name for x in AlertRuleEnvironment.objects.filter(alert_rule=alert_rule)]
 
 
-def get_incident_aggregates(incident):
+def get_incident_aggregates(incident, start=None, end=None, prewindow=False):
     """
-    Calculates aggregate stats across the life of an incident.
+    Calculates aggregate stats across the life of an incident, or the provided range.
     - count: Total count of events
     - unique_users: Total number of unique users
     """
-    query_params = build_incident_query_params(incident)
+    query_params = build_incident_query_params(incident, start, end, prewindow)
     return bulk_get_incident_aggregates([query_params])[0]
 
 
diff --git a/src/sentry/integrations/slack/utils.py b/src/sentry/integrations/slack/utils.py
index b56a34994a..4a8499cda2 100644
--- a/src/sentry/integrations/slack/utils.py
+++ b/src/sentry/integrations/slack/utils.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 import logging
 import time
+from datetime import timedelta
 
 from django.core.cache import cache
 from django.core.urlresolvers import reverse
@@ -10,7 +11,7 @@ from sentry import http
 from sentry import tagstore
 from sentry.api.fields.actor import Actor
 from sentry.incidents.logic import get_incident_aggregates
-from sentry.incidents.models import IncidentStatus
+from sentry.incidents.models import IncidentStatus, IncidentTrigger
 from sentry.snuba.models import QueryAggregations
 from sentry.utils import metrics, json
 from sentry.utils.assets import get_asset_url
@@ -293,7 +294,21 @@ def build_group_attachment(group, event=None, tags=None, identity=None, actions=
 def build_incident_attachment(incident):
     logo_url = absolute_uri(get_asset_url("sentry", "images/sentry-email-avatar.png"))
     alert_rule = incident.alert_rule
-    aggregates = get_incident_aggregates(incident)
+
+    incident_trigger = (
+        IncidentTrigger.objects.filter(incident=incident).order_by("-date_modified").first()
+    )
+    if incident_trigger:
+        alert_rule_trigger = incident_trigger.alert_rule_trigger
+        # TODO: If we're relying on this and expecting possible delays between a trigger fired and this function running,
+        # then this could actually be incorrect if they changed the trigger's time window in this time period. Should we store it?
+        start = incident_trigger.date_modified - timedelta(
+            minutes=alert_rule_trigger.alert_rule.time_window
+        )
+        end = incident_trigger.date_modified
+    else:
+        start, end = None, None
+    aggregates = get_incident_aggregates(incident, start, end)
 
     if incident.status == IncidentStatus.CLOSED.value:
         status = "Resolved"
@@ -317,7 +332,7 @@ def build_incident_attachment(incident):
     text = "{} {} in the last {} minutes".format(agg_value, agg_text, time_window)
 
     if alert_rule.query != "":
-        text = text + "\Filter: {}".format(alert_rule.query)
+        text = text + "\nFilter: {}".format(alert_rule.query)
 
     ts = incident.date_started
 
diff --git a/tests/sentry/integrations/slack/test_utils.py b/tests/sentry/integrations/slack/test_utils.py
index 9e31347da2..094fafeae3 100644
--- a/tests/sentry/integrations/slack/test_utils.py
+++ b/tests/sentry/integrations/slack/test_utils.py
@@ -95,7 +95,7 @@ class BuildIncidentAttachmentTest(TestCase):
                     },
                 )
             ),
-            "text": "0 events in the last 10 minutes\\Filter: level:error",
+            "text": "0 events in the last 10 minutes\nFilter: level:error",
             "fields": [],
             "mrkdwn_in": ["text"],
             "footer_icon": logo_url,
