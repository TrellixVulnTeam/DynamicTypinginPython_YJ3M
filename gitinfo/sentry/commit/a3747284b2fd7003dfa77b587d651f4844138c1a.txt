commit a3747284b2fd7003dfa77b587d651f4844138c1a
Author: Dan Fuller <dfuller@sentry.io>
Date:   Tue Jun 4 16:46:58 2019 -0700

    fix(api): Fix unsubscribe link in incident emails
    
    Currently this unsubscribes the creator of the activity from the incident, rather than the email
    recipient.

diff --git a/src/sentry/incidents/tasks.py b/src/sentry/incidents/tasks.py
index 844e0d031c..d3f92b8d20 100644
--- a/src/sentry/incidents/tasks.py
+++ b/src/sentry/incidents/tasks.py
@@ -44,32 +44,28 @@ def send_subscriber_notifications(activity_id):
     # Check that the user still has access to at least one of the projects
     # related to the incident. If not then unsubscribe them.
     projects = list(activity.incident.projects.all())
-    emails = []
     for subscriber in get_incident_subscribers(activity.incident).select_related('user'):
         user = subscriber.user
         access = from_user(user, activity.incident.organization)
         if not any(project for project in projects if access.has_project_access(project)):
             unsubscribe_from_incident(activity.incident, user)
         elif user != activity.user:
-            emails.append(user.email)
+            msg = generate_incident_activity_email(activity, user)
+            msg.send_async([user.email])
 
-    if emails:
-        msg = generate_incident_activity_email(activity)
-        msg.send_async(emails)
 
-
-def generate_incident_activity_email(activity):
+def generate_incident_activity_email(activity, user):
     incident = activity.incident
     return MessageBuilder(
         subject=u'Activity on Incident {} (#{})'.format(incident.title, incident.identifier),
         template=u'sentry/emails/incidents/activity.txt',
         html_template=u'sentry/emails/incidents/activity.html',
         type='incident.activity',
-        context=build_activity_context(activity),
+        context=build_activity_context(activity, user),
     )
 
 
-def build_activity_context(activity):
+def build_activity_context(activity, user):
     if activity.type == IncidentActivityType.COMMENT.value:
         action = 'left a comment'
     else:
@@ -93,7 +89,7 @@ def build_activity_context(activity):
         )),
         'comment': activity.comment,
         'unsubscribe_link': generate_signed_link(
-            activity.user,
+            user,
             'sentry-account-email-unsubscribe-incident',
             kwargs={'incident_id': incident.id},
         ),
diff --git a/tests/sentry/incidents/test_tasks.py b/tests/sentry/incidents/test_tasks.py
index 71831ecc72..302fc68b0f 100644
--- a/tests/sentry/incidents/test_tasks.py
+++ b/tests/sentry/incidents/test_tasks.py
@@ -80,13 +80,14 @@ class TestGenerateIncidentActivityEmail(BaseIncidentActivityTest, TestCase):
             comment='hello',
         )
         incident = activity.incident
-        message = generate_incident_activity_email(activity)
+        recipient = self.create_user()
+        message = generate_incident_activity_email(activity, recipient)
         assert message.subject == 'Activity on Incident {} (#{})'.format(
             incident.title,
             incident.identifier,
         )
         assert message.type == 'incident.activity'
-        assert message.context == build_activity_context(activity)
+        assert message.context == build_activity_context(activity, recipient)
 
 
 class TestBuildActivityContext(BaseIncidentActivityTest, TestCase):
@@ -96,9 +97,10 @@ class TestBuildActivityContext(BaseIncidentActivityTest, TestCase):
         expected_username,
         expected_action,
         expected_comment,
+        expected_recipient,
     ):
         incident = activity.incident
-        context = build_activity_context(activity)
+        context = build_activity_context(activity, expected_recipient)
         assert context['user_name'] == expected_username
         assert context['action'] == '%s on incident %s (#%s)' % (
             expected_action,
@@ -114,7 +116,7 @@ class TestBuildActivityContext(BaseIncidentActivityTest, TestCase):
         ))
         assert context['comment'] == expected_comment
         assert context['unsubscribe_link'] == generate_signed_link(
-            activity.user,
+            expected_recipient,
             'sentry-account-email-unsubscribe-incident',
             kwargs={'incident_id': incident.id},
         )
@@ -126,11 +128,13 @@ class TestBuildActivityContext(BaseIncidentActivityTest, TestCase):
             user=self.user,
             comment='hello',
         )
+        recepient = self.create_user()
         self.run_test(
             activity,
             expected_username=activity.user.name,
             expected_action='left a comment',
             expected_comment=activity.comment,
+            expected_recipient=recepient,
         )
         activity.type = IncidentActivityType.STATUS_CHANGE
         activity.value = six.text_type(IncidentStatus.CLOSED.value)
@@ -143,4 +147,5 @@ class TestBuildActivityContext(BaseIncidentActivityTest, TestCase):
                 IncidentStatus.CLOSED.name.lower(),
             ),
             expected_comment=activity.comment,
+            expected_recipient=recepient,
         )
