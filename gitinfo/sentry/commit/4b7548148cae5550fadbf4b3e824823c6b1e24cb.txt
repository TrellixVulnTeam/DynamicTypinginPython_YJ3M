commit 4b7548148cae5550fadbf4b3e824823c6b1e24cb
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Aug 27 13:25:23 2015 -0700

    Correctly support multiple captchas

diff --git a/src/sentry/templates/sentry/includes/captcha.html b/src/sentry/templates/sentry/includes/captcha.html
new file mode 100644
index 0000000000..fb3ad84671
--- /dev/null
+++ b/src/sentry/templates/sentry/includes/captcha.html
@@ -0,0 +1,23 @@
+{% if api_key %}
+<script>
+  (function(window){
+    var captchaNodes = $('.g-recaptcha');
+    if (captchaNodes.length) {
+      window.recaptchaCallback = function(){
+        var sitekey = '{{ api_key }}';
+        captchaNodes.each(function(){
+          grecaptcha.render(this, {
+            'sitekey': sitekey
+          });
+        });
+      };
+      var sNew = document.createElement("script");
+      sNew.async = true;
+      sNew.defer = true;
+      sNew.src = "https://www.google.com/recaptcha/api.js?onload=recaptchaCallback&render=explicit";
+      var s0 = document.getElementsByTagName('script')[0];
+      s0.parentNode.insertBefore(sNew, s0);
+    }
+  }(window));
+</script>
+{% endif %}
diff --git a/src/sentry/templates/sentry/layout.html b/src/sentry/templates/sentry/layout.html
index 95fd7040ca..dbe2301843 100644
--- a/src/sentry/templates/sentry/layout.html
+++ b/src/sentry/templates/sentry/layout.html
@@ -415,6 +415,9 @@
   });
   </script>
   {% endblock %}
+
+  {% load_captcha %}
+
   {% block scripts_bottom %}{% endblock %}
 </body>
 </html>
diff --git a/src/sentry/templates/sentry/partial/form_captcha.html b/src/sentry/templates/sentry/partial/form_captcha.html
index 98d7d9acfd..170d812b34 100644
--- a/src/sentry/templates/sentry/partial/form_captcha.html
+++ b/src/sentry/templates/sentry/partial/form_captcha.html
@@ -1,2 +1 @@
-<div class="g-recaptcha" data-sitekey="{{ public_key }}"></div>
-<script src="https://www.google.com/recaptcha/api.js" async defer></script>
+<div class="g-recaptcha"></div>
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index d9effda3ad..2ec97d78ca 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -407,3 +407,10 @@ def format_userinfo(user):
         escape(user.username),
         escape(username),
     ))
+
+
+@register.inclusion_tag('sentry/includes/captcha.html')
+def load_captcha():
+    return {
+        'api_key': settings.RECAPTCHA_PUBLIC_KEY,
+    }
