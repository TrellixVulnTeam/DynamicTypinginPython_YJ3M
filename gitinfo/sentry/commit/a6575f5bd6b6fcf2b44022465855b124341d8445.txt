commit a6575f5bd6b6fcf2b44022465855b124341d8445
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Tue Jun 25 10:57:38 2019 -0700

    feat(events-v2): Support project.name in event search (#13781)

diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index c37246fff0..9a9b05f11d 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -19,6 +19,7 @@ from sentry.search.utils import (
 )
 from sentry.utils.dates import to_timestamp
 from sentry.utils.snuba import SENTRY_SNUBA_MAP
+from sentry.models import Project
 
 WILDCARD_CHARS = re.compile(r'[\*]')
 
@@ -147,6 +148,8 @@ SEARCH_MAP = dict({
 }, **SENTRY_SNUBA_MAP)
 no_conversion = set(['project_id', 'start', 'end'])
 
+PROJECT_KEY = 'project.name'
+
 
 class InvalidSearchQuery(Exception):
     pass
@@ -624,11 +627,27 @@ def get_snuba_query_args(query=None, params=None):
         'filter_keys': defaultdict(list),
     }
 
+    projects = {}
+    has_project_term = any(
+        isinstance(term, SearchFilter) and term.key.name == PROJECT_KEY
+        for term
+        in parsed_terms
+    )
+    if has_project_term:
+        projects = {
+            p['slug']: p['id'] for p in Project.objects.filter(
+                id__in=params['project_id'],
+            ).values('id', 'slug')
+        }
+
     for term in parsed_terms:
         if isinstance(term, SearchFilter):
             snuba_name = term.key.snuba_name
+            if term.key.name == PROJECT_KEY:
+                condition = ['project_id', '=', projects.get(term.value.value)]
+                kwargs['conditions'].append(condition)
 
-            if snuba_name in ('start', 'end'):
+            elif snuba_name in ('start', 'end'):
                 kwargs[snuba_name] = term.value.value
             elif snuba_name in ('project_id', 'issue'):
                 value = term.value.value
diff --git a/tests/sentry/api/test_event_search.py b/tests/sentry/api/test_event_search.py
index 784105d95d..189c1ee0b7 100644
--- a/tests/sentry/api/test_event_search.py
+++ b/tests/sentry/api/test_event_search.py
@@ -1148,6 +1148,20 @@ class GetSnubaQueryArgsTest(TestCase):
             },
         }
 
+    def test_project_name(self):
+        p1 = self.create_project(organization=self.organization)
+        p2 = self.create_project(organization=self.organization)
+
+        params = {
+            'project_id': [p1.id, p2.id],
+        }
+        assert get_snuba_query_args('project.name:{}'.format(p1.slug), params) == {
+            'conditions': [['project_id', '=', p1.id]],
+            'filter_keys': {
+                'project_id': [p1.id, p2.id],
+            }
+        }
+
 
 class ConvertEndpointParamsTests(TestCase):
     def test_simple(self):
