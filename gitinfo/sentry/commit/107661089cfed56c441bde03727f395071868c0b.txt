commit 107661089cfed56c441bde03727f395071868c0b
Author: Ted Kaemming <ted@kaemming.com>
Date:   Wed Feb 17 18:23:58 2016 -0800

    Assert that cache is set before allowing mutation operations.

diff --git a/src/sentry/options/store.py b/src/sentry/options/store.py
index 90994cb801..132e7242ea 100644
--- a/src/sentry/options/store.py
+++ b/src/sentry/options/store.py
@@ -188,6 +188,8 @@ class OptionsStore(object):
         If cache fails, we ignore silently since it'll get repaired later by sync_options.
         A boolean is returned to indicate if the network cache was set successfully.
         """
+        assert self.cache is not None, 'cache must be configured before mutating options'
+
         self.set_store(key, value)
         return self.set_cache(key, value)
 
@@ -207,9 +209,6 @@ class OptionsStore(object):
         if key.ttl > 0:
             self._local_cache[cache_key] = _make_cache_value(key, value)
 
-        if self.cache is None:
-            return
-
         try:
             self.cache.set(cache_key, value, self.ttl)
             return True
@@ -224,6 +223,8 @@ class OptionsStore(object):
         If database succeeds, caches are then allowed to fail silently.
         A boolean is returned to indicate if the network deletion succeeds.
         """
+        assert self.cache is not None, 'cache must be configured before mutating options'
+
         self.delete_store(key)
         return self.delete_cache(key)
 
@@ -237,9 +238,6 @@ class OptionsStore(object):
         except KeyError:
             pass
 
-        if self.cache is None:
-            return
-
         try:
             self.cache.delete(cache_key)
             return True
diff --git a/tests/sentry/options/test_store.py b/tests/sentry/options/test_store.py
index d4b8100c33..ce5f41c21e 100644
--- a/tests/sentry/options/test_store.py
+++ b/tests/sentry/options/test_store.py
@@ -3,7 +3,9 @@
 from __future__ import absolute_import
 
 from uuid import uuid1
-from exam import fixture, before
+
+import pytest
+from exam import before, fixture
 from mock import patch
 
 from sentry.cache.redis import RedisCache
@@ -41,9 +43,12 @@ class OptionsStoreTest(TestCase):
         key = self.key
 
         assert store.get(key) is None
-        assert store.set(key, 'bar') is None
-        assert store.get(key) == 'bar'
-        assert store.delete(key) is None
+
+        with pytest.raises(AssertionError):
+            store.set(key, 'bar')
+
+        with pytest.raises(AssertionError):
+            store.delete(key)
 
     def test_db_and_cache_unavailable(self):
         store, key = self.store, self.key
