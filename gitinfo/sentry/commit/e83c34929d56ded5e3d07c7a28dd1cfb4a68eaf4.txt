commit e83c34929d56ded5e3d07c7a28dd1cfb4a68eaf4
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Thu Oct 24 10:27:27 2019 -0700

    feat: Pass type != transaction condition where we don't want transactions (#15254)
    
    This is an alternative to https://github.com/getsentry/sentry/pull/15118
    which added a dataset argument (defaulting to Events) on an eventstore
    query. Here we are forcing the correct dataset decision by adding a
    condition "type != transaction" anywhere we do not want to look at
    transactions (everything except Discover 2).

diff --git a/src/sentry/api/endpoints/project_event_details.py b/src/sentry/api/endpoints/project_event_details.py
index e03d1854ec..74307b292f 100644
--- a/src/sentry/api/endpoints/project_event_details.py
+++ b/src/sentry/api/endpoints/project_event_details.py
@@ -55,7 +55,7 @@ class ProjectEventDetailsEndpoint(ProjectEndpoint):
 
         if event.group_id:
             requested_environments = set(request.GET.getlist("environment"))
-            conditions = []
+            conditions = [["type", "!=", "transaction"]]
 
             if requested_environments:
                 conditions.append(["environment", "IN", requested_environments])
diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index 380e340fd9..f79d0da2c6 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -389,6 +389,13 @@ def detect_dataset(query_args, aliased_conditions=False):
         ]:
             return Dataset.Transactions
 
+        if condition == ["event.type", "!=", "transaction"] or condition == [
+            "type",
+            "!=",
+            "transaction",
+        ]:
+            return Dataset.Events
+
     for field in query_args.get("selected_columns") or []:
         if isinstance(field, six.string_types) and field in transaction_fields:
             return Dataset.Transactions
diff --git a/tests/sentry/utils/test_snuba.py b/tests/sentry/utils/test_snuba.py
index fe8d1152f5..6a7f68f04e 100644
--- a/tests/sentry/utils/test_snuba.py
+++ b/tests/sentry/utils/test_snuba.py
@@ -546,6 +546,9 @@ class DetectDatasetTest(TestCase):
         query = {"conditions": [["type", "=", "error"]]}
         assert detect_dataset(query) == Dataset.Events
 
+        query = {"conditions": [["type", "!=", "transactions"]]}
+        assert detect_dataset(query) == Dataset.Events
+
     def test_conditions(self):
         query = {"conditions": [["transaction", "=", "api.do_thing"]]}
         assert detect_dataset(query) == Dataset.Events
