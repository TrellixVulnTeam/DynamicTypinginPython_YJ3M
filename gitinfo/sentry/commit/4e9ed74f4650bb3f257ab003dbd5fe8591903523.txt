commit 4e9ed74f4650bb3f257ab003dbd5fe8591903523
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jan 20 17:05:15 2013 -0800

    Support pulling down source code for any frame thats missing context

diff --git a/src/sentry/tasks/fetch_source.py b/src/sentry/tasks/fetch_source.py
index 79e32498e1..fb5f2b44ff 100644
--- a/src/sentry/tasks/fetch_source.py
+++ b/src/sentry/tasks/fetch_source.py
@@ -134,17 +134,22 @@ def fetch_javascript_source(event, **kwargs):
     # build list of frames that we can actually grab source for
     frames = [f for f in stacktrace['frames']
         if f.get('lineno') is not None
-            and f.get('colno') is not None
-            # and f.get('context_line') is None
+            and f.get('context_line') is None
             and f.get('abs_path', '').startswith(('http://', 'https://'))]
     if not frames:
         logger.debug('Event %r has no frames with enough context to fetch remote source', event.id)
         return
 
-    file_list = set((f['abs_path'] for f in frames))
+    file_list = set()
+    sourcemap_capable = set()
     source_code = {}
     sourcemaps = {}
 
+    for f in frames:
+        file_list.add(f['abs_path'])
+        if f.get('colno') is not None:
+            sourcemap_capable.add(f['abs_path'])
+
     while file_list:
         filename = file_list.pop()
 
@@ -155,6 +160,11 @@ def fetch_javascript_source(event, **kwargs):
         if result == BAD_SOURCE:
             continue
 
+        # If we didn't have a colno, a sourcemap wont do us any good
+        if filename not in sourcemap_capable:
+            source_code[filename] = (result.body.splitlines(), None)
+            continue
+
         # TODO: we're currently running splitlines twice
         sourcemap = discover_sourcemap(result, logger=logger)
         source_code[filename] = (result.body.splitlines(), sourcemap)
@@ -182,7 +192,7 @@ def fetch_javascript_source(event, **kwargs):
             # we must've failed pulling down the source
             continue
 
-        if sourcemap:
+        if frame.get('colno') and sourcemap:
             state = find_source(sourcemaps[sourcemap], frame['lineno'], frame['colno'])
             # TODO: is this urljoin right? (is it relative to the sourcemap or the originating file)
             abs_path = urljoin(sourcemap, state.src)
