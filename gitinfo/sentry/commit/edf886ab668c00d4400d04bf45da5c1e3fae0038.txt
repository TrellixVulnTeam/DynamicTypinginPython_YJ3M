commit edf886ab668c00d4400d04bf45da5c1e3fae0038
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Fri May 13 10:32:14 2016 +0200

    Added frontend code for 2FA configuration

diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index f8f546dbc4..89dd4d6830 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -20,7 +20,8 @@ from django.utils import timezone
 from sudo.decorators import sudo_required
 
 from sentry.models import (
-    LostPasswordHash, Project, ProjectStatus, UserOption
+    LostPasswordHash, Project, ProjectStatus, UserOption, Authenticator,
+    AUTHENTICATOR_INTERFACES
 )
 from sentry.plugins import plugins
 from sentry.web.decorators import login_required
@@ -132,11 +133,38 @@ def settings(request):
     context.update({
         'form': form,
         'page': 'settings',
+        'has_2fa': Authenticator.objects.user_has_2fa(request.user),
         'AUTH_PROVIDERS': get_auth_providers(),
     })
     return render_to_response('sentry/account/settings.html', context, request)
 
 
+@csrf_protect
+@never_cache
+@login_required
+@sudo_required
+@transaction.atomic
+def twofactor_settings(request):
+    missing_authenticators = AUTHENTICATOR_INTERFACES.copy()
+    active_authenticators = Authenticator.objects.get_for_user(request.user)
+    for auth in active_authenticators:
+        missing_authenticators.pop(auth.interface_id, None)
+    missing_authenticators = [{
+        'interface_id': x.interface_id,
+        'name': x.name,
+    } for x in sorted(missing_authenticators.values(),
+                      key=lambda x: (x.type == 0, x.type))]
+
+    context = csrf(request)
+    context.update({
+        'page': 'settings',
+        'has_2fa': len(active_authenticators) > 0,
+        'active_authenticators': active_authenticators,
+        'missing_authenticators': missing_authenticators,
+    })
+    return render_to_response('sentry/account/twofactor.html', context, request)
+
+
 @csrf_protect
 @never_cache
 @login_required
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index a333e15a78..f86af7658c 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -183,6 +183,8 @@ urlpatterns += patterns(
         name='sentry-account-recover-confirm'),
     url(r'^account/settings/$', accounts.settings,
         name='sentry-account-settings'),
+    url(r'^account/settings/2fa/$', accounts.twofactor_settings,
+        name='sentry-account-settings-2fa'),
     url(r'^account/settings/avatar/$', accounts.avatar_settings,
         name='sentry-account-settings-avatar'),
     url(r'^account/settings/appearance/$', accounts.appearance_settings,
