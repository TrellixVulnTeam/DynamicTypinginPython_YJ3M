commit fd35ab733f45655701ef03b39895c9c8be1cb377
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Apr 23 16:38:05 2015 -0700

    Revert "Revert "redis buffer: use atomic set + expire""
    
    This reverts commit 14315e7a5de0d28021ace90baadeeabe44a34ebc.

diff --git a/src/sentry/buffer/redis.py b/src/sentry/buffer/redis.py
index b821b5f379..86888af166 100644
--- a/src/sentry/buffer/redis.py
+++ b/src/sentry/buffer/redis.py
@@ -89,9 +89,8 @@ class RedisBuffer(Buffer):
     def process_pending(self):
         lock_key = self._make_lock_key(self.pending_key)
         # prevent a stampede due to celerybeat + periodic task
-        if not self.conn.setnx(lock_key, '1'):
+        if not self.conn.set(lock_key, '1', nx=True, ex=60):
             return
-        self.conn.expire(lock_key, 60)
 
         try:
             for conn in self.conn.hosts.itervalues():
@@ -112,9 +111,8 @@ class RedisBuffer(Buffer):
         lock_key = self._make_lock_key(key)
         # prevent a stampede due to the way we use celery etas + duplicate
         # tasks
-        if not self.conn.setnx(lock_key, '1'):
+        if not self.conn.set(lock_key, '1', nx=True, ex=10):
             return
-        self.conn.expire(lock_key, 10)
 
         with self.conn.map() as conn:
             values = conn.hgetall(key)
