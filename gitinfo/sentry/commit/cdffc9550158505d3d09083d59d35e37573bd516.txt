commit cdffc9550158505d3d09083d59d35e37573bd516
Author: Lauryn Brown <lauryndbrown@gmail.com>
Date:   Wed May 8 11:11:27 2019 -0700

    ref(snuba): Change snuba functions in aggregate_defs (#13115)
    
    * changed topK(#) to top# instead
    
    * Changed aggregation_defs to use only functions
    
    * Removed changes to topK from this pr.

diff --git a/src/sentry/search/snuba/backend.py b/src/sentry/search/snuba/backend.py
index 1e071288ea..2f6a2e200d 100644
--- a/src/sentry/search/snuba/backend.py
+++ b/src/sentry/search/snuba/backend.py
@@ -43,10 +43,10 @@ dependency_aggregations = {
 
 aggregation_defs = {
     'times_seen': ['count()', ''],
-    'first_seen': ['toUInt64(min(timestamp)) * 1000', ''],
-    'last_seen': ['toUInt64(max(timestamp)) * 1000', ''],
+    'first_seen': ['multiply(toUInt64(min(timestamp)), 1000)', ''],
+    'last_seen': ['multiply(toUInt64(max(timestamp)), 1000)', ''],
     # https://github.com/getsentry/sentry/blob/804c85100d0003cfdda91701911f21ed5f66f67c/src/sentry/event_manager.py#L241-L271
-    'priority': ['(toUInt64(log(times_seen) * 600)) + last_seen', ''],
+    'priority': ['toUInt64(plus(multiply(log(times_seen), 600), last_seen))', ''],
     # Only makes sense with WITH TOTALS, returns 1 for an individual group.
     'total': ['uniq', 'issue'],
 }
diff --git a/tests/snuba/search/test_backend.py b/tests/snuba/search/test_backend.py
index 1cb64e9426..518967cd0e 100644
--- a/tests/snuba/search/test_backend.py
+++ b/tests/snuba/search/test_backend.py
@@ -327,7 +327,6 @@ class SnubaSearchTest(TestCase, SnubaTestCase):
             sort_by='date',
         )
         assert list(results) == [self.group2, self.group1]
-
         results = self.make_query(
             environments=[self.environments['production']],
             sort_by='new',
@@ -1024,7 +1023,7 @@ class SnubaSearchTest(TestCase, SnubaTestCase):
             orderby=['-last_seen', 'issue'],
             aggregations=[
                 ['uniq', 'issue', 'total'],
-                ['toUInt64(max(timestamp)) * 1000', '', 'last_seen']
+                ['multiply(toUInt64(max(timestamp)), 1000)', '', 'last_seen']
             ],
             having=[['last_seen', '>=', Any(int)]],
             **common_args
@@ -1037,10 +1036,10 @@ class SnubaSearchTest(TestCase, SnubaTestCase):
         assert query_mock.call_args == mock.call(
             orderby=['-priority', 'issue'],
             aggregations=[
-                ['(toUInt64(log(times_seen) * 600)) + last_seen', '', 'priority'],
+                ['toUInt64(plus(multiply(log(times_seen), 600), last_seen))', '', 'priority'],
                 ['count()', '', 'times_seen'],
                 ['uniq', 'issue', 'total'],
-                ['toUInt64(max(timestamp)) * 1000', '', 'last_seen']
+                ['multiply(toUInt64(max(timestamp)), 1000)', '', 'last_seen']
             ],
             having=[],
             **common_args
