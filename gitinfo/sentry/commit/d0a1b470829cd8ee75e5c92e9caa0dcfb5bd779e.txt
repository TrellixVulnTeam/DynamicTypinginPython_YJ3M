commit d0a1b470829cd8ee75e5c92e9caa0dcfb5bd779e
Author: Stephen Cefali <scefali@sentry.io>
Date:   Wed Sep 18 12:38:51 2019 -0700

    feat(app-platform): prevent duplicate installs (#14755)

diff --git a/src/sentry/api/endpoints/sentry_app_installations.py b/src/sentry/api/endpoints/sentry_app_installations.py
index d63470cc47..4b2f6c0bb0 100644
--- a/src/sentry/api/endpoints/sentry_app_installations.py
+++ b/src/sentry/api/endpoints/sentry_app_installations.py
@@ -49,11 +49,15 @@ class SentryAppInstallationsEndpoint(SentryAppInstallationsBaseEndpoint):
         if not serializer.is_valid():
             return Response(serializer.errors, status=400)
 
-        install = Creator.run(
-            organization=organization,
-            slug=serializer.validated_data.get("slug"),
-            user=request.user,
-            request=request,
-        )
+        # check for an exiting installation and return that if it exists
+        slug = serializer.validated_data.get("slug")
+        try:
+            install = SentryAppInstallation.objects.get(
+                sentry_app__slug=slug, organization=organization
+            )
+        except SentryAppInstallation.DoesNotExist:
+            install = Creator.run(
+                organization=organization, slug=slug, user=request.user, request=request
+            )
 
         return Response(serialize(install))
diff --git a/tests/sentry/api/endpoints/test_organization_sentry_app_installations.py b/tests/sentry/api/endpoints/test_organization_sentry_app_installations.py
index 6d0b3537b9..966fa58bab 100644
--- a/tests/sentry/api/endpoints/test_organization_sentry_app_installations.py
+++ b/tests/sentry/api/endpoints/test_organization_sentry_app_installations.py
@@ -5,6 +5,7 @@ import six
 from django.core.urlresolvers import reverse
 
 from sentry.testutils import APITestCase
+from sentry.models import SentryAppInstallation
 
 
 class SentryAppInstallationsTest(APITestCase):
@@ -115,3 +116,11 @@ class PostSentryAppInstallationsTest(SentryAppInstallationsTest):
         app = self.create_sentry_app(name="Sample", organization=self.org, published=True)
         response = self.client.post(self.url, data={"slug": app.slug}, format="json")
         assert response.status_code == 403
+
+    def test_install_twice(self):
+        self.login_as(user=self.user)
+        app = self.create_sentry_app(name="Sample", organization=self.org)
+        self.client.post(self.url, data={"slug": app.slug}, format="json")
+        response = self.client.post(self.url, data={"slug": app.slug}, format="json")
+        assert SentryAppInstallation.objects.filter(sentry_app=app).count() == 1
+        assert response.status_code == 200
