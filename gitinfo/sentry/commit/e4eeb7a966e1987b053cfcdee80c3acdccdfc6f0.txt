commit e4eeb7a966e1987b053cfcdee80c3acdccdfc6f0
Author: Mark Story <mark@sentry.io>
Date:   Wed Oct 3 12:09:04 2018 -0400

    fix(api) Don't 500 when auth verify gets no password
    
    Make the password a required field if we 500 when it is not present.
    The password is required when a u2f challenge/response is not present.
    
    Fixes APP-555

diff --git a/src/sentry/api/validators/auth.py b/src/sentry/api/validators/auth.py
index 54489c66ab..1f8b8df3c1 100644
--- a/src/sentry/api/validators/auth.py
+++ b/src/sentry/api/validators/auth.py
@@ -8,3 +8,11 @@ class AuthVerifyValidator(serializers.Serializer):
     # For u2f
     challenge = serializers.CharField(required=False)
     response = serializers.CharField(required=False)
+
+    def validate(self, data):
+        if 'password' in data:
+            return data
+        if 'challenge' in data and 'response' in data:
+            return data
+        raise serializers.ValidationError(
+            'You must provide `password` or `challenge` and `response`.')
diff --git a/tests/sentry/api/endpoints/test_auth_index.py b/tests/sentry/api/endpoints/test_auth_index.py
index 4da12862c3..f6aa9bb685 100644
--- a/tests/sentry/api/endpoints/test_auth_index.py
+++ b/tests/sentry/api/endpoints/test_auth_index.py
@@ -66,6 +66,12 @@ class AuthVerifyEndpointTest(APITestCase):
         })
         assert response.status_code == 403
 
+    def test_no_password_no_u2f(self):
+        user = self.create_user('foo@example.com')
+        self.login_as(user)
+        response = self.client.put(self.path, data={})
+        assert response.status_code == 400
+
 
 class AuthLogoutEndpointTest(APITestCase):
     path = '/api/0/auth/'
