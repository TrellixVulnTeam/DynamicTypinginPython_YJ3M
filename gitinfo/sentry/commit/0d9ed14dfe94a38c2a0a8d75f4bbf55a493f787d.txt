commit 0d9ed14dfe94a38c2a0a8d75f4bbf55a493f787d
Author: Lauryn Brown <lauryndbrown@gmail.com>
Date:   Fri Oct 19 13:16:25 2018 -0700

    fix(integrations): Add group_id to GitLab metadata. (#10204)
    
    * Added group id to metadata.
    
    * Added a test to ensure things will work as expected.

diff --git a/src/sentry/integrations/gitlab/integration.py b/src/sentry/integrations/gitlab/integration.py
index 21bff1fffb..963cca27ab 100644
--- a/src/sentry/integrations/gitlab/integration.py
+++ b/src/sentry/integrations/gitlab/integration.py
@@ -76,7 +76,7 @@ class GitlabIntegration(IntegrationInstallation, GitlabIssueBasic, RepositoryMix
         self.default_identity = None
 
     def get_group_id(self):
-        return self.model.name
+        return self.model.metadata['group_id']
 
     def get_client(self):
         if self.default_identity is None:
@@ -270,7 +270,8 @@ class GitlabIntegrationProvider(IntegrationProvider):
                 'scopes': scopes,
                 'verify_ssl': verify_ssl,
                 'base_url': base_url,
-                'webhook_secret': secret.hexdigest()
+                'webhook_secret': secret.hexdigest(),
+                'group_id': group['id'],
             },
             'user_identity': {
                 'type': 'gitlab',
diff --git a/tests/sentry/integrations/gitlab/test_integration.py b/tests/sentry/integrations/gitlab/test_integration.py
index eeb6825a11..a4c9ea005a 100644
--- a/tests/sentry/integrations/gitlab/test_integration.py
+++ b/tests/sentry/integrations/gitlab/test_integration.py
@@ -24,8 +24,12 @@ class GitlabIntegrationTest(IntegrationTestCase):
         'client_id': 'client_id',
         'client_secret': 'client_secret'
     }
+    default_group_id = 4
+
+    def assert_setup_flow(self, user_id='user_id_1', group_id=None):
+        if group_id is None:
+            group_id = self.default_group_id
 
-    def assert_setup_flow(self, user_id='user_id_1', group_id=4):
         resp = self.client.get(self.init_path)
         assert resp.status_code == 200
         resp = self.client.post(self.init_path, data=self.config)
@@ -116,7 +120,8 @@ class GitlabIntegrationTest(IntegrationTestCase):
             'domain_name': u'gitlab.example.com/cool-group',
             'verify_ssl': True,
             'base_url': 'https://gitlab.example.com',
-            'webhook_secret': 'secret-token'
+            'webhook_secret': 'secret-token',
+            'group_id': self.default_group_id,
         }
         oi = OrganizationIntegration.objects.get(
             integration=integration,
@@ -134,3 +139,11 @@ class GitlabIntegrationTest(IntegrationTestCase):
         assert identity.data == {
             'access_token': 'xxxxx-xxxxxxxxx-xxxxxxxxxx-xxxxxxxxxxxx'
         }
+
+    @responses.activate
+    def test_get_group_id(self):
+        self.assert_setup_flow()
+        integration = Integration.objects.get(provider=self.provider.key)
+
+        installation = integration.get_installation(self.organization.id)
+        assert self.default_group_id == installation.get_group_id()
