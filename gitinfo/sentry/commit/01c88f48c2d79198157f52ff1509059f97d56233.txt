commit 01c88f48c2d79198157f52ff1509059f97d56233
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Tue May 23 18:19:38 2017 -0700

    tasks: fix race condition and handle missing activity in clear_expired_resolution
    
    * We were using the raw queryset for both the update and the iteration,
    which meant that it was being evaluated twice with potentially different
    results each time. So coerce to a list.
    * Handle missing Activity objects gracefully, fixes SENTRY-2XQ

diff --git a/src/sentry/tasks/clear_expired_resolutions.py b/src/sentry/tasks/clear_expired_resolutions.py
index c6781d181b..0248fd7dc9 100644
--- a/src/sentry/tasks/clear_expired_resolutions.py
+++ b/src/sentry/tasks/clear_expired_resolutions.py
@@ -22,21 +22,29 @@ def clear_expired_resolutions(release_id):
     except Release.DoesNotExist:
         return
 
-    resolution_list = GroupResolution.objects.filter(
+    resolution_list = list(GroupResolution.objects.filter(
         release__projects=release.projects.all(),
         release__date_added__lt=release.date_added,
     ).exclude(
         release=release,
-    )
+    ))
 
-    resolution_list.update(status=GroupResolutionStatus.RESOLVED)
+    if not resolution_list:
+        return
+
+    GroupResolution.objects.filter(
+        id__in=[r.id for r in resolution_list]
+    ).update(status=GroupResolutionStatus.RESOLVED)
 
     for resolution in resolution_list:
-        activity = Activity.objects.filter(
-            group=resolution.group_id,
-            type=Activity.SET_RESOLVED_IN_RELEASE,
-            ident=resolution.id,
-        ).order_by('-datetime')[0]
+        try:
+            activity = Activity.objects.filter(
+                group=resolution.group_id,
+                type=Activity.SET_RESOLVED_IN_RELEASE,
+                ident=resolution.id,
+            ).order_by('-datetime')[0]
+        except IndexError:
+            continue
 
         activity.update(data={
             'version': release.version,
