commit 69afa5ec22e974ff8d14b6488370b5bafafe110e
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jan 20 11:39:45 2013 -0800

    Delete one object at a time

diff --git a/src/sentry/tasks/cleanup.py b/src/sentry/tasks/cleanup.py
index f4cf40f291..59f1b9061d 100644
--- a/src/sentry/tasks/cleanup.py
+++ b/src/sentry/tasks/cleanup.py
@@ -47,7 +47,9 @@ def cleanup(days=30, project=None, **kwargs):
         qs = model.objects.filter(**{'%s__lte' % (date_col,): ts})
         if project:
             qs = qs.filter(project=project)
-        qs.delete()
+        # XXX: we step through because the deletion collector will pull all relations into memory
+        for obj in RangeQuerySetWrapper(qs):
+            obj.delete()
 
     # We'll need this to confirm deletion of FilterKey and Filtervalue objects.
     mqs = MessageFilterValue.objects.all()
