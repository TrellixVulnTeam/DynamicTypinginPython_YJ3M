commit 60a9bda618b37fdacc557e7320df73550577bfe2
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Aug 7 12:06:51 2012 -0700

    Handle headers when they're a string

diff --git a/sentry/interfaces.py b/sentry/interfaces.py
index d3fbcf2abf..fd5f880cdb 100644
--- a/sentry/interfaces.py
+++ b/sentry/interfaces.py
@@ -363,27 +363,28 @@ class Http(Interface):
             'query_string': self.query_string,
         })
 
+    def _to_dict(self, value):
+        if value is None:
+            value = {}
+        if isinstance(value, dict):
+            return True, value
+        try:
+            value = QueryDict(value)
+        except _Exception:
+            return False, value
+        else:
+            return True, value
+
     def to_html(self, event):
         data = self.data
         data_is_dict = False
-        if self.headers.get('Content-Type') == 'application/x-www-form-urlencoded':
-            try:
-                data = QueryDict(data)
-            except _Exception:
-                pass
-            else:
-                data_is_dict = True
+        headers_is_dict, headers = self._to_dict(self.headers)
+
+        if headers_is_dict and headers.get('Content-Type') == 'application/x-www-form-urlencoded':
+            data_is_dict, data = self._to_dict(data)
 
         # It's kind of silly we store this twice
-        cookies = self.cookies or self.headers.pop('Cookie', {})
-        cookies_is_dict = isinstance(cookies, dict)
-        if not cookies_is_dict:
-            try:
-                cookies = QueryDict(cookies)
-            except _Exception:
-                pass
-            else:
-                cookies_is_dict = True
+        cookies_is_dict, cookies = self._to_dict(self.cookies or headers.pop('Cookie', {}))
 
         return render_to_string('sentry/partial/interfaces/http.html', {
             'event': event,
@@ -396,6 +397,7 @@ class Http(Interface):
             'cookies': cookies,
             'cookies_is_dict': cookies_is_dict,
             'headers': self.headers,
+            'headers_is_dict': headers_is_dict,
             'env': self.env,
         })
 
diff --git a/sentry/templates/sentry/partial/interfaces/http.html b/sentry/templates/sentry/partial/interfaces/http.html
index f79d07cc8f..7d4fa29153 100644
--- a/sentry/templates/sentry/partial/interfaces/http.html
+++ b/sentry/templates/sentry/partial/interfaces/http.html
@@ -96,22 +96,31 @@
                     <tr>
                         <th>{% trans "Headers:" %}</th>
                         <td>
-                            {% if headers|length > 5 %}
-                                <a href="#" onclick="return varToggle(this, 'HttpHeaders')"><span>&#x25b6;</span> {% trans "Headers" %}</a>
+                            {% if headers_is_dict %}
+                                {% if headers|length > 5 %}
+                                    <a href="#" onclick="return varToggle(this, 'HttpHeaders')"><span>&#x25b6;</span> {% trans "Cookies" %}</a>
+                                {% endif %}
+                                <table class="table vars" id="vHttpHeaders"{% if headers|length > 5 %} style="display:none;"{% endif %}>
+                                    <colgroup>
+                                        <col style="width:100px;">
+                                    </colgroup>
+                                    <tbody>
+                                        {% for key, value in headers.iteritems|as_sorted %}
+                                            <tr>
+                                                <td>{{ key|to_str }}</td>
+                                                <td class="code"><pre>{{ value|pprint }}</pre></td>
+                                            </tr>
+                                        {% endfor %}
+                                    </tbody>
+                                </table>
+                            {% else %}
+                                {% if headers|length > 5 %}
+                                    <a href="#" onclick="return varToggle(this, 'HttpHeaders')"><span>&#x25b6;</span> {% trans "Cookies" %}</a>
+                                {% endif %}
+                                <div id="vHttpHeaders"{% if headers|length > 5 %} style="display:none;"{% endif %}>
+                                    <pre>{{ headers|pprint }}</pre>
+                                </div>
                             {% endif %}
-                            <table class="table vars" id="vHttpHeaders"{% if headers|length > 5 %} style="display:none;"{% endif %}>
-                                <colgroup>
-                                    <col style="width:100px;">
-                                </colgroup>
-                                <tbody>
-                                    {% for key, value in headers.iteritems|as_sorted %}
-                                        <tr>
-                                            <td>{{ key }}</td>
-                                            <td class="code"><pre>{{ value|pprint }}</pre></td>
-                                        </tr>
-                                    {% endfor %}
-                                </tbody>
-                            </table>
                         </td>
                     </tr>
                 {% endif %}
