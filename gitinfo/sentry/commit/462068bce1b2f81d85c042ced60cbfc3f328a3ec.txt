commit 462068bce1b2f81d85c042ced60cbfc3f328a3ec
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Thu Jul 13 11:55:26 2017 -0700

    make sure associations with releases are removed for projects in Team.transfer_to fixes SENTRY-3VW (#5715)

diff --git a/src/sentry/models/team.py b/src/sentry/models/team.py
index 9567ed6855..3cfcc68161 100644
--- a/src/sentry/models/team.py
+++ b/src/sentry/models/team.py
@@ -174,7 +174,7 @@ class Team(Model):
         """
         from sentry.models import (
             OrganizationAccessRequest, OrganizationMember,
-            OrganizationMemberTeam, Project
+            OrganizationMemberTeam, Project, ReleaseProject
         )
 
         try:
@@ -190,10 +190,19 @@ class Team(Model):
         else:
             new_team = self
 
-        Project.objects.filter(
+        project_ids = list(Project.objects.filter(
             team=self,
         ).exclude(
             organization=organization,
+        ).values_list('id', flat=True))
+
+        # remove associations with releases from other org
+        ReleaseProject.objects.filter(
+            project_id__in=project_ids,
+        ).delete()
+
+        Project.objects.filter(
+            id__in=project_ids,
         ).update(
             team=new_team,
             organization=organization,
diff --git a/tests/sentry/models/test_team.py b/tests/sentry/models/test_team.py
index 3dc89a6173..a913e1dfa2 100644
--- a/tests/sentry/models/test_team.py
+++ b/tests/sentry/models/test_team.py
@@ -3,7 +3,8 @@
 from __future__ import absolute_import
 
 from sentry.models import (
-    OrganizationMember, OrganizationMemberTeam, Project, Team
+    OrganizationMember, OrganizationMemberTeam,
+    Project, Release, ReleaseProject, Team
 )
 from sentry.testutils import TestCase
 
@@ -131,3 +132,31 @@ class TransferTest(TestCase):
         assert project.team == team2
 
         assert not Team.objects.filter(id=team.id).exists()
+
+    def test_release_projects(self):
+        user = self.create_user()
+        org = self.create_organization(name='foo', owner=user)
+        org2 = self.create_organization(name='bar', owner=None)
+        team = self.create_team(organization=org)
+        project = self.create_project(team=team)
+
+        release = Release.objects.create(
+            version='a' * 7,
+            organization=org,
+        )
+
+        release.add_project(project)
+
+        assert ReleaseProject.objects.filter(
+            release=release,
+            project=project,
+        ).exists()
+
+        team.transfer_to(org2)
+
+        assert Release.objects.filter(id=release.id).exists()
+
+        assert not ReleaseProject.objects.filter(
+            release=release,
+            project=project,
+        ).exists()
