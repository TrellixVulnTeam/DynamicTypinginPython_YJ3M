commit 32e7d644744fb898dc192f42d1c0b6cc9ac95d26
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue Jul 26 14:53:05 2016 +0200

    Switch to saner JSON dumping

diff --git a/src/sentry/templatetags/sentry_api.py b/src/sentry/templatetags/sentry_api.py
index 039f4c2d04..ea2bc165a1 100644
--- a/src/sentry/templatetags/sentry_api.py
+++ b/src/sentry/templatetags/sentry_api.py
@@ -2,7 +2,6 @@ from __future__ import absolute_import
 
 from django import template
 from django.http import HttpRequest
-from django.utils.html import mark_safe
 
 from sentry.api.serializers.base import serialize as serialize_func
 from sentry.api.serializers.models.organization import (
@@ -21,14 +20,12 @@ def serialize(context, obj):
     else:
         user = None
 
-    return convert_to_json(serialize_func(obj, user), escape=True)
+    return convert_to_json(serialize_func(obj, user))
 
 
 @register.simple_tag
-def convert_to_json(obj, escape=False):
-    if escape:
-        return json.dumps_htmlsafe(obj)
-    return mark_safe(json.dumps(obj))
+def convert_to_json(obj):
+    return json.dumps_htmlsafe(obj)
 
 
 @register.simple_tag(takes_context=True)
@@ -44,7 +41,7 @@ def serialize_detailed_org(context, obj):
         DetailedOrganizationSerializer(),
     )
 
-    return convert_to_json(context, escape=True)
+    return convert_to_json(context)
 
 
 @register.simple_tag
@@ -61,4 +58,4 @@ def get_user_context(request, escape=False):
                 result['name'] = user.name
     else:
         result = {}
-    return convert_to_json(result, escape=True)
+    return convert_to_json(result)
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index 7f6dfc82bb..6e3aed0ced 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -154,9 +154,7 @@ def is_none(value):
 @register.simple_tag(takes_context=True)
 def serialize(context, value):
     value = serialize_func(value, context['request'].user)
-    value = json.dumps(value)
-    value = value.replace('<', '&lt;').replace('>', '&gt;')
-    return mark_safe(value)
+    return json.dumps_htmlsafe(value)
 
 
 @register.simple_tag(takes_context=True)
diff --git a/src/sentry/utils/javascript.py b/src/sentry/utils/javascript.py
index f3ac79b61b..38a970cf40 100644
--- a/src/sentry/utils/javascript.py
+++ b/src/sentry/utils/javascript.py
@@ -64,7 +64,7 @@ def transform(objects, request=None):
 
 def to_json(obj, request=None):
     result = transform(obj, request=request)
-    return json.dumps(result)
+    return json.dumps_htmlsafe(result)
 
 
 def register(type):
diff --git a/src/sentry/utils/json.py b/src/sentry/utils/json.py
index ae0696fc5b..e2f40f48aa 100644
--- a/src/sentry/utils/json.py
+++ b/src/sentry/utils/json.py
@@ -70,6 +70,7 @@ def dump(value, fp, **kwargs):
 
 
 def dumps(value, escape=False, **kwargs):
+    # Legacy use. Do not use. Use dumps_htmlsafe
     if escape:
         return _default_escaped_encoder.encode(value)
     return _default_encoder.encode(value)
@@ -79,7 +80,5 @@ def loads(value, **kwargs):
     return _default_decoder.decode(value)
 
 
-def dumps_htmlsafe(obj):
-    data = dumps(obj)
-    data = data.replace('<', '&lt;').replace('>', '&gt;')
-    return mark_safe(data)
+def dumps_htmlsafe(value):
+    return mark_safe(_default_escaped_encoder.encode(value))
diff --git a/tests/sentry/templatetags/test_sentry_api.py b/tests/sentry/templatetags/test_sentry_api.py
index 948a6b1dd3..c9cd40d2e3 100644
--- a/tests/sentry/templatetags/test_sentry_api.py
+++ b/tests/sentry/templatetags/test_sentry_api.py
@@ -19,4 +19,4 @@ class SerializeDetailedOrgTest(TestCase):
         }))
 
         assert '<script>' not in result
-        assert '&lt;script&gt;' in result
+        assert '\u003cscript\u003ealert(1);\u003c/script\u003e' in result
