commit f54d2ff7369e7879a17156f635f8b157845e5f1a
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Feb 13 20:40:48 2013 -0800

    Improve accuracy and number of intervals used in trends query

diff --git a/src/sentry/manager.py b/src/sentry/manager.py
index 8809be37c9..b40e2f5b9f 100644
--- a/src/sentry/manager.py
+++ b/src/sentry/manager.py
@@ -706,7 +706,7 @@ class GroupManager(BaseManager, ChartMixin):
 
         assert minutes >= normalization
 
-        intervals = (60 / normalization)
+        intervals = 8
 
         engine = get_db_engine(queryset.db)
         # We technically only support mysql and postgresql, since there seems to be no standard
@@ -729,13 +729,11 @@ class GroupManager(BaseManager, ChartMixin):
 
         query = """
         SELECT ((mcbm.times_seen + 1) / ((%(epoch_clause)s) / 60)) / (COALESCE(z.rate, 0) + 1) as sort_value,
-               (COALESCE(z.rate, 0) + 1) as prev_rate,
-               ((mcbm.times_seen + 1) / ((%(epoch_clause)s) / 60)) as cur_rate,
                %(fields)s
         FROM sentry_groupedmessage
         INNER JOIN sentry_messagecountbyminute as mcbm
             ON (sentry_groupedmessage.id = mcbm.group_id)
-        LEFT JOIN (SELECT a.group_id, SUM(a.times_seen) / COUNT(a.times_seen) / %(norm)f as rate
+        LEFT JOIN (SELECT a.group_id, (SUM(a.times_seen)) / COUNT(a.times_seen) / %(norm)f as rate
             FROM sentry_messagecountbyminute as a
             WHERE a.date >=  %(now)s - %(max_time)s
             AND a.date < %(now)s - %(min_time)s
@@ -747,7 +745,7 @@ class GroupManager(BaseManager, ChartMixin):
         AND mcbm.times_seen > 0
         AND ((mcbm.times_seen + 1) / ((%(epoch_clause)s) / 60)) > (COALESCE(z.rate, 0) + 1)
         AND %(after_where)s
-        GROUP BY prev_rate, mcbm.times_seen, mcbm.date, %(fields)s
+        GROUP BY mcbm.times_seen, mcbm.date, %(fields)s
         ORDER BY sort_value DESC
         """ % dict(
             fields=self.model_fields_clause,
