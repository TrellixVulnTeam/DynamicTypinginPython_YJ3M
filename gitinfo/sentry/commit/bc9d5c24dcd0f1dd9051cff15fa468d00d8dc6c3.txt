commit bc9d5c24dcd0f1dd9051cff15fa468d00d8dc6c3
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri Sep 18 14:39:10 2015 -0700

    Handle inf/-inf/nan values inside Frame interface
    
    Fixes GH-1979

diff --git a/src/sentry/interfaces/stacktrace.py b/src/sentry/interfaces/stacktrace.py
index bd2256f068..49f7237c88 100644
--- a/src/sentry/interfaces/stacktrace.py
+++ b/src/sentry/interfaces/stacktrace.py
@@ -145,6 +145,19 @@ def validate_bool(value, required=True):
     return value
 
 
+def handle_nan(value):
+    "Remove nan values that can't be json encoded"
+    if isinstance(value, float):
+        if value == float('inf'):
+            return '<inf>'
+        if value == float('-inf'):
+            return '<-inf>'
+        # lol checking for float('nan')
+        if value != value:
+            return '<nan>'
+    return value
+
+
 class Frame(Interface):
     @classmethod
     def to_python(cls, data):
@@ -179,7 +192,7 @@ class Frame(Interface):
             context_locals = dict(enumerate(context_locals))
         elif not isinstance(context_locals, dict):
             context_locals = {}
-        context_locals = trim_dict(context_locals)
+        context_locals = trim_dict(context_locals, object_hook=handle_nan)
 
         # extra data is used purely by internal systems,
         # so we dont trim it
diff --git a/src/sentry/utils/safe.py b/src/sentry/utils/safe.py
index aefa59e7f4..356bc62e40 100644
--- a/src/sentry/utils/safe.py
+++ b/src/sentry/utils/safe.py
@@ -50,7 +50,7 @@ def safe_execute(func, *args, **kwargs):
 
 
 def trim(value, max_size=settings.SENTRY_MAX_VARIABLE_SIZE, max_depth=3,
-         _depth=0, _size=0, **kwargs):
+         object_hook=None, _depth=0, _size=0, **kwargs):
     """
     Truncates a value to ```MAX_VARIABLE_SIZE```.
 
@@ -59,6 +59,7 @@ def trim(value, max_size=settings.SENTRY_MAX_VARIABLE_SIZE, max_depth=3,
     options = {
         'max_depth': max_depth,
         'max_size': max_size,
+        'object_hook': object_hook,
         '_depth': _depth + 1,
     }
 
@@ -91,7 +92,9 @@ def trim(value, max_size=settings.SENTRY_MAX_VARIABLE_SIZE, max_depth=3,
     else:
         result = value
 
-    return result
+    if object_hook is None:
+        return result
+    return object_hook(result)
 
 
 def trim_pairs(iterable, max_items=settings.SENTRY_MAX_DICTIONARY_ITEMS, **kwargs):
diff --git a/tests/sentry/interfaces/test_stacktrace.py b/tests/sentry/interfaces/test_stacktrace.py
index 308a36caf7..7ec9826960 100644
--- a/tests/sentry/interfaces/test_stacktrace.py
+++ b/tests/sentry/interfaces/test_stacktrace.py
@@ -350,6 +350,29 @@ class StacktraceTest(TestCase):
                 'module': 1,
             })
 
+    def test_context_with_nan(self):
+        self.assertEquals(
+            Frame.to_python({
+                'filename': 'x',
+                'vars': {'x': float('inf')},
+            }).vars,
+            {'x': '<inf>'},
+        )
+        self.assertEquals(
+            Frame.to_python({
+                'filename': 'x',
+                'vars': {'x': float('-inf')},
+            }).vars,
+            {'x': '<-inf>'},
+        )
+        self.assertEquals(
+            Frame.to_python({
+                'filename': 'x',
+                'vars': {'x': float('nan')},
+            }).vars,
+            {'x': '<nan>'},
+        )
+
 
 class SlimFrameDataTest(TestCase):
     def test_under_max(self):
