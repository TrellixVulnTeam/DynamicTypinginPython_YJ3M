commit 1bb64111b3d5a3286875c4118898d6212b42bb3b
Author: David Cramer <dcramer@gmail.com>
Date:   Fri May 2 12:05:27 2014 -0300

    Default redis settings for tests

diff --git a/conftest.py b/conftest.py
index 1bb99797bd..94e43a8777 100644
--- a/conftest.py
+++ b/conftest.py
@@ -73,8 +73,13 @@ def pytest_configure(config):
     settings.SENTRY_ENABLE_EXPLORE_USERS = True
     settings.SENTRY_ENABLE_EMAIL_REPLIES = True
 
+    settings.SENTRY_REDIS_OPTIONS = {'hosts': {0: {'db': 9}}}
+
     settings.SENTRY_ALLOW_ORIGIN = '*'
 
+    settings.SENTRY_TSDB = 'sentry.tsdb.redis.RedisTSDB'
+    settings.SENTRY_TSDB_OPTIONS = {}
+
     # django mail uses socket.getfqdn which doesnt play nice if our
     # networking isnt stable
     patcher = mock.patch('socket.getfqdn', return_value='localhost')
@@ -82,3 +87,6 @@ def pytest_configure(config):
 
     from sentry.utils.runner import initialize_receivers
     initialize_receivers()
+
+    from sentry.testutils.cases import flush_redis
+    flush_redis()
diff --git a/src/sentry/testutils/cases.py b/src/sentry/testutils/cases.py
index d750e02e60..0f47eb4c07 100644
--- a/src/sentry/testutils/cases.py
+++ b/src/sentry/testutils/cases.py
@@ -25,6 +25,7 @@ from django.test import TestCase, TransactionTestCase
 from django.test.client import Client
 from django.utils.importlib import import_module
 from exam import Exam
+from nydus.db import create_cluster
 from rest_framework.test import APITestCase as BaseAPITestCase
 from django_sudo.settings import COOKIE_NAME as SUDO_COOKIE_NAME
 from django_sudo.utils import grant_sudo_privileges
@@ -37,6 +38,21 @@ from .fixtures import Fixtures
 from .helpers import get_auth_header
 
 
+def create_redis_conn():
+    options = {
+        'engine': 'nydus.db.backends.redis.Redis',
+    }
+    options.update(settings.SENTRY_REDIS_OPTIONS)
+
+    return create_cluster(options)
+
+_redis_conn = create_redis_conn()
+
+
+def flush_redis():
+    _redis_conn.flushdb()
+
+
 class BaseTestCase(Fixtures, Exam):
     urls = 'tests.sentry.web.urls'
 
@@ -94,6 +110,10 @@ class BaseTestCase(Fixtures, Exam):
         ProjectOption.objects.clear_local_cache()
         super(BaseTestCase, self)._pre_setup()
 
+    def _post_teardown(self):
+        flush_redis()
+        super(BaseTestCase, self)._post_teardown()
+
     def _makeMessage(self, data):
         return json.dumps(data)
 
diff --git a/tests/sentry/buffer/redis/tests.py b/tests/sentry/buffer/redis/tests.py
index 5ad727de25..34f9635088 100644
--- a/tests/sentry/buffer/redis/tests.py
+++ b/tests/sentry/buffer/redis/tests.py
@@ -14,7 +14,6 @@ class RedisBufferTest(TestCase):
         self.buf = RedisBuffer(hosts={
             0: {'db': 9}
         })
-        self.buf.conn.flushdb()
 
     def test_default_host_is_local(self):
         buf = RedisBuffer()
diff --git a/tests/sentry/quotas/redis/tests.py b/tests/sentry/quotas/redis/tests.py
index 5b71ea5f00..318df96156 100644
--- a/tests/sentry/quotas/redis/tests.py
+++ b/tests/sentry/quotas/redis/tests.py
@@ -16,7 +16,6 @@ class RedisQuotaTest(TestCase):
         inst = RedisQuota(hosts={
             0: {'db': 9}
         })
-        inst.conn.flushdb()
         return inst
 
     @patcher.object(RedisQuota, 'get_system_quota')
