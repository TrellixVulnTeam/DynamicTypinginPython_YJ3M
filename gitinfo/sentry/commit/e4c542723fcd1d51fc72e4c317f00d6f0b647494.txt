commit e4c542723fcd1d51fc72e4c317f00d6f0b647494
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Feb 13 01:19:15 2013 -0800

    Enforce at least a 60 second old window for alert data

diff --git a/src/sentry/tasks/check_alerts.py b/src/sentry/tasks/check_alerts.py
index e9c0450490..62dc0ba9b6 100644
--- a/src/sentry/tasks/check_alerts.py
+++ b/src/sentry/tasks/check_alerts.py
@@ -69,15 +69,19 @@ def check_alerts(**kwargs):
     from sentry.utils.queue import maybe_delay
 
     when = timezone.now()
+    # we want at least a 60 second window of events
+    min_date = when - timedelta(minutes=MINUTE_NORMALIZATION + 1)
+    max_date = min_date + timedelta(minutes=MINUTE_NORMALIZATION)
 
     # find each project which has data for the last interval
     # TODO: we could force more work on the db by eliminating onces which dont have the full aggregate we need
     qs = ProjectCountByMinute.objects.filter(
-        date__gt=when - timedelta(minutes=MINUTE_NORMALIZATION),
+        date__gt=min_date,
+        date__lte=max_date,
         times_seen__gt=0,
     ).values_list('project_id', 'date', 'times_seen')
     for project_id, date, count in qs:
-        normalized_count = int(count / (((when - date).seconds + 1) / 60))
+        normalized_count = int(count / ((when - date).seconds / 60))
         maybe_delay(check_project_alerts,
             project_id=project_id,
             when=when,
diff --git a/tests/sentry/tasks/check_alerts/tests.py b/tests/sentry/tasks/check_alerts/tests.py
index 9199c8b88e..fa24c40f79 100644
--- a/tests/sentry/tasks/check_alerts/tests.py
+++ b/tests/sentry/tasks/check_alerts/tests.py
@@ -35,7 +35,7 @@ class CheckAlertsTest(BaseTestCase):
             check_project_alerts,
             project_id=self.project.id,
             when=when,
-            count=9,
+            count=10,
             expires=120
         )
 
