commit de9e58155d28ec249a42c9c918238fe819a5acac
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Thu Dec 5 14:09:29 2019 -0800

    feat(snuba): Add 1 second to end timestamp (#15939)
    
    Since Snuba queries are rounded to the second, and non inclusive of
    the end time, we sometimes have a problem where recently inserted events
    are not returned on fetch.
    
    This issue mostly arises in tests, however it can also affect event
    backfill scripts and creating sample events. In these scenarios it's
    possible that attempting to fetch the event happens in the same second
    as the timestamp of the freshly created event resulting in flaky
    behavior.
    
    This is solved here by adding 1 second to the default end time.
    
    An alternative approach in getsentry/snuba#616
    would be to make Snuba queries inclusive of the end time.

diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index 9f76a0376a..71e6a35ee5 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -741,7 +741,7 @@ class SnubaQueryParams(object):
         # TODO: instead of having events be the default, make dataset required.
         self.dataset = dataset or Dataset.Events
         self.start = start or datetime.utcfromtimestamp(0)  # will be clamped to project retention
-        self.end = end or datetime.utcnow()
+        self.end = end or datetime.utcnow() + timedelta(seconds=1)
         self.groupby = groupby or []
         self.conditions = conditions or []
         self.aggregations = aggregations or []
