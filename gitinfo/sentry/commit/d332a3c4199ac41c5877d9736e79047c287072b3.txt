commit d332a3c4199ac41c5877d9736e79047c287072b3
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Sep 11 00:27:10 2012 -0700

    Sanity for authentication: always set test cookie and some guarantees around login redirect url

diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index a5151f2762..637eb23c12 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -32,8 +32,8 @@ def login(request):
     if form.is_valid():
         login_(request, form.get_user())
         return login_redirect(request)
-    else:
-        request.session.set_test_cookie()
+
+    request.session.set_test_cookie()
 
     AUTH_PROVIDERS = get_auth_providers()
 
@@ -49,7 +49,13 @@ def login(request):
 
 @login_required
 def login_redirect(request):
-    return HttpResponseRedirect(request.session.pop('_next', None) or reverse('sentry'))
+    default = reverse('sentry')
+    login_url = request.session.pop('_next', None) or default
+    if '//' in login_url:
+        login_url = default
+    elif login_url.startswith(reverse('sentry-login')):
+        login_url = default
+    return HttpResponseRedirect(login_url)
 
 
 def logout(request):
