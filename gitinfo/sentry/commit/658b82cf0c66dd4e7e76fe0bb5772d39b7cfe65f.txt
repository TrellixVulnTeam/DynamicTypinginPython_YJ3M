commit 658b82cf0c66dd4e7e76fe0bb5772d39b7cfe65f
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu Feb 18 18:06:17 2016 -0800

    Added global dsym upload endpoint

diff --git a/src/sentry/api/endpoints/dsym_files.py b/src/sentry/api/endpoints/dsym_files.py
index ffd72bcb6e..b5ae06d284 100644
--- a/src/sentry/api/endpoints/dsym_files.py
+++ b/src/sentry/api/endpoints/dsym_files.py
@@ -5,7 +5,9 @@ from rest_framework.parsers import FormParser, MultiPartParser
 from rest_framework.response import Response
 
 from sentry.api.base import DocSection
+from sentry.api.base import Endpoint
 from sentry.api.bases.project import ProjectEndpoint
+from sentry.api.permissions import SystemPermission
 from sentry.api.paginator import OffsetPaginator
 from sentry.api.serializers import serialize
 from sentry.models import DSymFile
@@ -85,3 +87,14 @@ class DSymFilesEndpoint(ProjectEndpoint):
         files = DSymFile.create_files_from_macho_zip(project, fileobj)
 
         return Response(serialize(files, request.user), status=201)
+
+
+class GlobalDSymFilesEndpoint(Endpoint):
+    permission_classes = (SystemPermission,)
+
+    def post(self, request):
+        if 'file' not in request.FILES:
+            return Response({'detail': 'Missing uploaded file'}, status=400)
+        fileobj = request.FILES['file']
+        files = DSymFile.create_files_from_macho_zip(None, fileobj)
+        return Response(serialize(files, request.user), status=201)
diff --git a/src/sentry/api/urls.py b/src/sentry/api/urls.py
index bad28e3176..f16c892cda 100644
--- a/src/sentry/api/urls.py
+++ b/src/sentry/api/urls.py
@@ -60,7 +60,7 @@ from .endpoints.project_user_reports import ProjectUserReportsEndpoint
 from .endpoints.release_details import ReleaseDetailsEndpoint
 from .endpoints.release_files import ReleaseFilesEndpoint
 from .endpoints.release_file_details import ReleaseFileDetailsEndpoint
-from .endpoints.dsym_files import DSymFilesEndpoint
+from .endpoints.dsym_files import DSymFilesEndpoint, GlobalDSymFilesEndpoint
 from .endpoints.shared_group_details import SharedGroupDetailsEndpoint
 from .endpoints.system_health import SystemHealthEndpoint
 from .endpoints.system_options import SystemOptionsEndpoint
@@ -295,6 +295,11 @@ urlpatterns = patterns(
         EventDetailsEndpoint.as_view(),
         name='sentry-api-0-event-details'),
 
+    # Installation Global Endpoints
+    url(r'^system/global-dsyms/$',
+        GlobalDSymFilesEndpoint.as_view(),
+        name='sentry-api-0-global-dsym-files'),
+
     # Internal
     url(r'^internal/health/$',
         SystemHealthEndpoint.as_view(),
diff --git a/src/sentry/lang/native/dsymcache.py b/src/sentry/lang/native/dsymcache.py
index 1cab36cdbe..57f300e30b 100644
--- a/src/sentry/lang/native/dsymcache.py
+++ b/src/sentry/lang/native/dsymcache.py
@@ -2,6 +2,7 @@ import os
 import shutil
 
 from django.conf import settings
+from django.db.models import Q
 from sentry.models import DSymFile
 
 
@@ -31,8 +32,8 @@ class DSymCache(object):
 
         try:
             dsf = DSymFile.objects.filter(
-                project=project,
-                uuid=image_uuid,
+                Q(uuid=image_uuid),
+                Q(project=project) | Q(project=None),
             ).select_related('file', 'file__blob').get()
         except DSymFile.DoesNotExist:
             return None
diff --git a/src/sentry/migrations/0235_auto__add_dsymfile__add_unique_dsymfile_project_uuid.py b/src/sentry/migrations/0235_auto__add_dsymfile__add_unique_dsymfile_project_uuid.py
index 4316f6e23c..14e984b06b 100644
--- a/src/sentry/migrations/0235_auto__add_dsymfile__add_unique_dsymfile_project_uuid.py
+++ b/src/sentry/migrations/0235_auto__add_dsymfile__add_unique_dsymfile_project_uuid.py
@@ -11,7 +11,7 @@ class Migration(SchemaMigration):
         # Adding model 'DSymFile'
         db.create_table('sentry_dsymfile', (
             ('id', self.gf('sentry.db.models.fields.bounded.BoundedBigAutoField')(primary_key=True)),
-            ('project', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.Project'])),
+            ('project', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.Project'], null=True)),
             ('file', self.gf('sentry.db.models.fields.foreignkey.FlexibleForeignKey')(to=orm['sentry.File'])),
             ('uuid', self.gf('django.db.models.fields.CharField')(max_length=36)),
             ('object_name', self.gf('django.db.models.fields.TextField')()),
@@ -96,7 +96,7 @@ class Migration(SchemaMigration):
         'sentry.broadcast': {
             'Meta': {'object_name': 'Broadcast'},
             'date_added': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime.now'}),
-            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2016, 2, 11, 0, 0)', 'null': 'True', 'blank': 'True'}),
+            'date_expires': ('django.db.models.fields.DateTimeField', [], {'default': 'datetime.datetime(2016, 2, 25, 0, 0)', 'null': 'True', 'blank': 'True'}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'is_active': ('django.db.models.fields.BooleanField', [], {'default': 'True', 'db_index': 'True'}),
             'link': ('django.db.models.fields.URLField', [], {'max_length': '200', 'null': 'True', 'blank': 'True'}),
@@ -117,7 +117,7 @@ class Migration(SchemaMigration):
             'file': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.File']"}),
             'id': ('sentry.db.models.fields.bounded.BoundedBigAutoField', [], {'primary_key': 'True'}),
             'object_name': ('django.db.models.fields.TextField', [], {}),
-            'project': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.Project']"}),
+            'project': ('sentry.db.models.fields.foreignkey.FlexibleForeignKey', [], {'to': "orm['sentry.Project']", 'null': 'True'}),
             'uuid': ('django.db.models.fields.CharField', [], {'max_length': '36'})
         },
         'sentry.event': {
diff --git a/src/sentry/models/dsymfile.py b/src/sentry/models/dsymfile.py
index 4cdef7d75c..727c6e28a3 100644
--- a/src/sentry/models/dsymfile.py
+++ b/src/sentry/models/dsymfile.py
@@ -31,7 +31,7 @@ class DSymFile(Model):
     """
     __core__ = False
 
-    project = FlexibleForeignKey('sentry.Project')
+    project = FlexibleForeignKey('sentry.Project', null=True)
     file = FlexibleForeignKey('sentry.File')
     uuid = models.CharField(max_length=36)
     object_name = models.TextField()
@@ -58,7 +58,7 @@ class DSymFile(Model):
         """
         file = File.objects.create(
             name=uuid,
-            type='project.dsym',
+            type='%s.dsym' % (project and 'project' or 'global'),
             headers={
                 'Content-Type': 'application/x-mach-binary'
             },
