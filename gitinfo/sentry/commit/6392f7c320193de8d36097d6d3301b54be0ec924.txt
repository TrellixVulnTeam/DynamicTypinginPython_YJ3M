commit 6392f7c320193de8d36097d6d3301b54be0ec924
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Thu Mar 8 11:58:08 2018 -0800

    fix(environments): Make sure UI sends environment:null for All Environments (#7525)
    
    Adding a key to represent all environments since Select2Field doesn't handle a null value properly

diff --git a/src/sentry/static/sentry/app/views/ruleEditor/index.jsx b/src/sentry/static/sentry/app/views/ruleEditor/index.jsx
index 50dac597d5..617ceeb821 100644
--- a/src/sentry/static/sentry/app/views/ruleEditor/index.jsx
+++ b/src/sentry/static/sentry/app/views/ruleEditor/index.jsx
@@ -20,6 +20,8 @@ import PanelBody from '../settings/components/panelBody';
 import PanelHeader from '../settings/components/panelHeader';
 import RuleNodeList from './ruleNodeList';
 
+const ALL_ENVIRONMENTS_KEY = '__all_environments__';
+
 const FREQUENCY_CHOICES = [
   ['5', t('5 minutes')],
   ['10', t('10 minutes')],
@@ -158,7 +160,7 @@ const RuleEditor = createReactClass({
 
   handleEnvironmentChange(val) {
     // If 'All Environments' is selected the value should be null
-    if (val === 'all') {
+    if (val === ALL_ENVIRONMENTS_KEY) {
       this.handleChange('environment', null);
     } else {
       this.handleChange('environment', val);
@@ -176,14 +178,17 @@ const RuleEditor = createReactClass({
   render() {
     const activeEnvs = EnvironmentStore.getActive() || [];
     const environmentChoices = [
-      ['all', t('All Environments')],
+      [ALL_ENVIRONMENTS_KEY, t('All Environments')],
       ...activeEnvs.map(env => [env.name, env.displayName]),
     ];
 
     if (!this.state.rule) return <LoadingIndicator />;
 
     const {rule, loading, error} = this.state;
-    const {actionMatch, actions, conditions, frequency, name, environment} = rule;
+    const {actionMatch, actions, conditions, frequency, name} = rule;
+
+    const environment =
+      rule.environment === null ? ALL_ENVIRONMENTS_KEY : rule.environment;
 
     return (
       <form onSubmit={this.onSubmit} ref={node => (this.formNode = node)}>
diff --git a/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap b/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
index 6d3ef7f03c..f8cb52d367 100644
--- a/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/projectAlertRuleDetails.spec.jsx.snap
@@ -386,7 +386,7 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
                     choices={
                       Array [
                         Array [
-                          "all",
+                          "__all_environments__",
                           "All Environments",
                         ],
                       ]
@@ -432,8 +432,8 @@ exports[`ProjectAlertRuleDetails Edit alert rule renders 1`] = `
                           value=""
                         >
                           <option
-                            key="all"
-                            value="all"
+                            key="__all_environments__"
+                            value="__all_environments__"
                           >
                             All Environments
                           </option>
@@ -1074,7 +1074,7 @@ exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
                     choices={
                       Array [
                         Array [
-                          "all",
+                          "__all_environments__",
                           "All Environments",
                         ],
                       ]
@@ -1120,8 +1120,8 @@ exports[`ProjectAlertRuleDetails New alert rule renders 1`] = `
                           value=""
                         >
                           <option
-                            key="all"
-                            value="all"
+                            key="__all_environments__"
+                            value="__all_environments__"
                           >
                             All Environments
                           </option>
