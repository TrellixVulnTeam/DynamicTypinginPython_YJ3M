commit 7908d3695b685ed5604f0c3e88e446f59da1957b
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Fri Dec 15 11:22:57 2017 -0800

    fix: Get/create security token in lock

diff --git a/src/sentry/models/project.py b/src/sentry/models/project.py
index 002c7918da..ba3eb0602e 100644
--- a/src/sentry/models/project.py
+++ b/src/sentry/models/project.py
@@ -317,9 +317,13 @@ class Project(Model):
             return True
 
     def get_security_token(self):
-        # TODO(dcramer): this update should happen within a lock
-        security_token = self.get_option('sentry:token', None)
-        if security_token is None:
-            security_token = uuid1().hex
-            self.update_option('sentry:token', security_token)
-        return security_token
+        lock = locks.get(self.get_lock_key(), duration=5)
+        with TimedRetryPolicy(10)(lock.acquire):
+            security_token = self.get_option('sentry:token', None)
+            if security_token is None:
+                security_token = uuid1().hex
+                self.update_option('sentry:token', security_token)
+            return security_token
+
+    def get_lock_key(self):
+        return 'project_token:%s' % self.id
