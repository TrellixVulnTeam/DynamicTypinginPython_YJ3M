commit 6d817f75f1a25a55f0334bf1eddfcd618cd5c6d2
Author: Megan Heskett <meg.heskett@gmail.com>
Date:   Thu Nov 7 11:33:09 2019 -0800

    Add invite modal to teams dropdown (#15472)

diff --git a/src/sentry/static/sentry/app/views/settings/organizationTeams/teamMembers.jsx b/src/sentry/static/sentry/app/views/settings/organizationTeams/teamMembers.jsx
index b4a7319dee..ea8e3b7e37 100644
--- a/src/sentry/static/sentry/app/views/settings/organizationTeams/teamMembers.jsx
+++ b/src/sentry/static/sentry/app/views/settings/organizationTeams/teamMembers.jsx
@@ -1,3 +1,4 @@
+import {browserHistory} from 'react-router';
 import {debounce} from 'lodash';
 import PropTypes from 'prop-types';
 import React from 'react';
@@ -6,6 +7,7 @@ import styled from 'react-emotion';
 import {Panel, PanelHeader} from 'app/components/panels';
 import {addErrorMessage, addSuccessMessage} from 'app/actionCreators/indicator';
 import {joinTeam, leaveTeam} from 'app/actionCreators/teams';
+import {openInviteMembersModal} from 'app/actionCreators/modal';
 import {t} from 'app/locale';
 import Avatar from 'app/components/avatar';
 import Button from 'app/components/button';
@@ -197,6 +199,17 @@ class TeamMembers extends React.Component {
     this.debouncedFetchMembersRequest(e.target.value);
   };
 
+  get hasInviteRequestExperiment() {
+    const {organization} = this.props;
+
+    if (!organization || !organization.experiments) {
+      return false;
+    }
+
+    const variant = organization.experiments.ImprovedInvitesExperiment;
+    return variant === 'all' || variant === 'invite_request';
+  }
+
   renderDropdown = access => {
     const {params} = this.props;
 
@@ -238,8 +251,17 @@ class TeamMembers extends React.Component {
     const menuHeader = (
       <StyledMembersLabel>
         {t('Members')}
-        <StyledCreateMemberLink to={`/settings/${params.orgId}/members/new/`}>
-          {t('Add Member')}
+        <StyledCreateMemberLink
+          onClick={() =>
+            this.hasInviteRequestExperiment
+              ? openInviteMembersModal({source: 'teams'})
+              : browserHistory.push(
+                  `/settings/${params.orgId}/members/new/?referrer=teams`
+                )
+          }
+          data-test-id="invite-member"
+        >
+          {t('Invite Member')}
         </StyledCreateMemberLink>
       </StyledMembersLabel>
     );
@@ -255,7 +277,7 @@ class TeamMembers extends React.Component {
         onClose={() => this.debouncedFetchMembersRequest('')}
       >
         {({isOpen}) => (
-          <DropdownButton isOpen={isOpen} size="xsmall">
+          <DropdownButton isOpen={isOpen} size="xsmall" data-test-id="add-member">
             {t('Add Member')}
           </DropdownButton>
         )}
diff --git a/tests/js/spec/views/teamMembers.spec.jsx b/tests/js/spec/views/teamMembers.spec.jsx
index ac82290dd1..f3a8f563aa 100644
--- a/tests/js/spec/views/teamMembers.spec.jsx
+++ b/tests/js/spec/views/teamMembers.spec.jsx
@@ -1,10 +1,16 @@
 import React from 'react';
+import {browserHistory} from 'react-router';
 
 import {Client} from 'app/api';
 import {initializeOrg} from 'sentry-test/initializeOrg';
 import {mountWithTheme} from 'sentry-test/enzyme';
+import {openInviteMembersModal} from 'app/actionCreators/modal';
 import TeamMembers from 'app/views/settings/organizationTeams/teamMembers';
 
+jest.mock('app/actionCreators/modal', () => ({
+  openInviteMembersModal: jest.fn(),
+}));
+
 describe('TeamMembers', function() {
   const {organization, routerContext} = initializeOrg();
   const team = TestStubs.Team();
@@ -36,6 +42,48 @@ describe('TeamMembers', function() {
     wrapper.update();
   });
 
+  it('can invite member from team dropdown', async function() {
+    const wrapper = mountWithTheme(
+      <TeamMembers
+        params={{orgId: organization.slug, teamId: team.slug}}
+        organization={organization}
+      />,
+      routerContext
+    );
+
+    await tick();
+    wrapper.update();
+
+    wrapper.find('DropdownButton[data-test-id="add-member"]').simulate('click');
+    wrapper
+      .find('StyledCreateMemberLink[data-test-id="invite-member"]')
+      .simulate('click');
+
+    expect(browserHistory.push).toHaveBeenCalledWith(
+      `/settings/${organization.slug}/members/new/?referrer=teams`
+    );
+  });
+
+  it('can open invite modal on invite member with experiment', async function() {
+    const org = TestStubs.Organization({
+      experiments: {ImprovedInvitesExperiment: 'invite_request'},
+    });
+    const wrapper = mountWithTheme(
+      <TeamMembers params={{orgId: org.slug, teamId: team.slug}} organization={org} />,
+      routerContext
+    );
+
+    await tick();
+    wrapper.update();
+
+    wrapper.find('DropdownButton[data-test-id="add-member"]').simulate('click');
+    wrapper
+      .find('StyledCreateMemberLink[data-test-id="invite-member"]')
+      .simulate('click');
+
+    expect(openInviteMembersModal).toHaveBeenCalled();
+  });
+
   it('can remove member from team', async function() {
     const endpoint = `/organizations/${organization.slug}/members/${
       members[0].id
