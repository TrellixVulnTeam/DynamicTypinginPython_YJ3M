commit e718bba9a873ac2e01452ceaeeb2b1756eb6dc7f
Author: David Cramer <dcramer@David-Cramers-MacBook.local>
Date:   Wed Mar 31 20:21:03 2010 -0500

    Fix for a race condition with times_seen (non-critical)

diff --git a/djangodblog/manager.py b/djangodblog/manager.py
index 1eb31944eb..977191594d 100644
--- a/djangodblog/manager.py
+++ b/djangodblog/manager.py
@@ -55,10 +55,19 @@ class DBLogManager(models.Manager):
                 defaults = defaults
             )
             if not created:
-                batch.times_seen += 1
-                batch.status = 0
-                batch.last_seen = datetime.datetime.now()
-                batch.save()
+                # This creates a race condition:
+                #
+                # batch.times_seen += 1
+                # batch.status = 0
+                # batch.last_seen = datetime.datetime.now()
+                # batch.save()
+                #
+                # So instead we use the update method
+                ErrorBatch.objects.filter(pk=batch.pk).update(
+                    times_seen=models.F('times_seen') + 1,
+                    status=0,
+                    last_seen=datetime.datetime.now(),
+                )
         except Exception, exc:
             warnings.warn(smart_unicode(exc))
         else:
