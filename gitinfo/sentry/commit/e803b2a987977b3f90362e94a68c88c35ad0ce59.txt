commit e803b2a987977b3f90362e94a68c88c35ad0ce59
Author: Markus Unterwaditzer <markus@unterwaditzer.net>
Date:   Mon Apr 15 14:55:43 2019 +0200

    fix: Update symbolicator snapshots (#12710)
    
    * fix: Update symbolicator snapshots
    
    * feat: Add warnings and comments for running symbolicator on mac
    
    * fix: Add debug_meta and images to all snapshots
    
    * fix: Make host.docker.internal just the default for OSX, remove warning from devservices
    
    * fix: Broken import
    
    * fix: Do not use DEBUG flag
    
    * fix: Add contexts to snapshots
    
    * fix: Update snapshots
    
    * fix: Add errors

diff --git a/src/sentry/lang/native/symbolicator.py b/src/sentry/lang/native/symbolicator.py
index b8106a7d1d..992caf2b3f 100644
--- a/src/sentry/lang/native/symbolicator.py
+++ b/src/sentry/lang/native/symbolicator.py
@@ -1,5 +1,6 @@
 from __future__ import absolute_import
 
+import sys
 import jsonschema
 import logging
 import six
@@ -104,8 +105,13 @@ def get_internal_source(project):
     """
     Returns the source configuration for a Sentry project.
     """
-    internal_url_prefix = options.get('system.internal-url-prefix') \
-        or options.get('system.url-prefix')
+    internal_url_prefix = options.get('system.internal-url-prefix')
+    if not internal_url_prefix:
+        internal_url_prefix = options.get('system.url-prefix')
+        if sys.platform == 'darwin':
+            internal_url_prefix = internal_url_prefix \
+                .replace("localhost", "host.docker.internal") \
+                .replace("127.0.0.1", "host.docker.internal")
 
     assert internal_url_prefix
     sentry_source_url = '%s%s' % (
diff --git a/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
index 8661578b98..523f0d75b5 100644
--- a/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_debug_id_resolving.pysnap
@@ -1,5 +1,5 @@
 ---
-created: '2019-04-02T14:12:16.040240Z'
+created: '2019-04-15T09:43:14.321187Z'
 creator: sentry
 source: tests/symbolicator/test_native_plugin.py
 ---
@@ -12,7 +12,6 @@ contexts:
     name: Windows
     type: os
     version: 10.0.14393
-culprit: main
 debug_meta:
   images:
   - code_file: C:\projects\breakpad-tools\windows\Release\crash.exe
@@ -40,36 +39,5 @@ exception:
     thread_id: 1636
     type: EXCEPTION_ACCESS_VIOLATION_WRITE
     value: 'Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
-fingerprint:
-- '{{ default }}'
-grouping_config:
-  id: legacy:2019-03-12
-hashes:
-- ffe48bfc93b1bf86ffb750d5d2bdc51a
-level: error
-location: main.cpp
-logger: ''
-metadata:
-  filename: main.cpp
-  function: main
-  type: EXCEPTION_ACCESS_VIOLATION_WRITE
-  value: 'Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
-platform: native
-sdk:
-  name: _postWithHeader
-  version: 0.0.0
-tags:
-- - level
-  - error
-- - sentry:user
-  - ip:127.0.0.1
-- - os
-  - Windows 10.0.14393
-- - os.name
-  - Windows
-title: 'EXCEPTION_ACCESS_VIOLATION_WRITE: Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
-type: error
-use_rust_normalize: true
-user:
-  ip_address: 127.0.0.1
-version: '6'
+stacktrace: null
+threads: null
diff --git a/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
index 8a1bd626b8..0bb6408211 100644
--- a/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_missing_dsym.pysnap
@@ -1,9 +1,9 @@
 ---
-created: '2019-04-02T14:12:16.775814Z'
+created: '2019-04-15T09:43:15.116901Z'
 creator: sentry
 source: tests/symbolicator/test_native_plugin.py
 ---
-culprit: unknown
+contexts: null
 debug_meta:
   images:
   - arch: x86_64
@@ -18,12 +18,6 @@ debug_meta:
     version_major: 10
     version_minor: 12
     version_patchlevel: 4
-errors:
-- image_arch: x86_64
-  image_path: Foo.app/Contents/Foo
-  image_uuid: 502fc0a5-1ec1-3e47-9998-684fa139dca7
-  message: None
-  type: native_missing_dsym
 exception:
   values:
   - raw_stacktrace:
@@ -37,41 +31,5 @@ exception:
       - *id001
     type: Fail
     value: fail
-fingerprint:
-- '{{ default }}'
-grouping_config:
-  id: legacy:2019-03-12
-hashes:
-- efca000ff6704f25e5434e9ed7eff02f
-level: error
-location: null
-logger: ''
-metadata:
-  type: Fail
-  value: fail
-platform: cocoa
-processing_issues:
-  native:dsym:502fc0a5-1ec1-3e47-9998-684fa139dca7:
-    data:
-      image_arch: x86_64
-      image_path: Foo.app/Contents/Foo
-      image_uuid: 502fc0a5-1ec1-3e47-9998-684fa139dca7
-      message: None
-      type: native_missing_dsym
-    object: dsym:502fc0a5-1ec1-3e47-9998-684fa139dca7
-    scope: native
-    type: native_missing_dsym
-sdk:
-  name: _postWithHeader
-  version: 0.0.0
-tags:
-- - level
-  - error
-- - sentry:user
-  - ip:127.0.0.1
-title: 'Fail: fail'
-type: error
-use_rust_normalize: true
-user:
-  ip_address: 127.0.0.1
-version: '6'
+stacktrace: null
+threads: null
diff --git a/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
index b984a7eabb..e2888c5f1a 100644
--- a/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicResolvingIntegrationTest/test_real_resolving.pysnap
@@ -1,9 +1,9 @@
 ---
-created: '2019-04-02T14:12:17.205926Z'
+created: '2019-04-15T09:43:15.764548Z'
 creator: sentry
 source: tests/symbolicator/test_native_plugin.py
 ---
-culprit: main
+contexts: null
 debug_meta:
   images:
   - arch: x86_64
@@ -36,32 +36,5 @@ exception:
         package: Foo.app/Contents/Foo
     type: Fail
     value: fail
-fingerprint:
-- '{{ default }}'
-grouping_config:
-  id: legacy:2019-03-12
-hashes:
-- 6e2889ec15f82569f56fdba9ffc9b90b
-level: error
-location: hello.c
-logger: ''
-metadata:
-  filename: hello.c
-  function: main
-  type: Fail
-  value: fail
-platform: cocoa
-sdk:
-  name: _postWithHeader
-  version: 0.0.0
-tags:
-- - level
-  - error
-- - sentry:user
-  - ip:127.0.0.1
-title: 'Fail: fail'
-type: error
-use_rust_normalize: true
-user:
-  ip_address: 127.0.0.1
-version: '6'
+stacktrace: null
+threads: null
diff --git a/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
index ec9262c803..a93f862bc4 100644
--- a/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_debug_id_resolving.pysnap
@@ -1,5 +1,5 @@
 ---
-created: '2019-04-08T15:19:10.243455Z'
+created: '2019-04-15T11:04:01.534478Z'
 creator: sentry
 source: tests/symbolicator/test_native_plugin.py
 ---
@@ -12,7 +12,6 @@ contexts:
     name: Windows
     type: os
     version: 10.0.14393
-culprit: main
 debug_meta:
   images:
   - arch: x86
@@ -21,6 +20,7 @@ debug_meta:
     image_addr: '0x2a0000'
     image_size: 36864
     type: symbolic
+errors: null
 exception:
   values:
   - raw_stacktrace:
@@ -42,36 +42,5 @@ exception:
     thread_id: 1636
     type: EXCEPTION_ACCESS_VIOLATION_WRITE
     value: 'Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
-fingerprint:
-- '{{ default }}'
-grouping_config:
-  id: legacy:2019-03-12
-hashes:
-- ffe48bfc93b1bf86ffb750d5d2bdc51a
-level: error
-location: main.cpp
-logger: ''
-metadata:
-  filename: main.cpp
-  function: main
-  type: EXCEPTION_ACCESS_VIOLATION_WRITE
-  value: 'Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
-platform: native
-sdk:
-  name: _postWithHeader
-  version: 0.0.0
-tags:
-- - level
-  - error
-- - sentry:user
-  - ip:127.0.0.1
-- - os
-  - Windows 10.0.14393
-- - os.name
-  - Windows
-title: 'EXCEPTION_ACCESS_VIOLATION_WRITE: Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
-type: error
-use_rust_normalize: true
-user:
-  ip_address: 127.0.0.1
-version: '6'
+stacktrace: null
+threads: null
diff --git a/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
index 978adbd8ca..c5391a5070 100644
--- a/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_missing_dsym.pysnap
@@ -1,9 +1,9 @@
 ---
-created: '2019-04-08T15:19:12.541376Z'
+created: '2019-04-15T11:04:03.933068Z'
 creator: sentry
 source: tests/symbolicator/test_native_plugin.py
 ---
-culprit: unknown
+contexts: null
 debug_meta:
   images:
   - arch: x86_64
@@ -38,41 +38,5 @@ exception:
         instruction_addr: '0x100000fa0'
     type: Fail
     value: fail
-fingerprint:
-- '{{ default }}'
-grouping_config:
-  id: legacy:2019-03-12
-hashes:
-- efca000ff6704f25e5434e9ed7eff02f
-level: error
-location: null
-logger: ''
-metadata:
-  type: Fail
-  value: fail
-platform: cocoa
-processing_issues:
-  native:dsym:502fc0a5-1ec1-3e47-9998-684fa139dca7:
-    data:
-      image_arch: x86_64
-      image_path: Foo.app/Contents/Foo
-      image_uuid: 502fc0a5-1ec1-3e47-9998-684fa139dca7
-      message: None
-      type: native_missing_dsym
-    object: dsym:502fc0a5-1ec1-3e47-9998-684fa139dca7
-    scope: native
-    type: native_missing_dsym
-sdk:
-  name: _postWithHeader
-  version: 0.0.0
-tags:
-- - level
-  - error
-- - sentry:user
-  - ip:127.0.0.1
-title: 'Fail: fail'
-type: error
-use_rust_normalize: true
-user:
-  ip_address: 127.0.0.1
-version: '6'
+stacktrace: null
+threads: null
diff --git a/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
index c39680c353..cd941985a4 100644
--- a/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
+++ b/tests/symbolicator/snapshots/SymbolicatorResolvingIntegrationTest/test_real_resolving.pysnap
@@ -1,9 +1,9 @@
 ---
-created: '2019-04-08T15:19:14.494425Z'
+created: '2019-04-15T11:04:06.116525Z'
 creator: sentry
 source: tests/symbolicator/test_native_plugin.py
 ---
-culprit: main
+contexts: null
 debug_meta:
   images:
   - arch: x86_64
@@ -18,6 +18,7 @@ debug_meta:
     version_major: 10
     version_minor: 12
     version_patchlevel: 4
+errors: null
 exception:
   values:
   - raw_stacktrace:
@@ -37,32 +38,5 @@ exception:
         symbol: main
     type: Fail
     value: fail
-fingerprint:
-- '{{ default }}'
-grouping_config:
-  id: legacy:2019-03-12
-hashes:
-- 6e2889ec15f82569f56fdba9ffc9b90b
-level: error
-location: hello.c
-logger: ''
-metadata:
-  filename: hello.c
-  function: main
-  type: Fail
-  value: fail
-platform: cocoa
-sdk:
-  name: _postWithHeader
-  version: 0.0.0
-tags:
-- - level
-  - error
-- - sentry:user
-  - ip:127.0.0.1
-title: 'Fail: fail'
-type: error
-use_rust_normalize: true
-user:
-  ip_address: 127.0.0.1
-version: '6'
+stacktrace: null
+threads: null
diff --git a/tests/symbolicator/test_native_plugin.py b/tests/symbolicator/test_native_plugin.py
index 664da1deea..ae95a1362c 100644
--- a/tests/symbolicator/test_native_plugin.py
+++ b/tests/symbolicator/test_native_plugin.py
@@ -1091,6 +1091,16 @@ class InAppHonoringResolvingIntegrationTest(TestCase):
 
 
 class ResolvingIntegrationTestBase(object):
+    def snapshot_stacktrace_data(self, event):
+        self.insta_snapshot({
+            "stacktrace": event.get('stacktrace'),
+            "exception": event.get('exception'),
+            "threads": event.get('threads'),
+            "debug_meta": event.get('debug_meta'),
+            "contexts": event.get('contexts'),
+            "errors": event.get('errors'),
+        })
+
     def test_real_resolving(self):
         url = reverse(
             'sentry-api-0-dsym-files',
@@ -1123,13 +1133,7 @@ class ResolvingIntegrationTestBase(object):
 
         event = Event.objects.get()
         assert event.data['culprit'] == 'main'
-        snapshot_data = dict(event.data)
-        del snapshot_data['event_id']
-        del snapshot_data['timestamp']
-        del snapshot_data['received']
-        del snapshot_data['key_id']
-        del snapshot_data['project']
-        self.insta_snapshot(snapshot_data)
+        self.snapshot_stacktrace_data(event.data)
 
     def test_debug_id_resolving(self):
         file = File.objects.create(
@@ -1198,13 +1202,7 @@ class ResolvingIntegrationTestBase(object):
 
         event = Event.objects.get()
         assert event.data['culprit'] == 'main'
-        snapshot_data = dict(event.data)
-        del snapshot_data['event_id']
-        del snapshot_data['timestamp']
-        del snapshot_data['received']
-        del snapshot_data['key_id']
-        del snapshot_data['project']
-        self.insta_snapshot(snapshot_data)
+        self.snapshot_stacktrace_data(event.data)
 
     def test_missing_dsym(self):
         self.login_as(user=self.user)
@@ -1214,13 +1212,7 @@ class ResolvingIntegrationTestBase(object):
 
         event = Event.objects.get()
         assert event.data['culprit'] == 'unknown'
-        snapshot_data = dict(event.data)
-        del snapshot_data['event_id']
-        del snapshot_data['timestamp']
-        del snapshot_data['received']
-        del snapshot_data['key_id']
-        del snapshot_data['project']
-        self.insta_snapshot(snapshot_data)
+        self.snapshot_stacktrace_data(event.data)
 
 
 class SymbolicResolvingIntegrationTest(ResolvingIntegrationTestBase, TestCase):
@@ -1320,13 +1312,18 @@ class SymbolicResolvingIntegrationTest(ResolvingIntegrationTestBase, TestCase):
 
 
 class SymbolicatorResolvingIntegrationTest(ResolvingIntegrationTestBase, TransactionTestCase):
+    # For these tests to run, write `symbolicator.enabled: true` into your
+    # `~/.sentry/config.yml` and run `sentry devservices up`
+
     @pytest.fixture(autouse=True)
     def initialize(self, live_server):
+        new_prefix = live_server.url
+
         with patch('sentry.lang.native.symbolizer.Symbolizer._symbolize_app_frame') \
             as symbolize_app_frame, \
                 patch('sentry.lang.native.plugin._is_symbolicator_enabled', return_value=True), \
                 patch('sentry.auth.system.is_internal_ip', return_value=True), \
-                self.options({"system.url-prefix": live_server.url}):
+                self.options({"system.url-prefix": new_prefix}):
 
             # Run test case:
             yield
