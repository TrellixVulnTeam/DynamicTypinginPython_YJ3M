commit eb5a70df32b45e08519d33e3e75c1eca5706602c
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Sep 11 11:40:37 2015 -0500

    Restrict tagkey query to last 10,000 based on frequency

diff --git a/src/sentry/api/endpoints/project_tagkey_values.py b/src/sentry/api/endpoints/project_tagkey_values.py
index 364ed90c44..cefffa6b64 100644
--- a/src/sentry/api/endpoints/project_tagkey_values.py
+++ b/src/sentry/api/endpoints/project_tagkey_values.py
@@ -38,18 +38,25 @@ class ProjectTagKeyValuesEndpoint(ProjectEndpoint):
         except TagKey.DoesNotExist:
             raise ResourceDoesNotExist
 
-        queryset = TagValue.objects.filter(
-            project=project,
-            key=tagkey.key,
-        )
-
         query = request.GET.get('query')
         if query:
-            queryset = queryset.filter(value__istartswith=query)
+            # not quite optimal, but best we can do with ORM
+            queryset = TagValue.objects.filter(
+                id__in=TagValue.objects.filter(
+                    project=project,
+                    key=tagkey.key,
+                ).order_by('-times_seen')[:10000]
+            ).filter(value__istartswith=query)
+
+        else:
+            queryset = TagValue.objects.filter(
+                project=project,
+                key=tagkey.key,
+            )
 
         return self.paginate(
             request=request,
             queryset=queryset,
-            order_by='-id',
+            order_by='-times_seen',
             on_results=lambda x: serialize(x, request.user),
         )
