commit 0705c5c80e529302675eaa638ac9e940430c75d0
Author: Daniel Griesser <daniel.griesser.86@gmail.com>
Date:   Fri Jul 26 17:23:39 2019 +0200

    feat: Update frontend spans, Use new SDK version (#14162)
    
    * feat: Update frontend spans, Use new SDK version
    
    * fix: JS tests

diff --git a/package.json b/package.json
index ee91fc6ba0..d8444b90af 100644
--- a/package.json
+++ b/package.json
@@ -18,8 +18,8 @@
     "@babel/preset-react": "^7.0.0",
     "@babel/preset-typescript": "^7.3.3",
     "@babel/runtime": "^7.0.0",
-    "@sentry/browser": "5.6.0-beta.1",
-    "@sentry/integrations": "5.6.0-beta.1",
+    "@sentry/browser": "5.6.0-beta.4",
+    "@sentry/integrations": "5.6.0-beta.4",
     "@sentry/typescript": "^5.3.0",
     "@types/lodash": "^4.14.134",
     "@types/moment-timezone": "^0.5.12",
diff --git a/src/sentry/static/sentry/app/api.jsx b/src/sentry/static/sentry/app/api.jsx
index 0a46e102d9..2cf6e0d9c8 100644
--- a/src/sentry/static/sentry/app/api.jsx
+++ b/src/sentry/static/sentry/app/api.jsx
@@ -170,15 +170,6 @@ export class Client {
       data = JSON.stringify(data);
     }
 
-    const hub = Sentry.getCurrentHub();
-    const requestSpan = hub.startSpan({
-      data: {
-        request_data: data,
-      },
-      op: 'http',
-      description: `${method} ${path}`,
-    });
-
     let query;
     try {
       query = $.param(options.query || [], true);
@@ -208,6 +199,14 @@ export class Client {
       }
     }
 
+    const requestSpan = Sentry.startSpan({
+      data: {
+        request_data: data,
+      },
+      op: 'http',
+      description: `${method} ${fullUrl}`,
+    });
+
     const errorObject = new Error();
 
     this.activeRequests[id] = new Request(
@@ -271,7 +270,7 @@ export class Client {
           );
         },
         complete: (...args) => {
-          hub.finishSpan(requestSpan);
+          Sentry.finishSpan(requestSpan);
           return this.wrapCallback(id, options.complete, true)(...args);
         },
       })
diff --git a/src/sentry/static/sentry/app/bootstrap.jsx b/src/sentry/static/sentry/app/bootstrap.jsx
index 9837fe8b94..864c58a472 100644
--- a/src/sentry/static/sentry/app/bootstrap.jsx
+++ b/src/sentry/static/sentry/app/bootstrap.jsx
@@ -74,14 +74,6 @@ if (
         config.urlPrefix.includes('127.0.0.1') ||
         config.urlPrefix.includes('dev.getsentry.net'))))
 ) {
-  Sentry.configureScope(scope => {
-    scope.setSpan(
-      Sentry.getCurrentHub().startSpan({
-        op: 'pageload',
-        sampled: true,
-      })
-    );
-  });
   startApm();
 }
 // -----------------------------------------------------------------
diff --git a/src/sentry/static/sentry/app/utils/apm.jsx b/src/sentry/static/sentry/app/utils/apm.jsx
index 6fd355dd37..217f2bbfc4 100644
--- a/src/sentry/static/sentry/app/utils/apm.jsx
+++ b/src/sentry/static/sentry/app/utils/apm.jsx
@@ -1,18 +1,15 @@
 import * as Router from 'react-router';
 import * as Sentry from '@sentry/browser';
 
-let flushTransactionTimeout = undefined;
 let firstPageLoad = true;
 
 function startTransaction() {
   // We do set the transaction name in the router but we want to start it here
   // since in the App component where we set the transaction name, it's called multiple
   // times. This would result in losing the start of the transaction.
-  let transactionSpan;
   const hub = Sentry.getCurrentHub();
   hub.configureScope(scope => {
     if (firstPageLoad) {
-      transactionSpan = scope.getSpan();
       firstPageLoad = false;
     } else {
       const prevTransactionSpan = scope.getSpan();
@@ -20,26 +17,35 @@ function startTransaction() {
       if (prevTransactionSpan && prevTransactionSpan.timestamp === undefined) {
         hub.finishSpan(prevTransactionSpan);
       }
-      transactionSpan = hub.startSpan({
-        op: 'navigation',
-        sampled: true,
-      });
+      Sentry.startSpan(
+        {
+          op: 'navigation',
+          sampled: true,
+        },
+        true
+      );
     }
-    scope.setSpan(transactionSpan);
   });
 
+  finishTransaction(5000);
+}
+
+let flushTransactionTimeout = undefined;
+function finishTransaction(delay) {
   if (flushTransactionTimeout) {
     clearTimeout(flushTransactionTimeout);
   }
-
-  flushTransactionTimeout = setTimeout(() => {
-    hub.finishSpan(transactionSpan);
-  }, 5000);
+  flushTransactionTimeout = setTimeout(() => Sentry.finishSpan(), delay || 5000);
 }
 
 export function startApm() {
+  Sentry.startSpan(
+    {
+      op: 'pageload',
+      sampled: true,
+    },
+    true
+  );
   startTransaction();
-  Router.browserHistory.listen(() => {
-    startTransaction();
-  });
+  Router.browserHistory.listen(() => startTransaction());
 }
diff --git a/tests/js/setup.js b/tests/js/setup.js
index 38b60f4a82..1652c25f9f 100644
--- a/tests/js/setup.js
+++ b/tests/js/setup.js
@@ -111,6 +111,8 @@ jest.mock('@sentry/browser', () => {
     captureMessage: jest.fn(),
     captureException: jest.fn(),
     showReportDialog: jest.fn(),
+    startSpan: jest.fn(),
+    finishSpan: jest.fn(),
     lastEventId: jest.fn(),
     getCurrentHub: jest.spyOn(SentryBrowser, 'getCurrentHub'),
     withScope: jest.spyOn(SentryBrowser, 'withScope'),
diff --git a/yarn.lock b/yarn.lock
index 116208673b..191c9a0cac 100644
--- a/yarn.lock
+++ b/yarn.lock
@@ -1182,58 +1182,58 @@
     hey-listen "^1.0.8"
     style-value-types "^3.1.4"
 
-"@sentry/browser@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/browser/-/browser-5.6.0-beta.1.tgz#96da9be0a19ad31b390f2c6793f9f6c84c11c10b"
-  integrity sha512-tLVLbshEakc22bpRidX0zlHsqdaGaXIBXKFtnhanjdKlBgWn0lfydzUBJW7GIhce3e0UEXDORfYMBlC6kObC6A==
-  dependencies:
-    "@sentry/core" "5.6.0-beta.1"
-    "@sentry/types" "5.6.0-beta.1"
-    "@sentry/utils" "5.6.0-beta.1"
+"@sentry/browser@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/browser/-/browser-5.6.0-beta.4.tgz#1f1f12a63c30dbecb63cda6c84dffb0e2684c778"
+  integrity sha512-7u06iH5gKpK2duloRVY+yId0xL+++dnM1Su65uvM3V0ubmv3+HyCqe2wXuSCi6M2NGt9GTWB7yRUw3OCooGlRw==
+  dependencies:
+    "@sentry/core" "5.6.0-beta.4"
+    "@sentry/types" "5.6.0-beta.4"
+    "@sentry/utils" "5.6.0-beta.4"
     tslib "^1.9.3"
 
-"@sentry/core@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/core/-/core-5.6.0-beta.1.tgz#879eae9072fbb579a65351851889217c8f4c03af"
-  integrity sha512-LVSHT2QJgiqhKH0bj2DxBCAOuYQsEkDRQDv7X5Zq4pEEMrihpOD6gWDBhHJRSyDGogstU9DxlnTJ97sIQhE64w==
+"@sentry/core@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/core/-/core-5.6.0-beta.4.tgz#a75271896cc6973c61ccc8bc138c59301e69bf72"
+  integrity sha512-Xq09gz+/G26xOEKOmXPp+s0VIj6IR2DQ7lXxxqfUGjAtdFzkHMk3RrukznFvc8Sdp2ZgD3z1zrSwx+2poKYbqw==
   dependencies:
-    "@sentry/hub" "5.6.0-beta.1"
-    "@sentry/minimal" "5.6.0-beta.1"
-    "@sentry/types" "5.6.0-beta.1"
-    "@sentry/utils" "5.6.0-beta.1"
+    "@sentry/hub" "5.6.0-beta.4"
+    "@sentry/minimal" "5.6.0-beta.4"
+    "@sentry/types" "5.6.0-beta.4"
+    "@sentry/utils" "5.6.0-beta.4"
     tslib "^1.9.3"
 
-"@sentry/hub@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/hub/-/hub-5.6.0-beta.1.tgz#ffb094569bde4402ff95be0b077a3673cf18e00a"
-  integrity sha512-CGrnYoAi7bDdupTrK71NB/k0C+xx+jT8BXXvxe8KV/4PoxEhm8kA1LjUdvMFp2ZGZi2jlrjIjLBlTQMT9X9MPg==
+"@sentry/hub@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/hub/-/hub-5.6.0-beta.4.tgz#69db4c5753f49e002fb9d3d068ef2b67a6f947cb"
+  integrity sha512-ShtUkmLVf5vSTTgvAZ5MCQdDBe+Y3H0rxqndF2PNwZwK1ozpgpHAbzn8CKbLq65oYYMk6W30PCrhOtHHvFtA2A==
   dependencies:
-    "@sentry/types" "5.6.0-beta.1"
-    "@sentry/utils" "5.6.0-beta.1"
+    "@sentry/types" "5.6.0-beta.4"
+    "@sentry/utils" "5.6.0-beta.4"
     tslib "^1.9.3"
 
-"@sentry/integrations@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/integrations/-/integrations-5.6.0-beta.1.tgz#7ccadd89525920a2b7d8119bad71bb6b164cebec"
-  integrity sha512-n6cebuKgNaPd7CLb1LuoB2pBE6BQ2YeufhTJ9UhURADJ5j2W4/lSh7q3mf85BXxsAVvO8up209WmQeuig0Fo3Q==
+"@sentry/integrations@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/integrations/-/integrations-5.6.0-beta.4.tgz#0d4cc40d1191c4f3b9f68f1fa20a0caa5611186a"
+  integrity sha512-D0f7sVP3DQ/4OXmoCg4t7BSOUPeSZrageShfYH4/i8RGP5qMnucyZ1yJQnga59xF1hJ9mpdDiKmtXxN5gmaNcQ==
   dependencies:
-    "@sentry/types" "5.6.0-beta.1"
-    "@sentry/utils" "5.6.0-beta.1"
+    "@sentry/types" "5.6.0-beta.4"
+    "@sentry/utils" "5.6.0-beta.4"
     tslib "^1.9.3"
 
-"@sentry/minimal@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/minimal/-/minimal-5.6.0-beta.1.tgz#d783515f53d7f8fd5ab09048f3559fc6a4cdcd28"
-  integrity sha512-M+jpyCyHJXGZBWndfzR1ScmpFUmXeC8l/VkQXwqNMyyxfO+9LbFJg5sbHxm/zCFXK6ESpi7hM/zOosVUQAzrpw==
+"@sentry/minimal@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/minimal/-/minimal-5.6.0-beta.4.tgz#1066556b0768fc65f3e8345b0174e4443e94540b"
+  integrity sha512-Iju4VhRIhaiFgXYI8/ZyS4YcUB/7w3gjgqSYVqVP0ARR8GlG7ZJNzYFz7IIstimVleZDylXKMlwvtqiiJFvLjg==
   dependencies:
-    "@sentry/hub" "5.6.0-beta.1"
-    "@sentry/types" "5.6.0-beta.1"
+    "@sentry/hub" "5.6.0-beta.4"
+    "@sentry/types" "5.6.0-beta.4"
     tslib "^1.9.3"
 
-"@sentry/types@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/types/-/types-5.6.0-beta.1.tgz#516d5ef34b5a1bff898cf564d63bf489b85e9942"
-  integrity sha512-jVII0NE7tppdSIX0EgS6jDYeegox0zTA9az6Cvhd3kpkJy1G9ggFaZxhZu2J1T5hwFuxn/a7o1uDyySmlvzG7w==
+"@sentry/types@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/types/-/types-5.6.0-beta.4.tgz#7ad453fd6969cc38c97c85c4d7e5e1f7588276b2"
+  integrity sha512-YVloNOyyek0Qackamn1kDyFpVTRysj8CBUJwZx774VMtYHMy48Lre2rxz3s1j/XztsaZEqn0nO86aP8DzlNNzg==
 
 "@sentry/typescript@^5.3.0":
   version "5.3.0"
@@ -1243,12 +1243,12 @@
     tslint-config-prettier "^1.18.0"
     tslint-consistent-codestyle "^1.15.1"
 
-"@sentry/utils@5.6.0-beta.1":
-  version "5.6.0-beta.1"
-  resolved "https://registry.yarnpkg.com/@sentry/utils/-/utils-5.6.0-beta.1.tgz#f0d5ea3ce5f9afbd022b9e6136704a3546a4ef4a"
-  integrity sha512-+7WuAA8kChJq35HYQTv30bbeBX0Q3IjZ8xkfPC4yQjDvPmnvNNs/JLqPLeUM5eSZHuWSh2iuNvt1CMGMwrAdBQ==
+"@sentry/utils@5.6.0-beta.4":
+  version "5.6.0-beta.4"
+  resolved "https://registry.yarnpkg.com/@sentry/utils/-/utils-5.6.0-beta.4.tgz#d3e2ffc7487590af7555da836d17f3a19ff07a8d"
+  integrity sha512-ysrXMsbdiB3rogh4sridexazJKZRIJdSYarj8fGMKryPsF7FwvVu8i3VGCz4nmGqxtFhyDDUu0udhxgx9wQhZA==
   dependencies:
-    "@sentry/types" "5.6.0-beta.1"
+    "@sentry/types" "5.6.0-beta.4"
     tslib "^1.9.3"
 
 "@storybook/addon-a11y@^4.1.3":
