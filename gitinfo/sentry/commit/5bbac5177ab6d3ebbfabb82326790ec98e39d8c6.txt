commit 5bbac5177ab6d3ebbfabb82326790ec98e39d8c6
Author: Chris Fuller <chris@iprogramstuff.com>
Date:   Tue Aug 27 17:42:05 2019 -0400

    fix(integrations): Modifying Slack integration to prefer event data over group data (#14464)
    
    Changing Slack integration to prefer event data over group data

diff --git a/src/sentry/integrations/slack/utils.py b/src/sentry/integrations/slack/utils.py
index f026d8811d..948e9f2cf9 100644
--- a/src/sentry/integrations/slack/utils.py
+++ b/src/sentry/integrations/slack/utils.py
@@ -76,25 +76,16 @@ def get_assignee(group):
         return None
 
 
-def build_attachment_title(group, event=None):
-    # XXX(mitsuhiko): This is all super event specific and ideally could just use a
-    # combination of `group.title` and `group.title + group.culprit`.
-    ev_metadata = group.get_event_metadata()
-    ev_type = group.get_event_type()
-    if ev_type == "error":
-        if "type" in ev_metadata:
-            if group.culprit:
-                return u"{} - {}".format(ev_metadata["type"][:40], group.culprit)
-            return ev_metadata["type"]
-        if group.culprit:
-            return u"{} - {}".format(group.title, group.culprit)
-        return group.title
+def build_attachment_title(obj):
+    ev_metadata = obj.get_event_metadata()
+    ev_type = obj.get_event_type()
+
+    if ev_type == "error" and "type" in ev_metadata:
+        return ev_metadata["type"]
     elif ev_type == "csp":
         return u"{} - {}".format(ev_metadata["directive"], ev_metadata["uri"])
     else:
-        if group.culprit:
-            return u"{} - {}".format(group.title, group.culprit)
-        return group.title
+        return obj.title
 
 
 def build_attachment_text(group, event=None):
@@ -254,9 +245,10 @@ def build_group_attachment(group, event=None, tags=None, identity=None, actions=
         if len(rules) > 1:
             footer += u" (+{} other)".format(len(rules) - 1)
 
+    obj = event if event is not None else group
     return {
-        "fallback": u"[{}] {}".format(group.project.slug, group.title),
-        "title": build_attachment_title(group, event),
+        "fallback": u"[{}] {}".format(obj.project.slug, obj.title),
+        "title": build_attachment_title(obj),
         "title_link": group.get_absolute_url(params={"referrer": "slack"}),
         "text": text,
         "fields": fields,
diff --git a/tests/sentry/integrations/slack/test_utils.py b/tests/sentry/integrations/slack/test_utils.py
index 06f00709a4..9e1858a25b 100644
--- a/tests/sentry/integrations/slack/test_utils.py
+++ b/tests/sentry/integrations/slack/test_utils.py
@@ -1,8 +1,13 @@
 from __future__ import absolute_import
+import six
 
 from django.core.urlresolvers import reverse
 
-from sentry.integrations.slack.utils import build_incident_attachment, LEVEL_TO_COLOR
+from sentry.integrations.slack.utils import (
+    build_incident_attachment,
+    build_group_attachment,
+    LEVEL_TO_COLOR,
+)
 from sentry.testutils import TestCase
 from sentry.utils.assets import get_asset_url
 from sentry.utils.dates import to_timestamp
@@ -40,3 +45,107 @@ class BuildIncidentAttachmentTest(TestCase):
             "color": LEVEL_TO_COLOR["error"],
             "actions": [],
         }
+
+    def test_build_group_attachment(self):
+        self.user = self.create_user("foo@example.com")
+        self.org = self.create_organization(name="Rowdy Tiger", owner=None)
+        self.team = self.create_team(organization=self.org, name="Mariachi Band")
+        self.project = self.create_project(
+            organization=self.org, teams=[self.team], name="Bengal-Elephant-Giraffe-Tree-House"
+        )
+        self.create_member(user=self.user, organization=self.org, role="owner", teams=[self.team])
+        group = self.create_group(project=self.project)
+        # import pdb; pdb.set_trace();
+        ts = group.last_seen
+        assert build_group_attachment(group) == {
+            "color": "#E03E2F",
+            "text": "",
+            "actions": [
+                {"name": "status", "text": "Resolve", "type": "button", "value": "resolved"},
+                {"text": "Ignore", "type": "button", "name": "status", "value": "ignored"},
+                {
+                    "option_groups": [
+                        {
+                            "text": "Teams",
+                            "options": [
+                                {
+                                    "text": u"#mariachi-band",
+                                    "value": u"team:" + six.text_type(self.team.id),
+                                }
+                            ],
+                        },
+                        {
+                            "text": "People",
+                            "options": [
+                                {
+                                    "text": u"foo@example.com",
+                                    "value": u"user:" + six.text_type(self.user.id),
+                                }
+                            ],
+                        },
+                    ],
+                    "text": "Select Assignee...",
+                    "selected_options": [None],
+                    "type": "select",
+                    "name": "assign",
+                },
+            ],
+            "mrkdwn_in": ["text"],
+            "title": group.title,
+            "fields": [],
+            "footer": u"BENGAL-ELEPHANT-GIRAFFE-TREE-HOUSE-1",
+            "ts": to_timestamp(ts),
+            "title_link": u"http://testserver/organizations/rowdy-tiger/issues/"
+            + six.text_type(group.id)
+            + "/?referrer=slack",
+            "callback_id": '{"issue":' + six.text_type(group.id) + "}",
+            "fallback": u"[{}] {}".format(self.project.slug, group.title),
+            "footer_icon": u"http://testserver/_static/{version}/sentry/images/sentry-email-avatar.png",
+        }
+        event = self.create_event()
+        ts = event.datetime
+        assert build_group_attachment(group, event) == {
+            "color": "error",
+            "text": "",
+            "actions": [
+                {"name": "status", "text": "Resolve", "type": "button", "value": "resolved"},
+                {"text": "Ignore", "type": "button", "name": "status", "value": "ignored"},
+                {
+                    "option_groups": [
+                        {
+                            "text": "Teams",
+                            "options": [
+                                {
+                                    "text": u"#mariachi-band",
+                                    "value": u"team:" + six.text_type(self.team.id),
+                                }
+                            ],
+                        },
+                        {
+                            "text": "People",
+                            "options": [
+                                {
+                                    "text": u"foo@example.com",
+                                    "value": u"user:" + six.text_type(self.user.id),
+                                }
+                            ],
+                        },
+                    ],
+                    "text": "Select Assignee...",
+                    "selected_options": [None],
+                    "type": "select",
+                    "name": "assign",
+                },
+            ],
+            "mrkdwn_in": ["text"],
+            "title": event.title,
+            "fields": [],
+            "footer": u"BENGAL-ELEPHANT-GIRAFFE-TREE-HOUSE-1",
+            "ts": to_timestamp(ts),
+            "title_link": u"http://testserver/organizations/rowdy-tiger/issues/"
+            + six.text_type(group.id)
+            + "/?referrer=slack",
+            "callback_id": '{"issue":' + six.text_type(group.id) + "}",
+            "fallback": u"[{}] {}".format(self.project.slug, event.title),
+            "footer_icon": u"http://testserver/_static/{version}/sentry/images/sentry-email-avatar.png",
+        }
