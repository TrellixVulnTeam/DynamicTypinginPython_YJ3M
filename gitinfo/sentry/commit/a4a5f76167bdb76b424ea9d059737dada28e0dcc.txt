commit a4a5f76167bdb76b424ea9d059737dada28e0dcc
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Jan 9 11:53:04 2015 -0600

    Render tag key labels

diff --git a/src/sentry/models/group.py b/src/sentry/models/group.py
index 8b12337234..20b8f7ce43 100644
--- a/src/sentry/models/group.py
+++ b/src/sentry/models/group.py
@@ -229,16 +229,41 @@ class Group(Model):
         ).order_by(order_by)
 
     def get_tags(self, with_internal=True):
-        from sentry.models import GroupTagKey
-
+        from sentry.models import GroupTagKey, TagKey
         if not hasattr(self, '_tag_cache'):
-            self._tag_cache = sorted([
-                t for t in GroupTagKey.objects.filter(
-                    group=self,
+            group_tags = GroupTagKey.objects.filter(
+                group=self,
+                project=self.project,
+            )
+            if not with_internal:
+                group_tags = group_tags.exclude(key__startswith='sentry:')
+
+            group_tags = list(group_tags.values_list('key', flat=True))
+
+            tag_keys = dict(
+                (t.key, t)
+                for t in TagKey.objects.filter(
                     project=self.project,
-                ).values_list('key', flat=True)
-                if with_internal or not t.startswith('sentry:')
-            ])
+                    key__in=group_tags
+                )
+            )
+
+            results = []
+            for key in group_tags:
+                try:
+                    tag_key = tag_keys[key]
+                except KeyError:
+                    label = key.replace('_', ' ').title()
+                else:
+                    label = tag_key.get_label()
+
+                results.append({
+                    'key': key,
+                    'label': label,
+                })
+
+            self._tag_cache = sorted(results, key=lambda x: x['label'])
+
         return self._tag_cache
 
     def error(self):
diff --git a/src/sentry/templatetags/sentry_helpers.py b/src/sentry/templatetags/sentry_helpers.py
index 5cb8023ed4..4f959c1053 100644
--- a/src/sentry/templatetags/sentry_helpers.py
+++ b/src/sentry/templatetags/sentry_helpers.py
@@ -351,8 +351,8 @@ def render_tag_widget(group, tag):
     cutoff = timezone.now() - timedelta(days=7)
 
     return {
-        'title': tag.replace('_', ' ').title(),
-        'tag_name': tag,
+        'title': tag['label'],
+        'tag_name': tag['key'],
         'group': group,
     }
 
diff --git a/src/sentry/web/frontend/groups.py b/src/sentry/web/frontend/groups.py
index 0ef506b6bf..8699957d7a 100644
--- a/src/sentry/web/frontend/groups.py
+++ b/src/sentry/web/frontend/groups.py
@@ -417,9 +417,14 @@ def group_tag_list(request, organization, project, group):
     def percent(total, this):
         return int(this / total * 100)
 
+    queryset = TagKey.objects.filter(
+        project=project,
+        key__in=[t['key'] for t in group.get_tags()],
+    )
+
     # O(N) db access
     tag_list = []
-    for tag_key in TagKey.objects.filter(project=project, key__in=group.get_tags()):
+    for tag_key in queryset:
         tag_list.append((tag_key, [
             (value, times_seen, percent(group.times_seen, times_seen))
             for (value, times_seen, first_seen, last_seen)
