commit 4358bb416d256d5760918e1c98ce6acb902d19e0
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Jun 26 00:33:13 2013 -0700

    pytest support for setup.py test

diff --git a/runtests.py b/runtests.py
deleted file mode 100644
index b415412a67..0000000000
--- a/runtests.py
+++ /dev/null
@@ -1,18 +0,0 @@
-#!/usr/bin/env python
-import sys
-
-
-def runtests(args=None):
-    import pytest
-
-    if not args:
-        args = []
-
-    if not any(a for a in args[1:] if not a.startswith('-')):
-        args.append('tests')
-
-    sys.exit(pytest.main(args))
-
-
-if __name__ == '__main__':
-    runtests(sys.argv)
diff --git a/setup.py b/setup.py
index 4a820058fb..2577734dfa 100755
--- a/setup.py
+++ b/setup.py
@@ -23,6 +23,9 @@ any application.
 """
 
 from setuptools import setup, find_packages
+from setuptools.command.test import test as TestCommand
+import sys
+
 
 # Hack to prevent stupid "TypeError: 'NoneType' object is not callable" error
 # in multiprocessing/util.py _exit_function when running `python
@@ -94,6 +97,19 @@ mysql_requires = [
 ]
 
 
+class PyTest(TestCommand):
+    def finalize_options(self):
+        TestCommand.finalize_options(self)
+        self.test_args = []
+        self.test_suite = True
+
+    def run_tests(self):
+        #import here, cause outside the eggs aren't loaded
+        import pytest
+        errno = pytest.main(self.test_args)
+        sys.exit(errno)
+
+
 setup(
     name='sentry',
     version='6.0.0-DEV',
@@ -113,7 +129,7 @@ setup(
         'postgres_pypy': install_requires + postgres_pypy_requires,
         'mysql': install_requires + mysql_requires,
     },
-    test_suite='runtests.runtests',
+    cmdclass={'test': PyTest},
     license='BSD',
     include_package_data=True,
     entry_points={
