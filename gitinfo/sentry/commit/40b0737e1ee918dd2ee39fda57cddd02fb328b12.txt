commit 40b0737e1ee918dd2ee39fda57cddd02fb328b12
Author: Megan Heskett <meg.heskett@gmail.com>
Date:   Mon Oct 29 10:56:21 2018 -0700

    Generate token (#10296)

diff --git a/src/sentry/models/organizationmember.py b/src/sentry/models/organizationmember.py
index c6342c8037..b0c514b938 100644
--- a/src/sentry/models/organizationmember.py
+++ b/src/sentry/models/organizationmember.py
@@ -119,6 +119,11 @@ class OrganizationMember(Model):
         self.token = None
         self.token_expires_at = None
 
+    def remove_user(self):
+        self.email = self.get_email()
+        self.user = None
+        self.token = self.generate_token()
+
     def regenerate_token(self):
         self.token = self.generate_token()
         self.refresh_expires_at()
diff --git a/src/sentry/tasks/auth.py b/src/sentry/tasks/auth.py
index ceed5d4039..876197affe 100644
--- a/src/sentry/tasks/auth.py
+++ b/src/sentry/tasks/auth.py
@@ -89,8 +89,7 @@ def _remove_2fa_non_compliant_member(member, org, actor=None, actor_key=None, ip
     }
 
     try:
-        member.email = member.get_email()
-        member.user = None
+        member.remove_user()
         member.save()
     except (AssertionError, IntegrityError):
         logger.warning(
diff --git a/tests/sentry/models/test_organization.py b/tests/sentry/models/test_organization.py
index 44daae8cdb..173e703fa4 100644
--- a/tests/sentry/models/test_organization.py
+++ b/tests/sentry/models/test_organization.py
@@ -246,11 +246,17 @@ class Require2fa(TestCase):
         assert not member.email
         assert member.user == user
 
-    def is_pending_organization_member(self, user_id, member_id):
+    def is_pending_organization_member(self, user_id, member_id, was_booted=True):
         member = OrganizationMember.objects.get(id=member_id)
         assert User.objects.filter(id=user_id).exists()
         assert member.is_pending
         assert member.email
+        if was_booted:
+            assert member.token
+            assert member.token_expires_at
+        else:
+            assert member.token is None
+            assert member.token_expires_at is None
 
     @mock.patch('sentry.utils.email.logger')
     def test_handle_2fa_required__compliant_and_non_compliant_members(self, email_log):
@@ -325,7 +331,7 @@ class Require2fa(TestCase):
 
         with self.options({'system.url-prefix': 'http://example.com'}), self.tasks():
             self.org.handle_2fa_required(self.request)
-        self.is_pending_organization_member(user.id, member.id)
+        self.is_pending_organization_member(user.id, member.id, was_booted=False)
 
         assert len(mail.outbox) == email_log.info.call_count == 0
         assert not AuditLogEntry.objects.filter(
