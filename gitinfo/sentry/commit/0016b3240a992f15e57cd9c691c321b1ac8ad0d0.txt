commit 0016b3240a992f15e57cd9c691c321b1ac8ad0d0
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Sun Jul 13 22:21:46 2014 -0700

    Add Http.to_curl()

diff --git a/src/sentry/interfaces/http.py b/src/sentry/interfaces/http.py
index aebe66adeb..1754dca225 100644
--- a/src/sentry/interfaces/http.py
+++ b/src/sentry/interfaces/http.py
@@ -8,7 +8,9 @@ sentry.interfaces.http
 
 __all__ = ('Http',)
 
+from Cookie import SmartCookie
 from django.utils.translation import ugettext as _
+from pipes import quote
 from urllib import urlencode
 from urlparse import parse_qsl, urlsplit, urlunsplit
 
@@ -179,6 +181,25 @@ class Http(Interface):
 
         return render_to_string('sentry/partial/interfaces/http.html', context)
 
+    def to_curl(self):
+        method = self.method.upper()
+        if self.cookies is not None:
+            cookies = SmartCookie(self.cookies)
+            # The Cookie header is already yanked out of the headers dict
+            # inside `to_python` so we can just safely re-set it.
+            self.headers['Cookie'] = ';'.join(c.output(attrs=[], header='') for c in cookies.values()).strip()
+        bits = []
+        if method != 'GET':
+            bits.append('-X' + method)
+            if self.data is not None:
+                bits.append('--data ' + quote(self.data))
+        bits.append(quote(self.full_url))
+        for header in self.headers.iteritems():
+            bits.append('-H ' + quote('%s: %s' % header))
+        if 'gzip' in self.headers.get('Accept-Encoding', ''):
+            bits.append('--compressed')
+        return 'curl ' + ' '.join(bits)
+
     def get_alias(self):
         return 'request'
 
diff --git a/src/sentry/rules/actions/notify_event_service.py b/src/sentry/rules/actions/notify_event_service.py
index 13505398d1..49ae28da16 100644
--- a/src/sentry/rules/actions/notify_event_service.py
+++ b/src/sentry/rules/actions/notify_event_service.py
@@ -18,7 +18,7 @@ class NotifyEventServiceForm(forms.Form):
     service = forms.ChoiceField(choices=())
 
     def __init__(self, *args, **kwargs):
-        plugins = kwargs.pop('plugins')
+        kwargs.pop('plugins')
 
         super(NotifyEventServiceForm, self).__init__(*args, **kwargs)
 
diff --git a/tests/sentry/interfaces/test_http.py b/tests/sentry/interfaces/test_http.py
index eea4cdc323..afa1dc765e 100644
--- a/tests/sentry/interfaces/test_http.py
+++ b/tests/sentry/interfaces/test_http.py
@@ -122,3 +122,24 @@ class HttpTest(TestCase):
         ))
         assert result.url == 'http://example.com'
         assert result.full_url == 'http://example.com?foo=bar#fragment'
+
+    def test_to_curl_get(self):
+        result = Http.to_python(dict(
+            method='GET',
+            url='http://example.com',
+            query_string='foo=bar',
+            headers={'x-foo-bar': 'baz', 'accept-encoding': 'deflate, gzip'},
+            cookies={'foo': 'bar'},
+        ))
+        assert result.to_curl() == "curl 'http://example.com?foo=bar' -H 'X-Foo-Bar: baz' -H 'Cookie: foo=bar' -H 'Accept-Encoding: deflate, gzip' --compressed"
+
+    def test_to_curl_post(self):
+        result = Http.to_python(dict(
+            method='POST',
+            url='http://example.com',
+            query_string='foo=bar',
+            headers={'x-foo-bar': 'baz', 'accept-encoding': 'deflate, gzip'},
+            cookies={'foo': 'bar'},
+            data='foo=bar&a=b',
+        ))
+        assert result.to_curl() == "curl -XPOST --data 'foo=bar&a=b' 'http://example.com?foo=bar' -H 'X-Foo-Bar: baz' -H 'Cookie: foo=bar' -H 'Accept-Encoding: deflate, gzip' --compressed"
