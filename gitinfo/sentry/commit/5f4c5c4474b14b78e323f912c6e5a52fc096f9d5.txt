commit 5f4c5c4474b14b78e323f912c6e5a52fc096f9d5
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Tue Sep 19 14:48:36 2017 -0500

    fix: Skip similarity feature deletion during cleanup (#6154)

diff --git a/src/sentry/deletions/defaults/group.py b/src/sentry/deletions/defaults/group.py
index 11b707c465..34ef7029d0 100644
--- a/src/sentry/deletions/defaults/group.py
+++ b/src/sentry/deletions/defaults/group.py
@@ -38,7 +38,8 @@ class GroupDeletionTask(ModelDeletionTask):
     def delete_instance(self, instance):
         from sentry.similarity import features
 
-        features.delete(instance)
+        if not self.skip_models or features not in self.skip_models:
+            features.delete(instance)
 
         return super(GroupDeletionTask, self).delete_instance(instance)
 
diff --git a/src/sentry/runner/commands/cleanup.py b/src/sentry/runner/commands/cleanup.py
index ddaa8bac23..947c96eb70 100644
--- a/src/sentry/runner/commands/cleanup.py
+++ b/src/sentry/runner/commands/cleanup.py
@@ -76,6 +76,7 @@ def cleanup(days, project, concurrency, silent, model, router, timed):
     from sentry.db.deletion import BulkDeleteQuery
     from sentry import deletions
     from sentry import models
+    from sentry import similarity
 
     if timed:
         import time
@@ -199,12 +200,15 @@ def cleanup(days, project, concurrency, silent, model, router, timed):
                 query=query,
                 order_by=order_by,
                 skip_models=[
+                    # Handled by other parts of cleanup
                     models.Event,
                     models.EventMapping,
                     models.EventTag,
                     models.GroupEmailThread,
                     models.GroupRuleStatus,
                     models.GroupTagValue,
+                    # Handled by TTL
+                    similarity.features,
                 ],
                 transaction_id=uuid4().hex,
             )
