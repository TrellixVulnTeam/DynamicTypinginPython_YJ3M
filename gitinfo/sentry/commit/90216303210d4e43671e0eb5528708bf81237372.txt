commit 90216303210d4e43671e0eb5528708bf81237372
Author: Mark Story <mark@mark-story.com>
Date:   Fri Jan 4 13:32:44 2019 -0500

    fix(releases) Fix incorrect transaction management (#11359)
    
    I made a mistake in my previous change where I missed required
    transaction.atomic() blocks. Currently when an integrity error is hit
    the entire set_commits operation fails which is not great.
    
    Fixes SENTRY-8Z1
    Fixes SENTRY-8Z0

diff --git a/src/sentry/models/release.py b/src/sentry/models/release.py
index a3a9868d17..67fb1fdb13 100644
--- a/src/sentry/models/release.py
+++ b/src/sentry/models/release.py
@@ -443,22 +443,24 @@ class Release(Model):
                     patch_set = data.get('patch_set', [])
                     for patched_file in patch_set:
                         try:
-                            CommitFileChange.objects.create(
-                                organization_id=self.organization.id,
-                                commit=commit,
-                                filename=patched_file['path'],
-                                type=patched_file['type'],
-                            )
+                            with transaction.atomic():
+                                CommitFileChange.objects.create(
+                                    organization_id=self.organization.id,
+                                    commit=commit,
+                                    filename=patched_file['path'],
+                                    type=patched_file['type'],
+                                )
                         except IntegrityError:
                             pass
 
                     try:
-                        ReleaseCommit.objects.create(
-                            organization_id=self.organization_id,
-                            release=self,
-                            commit=commit,
-                            order=idx,
-                        )
+                        with transaction.atomic():
+                            ReleaseCommit.objects.create(
+                                organization_id=self.organization_id,
+                                release=self,
+                                commit=commit,
+                                order=idx,
+                            )
                     except IntegrityError:
                         pass
 
