commit 716d47268bdaf539f932a49c23547d20a9d91e4a
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Dec 26 04:16:44 2011 -0800

    Change JS api to be project bound

diff --git a/sentry/templates/sentry/groups/details.html b/sentry/templates/sentry/groups/details.html
index 2977170e7a..e5a86616fb 100644
--- a/sentry/templates/sentry/groups/details.html
+++ b/sentry/templates/sentry/groups/details.html
@@ -58,7 +58,7 @@
                 {{ group.error }}
             </p>
             {% if group.status == 0 %}
-                <a href="{% url sentry-ajax %}?op=resolve&amp;gid={{ group.pk }}" class="hidden button button_resolve">&#10003;</a>
+                <a href="{% url sentry-ajax group.project_id %}?op=resolve&amp;gid={{ group.pk }}" class="hidden button button_resolve">&#10003;</a>
             {% endif %}
         </li>
     </ul>
diff --git a/sentry/templates/sentry/groups/group_list.html b/sentry/templates/sentry/groups/group_list.html
index 46b6039063..29f97016f2 100644
--- a/sentry/templates/sentry/groups/group_list.html
+++ b/sentry/templates/sentry/groups/group_list.html
@@ -3,6 +3,19 @@
 {% load i18n %}
 {% load sentry_helpers %}
 
+{% block meta %}
+    {{ block.super }}
+    <script>
+    Sentry.config({
+        apiUrl: '{% url sentry-ajax project.id %}'
+    });
+    {% if has_realtime %}
+        Sentry.realtime.enable();
+    {% endif %}
+    </script>
+{% endblock %}
+
+
 {% block heading %}{% trans "Events <small>Aggregated</small>" %}{% endblock %}
 
 {% block sidebar %}
@@ -54,7 +67,7 @@
                 <li{% ifequal sort 'accel_60' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=accel_60">{% trans "Trending: 60 minutes" %}</a></li>
             </ul>
         </li>
-        <li class="pull-right"><a href="{% url sentry-ajax %}?op=clear" onclick="Sentry.stream.clear();return false;">Clear Feed</a>
+        <li class="pull-right"><a href="{% url sentry-ajax project.pk %}?op=clear" onclick="Sentry.stream.clear();return false;">Clear Feed</a>
     </ul>
 
     {% if event_list.paginator.objects %}
diff --git a/sentry/templates/sentry/layout.html b/sentry/templates/sentry/layout.html
index 889dc041f2..75b9c9fa73 100644
--- a/sentry/templates/sentry/layout.html
+++ b/sentry/templates/sentry/layout.html
@@ -18,12 +18,8 @@
         <script type="text/javascript">
         Sentry.config({
             mediaUrl: '{% url sentry-media '' %}',
-            apiUrl: '{% url sentry-ajax %}',
             defaultImage: '{% url sentry-media 'images/sentry.png' %}'
         });
-        {% if has_realtime %}
-        Sentry.realtime.enable();
-        {% endif %}
         </script>
         {% block meta %}
         {% endblock %}
diff --git a/sentry/templates/sentry/partial/_group.html b/sentry/templates/sentry/partial/_group.html
index 040f177829..c44665e48a 100644
--- a/sentry/templates/sentry/partial/_group.html
+++ b/sentry/templates/sentry/partial/_group.html
@@ -18,6 +18,6 @@
     </p>
     <a href="{% url sentry-group group.project_id group.pk %}" class="row_link"></a>
     {% if group.status == 0 %}
-        <a href="{% url sentry-ajax %}?op=resolve&amp;gid={{ group.pk }}" onclick="Sentry.stream.resolve({{ group.pk }});return false;" class="button resolve_button hidden">&#10003;</a>
+        <a href="{% url sentry-ajax group.project_id %}?op=resolve&amp;gid={{ group.pk }}" onclick="Sentry.stream.resolve({{ group.pk }});return false;" class="button resolve_button hidden">&#10003;</a>
     {% endif %}
 </li>
diff --git a/sentry/web/frontend/groups.py b/sentry/web/frontend/groups.py
index 8b895758e5..2ec6963310 100644
--- a/sentry/web/frontend/groups.py
+++ b/sentry/web/frontend/groups.py
@@ -34,24 +34,23 @@ event_re = re.compile(r'^(?P<event_id>[a-z0-9]{32})\$(?P<checksum>[a-z0-9]{32})$
 
 @login_required
 @csrf_exempt
-def ajax_handler(request):
+@can_manage
+def ajax_handler(request, project):
     # TODO: remove this awful idea of an API
     op = request.REQUEST.get('op')
 
-    def notification(request):
+    def notification(request, project):
         return render_to_response('sentry/partial/_notification.html', request.GET)
 
-    def poll(request):
+    def poll(request, project):
         filters = []
         for filter_ in get_filters():
             filters.append(filter_(request))
 
-        projects = get_project_list(request.user, 'read_message')
-
         offset = 0
         limit = settings.MESSAGES_PER_PAGE
 
-        event_list = Group.objects.filter(Q(project__in=projects.keys()) | Q(project__isnull=True))
+        event_list = Group.objects.filter(project=project)
 
         for filter_ in filters:
             if not filter_.is_set():
@@ -90,7 +89,7 @@ def ajax_handler(request):
         response['Content-Type'] = 'application/json'
         return response
 
-    def resolve(request):
+    def resolve(request, project):
         gid = request.REQUEST.get('gid')
         if not gid:
             return HttpResponseForbidden()
@@ -121,7 +120,7 @@ def ajax_handler(request):
         response['Content-Type'] = 'application/json'
         return response
 
-    def clear(request):
+    def clear(request, project):
         projects = get_project_list(request.user, 'change_message_status')
 
         event_list = Group.objects.filter(Q(project__in=projects.keys()) | Q(project__isnull=True))
@@ -136,7 +135,7 @@ def ajax_handler(request):
         response['Content-Type'] = 'application/json'
         return response
 
-    def chart(request):
+    def chart(request, project):
         gid = request.REQUEST.get('gid')
         if not gid:
             return HttpResponseForbidden()
@@ -156,7 +155,7 @@ def ajax_handler(request):
         return response
 
     if op in ['notification', 'poll', 'resolve', 'clear', 'chart']:
-        return locals()[op](request)
+        return locals()[op](request, project)
     else:
         return HttpResponseBadRequest()
 
@@ -208,13 +207,6 @@ def search(request, project):
     })
 
 
-SORT_CHOICES = (
-    ('priority', 'Priority'),
-    ('date', 'Last Seeen'),
-    ('new', 'First Seen'),
-    ('freq', 'Frequency'),
-)
-
 @login_required
 @can_manage('read_message')
 def group_list(request, project):
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index a6fcac5010..21b2e818ed 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -50,7 +50,7 @@ urlpatterns = patterns('',
 
     # JS
 
-    url(r'^jsapi/$', groups.ajax_handler, name='sentry-ajax'),
+    url(r'^(?P<project_id>\d+)/jsapi$', groups.ajax_handler, name='sentry-ajax'),
 
     # API
 
