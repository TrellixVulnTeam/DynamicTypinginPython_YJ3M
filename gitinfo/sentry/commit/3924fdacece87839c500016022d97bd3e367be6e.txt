commit 3924fdacece87839c500016022d97bd3e367be6e
Author: Jess MacQueen <jess@getsentry.com>
Date:   Wed Mar 15 16:56:46 2017 -0700

    use user objects for avatars when we have them

diff --git a/src/sentry/plugins/sentry_mail/activity/release.py b/src/sentry/plugins/sentry_mail/activity/release.py
index 00e4da540a..05dde86ef7 100644
--- a/src/sentry/plugins/sentry_mail/activity/release.py
+++ b/src/sentry/plugins/sentry_mail/activity/release.py
@@ -7,7 +7,7 @@ from sentry.db.models.query import in_iexact
 from sentry.models import (
     CommitFileChange, Deploy, Environment, Group,
     GroupSubscriptionReason, GroupCommitResolution,
-    Release, ReleaseCommit, Repository, User
+    Release, ReleaseCommit, Repository, Team, User, UserEmail
 )
 from sentry.utils.http import absolute_uri
 
@@ -33,6 +33,7 @@ class ReleaseActivityEmail(ActivityEmail):
         except Release.DoesNotExist:
             self.release = None
             self.repos = []
+            self.projects = []
         else:
             self.projects = list(self.release.projects.all())
             self.commit_list = [
@@ -51,15 +52,27 @@ class ReleaseActivityEmail(ActivityEmail):
                     id__in={c.repository_id for c in self.commit_list}
                 ).values('id', 'name')
             }
-            for commit in self.commit_list:
-                repos[commit.repository_id]['commits'].append(commit)
-
-            self.repos = repos.values()
 
             self.email_list = set([
                 c.author.email for c in self.commit_list
                 if c.author
             ])
+            users = {
+                ue.email: ue.user
+                for ue in UserEmail.objects.filter(
+                    in_iexact('email', self.email_list),
+                    is_verified=True,
+                    user__sentry_orgmember_set__organization=self.organization,
+                ).select_related('user')
+            }
+
+            for commit in self.commit_list:
+                repos[commit.repository_id]['commits'].append(
+                    (commit, users.get(commit.author.email))
+                )
+
+            self.repos = repos.values()
+
             self.environment = Environment.objects.get(
                 id=self.deploy.environment_id
             ).name or 'Default Environment'
@@ -68,8 +81,6 @@ class ReleaseActivityEmail(ActivityEmail):
         return bool(self.release and self.deploy)
 
     def get_participants(self):
-        project = self.project
-
         if not self.email_list:
             return {}
 
@@ -80,7 +91,9 @@ class ReleaseActivityEmail(ActivityEmail):
             for user in User.objects.filter(
                 in_iexact('emails__email', self.email_list),
                 emails__is_verified=True,
-                sentry_orgmember_set__teams=project.team,
+                sentry_orgmember_set__teams=Team.objects.filter(
+                    id__in=[p.team_id for p in self.projects]
+                ),
                 is_active=True,
             ).distinct()
             if features.has('workflow:release-emails', project=self.project, actor=user)
diff --git a/src/sentry/templates/sentry/emails/activity/release.html b/src/sentry/templates/sentry/emails/activity/release.html
index 0b9d45a8f1..e8f82280d2 100644
--- a/src/sentry/templates/sentry/emails/activity/release.html
+++ b/src/sentry/templates/sentry/emails/activity/release.html
@@ -47,17 +47,19 @@
           <tr>
             <th class="lowercase" colspan="3">{{ repo.name }}</th>
           </tr>
-          {% for commit in repo.commits %}
+          {% for commit, user in repo.commits %}
             <tr>
               <td class="avatar-column">
-                {% if commit.author %}
-                  {% if author.get_avatar_type == 'upload' %}
-                    <img class="avatar" src="{% profile_photo_url commit.author.id size 36 %}">
-                  {% elif commit.author.get_avatar_type == 'letter_avatar' %}
-                    {% email_avatar commit.author.name commit.author.get_label size 36 try_gravatar False %}
+                {% if user %}
+                  {% if user.get_avatar_type == 'upload' %}
+                    <img class="avatar" src="{% profile_photo_url user.id size 36 %}">
+                  {% elif user.get_avatar_type == 'letter_avatar' %}
+                    {% email_avatar user.get_display_name user.get_label size 36 try_gravatar False %}
                   {% else %}
-                    {% email_avatar commit.author.name commit.author.get_label size 36 %}
+                    {% email_avatar user.get_display_name user.get_label size 36 %}
                   {% endif %}
+                {% elif commit.author %}
+                  {% email_avatar commit.author.name commit.author.get_label size 36 %}
                 {% else %}
                     <div class="placeholder-avatar">?</div>
                 {% endif %}
diff --git a/src/sentry/web/frontend/debug/debug_new_release_email.py b/src/sentry/web/frontend/debug/debug_new_release_email.py
index 5b5b4ea13b..3410421b68 100644
--- a/src/sentry/web/frontend/debug/debug_new_release_email.py
+++ b/src/sentry/web/frontend/debug/debug_new_release_email.py
@@ -8,7 +8,7 @@ from django.views.generic import View
 
 from sentry.models import (
     Commit, CommitAuthor, Deploy, GroupSubscriptionReason,
-    Organization, Project, Release, Team
+    Organization, Project, Release, Team, User
 )
 from sentry.utils.http import absolute_uri
 
@@ -68,11 +68,11 @@ class DebugNewReleaseEmailView(View):
         repos = [{
             'name': 'getsentry/getsentry',
             'commits': [
-                Commit(
+                (Commit(
                     key='48b86fcd677da3dba5679d7a738240ce6fb74b20',
                     date_added=timezone.now() - datetime.timedelta(hours=2),
-                ),
-                Commit(
+                ), None),
+                (Commit(
                     key='a53a2756bb8d111b43196210b34df90b87ed336b',
                     message='Fix billing',
                     author=CommitAuthor(
@@ -80,16 +80,25 @@ class DebugNewReleaseEmailView(View):
                         email='david@sentry.io',
                     ),
                     date_added=timezone.now() - datetime.timedelta(hours=1),
-                ),
+                ), User(email='david@sentry.io', name='David Cramer')),
             ],
         }, {
             'name': 'getsentry/sentry',
             'commits': [
-                Commit(
+                (Commit(
                     key='3c8eb3b4af6ee2a29c68daa188fc730c8e4b39fd',
                     date_added=timezone.now() - datetime.timedelta(hours=7),
-                ),
-                Commit(
+                ), None),
+                (Commit(
+                    key='373562702009df1692da6eb80a933139f29e094b',
+                    message='Fix padding',
+                    author=CommitAuthor(
+                        name='Chris Jennings',
+                        email='chris@sentry.io',
+                    ),
+                    date_added=timezone.now() - datetime.timedelta(hours=5),
+                ), None),
+                (Commit(
                     key='631cd9096bd9811a046a472bb0aa8b573e86e1f1',
                     message='Update README.rst',
                     author=CommitAuthor(
@@ -97,7 +106,7 @@ class DebugNewReleaseEmailView(View):
                         email='david@sentry.io',
                     ),
                     date_added=timezone.now() - datetime.timedelta(hours=4),
-                ),
+                ), User(email='david@sentry.io', name='David Cramer')),
             ],
         }]
 
diff --git a/tests/sentry/plugins/mail/activity/test_release.py b/tests/sentry/plugins/mail/activity/test_release.py
index 53c1e3c587..46aee8f73a 100644
--- a/tests/sentry/plugins/mail/activity/test_release.py
+++ b/tests/sentry/plugins/mail/activity/test_release.py
@@ -109,7 +109,10 @@ class ReleaseTestCase(TestCase):
 
             context = email.get_context()
             assert context['environment'] == 'production'
-            assert context['repos'][0]['commits'] == [self.commit, self.commit2]
+            assert context['repos'][0]['commits'] == [
+                (self.commit, self.user),
+                (self.commit2, self.user2),
+            ]
 
             with self.tasks():
                 email.send()
