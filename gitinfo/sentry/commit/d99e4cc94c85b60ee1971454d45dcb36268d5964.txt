commit d99e4cc94c85b60ee1971454d45dcb36268d5964
Author: Lauryn Brown <lauryndbrown@gmail.com>
Date:   Wed Aug 15 13:11:41 2018 -0700

    Changed the issue display name to project#id (#9385)

diff --git a/src/sentry/integrations/vsts/issues.py b/src/sentry/integrations/vsts/issues.py
index 4940303af6..d8bc88ca13 100644
--- a/src/sentry/integrations/vsts/issues.py
+++ b/src/sentry/integrations/vsts/issues.py
@@ -1,6 +1,5 @@
 from __future__ import absolute_import
 
-import six
 from mistune import markdown
 
 from sentry.models import IntegrationExternalProject, OrganizationIntegration
@@ -49,8 +48,9 @@ class VstsIssueSync(IssueSyncMixin):
         fields = super(VstsIssueSync, self).get_link_issue_config(group, **kwargs)
         return fields
 
-    def get_issue_url(self, key, **kwargs):
-        return 'https://%s/_workitems/edit/%s' % (self.instance, six.text_type(key))
+    def get_issue_url(self, key):
+        issue_id = self.get_issue_id_from_key(key)
+        return 'https://%s/_workitems/edit/%s' % (self.instance, issue_id)
 
     def create_issue(self, data, **kwargs):
         """
@@ -81,6 +81,7 @@ class VstsIssueSync(IssueSyncMixin):
         return {
             'key': created_item['id'],
             # 'url': created_item['_links']['html']['href'],
+            'project': created_item['fields']['System.TeamProject'],
             'title': title,
             'description': description,
         }
@@ -89,7 +90,8 @@ class VstsIssueSync(IssueSyncMixin):
         client = self.get_client()
         work_item = client.get_work_item(self.instance, issue_id)
         return {
-            'key': work_item['id'],
+            'key': issue_id,
+            'project': work_item['fields']['System.TeamProject'],
             'title': work_item['fields']['System.Title'],
             'description': work_item['fields'].get('System.Description')
         }
@@ -125,8 +127,9 @@ class VstsIssueSync(IssueSyncMixin):
                 return
 
         try:
+            issue_id = self.get_issue_id_from_key(external_issue.key)
             client.update_work_item(
-                self.instance, external_issue.key, assigned_to=assignee)
+                self.instance, issue_id, assigned_to=assignee)
         except (ApiUnauthorized, ApiError):
             self.logger.info(
                 'vsts.failed-to-assign',
@@ -139,7 +142,8 @@ class VstsIssueSync(IssueSyncMixin):
 
     def sync_status_outbound(self, external_issue, is_resolved, project_id, **kwargs):
         client = self.get_client()
-        work_item = client.get_work_item(self.instance, external_issue.key)
+        issue_id = self.get_issue_id_from_key(external_issue.key)
+        work_item = client.get_work_item(self.instance, issue_id)
 
         # For some reason, vsts doesn't include the project id
         # in the work item response.
@@ -178,7 +182,7 @@ class VstsIssueSync(IssueSyncMixin):
 
         try:
             client.update_work_item(
-                self.instance, external_issue.key, state=status)
+                self.instance, issue_id, state=status)
         except (ApiUnauthorized, ApiError) as error:
             self.logger.info(
                 'vsts.failed-to-change-status',
@@ -205,3 +209,9 @@ class VstsIssueSync(IssueSyncMixin):
             state['name'] for state in all_states if state['category'] in self.done_categories
         ]
         return done_states
+
+    def make_external_key(self, data):
+        return u'{}#{}'.format(data['project'], data['key'])
+
+    def get_issue_id_from_key(self, key):
+        return key.split('#')[1]
diff --git a/tests/sentry/integrations/vsts/test_issues.py b/tests/sentry/integrations/vsts/test_issues.py
index 38de070788..082534b7bc 100644
--- a/tests/sentry/integrations/vsts/test_issues.py
+++ b/tests/sentry/integrations/vsts/test_issues.py
@@ -56,6 +56,8 @@ class VstsIssueSycnTest(TestCase):
         model.add_project(self.project.id, self.config)
         self.integration = VstsIntegration(model, self.organization.id)
         self.issue_id = 309
+        self.project_name = 'Fabrikam-Fiber-Git'
+        self.full_issue_id = '%s#%s' % (self.project_name, self.issue_id)
 
     @responses.activate
     def test_create_issue(self):
@@ -74,6 +76,7 @@ class VstsIssueSycnTest(TestCase):
         }
         assert self.integration.create_issue(form_data) == {
             'key': self.issue_id,
+            'project': self.project_name,
             'description': 'Fix this.',
             'title': 'Hello',
         }
@@ -116,8 +119,10 @@ class VstsIssueSycnTest(TestCase):
             body=WORK_ITEM_RESPONSE,
             content_type='application/json',
         )
+
         assert self.integration.get_issue(self.issue_id) == {
             'key': self.issue_id,
+            'project': self.project_name,
             'description': 'Fix this.',
             'title': 'Hello',
         }
@@ -126,10 +131,10 @@ class VstsIssueSycnTest(TestCase):
 
     @responses.activate
     def test_sync_assignee_outbound(self):
-        vsts_work_item_id = 5
+        vsts_work_item_id = '%s#%d' % (self.project_name, 5)
         responses.add(
             responses.PATCH,
-            'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/%d' % vsts_work_item_id,
+            'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/5',
             body=WORK_ITEM_RESPONSE,
             content_type='application/json',
         )
@@ -152,15 +157,15 @@ class VstsIssueSycnTest(TestCase):
         assert len(responses.calls) == 2
         assert responses.calls[0].request.url == 'https://fabrikam-fiber-inc.vssps.visualstudio.com/_apis/graph/users'
         assert responses.calls[0].response.status_code == 200
-        assert responses.calls[1].request.url == 'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/%d' % vsts_work_item_id
+        assert responses.calls[1].request.url == 'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/5'
         assert responses.calls[1].response.status_code == 200
 
     @responses.activate
     def test_sync_status_outbound(self):
-        vsts_work_item_id = 5
+        vsts_work_item_id = '%s#%d' % (self.project_name, 5)
         responses.add(
             responses.PATCH,
-            'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/%d' % vsts_work_item_id,
+            'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/5',
             body=WORK_ITEM_RESPONSE,
             content_type='application/json',
         )
@@ -172,7 +177,7 @@ class VstsIssueSycnTest(TestCase):
         )
         responses.add(
             responses.GET,
-            'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/%d' % vsts_work_item_id,
+            'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/5',
             body=WORK_ITEM_RESPONSE,
             content_type='application/json',
         )
@@ -200,11 +205,11 @@ class VstsIssueSycnTest(TestCase):
         self.integration.sync_status_outbound(external_issue, True, self.project.id)
         assert len(responses.calls) == 3
         req = responses.calls[2].request
-        assert req.url == 'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/%d' % vsts_work_item_id
+        assert req.url == 'https://fabrikam-fiber-inc.visualstudio.com/DefaultCollection/_apis/wit/workitems/5'
         assert req.body == '[{"path": "/fields/System.State", "value": "Resolved", "op": "replace"}]'
         assert responses.calls[2].response.status_code == 200
 
     def test_get_issue_url(self):
-        work_id = 345
+        work_id = '%s#%d' % (self.project_name, 345)
         url = self.integration.get_issue_url(work_id)
         assert url == 'https://fabrikam-fiber-inc.visualstudio.com/_workitems/edit/345'
