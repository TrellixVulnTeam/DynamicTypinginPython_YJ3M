commit ab29c91033e400bb42fbc5ba018b06346b9d29fa
Author: Billy Vong <billyvg@users.noreply.github.com>
Date:   Wed Jun 3 09:04:23 2020 -0700

    build(github): Minor refactor of acceptance test workflow (#19037)
    
    Refactors the `TOTAL_TEST_GROUPS` env var to not be a constant value, instead use the value provided by Github Actions.

diff --git a/.github/workflows/acceptance.yml b/.github/workflows/acceptance.yml
index 6b26f4049f..373eda9565 100644
--- a/.github/workflows/acceptance.yml
+++ b/.github/workflows/acceptance.yml
@@ -3,7 +3,7 @@ on: pull_request
 
 jobs:
     percynonce:
-      name: Generate Percy nonce
+      name: Generate Percy ID
       runs-on: ubuntu-latest
       steps:
         - name: Generate Percy nonce
@@ -55,7 +55,7 @@ jobs:
         PERCY_PROJECT: ${{ secrets.PERCY_PROJECT }}
 
         # Number of matrix instances
-        TOTAL_TEST_GROUPS: 3
+        TOTAL_TEST_GROUPS: ${{ strategy.job-total }}
 
       services:
         clickhouse:
@@ -121,35 +121,44 @@ jobs:
         # Install node
         - uses: volta-cli/action@v1
 
-        # See https://github.com/actions/cache/blob/master/examples.md#node---yarn for example
-        - name: Get yarn cache dir
-          id: yarn-cache-dir-path
-          run: echo "::set-output name=dir::$(yarn cache dir)"
+        - name: Download percy nonce
+          uses: actions/download-artifact@v1
+          with:
+            name: percy
+
+        # Yarn
+        #   - See https://github.com/actions/cache/blob/master/examples.md#node---yarn for example
+        # Python
+        #   Use `.python-version` to avoid duplication
+        #   XXX: can't actually read from .python-version because GitHub Actions
+        #   does not support our version (2.7.16)
+        #
+        #   XXX: Using `2.7` as GHA image only seems to keep one minor version around and will break
+        #   CI if we pin it to a specific patch version.
+        - name: Set up outputs
+          id: config
+          env:
+            MATRIX_INSTANCE: ${{ matrix.instance }}
+          run: |
+            echo "::set-output name=yarn-cache-dir::$(yarn cache dir)"
+            echo "::set-output name=python-version::2.7"
+            echo "::set-output name=percy-nonce::$(<percy/nonce.txt)"
+            echo "::set-output name=matrix-instance-number::$(($MATRIX_INSTANCE+1))"
 
         # yarn cache
         - uses: actions/cache@v1
           id: yarn-cache # use this to check for `cache-hit` (`steps.yarn-cache.outputs.cache-hit != 'true'`)
           with:
-            path: ${{ steps.yarn-cache-dir-path.outputs.dir }}
+            path: ${{ steps.config.outputs.yarn-cache-dir }}
             key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
             restore-keys: |
               ${{ runner.os }}-yarn-
 
-        # Use `.python-version` to avoid duplication
-        # XXX: can't actually read from .python-version because GitHub Actions
-        # does not support our version (2.7.16)
-        #
-        # XXX: Using `2.7` as GHA image only seems to keep one minor version around and will break
-        # CI if we pin it to a specific patch version.
-        - name: Get python version from `.python-version`
-          id: python-version
-          run: echo "::set-output name=version::2.7"
-
         # setup python
-        - name: Set up Python ${{ steps.python-version.outputs.version }}
+        - name: Set up Python ${{ steps.config.outputs.python-version }}
           uses: actions/setup-python@v1
           with:
-            python-version: ${{ steps.python-version.outputs.version}}
+            python-version: ${{ steps.config.outputs.python-version}}
 
         # setup pip
         - name: Install pip
@@ -188,16 +197,6 @@ jobs:
             pip install -U -e ".[dev]"
             psql -c 'create database sentry;' -h localhost -U postgres
 
-        - name: Download percy nonce
-          uses: actions/download-artifact@v1
-          with:
-            name: percy
-
-        - name: Set percy nonce
-          id: set_percy_nonce
-          run: |
-            echo "::set-output name=percy_nonce::$(<percy/nonce.txt)"
-
         - name: Build platform assets
           run: |
             sentry init
@@ -207,7 +206,7 @@ jobs:
           run: |
             yarn webpack --display errors-only
 
-        - name: Acceptance tests (#${{ matrix.instance }})
+        - name: Run acceptance tests (#${{ steps.config.outputs.matrix-instance-number }} of ${{ strategy.job-total }})
           if: always()
           uses: percy/exec-action@v0.3.0
           with:
@@ -218,4 +217,4 @@ jobs:
             PERCY_TOKEN: ${{ secrets.PERCY_TOKEN }}
             PERCY_PROJECT: ${{ secrets.PERCY_PROJECT }}
             PERCY_PARALLEL_TOTAL: ${{ env.TOTAL_TEST_GROUPS }}
-            PERCY_PARALLEL_NONCE: ${{ steps.set_percy_nonce.outputs.percy_nonce }}
+            PERCY_PARALLEL_NONCE: ${{ steps.config.outputs.percy-nonce }}
