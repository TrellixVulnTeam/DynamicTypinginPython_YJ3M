commit 56e1dba778e98edbada86c1c667f49101ee45403
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Mar 24 13:52:36 2012 -0700

    Correct average events per day data

diff --git a/sentry/templates/sentry/admin/projects/list.html b/sentry/templates/sentry/admin/projects/list.html
index 6a5595c540..cc507e8e5e 100644
--- a/sentry/templates/sentry/admin/projects/list.html
+++ b/sentry/templates/sentry/admin/projects/list.html
@@ -38,12 +38,12 @@
                 <thead>
                     <tr>
                         <th><a href="?{{ sort_querystring }}&amp;sort=name">{% trans "Project" %}</a></th>
-                        <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=events">{% trans "Daily Events" %}</th>
-                        <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=date">{% trans "Date Added" %}</th>
+                        <th style="text-align:center;">{% trans "Daily Events" %}</th>
+                        <th style="text-align:center;"><a href="?{{ sort_querystring }}&amp;sort=date">{% trans "Date Added" %}</a></th>
                     </tr>
                 </thead>
                 <tbody>
-                    {% for project in project_list.paginator.objects %}
+                    {% for project, avg_events in project_list.paginator.objects|with_event_counts %}
                         <tr>
                             <td>
                                 <strong>{{ project.name }}</strong> <a href="{% url sentry project.pk %}">[view]</a><br/>
@@ -58,7 +58,7 @@
                                 {% endif %}
                             </td>
                             <td style="text-align:center; vertical-align:middle;">
-                                <em>~{{ project|avg_events_per_day }}</em>
+                                <em>~{{ avg_events }}</em>
                             </td>
                             <td style="text-align:center; vertical-align:middle;">
                                 {{ project.date_added|date }}
diff --git a/sentry/templates/sentry/admin/users/edit.html b/sentry/templates/sentry/admin/users/edit.html
index cde9a75427..5e314a6bab 100644
--- a/sentry/templates/sentry/admin/users/edit.html
+++ b/sentry/templates/sentry/admin/users/edit.html
@@ -54,14 +54,14 @@
                     </tr>
                 </thead>
                 <tbody>
-                    {% for project in project_list %}
+                    {% for project, avg_events in project_list|with_event_counts %}
                         <tr>
                             <td>
                                 {{ project.name }} <a href="{% url sentry project.pk %}">[view]</a>
                                 </a>
                             </td>
                             <td style="text-align:center; vertical-align:middle;">
-                                <em>~{{ project|avg_events_per_day }}</em>
+                                <em>~{{ avg_events }}</em>
                             </td>
                         </tr>
                     {% endfor %}
diff --git a/sentry/templates/sentry/admin/users/list_projects.html b/sentry/templates/sentry/admin/users/list_projects.html
index bb9e08b9f5..c1db6c66cf 100644
--- a/sentry/templates/sentry/admin/users/list_projects.html
+++ b/sentry/templates/sentry/admin/users/list_projects.html
@@ -32,14 +32,14 @@
                     </tr>
                 </thead>
                 <tbody>
-                    {% for project in project_list.objects %}
+                    {% for project, avg_events in project_list.objects|with_event_counts %}
                         <tr>
                             <td>
                                 {{ project.name }} <a href="{% url sentry project.pk %}">[view]</a>
                                 </a>
                             </td>
                             <td style="text-align:center; vertical-align:middle;">
-                                <em>~{{ project|avg_events_per_day }}</em>
+                                <em>~{{ avg_events }}</em>
                             </td>
                         </tr>
                     {% endfor %}
diff --git a/sentry/templatetags/sentry_admin_helpers.py b/sentry/templatetags/sentry_admin_helpers.py
index 455ed82421..3e7a4907f3 100644
--- a/sentry/templatetags/sentry_admin_helpers.py
+++ b/sentry/templatetags/sentry_admin_helpers.py
@@ -5,23 +5,30 @@ sentry.templatetags.sentry_admin_helpers
 :copyright: (c) 2012 by the Sentry Team, see AUTHORS for more details.
 :license: BSD, see LICENSE for more details.
 """
-from django import template
+import datetime
 
-from sentry.conf import settings
+from django import template
+from django.db.models import Sum
 
 register = template.Library()
 
 
 @register.filter
-def avg_events_per_day(project):
-    """
-    Project is expected to have already been annotated with avg_events_per_n
-    and n_value properties.
-    """
-    if not project.avg_events_per_n:
-        per_day = 0
-    else:
-        n_per_hour = (60 / settings.MINUTE_NORMALIZATION)
-        per_day = int(project.avg_events_per_n / (float(project.n_value) / n_per_hour) * 24)
+def with_event_counts(project_list):
+    from sentry.models import ProjectCountByMinute
+    results = dict(ProjectCountByMinute.objects.filter(
+        project__in=project_list,
+        date__gte=datetime.datetime.now() - datetime.timedelta(days=30),
+    ).annotate(
+        total_events=Sum('times_seen'),
+    ).values_list('project', 'total_events'))
 
-    return per_day
+    for project in project_list:
+        avg = results.get(project.pk, 0) / 30.0
+        if avg < 5:
+            avg = '%.1f' % avg
+            if avg == '0.0':
+                avg = 0
+        else:
+            avg = int(avg)
+        yield project, avg
diff --git a/sentry/web/frontend/admin.py b/sentry/web/frontend/admin.py
index ba410d7a09..5e6478ecde 100644
--- a/sentry/web/frontend/admin.py
+++ b/sentry/web/frontend/admin.py
@@ -51,11 +51,6 @@ def configure_plugin(request, slug):
 def manage_projects(request):
     project_list = Project.objects.filter(
         status=0,
-    ).exclude(
-        projectcountbyminute__date__lte=datetime.datetime.now() - datetime.timedelta(days=30),
-    ).annotate(
-        avg_events_per_n=Sum('projectcountbyminute__times_seen'),
-        n_value=Count('projectcountbyminute__times_seen')
     ).select_related('owner')
 
     project_query = request.GET.get('pquery')
@@ -70,8 +65,6 @@ def manage_projects(request):
         order_by = '-date_added'
     elif sort == 'name':
         order_by = 'name'
-    elif sort == 'events':
-        order_by = '-avg_events_per_n'
 
     project_list = project_list.order_by(order_by)
 
@@ -193,11 +186,6 @@ def edit_user(request, user_id):
     project_list = Project.objects.filter(
         status=0,
         member_set__user=user,
-    ).exclude(
-        projectcountbyminute__date__lte=datetime.datetime.now() - datetime.timedelta(days=30),
-    ).annotate(
-        avg_events_per_n=Sum('projectcountbyminute__times_seen'),
-        n_value=Count('projectcountbyminute__times_seen')
     ).order_by('-date_added')
 
     context = {
@@ -249,11 +237,6 @@ def list_user_projects(request, user_id):
     project_list = Project.objects.filter(
         status=0,
         member_set__user=user,
-    ).exclude(
-        projectcountbyminute__date__lte=datetime.datetime.now() - datetime.timedelta(days=30),
-    ).annotate(
-        avg_events_per_n=Sum('projectcountbyminute__times_seen'),
-        n_value=Count('projectcountbyminute__times_seen')
     ).order_by('-date_added')
 
     context = {
diff --git a/setup.py b/setup.py
index b7811e4a55..9e9cb2d7eb 100755
--- a/setup.py
+++ b/setup.py
@@ -50,7 +50,7 @@ install_requires = [
 
 setup(
     name='sentry',
-    version='3.6.1',
+    version='3.6.2',
     author='David Cramer',
     author_email='dcramer@gmail.com',
     url='http://github.com/dcramer/sentry',
