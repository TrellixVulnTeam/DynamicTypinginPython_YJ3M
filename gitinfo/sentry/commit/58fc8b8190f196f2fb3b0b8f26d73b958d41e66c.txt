commit 58fc8b8190f196f2fb3b0b8f26d73b958d41e66c
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Jun 28 17:15:11 2015 -0700

    Switch behavior of defaults for create_or_update

diff --git a/src/sentry/api/endpoints/group_details.py b/src/sentry/api/endpoints/group_details.py
index e53ee94312..2fb2eb2229 100644
--- a/src/sentry/api/endpoints/group_details.py
+++ b/src/sentry/api/endpoints/group_details.py
@@ -226,7 +226,7 @@ class GroupDetailsEndpoint(GroupEndpoint):
                 group=group,
                 user=request.user,
                 project=group.project,
-                defaults={
+                values={
                     'last_seen': timezone.now(),
                 }
             )
diff --git a/src/sentry/api/endpoints/organization_access_request_details.py b/src/sentry/api/endpoints/organization_access_request_details.py
index dd9b3eca65..89e1ad91d8 100644
--- a/src/sentry/api/endpoints/organization_access_request_details.py
+++ b/src/sentry/api/endpoints/organization_access_request_details.py
@@ -44,7 +44,7 @@ class OrganizationAccessRequestDetailsEndpoint(OrganizationEndpoint):
             affected, _ = OrganizationMemberTeam.objects.create_or_update(
                 organizationmember=access_request.member,
                 team=access_request.team,
-                defaults={
+                values={
                     'is_active': is_approved,
                 }
             )
diff --git a/src/sentry/api/endpoints/project_group_index.py b/src/sentry/api/endpoints/project_group_index.py
index 0d5c0f15cf..54cf9173fc 100644
--- a/src/sentry/api/endpoints/project_group_index.py
+++ b/src/sentry/api/endpoints/project_group_index.py
@@ -256,7 +256,7 @@ class ProjectGroupIndexEndpoint(ProjectEndpoint):
                     group=group,
                     user=request.user,
                     project=group.project,
-                    defaults={
+                    values={
                         'last_seen': timezone.now(),
                     }
                 )
diff --git a/src/sentry/buffer/base.py b/src/sentry/buffer/base.py
index 053ff09786..ca982d2bbe 100644
--- a/src/sentry/buffer/base.py
+++ b/src/sentry/buffer/base.py
@@ -46,7 +46,7 @@ class Buffer(object):
             update_kwargs.update(extra)
 
         _, created = model.objects.create_or_update(
-            defaults=update_kwargs,
+            values=update_kwargs,
             **filters
         )
 
diff --git a/src/sentry/db/models/query.py b/src/sentry/db/models/query.py
index 68dc719209..091c574308 100644
--- a/src/sentry/db/models/query.py
+++ b/src/sentry/db/models/query.py
@@ -54,10 +54,11 @@ def create_or_update(model, using=None, **kwargs):
     The result will be (rows affected, False), if the row was not created,
     or (instance, True) if the object is new.
 
-    >>> create_or_update(MyModel, key='value', defaults={
+    >>> create_or_update(MyModel, key='value', values={
     >>>     'value': F('value') + 1,
-    >>> })
+    >>> }, defaults={'created_at': timezone.now()})
     """
+    values = kwargs.pop('values', {})
     defaults = kwargs.pop('defaults', {})
 
     if not using:
@@ -66,21 +67,27 @@ def create_or_update(model, using=None, **kwargs):
     objects = model.objects.using(using)
 
     # TODO(dcramer): support _id shortcut on filter kwargs
-    affected = objects.filter(**kwargs).update(**defaults)
+    affected = objects.filter(**kwargs).update(**values)
     if affected:
         return affected, False
 
     create_kwargs = kwargs.copy()
     inst = objects.model()
+    for k, v in values.iteritems():
+        if isinstance(v, ExpressionNode):
+            create_kwargs[k] = resolve_expression_node(inst, v)
+        else:
+            create_kwargs[k] = v
     for k, v in defaults.iteritems():
         if isinstance(v, ExpressionNode):
             create_kwargs[k] = resolve_expression_node(inst, v)
         else:
             create_kwargs[k] = v
+
     try:
         with transaction.atomic():
             return objects.create(**create_kwargs), True
     except IntegrityError:
-        affected = objects.filter(**kwargs).update(**defaults)
+        affected = objects.filter(**kwargs).update(**values)
 
     return affected, False
diff --git a/src/sentry/management/commands/load_help_pages.py b/src/sentry/management/commands/load_help_pages.py
index 4ad03d2b57..740a463ed8 100644
--- a/src/sentry/management/commands/load_help_pages.py
+++ b/src/sentry/management/commands/load_help_pages.py
@@ -40,7 +40,7 @@ class Command(BaseCommand):
             page, created = create_or_update(
                 HelpPage,
                 key=filename,
-                defaults={
+                values={
                     'title': options['title'],
                     'priority': options.get('priority', 50),
                     'content': body,
diff --git a/src/sentry/migrations/0083_migrate_dupe_groups.py b/src/sentry/migrations/0083_migrate_dupe_groups.py
index ac513d94bc..d9a40c81e8 100644
--- a/src/sentry/migrations/0083_migrate_dupe_groups.py
+++ b/src/sentry/migrations/0083_migrate_dupe_groups.py
@@ -84,7 +84,7 @@ class Migration(DataMigration):
                     group=group,
                     key=key,
                     value=value,
-                    defaults=defaults
+                    values=values,
                 )
 
             orm['sentry.MessageFilterValue'].objects.filter(group__in=matches).delete()
@@ -95,7 +95,7 @@ class Migration(DataMigration):
                     project=group.project,
                     group=group,
                     date=date,
-                    defaults={
+                    values={
                         'times_seen': F('times_seen') + data['times_seen'],
                         'time_spent_total': F('time_spent_total') + data['time_spent_total'],
                         'time_spent_count': F('time_spent_count') + data['time_spent_count'],
diff --git a/src/sentry/models/groupmeta.py b/src/sentry/models/groupmeta.py
index dd94a74a53..66035ee2dc 100644
--- a/src/sentry/models/groupmeta.py
+++ b/src/sentry/models/groupmeta.py
@@ -92,7 +92,7 @@ class GroupMetaManager(BaseManager):
         self.create_or_update(
             group=instance,
             key=key,
-            defaults={
+            values={
                 'value': value,
             },
         )
diff --git a/src/sentry/models/projectoption.py b/src/sentry/models/projectoption.py
index 3aa92c42da..458595bc31 100644
--- a/src/sentry/models/projectoption.py
+++ b/src/sentry/models/projectoption.py
@@ -59,7 +59,7 @@ class ProjectOptionManager(BaseManager):
         self.create_or_update(
             project=project,
             key=key,
-            defaults={
+            values={
                 'value': value,
             },
         )
diff --git a/src/sentry/nodestore/django/backend.py b/src/sentry/nodestore/django/backend.py
index d4f46c1263..8689391c8b 100644
--- a/src/sentry/nodestore/django/backend.py
+++ b/src/sentry/nodestore/django/backend.py
@@ -37,7 +37,7 @@ class DjangoNodeStorage(NodeStorage):
         create_or_update(
             Node,
             id=id,
-            defaults={
+            values={
                 'data': data,
                 'timestamp': timezone.now(),
             },
diff --git a/src/sentry/options/manager.py b/src/sentry/options/manager.py
index 18bd4c1b0f..8da47f0e47 100644
--- a/src/sentry/options/manager.py
+++ b/src/sentry/options/manager.py
@@ -74,7 +74,7 @@ class OptionsManager(object):
         create_or_update(
             model=Option,
             key=key,
-            defaults={
+            values={
                 'value': value,
                 'last_updated': timezone.now(),
             }
diff --git a/src/sentry/plugins/interfaces/releasehook.py b/src/sentry/plugins/interfaces/releasehook.py
index 94d9e3b70a..a8eaf163d0 100644
--- a/src/sentry/plugins/interfaces/releasehook.py
+++ b/src/sentry/plugins/interfaces/releasehook.py
@@ -19,20 +19,20 @@ class ReleaseHook(object):
     def __init__(self, project):
         self.project = project
 
-    def start_release(self, version, **defaults):
-        defaults.setdefault('date_started', timezone.now())
+    def start_release(self, version, **values):
+        values.setdefault('date_started', timezone.now())
         Release.objects.create_or_update(
             version=version,
             project=self.project,
-            defaults=defaults,
+            values=values,
         )
 
-    def finish_release(self, version, **defaults):
-        defaults.setdefault('date_released', timezone.now())
+    def finish_release(self, version, **values):
+        values.setdefault('date_released', timezone.now())
         Release.objects.create_or_update(
             version=version,
             project=self.project,
-            defaults=defaults,
+            values=values,
         )
 
     def handle(self, request):
diff --git a/src/sentry/web/frontend/groups.py b/src/sentry/web/frontend/groups.py
index 3727665394..15933f1d1c 100644
--- a/src/sentry/web/frontend/groups.py
+++ b/src/sentry/web/frontend/groups.py
@@ -381,7 +381,7 @@ def group_details(request, organization, project, group, event_id=None):
             group=group,
             user=request.user,
             project=project,
-            defaults={
+            values={
                 'last_seen': timezone.now(),
             }
         )
diff --git a/tests/sentry/api/endpoints/test_organization_details.py b/tests/sentry/api/endpoints/test_organization_details.py
index f77d6e67a2..ac854fae28 100644
--- a/tests/sentry/api/endpoints/test_organization_details.py
+++ b/tests/sentry/api/endpoints/test_organization_details.py
@@ -76,7 +76,7 @@ class OrganizationDeleteTest(APITestCase):
         org.member_set.create_or_update(
             organization=org,
             user=user,
-            defaults={
+            values={
                 'type': OrganizationMemberType.ADMIN,
             }
         )
diff --git a/tests/sentry/api/endpoints/test_team_details.py b/tests/sentry/api/endpoints/test_team_details.py
index a48e8e3023..6cb5ca0e9e 100644
--- a/tests/sentry/api/endpoints/test_team_details.py
+++ b/tests/sentry/api/endpoints/test_team_details.py
@@ -84,7 +84,7 @@ class TeamDeleteTest(APITestCase):
         team.organization.member_set.create_or_update(
             organization=org,
             user=user,
-            defaults={
+            values={
                 'type': OrganizationMemberType.ADMIN,
             }
         )
