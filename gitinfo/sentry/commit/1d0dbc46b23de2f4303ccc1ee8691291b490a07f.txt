commit 1d0dbc46b23de2f4303ccc1ee8691291b490a07f
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Apr 6 11:45:59 2015 -0700

    Ensure linking works correctly for invalidated accounts

diff --git a/src/sentry/auth/helper.py b/src/sentry/auth/helper.py
index 6a3f06d320..b865e0c91f 100644
--- a/src/sentry/auth/helper.py
+++ b/src/sentry/auth/helper.py
@@ -312,14 +312,20 @@ class AuthHelper(object):
         except OrganizationMember.DoesNotExist:
             return self.error(ERR_UID_MISMATCH)
 
-        # TODO(dcramer): handle case when another user exists w/ this identity
-        auth_identity = AuthIdentity.objects.create(
+        auth_data = identity.get('data', {})
+        auth_identity = AuthIdentity.objects.get_or_create(
             user=request.user,
             ident=identity['id'],
             auth_provider=self.auth_provider,
-            data=identity.get('data', {}),
+            defaults={
+                'data': auth_data,
+            }
         )
 
+        if auth_identity.data != auth_data:
+            auth_identity.data = auth_data
+            auth_identity.save()
+
         setattr(om.flags, 'sso:invalid', False)
         setattr(om.flags, 'sso:linked', True)
         om.save()
