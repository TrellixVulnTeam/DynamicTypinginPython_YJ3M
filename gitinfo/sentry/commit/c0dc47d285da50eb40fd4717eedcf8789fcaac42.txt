commit c0dc47d285da50eb40fd4717eedcf8789fcaac42
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Thu Dec 5 00:39:42 2019 +0300

    fix(kafka): Flush producers on exit (#15934)
    
    We need to make sure the producers are flushed when exiting the application as otherwise we risk losing events that were not yet sent to Kafka, which happened to me with the backfill script.

diff --git a/src/sentry/utils/kafka.py b/src/sentry/utils/kafka.py
index 230ccdac8c..0b087181c0 100644
--- a/src/sentry/utils/kafka.py
+++ b/src/sentry/utils/kafka.py
@@ -1,5 +1,6 @@
 from __future__ import absolute_import
 
+import atexit
 import logging
 import signal
 
@@ -32,6 +33,20 @@ class ProducerManager(object):
 
         cluster_options = settings.KAFKA_CLUSTERS[cluster_name]
         producer = self.__producers[cluster_name] = Producer(cluster_options)
+
+        @atexit.register
+        def exit_handler():
+            pending_count = len(producer)
+            if pending_count == 0:
+                return
+
+            logger.debug(
+                "Waiting for %d messages to be flushed from %s before exiting...",
+                pending_count,
+                cluster_name,
+            )
+            producer.flush()
+
         return producer
 
 
