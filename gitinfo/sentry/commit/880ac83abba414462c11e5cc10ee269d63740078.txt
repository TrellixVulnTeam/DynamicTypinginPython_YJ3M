commit 880ac83abba414462c11e5cc10ee269d63740078
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Mon Nov 4 09:42:08 2019 +0100

    feat(grouping): Always override client fingerprint (#15389)

diff --git a/src/sentry/grouping/api.py b/src/sentry/grouping/api.py
index c2e40c05fb..390321332a 100644
--- a/src/sentry/grouping/api.py
+++ b/src/sentry/grouping/api.py
@@ -129,22 +129,9 @@ def get_fingerprinting_config_for_project(project):
 
 
 def apply_server_fingerprinting(event, config):
-    fingerprint = event["fingerprint"]
-    if not any(x in DEFAULT_FINGERPRINT_VALUES for x in fingerprint):
-        return
-
-    new_values = config.get_fingerprint_values_for_event(event)
-    if new_values is None:
-        return
-
-    new_fingerprint = []
-    for value in fingerprint:
-        if value in DEFAULT_FINGERPRINT_VALUES:
-            new_fingerprint.extend(new_values)
-        else:
-            new_fingerprint.append(value)
-
-    event["fingerprint"] = new_fingerprint
+    new_fingerprint = config.get_fingerprint_values_for_event(event)
+    if new_fingerprint is not None:
+        event["fingerprint"] = new_fingerprint
 
 
 def _get_calculated_grouping_variants_for_event(event, config):
diff --git a/tests/sentry/grouping/fingerprint_inputs/fingerprint-override-client.json b/tests/sentry/grouping/fingerprint_inputs/fingerprint-override-client.json
new file mode 100644
index 0000000000..681ed6a909
--- /dev/null
+++ b/tests/sentry/grouping/fingerprint_inputs/fingerprint-override-client.json
@@ -0,0 +1,14 @@
+{
+  "_fingerprinting_rules": [
+    {
+      "matchers": [
+        ["message", "*love*"]
+      ],
+      "fingerprint": ["what-is-love"]
+    }
+  ],
+  "fingerprint": ["client-sent"],
+  "logentry": {
+    "formatted": "Hello my sweet Love"
+  }
+}
diff --git a/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type.pysnap b/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type.pysnap
index 581deb1206..6999dd474d 100644
--- a/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type.pysnap
+++ b/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type.pysnap
@@ -1,5 +1,5 @@
 ---
-created: '2019-07-23T21:55:25.846335Z'
+created: '2019-11-01T11:48:29.596222Z'
 creator: sentry
 source: tests/sentry/grouping/test_fingerprinting.py
 ---
@@ -12,11 +12,9 @@ config:
       - DatabaseUnavailable
   version: 1
 fingerprint:
-- my-route
 - database-unavailable
 variants:
   custom-fingerprint:
     type: custom-fingerprint
     values:
-    - my-route
     - database-unavailable
diff --git a/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type_and_module.pysnap b/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type_and_module.pysnap
index 6851706ced..b19c9d1cc5 100644
--- a/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type_and_module.pysnap
+++ b/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_exception_type_and_module.pysnap
@@ -1,5 +1,5 @@
 ---
-created: '2019-07-23T21:55:25.855738Z'
+created: '2019-11-01T11:48:29.607303Z'
 creator: sentry
 source: tests/sentry/grouping/test_fingerprinting.py
 ---
@@ -14,11 +14,9 @@ config:
       - io.sentry.example.*
   version: 1
 fingerprint:
-- my-route
 - database-unavailable
 variants:
   custom-fingerprint:
     type: custom-fingerprint
     values:
-    - my-route
     - database-unavailable
diff --git a/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_override_client.pysnap b/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_override_client.pysnap
new file mode 100644
index 0000000000..4a3d21bcef
--- /dev/null
+++ b/tests/sentry/grouping/snapshots/test_fingerprinting/test_event_hash_variant/fingerprint_override_client.pysnap
@@ -0,0 +1,20 @@
+---
+created: '2019-11-01T11:48:30.045123Z'
+creator: sentry
+source: tests/sentry/grouping/test_fingerprinting.py
+---
+config:
+  rules:
+  - fingerprint:
+    - what-is-love
+    matchers:
+    - - message
+      - '*love*'
+  version: 1
+fingerprint:
+- what-is-love
+variants:
+  custom-fingerprint:
+    type: custom-fingerprint
+    values:
+    - what-is-love
