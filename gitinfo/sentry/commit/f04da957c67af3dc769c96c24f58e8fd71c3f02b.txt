commit f04da957c67af3dc769c96c24f58e8fd71c3f02b
Author: Lauryn Brown <lauryndbrown@gmail.com>
Date:   Wed Nov 21 10:21:01 2018 -0800

    fix(integrations): Azure DevOps check all users in outbound assignee sync. (#10667)
    
    * Added paging functionality to outbound assingee sync.
    
    * added check to ensure the right user was assigned.

diff --git a/src/sentry/integrations/vsts/client.py b/src/sentry/integrations/vsts/client.py
index 938a27d12d..26b9ae2fd0 100644
--- a/src/sentry/integrations/vsts/client.py
+++ b/src/sentry/integrations/vsts/client.py
@@ -246,12 +246,17 @@ class VstsApiClient(ApiClient, OAuth2RefreshMixin):
             params={'stateFilter': 'WellFormed'}
         )
 
-    def get_users(self, account_name):
+    def get_users(self, account_name, continuation_token=None):
+        """
+        Gets Users with access to a given account/organization
+        https://docs.microsoft.com/en-us/rest/api/azure/devops/graph/users/list?view=azure-devops-rest-4.1
+        """
         return self.get(
             VstsApiPath.users.format(
                 account_name=account_name,
             ),
             api_preview=True,
+            params={'continuationToken': continuation_token},
         )
 
     def create_subscription(self, instance, shared_secret):
diff --git a/src/sentry/integrations/vsts/issues.py b/src/sentry/integrations/vsts/issues.py
index 6a6cf30d45..34f8844d94 100644
--- a/src/sentry/integrations/vsts/issues.py
+++ b/src/sentry/integrations/vsts/issues.py
@@ -144,13 +144,18 @@ class VstsIssueSync(IssueSyncMixin):
         assignee = None
 
         if assign is True:
-            vsts_users = client.get_users(self.model.name)
             sentry_emails = [email.email.lower() for email in user.get_verified_emails()]
-
-            for vsts_user in vsts_users['value']:
-                vsts_email = vsts_user.get(u'mailAddress')
-                if vsts_email and vsts_email.lower() in sentry_emails:
-                    assignee = vsts_user['mailAddress']
+            continuation_token = None
+            while True:
+                vsts_users = client.get_users(self.model.name, continuation_token)
+                continuation_token = vsts_users.headers.get('X-MS-ContinuationToken')
+                for vsts_user in vsts_users['value']:
+                    vsts_email = vsts_user.get(u'mailAddress')
+                    if vsts_email and vsts_email.lower() in sentry_emails:
+                        assignee = vsts_user['mailAddress']
+                        break
+
+                if not continuation_token:
                     break
 
             if assignee is None:
diff --git a/tests/sentry/integrations/vsts/test_issues.py b/tests/sentry/integrations/vsts/test_issues.py
index c79a354120..a9989c67ca 100644
--- a/tests/sentry/integrations/vsts/test_issues.py
+++ b/tests/sentry/integrations/vsts/test_issues.py
@@ -69,6 +69,9 @@ class VstsIssueBase(TestCase):
 
 class VstsIssueSyncTest(VstsIssueBase):
 
+    def tearDown(self):
+        responses.reset()
+
     @responses.activate
     def test_create_issue(self):
         responses.add(
@@ -162,8 +165,68 @@ class VstsIssueSyncTest(VstsIssueBase):
         assert responses.calls[0].request.url == 'https://fabrikam-fiber-inc.vssps.visualstudio.com/_apis/graph/users'
         assert responses.calls[0].response.status_code == 200
         assert responses.calls[1].request.url == 'https://fabrikam-fiber-inc.visualstudio.com/_apis/wit/workitems/%d' % vsts_work_item_id
+
+        request_body = json.loads(responses.calls[1].request.body)
+        assert len(request_body) == 1
+        assert request_body[0]['path'] == '/fields/System.AssignedTo'
+        assert request_body[0]['value'] == 'ftotten@vscsi.us'
+        assert request_body[0]['op'] == 'replace'
         assert responses.calls[1].response.status_code == 200
 
+    @responses.activate
+    def test_sync_assignee_outbound_with_paging(self):
+        vsts_work_item_id = 5
+        responses.add(
+            responses.PATCH,
+            'https://fabrikam-fiber-inc.visualstudio.com/_apis/wit/workitems/%d' % vsts_work_item_id,
+            body=WORK_ITEM_RESPONSE,
+            content_type='application/json',
+        )
+        responses.add(
+            responses.GET,
+            'https://fabrikam-fiber-inc.vssps.visualstudio.com/_apis/graph/users',
+            json={
+                'value': [
+                    {'mailAddress': 'example1@example.com'},
+                    {'mailAddress': 'example2@example.com'},
+                    {'mailAddress': 'example3@example.com'},
+                ]
+            },
+            headers={'X-MS-ContinuationToken': 'continuation-token'},
+            match_querystring=True,
+        )
+        responses.add(
+            responses.GET,
+            'https://fabrikam-fiber-inc.vssps.visualstudio.com/_apis/graph/users?continuationToken=continuation-token',
+            body=GET_USERS_RESPONSE,
+            content_type='application/json',
+            match_querystring=True,
+        )
+
+        user = self.create_user('ftotten@vscsi.us')
+        external_issue = ExternalIssue.objects.create(
+            organization_id=self.organization.id,
+            integration_id=self.integration.model.id,
+            key=vsts_work_item_id,
+            title='I\'m a title!',
+            description='I\'m a description.'
+        )
+        self.integration.sync_assignee_outbound(external_issue, user, assign=True)
+        assert len(responses.calls) == 3
+        assert responses.calls[0].request.url == 'https://fabrikam-fiber-inc.vssps.visualstudio.com/_apis/graph/users'
+        assert responses.calls[0].response.status_code == 200
+
+        assert responses.calls[1].request.url == 'https://fabrikam-fiber-inc.vssps.visualstudio.com/_apis/graph/users?continuationToken=continuation-token'
+        assert responses.calls[1].response.status_code == 200
+
+        assert responses.calls[2].request.url == 'https://fabrikam-fiber-inc.visualstudio.com/_apis/wit/workitems/%d' % vsts_work_item_id
+        request_body = json.loads(responses.calls[2].request.body)
+        assert len(request_body) == 1
+        assert request_body[0]['path'] == '/fields/System.AssignedTo'
+        assert request_body[0]['value'] == 'ftotten@vscsi.us'
+        assert request_body[0]['op'] == 'replace'
+        assert responses.calls[2].response.status_code == 200
+
     @responses.activate
     def test_sync_status_outbound(self):
         vsts_work_item_id = 5
