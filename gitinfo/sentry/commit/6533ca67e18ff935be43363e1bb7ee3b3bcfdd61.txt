commit 6533ca67e18ff935be43363e1bb7ee3b3bcfdd61
Author: Mark Story <mark@sentry.io>
Date:   Thu Aug 22 15:55:26 2019 -0400

    fix(vsts) Handle 401 errors when creating azure webhooks (#14451)
    
    Azure Devops can return 401 errors in addition to 400 and 403 errors
    when creating webhooks. Handle those errors as well, we also account for
    azure mixing up status codes and messages as it has done that in the
    past.
    
    Fixes SENTRY-BTA
    Fixes #14390
    Fixes SEN-927

diff --git a/src/sentry/integrations/vsts/integration.py b/src/sentry/integrations/vsts/integration.py
index c21844cc30..a8771aa614 100644
--- a/src/sentry/integrations/vsts/integration.py
+++ b/src/sentry/integrations/vsts/integration.py
@@ -396,7 +396,9 @@ class VstsIntegrationProvider(IntegrationProvider):
                 instance, oauth_data, self.oauth_redirect_url
             )
         except ApiError as e:
-            if e.code == 400 or e.code == 403 or "permission" in e.message:
+            auth_codes = (400, 401, 403)
+            permission_error = "permission" in e.message or "not authorized" in e.message
+            if e.code in auth_codes or permission_error:
                 raise IntegrationError(
                     "You do not have sufficient account access to create webhooks "
                     "on the selected Azure DevOps organization.\n"
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index 3be6028fc4..a03379304c 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -176,13 +176,47 @@ class VstsIntegrationProviderTest(VstsIntegrationTestCase):
             VSTSIdentityProvider.oauth_scopes
         )
 
-    def test_build_integration__create_subscription_error(self):
+    def test_build_integration__create_subscription_forbidden(self):
         responses.replace(
             responses.POST,
             u"https://{}.visualstudio.com/_apis/hooks/subscriptions".format(
                 self.vsts_account_name.lower()
             ),
             status=403,
+            json={
+                "$id": 1,
+                "message": "The user bob is does not have permission to access this resource",
+                "typeKey": "UnauthorizedRequestException",
+                "errorCode": 0,
+                "eventId": 3000,
+            },
+        )
+        state = {
+            "account": {"accountName": self.vsts_account_name, "accountId": self.vsts_account_id},
+            "base_url": self.vsts_base_url,
+            "identity": {
+                "data": {
+                    "access_token": self.access_token,
+                    "expires_in": "3600",
+                    "refresh_token": self.refresh_token,
+                    "token_type": "jwt-bearer",
+                }
+            },
+        }
+
+        integration = VstsIntegrationProvider()
+
+        with pytest.raises(IntegrationError) as err:
+            integration.build_integration(state)
+        assert "sufficient account access to create webhooks" in six.text_type(err)
+
+    def test_build_integration__create_subscription_unauthorized(self):
+        responses.replace(
+            responses.POST,
+            u"https://{}.visualstudio.com/_apis/hooks/subscriptions".format(
+                self.vsts_account_name.lower()
+            ),
+            status=401,
             json={
                 "$id": 1,
                 "message": "The user bob is not authorized to access this resource",
