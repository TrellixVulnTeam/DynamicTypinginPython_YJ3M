commit b4021f3de5eb3a8bf86941c435f9c5a84bf2e156
Author: Jan Michael Auer <account@jauer.org>
Date:   Wed Feb 6 13:12:22 2019 +0100

    fix(assemble): Cache successful assembles to avoid race (#11931)

diff --git a/src/sentry/api/endpoints/debug_files.py b/src/sentry/api/endpoints/debug_files.py
index 05599e9d7d..66cefac152 100644
--- a/src/sentry/api/endpoints/debug_files.py
+++ b/src/sentry/api/endpoints/debug_files.py
@@ -259,7 +259,15 @@ class DifAssembleEndpoint(ProjectEndpoint):
             # ProjectDebugFile will be created and we need to prevent a race
             # condition.
             state, detail = get_assemble_status(project, checksum)
-            if state is not None:
+            if state == ChunkFileState.OK:
+                file_response[checksum] = {
+                    'state': state,
+                    'detail': None,
+                    'missingChunks': [],
+                    'dif': detail
+                }
+                continue
+            elif state is not None:
                 file_response[checksum] = {
                     'state': state,
                     'detail': detail,
diff --git a/src/sentry/models/debugfile.py b/src/sentry/models/debugfile.py
index 58f272e3e4..19e7ec3ea3 100644
--- a/src/sentry/models/debugfile.py
+++ b/src/sentry/models/debugfile.py
@@ -33,7 +33,7 @@ from sentry.cache import default_cache
 from sentry.constants import KNOWN_DIF_TYPES
 from sentry.db.models import FlexibleForeignKey, Model, \
     sane_repr, BaseManager, BoundedPositiveIntegerField
-from sentry.models.file import File, ChunkFileState
+from sentry.models.file import File
 from sentry.reprocessing import resolve_processing_issue, \
     bump_reprocessing_revision
 from sentry.utils import metrics
@@ -81,12 +81,10 @@ def set_assemble_status(project, checksum, state, detail=None):
     cache_key = 'assemble-status:%s' % _get_idempotency_id(
         project, checksum)
 
-    # If the state is okay we actually clear it from the cache because in
-    # that case a project dsym file was created.
-    if state == ChunkFileState.OK:
-        default_cache.delete(cache_key)
-    else:
-        default_cache.set(cache_key, (state, detail), 300)
+    # NB: Also cache successfully created debug files to avoid races between
+    # multiple DIFs with the same identifier. On the downside, this blocks
+    # re-uploads for 10 minutes.
+    default_cache.set(cache_key, (state, detail), 600)
 
 
 class BadDif(Exception):
diff --git a/src/sentry/tasks/assemble.py b/src/sentry/tasks/assemble.py
index 0da92cede7..2a0f065c8b 100644
--- a/src/sentry/tasks/assemble.py
+++ b/src/sentry/tasks/assemble.py
@@ -3,6 +3,7 @@ from __future__ import absolute_import, print_function
 import os
 import logging
 
+from sentry.api.serializers import serialize
 from sentry.tasks.base import instrumented_task
 from sentry.utils.files import get_max_file_size
 from sentry.utils.sdk import configure_scope
@@ -77,7 +78,8 @@ def assemble_dif(project_id, name, checksum, chunks, **kwargs):
                     dif.delete()
 
             if indicate_success:
-                set_assemble_status(project, checksum, ChunkFileState.OK)
+                set_assemble_status(project, checksum, ChunkFileState.OK,
+                                    detail=serialize(dif))
     finally:
         if delete_file:
             file.delete()
