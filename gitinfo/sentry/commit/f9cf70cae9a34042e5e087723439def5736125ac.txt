commit f9cf70cae9a34042e5e087723439def5736125ac
Author: adhiraj <693121+adhiraj@users.noreply.github.com>
Date:   Mon Jul 9 15:39:38 2018 -0700

    feat(identity): Add API call to fetch correct VSTS id (#8977)

diff --git a/src/sentry/identity/vsts/provider.py b/src/sentry/identity/vsts/provider.py
index a145a63c45..a0190405ab 100644
--- a/src/sentry/identity/vsts/provider.py
+++ b/src/sentry/identity/vsts/provider.py
@@ -16,9 +16,26 @@ def get_user_info(access_token):
         },
     )
     resp.raise_for_status()
-    resp = resp.json()
-
-    return resp
+    user = resp.json()
+    resp = session.get(
+        'https://app.vssps.visualstudio.com/_apis/connectionData/',
+        headers={
+            'Accept': 'application/json',
+            'Authorization': 'bearer %s' % access_token,
+        },
+    )
+    resp.raise_for_status()
+    # NOTE (from Microsoft PM):
+    # The "descriptor" is the universal identifier for a given user and is consistent across
+    # all VSTS accounts (organizations). The "id" field for the same user can be different for
+    # the same user in different places, so the "descriptor" is the best identifier for a user.
+    # This is returned in most/all of the VSTS REST APIs at this point (except for the
+    # profiles/me API above). To get the current user's descriptor, we call the "connection data"
+    # REST API (this assumes we are authenticating with an access token issued to the user).
+    # We will also see descriptors returned for every user in the "Get users" (Graph) REST API.
+    user['id'] = resp.json()['authenticatedUser']['subjectDescriptor']
+
+    return user
 
 
 class VSTSIdentityProvider(OAuth2Provider):
diff --git a/tests/sentry/integrations/vsts/test_integration.py b/tests/sentry/integrations/vsts/test_integration.py
index 64ddb11ea1..0588d8c265 100644
--- a/tests/sentry/integrations/vsts/test_integration.py
+++ b/tests/sentry/integrations/vsts/test_integration.py
@@ -22,6 +22,15 @@ class VstsIntegrationProviderTest(TestCase):
                 'emailAddress': 'sentry@user.com',
             },
         )
+        responses.add(
+            responses.GET,
+            'https://app.vssps.visualstudio.com/_apis/connectionData/',
+            json={
+                'authenticatedUser': {
+                    'subjectDescriptor': 'user1-subject-desc',
+                },
+            },
+        )
 
     @responses.activate
     def test_build_integration(self):
@@ -43,7 +52,7 @@ class VstsIntegrationProviderTest(TestCase):
         assert integration_dict['metadata']['domain_name'] == 'sentry.visualstudio.com'
 
         assert integration_dict['user_identity']['type'] == 'vsts'
-        assert integration_dict['user_identity']['external_id'] == 'user1'
+        assert integration_dict['user_identity']['external_id'] == 'user1-subject-desc'
         assert integration_dict['user_identity']['scopes'] == sorted(
             VSTSIdentityProvider.oauth_scopes)
 
