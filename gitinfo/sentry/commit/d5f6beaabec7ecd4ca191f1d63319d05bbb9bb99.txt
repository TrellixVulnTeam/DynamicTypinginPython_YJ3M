commit d5f6beaabec7ecd4ca191f1d63319d05bbb9bb99
Author: Evan Hicks <evan.hicks@sentry.io>
Date:   Mon Dec 16 12:05:29 2019 -0500

    feat(discover) Switch trace and span id to use columns instead of context
    
    Have the trace_id and span_id use the built in columns instead of the context
    array.

diff --git a/src/sentry/api/endpoints/organization_events.py b/src/sentry/api/endpoints/organization_events.py
index 3a36d88735..62f31e32eb 100644
--- a/src/sentry/api/endpoints/organization_events.py
+++ b/src/sentry/api/endpoints/organization_events.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 import logging
 import six
+import uuid
 from functools import partial
 from rest_framework.response import Response
 from rest_framework.exceptions import ParseError
@@ -164,9 +165,19 @@ class OrganizationEventsV2Endpoint(OrganizationEventsEndpointBase):
 
         # TODO(mark) move all of this result formatting into discover.query()
         # once those APIs are used across the application.
-        if "transaction.status" in first_row:
+        tests = {
+            "transaction.status": "transaction.status" in first_row,
+            "trace": "trace" in first_row,
+        }
+        if any(tests.values()):
             for row in results:
-                row["transaction.status"] = SPAN_STATUS_CODE_TO_NAME.get(row["transaction.status"])
+                if tests["transaction.status"]:
+                    row["transaction.status"] = SPAN_STATUS_CODE_TO_NAME.get(
+                        row["transaction.status"]
+                    )
+                if tests["trace"]:
+                    row["trace"] = uuid.UUID(row["trace"]).hex
+
         if not ("project.id" in first_row or "projectid" in first_row):
             return results
         fields = request.GET.getlist("field")
diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index 3e190f12ef..17a033dd1e 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 
 import re
+import uuid
 from collections import namedtuple
 from copy import deepcopy
 from datetime import datetime
@@ -584,6 +585,21 @@ def convert_search_filter_to_snuba_query(search_filter):
                 )
             )
         return [name, search_filter.operator, internal_value]
+    elif name == "trace":
+        if not search_filter.value.raw_value:
+            operator = "IS NULL" if search_filter.operator == "=" else "IS NOT NULL"
+            return [name, operator, None]
+
+        try:
+            return [
+                name,
+                search_filter.operator,
+                six.text_type(uuid.UUID(search_filter.value.raw_value)),
+            ]
+        except Exception:
+            raise InvalidSearchQuery(
+                "Invalid value for the trace condition. Value must be a hexadecimal UUID string."
+            )
     else:
         value = (
             int(to_timestamp(value)) * 1000
diff --git a/src/sentry/snuba/events.py b/src/sentry/snuba/events.py
index 6c3d196804..c20f4b2b7e 100644
--- a/src/sentry/snuba/events.py
+++ b/src/sentry/snuba/events.py
@@ -212,8 +212,8 @@ class Columns(Enum):
     TRACE_ID = Column(
         "events.contexts[trace.trace_id]",
         "contexts[trace.trace_id]",
-        "contexts[trace.trace_id]",
-        "contexts[trace.trace_id]",
+        "trace_id",
+        "trace_id",
         "trace",
     )
     SPAN_ID = Column(
diff --git a/tests/sentry/api/test_event_search.py b/tests/sentry/api/test_event_search.py
index 2c465ff6b5..e412c53eff 100644
--- a/tests/sentry/api/test_event_search.py
+++ b/tests/sentry/api/test_event_search.py
@@ -1079,6 +1079,10 @@ class GetSnubaQueryArgsTest(TestCase):
         assert "Invalid value" in six.text_type(err)
         assert "cancelled," in six.text_type(err)
 
+    def test_trace_id(self):
+        result = get_filter("trace:{}".format("a0fa8803753e40fd8124b21eeb2986b5"))
+        assert result.conditions == [["trace", "=", "a0fa8803-753e-40fd-8124-b21eeb2986b5"]]
+
 
 class ResolveFieldListTest(unittest.TestCase):
     def test_non_string_field_error(self):
diff --git a/tests/snuba/api/endpoints/test_organization_events_v2.py b/tests/snuba/api/endpoints/test_organization_events_v2.py
index ed282a3a4e..e2f48d72c4 100644
--- a/tests/snuba/api/endpoints/test_organization_events_v2.py
+++ b/tests/snuba/api/endpoints/test_organization_events_v2.py
@@ -592,3 +592,23 @@ class OrganizationEventsV2EndpointTest(APITestCase, SnubaTestCase):
         assert response.data["meta"]["transaction.duration"] == "duration"
         assert response.data["meta"]["transaction.status"] == "string"
         assert response.data["data"][0]["transaction.status"] == "ok"
+
+    def test_trace_columns(self):
+        self.login_as(user=self.user)
+
+        project = self.create_project()
+        data = load_data("transaction")
+        data["timestamp"] = iso_format(before_now(minutes=1))
+        data["start_timestamp"] = iso_format(before_now(minutes=1, seconds=5))
+        self.store_event(data=data, project_id=project.id)
+
+        with self.feature("organizations:events-v2"):
+            response = self.client.get(
+                self.url,
+                format="json",
+                data={"field": ["trace"], "query": "event.type:transaction"},
+            )
+        assert response.status_code == 200, response.content
+        assert len(response.data["data"]) == 1
+        assert response.data["meta"]["trace"] == "string"
+        assert response.data["data"][0]["trace"] == data["contexts"]["trace"]["trace_id"]
diff --git a/tests/snuba/search/test_backend.py b/tests/snuba/search/test_backend.py
index 21c14b7860..7d26144134 100644
--- a/tests/snuba/search/test_backend.py
+++ b/tests/snuba/search/test_backend.py
@@ -1376,7 +1376,7 @@ class EventsSnubaSearchTest(TestCase, SnubaTestCase):
             elif key in IssueSearchVisitor.date_keys:
                 val = "2019-01-01"
             else:
-                val = "hello"
+                val = "abadcafedeadbeefdeaffeedabadfeed"
                 test_query("!%s:%s" % (key, val))
 
             test_query("%s:%s" % (key, val))
