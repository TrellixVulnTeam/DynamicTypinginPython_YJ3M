commit 319a56b465975c0bad60becf730a066a4fc1b00f
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Thu Oct 20 12:25:24 2016 -0700

    api: make sure environment isn't longer than 64 chars (#4407)
    
    fixes SENTRY-1XH

diff --git a/src/sentry/coreapi.py b/src/sentry/coreapi.py
index b71c914a02..6a8e14bf1d 100644
--- a/src/sentry/coreapi.py
+++ b/src/sentry/coreapi.py
@@ -676,6 +676,17 @@ class ClientApiHelper(object):
                     'value': data['release'],
                 })
                 del data['release']
+
+        if data.get('environment'):
+            data['environment'] = six.text_type(data['environment'])
+            if len(data['environment']) > 64:
+                data['errors'].append({
+                    'type': EventError.VALUE_TOO_LONG,
+                    'name': 'environment',
+                    'value': data['environment'],
+                })
+                del data['environment']
+
         return data
 
     def ensure_does_not_have_ip(self, data):
diff --git a/tests/sentry/coreapi/tests.py b/tests/sentry/coreapi/tests.py
index 751c60d5b5..d7b0a97b64 100644
--- a/tests/sentry/coreapi/tests.py
+++ b/tests/sentry/coreapi/tests.py
@@ -367,6 +367,22 @@ class ValidateDataTest(BaseAPITest):
         })
         assert data.get('platform') == 'other'
 
+    def test_environment_too_long(self):
+        data = self.helper.validate_data(self.project, {
+            'environment': 'a' * 65,
+        })
+        assert not data.get('environment')
+        assert len(data['errors']) == 1
+        assert data['errors'][0]['type'] == 'value_too_long'
+        assert data['errors'][0]['name'] == 'environment'
+        assert data['errors'][0]['value'] == 'a' * 65
+
+    def test_environment_as_non_string(self):
+        data = self.helper.validate_data(self.project, {
+            'environment': 42,
+        })
+        assert data.get('environment') == '42'
+
 
 class SafelyLoadJSONStringTest(BaseAPITest):
     def test_valid_payload(self):
