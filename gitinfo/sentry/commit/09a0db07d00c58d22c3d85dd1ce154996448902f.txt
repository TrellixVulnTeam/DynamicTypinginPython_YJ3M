commit 09a0db07d00c58d22c3d85dd1ce154996448902f
Author: Katie Byers <lobsterkatie@gmail.com>
Date:   Mon Feb 25 13:14:08 2019 -0800

    fix(source maps): Ignore fragment if present in URL (#12189)
    
    Right now, if we have an `abs_path` like `'http://www.example.com/script.js#random-fragment'`, and an artifact uploaded as `'http://www.example.com/script.js'`, we won't find it. This fixes that.

diff --git a/src/sentry/models/releasefile.py b/src/sentry/models/releasefile.py
index ab29a5967e..7a55366c86 100644
--- a/src/sentry/models/releasefile.py
+++ b/src/sentry/models/releasefile.py
@@ -73,10 +73,12 @@ class ReleaseFile(Model):
         """
         # Always ignore the fragment
         scheme, netloc, path, query, _ = urlsplit(url)
+
+        uri_without_fragment = (scheme, netloc, path, query, None)
         uri_relative = (None, None, path, query, None)
         uri_without_query = (scheme, netloc, path, None, None)
         uri_relative_without_query = (None, None, path, None, None)
-        urls = [url]
+        urls = [urlunsplit(uri_without_fragment)]
         if query:
             urls.append(urlunsplit(uri_without_query))
         urls.append('~' + urlunsplit(uri_relative))
diff --git a/tests/sentry/models/test_releasefile.py b/tests/sentry/models/test_releasefile.py
index e6e21668ce..2d9caf3b52 100644
--- a/tests/sentry/models/test_releasefile.py
+++ b/tests/sentry/models/test_releasefile.py
@@ -27,6 +27,13 @@ class ReleaseFileTestCase(TestCase):
             '~/foo.js',
         ]
 
+        assert n('http://example.com/foo.js?bar#baz') == [
+            'http://example.com/foo.js?bar',
+            'http://example.com/foo.js',
+            '~/foo.js?bar',
+            '~/foo.js',
+        ]
+
         # This is the current behavior, but seems weird to me.
         # unclear if we actually experience this case in the real
         # world, but worth documenting the behavior
