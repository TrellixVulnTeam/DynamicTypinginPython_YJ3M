commit c9454180f8d8bdccd88d91122c69ed14bb0ce694
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Tue Mar 13 11:26:36 2018 -0500

    fix(tagstore): Fix object delete in merge code for tagstore v2 (#7594)
    
    Fixes SENTRY-630

diff --git a/src/sentry/tagstore/v2/models/grouptagkey.py b/src/sentry/tagstore/v2/models/grouptagkey.py
index 694de5a4a1..557a64737a 100644
--- a/src/sentry/tagstore/v2/models/grouptagkey.py
+++ b/src/sentry/tagstore/v2/models/grouptagkey.py
@@ -9,7 +9,7 @@ from __future__ import absolute_import
 
 import six
 
-from django.db import router, transaction, DataError
+from django.db import router, transaction, DataError, connections
 
 from sentry.api.serializers import Serializer, register
 from sentry.db.models import (
@@ -38,6 +38,17 @@ class GroupTagKey(Model):
 
     __repr__ = sane_repr('project_id', 'group_id', '_key')
 
+    def delete_for_merge(self):
+        using = router.db_for_read(GroupTagKey)
+        cursor = connections[using].cursor()
+        cursor.execute(
+            """
+            DELETE FROM tagstore_grouptagkey
+            WHERE project_id = %s
+              AND id = %s
+        """, [self.project_id, self.id]
+        )
+
     @property
     def key(self):
         if hasattr(self, '_set_key'):
diff --git a/src/sentry/tagstore/v2/models/grouptagvalue.py b/src/sentry/tagstore/v2/models/grouptagvalue.py
index 13382cbc55..cf1c050303 100644
--- a/src/sentry/tagstore/v2/models/grouptagvalue.py
+++ b/src/sentry/tagstore/v2/models/grouptagvalue.py
@@ -9,7 +9,7 @@ from __future__ import absolute_import
 
 import six
 
-from django.db import models, router, transaction, DataError
+from django.db import models, router, transaction, DataError, connections
 from django.utils import timezone
 
 from sentry.api.serializers import Serializer, register
@@ -44,6 +44,17 @@ class GroupTagValue(Model):
 
     __repr__ = sane_repr('project_id', 'group_id', '_key', '_value')
 
+    def delete_for_merge(self):
+        using = router.db_for_read(GroupTagValue)
+        cursor = connections[using].cursor()
+        cursor.execute(
+            """
+            DELETE FROM tagstore_grouptagvalue
+            WHERE project_id = %s
+              AND id = %s
+        """, [self.project_id, self.id]
+        )
+
     @property
     def key(self):
         if hasattr(self, '_set_key'):
diff --git a/src/sentry/tasks/merge.py b/src/sentry/tasks/merge.py
index 13ebce936d..8a3e8aebb1 100644
--- a/src/sentry/tasks/merge.py
+++ b/src/sentry/tasks/merge.py
@@ -334,7 +334,12 @@ def merge_objects(models, group, new_group, limit=1000, logger=None, transaction
                     obj.merge_counts(new_group)
 
                 obj_id = obj.id
-                obj.delete()
+
+                if hasattr(model, 'delete_for_merge'):
+                    obj.delete_for_merge()
+                else:
+                    obj.delete()
+
                 if logger is not None:
                     delete_logger.debug(
                         'object.delete.executed',
