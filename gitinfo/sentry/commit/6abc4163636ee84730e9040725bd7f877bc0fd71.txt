commit 6abc4163636ee84730e9040725bd7f877bc0fd71
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Jul 7 14:55:37 2017 -0700

    api: add hits to issue search endpoint (gated)

diff --git a/src/sentry/api/base.py b/src/sentry/api/base.py
index 87210389f2..1b03c16b7c 100644
--- a/src/sentry/api/base.py
+++ b/src/sentry/api/base.py
@@ -199,6 +199,16 @@ class Endpoint(APIView):
         response['Access-Control-Allow-Origin'] = request.META['HTTP_ORIGIN']
         response['Access-Control-Allow-Methods'] = ', '.join(self.http_method_names)
 
+    def add_cursor_headers(self, request, response, cursor_result):
+        if cursor_result.hits is not None:
+            response['X-Hits'] = cursor_result.hits
+        if cursor_result.max_hits is not None:
+            response['X-Max-Hits'] = cursor_result.max_hits
+        response['Link'] = ', '.join([
+            self.build_cursor_link(request, 'previous', cursor_result.prev),
+            self.build_cursor_link(request, 'next', cursor_result.next),
+        ])
+
     def paginate(self, request, on_results=None, paginator_cls=Paginator,
                  default_per_page=100, **kwargs):
         per_page = int(request.GET.get('per_page', default_per_page))
@@ -220,17 +230,8 @@ class Endpoint(APIView):
         if on_results:
             results = on_results(cursor_result.results)
 
-        headers = {}
-        if cursor_result.hits is not None:
-            headers['X-Hits'] = cursor_result.hits
-        if cursor_result.max_hits is not None:
-            headers['X-Max-Hits'] = cursor_result.max_hits
-        headers['Link'] = ', '.join([
-            self.build_cursor_link(request, 'previous', cursor_result.prev),
-            self.build_cursor_link(request, 'next', cursor_result.next),
-        ])
-
-        return Response(results, headers=headers)
+        response = Response(results)
+        self.add_cursor_headers(request, response, cursor_result)
 
 
 class StatsMixin(object):
diff --git a/src/sentry/api/endpoints/project_group_index.py b/src/sentry/api/endpoints/project_group_index.py
index 3cffaa1c4c..f9fd111126 100644
--- a/src/sentry/api/endpoints/project_group_index.py
+++ b/src/sentry/api/endpoints/project_group_index.py
@@ -10,7 +10,7 @@ from django.utils import timezone
 from rest_framework import serializers
 from rest_framework.response import Response
 
-from sentry import search
+from sentry import features, search
 from sentry.api.base import DocSection
 from sentry.api.bases.project import ProjectEndpoint, ProjectEventPermission
 from sentry.api.fields import UserField
@@ -338,7 +338,12 @@ class ProjectGroupIndexEndpoint(ProjectEndpoint):
         except ValidationError as exc:
             return Response({'detail': six.text_type(exc)}, status=400)
 
-        cursor_result = search.query(**query_kwargs)
+        count_hits = features.has(
+            'projects:stream-hit-counts',
+            project=project,
+            actor=request.user)
+
+        cursor_result = search.query(count_hits=count_hits, **query_kwargs)
 
         results = list(cursor_result)
 
@@ -356,10 +361,8 @@ class ProjectGroupIndexEndpoint(ProjectEndpoint):
             ]
 
         response = Response(context)
-        response['Link'] = ', '.join([
-            self.build_cursor_link(request, 'previous', cursor_result.prev),
-            self.build_cursor_link(request, 'next', cursor_result.next),
-        ])
+
+        self.add_cursor_headers(request, response, cursor_result)
 
         if results and query not in SAVED_SEARCH_QUERIES:
             advanced_search.send(project=project, sender=request.user)
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index e45df6bd96..01ce201390 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -783,6 +783,7 @@ SENTRY_FEATURES = {
     'projects:sample-events': True,
     'projects:data-forwarding': True,
     'projects:rate-limits': True,
+    'projects:stream-hit-counts': False,
 }
 
 # Default time zone for localization in the UI.
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index 6f4384563c..8ed9a8b31c 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -23,6 +23,7 @@ default_manager.add('projects:rate-limits', ProjectFeature)  # NOQA
 default_manager.add('workflow:release-emails', ProjectFeature)  # NOQA
 default_manager.add('projects:sample-events', ProjectFeature)  # NOQA
 default_manager.add('projects:similarity-indexing', ProjectFeature)  # NOQA
+default_manager.add('projects:stream-hit-counts', ProjectFeature)  # NOQA
 
 # expose public api
 add = default_manager.add
diff --git a/src/sentry/search/django/backend.py b/src/sentry/search/django/backend.py
index 9332b0e35b..d4bba93f98 100644
--- a/src/sentry/search/django/backend.py
+++ b/src/sentry/search/django/backend.py
@@ -259,7 +259,7 @@ class DjangoSearchBackend(SearchBackend):
         )
         return queryset
 
-    def query(self, project, **kwargs):
+    def query(self, project, count_hits=False, **kwargs):
         queryset = self._build_queryset(project=project, **kwargs)
 
         sort_by = kwargs.get('sort_by', 'date')
@@ -285,4 +285,4 @@ class DjangoSearchBackend(SearchBackend):
 
         queryset = queryset.order_by(sort_clause)
         paginator = paginator_cls(queryset, sort_clause)
-        return paginator.get_result(limit, cursor)
+        return paginator.get_result(limit, cursor, count_hits=count_hits)
