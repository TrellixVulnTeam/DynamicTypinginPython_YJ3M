commit ae104f5935063299b06e1bb521025ae2aa7b3e66
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Mon Mar 4 14:57:46 2019 -0800

    feat(api): Support filtering seen stats by date in group snuba serializer (#12242)

diff --git a/src/sentry/api/serializers/models/group.py b/src/sentry/api/serializers/models/group.py
index 20ae9559e3..8425146edd 100644
--- a/src/sentry/api/serializers/models/group.py
+++ b/src/sentry/api/serializers/models/group.py
@@ -575,6 +575,8 @@ class GroupSerializerSnuba(GroupSerializerBase):
                 project_ids,
                 group_ids,
                 self.environment_ids,
+                start=self.start,
+                end=self.end,
             )
 
             first_seen_data = {
diff --git a/src/sentry/tagstore/snuba/backend.py b/src/sentry/tagstore/snuba/backend.py
index 4e39e17ee2..9360596231 100644
--- a/src/sentry/tagstore/snuba/backend.py
+++ b/src/sentry/tagstore/snuba/backend.py
@@ -312,13 +312,11 @@ class SnubaTagStorage(TagStorage):
             ) for issue, data in six.iteritems(result)
         }
 
-    def get_group_seen_values_for_environments(self, project_ids, group_id_list, environment_ids):
+    def get_group_seen_values_for_environments(self, project_ids, group_id_list, environment_ids,
+                                               start=None, end=None):
         # Get the total times seen, first seen, and last seen across multiple environments
-
-        # TODO(jess): this is mostly copy paste from above
-        # also, this is temporary and will probably need to be updated to
-        # filter correctly based on date filters -- waiting on some product decisions
-        start, end = self.get_time_range()
+        if start is None or end is None:
+            start, end = self.get_time_range()
         filters = {
             'project_id': project_ids,
             'issue': group_id_list,
diff --git a/tests/snuba/api/serializers/test_group.py b/tests/snuba/api/serializers/test_group.py
index cd41b3dc53..5c8281082b 100644
--- a/tests/snuba/api/serializers/test_group.py
+++ b/tests/snuba/api/serializers/test_group.py
@@ -349,13 +349,18 @@ class GroupSerializerSnubaTest(APITestCase, SnubaTestCase):
         assert group_env2.first_seen > group_env.first_seen
         assert result['userCount'] == 3
 
-        # test userCount filtering correctly by time
+        # test userCount, count, lastSeen filtering correctly by time
+        # firstSeen should still be from GroupEnvironment
         result = serialize(group, serializer=GroupSerializerSnuba(
             environment_ids=[environment.id, environment2.id],
             start=self.week_ago - timedelta(hours=1),
             end=self.week_ago + timedelta(hours=1),
         ))
         assert result['userCount'] == 1
+        assert result['lastSeen'] == self.week_ago - \
+            timedelta(microseconds=self.week_ago.microsecond)
+        assert result['firstSeen'] == group_env.first_seen
+        assert result['count'] == '1'
 
 
 class StreamGroupSerializerTestCase(APITestCase, SnubaTestCase):
diff --git a/tests/snuba/tagstore/test_tagstore_backend.py b/tests/snuba/tagstore/test_tagstore_backend.py
index b38fc46507..879912fd98 100644
--- a/tests/snuba/tagstore/test_tagstore_backend.py
+++ b/tests/snuba/tagstore/test_tagstore_backend.py
@@ -518,3 +518,10 @@ class TagStorageTest(SnubaTestCase):
             'last_seen': self.now - timedelta(seconds=1),
             'times_seen': 2,
         }}
+
+        # test where there should be no results because of time filters
+        assert self.ts.get_group_seen_values_for_environments(
+            [self.proj1.id], [self.proj1group1.id], [self.proj1env1.id],
+            start=self.now - timedelta(hours=5),
+            end=self.now - timedelta(hours=4),
+        ) == {}
