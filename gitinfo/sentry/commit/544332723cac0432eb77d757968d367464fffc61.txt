commit 544332723cac0432eb77d757968d367464fffc61
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Fri Mar 9 14:23:51 2018 -0600

    fix(tagstore): Fix merge of tagstore v2 by adding project_id to queries (#7553)

diff --git a/src/sentry/tagstore/v2/models/grouptagkey.py b/src/sentry/tagstore/v2/models/grouptagkey.py
index 037ce4e097..694de5a4a1 100644
--- a/src/sentry/tagstore/v2/models/grouptagkey.py
+++ b/src/sentry/tagstore/v2/models/grouptagkey.py
@@ -63,10 +63,6 @@ class GroupTagKey(Model):
     def key(self, key):
         self._set_key = key
 
-    @staticmethod
-    def get_select_related_for_merge():
-        return ('_key', )
-
     def merge_counts(self, new_group):
         from sentry.tagstore.v2.models import GroupTagValue
 
@@ -74,10 +70,12 @@ class GroupTagKey(Model):
             with transaction.atomic(using=router.db_for_write(GroupTagKey)):
                 GroupTagKey.objects.filter(
                     group_id=new_group.id,
+                    project_id=new_group.project_id,
                     _key_id=self._key_id,
                 ).update(
                     values_seen=GroupTagValue.objects.filter(
                         group_id=new_group.id,
+                        project_id=new_group.project_id,
                         _key_id=self._key_id,
                     ).count()
                 )
diff --git a/src/sentry/tagstore/v2/models/grouptagvalue.py b/src/sentry/tagstore/v2/models/grouptagvalue.py
index 655d34f3ac..717cc3c00b 100644
--- a/src/sentry/tagstore/v2/models/grouptagvalue.py
+++ b/src/sentry/tagstore/v2/models/grouptagvalue.py
@@ -99,15 +99,12 @@ class GroupTagValue(Model):
             self.first_seen = self.last_seen
         super(GroupTagValue, self).save(*args, **kwargs)
 
-    @staticmethod
-    def get_select_related_for_merge():
-        return ('_key', '_value', )
-
     def merge_counts(self, new_group):
         try:
             with transaction.atomic(using=router.db_for_write(GroupTagValue)):
                 new_obj = GroupTagValue.objects.get(
                     group_id=new_group.id,
+                    project_id=new_group.project_id,
                     _key_id=self._key_id,
                     _value_id=self._value_id,
                 )
diff --git a/src/sentry/tasks/merge.py b/src/sentry/tasks/merge.py
index 548e5848e0..13ebce936d 100644
--- a/src/sentry/tasks/merge.py
+++ b/src/sentry/tasks/merge.py
@@ -316,9 +316,6 @@ def merge_objects(models, group, new_group, limit=1000, logger=None, transaction
         else:
             queryset = project_qs.filter(group_id=group.id)
 
-        if hasattr(model, 'get_select_related_for_merge'):
-            queryset = queryset.select_related(*model.get_select_related_for_merge())
-
         for obj in queryset[:limit]:
             try:
                 with transaction.atomic(using=router.db_for_write(model)):
