commit 60d0a51e0b00d74e497c9bbdbaebc26ac2d22aea
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Wed Feb 15 17:43:00 2017 -0800

    fix project deletion (#4922)
    
    fixes SENTRY-2VD

diff --git a/src/sentry/tasks/deletion.py b/src/sentry/tasks/deletion.py
index 6aec595813..c966186f9f 100644
--- a/src/sentry/tasks/deletion.py
+++ b/src/sentry/tasks/deletion.py
@@ -27,7 +27,7 @@ logger = logging.getLogger('sentry.deletions.async')
 def delete_organization(object_id, transaction_id=None, continuous=True, **kwargs):
     from sentry.models import (
         Organization, OrganizationMember, OrganizationStatus, Team, TeamStatus,
-        Commit, CommitAuthor, CommitFileChange, Release, ReleaseCommit,
+        Commit, CommitAuthor, CommitFileChange, Environment, Release, ReleaseCommit,
         ReleaseFile, Repository
     )
 
@@ -55,7 +55,7 @@ def delete_organization(object_id, transaction_id=None, continuous=True, **kwarg
 
     model_list = (
         OrganizationMember, CommitFileChange, Commit, CommitAuthor,
-        Repository, Release, ReleaseCommit, ReleaseFile
+        Environment, Repository, Release, ReleaseCommit, ReleaseFile
     )
 
     has_more = delete_objects(
@@ -128,7 +128,7 @@ def delete_project(object_id, transaction_id=None, continuous=True, **kwargs):
         GroupRuleStatus, GroupSeen, GroupSubscription, GroupSnooze, GroupTagKey,
         GroupTagValue, Project, ProjectBookmark, ProjectKey, ProjectStatus,
         ReleaseEnvironment, ReleaseProject, SavedSearchUserDefault, SavedSearch,
-        TagKey, TagValue, UserReport, Environment
+        TagKey, TagValue, UserReport, EnvironmentProject
     )
 
     try:
@@ -158,7 +158,7 @@ def delete_project(object_id, transaction_id=None, continuous=True, **kwargs):
         GroupEmailThread, GroupHash, GroupRelease, GroupRuleStatus, GroupSeen,
         GroupSubscription, GroupTagKey, GroupTagValue, ProjectBookmark,
         ProjectKey, TagKey, TagValue, SavedSearchUserDefault, SavedSearch,
-        UserReport, ReleaseEnvironment, Environment
+        UserReport, ReleaseEnvironment, EnvironmentProject
     )
     for model in model_list:
         has_more = bulk_delete_objects(model, project_id=p.id, transaction_id=transaction_id, logger=logger)
diff --git a/tests/sentry/tasks/test_deletion.py b/tests/sentry/tasks/test_deletion.py
index 352d8a13c9..2f4075222f 100644
--- a/tests/sentry/tasks/test_deletion.py
+++ b/tests/sentry/tasks/test_deletion.py
@@ -5,7 +5,7 @@ import pytest
 from sentry.constants import ObjectStatus
 from sentry.exceptions import DeleteAborted
 from sentry.models import (
-    Event, EventMapping, EventTag,
+    Environment, EnvironmentProject, Event, EventMapping, EventTag,
     Group, GroupAssignee, GroupMeta, GroupResolution, GroupRedirect, GroupStatus, GroupTagKey,
     GroupTagValue, Organization, OrganizationStatus, Project, ProjectStatus,
     Release, TagKey, TagValue, Team, TeamStatus, Commit, CommitAuthor,
@@ -50,10 +50,17 @@ class DeleteOrganizationTest(TestCase):
             order=0,
         )
 
+        env = Environment.objects.create(
+            organization_id=org.id,
+            project_id=4,
+            name='foo'
+        )
+
         with self.tasks():
             delete_organization(object_id=org.id)
 
         assert not Organization.objects.filter(id=org.id).exists()
+        assert not Environment.objects.filter(id=env.id).exists()
         assert not Repository.objects.filter(id=repo.id).exists()
         assert not ReleaseCommit.objects.filter(organization_id=org.id).exists()
         assert not Release.objects.filter(organization_id=org.id).exists()
@@ -117,6 +124,12 @@ class DeleteProjectTest(TestCase):
                                          organization_id=project.organization_id)
         release.add_project(project)
         GroupResolution.objects.create(group=group, release=release)
+        env = Environment.objects.create(
+            organization_id=project.organization_id,
+            project_id=project.id,
+            name='foo'
+        )
+        env.add_project(project)
         repo = Repository.objects.create(
             organization_id=project.organization_id,
             name=project.name,
@@ -144,6 +157,11 @@ class DeleteProjectTest(TestCase):
             delete_project(object_id=project.id)
 
         assert not Project.objects.filter(id=project.id).exists()
+        assert not EnvironmentProject.objects.filter(
+            project_id=project.id,
+            environment_id=env.id
+        ).exists()
+        assert Environment.objects.filter(id=env.id).exists()
         assert Release.objects.filter(id=release.id).exists()
         assert ReleaseCommit.objects.filter(release_id=release.id).exists()
         assert Commit.objects.filter(id=commit.id).exists()
