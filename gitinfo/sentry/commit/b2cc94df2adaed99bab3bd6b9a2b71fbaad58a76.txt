commit b2cc94df2adaed99bab3bd6b9a2b71fbaad58a76
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Oct 14 17:09:08 2014 +0100

    Expand stream actions to include remove bookmarks

diff --git a/src/sentry/static/sentry/app/controllers/projectStream.js b/src/sentry/static/sentry/app/controllers/projectStream.js
index e65ad339a5..bf05cd6e2a 100644
--- a/src/sentry/static/sentry/app/controllers/projectStream.js
+++ b/src/sentry/static/sentry/app/controllers/projectStream.js
@@ -16,7 +16,8 @@
     '$scope', '$modalInstance', 'context',
     function($scope, $modalInstance, context) {
       $scope.numEvents = context.selectedGroupIds.length;
-      $scope.actionLabel = context.actionLabel;
+      $scope.actionLabel = context.actionLabel.replace('{count}', $scope.numEvents);
+      $scope.confirmLabel = context.confirmLabel;
       $scope.canActionAll = context.canActionAll;
       $scope.cancel = function(){
         $modalInstance.dismiss('cancel');
@@ -163,6 +164,9 @@
         canUpdate: function(current, pending) {
           return (current.version < pending.version);
         },
+        equals: function(self, other) {
+          return self.id === other.id;
+        },
         limit: 50
       });
 
@@ -198,6 +202,10 @@
       }
       $scope.sortLabel = sortLabel;
 
+      function defaultActionLabel(confirmLabel) {
+        return confirmLabel.toLowerCase() + ' these {count} events';
+      }
+
       function confirmAction(options){
         var selectedGroupIds = $.map($('.group-list .chk-select:checked'), function(item){
           return $(item).val();
@@ -206,6 +214,24 @@
           return;
         }
 
+        var shouldConfirm = true;
+        // if skipConfirm is set we never actually show the modal
+        if (options.skipConfirm === true) {
+          shouldConfirm = false;
+        // if onlyIfBulk is set and we've selected a single item, we skip
+        // showing the modal
+        } else if (options.onlyIfBulk === true && !$scope.selectAllActive) {
+          shouldConfirm = false;
+        }
+
+        if (!shouldConfirm) {
+          return options.action(selectedGroupIds);
+        }
+
+        if (typeof options.confirmLabel === 'undefined') {
+          options.confirmLabel = 'Edit';
+        }
+
         var modal = $modal.open({
           templateUrl: '/templates/action-modal.html',
           controller: 'ProjectStreamActionModalCtrl',
@@ -214,7 +240,8 @@
               return {
                 selectAllActive: $scope.selectAllActive,
                 selectedGroupIds: selectedGroupIds,
-                actionLabel: options.actionLabel,
+                actionLabel: options.actionLabel || defaultActionLabel(options.confirmLabel),
+                confirmLabel: options.confirmLabel,
                 canActionAll: options.canActionAll && $scope.selectAllActive || false
               };
             }
@@ -239,8 +266,11 @@
              groupList = $scope.groupList;
           } else {
             $.each(options.ids, function(_, id){
-              var item = groupList[groupList.indexOf({id: id})];
-              groupList.push(item);
+              var idx = $scope.groupList.indexOf({id: id});
+              if (idx === -1) {
+                return;
+              }
+              groupList.push($scope.groupList[idx]);
             });
           }
           $.each(groupList, function(_, item){
@@ -256,8 +286,9 @@
         e.preventDefault();
 
         confirmAction({
-          actionLabel: 'Resolve',
+          confirmLabel: 'Resolve',
           canActionAll: true,
+          onlyIfBulk: true,
           action: function(selectedGroupIds){
             actionGroups({
               ids: selectedGroupIds,
@@ -271,8 +302,7 @@
         e.preventDefault();
 
         confirmAction({
-          actionLabel: 'Merge',
-          canActionAll: true,
+          confirmLabel: 'Merge',
           action: function(selectedGroupIds){
             actionGroups({
               ids: selectedGroupIds,
@@ -287,7 +317,7 @@
         e.preventDefault();
 
         confirmAction({
-          actionLabel: 'Delete',
+          confirmLabel: 'Delete',
           action: function(selectedGroupIds){
             actionGroups({
               ids: selectedGroupIds,
@@ -302,7 +332,8 @@
         e.preventDefault();
 
         confirmAction({
-          actionLabel: 'Bookmark',
+          neverConfirm: true,
+          confirmLabel: 'Bookmark',
           action: function(selectedGroupIds){
             actionGroups({
               ids: selectedGroupIds,
@@ -312,6 +343,21 @@
         });
       });
 
+      $('.stream-actions .action-remove-bookmark').click(function(e){
+        e.preventDefault();
+
+        confirmAction({
+          neverConfirm: true,
+          actionLabel: 'remove these {count} events from your bookmarks',
+          action: function(selectedGroupIds){
+            actionGroups({
+              ids: selectedGroupIds,
+              data: {isBookmarked: 0}
+            });
+          }
+        });
+      });
+
       $('.stream-actions .datepicker-box').click(function(e){
         e.preventDefault();
       });
diff --git a/src/sentry/static/sentry/app/templates/action-modal.html b/src/sentry/static/sentry/app/templates/action-modal.html
index 310b323f93..903016294b 100644
--- a/src/sentry/static/sentry/app/templates/action-modal.html
+++ b/src/sentry/static/sentry/app/templates/action-modal.html
@@ -6,7 +6,7 @@
   <h4 class="modal-title">Please confirm</h4>
 </div>
 <div class="modal-body">
-  <p><strong>Are you sure that you want to <% actionLabel.toLowerCase() %> these <% numEvents %> events?</strong></p>
+  <p><strong>Are you sure that you want to <% actionLabel %>?</strong></p>
   <p>This action cannot be undone.</p>
 </div>
 <div class="modal-footer">
@@ -14,7 +14,7 @@
           ng-click="close()">Cancel</button>
   <button type="button" class="btn btn-danger"
           ng-if="canActionAll"
-          ng-click="actionAll()"><% actionLabel %> all recorded events</button>
+          ng-click="actionAll()"><% confirmLabel %> all recorded events</button>
   <button type="button" class="btn btn-primary"
-          ng-click="actionSelected()"><% actionLabel %> <% numEvents %> selected events</button>
+          ng-click="actionSelected()"><% confirmLabel %> <% numEvents %> selected events</button>
 </div>
diff --git a/src/sentry/templates/sentry/groups/group_list.html b/src/sentry/templates/sentry/groups/group_list.html
index b618100cd7..a771586310 100644
--- a/src/sentry/templates/sentry/groups/group_list.html
+++ b/src/sentry/templates/sentry/groups/group_list.html
@@ -30,9 +30,10 @@
                     </a>
 
                     <ul class="dropdown-menu more-menu" style="left: 0">
-                      <li><a href="javascript:void(0)" class="action action-merge">Merge events</a></li>
+                      <li><a href="javascript:void(0)" class="action action-merge">Merge Events</a></li>
+                      <li><a href="javascript:void(0)" class="action action-remove-bookmark">Remove from Bookmarks</a></li>
                       <li class="divider"></li>
-                      <li><a href="javascript:void(0)" class="action action-delete">Delete events</a></li>
+                      <li><a href="javascript:void(0)" class="action action-delete">Delete Events</a></li>
                     </ul>
                 </div>
 
