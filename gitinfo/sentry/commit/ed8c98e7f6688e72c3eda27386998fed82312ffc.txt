commit ed8c98e7f6688e72c3eda27386998fed82312ffc
Author: David Cramer <dcramer@gmail.com>
Date:   Mon May 13 18:56:27 2013 -0700

    Skip kombu in addition to social_auth if migration is already applied

diff --git a/docs/upgrading/index.rst b/docs/upgrading/index.rst
index a7a815e6a6..ec27db81f7 100644
--- a/docs/upgrading/index.rst
+++ b/docs/upgrading/index.rst
@@ -18,30 +18,6 @@ Continue by running all required migrations, with the upgrade command::
 
 Finally, restart any Sentry services you had running.
 
-Conflicts with kombu.transport.django
-~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
-
-A recent release of Kombu (2.1.6) added support for South migrations. This means that if you had an older
-version of Kombu installed, you'll need to "fake" the migrations, as they were already applied.
-
-**You should only do this is you actually receive an error while migrating.**
-
-To fake the migrations, run the following::
-
-    sentry migrate kombu.transport.django 0001 --fake
-
-Conflicts with social_auth
-~~~~~~~~~~~~~~~~~~~~~~~~~~
-
-A recent release of django-social-auth (0.7.18) added support for South migrations. This means that if you had an older
-version of the package installed, you'll need to "fake" the migrations, as they were already applied.
-
-**You should only do this is you actually receive an error while migrating.**
-
-To fake the migrations, run the following::
-
-    sentry migrate social_auth 0001 --fake
-
 Upgrading from 1.x
 ~~~~~~~~~~~~~~~~~~
 
diff --git a/src/sentry/utils/runner.py b/src/sentry/utils/runner.py
index 14040caeda..bcb0787c45 100644
--- a/src/sentry/utils/runner.py
+++ b/src/sentry/utils/runner.py
@@ -189,7 +189,10 @@ def initialize_app(config):
 
     install_plugins(config['settings'])
 
-    patch_socal_auth(config['settings'])
+    skip_initial_migration_if_applied(
+        config['settings'], 'kombu.contrib.django', 'djkombu_queue')
+    skip_initial_migration_if_applied(
+        config['settings'], 'social_auth', 'social_auth_association')
 
 
 def table_exists(name):
@@ -197,17 +200,17 @@ def table_exists(name):
     return name in connections['default'].introspection.table_names()
 
 
-def patch_socal_auth(settings):
+def skip_initial_migration_if_applied(settings, app_name, table_name):
     from south.migration import Migrations
     import types
 
-    migrations = Migrations('social_auth')
+    migrations = Migrations(app_name)
     # fix the initial migration
     initial = migrations['0001_initial']
 
     def initial_forwards(original):
         def wrapped(self):
-            if table_exists('social_auth_association'):
+            if table_exists(table_name):
                 return
             return original()
         return wrapped
@@ -215,11 +218,6 @@ def patch_socal_auth(settings):
     initial.forwards = types.MethodType(
         initial_forwards(initial.forwards), initial.forwards)
 
-    # now fix all of the migrations so they reference sentry.User
-    for migration in migrations:
-        migration = migration.migration_class()
-        migration.models['sentry.user'] = migration.models['auth.user']
-
 
 def configure():
     configure_app(
