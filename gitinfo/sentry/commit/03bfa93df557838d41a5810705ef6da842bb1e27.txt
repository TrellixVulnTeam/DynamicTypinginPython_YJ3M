commit 03bfa93df557838d41a5810705ef6da842bb1e27
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Fri Sep 28 15:39:54 2018 -0700

    fix(integrations): Unset integration id for repos when int is removed from org

diff --git a/src/sentry/api/endpoints/organization_integration_details.py b/src/sentry/api/endpoints/organization_integration_details.py
index 575eee04a3..34fa8774c3 100644
--- a/src/sentry/api/endpoints/organization_integration_details.py
+++ b/src/sentry/api/endpoints/organization_integration_details.py
@@ -28,7 +28,7 @@ class OrganizationIntegrationDetailsEndpoint(OrganizationEndpoint):
         return self.respond(serialize(integration, request.user))
 
     def delete(self, request, organization, integration_id):
-        # Removing the integration removes the organization and project
+        # Removing the integration removes the organization
         # integrations and all linked issues.
         try:
             org_integration = OrganizationIntegration.objects.get(
diff --git a/src/sentry/tasks/deletion.py b/src/sentry/tasks/deletion.py
index 6c6a0baa2b..f989f5b5e2 100644
--- a/src/sentry/tasks/deletion.py
+++ b/src/sentry/tasks/deletion.py
@@ -400,7 +400,7 @@ def delete_repository(object_id, transaction_id=None, actor_id=None, **kwargs):
 @retry(exclude=(DeleteAborted, ))
 def delete_organization_integration(object_id, transaction_id=None, actor_id=None, **kwargs):
     from sentry import deletions
-    from sentry.models import OrganizationIntegration
+    from sentry.models import OrganizationIntegration, Repository
 
     try:
         instance = OrganizationIntegration.objects.get(id=object_id)
@@ -410,6 +410,14 @@ def delete_organization_integration(object_id, transaction_id=None, actor_id=Non
     if instance.status == ObjectStatus.VISIBLE:
         raise DeleteAborted
 
+    # dissociate repos from that integration
+    Repository.objects.filter(
+        organization_id=instance.organization_id,
+        integration_id=instance.integration_id,
+    ).update(
+        integration_id=None,
+    )
+
     task = deletions.get(
         model=OrganizationIntegration,
         actor_id=actor_id,
diff --git a/tests/sentry/api/endpoints/test_organization_integration_details.py b/tests/sentry/api/endpoints/test_organization_integration_details.py
index f6687c349d..3876b6e370 100644
--- a/tests/sentry/api/endpoints/test_organization_integration_details.py
+++ b/tests/sentry/api/endpoints/test_organization_integration_details.py
@@ -2,7 +2,7 @@ from __future__ import absolute_import
 
 import six
 
-from sentry.models import Integration, OrganizationIntegration
+from sentry.models import Integration, OrganizationIntegration, Repository
 from sentry.testutils import APITestCase
 
 
@@ -18,6 +18,13 @@ class OrganizationIntegrationDetailsTest(APITestCase):
         )
         self.integration.add_organization(self.org, self.user)
 
+        self.repo = Repository.objects.create(
+            provider='example',
+            name='getsentry/sentry',
+            organization_id=self.org.id,
+            integration_id=self.integration.id,
+        )
+
         self.path = u'/api/0/organizations/{}/integrations/{}/'.format(
             self.org.slug, self.integration.id)
 
@@ -40,6 +47,9 @@ class OrganizationIntegrationDetailsTest(APITestCase):
                 organization=self.org,
             ).exists()
 
+            # make sure repo is dissociated from integration
+            assert Repository.objects.get(id=self.repo.id).integration_id is None
+
     def test_update_config(self):
         config = {
             'setting': 'new_value',
