commit f58ca5eef79a8fc1091703d72611e8e3e63b34a0
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Tue Oct 25 13:17:26 2016 -0700

    filestore: Wrap boto3 initialization in a thread lock (#4429)
    
    Initialization isn't thread safe.
    
    See:
    * https://github.com/boto/botocore/pull/1033
    * https://github.com/boto/botocore/issues/577

diff --git a/src/sentry/filestore/s3.py b/src/sentry/filestore/s3.py
index d2e31ed85a..c9edb7550d 100644
--- a/src/sentry/filestore/s3.py
+++ b/src/sentry/filestore/s3.py
@@ -41,6 +41,7 @@ import posixpath
 import mimetypes
 from gzip import GzipFile
 from tempfile import SpooledTemporaryFile
+from threading import Lock
 
 from django.conf import settings
 from django.core.exceptions import ImproperlyConfigured, SuspiciousOperation
@@ -136,6 +137,7 @@ class S3Boto3StorageFile(File):
         if buffer_size is not None:
             self.buffer_size = buffer_size
         self._write_counter = 0
+        self._lock = Lock()
 
     @property
     def size(self):
@@ -314,15 +316,16 @@ class S3Boto3Storage(Storage):
         # urllib/requests libraries read. See https://github.com/boto/boto3/issues/338
         # and http://docs.python-requests.org/en/latest/user/advanced/#proxies
         if self._connection is None:
-            self._connection = self.connection_class(
-                self.connection_service_name,
-                aws_access_key_id=self.access_key,
-                aws_secret_access_key=self.secret_key,
-                region_name=self.region_name,
-                use_ssl=self.use_ssl,
-                endpoint_url=self.endpoint_url,
-                config=self.config
-            )
+            with self._lock:
+                self._connection = self.connection_class(
+                    self.connection_service_name,
+                    aws_access_key_id=self.access_key,
+                    aws_secret_access_key=self.secret_key,
+                    region_name=self.region_name,
+                    use_ssl=self.use_ssl,
+                    endpoint_url=self.endpoint_url,
+                    config=self.config
+                )
         return self._connection
 
     @property
