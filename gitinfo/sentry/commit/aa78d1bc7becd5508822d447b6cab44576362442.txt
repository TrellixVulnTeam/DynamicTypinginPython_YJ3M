commit aa78d1bc7becd5508822d447b6cab44576362442
Author: Mark Story <mark@sentry.io>
Date:   Tue Sep 4 13:54:54 2018 -0400

    fix(orgs) Track last used organization for API requests
    
    By tracking the organization when it changes we can redirect users to
    their last used organization when they visit sentry.io/. The session
    should only be updated when the request came from a cookie based
    request.
    
    I've only instrumented this endpoint as it is used by our react app when
    organizations switch and I wanted to minimize the impact/overhead this
    may incur.
    
    Fixes #6859

diff --git a/src/sentry/api/bases/organization.py b/src/sentry/api/bases/organization.py
index bd755634bd..a0e521f9ea 100644
--- a/src/sentry/api/bases/organization.py
+++ b/src/sentry/api/bases/organization.py
@@ -145,9 +145,13 @@ class OrganizationEndpoint(Endpoint):
         raven.tags_context({
             'organization': organization.id,
         })
-
         request._request.organization = organization
 
+        # Track the 'active' organization when the request came from
+        # a cookie based agent (react app)
+        if request.auth is None and request.user:
+            request.session['activeorg'] = organization.slug
+
         kwargs['organization'] = organization
         return (args, kwargs)
 
diff --git a/tests/sentry/api/endpoints/test_organization_projects.py b/tests/sentry/api/endpoints/test_organization_projects.py
index ff5c5c34bc..bb3a609f86 100644
--- a/tests/sentry/api/endpoints/test_organization_projects.py
+++ b/tests/sentry/api/endpoints/test_organization_projects.py
@@ -19,6 +19,7 @@ class OrganizationProjectsTest(APITestCase):
         assert response.status_code == 200, response.content
         assert len(response.data) == 1
         assert response.data[0]['id'] == six.text_type(project.id)
+        assert self.client.session['activeorg'] == org.slug
 
     def test_with_stats(self):
         self.login_as(user=self.user)
