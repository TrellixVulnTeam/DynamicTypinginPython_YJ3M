commit f63fb9cbb691c365a20eef6351e7efb5c3861483
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Feb 13 12:23:00 2013 -0800

    Capture trends with project-wide alerts

diff --git a/src/sentry/models.py b/src/sentry/models.py
index 3b7986d05b..aec014d298 100644
--- a/src/sentry/models.py
+++ b/src/sentry/models.py
@@ -36,12 +36,13 @@ from django.utils.translation import ugettext_lazy as _
 from sentry.conf import settings
 from sentry.constants import (STATUS_LEVELS, MEMBER_TYPES,
     MEMBER_OWNER, MEMBER_USER, PLATFORM_TITLES, PLATFORM_LIST,
-    STATUS_VISIBLE, STATUS_HIDDEN)
+    STATUS_VISIBLE, STATUS_HIDDEN, MINUTE_NORMALIZATION)
 from sentry.manager import (GroupManager, ProjectManager,
     MetaManager, InstanceMetaManager, SearchDocumentManager, BaseManager,
     UserOptionManager, FilterKeyManager, TeamManager)
 from sentry.signals import buffer_incr_complete, regression_signal
 from sentry.utils import cached_property, MockDjangoRequest
+from sentry.utils.db import has_trending
 from sentry.utils.models import Model, GzippedDictField, update
 from sentry.utils.imports import import_string
 from sentry.utils.safe import safe_execute
@@ -1049,11 +1050,20 @@ class Alert(Model):
         if manager.filter(project=project_id, group=group_id, datetime__gte=now - timedelta(minutes=60)).exists():
             return
 
+        if not group_id and has_trending():
+            # Capture the top 5 trending events at the time of this error
+            related_groups = Group.objects.get_accelerated([project_id], minutes=MINUTE_NORMALIZATION)[:5]
+            data = [{'id': g.id, 'times_seen': g.times_seen, 'sort_value': g.sort_value}
+                for g in related_groups]
+        else:
+            data = None
+
         return manager.create(
             project_id=project_id,
             group_id=group_id,
             datetime=now,
             message=message,
+            data=data,
         )
 
 
