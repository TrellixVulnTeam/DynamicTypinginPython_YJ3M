commit 7ebdafe24dcf4796fa652711d831f47e3b44be43
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue Mar 1 21:31:27 2016 +0100

    Added endpoint to check dsym presence by checksum

diff --git a/src/sentry/api/endpoints/dsym_files.py b/src/sentry/api/endpoints/dsym_files.py
index 5f373c5329..c35fc55d04 100644
--- a/src/sentry/api/endpoints/dsym_files.py
+++ b/src/sentry/api/endpoints/dsym_files.py
@@ -10,7 +10,8 @@ from sentry.api.bases.project import ProjectEndpoint
 from sentry.api.permissions import SystemPermission
 from sentry.api.paginator import OffsetPaginator
 from sentry.api.serializers import serialize
-from sentry.models import ProjectDSymFile, create_files_from_macho_zip
+from sentry.models import ProjectDSymFile, create_files_from_macho_zip, \
+    find_missing_dsym_files
 
 ERR_FILE_EXISTS = 'A file matching this uuid already exists'
 
@@ -97,8 +98,10 @@ class GlobalDSymFilesEndpoint(Endpoint):
         return upload_from_request(request, project=None)
 
 
-class UnknownDSymFilesEndpoint(Endpoint):
-    permission_classes = (SystemPermission,)
+class UnknownDSymFilesEndpoint(ProjectEndpoint):
+    doc_section = DocSection.PROJECTS
 
-    def post(self, request):
-        return upload_from_request(request, project=None)
+    def get(self, request, project):
+        checksums = request.GET.getlist('checksums')
+        missing = find_missing_dsym_files(project, checksums)
+        return Response({'missing': missing})
diff --git a/src/sentry/api/urls.py b/src/sentry/api/urls.py
index f16c892cda..f2e7cf9d4e 100644
--- a/src/sentry/api/urls.py
+++ b/src/sentry/api/urls.py
@@ -60,7 +60,8 @@ from .endpoints.project_user_reports import ProjectUserReportsEndpoint
 from .endpoints.release_details import ReleaseDetailsEndpoint
 from .endpoints.release_files import ReleaseFilesEndpoint
 from .endpoints.release_file_details import ReleaseFileDetailsEndpoint
-from .endpoints.dsym_files import DSymFilesEndpoint, GlobalDSymFilesEndpoint
+from .endpoints.dsym_files import DSymFilesEndpoint, GlobalDSymFilesEndpoint, \
+    UnknownDSymFilesEndpoint
 from .endpoints.shared_group_details import SharedGroupDetailsEndpoint
 from .endpoints.system_health import SystemHealthEndpoint
 from .endpoints.system_options import SystemOptionsEndpoint
@@ -217,6 +218,9 @@ urlpatterns = patterns(
     url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/files/dsyms/$',
         DSymFilesEndpoint.as_view(),
         name='sentry-api-0-dsym-files'),
+    url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/files/dsyms/unknown/$',
+        UnknownDSymFilesEndpoint.as_view(),
+        name='sentry-api-0-unknown-dsym-files'),
     url(r'^projects/(?P<organization_slug>[^\/]+)/(?P<project_slug>[^\/]+)/rules/$',
         ProjectRulesEndpoint.as_view(),
         name='sentry-api-0-project-rules'),
diff --git a/src/sentry/models/dsymfile.py b/src/sentry/models/dsymfile.py
index b0bfd4fc76..4c9409d2f3 100644
--- a/src/sentry/models/dsymfile.py
+++ b/src/sentry/models/dsymfile.py
@@ -177,3 +177,28 @@ def find_dsym_file(project, image_uuid):
         ).select_related('file', 'file__blob').get()
     except GlobalDSymFile.DoesNotExist:
         return None
+
+
+def find_missing_dsym_files(project, checksums):
+    checksums = [x.lower() for x in checksums]
+
+    found = ProjectDSymFile.objects.filter(
+        file__checksum__in=checksums,
+        project=project
+    ).values('file__checksum')
+
+    missing = set(checksums)
+    for values in found:
+        missing.discard(values.values()[0])
+
+    if not missing:
+        return []
+
+    found = GlobalDSymFile.objects.filter(
+        file__checksum__in=list(missing),
+    ).values('file__checksum')
+
+    for values in found:
+        missing.discard(values.values()[0])
+
+    return list(missing)
