commit 49c1b03202fe24bf02fed4fe6caeac159114ed9e
Author: David Cramer <dcramer@gmail.com>
Date:   Tue May 7 17:29:08 2013 -0700

    Optimize attach_foreignkey when theres a single value to lookup

diff --git a/src/sentry/models.py b/src/sentry/models.py
index 39d789bf09..391d6ddcbb 100644
--- a/src/sentry/models.py
+++ b/src/sentry/models.py
@@ -385,7 +385,9 @@ class ProjectOption(Model):
     key = models.CharField(max_length=64)
     value = PickledObjectField()
 
-    objects = InstanceMetaManager('project')
+    objects = InstanceMetaManager('project', cache_fields=[
+        'project_id',
+    ])
 
     class Meta:
         db_table = 'sentry_projectoptions'
diff --git a/src/sentry/utils/db.py b/src/sentry/utils/db.py
index c1145a9fe6..91be60bc8a 100644
--- a/src/sentry/utils/db.py
+++ b/src/sentry/utils/db.py
@@ -116,12 +116,17 @@ def attach_foreignkey(objects, field, related=[], database=None):
     # values specified in select_related
     values = set(filter(None, (getattr(o, column) for o in objects)))
     if values:
-        qs = model.objects.filter(**{'%s__in' % lookup: values})
+        qs = model.objects
         if database:
             qs = qs.using(database)
         if related:
             qs = qs.select_related(*related)
 
+        if len(values) > 1:
+            qs = qs.filter(**{'%s__in' % lookup: values})
+        else:
+            qs = [qs.get(**{lookup: iter(values).next()})]
+
         queryset = dict((getattr(o, key), o) for o in qs)
     else:
         queryset = {}
