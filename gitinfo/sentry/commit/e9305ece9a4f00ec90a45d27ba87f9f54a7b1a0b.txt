commit e9305ece9a4f00ec90a45d27ba87f9f54a7b1a0b
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Mon Mar 18 10:53:31 2019 -0700

    dev: Ensure docker binds to an interface
    
    Default the interface to bind to 127.0.0.1

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index d7e9eda481..a6fe4f3f43 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -1362,7 +1362,7 @@ SENTRY_DEVSERVICES = {
         'environment': {
             'KAFKA_ZOOKEEPER_CONNECT': '{containers[zookeeper][name]}:2181',
             'KAFKA_LISTENERS': 'INTERNAL://0.0.0.0:9093,EXTERNAL://0.0.0.0:9092',
-            'KAFKA_ADVERTISED_LISTENERS': 'INTERNAL://{containers[kafka][name]}:9093,EXTERNAL://127.0.0.1:{containers[kafka][ports][9092/tcp]}',
+            'KAFKA_ADVERTISED_LISTENERS': 'INTERNAL://{containers[kafka][name]}:9093,EXTERNAL://{containers[kafka][ports][9092/tcp][0]}:{containers[kafka][ports][9092/tcp][1]}',
             'KAFKA_LISTENER_SECURITY_PROTOCOL_MAP': 'INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT',
             'KAFKA_INTER_BROKER_LISTENER_NAME': 'INTERNAL',
             'KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR': '1',
diff --git a/src/sentry/runner/commands/devservices.py b/src/sentry/runner/commands/devservices.py
index d0355ec81c..f3526fc3c0 100644
--- a/src/sentry/runner/commands/devservices.py
+++ b/src/sentry/runner/commands/devservices.py
@@ -23,6 +23,17 @@ def get_or_create(client, thing, name):
         return getattr(client, thing + 's').create(name)
 
 
+def ensure_interface(ports):
+    # If there is no interface specified, make sure the
+    # default interface is 127.0.0.1
+    rv = {}
+    for k, v in ports.items():
+        if not isinstance(v, tuple):
+            v = ('127.0.0.1', v)
+        rv[k] = v
+    return rv
+
+
 class SetType(click.ParamType):
     name = 'set'
 
@@ -89,6 +100,7 @@ def up(project, exclude):
         options.setdefault('ports', {})
         options.setdefault('environment', {})
         options.setdefault('restart_policy', {'Name': 'on-failure'})
+        options['ports'] = ensure_interface(options['ports'])
         containers[name] = options
 
     pulled = set()
