commit d3160fe71d7e6b418b95f4a80e2744e91525b0a2
Author: Ted Kaemming <ted@kaemming.com>
Date:   Thu Sep 24 14:00:11 2015 -0700

    Add events to digests as part of `NotificationPlugin`.

diff --git a/src/sentry/plugins/bases/notify.py b/src/sentry/plugins/bases/notify.py
index f16b490f9f..730465d868 100644
--- a/src/sentry/plugins/bases/notify.py
+++ b/src/sentry/plugins/bases/notify.py
@@ -12,9 +12,14 @@ import logging
 from django import forms
 
 from sentry import features
-from sentry.app import ratelimiter
+from sentry.app import (
+    digests,
+    ratelimiter,
+)
+from sentry.digests.base import Record
 from sentry.plugins import Notification, Plugin
 from sentry.models import UserOption
+from sentry.utils.dates import to_timestamp
 
 
 class NotificationConfigurationForm(forms.Form):
@@ -57,7 +62,14 @@ class NotificationPlugin(Plugin):
 
         notification = Notification(event=event, rules=rules)
         if features.has('projects:digests', event.group.project):
-            raise NotImplementedError
+            payload = (event.project_id, event.group_id, event.id, event.data.data, rules)
+            digests.add(
+                '{plugin.slug}:p:{project.id}'.format(
+                    plugin=self,
+                    project=event.group.project,
+                ),
+                Record(event.event_id, payload, to_timestamp(event.datetime)),
+            )
         else:
             self.notify(notification)
 
@@ -97,7 +109,7 @@ class NotificationPlugin(Plugin):
         # If digests are enabled for this project, we always want to add the
         # notification to the digest (even if it may be filtered out later.)
         if features.has('projects:digests', group.project):
-            raise NotImplementedError
+            return True
 
         if group.is_muted():
             return False
diff --git a/tests/sentry/digests/test_redis.py b/tests/sentry/digests/test_redis.py
index 2d07e3d548..6967fe0163 100644
--- a/tests/sentry/digests/test_redis.py
+++ b/tests/sentry/digests/test_redis.py
@@ -4,9 +4,7 @@ import functools
 import itertools
 import mock
 import time
-from datetime import datetime
 
-import pytz
 from exam import fixture
 from redis.client import StrictRedis
 
@@ -28,10 +26,6 @@ from sentry.digests.redis import (
 from sentry.testutils import TestCase
 
 
-def to_timestamp(value):
-    return (value - datetime(1970, 1, 1, tzinfo=pytz.utc)).total_seconds()
-
-
 def get_set_size(cluster, key):
     results = []
     with cluster.all() as client:
