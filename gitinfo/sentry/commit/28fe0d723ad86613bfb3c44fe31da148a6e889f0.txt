commit 28fe0d723ad86613bfb3c44fe31da148a6e889f0
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Apr 16 12:26:22 2011 -0700

    Change default sentry client format to use new JSON storage

diff --git a/sentry/client/base.py b/sentry/client/base.py
index 4468b61159..6663561351 100644
--- a/sentry/client/base.py
+++ b/sentry/client/base.py
@@ -14,6 +14,7 @@ import uuid
 from django.core.cache import cache
 from django.template import TemplateSyntaxError
 from django.template.loader import LoaderOrigin
+from django.utils import simplejson
 from django.views.debug import ExceptionReporter
 
 from sentry import conf
@@ -131,7 +132,8 @@ class SentryClient(object):
         if conf.REMOTE_URL:
             for url in conf.REMOTE_URL:
                 data = {
-                    'data': base64.b64encode(pickle.dumps(kwargs).encode('zlib')),
+                    'data': base64.b64encode(simplejson.dumps(kwargs).encode('zlib')),
+                    'format': 'json',
                     'key': conf.KEY,
                 }
                 try:
diff --git a/sentry/views.py b/sentry/views.py
index 30ca46918a..a47971af53 100644
--- a/sentry/views.py
+++ b/sentry/views.py
@@ -353,17 +353,34 @@ def store(request):
     key = request.POST.get('key')
     if key != conf.KEY:
         return HttpResponseForbidden('Invalid credentials')
+
+    format = request.POST.get('format', 'pickle')
+    if format not in ('pickle', 'json'):
+        return HttpResponseForbidden('Invalid format')
     
     data = request.POST.get('data')
     if not data:
         return HttpResponseForbidden('Missing data')
+
+    logger = logging.getLogger('sentry.server')
+
     try:
         try:
-            data = pickle.loads(base64.b64decode(data).decode('zlib'))
+            data = base64.b64decode(data).decode('zlib')
         except zlib.error:
-            data = pickle.loads(base64.b64decode(data))
+            data = base64.b64decode(data)
+    except Exception, e:
+        # This error should be caught as it suggests that there's a
+        # bug somewhere in the Sentry code.
+        logger.exception('Bad data received')
+        return HttpResponseForbidden('Bad data')
+
+    try:
+        if format == 'pickle':
+            data = pickle.loads(data)
+        elif format == 'json':
+            data = simplejson.loads(data)
     except Exception, e:
-        logger = logging.getLogger('sentry.server')
         # This error should be caught as it suggests that there's a
         # bug somewhere in the Sentry code.
         logger.exception('Bad data received')
