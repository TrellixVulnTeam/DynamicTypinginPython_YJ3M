commit fdf7506797b8d382b002facc1bb3d47a430d57ac
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Feb 7 02:01:53 2012 -0800

    Added account settings panel

diff --git a/sentry/templates/sentry/account/settings.html b/sentry/templates/sentry/account/settings.html
new file mode 100644
index 0000000000..86ce977efd
--- /dev/null
+++ b/sentry/templates/sentry/account/settings.html
@@ -0,0 +1,58 @@
+{% extends "sentry/layout.html" %}
+
+{% load i18n %}
+
+{% block title %}{% trans "Account Settings" %} | {{ block.super }}{% endblock %}
+
+{% block bodyclass %}{% endblock %}
+
+{% block page_header %}
+    <ul class="breadcrumb">
+        <li><a href="#">{% trans "Account Settings" %}</a></li>
+        {% block breadcrumb %}{% endblock %}
+    </ul>
+{% endblock %}
+
+{% block heading %}
+    {% trans "Account Settings" %}
+{% endblock %}
+
+{% block content %}
+    <section class="body">
+        <form action="" method="post">
+            {% csrf_token %}
+            {% if form.non_field_errors %}
+                <div class="alert alert-block alert-error">
+                    <p>{% trans "There were errors saving your changes:" %}</p>
+                    <ul>
+                        {% for error in form.non_field_errors %}
+                            <li>{{ error }}</li>
+                        {% endfor %}
+                    </ul>
+                </div>
+            {% endif %}
+            <p>To make changes to your account, you must first enter your current password.</p>
+            {% with form.old_password as field %}
+                {% include "sentry/partial/_form_field.html" %}
+            {% endwith %}
+            <hr>
+            {% with form.first_name as field %}
+                {% include "sentry/partial/_form_field.html" %}
+            {% endwith %}
+            {% with form.email as field %}
+                {% include "sentry/partial/_form_field.html" %}
+            {% endwith %}
+            <hr>
+            <p>You may also optionally change your password.</p>
+            {% with form.new_password1 as field %}
+                {% include "sentry/partial/_form_field.html" %}
+            {% endwith %}
+            {% with form.new_password2 as field %}
+                {% include "sentry/partial/_form_field.html" %}
+            {% endwith %}
+            <fieldset class="form-actions">
+                <button type="submit" class="btn btn-primary">{% trans "Save Changes" %}</button>
+            </fieldset>
+        </form>
+    </section>
+{% endblock %}
diff --git a/sentry/templates/sentry/header.html b/sentry/templates/sentry/header.html
index 963737c4a2..c13fa7ce6b 100644
--- a/sentry/templates/sentry/header.html
+++ b/sentry/templates/sentry/header.html
@@ -42,7 +42,9 @@
                         <li class="dropdown">
                             <a href="#" class="dropdown-toggle" data-toggle="dropdown">{% trans "Account" %} <span class="caret"></span></a>
                             <ul class="dropdown-menu">
+                                <li><a href="{% url sentry-account-settings %}">{% trans "Settings" %}</a></li>
                                 {% if request.user.is_staff %}
+                                    <li class="divider"></li>
                                     <li><a href="{% url sentry-admin-status %}">{% trans "Admin" %}</a></li>
                                 {% endif %}
                                 <li class="divider"></li>
diff --git a/sentry/web/forms.py b/sentry/web/forms.py
index 767d47998c..09b0192f48 100644
--- a/sentry/web/forms.py
+++ b/sentry/web/forms.py
@@ -6,9 +6,11 @@ sentry.web.forms
 :license: BSD, see LICENSE for more details.
 """
 from django import forms
+from django.contrib.auth.forms import PasswordChangeForm
 from django.contrib.auth.models import User
 from django.utils.encoding import force_unicode
 from django.utils.safestring import mark_safe
+from django.utils.translation import ugettext_lazy as _
 
 from sentry.models import Project, ProjectMember
 from sentry.interfaces import Http
@@ -166,3 +168,41 @@ class RemoveUserForm(forms.Form):
         ('1', 'Disable the account.'),
         ('2', 'Permanently remove the user and their data.'),
     ), widget=forms.RadioSelect(renderer=RadioFieldRenderer))
+
+
+class AccountSettingsForm(forms.Form):
+    old_password = forms.CharField(label=_("Old password"), widget=forms.PasswordInput)
+    email = forms.EmailField()
+    first_name = forms.CharField(required=True, label='Name')
+    new_password1 = forms.CharField(label=_("New password"), widget=forms.PasswordInput, required=False)
+    new_password2 = forms.CharField(label=_("New password confirmation"), widget=forms.PasswordInput, required=False)
+
+    def __init__(self, user, *args, **kwargs):
+        self.user = user
+        super(AccountSettingsForm, self).__init__(*args, **kwargs)
+
+    def clean_new_password2(self):
+        password1 = self.cleaned_data.get('new_password1')
+        password2 = self.cleaned_data.get('new_password2')
+        if password1 and password2:
+            if password1 != password2:
+                raise forms.ValidationError(_("The two password fields didn't match."))
+        return password2
+
+    def clean_old_password(self):
+        """
+        Validates that the old_password field is correct.
+        """
+        old_password = self.cleaned_data["old_password"]
+        if not self.user.check_password(old_password):
+            raise forms.ValidationError(_("Your old password was entered incorrectly. Please enter it again."))
+        return old_password
+
+    def save(self, commit=True):
+        if self.cleaned_data['new_password2']:
+            self.user.set_password(self.cleaned_data['new_password1'])
+        self.user.first_name = self.cleaned_data['first_name']
+        self.user.email = self.cleaned_data['email']
+        if commit:
+            self.user.save()
+        return self.user
diff --git a/sentry/web/frontend/accounts.py b/sentry/web/frontend/accounts.py
index 2f95016fe0..1b01474f66 100644
--- a/sentry/web/frontend/accounts.py
+++ b/sentry/web/frontend/accounts.py
@@ -3,6 +3,8 @@ from django.core.urlresolvers import reverse
 from django.http import HttpResponseRedirect
 from django.views.decorators.csrf import csrf_protect
 
+from sentry.web.decorators import login_required
+from sentry.web.forms import AccountSettingsForm
 from sentry.web.helpers import render_to_response
 
 
@@ -11,15 +13,11 @@ def login(request):
     from django.contrib.auth import login as login_
     from django.contrib.auth.forms import AuthenticationForm
 
-    if request.POST:
-        form = AuthenticationForm(request, request.POST)
-        if form.is_valid():
-            login_(request, form.get_user())
-            return HttpResponseRedirect(request.POST.get('next') or reverse('sentry'))
-        else:
-            request.session.set_test_cookie()
+    form = AuthenticationForm(request, request.POST or None)
+    if form.is_valid():
+        login_(request, form.get_user())
+        return HttpResponseRedirect(request.POST.get('next') or reverse('sentry'))
     else:
-        form = AuthenticationForm(request)
         request.session.set_test_cookie()
 
     context = csrf(request)
@@ -35,3 +33,21 @@ def logout(request):
     logout(request)
 
     return HttpResponseRedirect(reverse('sentry'))
+
+
+@csrf_protect
+@login_required
+def settings(request):
+    form = AccountSettingsForm(request.user, request.POST or None, initial={
+        'email': request.user.email,
+        'first_name': request.user.first_name,
+    })
+    if form.is_valid():
+        user = form.save()
+        return HttpResponseRedirect(reverse('sentry-account-settings') + '?success=1')
+
+    context = csrf(request)
+    context.update({
+        'form': form,
+    })
+    return render_to_response('sentry/account/settings.html', context, request)
diff --git a/sentry/web/urls.py b/sentry/web/urls.py
index 0e6b81cd8e..589c2ad221 100644
--- a/sentry/web/urls.py
+++ b/sentry/web/urls.py
@@ -41,6 +41,7 @@ urlpatterns = patterns('',
 
     url(r'^login/$', accounts.login, name='sentry-login'),
     url(r'^logout/$', accounts.logout, name='sentry-logout'),
+    url(r'^account/settings/$', accounts.settings, name='sentry-account-settings'),
 
     # Management
 
