commit a9ef38e6f77064b4633c10c42d9070487bf25e0b
Author: ted kaemming <t.kaemming+github@gmail.com>
Date:   Mon Sep 19 14:21:47 2016 -0700

    Prevent autoescaping of entities in digest email subjects. (#4172)

diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index fb55858f67..376da82e4f 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -14,7 +14,7 @@ import six
 import sentry
 
 from django.core.urlresolvers import reverse
-from django.template.loader import render_to_string
+from django.utils import dateformat
 from django.utils.encoding import force_text
 from django.utils.safestring import mark_safe
 
@@ -196,6 +196,14 @@ class MailPlugin(NotificationPlugin):
                 send_to=[user_id],
             )
 
+    def get_digest_subject(self, project, counts, date):
+        return u'[{project}] {count} {noun} since {date}'.format(
+            project=project.get_full_name(),
+            count=len(counts),
+            noun='notification' if len(counts) == 1 else 'notifications',
+            date=dateformat.format(date, 'N j, Y, P e'),
+        )
+
     def notify_digest(self, project, digest):
         start, end, counts = get_digest_metadata(digest)
 
@@ -222,10 +230,12 @@ class MailPlugin(NotificationPlugin):
             'counts': counts,
         }
 
+        subject = self.get_digest_subject(project, counts, start)
+
         for user_id in self.get_send_to(project):
             self.add_unsubscribe_link(context, user_id, project)
             self._send_mail(
-                subject=render_to_string('sentry/emails/digests/subject.txt', context).rstrip(),
+                subject=subject,
                 template='sentry/emails/digests/body.txt',
                 html_template='sentry/emails/digests/body.html',
                 project=project,
diff --git a/src/sentry/templates/sentry/emails/digests/subject.txt b/src/sentry/templates/sentry/emails/digests/subject.txt
deleted file mode 100644
index 22bae55677..0000000000
--- a/src/sentry/templates/sentry/emails/digests/subject.txt
+++ /dev/null
@@ -1 +0,0 @@
-[{{ project.get_full_name }}] {{ counts|length }} notification{{ counts|pluralize }} since {{ start|date:"N j, Y, P e" }}
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index 0df6c03d65..0241260007 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -4,7 +4,9 @@ from __future__ import absolute_import
 
 import mock
 import six
+from datetime import datetime
 
+import pytz
 from django.core import mail
 from django.utils import timezone
 from exam import fixture
@@ -242,6 +244,13 @@ class MailPluginTest(TestCase):
         msg = mail.outbox[0]
         assert msg.subject == u'[Sentry] [foo Bar] ERROR: רונית מגן'
 
+    def test_get_digest_subject(self):
+        assert self.plugin.get_digest_subject(
+            mock.Mock(get_full_name=lambda: 'Rick & Morty'),
+            {mock.sentinel.group: 3},
+            datetime(2016, 9, 19, 1, 2, 3, tzinfo=pytz.utc),
+        ) == '[Rick & Morty] 1 notification since Sept. 19, 2016, 1:02 a.m. UTC'
+
     @mock.patch.object(MailPlugin, 'notify', side_effect=MailPlugin.notify, autospec=True)
     @mock.patch.object(MessageBuilder, 'send_async', autospec=True)
     def test_notify_digest(self, send_async, notify):
