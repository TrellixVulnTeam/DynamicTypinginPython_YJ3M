commit 761c66ca6c2506d147aeb299b21ec0f115487206
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Tue Jul 17 17:05:00 2018 -0700

    fix(discover): Convert aggregation aliases to underscores (#9084)
    
    Use an underscore character instead of square brackets for aggregation aliases as [] is not allowed in orderby validation

diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/aggregations/utils.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/aggregations/utils.jsx
index cc8c2d149d..3a3ba54d25 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/aggregations/utils.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/aggregations/utils.jsx
@@ -85,7 +85,10 @@ export function getExternal(internal) {
 
   if (internal.match(uniqRegex)) {
     const column = internal.match(uniqRegex)[1];
-    return ['uniq', column, `uniq_${column}`];
+    const tagMatch = column.match(/^tags\[(.+)]$/);
+    const alias = tagMatch ? `tags_${tagMatch[1]}` : column;
+
+    return ['uniq', column, `uniq_${alias}`];
   }
 
   if (internal.match(avgRegex)) {
diff --git a/tests/js/spec/views/organizationDiscover/aggregations/aggregation.spec.jsx b/tests/js/spec/views/organizationDiscover/aggregations/aggregation.spec.jsx
index 46cd2278a8..5bb76d5fa8 100644
--- a/tests/js/spec/views/organizationDiscover/aggregations/aggregation.spec.jsx
+++ b/tests/js/spec/views/organizationDiscover/aggregations/aggregation.spec.jsx
@@ -8,7 +8,7 @@ describe('Aggregation', function() {
     it('renders empty, count, topK, uniq and avg', function() {
       const data = [
         {value: [null, null, null], expectedTextValue: 'Add aggregation function...'},
-        {value: ['count', null, 'count'], expectedTextValue: 'count'},
+        {value: ['count()', null, 'count'], expectedTextValue: 'count'},
         {
           value: ['uniq', 'environment', 'uniq_environment'],
           expectedTextValue: 'uniq(environment)',
@@ -21,6 +21,10 @@ describe('Aggregation', function() {
           value: ['topK(5)', 'environment', 'topK_5_environment'],
           expectedTextValue: 'topK(5)(environment)',
         },
+        {
+          value: ['uniq', 'tags[message]', 'uniq_tags_message'],
+          expectedTextValue: 'uniq(tags[message])',
+        },
       ];
 
       data.forEach(function(item) {
