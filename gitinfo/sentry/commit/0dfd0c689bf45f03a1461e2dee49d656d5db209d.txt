commit 0dfd0c689bf45f03a1461e2dee49d656d5db209d
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Thu Jun 1 11:14:04 2017 -0700

    Localhost filter includes url (#5339)
    
    * spaces
    
    * refactor and use urlparse
    
    * add test

diff --git a/src/sentry/filters/localhost.py b/src/sentry/filters/localhost.py
index 9130805ec6..00f99f497b 100644
--- a/src/sentry/filters/localhost.py
+++ b/src/sentry/filters/localhost.py
@@ -1,8 +1,10 @@
 from __future__ import absolute_import
 
 from .base import Filter
+from six.moves.urllib.parse import urlparse
 
 LOCAL_IPS = frozenset(['127.0.0.1', '::1'])
+LOCAL_DOMAINS = frozenset(['127.0.0.1', 'localhost'])
 
 
 class LocalhostFilter(Filter):
@@ -16,5 +18,14 @@ class LocalhostFilter(Filter):
         except KeyError:
             return ''
 
+    def get_url(self, data):
+        try:
+            return data['sentry.interfaces.Http']['url'] or ''
+        except KeyError:
+            return ''
+
+    def get_domain(self, data):
+        return urlparse(self.get_url(data)).netloc
+
     def test(self, data):
-        return self.get_ip_address(data) in LOCAL_IPS
+        return self.get_ip_address(data) in LOCAL_IPS or self.get_domain(data) in LOCAL_DOMAINS
diff --git a/tests/sentry/filters/test_localhost.py b/tests/sentry/filters/test_localhost.py
index db63253386..afff609c7b 100644
--- a/tests/sentry/filters/test_localhost.py
+++ b/tests/sentry/filters/test_localhost.py
@@ -10,10 +10,13 @@ class LocalhostFilterTest(TestCase):
     def apply_filter(self, data):
         return self.filter_cls(self.project).test(data)
 
-    def get_mock_data(self, client_ip=None):
+    def get_mock_data(self, client_ip=None, url=None):
         return {
             'sentry.interfaces.User': {
                 'ip_address': client_ip,
+            },
+            'sentry.interfaces.Http': {
+                'url': url,
             }
         }
 
@@ -31,3 +34,20 @@ class LocalhostFilterTest(TestCase):
 
     def test_fails_gracefully_without_user(self):
         assert not self.apply_filter({})
+
+    def test_filters_localhost_domain(self):
+        data = self.get_mock_data(url='http://localhost/something.html')
+        assert self.apply_filter(data)
+
+        data = self.get_mock_data(url='https://localhost')
+        assert self.apply_filter(data)
+
+        data = self.get_mock_data(url='https://127.0.0.1')
+        assert self.apply_filter(data)
+
+    def test_does_not_filter_non_localhost_domain(self):
+        data = self.get_mock_data(url='https://getsentry.com/')
+        assert not self.apply_filter(data)
+
+        data = self.get_mock_data(url='http://example.com/index.html?domain=localhost')
+        assert not self.apply_filter(data)
