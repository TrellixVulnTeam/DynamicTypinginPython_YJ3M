commit f4daec592ebba33b348b91c311239b1234b07f81
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Feb 16 11:31:58 2016 -0800

    Improve project deletion
    
    - Revoke keys first
    - Remove ProjectBookmark

diff --git a/src/sentry/tasks/deletion.py b/src/sentry/tasks/deletion.py
index 7073f19152..f749118f3e 100644
--- a/src/sentry/tasks/deletion.py
+++ b/src/sentry/tasks/deletion.py
@@ -94,8 +94,8 @@ def delete_project(object_id, continuous=True, **kwargs):
         Activity, EventMapping, Group, GroupAssignee, GroupBookmark,
         GroupEmailThread, GroupHash, GroupMeta, GroupResolution,
         GroupRuleStatus, GroupSeen, GroupTagKey, GroupTagValue, Project,
-        ProjectKey, ProjectStatus, Release, ReleaseFile, SavedSearchUserDefault,
-        SavedSearch, TagKey, TagValue, UserReport
+        ProjectBookmark, ProjectKey, ProjectStatus, Release, ReleaseFile,
+        SavedSearchUserDefault, SavedSearch, TagKey, TagValue, UserReport
     )
 
     try:
@@ -110,11 +110,13 @@ def delete_project(object_id, continuous=True, **kwargs):
         pending_delete.send(sender=Project, instance=p)
         p.update(status=ProjectStatus.DELETION_IN_PROGRESS)
 
-    # XXX: remove keys first to prevent additional data from flowing in
+    # Immediately revoke keys
+    ProjectKey.objects.filter(project_id=object_id).delete()
+
     model_list = (
         Activity, EventMapping, GroupAssignee, GroupBookmark, GroupEmailThread,
-        GroupHash, GroupSeen, GroupRuleStatus, GroupTagKey,
-        GroupTagValue, ProjectKey, TagKey, TagValue, SavedSearchUserDefault,
+        GroupHash, GroupSeen, GroupRuleStatus, GroupTagKey, GroupTagValue,
+        ProjectBookmark, ProjectKey, TagKey, TagValue, SavedSearchUserDefault,
         SavedSearch, UserReport
     )
     for model in model_list:
