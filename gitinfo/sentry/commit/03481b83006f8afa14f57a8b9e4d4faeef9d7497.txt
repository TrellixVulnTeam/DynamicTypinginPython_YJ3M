commit 03481b83006f8afa14f57a8b9e4d4faeef9d7497
Author: Katie Lundsgaard <katie@getsentry.com>
Date:   Fri Sep 30 14:28:42 2016 -0700

    Ensure UserEmail object gets created from user email (#4246)

diff --git a/src/sentry/models/useremail.py b/src/sentry/models/useremail.py
index 507fa28ee0..cbf25bfb0a 100644
--- a/src/sentry/models/useremail.py
+++ b/src/sentry/models/useremail.py
@@ -39,3 +39,10 @@ class UserEmail(Model):
 
     def hash_is_valid(self):
         return self.validation_hash and self.date_hash_added > timezone.now() - timedelta(hours=48)
+
+    @classmethod
+    def get_primary_email(self, user):
+        return UserEmail.objects.get_or_create(
+            user=user,
+            email=user.email,
+        )[0]
diff --git a/src/sentry/web/frontend/accounts.py b/src/sentry/web/frontend/accounts.py
index 099de3b53d..bf0569ee1e 100644
--- a/src/sentry/web/frontend/accounts.py
+++ b/src/sentry/web/frontend/accounts.py
@@ -159,7 +159,7 @@ def settings(request):
     form = AccountSettingsForm(
         user, request.POST or None,
         initial={
-            'email': user.email,
+            'email': UserEmail.get_primary_email(user).email,
             'username': user.username,
             'name': user.name,
         },
@@ -314,12 +314,12 @@ def list_identities(request):
 @login_required
 def show_emails(request):
     user = request.user
-    primary_email = user.email
-    alt_emails = user.emails.all().exclude(email=primary_email)
+    primary_email = UserEmail.get_primary_email(user)
+    alt_emails = user.emails.all().exclude(email=primary_email.email)
 
     email_form = EmailForm(user, request.POST or None,
         initial={
-            'primary_email': primary_email,
+            'primary_email': primary_email.email,
         },
     )
 
