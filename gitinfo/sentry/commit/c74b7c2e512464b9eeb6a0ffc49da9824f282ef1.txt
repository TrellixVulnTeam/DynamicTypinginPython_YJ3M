commit c74b7c2e512464b9eeb6a0ffc49da9824f282ef1
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Oct 16 19:24:16 2016 -0700

    [mail] push release emails behind feature flag

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index d7fe450b3d..741521479b 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -654,6 +654,7 @@ SENTRY_FEATURES = {
     'projects:quotas': True,
     'projects:plugins': True,
     'projects:dsym': False,
+    'workflow:release-emails': False,
 }
 
 # Default time zone for localization in the UI.
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index f4dc9a3ebd..73b6b96e10 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -18,6 +18,7 @@ default_manager.add('organizations:reports:calendar', OrganizationFeature)  # NO
 default_manager.add('projects:global-events', ProjectFeature)  # NOQA
 default_manager.add('projects:quotas', ProjectFeature)  # NOQA
 default_manager.add('projects:plugins', ProjectPluginFeature)  # NOQA
+default_manager.add('workflow:release-emails')
 
 # expose public api
 add = default_manager.add
diff --git a/src/sentry/plugins/sentry_mail/activity/release.py b/src/sentry/plugins/sentry_mail/activity/release.py
index bfe53466f9..b86d573d7b 100644
--- a/src/sentry/plugins/sentry_mail/activity/release.py
+++ b/src/sentry/plugins/sentry_mail/activity/release.py
@@ -1,5 +1,6 @@
 from __future__ import absolute_import
 
+from sentry import features
 from sentry.db.models.query import in_iexact
 from sentry.models import GroupSubscriptionReason, Release, ReleaseCommit, User
 
@@ -43,13 +44,13 @@ class ReleaseActivityEmail(ActivityEmail):
         # verified the matching email address
         return {
             user: GroupSubscriptionReason.committed
-            for user in
-            User.objects.filter(
+            for user in User.objects.filter(
                 in_iexact('emails__email', email_list),
                 emails__is_verified=True,
                 sentry_orgmember_set__teams=project.team,
                 is_active=True,
             ).distinct()
+            if features.has('workflow:release-emails', actor=user)
         }
 
     def get_context(self):
diff --git a/tests/sentry/plugins/mail/activity/test_release.py b/tests/sentry/plugins/mail/activity/test_release.py
index cf7d51a1bb..0b59c0bdda 100644
--- a/tests/sentry/plugins/mail/activity/test_release.py
+++ b/tests/sentry/plugins/mail/activity/test_release.py
@@ -90,19 +90,20 @@ class ReleaseTestCase(TestCase):
             )
         )
 
-        assert email.get_participants() == {
-            self.user: GroupSubscriptionReason.committed,
-        }
+        with self.feature('workflow:release-emails'):
+            assert email.get_participants() == {
+                self.user: GroupSubscriptionReason.committed,
+            }
 
-        context = email.get_context()
-        assert context['commit_list'] == [self.commit, self.commit2]
+            context = email.get_context()
+            assert context['commit_list'] == [self.commit, self.commit2]
 
-        with self.tasks():
-            email.send()
+            with self.tasks():
+                email.send()
 
-        assert len(mail.outbox) == 1
-        msg = mail.outbox[-1]
-        assert msg.to == [self.user.email]
+            assert len(mail.outbox) == 1
+            msg = mail.outbox[-1]
+            assert msg.to == [self.user.email]
 
     def test_doesnt_generate_on_no_release(self):
         email = ReleaseActivityEmail(
