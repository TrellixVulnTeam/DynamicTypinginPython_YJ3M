commit 751d461a8f27395ea14b6654e1c81480cba54c12
Author: David Cramer <dcramer@gmail.com>
Date:   Mon May 30 18:27:29 2011 -0700

    Ensure compatibility with add so that it doesnt re-set the timeout for trashing

diff --git a/sentry/client/base.py b/sentry/client/base.py
index fae56b5418..4074a19298 100644
--- a/sentry/client/base.py
+++ b/sentry/client/base.py
@@ -42,7 +42,12 @@ class SentryClient(object):
             return (False, None)
         
         cache_key = 'sentry:%s' % (checksum,)
-        added = cache.add(cache_key, 1, settings.THRASHING_TIMEOUT)
+        # We MUST do a get first to avoid re-setting the timeout when doing .add
+        added = cache.get(cache_key) is None
+        if not added:
+            # Use add to avoid race conditions
+            added = cache.add(cache_key, 1, settings.THRASHING_TIMEOUT)
+
         if added:
             return (False, None)
         
