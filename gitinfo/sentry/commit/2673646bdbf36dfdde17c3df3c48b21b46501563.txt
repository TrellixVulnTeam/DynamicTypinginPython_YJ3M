commit 2673646bdbf36dfdde17c3df3c48b21b46501563
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jan 28 23:46:05 2014 -0800

    Ensure users can actually change their username

diff --git a/src/sentry/web/forms/accounts.py b/src/sentry/web/forms/accounts.py
index 9e102b554e..ba0f43d85d 100644
--- a/src/sentry/web/forms/accounts.py
+++ b/src/sentry/web/forms/accounts.py
@@ -148,6 +148,12 @@ class AccountSettingsForm(forms.Form):
         if self.user.password in EMPTY_PASSWORD_VALUES:
             del self.fields['old_password']
 
+    def clean_username(self):
+        value = self.cleaned_data['username']
+        if User.objects.filter(username__iexact=value).exists():
+            raise forms.ValidationError_("That username is already in use.")
+        return value
+
     def clean_old_password(self):
         """
         Validates that the old_password field is correct.
@@ -169,7 +175,9 @@ class AccountSettingsForm(forms.Form):
 
         self.user.email = self.cleaned_data['email']
 
-        if new_username and not User.objects.filter(username__iexact=self.user.email).exists():
+        if self.cleaned_data.get('username'):
+            self.user.username = self.cleaned_data['username']
+        elif new_username and not User.objects.filter(username__iexact=self.user.email).exists():
             self.user.username = self.user.email
 
         if commit:
