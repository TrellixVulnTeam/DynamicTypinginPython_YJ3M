commit 3bcb789c05a7bc1d513eafca29018ee72b9094ea
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri Jul 27 16:00:31 2018 -0700

    fix(snuba): Handle timezones in raw_query instead of query
    
    Just moving what was done in d4d8d7e31c552a4932e5accc0f6f9a96c43a344a
    farther down the stack so callers of raw_query are fine.

diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index 218ff18876..b723bf2bff 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -75,6 +75,12 @@ def raw_query(start, end, groupby=None, conditions=None, filter_keys=None,
     `aggregations` a list of (aggregation_function, column, alias) tuples to be
     passed to the query.
     """
+
+    # convert to naive UTC datetimes, as Snuba only deals in UTC
+    # and this avoids offset-naive and offset-aware issues
+    start = start if not start.tzinfo else start.astimezone(pytz.utc).replace(tzinfo=None)
+    end = end if not end.tzinfo else end.astimezone(pytz.utc).replace(tzinfo=None)
+
     groupby = groupby or []
     conditions = conditions or []
     having = having or []
@@ -173,11 +179,6 @@ def query(start, end, groupby, conditions=None, filter_keys=None,
           aggregations=None, rollup=None, arrayjoin=None, limit=None, orderby=None,
           having=None, referrer=None, is_grouprelease=False, selected_columns=None):
 
-    # convert to naive UTC datetimes, as Snuba only deals in UTC
-    # and this avoids offset-naive and offset-aware issues
-    start = start if not start.tzinfo else start.astimezone(pytz.utc).replace(tzinfo=None)
-    end = end if not end.tzinfo else end.astimezone(pytz.utc).replace(tzinfo=None)
-
     aggregations = aggregations or [['count()', '', 'aggregate']]
     filter_keys = filter_keys or {}
     selected_columns = selected_columns or []
