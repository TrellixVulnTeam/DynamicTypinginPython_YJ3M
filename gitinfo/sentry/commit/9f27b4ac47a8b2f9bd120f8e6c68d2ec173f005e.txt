commit 9f27b4ac47a8b2f9bd120f8e6c68d2ec173f005e
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Aug 27 13:52:25 2015 -0700

    Standardize values of body, headers, and cookies (refs GH-1853)
    
    This reverts commit affa609b5b26dd8226d2a666c69dc12048649c48.

diff --git a/src/sentry/interfaces/http.py b/src/sentry/interfaces/http.py
index db2f3f654e..66119c6373 100644
--- a/src/sentry/interfaces/http.py
+++ b/src/sentry/interfaces/http.py
@@ -17,29 +17,42 @@ from urlparse import parse_qsl, urlsplit, urlunsplit
 
 from sentry.constants import HTTP_METHODS
 from sentry.interfaces.base import Interface
-from sentry.utils.safe import trim, trim_dict
+from sentry.utils import json
+from sentry.utils.safe import trim, trim_dict, trim_pairs
 from sentry.web.helpers import render_to_string
 
 
 def format_headers(value):
-    return dict(
-        (k.title(), v)
-        for k, v in value.iteritems()
-    )
+    if not value:
+        return ()
+
+    if isinstance(value, dict):
+        value = value.items()
+
+    result = []
+    cookie_header = None
+    for k, v in value:
+        if k.lower() == 'cookie':
+            cookie_header = v
+        else:
+            result.append((k.title(), v))
+    return result, cookie_header
 
 
 def format_cookies(value):
-    return dict(
-        (k.encode('utf8').strip(), v)
-        for k, v in value.iteritems()
-    )
+    if not value:
+        return ()
+
+    if isinstance(value, basestring):
+        value = parse_qsl(value, keep_blank_values=True)
 
+    if isinstance(value, dict):
+        value = value.items()
 
-def format_body(value):
-    return dict(
-        (k.encode('utf8'), v.encode('utf8'))
-        for k, v in value.iteritems()
-    )
+    return [
+        (k.encode('utf8').strip(), v)
+        for k, v in value
+    ]
 
 
 class Http(Interface):
@@ -115,41 +128,22 @@ class Http(Interface):
         # strip them out
         headers = data.get('headers')
         if headers:
-            headers = format_headers(headers)
-            if 'Cookie' in headers:
-                if not cookies:
-                    cookies = headers.pop('Cookie')
-                else:
-                    del headers['Cookie']
-            headers = trim_dict(headers)
+            headers, cookie_header = format_headers(headers)
+            if not cookies and cookie_header:
+                cookies = cookie_header
         else:
             headers = {}
 
         body = data.get('data')
-        # TODO(dcramer): a list as a body is not even close to valid
         if isinstance(body, dict):
-            body = trim_dict(dict(
-                (k, v or '')
-                for k, v in body.iteritems()
-            ))
-        elif body:
+            body = json.dumps(body)
+
+        if body:
             body = trim(body, settings.SENTRY_MAX_HTTP_BODY_SIZE)
-            if headers.get('Content-Type') == cls.FORM_TYPE and '=' in body:
-                body = dict(parse_qsl(body, True))
-
-        # if cookies were a string, convert to a dict
-        # parse_qsl will parse both acceptable formats:
-        #  a=b&c=d
-        # and
-        #  a=b;c=d
-        if isinstance(cookies, basestring):
-            cookies = dict(parse_qsl(cookies, keep_blank_values=True))
-        elif not cookies:
-            cookies = {}
-
-        kwargs['cookies'] = format_cookies(trim_dict(cookies))
+
+        kwargs['cookies'] = trim_pairs(format_cookies(cookies))
         kwargs['env'] = trim_dict(data.get('env') or {})
-        kwargs['headers'] = headers
+        kwargs['headers'] = trim_pairs(headers)
         kwargs['data'] = body
         kwargs['url'] = urlunsplit((scheme, netloc, path, '', ''))
         kwargs['fragment'] = trim(fragment, 256)
@@ -184,18 +178,29 @@ class Http(Interface):
         return _('Request')
 
     def get_api_context(self, is_public=False):
+        data = self.data
+        if isinstance(data, dict):
+            data = json.dumps(data)
+
+        cookies = self.cookies or ()
+        if isinstance(cookies, dict):
+            cookies = sorted(self.cookies.items())
+
+        headers = self.headers or ()
+        if isinstance(headers, dict):
+            headers = sorted(self.headers.items())
+
         data = {
             'method': self.method,
             'url': self.url,
             'query': self.query_string,
             'fragment': self.fragment,
-            'data': self.data,
-            # TODO(dcramer): scrub headers for IPs/etc when is_public
-            'headers': self.headers or None,
+            'data': data,
+            'headers': headers,
         }
         if not is_public:
             data.update({
-                'cookies': self.cookies or None,
+                'cookies': cookies,
                 'env': self.env or None,
             })
         return data
diff --git a/src/sentry/utils/safe.py b/src/sentry/utils/safe.py
index 3e342c6954..aefa59e7f4 100644
--- a/src/sentry/utils/safe.py
+++ b/src/sentry/utils/safe.py
@@ -94,6 +94,17 @@ def trim(value, max_size=settings.SENTRY_MAX_VARIABLE_SIZE, max_depth=3,
     return result
 
 
+def trim_pairs(iterable, max_items=settings.SENTRY_MAX_DICTIONARY_ITEMS, **kwargs):
+    max_items -= 1
+    result = []
+    for idx, item in enumerate(iterable):
+        key, value = item
+        result.append((key, trim(value, **kwargs)))
+        if idx > max_items:
+            return result
+    return result
+
+
 def trim_dict(value, max_items=settings.SENTRY_MAX_DICTIONARY_ITEMS, **kwargs):
     max_items -= 1
     for idx, key in enumerate(value.keys()):
diff --git a/tests/sentry/interfaces/test_http.py b/tests/sentry/interfaces/test_http.py
index 882a3da76d..e3bb1c84dc 100644
--- a/tests/sentry/interfaces/test_http.py
+++ b/tests/sentry/interfaces/test_http.py
@@ -29,8 +29,8 @@ class HttpTest(TestCase):
         assert result.fragment == ''
         assert result.query_string == ''
         assert result.data is None
-        assert result.cookies == {}
-        assert result.headers == {}
+        assert result.cookies == []
+        assert result.headers == []
         assert result.env == {}
         assert result.full_url == result.url
 
@@ -48,8 +48,8 @@ class HttpTest(TestCase):
         assert result.method == 'GET'
         assert result.query_string == 'foo=bar'
         assert result.fragment == 'foobar'
-        assert result.cookies == {'foo': 'bar'}
-        assert result.headers == {'X-Foo-Bar': 'baz'}
+        assert result.cookies == [('foo', 'bar')]
+        assert result.headers == [('X-Foo-Bar', 'baz')]
         assert result.env == {'bing': 'bong'}
         assert result.data == 'hello world'
 
@@ -65,7 +65,7 @@ class HttpTest(TestCase):
             url='http://example.com',
             data={'foo': 'bar'},
         ))
-        assert result.data == {'foo': 'bar'}
+        assert result.data == '{"foo":"bar"}'
 
     def test_form_encoded_data(self):
         result = Http.to_python(dict(
@@ -73,32 +73,32 @@ class HttpTest(TestCase):
             headers={'Content-Type': 'application/x-www-form-urlencoded'},
             data='foo=bar',
         ))
-        assert result.data == {'foo': 'bar'}
+        assert result.data == 'foo=bar'
 
     def test_cookies_as_string(self):
         result = Http.to_python(dict(
             url='http://example.com',
             cookies='a=b;c=d',
         ))
-        assert result.cookies == {'a': 'b', 'c': 'd'}
+        assert result.cookies == [('a', 'b'), ('c', 'd')]
         result = Http.to_python(dict(
             url='http://example.com',
             cookies='a=b&c=d',
         ))
-        assert result.cookies == {'a': 'b', 'c': 'd'}
+        assert result.cookies == [('a', 'b'), ('c', 'd')]
 
     def test_cookies_in_header(self):
         result = Http.to_python(dict(
             url='http://example.com',
             headers={'Cookie': 'a=b;c=d'},
         ))
-        assert result.cookies == {'a': 'b', 'c': 'd'}
+        assert result.cookies == [('a', 'b'), ('c', 'd')]
         result = Http.to_python(dict(
             url='http://example.com',
             headers={'Cookie': 'a=b;c=d'},
             cookies={'foo': 'bar'},
         ))
-        assert result.cookies == {'foo': 'bar'}
+        assert result.cookies == [('foo', 'bar')]
 
     def test_query_string_and_fragment_as_params(self):
         result = Http.to_python(dict(
