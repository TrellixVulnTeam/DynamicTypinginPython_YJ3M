commit 259f996601b1492082081caa4fa407e7fe202659
Author: ted kaemming <ted@kaemming.com>
Date:   Wed Nov 28 10:23:56 2018 -0800

    fix(eventstream): Gracefully handle unexpected offset values in commit log. (#10803)
    
    See getsentry/snuba#229 for additional details.

diff --git a/src/sentry/eventstream/kafka/consumer.py b/src/sentry/eventstream/kafka/consumer.py
index 6356aa8616..638659cf53 100644
--- a/src/sentry/eventstream/kafka/consumer.py
+++ b/src/sentry/eventstream/kafka/consumer.py
@@ -6,7 +6,7 @@ import threading
 import uuid
 
 from concurrent.futures import TimeoutError
-from confluent_kafka import Consumer, OFFSET_BEGINNING, TopicPartition
+from confluent_kafka import Consumer, OFFSET_BEGINNING, OFFSET_END, OFFSET_STORED, OFFSET_INVALID, TopicPartition
 
 from sentry.eventstream.kafka.state import SynchronizedPartitionState, SynchronizedPartitionStateManager
 from sentry.utils.concurrent import execute
@@ -22,6 +22,12 @@ def get_commit_data(message):
     return group, topic, partition, offset
 
 
+# Set of logical (not literal) offsets that don't follow normal numeric
+# comparison rules and should be ignored.
+# https://github.com/confluentinc/confluent-kafka-python/blob/443177e1c83d9b66ce30f5eb8775e062453a738b/tests/test_enums.py#L22-L25
+LOGICAL_OFFSETS = frozenset([OFFSET_BEGINNING, OFFSET_END, OFFSET_STORED, OFFSET_INVALID])
+
+
 def run_commit_log_consumer(bootstrap_servers, consumer_group, commit_log_topic,
                             partition_state_manager, synchronize_commit_group, start_event, stop_request_event):
     start_event.set()
@@ -83,6 +89,20 @@ def run_commit_log_consumer(bootstrap_servers, consumer_group, commit_log_topic,
             logger.debug('Received consumer offsets update from %r, ignoring...', group)
             continue
 
+        if offset in LOGICAL_OFFSETS:
+            logger.debug(
+                'Skipping invalid logical offset (%r) from %s/%s...',
+                offset,
+                topic,
+                partition)
+            continue
+        elif offset < 0:
+            logger.warning(
+                'Received unexpected negative offset (%r) from %s/%s!',
+                offset,
+                topic,
+                partition)
+
         partition_state_manager.set_remote_offset(topic, partition, offset)
 
 
