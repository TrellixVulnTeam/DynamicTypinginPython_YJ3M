commit 3a3a68aba331d379fabd3fb2261e060514dec00c
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Fri Feb 16 16:20:28 2018 -0800

    fix(deletion): Move project deletion from team to organization (#7296)

diff --git a/src/sentry/deletions/defaults/organization.py b/src/sentry/deletions/defaults/organization.py
index 3eea896558..f3733d47a4 100644
--- a/src/sentry/deletions/defaults/organization.py
+++ b/src/sentry/deletions/defaults/organization.py
@@ -8,7 +8,7 @@ class OrganizationDeletionTask(ModelDeletionTask):
         from sentry.models import (
             OrganizationMember, Commit, CommitAuthor, CommitFileChange, Environment, Release,
             ReleaseCommit, ReleaseEnvironment, ReleaseFile, Distribution, ReleaseHeadCommit,
-            Repository, Team
+            Repository, Team, Project
         )
 
         # Team must come first
@@ -18,7 +18,8 @@ class OrganizationDeletionTask(ModelDeletionTask):
 
         model_list = (
             OrganizationMember, CommitFileChange, Commit, CommitAuthor, Environment, Repository,
-            Release, ReleaseCommit, ReleaseEnvironment, ReleaseFile, Distribution, ReleaseHeadCommit
+            Release, ReleaseCommit, ReleaseEnvironment, ReleaseFile, Distribution,
+            ReleaseHeadCommit, Project,
         )
         relations.extend([ModelRelation(m, {'organization_id': instance.id}) for m in model_list])
 
diff --git a/src/sentry/deletions/defaults/project.py b/src/sentry/deletions/defaults/project.py
index 8fa4a8f10b..253b2b0647 100644
--- a/src/sentry/deletions/defaults/project.py
+++ b/src/sentry/deletions/defaults/project.py
@@ -18,7 +18,8 @@ class ProjectDeletionTask(ModelDeletionTask):
             models.GroupAssignee, models.GroupBookmark, models.GroupEmailThread,
             models.GroupHash, models.GroupRelease, models.GroupRuleStatus, models.GroupSeen,
             models.GroupShare, models.GroupSubscription, models.ProjectBookmark, models.ProjectKey,
-            models.SavedSearchUserDefault, models.SavedSearch, models.ServiceHook, models.UserReport,
+            models.ProjectTeam, models.SavedSearchUserDefault, models.SavedSearch, models.ServiceHook,
+            models.UserReport,
         )
 
         relations.extend(
diff --git a/src/sentry/deletions/defaults/team.py b/src/sentry/deletions/defaults/team.py
index 4ec8db547b..1fa1c94661 100644
--- a/src/sentry/deletions/defaults/team.py
+++ b/src/sentry/deletions/defaults/team.py
@@ -5,10 +5,10 @@ from ..base import ModelDeletionTask, ModelRelation
 
 class TeamDeletionTask(ModelDeletionTask):
     def get_child_relations(self, instance):
-        from sentry.models import Project
+        from sentry.models import ProjectTeam
 
         return [
-            ModelRelation(Project, {'team_id': instance.id}),
+            ModelRelation(ProjectTeam, {'team_id': instance.id}),
         ]
 
     def mark_deletion_in_progress(self, instance_list):
diff --git a/tests/sentry/deletions/test_team.py b/tests/sentry/deletions/test_team.py
index 7255b0f4b9..ba4c75a09f 100644
--- a/tests/sentry/deletions/test_team.py
+++ b/tests/sentry/deletions/test_team.py
@@ -15,6 +15,12 @@ class DeleteTeamTest(TestCase):
         assert project1.teams.first() == team
         assert project2.teams.first() == team
 
+        # TODO(jess): remove this once i fix fixtures
+        project1.team = None
+        project1.save()
+        project2.team = None
+        project2.save()
+
         deletion = ScheduledDeletion.schedule(team, days=0)
         deletion.update(in_progress=True)
 
@@ -22,6 +28,6 @@ class DeleteTeamTest(TestCase):
             run_deletion(deletion.id)
 
         assert not Team.objects.filter(id=team.id).exists()
-        assert not Project.objects.filter(id=project1.id).exists()
-        assert not Project.objects.filter(id=project2.id).exists()
+        assert Project.objects.filter(id=project1.id).exists()
+        assert Project.objects.filter(id=project2.id).exists()
         assert not ProjectTeam.objects.filter(team_id=team.id).exists()
