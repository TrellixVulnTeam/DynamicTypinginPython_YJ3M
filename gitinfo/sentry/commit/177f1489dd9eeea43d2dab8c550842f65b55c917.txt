commit 177f1489dd9eeea43d2dab8c550842f65b55c917
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Thu Mar 22 10:29:59 2018 -0500

    fix(tagstore): Fix v2 backfill edgecase with default params (#7750)
    
    Fixes SENTRY-652
    Fixes SENTRY-651

diff --git a/src/sentry/tagstore/v2/backend.py b/src/sentry/tagstore/v2/backend.py
index a6b622282e..ad57c48ea3 100644
--- a/src/sentry/tagstore/v2/backend.py
+++ b/src/sentry/tagstore/v2/backend.py
@@ -265,11 +265,25 @@ class V2TagStorage(TagStorage):
                                       environment_id, key, value, **kwargs):
         assert environment_id is not None
 
-        tag_key, _ = self.get_or_create_tag_key(
-            project_id, environment_id, key, **kwargs)
+        if 'defaults' in kwargs:
+            # while backfilling v2 it is possible that a user performs an unmerge
+            # (which contains default values in kwargs) AND where the TagKey actually
+            # doesn't exist in the v2 database yet, so the defaults are used in create
+            # and explode because the fields don't actually exist in TagKey
+            # this is solved here as a one-off because it's very seldomly used and in
+            # the hot path for basically everything to do with tags
+            kcopy = kwargs.copy()
+            kcopy.pop('defaults')
+            tag_key, _ = self.get_or_create_tag_key(project_id, environment_id, key, **kcopy)
+
+            tag_value, _ = self.get_or_create_tag_value(
+                project_id, environment_id, key, value, key_id=tag_key.id, **kcopy)
 
-        tag_value, _ = self.get_or_create_tag_value(
-            project_id, environment_id, key, value, key_id=tag_key.id, **kwargs)
+        else:
+            tag_key, _ = self.get_or_create_tag_key(project_id, environment_id, key, **kwargs)
+
+            tag_value, _ = self.get_or_create_tag_value(
+                project_id, environment_id, key, value, key_id=tag_key.id, **kwargs)
 
         gtv, created = GroupTagValue.objects.get_or_create(
             project_id=project_id,
