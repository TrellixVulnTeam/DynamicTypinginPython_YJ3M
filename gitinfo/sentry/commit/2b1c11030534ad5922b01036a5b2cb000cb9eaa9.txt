commit 2b1c11030534ad5922b01036a5b2cb000cb9eaa9
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Wed Nov 11 11:01:04 2015 -0800

    Support CSP reports in email

diff --git a/src/sentry/data/samples/csp.json b/src/sentry/data/samples/csp.json
new file mode 100644
index 0000000000..40121ad93f
--- /dev/null
+++ b/src/sentry/data/samples/csp.json
@@ -0,0 +1,32 @@
+{
+    "culprit": "script-src 'self' 'unsafe-eval' 'unsafe-inline' www.example.com",
+    "message": "Blocked 'script' from 'example.org'",
+    "sentry.interfaces.Csp": {
+        "line_number": 304,
+        "blocked_uri": "https://example.com",
+        "referrer": "https://www.google.com/",
+        "status_code": 0,
+        "violated_directive": "script-src 'self' 'unsafe-eval' 'unsafe-inline' www.example.com",
+        "document_uri": "https://example.com/welcome/",
+        "original_policy": "default-src *; script-src 'self' 'unsafe-eval' 'unsafe-inline' www.example.com; img-src * data:",
+        "source_file": "https://example.com/welcome/",
+        "column_number": 305,
+        "effective_directive": "script-src"
+    },
+    "sentry.interfaces.Http": {
+        "url": "https://example.com/welcome/",
+        "headers": [
+            [
+                "Referer",
+                "https://www.google.com/"
+            ],
+            [
+                "User-Agent",
+                "Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.36 (KHTML, like Gecko) coc_coc_browser/51.2.109 Chrome/45.2.2454.109 Safari/537.36"
+            ]
+        ]
+    },
+    "sentry.interfaces.User": {
+        "ip_address": "127.0.0.1"
+    }
+}
diff --git a/src/sentry/interfaces/csp.py b/src/sentry/interfaces/csp.py
index 6ed7cb66bb..54a0483807 100644
--- a/src/sentry/interfaces/csp.py
+++ b/src/sentry/interfaces/csp.py
@@ -12,8 +12,10 @@ __all__ = ('Csp',)
 
 from urlparse import urlsplit, urlunsplit
 from sentry.interfaces.base import Interface, InterfaceValidationError
+from sentry.utils import json
 from sentry.utils.cache import memoize
 from sentry.utils.safe import trim
+from sentry.web.helpers import render_to_string
 
 
 # Sourced from https://developer.mozilla.org/en-US/docs/Web/Security/CSP/CSP_policy_directives
@@ -92,6 +94,7 @@ class Csp(Interface):
     >>> }
     """
 
+    score = 1300
     display_score = 1300
 
     @classmethod
@@ -208,6 +211,18 @@ class Csp(Interface):
             return value
         return _unsplit(scheme, value)
 
+    def get_title(self):
+        return 'CSP Report'
+
+    def to_string(self, is_public=False, **kwargs):
+        return json.dumps({'csp-report': self.get_api_context()}, indent=2)
+
+    def to_email_html(self, event, **kwargs):
+        return render_to_string(
+            'sentry/partial/interfaces/csp_email.html',
+            {'data': self.get_api_context()}
+        )
+
     def get_path(self):
         return 'sentry.interfaces.Csp'
 
diff --git a/src/sentry/templates/sentry/partial/interfaces/csp_email.html b/src/sentry/templates/sentry/partial/interfaces/csp_email.html
new file mode 100644
index 0000000000..97da02a03e
--- /dev/null
+++ b/src/sentry/templates/sentry/partial/interfaces/csp_email.html
@@ -0,0 +1,14 @@
+<h4 style="font-size:18px">{{ data.effective_directive }}</h4>
+<table>
+    <colgroup>
+      <col style="width:130px;">
+    </colgroup>
+    <tbody>
+        {% for key, value in data.iteritems %}
+        <tr>
+            <th>{{ key }}</th>
+            <td>{{ value|truncatechars:100 }}</td>
+        </tr>
+        {% endfor %}
+    </tbody>
+</table>
diff --git a/src/sentry/utils/samples.py b/src/sentry/utils/samples.py
index c79514bac1..f1c51c88a7 100644
--- a/src/sentry/utils/samples.py
+++ b/src/sentry/utils/samples.py
@@ -32,6 +32,9 @@ def load_data(platform, default=None):
     if data is None:
         return
 
+    if platform == 'csp':
+        return data
+
     data['platform'] = platform
     data['message'] = 'This is an example %s exception' % (platform,)
     data['sentry.interfaces.User'] = {
diff --git a/src/sentry/web/frontend/debug/mail.py b/src/sentry/web/frontend/debug/mail.py
index eacdf17928..a8d3159b0e 100644
--- a/src/sentry/web/frontend/debug/mail.py
+++ b/src/sentry/web/frontend/debug/mail.py
@@ -69,6 +69,7 @@ class MailPreview(object):
 
 @login_required
 def new_event(request):
+    platform = request.GET.get('platform', 'python')
     org = Organization(
         id=1,
         slug='example',
@@ -99,7 +100,7 @@ def new_event(request):
         project=project,
         group=group,
         message=group.message,
-        data=load_data('python'),
+        data=load_data(platform),
     )
 
     rule = Rule(label="An example rule")
