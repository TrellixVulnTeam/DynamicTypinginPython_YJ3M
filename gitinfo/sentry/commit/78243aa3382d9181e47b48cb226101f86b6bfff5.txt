commit 78243aa3382d9181e47b48cb226101f86b6bfff5
Author: Alex Hofsteede <alex@hofsteede.com>
Date:   Tue Dec 19 13:46:32 2017 +1300

    fix: SentryInternalClient crashing on some log types. (#6777)
    
    * fix: SentryInternalClient crashing on some log types.
    
    [Log messages from Django](https://docs.djangoproject.com/en/2.0/topics/logging/#django-request)
    contain a `request` object which is not JSON serializable. The regular
    Raven `Client` has a pretty bulletproof JSON encoder which handles these
    objects, but SentryInternalClient didn't use it, so there is an
    exception thrown further down the stack in `insert_data_to_database`
    when it comes across these objects. This fix forces the Raven JSON
    encoding of the event.
    
    This is not a very efficient solution, but it is at least simple.

diff --git a/src/sentry/utils/raven.py b/src/sentry/utils/raven.py
index 891542f904..bebf566a02 100644
--- a/src/sentry/utils/raven.py
+++ b/src/sentry/utils/raven.py
@@ -60,6 +60,10 @@ class SentryInternalClient(DjangoClient):
         if not is_current_event_safe():
             return
 
+        # Force raven-python encoding of this event, so that edge cases like
+        # non JSON-serializable objects are handled.
+        kwargs = self.decode(self.encode(kwargs))
+
         from sentry import tsdb
         from sentry.coreapi import ClientApiHelper
         from sentry.event_manager import EventManager
diff --git a/tests/sentry/utils/test_raven.py b/tests/sentry/utils/test_raven.py
index 2cfe8dc274..9f960ff75f 100644
--- a/tests/sentry/utils/test_raven.py
+++ b/tests/sentry/utils/test_raven.py
@@ -40,3 +40,24 @@ class SentryInternalClientTest(TestCase):
                 _, kwargs = send.call_args
                 # and got tagged properly
                 assert kwargs['tags']['install-id'] == 'abc123'
+
+    @patch.object(SentryInternalClient, 'is_enabled', Mock(return_value=True))
+    def test_encoding(self):
+
+        class NotJSONSerializable():
+            pass
+
+        sic = SentryInternalClient()
+        with self.tasks():
+            sic.send(**{
+                'sentry.interfaces.Message': {
+                    'message': 'check the req',
+                },
+                'extra': {
+                    'request': NotJSONSerializable()
+                },
+            })
+
+        event = Event.objects.get()
+        assert event.data['sentry.interfaces.Message']['message'] == 'check the req'
+        assert 'NotJSONSerializable' in event.data['extra']['request']
