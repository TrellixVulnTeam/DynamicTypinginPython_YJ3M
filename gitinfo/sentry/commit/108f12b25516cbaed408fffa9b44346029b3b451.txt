commit 108f12b25516cbaed408fffa9b44346029b3b451
Author: David Cramer <dcramer@gmail.com>
Date:   Wed Aug 14 19:05:06 2013 -0700

    Correct rendering of interfaces in emails

diff --git a/src/sentry/interfaces.py b/src/sentry/interfaces.py
index 6f39b3dcff..1262eaacda 100644
--- a/src/sentry/interfaces.py
+++ b/src/sentry/interfaces.py
@@ -19,6 +19,7 @@ from pygments.lexers import TextLexer
 from pygments.formatters import HtmlFormatter
 
 from django.http import QueryDict
+from django.utils.html import escape
 from django.utils.safestring import mark_safe
 from django.utils.translation import ugettext as _
 
@@ -154,6 +155,12 @@ class Interface(object):
     def to_string(self, event, is_public=False, **kwargs):
         return ''
 
+    def to_email_html(self, event, **kwargs):
+        body = self.to_string(event)
+        if not body:
+            return ''
+        return '<pre>%s</pre>' % (escape(body).replace('\n', '<br>'),)
+
     def get_slug(self):
         return type(self).__name__.lower()
 
@@ -943,8 +950,8 @@ class Http(Interface):
             'env': self.env,
         }
 
-    def to_string(self, event, is_public=False, **kwargs):
-        return render_to_string('sentry/partial/interfaces/http.txt', {
+    def to_email_html(self, event, **kwargs):
+        return render_to_string('sentry/partial/interfaces/http_email.html', {
             'event': event,
             'full_url': '?'.join(filter(bool, [self.url, self.query_string])),
             'url': self.url,
diff --git a/src/sentry/plugins/sentry_mail/models.py b/src/sentry/plugins/sentry_mail/models.py
index 0deee9eda1..bd2f8d5fd8 100644
--- a/src/sentry/plugins/sentry_mail/models.py
+++ b/src/sentry/plugins/sentry_mail/models.py
@@ -179,7 +179,7 @@ class MailPlugin(NotificationPlugin):
 
         interface_list = []
         for interface in event.interfaces.itervalues():
-            body = interface.to_string(event)
+            body = interface.to_email_html(event)
             if not body:
                 continue
             interface_list.append((interface.get_title(), body))
diff --git a/src/sentry/templates/sentry/emails/error.html b/src/sentry/templates/sentry/emails/error.html
index 3eb08f3123..d4c23eff1b 100644
--- a/src/sentry/templates/sentry/emails/error.html
+++ b/src/sentry/templates/sentry/emails/error.html
@@ -40,10 +40,10 @@
         </tr>
     </table>
 
-    {% for label, text in interfaces %}
+    {% for int_id, label, text in interfaces %}
     <div class="interface">
         <div class="title">{{ label }}</div>
-		<pre>{{ text|linebreaksbr }}</pre>
+		{{ text }}
     </div>
     {% endfor %}
 
diff --git a/src/sentry/templates/sentry/partial/interfaces/http.txt b/src/sentry/templates/sentry/partial/interfaces/http_email.html
similarity index 100%
rename from src/sentry/templates/sentry/partial/interfaces/http.txt
rename to src/sentry/templates/sentry/partial/interfaces/http_email.html
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index e3fad32815..f6b424d653 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -31,7 +31,7 @@ class MailPluginTest(TestCase):
         )
 
         stacktrace = Mock(spec=Stacktrace)
-        stacktrace.to_string.return_value = 'foo bar'
+        stacktrace.to_email_html.return_value = 'foo bar'
         stacktrace.get_title.return_value = 'Stacktrace'
 
         event = Event()
@@ -45,7 +45,7 @@ class MailPluginTest(TestCase):
             self.plugin.notify_users(group, event)
 
         stacktrace.get_title.assert_called_once_with()
-        stacktrace.to_string.assert_called_once_with(event)
+        stacktrace.to_email_html.assert_called_once_with(event)
 
     @mock.patch('sentry.plugins.sentry_mail.models.MailPlugin._send_mail')
     def test_notify_users_renders_interfaces_with_utf8(self, _send_mail):
@@ -57,7 +57,7 @@ class MailPluginTest(TestCase):
         )
 
         stacktrace = Mock(spec=Stacktrace)
-        stacktrace.to_string.return_value = u'רונית מגן'
+        stacktrace.to_email_html.return_value = u'רונית מגן'
         stacktrace.get_title.return_value = 'Stacktrace'
 
         event = Event()
@@ -71,7 +71,7 @@ class MailPluginTest(TestCase):
             self.plugin.notify_users(group, event)
 
         stacktrace.get_title.assert_called_once_with()
-        stacktrace.to_string.assert_called_once_with(event)
+        stacktrace.to_email_html.assert_called_once_with(event)
 
     @mock.patch('sentry.plugins.sentry_mail.models.MailPlugin._send_mail')
     def test_notify_users_renders_interfaces_with_utf8_fix_issue_422(self, _send_mail):
@@ -83,7 +83,7 @@ class MailPluginTest(TestCase):
         )
 
         stacktrace = Mock(spec=Stacktrace)
-        stacktrace.to_string.return_value = u'רונית מגן'
+        stacktrace.to_email_html.return_value = u'רונית מגן'
         stacktrace.get_title.return_value = 'Stacktrace'
 
         event = Event()
@@ -97,7 +97,7 @@ class MailPluginTest(TestCase):
             self.plugin.notify_users(group, event)
 
         stacktrace.get_title.assert_called_once_with()
-        stacktrace.to_string.assert_called_once_with(event)
+        stacktrace.to_email_html.assert_called_once_with(event)
 
     @mock.patch('sentry.plugins.sentry_mail.models.MailPlugin._send_mail')
     def test_notify_users_does_email(self, _send_mail):
