commit 74a5ec8f25d2d26d2817c6d6e0a5ea39af9e3569
Author: Filippo Pacifici <filippo.pacifici@gmail.com>
Date:   Thu Feb 13 10:25:44 2020 -0800

    fix(tags facet) Apply turbo when providing sampling (#16991)
    
    When applying SAMPLING, snuba can still decide it will add FINAL after replacements happened and before clickhouse has merged the rows. These two together don't work, so we need to tell snuba that we do not care of the consistency of the results and not to apply FINAL in any case.
    This achieves that by passing Turbo together with sample.

diff --git a/src/sentry/snuba/discover.py b/src/sentry/snuba/discover.py
index 3bf4a675de..628c18a4c4 100644
--- a/src/sentry/snuba/discover.py
+++ b/src/sentry/snuba/discover.py
@@ -572,6 +572,8 @@ def get_facets(query, params, limit=10, referrer=None):
             dataset=Dataset.Discover,
             referrer=referrer,
             sample=sample_rate,
+            # Ensures Snuba will not apply FINAL
+            turbo=sample_rate is not None,
         )
         results.extend(
             [
@@ -609,6 +611,8 @@ def get_facets(query, params, limit=10, referrer=None):
             dataset=Dataset.Discover,
             referrer=referrer,
             sample=sample_rate,
+            # Ensures Snuba will not apply FINAL
+            turbo=sample_rate is not None,
         )
         results.extend(
             [
@@ -631,6 +635,8 @@ def get_facets(query, params, limit=10, referrer=None):
             dataset=Dataset.Discover,
             referrer=referrer,
             sample=sample_rate,
+            # Ensures Snuba will not apply FINAL
+            turbo=sample_rate is not None,
             limitby=[TOP_VALUES_DEFAULT_LIMIT, "tags_key"],
         )
         results.extend(
