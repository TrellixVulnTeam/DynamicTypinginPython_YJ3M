commit 0629028070981778e9ca67baf5c0b8db1a8ef50d
Author: Anton Ovchinnikov <anton@tonyo.info>
Date:   Mon May 14 14:25:41 2018 +0200

    ci: Build and deploy storybook (#8412)

diff --git a/.gitignore b/.gitignore
index 87fdab11a3..85879037ce 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1,5 +1,6 @@
 .cache/
 .coverage
+.storybook-out/
 .DS_Store
 *.egg-info
 *.pyc
diff --git a/.travis.yml b/.travis.yml
index 7535a84e0a..e67d78cfd1 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -10,6 +10,7 @@ cache:
   directories:
     - node_modules
     - $HOME/.cache/pip/wheels
+    - $HOME/google-cloud-sdk
 branches:
   only:
   - master
@@ -132,9 +133,32 @@ matrix:
         - docker run -d --name clickhouse-server -p 9000:9000 -p 9009:9009 -p 8123:8123 --ulimit nofile=262144:262144 yandex/clickhouse-server
         - docker run -d --env SNUBA_SETTINGS=test --env CLICKHOUSE_SERVER=clickhouse-server:9000 --name snuba -p 1218:1218 --link clickhouse-server:clickhouse-server getsentry/snuba
         - docker ps -a
+
+    # Deploy 'storybook' (component & style guide)
+    - language: node_js
+      env: STORYBOOK_BUILD=1
+      before_install:
+        # Decrypt the credentials we added to the repo using the key we added with the Travis command line tool
+        - openssl aes-256-cbc -K $encrypted_020be61ef175_key -iv $encrypted_020be61ef175_iv -in .travis/storybook-credentials.tar.gz.enc -out credentials.tar.gz -d
+        # If the SDK is not already cached, download it and unpack it
+        - if [ ! -d ${HOME}/google-cloud-sdk ]; then curl https://sdk.cloud.google.com | bash; fi
+        - tar -xzf credentials.tar.gz
+        # Use the decrypted service account credentials to authenticate the command line tool
+        - gcloud auth activate-service-account --key-file client-secret.json
+      install:
+        - nvm install $TRAVIS_NODE_VERSION
+        - make install-yarn
+        - gcloud version
+      after_success: skip
+      after_failure: skip
+      script: bash .travis/deploy-storybook.sh
+
   allow_failures:
     - python: 2.7
       env: TEST_SUITE=snuba SENTRY_TAGSTORE=sentry.tagstore.snuba.SnubaTagStorage
+    - language: node_js
+      env: STORYBOOK_BUILD=1
+
 notifications:
   webhooks:
     urls:
diff --git a/.travis/deploy-storybook.sh b/.travis/deploy-storybook.sh
new file mode 100644
index 0000000000..f8799b430b
--- /dev/null
+++ b/.travis/deploy-storybook.sh
@@ -0,0 +1,20 @@
+#!/bin/bash
+set -eu
+
+GS_BUCKET_NAME=sentryio-storybook
+DEPLOY_BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
+echo "Build branch: ${DEPLOY_BRANCH}"
+
+# Transform the branch name to a bucket directory
+BRANCH_PROCESSED=$(echo "${DEPLOY_BRANCH}" | tr '[:upper:]./' '[:lower:]--' | tr -cd '[:alnum:]-_')
+BUCKET_DIR_NAME="branches/${BRANCH_PROCESSED}"
+echo "Bucket directory: ${BUCKET_DIR_NAME}"
+
+npm run storybook-build
+
+# Upload the files
+gsutil -m rsync -r -d .storybook-out/ "gs://${GS_BUCKET_NAME}/${BUCKET_DIR_NAME}"
+
+# Upload build metadata
+echo "{\"branch\": \"${DEPLOY_BRANCH}\", \"commit\": \"${TRAVIS_COMMIT}\", \"synced_at\": $(date +%s)}" > build-info.json
+gsutil cp build-info.json "gs://${GS_BUCKET_NAME}/${BUCKET_DIR_NAME}"
diff --git a/.travis/storybook-credentials.tar.gz.enc b/.travis/storybook-credentials.tar.gz.enc
new file mode 100644
index 0000000000..49b78f9790
Binary files /dev/null and b/.travis/storybook-credentials.tar.gz.enc differ
diff --git a/package.json b/package.json
index 13a80ba896..dae2d0e436 100644
--- a/package.json
+++ b/package.json
@@ -101,6 +101,7 @@
     "dev-proxy": "node scripts/devproxy.js",
     "dev-server": "webpack-dev-server",
     "storybook": "start-storybook -p 9001 -c .storybook",
+    "storybook-build": "build-storybook -c .storybook -o .storybook-out",
     "snapshot": "build-storybook && PERCY_TOKEN=$STORYBOOK_PERCY_TOKEN PERCY_PROJECT=$STORYBOOK_PERCY_PROJECT percy-storybook --widths=1280",
     "webpack-profile": "yarn -s webpack --profile --json > stats.json"
   },
