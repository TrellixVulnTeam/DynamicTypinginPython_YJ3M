commit 890767e675367a85e86e4b162e8f27b0cfa25e57
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Apr 9 10:03:35 2015 -0400

    Add TaskRunner helper

diff --git a/src/sentry/testutils/cases.py b/src/sentry/testutils/cases.py
index 9a27a94b85..edafc93767 100644
--- a/src/sentry/testutils/cases.py
+++ b/src/sentry/testutils/cases.py
@@ -37,7 +37,7 @@ from sentry.rules import EventState
 from sentry.utils import json
 
 from .fixtures import Fixtures
-from .helpers import AuthProvider, Feature, get_auth_header
+from .helpers import AuthProvider, Feature, get_auth_header, TaskRunner
 
 
 def create_redis_conn():
@@ -72,6 +72,9 @@ class BaseTestCase(Fixtures, Exam):
 
         self.session = session
 
+    def tasks(self):
+        return TaskRunner()
+
     def feature(self, name, active=True):
         """
         >>> with self.feature('feature:name')
@@ -147,7 +150,7 @@ class BaseTestCase(Fixtures, Exam):
             secret = self.projectkey.secret_key
 
         message = self._makePostMessage(data)
-        with self.settings(CELERY_ALWAYS_EAGER=True):
+        with self.tasks():
             resp = self.client.post(
                 reverse('sentry-api-store'), message,
                 content_type='application/octet-stream',
@@ -170,7 +173,7 @@ class BaseTestCase(Fixtures, Exam):
             'sentry_key': key,
             'sentry_data': message,
         }
-        with self.settings(CELERY_ALWAYS_EAGER=True):
+        with self.tasks():
             resp = self.client.get(
                 '%s?%s' % (reverse('sentry-api-store', args=(self.project.pk,)), urllib.urlencode(qs)),
                 **headers
diff --git a/src/sentry/testutils/helpers/__init__.py b/src/sentry/testutils/helpers/__init__.py
index 6d66174445..b510956002 100644
--- a/src/sentry/testutils/helpers/__init__.py
+++ b/src/sentry/testutils/helpers/__init__.py
@@ -11,3 +11,4 @@ from .auth_header import *  # NOQA
 from .auth_providers import *  # NOQA
 from .features import *  # NOQA
 from .link_header import *  # NOQA
+from .task_runner import *  # NOQA
diff --git a/src/sentry/testutils/helpers/task_runner.py b/src/sentry/testutils/helpers/task_runner.py
new file mode 100644
index 0000000000..bee1c21c4d
--- /dev/null
+++ b/src/sentry/testutils/helpers/task_runner.py
@@ -0,0 +1,16 @@
+from __future__ import absolute_import
+
+__all__ = ['TaskRunner']
+
+from celery import current_app
+from contextlib import contextmanager
+from django.conf import settings
+
+
+@contextmanager
+def TaskRunner():
+    settings.CELERY_ALWAYS_EAGER = True
+    current_app.conf.CELERY_ALWAYS_EAGER = True
+    yield
+    current_app.conf.CELERY_ALWAYS_EAGER = False
+    settings.CELERY_ALWAYS_EAGER = False
