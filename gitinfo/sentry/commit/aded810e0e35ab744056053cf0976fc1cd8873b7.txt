commit aded810e0e35ab744056053cf0976fc1cd8873b7
Author: Anton Ovchinnikov <anton@tonyo.info>
Date:   Tue Jan 8 13:41:24 2019 +0300

    ref: Add proper tags for metrics in post_process (#11387)
    
    * ref: Add proper tags for metrics in post_process
    
    * fix: Keep platform metrics

diff --git a/src/sentry/tasks/post_process.py b/src/sentry/tasks/post_process.py
index 7b669bbef4..f35522289a 100644
--- a/src/sentry/tasks/post_process.py
+++ b/src/sentry/tasks/post_process.py
@@ -45,13 +45,14 @@ def _capture_stats(event, is_new):
     if not platform:
         return
     platform = platform.split('-', 1)[0].split('_', 1)[0]
+    tags = {'platform': platform}
 
     if is_new:
-        metrics.incr('events.unique', skip_internal=False)
+        metrics.incr('events.unique', tags=tags, skip_internal=False)
 
-    metrics.incr('events.processed', skip_internal=False)
+    metrics.incr('events.processed', tags=tags, skip_internal=False)
     metrics.incr(u'events.processed.{platform}'.format(platform=platform), skip_internal=False)
-    metrics.timing('events.size.data', event.size, tags={'platform': platform})
+    metrics.timing('events.size.data', event.size, tags=tags)
 
 
 def check_event_already_post_processed(event):
