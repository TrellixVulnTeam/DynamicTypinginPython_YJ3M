commit b7764cc6e1fde18717a1f14f9210361bf68aaddd
Author: Jess MacQueen <jess@getsentry.com>
Date:   Fri Mar 10 14:06:50 2017 -0800

    fix tests, tweak language to make it clear they're deploy emails

diff --git a/src/sentry/api/endpoints/release_deploys.py b/src/sentry/api/endpoints/release_deploys.py
index f496cca478..3630a68f73 100644
--- a/src/sentry/api/endpoints/release_deploys.py
+++ b/src/sentry/api/endpoints/release_deploys.py
@@ -140,9 +140,9 @@ class ReleaseDeploysEndpoint(OrganizationReleasesBaseEndpoint):
                 activity = Activity.objects.create(
                     type=Activity.DEPLOY,
                     project=project,
-                    ident=result['version'],
+                    ident=release.version,
                     data={
-                        'version': result['version'],
+                        'version': release.version,
                         'deploy_id': deploy.id,
                     },
                     datetime=deploy.date_finished,
diff --git a/src/sentry/plugins/sentry_mail/activity/release.py b/src/sentry/plugins/sentry_mail/activity/release.py
index 4a35af61c1..94c678be95 100644
--- a/src/sentry/plugins/sentry_mail/activity/release.py
+++ b/src/sentry/plugins/sentry_mail/activity/release.py
@@ -56,6 +56,9 @@ class ReleaseActivityEmail(ActivityEmail):
                 c.author.email for c in self.commit_list
                 if c.author
             ])
+            self.environment = Environment.objects.get(
+                id=self.deploy.environment_id
+            ).name or 'Default Environment'
 
     def should_email(self):
         return bool(self.release and self.deploy)
@@ -104,8 +107,6 @@ class ReleaseActivityEmail(ActivityEmail):
             ).count() for p in projects
         ]
 
-        environment = Environment.objects.get(id=self.deploy.environment_id).name
-
         return {
             'projects': zip(projects, release_links, resolved_issue_counts),
             'project_count': len(projects),
@@ -114,11 +115,15 @@ class ReleaseActivityEmail(ActivityEmail):
             'file_count': file_count,
             'repos': self.repos,
             'release': self.release,
-            'environment': environment or 'Default Environment',
+            'deploy': self.deploy,
+            'environment': self.environment,
         }
 
     def get_subject(self):
-        return u'Released {}'.format(self.release.short_version)
+        return u'Deployed version {} to {}'.format(
+            self.release.short_version,
+            self.environment,
+        )
 
     def get_template(self):
         return 'sentry/emails/activity/release.txt'
diff --git a/src/sentry/templates/sentry/emails/activity/release.html b/src/sentry/templates/sentry/emails/activity/release.html
index 8a393b73e2..0a82369515 100644
--- a/src/sentry/templates/sentry/emails/activity/release.html
+++ b/src/sentry/templates/sentry/emails/activity/release.html
@@ -9,7 +9,7 @@
     <h2 style="margin-bottom: 10px">
         Version {{ release.short_version }} was [deployed] to [{{ environment }}]
     </h2>
-    <p class="muted"><small><strong style="color: #72697d;">{{ release.date_added }}</strong> <span class="divider">&nbsp;</span>  {{ commit_count }} commits, {{ author_count }} authors, and {{ file_count }} files changed across {{ project_count }} projects</small></p>
+    <p class="muted"><small><strong style="color: #72697d;">{{ deploy.date_finished }}</strong> <span class="divider">&nbsp;</span>  {{ commit_count }} commits, {{ author_count }} authors, and {{ file_count }} files changed across {{ project_count }} projects</small></p>
 
     <hr>
 
diff --git a/src/sentry/templates/sentry/emails/activity/release.txt b/src/sentry/templates/sentry/emails/activity/release.txt
index c988dffac2..73edc73305 100644
--- a/src/sentry/templates/sentry/emails/activity/release.txt
+++ b/src/sentry/templates/sentry/emails/activity/release.txt
@@ -1,3 +1,5 @@
-{{ release.short_version }} was released for {{ project.name }} on {{ release.date_added }}.
+Version {{ release.short_version }} was deployed to {{ environment }} on {{ deploy.date_finished }}
 
-{{ release_link }}
+{% for project, release_link, resolved_issue_count in projects %}
+    {{ release_link }}
+{% endfor %}
diff --git a/src/sentry/web/frontend/debug/debug_new_release_email.py b/src/sentry/web/frontend/debug/debug_new_release_email.py
index 49e93b3817..ac3b459c5f 100644
--- a/src/sentry/web/frontend/debug/debug_new_release_email.py
+++ b/src/sentry/web/frontend/debug/debug_new_release_email.py
@@ -6,8 +6,8 @@ import pytz
 from django.views.generic import View
 
 from sentry.models import (
-    Commit, CommitAuthor, GroupSubscriptionReason, Organization, Project,
-    Release, Team
+    Commit, CommitAuthor, Deploy, GroupSubscriptionReason,
+    Organization, Project, Release, Team
 )
 from sentry.utils.http import absolute_uri
 
@@ -49,6 +49,13 @@ class DebugNewReleaseEmailView(View):
             date_added=datetime(2016, 10, 12, 15, 39, tzinfo=pytz.utc)
         )
 
+        deploy = Deploy(
+            release=release,
+            organization_id=org.id,
+            environment_id=1,
+            date_finished=datetime(2016, 10, 12, 15, 39, tzinfo=pytz.utc),
+        )
+
         release_links = [
             absolute_uri('/{}/{}/releases/{}/'.format(
                 org.slug,
@@ -100,5 +107,6 @@ class DebugNewReleaseEmailView(View):
                 'author_count': 1,
                 'file_count': 5,
                 'environment': 'production',
+                'deploy': deploy,
             },
         ).render(request)
diff --git a/tests/sentry/plugins/mail/activity/test_release.py b/tests/sentry/plugins/mail/activity/test_release.py
index e28b7cc042..53c1e3c587 100644
--- a/tests/sentry/plugins/mail/activity/test_release.py
+++ b/tests/sentry/plugins/mail/activity/test_release.py
@@ -6,8 +6,8 @@ from django.core import mail
 from django.utils import timezone
 
 from sentry.models import (
-    Activity, Commit, CommitAuthor, GroupSubscriptionReason, Release,
-    ReleaseCommit, Repository, UserEmail
+    Activity, Commit, CommitAuthor, Deploy, Environment,
+    GroupSubscriptionReason, Release, ReleaseCommit, Repository, UserEmail
 )
 from sentry.plugins.sentry_mail.activity.release import ReleaseActivityEmail
 from sentry.testutils import TestCase
@@ -44,6 +44,14 @@ class ReleaseTestCase(TestCase):
             date_released=timezone.now(),
         )
         self.release.add_project(self.project)
+        self.deploy = Deploy.objects.create(
+            release=self.release,
+            organization_id=self.org.id,
+            environment_id=Environment.objects.create(
+                name='production',
+                organization_id=self.org.id
+            ).id
+        )
         repository = Repository.objects.create(
             organization_id=self.org.id,
             name=self.project.name,
@@ -87,7 +95,10 @@ class ReleaseTestCase(TestCase):
                 project=self.project,
                 user=self.user,
                 type=Activity.RELEASE,
-                data={'version': self.release.version},
+                data={
+                    'version': self.release.version,
+                    'deploy_id': self.deploy.id,
+                },
             )
         )
 
@@ -97,7 +108,8 @@ class ReleaseTestCase(TestCase):
             }
 
             context = email.get_context()
-            assert context['commit_list'] == [self.commit, self.commit2]
+            assert context['environment'] == 'production'
+            assert context['repos'][0]['commits'] == [self.commit, self.commit2]
 
             with self.tasks():
                 email.send()
@@ -112,7 +124,7 @@ class ReleaseTestCase(TestCase):
                 project=self.project,
                 user=self.user,
                 type=Activity.RELEASE,
-                data={'version': 'a'},
+                data={'version': 'a', 'deploy_id': 5},
             )
         )
 
