commit 5e23084b89e90a2871cbe5cd4f3fe529d9a344b7
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Fri Mar 9 12:58:31 2018 -0600

    fix(tagstore): Fallback to querying the key for ensure_release_exists (#7548)

diff --git a/src/sentry/tagstore/v2/models/grouptagkey.py b/src/sentry/tagstore/v2/models/grouptagkey.py
index a2aa12026a..037ce4e097 100644
--- a/src/sentry/tagstore/v2/models/grouptagkey.py
+++ b/src/sentry/tagstore/v2/models/grouptagkey.py
@@ -43,7 +43,21 @@ class GroupTagKey(Model):
         if hasattr(self, '_set_key'):
             return self._set_key
 
-        return self._key.key
+        if hasattr(self, '__key_cache'):
+            return self._key.key
+
+        # fallback
+        from sentry.tagstore.v2.models import TagKey
+
+        tk = TagKey.objects.filter(
+            project_id=self.project_id,
+            id=self._key_id,
+        ).values_list('key', flat=True).get()
+
+        # cache for future calls
+        self.key = tk
+
+        return tk
 
     @key.setter
     def key(self, key):
diff --git a/src/sentry/tagstore/v2/models/grouptagvalue.py b/src/sentry/tagstore/v2/models/grouptagvalue.py
index 668ed574b3..655d34f3ac 100644
--- a/src/sentry/tagstore/v2/models/grouptagvalue.py
+++ b/src/sentry/tagstore/v2/models/grouptagvalue.py
@@ -49,7 +49,21 @@ class GroupTagValue(Model):
         if hasattr(self, '_set_key'):
             return self._set_key
 
-        return self._key.key
+        if hasattr(self, '__key_cache'):
+            return self._key.key
+
+        # fallback
+        from sentry.tagstore.v2.models import TagKey
+
+        tk = TagKey.objects.filter(
+            project_id=self.project_id,
+            id=self._key_id,
+        ).values_list('key', flat=True).get()
+
+        # cache for future calls
+        self.key = tk
+
+        return tk
 
     @key.setter
     def key(self, key):
@@ -60,7 +74,21 @@ class GroupTagValue(Model):
         if hasattr(self, '_set_value'):
             return self._set_value
 
-        return self._value.value
+        if hasattr(self, '__value_cache'):
+            return self._value.value
+
+        # fallback
+        from sentry.tagstore.v2.models import TagValue
+
+        tv = TagValue.objects.filter(
+            project_id=self.project_id,
+            id=self._value_id,
+        ).values_list('value', flat=True).get()
+
+        # cache for future calls
+        self.value = tv
+
+        return tv
 
     @value.setter
     def value(self, value):
diff --git a/src/sentry/tagstore/v2/models/tagvalue.py b/src/sentry/tagstore/v2/models/tagvalue.py
index a87711d772..e12cfc89d8 100644
--- a/src/sentry/tagstore/v2/models/tagvalue.py
+++ b/src/sentry/tagstore/v2/models/tagvalue.py
@@ -50,7 +50,21 @@ class TagValue(Model):
         if hasattr(self, '_set_key'):
             return self._set_key
 
-        return self._key.key
+        if hasattr(self, '__key_cache'):
+            return self._key.key
+
+        # fallback
+        from sentry.tagstore.v2.models import TagKey
+
+        tk = TagKey.objects.filter(
+            project_id=self.project_id,
+            id=self._key_id,
+        ).values_list('key', flat=True).get()
+
+        # cache for future calls
+        self.key = tk
+
+        return tk
 
     @key.setter
     def key(self, key):
