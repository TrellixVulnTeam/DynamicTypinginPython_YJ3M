commit 5632a0368b8ab315b1853f93d48902d00c1cae2d
Author: Megan Heskett <meg.heskett@gmail.com>
Date:   Mon Feb 24 10:20:18 2020 -0800

    fix(guides): Show discover guide to previous users (#17196)

diff --git a/src/sentry/static/sentry/app/stores/guideStore.jsx b/src/sentry/static/sentry/app/stores/guideStore.jsx
index 058b276cdb..4ee011fdd1 100644
--- a/src/sentry/static/sentry/app/stores/guideStore.jsx
+++ b/src/sentry/static/sentry/app/stores/guideStore.jsx
@@ -147,19 +147,20 @@ const GuideStore = Reflux.createStore({
       // Don't show guides to users who signed up way before these changes were implemented
       const assistantThreshold = new Date(2019, 6, 1);
       // Spam existing users about the discover tab, but not new signups.
-      const discoverDate = new Date(2020, 2, 6);
+      const discoverDate = new Date(2020, 1, 6);
+      const userDateJoined = new Date(user?.dateJoined);
 
       guideKeys = guideKeys.filter(key => {
         if (this.state.guides[key].seen) {
           return false;
         }
-        if (
-          key === 'discover_sidebar' &&
-          (user.isSuperuser || new Date(user.dateJoined) < discoverDate)
-        ) {
+        if (user?.isSuperuser) {
           return true;
         }
-        return user.isSuperuser || new Date(user.dateJoined) > assistantThreshold;
+        if (key === 'discover_sidebar' && userDateJoined >= discoverDate) {
+          return false;
+        }
+        return userDateJoined > assistantThreshold;
       });
     }
 
diff --git a/tests/acceptance/test_organization_events_v2.py b/tests/acceptance/test_organization_events_v2.py
index a2ae1be76e..4886ba4470 100644
--- a/tests/acceptance/test_organization_events_v2.py
+++ b/tests/acceptance/test_organization_events_v2.py
@@ -144,7 +144,7 @@ def generate_transaction():
 class OrganizationEventsV2Test(AcceptanceTestCase, SnubaTestCase):
     def setUp(self):
         super(OrganizationEventsV2Test, self).setUp()
-        self.user = self.create_user("foo@example.com")
+        self.user = self.create_user("foo@example.com", is_superuser=True)
         self.org = self.create_organization(name="Rowdy Tiger")
         self.team = self.create_team(organization=self.org, name="Mariachi Band")
         self.project = self.create_project(organization=self.org, teams=[self.team], name="Bengal")
diff --git a/tests/js/spec/stores/guideStore.spec.jsx b/tests/js/spec/stores/guideStore.spec.jsx
index 29abec4efe..f5fb8d3482 100644
--- a/tests/js/spec/stores/guideStore.spec.jsx
+++ b/tests/js/spec/stores/guideStore.spec.jsx
@@ -83,4 +83,78 @@ describe('GuideStore', function() {
     expect(spy).toHaveBeenCalledTimes(1);
     spy.mockRestore();
   });
+
+  describe('discover sidebar guide', function() {
+    const anchor3 = <GuideAnchor target="discover_sidebar" />;
+
+    beforeEach(function() {
+      data = {
+        discover_sidebar: {
+          id: 4,
+          required_targets: ['discover_sidebar'],
+          steps: [
+            {
+              title: 'Title 4',
+              message: 'Message 4',
+              target: 'discover_sidebar',
+            },
+          ],
+          seen: false,
+        },
+      };
+
+      GuideStore.onRegisterAnchor(anchor3);
+    });
+
+    it('does not render without user', function() {
+      ConfigStore.config = {};
+      GuideStore.onFetchSucceeded(data);
+      expect(GuideStore.state.currentGuide).toBe(null);
+    });
+
+    it('shows discover sidebar guide to superusers', function() {
+      ConfigStore.config = {
+        user: {
+          isSuperuser: true,
+        },
+      };
+      GuideStore.onFetchSucceeded(data);
+      expect(GuideStore.state.currentGuide.id).toBe(data.discover_sidebar.id);
+    });
+
+    it('shows discover sidebar guide to previously existing users', function() {
+      ConfigStore.config = {
+        user: {
+          isSuperuser: false,
+          dateJoined: new Date(2020, 0, 1),
+        },
+      };
+      GuideStore.onFetchSucceeded(data);
+      expect(GuideStore.state.currentGuide.id).toBe(data.discover_sidebar.id);
+    });
+
+    it('does not show discover sidebar guide to new users', function() {
+      ConfigStore.config = {
+        user: {
+          isSuperuser: false,
+          dateJoined: new Date(2020, 1, 22),
+        },
+      };
+      GuideStore.onFetchSucceeded(data);
+      expect(GuideStore.state.currentGuide).toBe(null);
+    });
+
+    it('hides discover sidebar guide once seen', function() {
+      data.discover_sidebar.seen = true;
+      // previous user
+      ConfigStore.config = {
+        user: {
+          isSuperuser: false,
+          dateJoined: new Date(2020, 0, 1),
+        },
+      };
+      GuideStore.onFetchSucceeded(data);
+      expect(GuideStore.state.currentGuide).toBe(null);
+    });
+  });
 });
