commit 37380c7ab31aaf440bba0455d53f8fd268d3fde5
Author: Mark Story <mark@sentry.io>
Date:   Tue Jul 23 11:31:50 2019 -0400

    ref(environments) Optimize environment queries (#14102)
    
    Adding the organization_id to these queries allows postgres to use
    indexes better and makes queries much faster for organizations with many
    environments.

diff --git a/src/sentry/api/endpoints/project_environments.py b/src/sentry/api/endpoints/project_environments.py
index 0671d6a3e6..8b3a6d7589 100644
--- a/src/sentry/api/endpoints/project_environments.py
+++ b/src/sentry/api/endpoints/project_environments.py
@@ -45,6 +45,8 @@ class ProjectEnvironmentsEndpoint(ProjectEndpoint):
 
         queryset = EnvironmentProject.objects.filter(
             project=project,
+            # Including the organization_id is necessary for postgres to use indexes efficiently.
+            environment__organization_id=project.organization_id
         ).exclude(
             # HACK(mattrobenolt): We don't want to surface the
             # "No Environment" environment to the UI since it
diff --git a/src/sentry/api/serializers/models/project.py b/src/sentry/api/serializers/models/project.py
index 27d43862e8..5020481d5c 100644
--- a/src/sentry/api/serializers/models/project.py
+++ b/src/sentry/api/serializers/models/project.py
@@ -272,10 +272,12 @@ class ProjectSummarySerializer(ProjectWithTeamSerializer):
 
         project_envs = EnvironmentProject.objects.filter(
             project_id__in=[i.id for i in item_list],
+            # Including the organization_id is necessary for postgres to use indexes efficiently.
+            environment__organization_id=item_list[0].organization_id
         ).exclude(
-            is_hidden=True
-        ).exclude(
+            is_hidden=True,
             # HACK(lb): avoiding the no environment value
+        ).exclude(
             environment__name=''
         ).values('project_id', 'environment__name')
 
