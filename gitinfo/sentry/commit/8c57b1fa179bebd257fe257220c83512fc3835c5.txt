commit 8c57b1fa179bebd257fe257220c83512fc3835c5
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Wed Apr 19 14:12:15 2017 +0200

    Fixed mocked tests

diff --git a/tests/sentry/lang/javascript/test_plugin.py b/tests/sentry/lang/javascript/test_plugin.py
index 9e1105fe34..3b2262b4e9 100644
--- a/tests/sentry/lang/javascript/test_plugin.py
+++ b/tests/sentry/lang/javascript/test_plugin.py
@@ -151,6 +151,7 @@ class JavascriptIntegrationTest(TestCase):
             'http://example.com/foo.js',
             project=self.project,
             release=None,
+            distribution=None,
             allow_scraping=True,
         )
 
@@ -207,6 +208,7 @@ class JavascriptIntegrationTest(TestCase):
             'http://example.com/test.min.js',
             project=self.project,
             release=None,
+            distribution=None,
             allow_scraping=True,
         )
 
diff --git a/tests/sentry/lang/javascript/test_processor.py b/tests/sentry/lang/javascript/test_processor.py
index ad5682a2e4..bbe9bd66a4 100644
--- a/tests/sentry/lang/javascript/test_processor.py
+++ b/tests/sentry/lang/javascript/test_processor.py
@@ -19,7 +19,7 @@ from sentry.lang.javascript.processor import (
 from sentry.lang.javascript.errormapping import (
     rewrite_exception, REACT_MAPPING_URL
 )
-from sentry.models import File, Release, ReleaseFile, EventError
+from sentry.models import File, Release, Distribution, ReleaseFile, EventError
 from sentry.testutils import TestCase
 from sentry.utils.strings import truncatechars
 
@@ -72,6 +72,65 @@ class FetchReleaseFileTest(TestCase):
 
         assert result == new_result
 
+    def test_distribution(self):
+        project = self.project
+        release = Release.objects.create(
+            organization_id=project.organization_id,
+            version='abc',
+        )
+        release.add_project(project)
+
+        other_file = File.objects.create(
+            name='file.min.js',
+            type='release.file',
+            headers={'Content-Type': 'application/json; charset=utf-8'},
+        )
+        file = File.objects.create(
+            name='file.min.js',
+            type='release.file',
+            headers={'Content-Type': 'application/json; charset=utf-8'},
+        )
+
+        binary_body = unicode_body.encode('utf-8')
+        other_file.putfile(six.BytesIO(b''))
+        file.putfile(six.BytesIO(binary_body))
+
+        dist = Distribution.get_or_create(
+            release,
+            name='foo'
+        )
+
+        ReleaseFile.objects.create(
+            name='file.min.js',
+            release=release,
+            organization_id=project.organization_id,
+            file=other_file,
+        )
+
+        ReleaseFile.objects.create(
+            name='file.min.js',
+            release=release,
+            distribution=dist,
+            organization_id=project.organization_id,
+            file=file,
+        )
+
+        result = fetch_release_file('file.min.js', release, dist)
+
+        assert type(result.body) is six.binary_type
+        assert result == http.UrlResult(
+            'file.min.js',
+            {'content-type': 'application/json; charset=utf-8'},
+            binary_body,
+            200,
+            'utf-8',
+        )
+
+        # test with cache hit, which should be compressed
+        new_result = fetch_release_file('file.min.js', release, dist)
+
+        assert result == new_result
+
 
 class FetchFileTest(TestCase):
     @responses.activate
