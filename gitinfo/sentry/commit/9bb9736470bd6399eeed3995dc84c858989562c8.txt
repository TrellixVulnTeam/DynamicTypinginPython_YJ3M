commit 9bb9736470bd6399eeed3995dc84c858989562c8
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Aug 30 22:24:18 2010 -0700

    Add charts

diff --git a/dblog/templates/dblog/group.html b/dblog/templates/dblog/group.html
index 0622e5afa6..85a4892c56 100644
--- a/dblog/templates/dblog/group.html
+++ b/dblog/templates/dblog/group.html
@@ -11,6 +11,10 @@
 	</div> 
 
 	<div id="sidebar">
+		<h2>Last 24 Hours</h2>
+		
+		<img src="{{ chart_url }}" class="chart" alt="chart"/>
+		
 		<h2>URLs</h2>
 		
 		<ul class="url-list">
diff --git a/dblog/templates/dblog/index.html b/dblog/templates/dblog/index.html
index 9ee5d7db19..8bae486326 100644
--- a/dblog/templates/dblog/index.html
+++ b/dblog/templates/dblog/index.html
@@ -88,6 +88,7 @@
 			#body { background: #f9f9f9; }
 			#sidebar { float: right; width: 384px; padding: 8px; margin-top: 1em; margin-left: -100%; background: inherit; border-left:1px solid #ddd; }
 			#body.with-sidebar { margin-right: 400px; border-right:1px solid #ddd; }
+			#sidebar .chart { margin-bottom: 1em; }
 
 			/* tracebacks */
 			table { border:1px solid #ccc; border-collapse: collapse; width:100%; background:white; }
@@ -194,6 +195,10 @@
 		</div> 
 		
 		<div id="sidebar">
+			<h2>Last 24 Hours</h2>
+			
+			<img src="{{ chart_url }}" class="chart" alt="chart"/>
+			
 			<h2>Loggers</h2>
 
 			<ul class="logger-list filter-list">
diff --git a/dblog/views.py b/dblog/views.py
index b06c4a89d0..992edd2a27 100644
--- a/dblog/views.py
+++ b/dblog/views.py
@@ -8,8 +8,10 @@ from dblog.helpers import FakeRequest, ImprovedExceptionReporter
 from dblog.models import GroupedMessage, Message, LOG_LEVELS
 
 from math import log
+from pygooglechart import SimpleLineChart, Axis
 
 import base64
+import datetime
 try:
     import cPickle as pickle
 except ImportError:
@@ -41,15 +43,42 @@ def index(request):
             'score': 'times_seen / (pow((floor(extract(epoch from now() - last_seen) / 3600) + 2), 1.25) + 1)',
         }
     ).order_by('-score', '-last_seen')
+    
+    
+    today = datetime.datetime.now()
+
+    chart_qs = Message.objects\
+                      .filter(datetime__gte=today - datetime.timedelta(hours=24))\
+                      .extra(select={'hour': 'extract(hour from datetime)'}).values('hour')\
+                      .annotate(num=Count('id')).values_list('hour', 'num')
 
     if logger:
         message_list = message_list.filter(logger=logger)
+        chart_qs = chart_qs.filter(logger=logger)
 
     if level:
         message_list = message_list.filter(level=level)
+        chart_qs = chart_qs.filter(level=level)
 
     if server_name:
         message_list = message_list.filter(server_name=server_name)
+        chart_qs = chart_qs.filter(server_name=server_name)
+
+    rows = dict(chart_qs)
+    if rows:
+        max_y = max(rows.values())
+    else:
+        max_y = 1
+    chart = SimpleLineChart(384, 130, y_range=[0, max_y])
+    chart.add_data([max_y]*30)
+    chart.add_data([rows.get((today-datetime.timedelta(hours=d)).hour, 0) for d in range(0, 24)][::-1])
+    chart.add_data([0]*30)
+    chart.fill_solid(chart.BACKGROUND, 'eeeeee')
+    chart.add_fill_range('eeeeee', 0, 1)
+    chart.add_fill_range('e0ebff', 1, 2)
+    chart.set_colours(['eeeeee', '999999', 'eeeeee'])
+    chart.set_line_style(1, 1)
+    chart_url = chart.get_url()
 
     return render_to_response('dblog/index.html', locals())
 
@@ -106,4 +135,27 @@ def group(request, group_id):
     
     unique_servers = message_list.filter(server_name__isnull=False).values_list('server_name', 'logger', 'view', 'checksum').annotate(times_seen=Count('server_name')).values('server_name', 'times_seen')
     
+    today = datetime.datetime.now()
+
+    chart_qs = message_list\
+                      .filter(datetime__gte=today - datetime.timedelta(hours=24))\
+                      .extra(select={'hour': 'extract(hour from datetime)'}).values('hour')\
+                      .annotate(num=Count('id')).values_list('hour', 'num')
+
+    rows = dict(chart_qs)
+    if rows:
+        max_y = max(rows.values())
+    else:
+        max_y = 1
+    chart = SimpleLineChart(384, 130, y_range=[0, max_y])
+    chart.add_data([max_y]*30)
+    chart.add_data([rows.get((today-datetime.timedelta(hours=d)).hour, 0) for d in range(0, 24)][::-1])
+    chart.add_data([0]*30)
+    chart.fill_solid(chart.BACKGROUND, 'eeeeee')
+    chart.add_fill_range('eeeeee', 0, 1)
+    chart.add_fill_range('e0ebff', 1, 2)
+    chart.set_colours(['eeeeee', '999999', 'eeeeee'])
+    chart.set_line_style(1, 1)
+    chart_url = chart.get_url()
+    
     return render_to_response('dblog/group.html', locals())
\ No newline at end of file
