commit 2693c247722d25fb5903ebf9396f872f8dac27a4
Author: Filippo Pacifici <filippo.pacifici@gmail.com>
Date:   Mon Jun 15 10:53:17 2020 -0700

    fix(snuba): Fix the duration condition on the user_misery metric (#19365)
    
    The user_misery aggregate is passing an infix expression to Snuba, which cannot be parsed.

diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index 1fce6ea225..11e7568b1e 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -1174,7 +1174,7 @@ FUNCTIONS = {
         "name": "user_misery",
         "args": [NumberRange("satisfaction", 0, None)],
         "calculated_args": [{"name": "tolerated", "fn": lambda args: args["satisfaction"] * 4.0}],
-        "transform": u"uniqIf(user, duration > {tolerated:g})",
+        "transform": u"uniqIf(user, greater(duration, {tolerated:g}))",
         "result_type": "number",
     },
     "failure_rate": {
diff --git a/tests/sentry/api/test_event_search.py b/tests/sentry/api/test_event_search.py
index ba09aace56..34189d654e 100644
--- a/tests/sentry/api/test_event_search.py
+++ b/tests/sentry/api/test_event_search.py
@@ -1388,7 +1388,7 @@ class ResolveFieldListTest(unittest.TestCase):
                 None,
                 "impact_300",
             ],
-            ["uniqIf(user, duration > 1200)", None, "user_misery_300"],
+            ["uniqIf(user, greater(duration, 1200))", None, "user_misery_300"],
             ["quantile(0.75)", "transaction.duration", "percentile_transaction_duration_0_75"],
             ["quantile(0.95)", "transaction.duration", "percentile_transaction_duration_0_95"],
             ["quantile(0.99)", "transaction.duration", "percentile_transaction_duration_0_99"],
diff --git a/tests/sentry/snuba/test_discover.py b/tests/sentry/snuba/test_discover.py
index e8b56935b5..7a8abbfe93 100644
--- a/tests/sentry/snuba/test_discover.py
+++ b/tests/sentry/snuba/test_discover.py
@@ -655,7 +655,7 @@ class QueryTransformTest(TestCase):
         mock_query.assert_called_with(
             selected_columns=["transaction"],
             aggregations=[
-                ["uniqIf(user, duration > 1200)", None, "user_misery_300"],
+                ["uniqIf(user, greater(duration, 1200))", None, "user_misery_300"],
                 ["argMax", ["event_id", "timestamp"], "latest_event"],
                 ["argMax", ["project_id", "timestamp"], "projectid"],
                 [
