commit ae2787c37e48563de29ed8a37ab7585451c88b23
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Jan 21 20:59:39 2013 -0800

    More work on new nav structure

diff --git a/src/sentry/static/sentry/less/sentry.less b/src/sentry/static/sentry/less/sentry.less
index 5fa32f6fb5..e7d84f1be1 100644
--- a/src/sentry/static/sentry/less/sentry.less
+++ b/src/sentry/static/sentry/less/sentry.less
@@ -344,7 +344,7 @@ h3 {
   }
 
   .nav {
-    margin-bottom: 0;
+    margin: 0;
     > li {
       > a {
         height: 23px;
diff --git a/src/sentry/templates/sentry/bases/event.html b/src/sentry/templates/sentry/bases/event.html
new file mode 100644
index 0000000000..e69de29bb2
diff --git a/src/sentry/templates/sentry/bases/team.html b/src/sentry/templates/sentry/bases/team.html
new file mode 100644
index 0000000000..b9c61d264d
--- /dev/null
+++ b/src/sentry/templates/sentry/bases/team.html
@@ -0,0 +1,19 @@
+{% extends "sentry/layout.html" %}
+
+{% load i18n %}
+
+{% block title %}{{ team.name }} | {{ block.super }}{% endblock %}
+
+{% block page_header %}
+    <ul class="nav nav-tabs">
+        <li{% if SUBSECTION == 'settings' %} class="active"{% endif %}>
+            <a href="{% url sentry-manage-team team.slug %}">{% trans "Settings" %}</a>
+        </li>
+        <li{% if SUBSECTION == 'projects' %} class="active"{% endif %}>
+            <a href="{% url sentry-manage-team-projects team.slug %}">{% trans "Projects" %}</a>
+        </li>
+        <li{% if SUBSECTION == 'members' %} class="active"{% endif %}>
+            <a href="{% url sentry-manage-team-members team.slug %}">{% trans "Members" %}</a>
+        </li>
+    </ul>
+{% endblock %}
diff --git a/src/sentry/templates/sentry/bases/users.html b/src/sentry/templates/sentry/bases/users.html
new file mode 100644
index 0000000000..e69de29bb2
diff --git a/src/sentry/templates/sentry/partial/_client_config.html b/src/sentry/templates/sentry/partial/_client_config.html
index f67b802afb..c19dc51da5 100644
--- a/src/sentry/templates/sentry/partial/_client_config.html
+++ b/src/sentry/templates/sentry/partial/_client_config.html
@@ -108,7 +108,7 @@
 </div>
 <ul>
     <li>
-        <a href="{% url sentry-docs-client project.slug 'r' %}">
+        <a href="{% url sentry-docs-client project.team.slug project.slug 'r' %}">
             <strong>R Project</strong>
         </a>
     </li>
diff --git a/src/sentry/templates/sentry/projects/base.html b/src/sentry/templates/sentry/projects/base.html
index f3472ed43a..3c0743aeb9 100644
--- a/src/sentry/templates/sentry/projects/base.html
+++ b/src/sentry/templates/sentry/projects/base.html
@@ -1,4 +1,4 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/bases/team.html" %}
 
 {% load i18n %}
 
@@ -10,18 +10,6 @@
 
 {% block bodyclass %}{% endblock %}
 
-{% block page_header %}
-    {% if can_create_projects %}
-        <a href="{% url sentry-new-project team.slug %}" class="btn pull-right btn-primary">{% trans "Create a new project" %}</a>
-    {% endif %}
-    <ul class="breadcrumb">
-        <li><a href="{% url sentry %}" class="dashboard-btn" title="{% trans "Dashboard" %}"><i aria-hidden="true" class="icon-list"></i></a></li>
-        <li class="divider"></li>
-        <li><a href="{% url sentry-project-list team.slug %}">{% trans "Projects" %}</a></li>
-        {% block breadcrumb %}{% endblock %}
-    </ul>
-{% endblock %}
-
 {% block main %}
     <section class="body">
         {% if PROJECT_LIST %}
diff --git a/src/sentry/templates/sentry/projects/manage.html b/src/sentry/templates/sentry/projects/manage.html
index 2ecb743c99..2c03bd4b8b 100644
--- a/src/sentry/templates/sentry/projects/manage.html
+++ b/src/sentry/templates/sentry/projects/manage.html
@@ -65,7 +65,7 @@
 
 {% block sidebar %}
     <ul class="nav nav-list">
-        <li class="nav-header">{% trans "Project" %}</li>
+        <li class="nav-header">{{ project.name }}</li>
         <li{% if page == 'details' %} class="active"{% endif %}>
             <a href="{% url sentry-manage-project project.team.slug project.slug %}">{% trans "Settings" %}</a>
         </li>
diff --git a/src/sentry/templates/sentry/teams/manage.html b/src/sentry/templates/sentry/teams/manage.html
index 8e3f3b7b8a..c1862d260d 100644
--- a/src/sentry/templates/sentry/teams/manage.html
+++ b/src/sentry/templates/sentry/teams/manage.html
@@ -1,28 +1,14 @@
-{% extends "sentry/layout.html" %}
+{% extends "sentry/bases/team.html" %}
 
 {% load crispy_forms_tags %}
 {% load i18n %}
 {% load sentry_helpers %}
 {% load sentry_plugins %}
 
-{% block title %}{% blocktrans with team.name as name %}Manage Team: {{ name }}{% endblocktrans %} | {{ block.super }}{% endblock %}
+{% block title %}{% trans "Settings" %} | {{ block.super }}{% endblock %}
 
 {% block bodyclass %}{% endblock %}
 
-{% block page_header %}
-    <ul class="nav nav-tabs">
-        <li{% if page == 'details' %} class="active"{% endif %}>
-            <a href="{% url sentry-manage-team team.slug %}">{% trans "Settings" %}</a>
-        </li>
-        <li{% if page == 'projects' %} class="active"{% endif %}>
-            <a href="{% url sentry-manage-team-projects team.slug %}">{% trans "Projects" %}</a>
-        </li>
-        <li{% if page == 'members' %} class="active"{% endif %}>
-            <a href="{% url sentry-manage-team-members team.slug %}">{% trans "Members" %}</a>
-        </li>
-    </ul>
-{% endblock %}
-
 {% block main %}
     <section class="body">
         {% block inner %}
@@ -56,18 +42,3 @@
         {% endblock %}
     </section>
 {% endblock %}
-
-{% block sidebar %}
-    <ul class="nav nav-list">
-        <li class="nav-header">{% trans "Team" %}</li>
-        <li{% if page == 'details' %} class="active"{% endif %}>
-            <a href="{% url sentry-manage-team team.slug %}">{% trans "Settings" %}</a>
-        </li>
-        <li{% if page == 'projects' %} class="active"{% endif %}>
-            <a href="{% url sentry-manage-team-projects team.slug %}">{% trans "Projects" %}</a>
-        </li>
-        <li{% if page == 'members' %} class="active"{% endif %}>
-            <a href="{% url sentry-manage-team-members team.slug %}">{% trans "Members" %}</a>
-        </li>
-    </ul>
-{% endblock %}
diff --git a/src/sentry/web/decorators.py b/src/sentry/web/decorators.py
index 29043bd1d2..505ac32553 100644
--- a/src/sentry/web/decorators.py
+++ b/src/sentry/web/decorators.py
@@ -36,8 +36,11 @@ def has_access(group_or_func=None):
                 request.session['_next'] = request.get_full_path()
                 return HttpResponseRedirect(get_login_url())
 
+            has_team = 'team_slug' in kwargs
+            has_project = 'project_id' in kwargs
+
             # Pull in team if it's part of the URL arguments
-            if 'team_slug' in kwargs:
+            if kwargs.get('team_slug'):
                 team_slug = kwargs.pop('team_slug')
                 if request.user.is_superuser:
                     try:
@@ -54,7 +57,7 @@ def has_access(group_or_func=None):
             else:
                 team = None
 
-            if 'project_id' in kwargs:
+            if kwargs.get('project_id'):
                 project_id = kwargs.pop('project_id')
                 # Support project id's
                 if project_id.isdigit():
@@ -85,14 +88,14 @@ def has_access(group_or_func=None):
             else:
                 project = None
 
-            if project:
+            if has_project:
                 # ensure we're accessing this url correctly
-                if team and project.team != team:
+                if project and team and project.team != team:
                     return HttpResponseRedirect(reverse('sentry'))
 
                 kwargs['project'] = project
 
-            if team:
+            if has_team:
                 kwargs['team'] = team
 
             return func(request, *args, **kwargs)
diff --git a/src/sentry/web/frontend/docs.py b/src/sentry/web/frontend/docs.py
index 691e951c22..f6bd2ddd60 100644
--- a/src/sentry/web/frontend/docs.py
+++ b/src/sentry/web/frontend/docs.py
@@ -50,20 +50,22 @@ def get_key_context(user, project):
     }
 
 
-@has_access(MEMBER_SYSTEM)
-def client_help(request, project):
+@has_access
+def client_help(request, team, project):
     context = {
         'page': 'client_help',
         'project': project,
-        'SECTION': 'settings',
+        'team': project.team,
+        'SUBSECTION': 'projects',
+        'SECTION': 'team',
     }
     context.update(get_key_context(request.user, project))
 
     return render_to_response('sentry/projects/client_help.html', context, request)
 
 
-@has_access(MEMBER_SYSTEM)
-def client_guide(request, project, platform):
+@has_access
+def client_guide(request, team, project, platform):
     if platform not in PLATFORM_LIST:
         return HttpResponseRedirect(reverse('sentry'))
 
@@ -74,7 +76,9 @@ def client_guide(request, project, platform):
         'platform_title': PLATFORM_TITLES.get(platform, platform.title()),
         'project': project,
         'page': 'client_help_%s' % (PLATFORM_ROOTS.get(platform, platform),),
-        'SECTION': 'settings',
+        'team': project.team,
+        'SUBSECTION': 'projects',
+        'SECTION': 'team',
     }
     context.update(get_key_context(request.user, project))
 
diff --git a/src/sentry/web/frontend/projects.py b/src/sentry/web/frontend/projects.py
index 58b283e6e9..1265d57482 100644
--- a/src/sentry/web/frontend/projects.py
+++ b/src/sentry/web/frontend/projects.py
@@ -15,7 +15,7 @@ from django.views.decorators.http import require_http_methods
 from sentry.constants import MEMBER_OWNER
 from sentry.models import TeamMember, ProjectKey, Team, FilterKey
 from sentry.permissions import (can_create_projects, can_remove_project, can_create_teams,
-    can_add_team_member, can_add_project_key, can_remove_project_key)
+    can_add_project_key, can_remove_project_key)
 from sentry.plugins import plugins
 from sentry.plugins.helpers import set_option, get_option
 from sentry.web.decorators import login_required, has_access
@@ -31,35 +31,13 @@ from sentry.web.helpers import (render_to_response, get_project_list,
 def get_started(request, project):
     return render_to_response('sentry/get_started.html', {
         'project': project,
+        'team': project.team,
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     }, request)
 
 
-@login_required
-def project_list(request, team):
-    project_list = get_project_list(request.user, hidden=True, select_related=["owner"]).values()
-    team_list = Team.objects.in_bulk([p.team_id for p in project_list])
-    if request.user.is_authenticated():
-        memberships = dict((tm.team_id, tm) for tm in TeamMember.objects.filter(user=request.user, team__in=team_list))
-        keys = dict((p.project_id, p) for p in ProjectKey.objects.filter(user=request.user, project__in=project_list))
-    else:
-        memberships = {}
-        keys = {}
-
-    for project in project_list:
-        key = keys.get(project.id)
-        if key:
-            project.member_dsn = key.get_dsn()
-
-        member = memberships.get(project.team_id)
-        if member:
-            project.member_type = member.get_type_display()
-
-    return render_to_response('sentry/projects/list.html', {
-        'team': team,
-        'project_list': project_list,
-    }, request)
-
-
+# TODO: we need a team specific project creation view, vs the "get started" view
 @login_required
 def new_project(request):
     from django.contrib.auth.models import User
@@ -154,6 +132,8 @@ def remove_project(request, team, project):
         'team': team,
         'form': form,
         'project': project,
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     })
 
     return render_to_response('sentry/projects/remove.html', context, request)
@@ -193,7 +173,8 @@ def manage_project(request, team, project):
         'page': 'details',
         'form': form,
         'project': project,
-        'SECTION': 'settings',
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     })
 
     return render_to_response('sentry/projects/manage.html', context, request)
@@ -221,7 +202,8 @@ def manage_project_keys(request, team, project):
         'project': project,
         'key_list': key_list,
         'can_add_key': can_add_project_key(request.user, project),
-        'SECTION': 'settings',
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     })
 
     return render_to_response('sentry/projects/keys.html', context, request)
@@ -277,7 +259,8 @@ def manage_project_tags(request, team, project):
         'page': 'tags',
         'project': project,
         'form': form,
-        'SECTION': 'settings',
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     }
     return render_to_response('sentry/projects/manage_tags.html', context, request)
 
@@ -301,7 +284,8 @@ def manage_plugins(request, team, project):
         'team': team,
         'page': 'plugins',
         'project': project,
-        'SECTION': 'settings',
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     })
 
     return render_to_response('sentry/projects/plugins/list.html', context, request)
@@ -339,7 +323,8 @@ def configure_project_plugin(request, team, project, slug):
         'project': project,
         'plugin': plugin,
         'plugin_is_enabled': plugin.is_enabled(project),
-        'SECTION': 'settings',
+        'SECTION': 'team',
+        'SUBSECTION': 'projects'
     })
 
     return render_to_response('sentry/projects/plugins/configure.html', context, request)
diff --git a/src/sentry/web/frontend/teams.py b/src/sentry/web/frontend/teams.py
index 559235ec9f..c4cbcc9c91 100644
--- a/src/sentry/web/frontend/teams.py
+++ b/src/sentry/web/frontend/teams.py
@@ -100,6 +100,7 @@ def manage_team(request, team):
         'form': form,
         'team': team,
         'SECTION': 'team',
+        'SUBSECTION': 'settings',
     })
 
     return render_to_response('sentry/teams/manage.html', context, request)
@@ -121,6 +122,7 @@ def manage_team_projects(request, team):
         'team': team,
         'project_list': project_list,
         'SECTION': 'team',
+        'SUBSECTION': 'projects',
     })
 
     return render_to_response('sentry/teams/projects/index.html', context, request)
@@ -144,6 +146,7 @@ def manage_team_members(request, team):
         'member_list': member_list,
         'pending_member_list': pending_member_list,
         'SECTION': 'team',
+        'SUBSECTION': 'members',
     })
 
     return render_to_response('sentry/teams/members/index.html', context, request)
@@ -167,6 +170,7 @@ def remove_team(request, team):
         'form': form,
         'team': team,
         'SECTION': 'team',
+        'SUBSECTION': 'settings',
     })
 
     return render_to_response('sentry/teams/remove.html', context, request)
@@ -212,6 +216,7 @@ def new_team_member(request, team):
         'add_form': add_form,
         'invite_form': invite_form,
         'SECTION': 'team',
+        'SUBSECTION': 'members',
     })
 
     return render_to_response('sentry/teams/members/new.html', context, request)
@@ -296,6 +301,7 @@ def edit_team_member(request, team, member_id):
         'team': team,
         'form': form,
         'SECTION': 'team',
+        'SUBSECTION': 'members',
     })
 
     return render_to_response('sentry/teams/members/edit.html', context, request)
@@ -326,6 +332,7 @@ def remove_team_member(request, team, member_id):
         'member': member,
         'team': team,
         'SECTION': 'team',
+        'SUBSECTION': 'members',
     })
 
     return render_to_response('sentry/teams/members/remove.html', context, request)
@@ -452,6 +459,7 @@ def create_new_team_project(request, team):
         'team': team,
         'page': 'projects',
         'SECTION': 'team',
+        'SUBSECTION': 'settings',
     })
 
     return render_to_response('sentry/teams/projects/new.html', context, request)
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index a8a01cefc6..a999c433c2 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -77,7 +77,6 @@ urlpatterns = patterns('',
         name='sentry-accept-invite'),
 
     # Settings - Projects
-    url(r'^account/teams/(?P<team_slug>[\w_-]+)/projects/$', projects.project_list, name='sentry-project-list'),
     url(r'^account/teams/(?P<team_slug>[\w_-]+)/projects/new/$', projects.new_project, name='sentry-new-project'),
 
     url(r'^(?P<team_slug>[\w_-]+)/(?P<project_id>[\w_-]+)/settings/$', projects.manage_project,
