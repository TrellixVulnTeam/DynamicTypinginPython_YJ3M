commit 661f1bd674e52d068827544ce31154133771db6a
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Jan 8 17:03:37 2015 -0700

    Add labels to tag widgets

diff --git a/src/sentry/static/sentry/scripts/app.js b/src/sentry/static/sentry/scripts/app.js
index b518cb4465..f92e279e3d 100644
--- a/src/sentry/static/sentry/scripts/app.js
+++ b/src/sentry/static/sentry/scripts/app.js
@@ -280,8 +280,9 @@
                             $widget.append($('<li>No data available.</li>'));
                         } else {
                             $.each(data.values, function(_, item){
-                                var tagValue = item[0],
-                                    timesSeen = item[1],
+                                var tagValue = item.value,
+                                    timesSeen = item.count,
+                                    tagLabel = item.label || item.value,
                                     percent = parseInt(timesSeen / total * 100, 10),
                                     url = app.config.urlPrefix + '/' + app.config.organizationId + '/' + app.config.projectId + '/';
 
@@ -289,7 +290,7 @@
                                     '<div class="progressbar">' +
                                         '<div style="width:' + percent + '%">' + timesSeen + '</div>' +
                                         '<a href="' + url + '?' + eTagName + '=' + encodeURIComponent(tagValue) + '">' +
-                                            tagValue +
+                                            tagLabel +
                                             '<span>' + percent + '%</span>' +
                                         '</a>' +
                                     '</div>' +
diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index 78ef9fdf86..782ed2dcf4 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -656,9 +656,34 @@ def get_group_tags(request, organization, project, group_id, tag_name):
         last_seen__gte=cutoff,
     ).values_list('value', 'times_seen').order_by('-times_seen')[:10]
 
+    # fetch TagValue instances so we can get proper labels
+    tag_values = dict(
+        (t.value, t)
+        for t in TagValue.objects.filter(
+            key=tag_name,
+            project_id=project.id,
+            value__in=[u[0] for u in unique_tags],
+        )
+    )
+
+    values = []
+    for tag, times_seen in unique_tags:
+        try:
+            tag_value = tag_values[tag]
+        except KeyError:
+            label = tag
+        else:
+            label = tag_value.get_label()
+
+        values.append({
+            'value': tag,
+            'count': times_seen,
+            'label': label,
+        })
+
     return json.dumps({
         'name': tag_name,
-        'values': list(unique_tags),
+        'values': values,
         'total': total,
     })
 
