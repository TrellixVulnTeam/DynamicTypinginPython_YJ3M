commit baf861e9e77e2535fb7e27515a00017ca98fc55b
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue Mar 1 18:08:07 2016 +0100

    On file checksum mismatch delete the file and store again.

diff --git a/src/sentry/models/dsymfile.py b/src/sentry/models/dsymfile.py
index b9fcae26fc..b0bfd4fc76 100644
--- a/src/sentry/models/dsymfile.py
+++ b/src/sentry/models/dsymfile.py
@@ -10,6 +10,7 @@ from __future__ import absolute_import
 
 import os
 import shutil
+import hashlib
 import tempfile
 from django.db import models, transaction, IntegrityError
 
@@ -82,10 +83,25 @@ def _create_macho_dsym_from_uuid(project, cpu_name, uuid, fileobj,
         extra['project'] = project
         file_type = 'project.dsym'
 
+    h = hashlib.sha1()
+    while 1:
+        chunk = fileobj.read(16384)
+        if not chunk:
+            break
+        h.update(chunk)
+    checksum = h.hexdigest()
+    fileobj.seek(0, 0)
+
     try:
-        return cls.objects.get(uuid=uuid, **extra)
+        rv = cls.objects.get(uuid=uuid, **extra)
+        if rv.file.checksum == checksum:
+            return rv
     except cls.DoesNotExist:
         pass
+    else:
+        # The checksum mismatches.  In this case we delete the old object
+        # and perform a re-upload.
+        rv.delete()
 
     file = File.objects.create(
         name=uuid,
