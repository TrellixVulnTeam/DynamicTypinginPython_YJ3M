commit 13d63471c3f392533d2b28b737f7c156cad09717
Author: Jan Michael Auer <jan.auer@sentry.io>
Date:   Tue Mar 3 17:08:06 2020 +0100

    feat(relay): Expose new quotas to internal relays (#17427)

diff --git a/src/sentry/relay/config.py b/src/sentry/relay/config.py
index 6625392112..7e9985232c 100644
--- a/src/sentry/relay/config.py
+++ b/src/sentry/relay/config.py
@@ -74,6 +74,10 @@ def get_filter_settings(project):
     return filter_settings
 
 
+def get_quotas(project, keys=None):
+    return [quota.to_json() for quota in quotas.get_quotas(project, keys=keys)]
+
+
 def get_project_config(project, org_options=None, full_config=True, project_keys=None):
     """
     Constructs the ProjectConfig information.
@@ -136,6 +140,8 @@ def get_project_config(project, org_options=None, full_config=True, project_keys
         cfg["config"]["groupingConfig"] = get_grouping_config_dict_for_project(project)
     with Hub.current.start_span(op="get_event_retention"):
         cfg["config"]["eventRetention"] = quotas.get_event_retention(project.organization)
+    with Hub.current.start_span(op="get_all_quotas"):
+        cfg["config"]["quotas"] = get_quotas(project, keys=project_keys)
 
     return ProjectConfig(project, **cfg)
 
diff --git a/tests/sentry/api/endpoints/test_relay_projectconfigs.py b/tests/sentry/api/endpoints/test_relay_projectconfigs.py
index 6ec4a9a451..8f04a108fd 100644
--- a/tests/sentry/api/endpoints/test_relay_projectconfigs.py
+++ b/tests/sentry/api/endpoints/test_relay_projectconfigs.py
@@ -151,6 +151,7 @@ def test_internal_relays_should_receive_full_configs(
     assert safe.get_path(cfg, "config", "datascrubbingSettings", "scrubDefaults") is True
     assert safe.get_path(cfg, "config", "datascrubbingSettings", "scrubIpAddresses") is True
     assert safe.get_path(cfg, "config", "datascrubbingSettings", "sensitiveFields") == []
+    assert safe.get_path(cfg, "config", "quotas") == []
 
     # Event retention depends on settings, so assert the actual value. Likely
     # `None` in dev, but must not be missing.
@@ -235,6 +236,7 @@ def test_trusted_external_relays_should_receive_minimal_configs(
     assert safe.get_path(cfg, "config", "datascrubbingSettings", "scrubIpAddresses") is not None
     assert safe.get_path(cfg, "config", "piiConfig", "rules") is None
     assert safe.get_path(cfg, "config", "piiConfig", "applications") is None
+    assert safe.get_path(cfg, "config", "quotas") is None
 
 
 @pytest.mark.django_db
diff --git a/tests/sentry/relay/snapshots/test_config/test_get_project_config.pysnap b/tests/sentry/relay/snapshots/test_config/test_get_project_config.pysnap
deleted file mode 100644
index af3cfcafe1..0000000000
--- a/tests/sentry/relay/snapshots/test_config/test_get_project_config.pysnap
+++ /dev/null
@@ -1,104 +0,0 @@
----
-created: '2020-03-01T13:24:46.984214Z'
-creator: sentry
-source: tests/sentry/relay/test_config.py
----
-allowedDomains:
-- '*'
-datascrubbingSettings:
-  excludeFields: []
-  scrubData: true
-  scrubDefaults: true
-  scrubIpAddresses: false
-  sensitiveFields: []
-eventRetention: null
-filterSettings:
-  browserExtensions:
-    isEnabled: false
-  csp:
-    disallowedSources:
-    - about
-    - ms-browser-extension
-    - chrome://*
-    - chrome-extension://*
-    - chromeinvokeimmediate://*
-    - chromenull://*
-    - safari-extension://*
-    - mxaddon-pkg://*
-    - jar://*
-    - webviewprogressproxy://*
-    - ms-browser-extension://*
-    - tmtbff://*
-    - mbinit://*
-    - symres://*
-    - resource://*
-    - moz-extension://*
-    - '*.metrext.com'
-    - static.image2play.com
-    - '*.tlscdn.com'
-    - 73a5b0806e464be8bd4e694c744624f0.com
-    - 020dfefc4ac745dab7594f2f771c1ded.com
-    - '*.superfish.com'
-    - addons.mozilla.org
-    - v.zilionfast.in
-    - widgets.amung.us
-    - '*.superfish.com'
-    - xls.searchfun.in
-    - istatic.datafastguru.info
-    - v.zilionfast.in
-    - localhost
-    - resultshub-a.akamaihd.net
-    - pulseadnetwork.com
-    - gateway.zscalertwo.net
-    - www.passpack.com
-    - middlerush-a.akamaihd.net
-    - www.websmartcenter.com
-    - a.linkluster.com
-    - saveyoutime.ru
-    - cdncache-a.akamaihd.net
-    - x.rafomedia.com
-    - savingsslider-a.akamaihd.net
-    - injections.adguard.com
-    - icontent.us
-    - amiok.org
-    - connectionstrenth.com
-    - siteheart.net
-    - netanalitics.space
-    - printapplink.com
-    - godlinkapp.com
-    - devappstor.com
-    - hoholikik.club
-    - smartlink.cool
-    - promfflinkdev.com
-  legacyBrowsers:
-    isEnabled: false
-  localhost:
-    isEnabled: false
-  webCrawlers:
-    isEnabled: true
-groupingConfig:
-  enhancements: eJybzDhxY3J-bm5-npWRgaGlroGxrpHxBABcTQcY
-  id: newstyle:2019-10-29
-piiConfig:
-  applications:
-    $string:
-    - organization:remove_ips_and_macs
-    - project:remove_ips_and_macs
-  rules:
-    organization:remove_ips_and_macs:
-      hide_rule: false
-      redaction:
-        method: remove
-      rules:
-      - '@ip'
-      - '@mac'
-      type: multiple
-    project:remove_ips_and_macs:
-      hide_rule: false
-      redaction:
-        method: remove
-      rules:
-      - '@ip'
-      - '@mac'
-      type: multiple
-trustedRelays: []
diff --git a/tests/sentry/relay/snapshots/test_config/test_get_project_config/False.pysnap b/tests/sentry/relay/snapshots/test_config/test_get_project_config/False.pysnap
new file mode 100644
index 0000000000..3b62ab7c16
--- /dev/null
+++ b/tests/sentry/relay/snapshots/test_config/test_get_project_config/False.pysnap
@@ -0,0 +1,39 @@
+---
+created: '2020-03-03T15:00:37.986304Z'
+creator: sentry
+source: tests/sentry/relay/test_config.py
+---
+config:
+  allowedDomains:
+  - '*'
+  datascrubbingSettings:
+    excludeFields: []
+    scrubData: true
+    scrubDefaults: true
+    scrubIpAddresses: false
+    sensitiveFields: []
+  piiConfig:
+    applications:
+      $string:
+      - organization:remove_ips_and_macs
+      - project:remove_ips_and_macs
+    rules:
+      organization:remove_ips_and_macs:
+        hide_rule: false
+        redaction:
+          method: remove
+        rules:
+        - '@ip'
+        - '@mac'
+        type: multiple
+      project:remove_ips_and_macs:
+        hide_rule: false
+        redaction:
+          method: remove
+        rules:
+        - '@ip'
+        - '@mac'
+        type: multiple
+  trustedRelays: []
+disabled: false
+slug: bar
diff --git a/tests/sentry/relay/snapshots/test_config/test_get_project_config/True.pysnap b/tests/sentry/relay/snapshots/test_config/test_get_project_config/True.pysnap
new file mode 100644
index 0000000000..312fa5670e
--- /dev/null
+++ b/tests/sentry/relay/snapshots/test_config/test_get_project_config/True.pysnap
@@ -0,0 +1,108 @@
+---
+created: '2020-03-03T15:00:38.166505Z'
+creator: sentry
+source: tests/sentry/relay/test_config.py
+---
+config:
+  allowedDomains:
+  - '*'
+  datascrubbingSettings:
+    excludeFields: []
+    scrubData: true
+    scrubDefaults: true
+    scrubIpAddresses: false
+    sensitiveFields: []
+  eventRetention: null
+  filterSettings:
+    browserExtensions:
+      isEnabled: false
+    csp:
+      disallowedSources:
+      - about
+      - ms-browser-extension
+      - chrome://*
+      - chrome-extension://*
+      - chromeinvokeimmediate://*
+      - chromenull://*
+      - safari-extension://*
+      - mxaddon-pkg://*
+      - jar://*
+      - webviewprogressproxy://*
+      - ms-browser-extension://*
+      - tmtbff://*
+      - mbinit://*
+      - symres://*
+      - resource://*
+      - moz-extension://*
+      - '*.metrext.com'
+      - static.image2play.com
+      - '*.tlscdn.com'
+      - 73a5b0806e464be8bd4e694c744624f0.com
+      - 020dfefc4ac745dab7594f2f771c1ded.com
+      - '*.superfish.com'
+      - addons.mozilla.org
+      - v.zilionfast.in
+      - widgets.amung.us
+      - '*.superfish.com'
+      - xls.searchfun.in
+      - istatic.datafastguru.info
+      - v.zilionfast.in
+      - localhost
+      - resultshub-a.akamaihd.net
+      - pulseadnetwork.com
+      - gateway.zscalertwo.net
+      - www.passpack.com
+      - middlerush-a.akamaihd.net
+      - www.websmartcenter.com
+      - a.linkluster.com
+      - saveyoutime.ru
+      - cdncache-a.akamaihd.net
+      - x.rafomedia.com
+      - savingsslider-a.akamaihd.net
+      - injections.adguard.com
+      - icontent.us
+      - amiok.org
+      - connectionstrenth.com
+      - siteheart.net
+      - netanalitics.space
+      - printapplink.com
+      - godlinkapp.com
+      - devappstor.com
+      - hoholikik.club
+      - smartlink.cool
+      - promfflinkdev.com
+    legacyBrowsers:
+      isEnabled: false
+    localhost:
+      isEnabled: false
+    webCrawlers:
+      isEnabled: true
+  groupingConfig:
+    enhancements: eJybzDhxY3J-bm5-npWRgaGlroGxrpHxBABcTQcY
+    id: newstyle:2019-10-29
+  piiConfig:
+    applications:
+      $string:
+      - organization:remove_ips_and_macs
+      - project:remove_ips_and_macs
+    rules:
+      organization:remove_ips_and_macs:
+        hide_rule: false
+        redaction:
+          method: remove
+        rules:
+        - '@ip'
+        - '@mac'
+        type: multiple
+      project:remove_ips_and_macs:
+        hide_rule: false
+        redaction:
+          method: remove
+        rules:
+        - '@ip'
+        - '@mac'
+        type: multiple
+  quotas: []
+  trustedRelays: []
+disabled: false
+slug: bar
diff --git a/tests/sentry/relay/test_config.py b/tests/sentry/relay/test_config.py
index bc552edeff..7753317e37 100644
--- a/tests/sentry/relay/test_config.py
+++ b/tests/sentry/relay/test_config.py
@@ -2,6 +2,7 @@ from __future__ import absolute_import
 
 import pytest
 
+from sentry.models import ProjectKey
 from sentry.relay.config import get_project_config
 
 PII_CONFIG = """
@@ -27,10 +28,25 @@ PII_CONFIG = """
 
 
 @pytest.mark.django_db
-def test_get_project_config(default_project, insta_snapshot):
+@pytest.mark.parametrize("full", [False, True])
+def test_get_project_config(default_project, insta_snapshot, full):
     # We could use the default_project fixture here, but we would like to avoid 1) hitting the db 2) creating a mock
     default_project.update_option("sentry:relay_pii_config", PII_CONFIG)
     default_project.organization.update_option("sentry:relay_pii_config", PII_CONFIG)
-    cfg = get_project_config(default_project)
+    keys = ProjectKey.objects.filter(project=default_project)
 
-    insta_snapshot(cfg.config)
+    cfg = get_project_config(default_project, full_config=full, project_keys=keys)
+    cfg = cfg.to_dict()
+
+    # Remove keys that change everytime
+    cfg.pop("lastChange")
+    cfg.pop("lastFetch")
+    cfg.pop("rev")
+
+    # public keys change every time
+    assert cfg.pop("projectId") == default_project.id
+    assert len(cfg.pop("publicKeys")) == len(keys)
+    if full:
+        assert cfg.pop("organizationId") == default_project.organization.id
+
+    insta_snapshot(cfg)
