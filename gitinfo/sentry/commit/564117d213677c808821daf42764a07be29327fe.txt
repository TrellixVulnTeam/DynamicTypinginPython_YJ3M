commit 564117d213677c808821daf42764a07be29327fe
Author: Jess MacQueen <jess@getsentry.com>
Date:   Fri Mar 10 12:20:00 2017 -0800

    move notification sending to deploy endpoint

diff --git a/src/sentry/api/endpoints/organization_release_details.py b/src/sentry/api/endpoints/organization_release_details.py
index c1a6ed8f21..517e1b6b27 100644
--- a/src/sentry/api/endpoints/organization_release_details.py
+++ b/src/sentry/api/endpoints/organization_release_details.py
@@ -140,14 +140,13 @@ class OrganizationReleaseDetailsEndpoint(OrganizationReleasesBaseEndpoint):
 
         if (not was_released and release.date_released):
             for project in release.projects.all():
-                activity = Activity.objects.create(
+                Activity.objects.create(
                     type=Activity.RELEASE,
                     project=project,
                     ident=release.version,
                     data={'version': release.version},
                     datetime=release.date_released,
                 )
-            activity.send_notification()
 
         return Response(serialize(release, request.user))
 
diff --git a/src/sentry/api/endpoints/organization_releases.py b/src/sentry/api/endpoints/organization_releases.py
index 286368ed9b..cca9032012 100644
--- a/src/sentry/api/endpoints/organization_releases.py
+++ b/src/sentry/api/endpoints/organization_releases.py
@@ -148,14 +148,13 @@ class OrganizationReleasesEndpoint(OrganizationReleasesBaseEndpoint):
 
             if release.date_released:
                 for project in new_projects:
-                    activity = Activity.objects.create(
+                    Activity.objects.create(
                         type=Activity.RELEASE,
                         project=project,
                         ident=result['version'],
                         data={'version': result['version']},
                         datetime=release.date_released,
                     )
-                    activity.send_notification()
 
             commit_list = result.get('commits')
             if commit_list:
diff --git a/src/sentry/api/endpoints/project_release_details.py b/src/sentry/api/endpoints/project_release_details.py
index 4fc15ebef7..528a3c77e7 100644
--- a/src/sentry/api/endpoints/project_release_details.py
+++ b/src/sentry/api/endpoints/project_release_details.py
@@ -156,14 +156,13 @@ class ProjectReleaseDetailsEndpoint(ProjectEndpoint):
             hook.set_commits(release.version, commit_list)
 
         if (not was_released and release.date_released):
-            activity = Activity.objects.create(
+            Activity.objects.create(
                 type=Activity.RELEASE,
                 project=project,
                 ident=release.version,
                 data={'version': release.version},
                 datetime=release.date_released,
             )
-            activity.send_notification()
 
         return Response(serialize(release, request.user))
 
diff --git a/src/sentry/api/endpoints/project_releases.py b/src/sentry/api/endpoints/project_releases.py
index 284556cdde..704c9116c8 100644
--- a/src/sentry/api/endpoints/project_releases.py
+++ b/src/sentry/api/endpoints/project_releases.py
@@ -173,14 +173,13 @@ class ProjectReleasesEndpoint(ProjectEndpoint):
                 hook.set_commits(release.version, commit_list)
 
             if (not was_released and release.date_released):
-                activity = Activity.objects.create(
+                Activity.objects.create(
                     type=Activity.RELEASE,
                     project=project,
                     ident=result['version'],
                     data={'version': result['version']},
                     datetime=release.date_released,
                 )
-                activity.send_notification()
 
             if not created:
                 # This is the closest status code that makes sense, and we want
diff --git a/src/sentry/api/endpoints/release_deploys.py b/src/sentry/api/endpoints/release_deploys.py
index 09d528a6d3..f496cca478 100644
--- a/src/sentry/api/endpoints/release_deploys.py
+++ b/src/sentry/api/endpoints/release_deploys.py
@@ -13,7 +13,7 @@ from sentry.api.exceptions import ResourceDoesNotExist
 from sentry.api.paginator import OffsetPaginator
 from sentry.api.serializers import serialize
 from sentry.app import locks
-from sentry.models import Deploy, Environment, Release
+from sentry.models import Activity, Deploy, Environment, Release
 from sentry.utils.retries import TimedRetryPolicy
 
 
@@ -136,6 +136,21 @@ class ReleaseDeploysEndpoint(OrganizationReleasesBaseEndpoint):
                     date_started=result.get('dateStarted'),
                 )
 
+            for project in release.projects.all():
+                activity = Activity.objects.create(
+                    type=Activity.DEPLOY,
+                    project=project,
+                    ident=result['version'],
+                    data={
+                        'version': result['version'],
+                        'deploy_id': deploy.id,
+                    },
+                    datetime=deploy.date_finished,
+                )
+            # Somewhat hacky, only send notification for one
+            # Deploy Activity record because it will cover all projects
+            activity.send_notification()
+
             # This is the closest status code that makes sense, and we want
             # a unique 2xx response code so people can understand when
             # behavior differs.
diff --git a/src/sentry/models/activity.py b/src/sentry/models/activity.py
index 6e12f3fae9..3320ec16db 100644
--- a/src/sentry/models/activity.py
+++ b/src/sentry/models/activity.py
@@ -40,6 +40,7 @@ class Activity(Model):
     MERGE = 14
     SET_RESOLVED_BY_AGE = 15
     SET_RESOLVED_IN_COMMIT = 16
+    DEPLOY = 17
 
     TYPE = (
         # (TYPE, verb-slug)
@@ -59,6 +60,7 @@ class Activity(Model):
         (ASSIGNED, 'assigned'),
         (UNASSIGNED, 'unassigned'),
         (MERGE, 'merge'),
+        (DEPLOY, 'deploy'),
     )
 
     project = FlexibleForeignKey('sentry.Project')
@@ -83,7 +85,7 @@ class Activity(Model):
         from sentry.models import Release
 
         # XXX(dcramer): fix for bad data
-        if self.type == self.RELEASE and isinstance(self.data['version'], Release):
+        if self.type in (self.RELEASE, self.DEPLOY) and isinstance(self.data['version'], Release):
             self.data['version'] = self.data['version'].version
         if self.type == self.ASSIGNED:
             self.data['assignee'] = six.text_type(self.data['assignee'])
diff --git a/src/sentry/plugins/interfaces/releasehook.py b/src/sentry/plugins/interfaces/releasehook.py
index 955052f4d8..9ed30b5883 100644
--- a/src/sentry/plugins/interfaces/releasehook.py
+++ b/src/sentry/plugins/interfaces/releasehook.py
@@ -81,14 +81,13 @@ class ReleaseHook(object):
 
         release.add_project(self.project)
 
-        activity = Activity.objects.create(
+        Activity.objects.create(
             type=Activity.RELEASE,
             project=self.project,
             ident=version,
             data={'version': version},
             datetime=values['date_released'],
         )
-        activity.send_notification()
 
     def handle(self, request):
         raise NotImplementedError
diff --git a/src/sentry/plugins/sentry_mail/activity/__init__.py b/src/sentry/plugins/sentry_mail/activity/__init__.py
index 09a2843016..53f9ac544d 100644
--- a/src/sentry/plugins/sentry_mail/activity/__init__.py
+++ b/src/sentry/plugins/sentry_mail/activity/__init__.py
@@ -13,7 +13,7 @@ from .unassigned import UnassignedActivityEmail
 emails = {
     Activity.ASSIGNED: AssignedActivityEmail,
     Activity.NOTE: NoteActivityEmail,
-    Activity.RELEASE: ReleaseActivityEmail,
+    Activity.DEPLOY: ReleaseActivityEmail,
     Activity.SET_REGRESSION: RegressionActivityEmail,
     Activity.SET_RESOLVED: ResolvedActivityEmail,
     Activity.SET_RESOLVED_IN_RELEASE: ResolvedInReleaseActivityEmail,
diff --git a/src/sentry/plugins/sentry_mail/activity/release.py b/src/sentry/plugins/sentry_mail/activity/release.py
index 335ff409a9..4a35af61c1 100644
--- a/src/sentry/plugins/sentry_mail/activity/release.py
+++ b/src/sentry/plugins/sentry_mail/activity/release.py
@@ -3,9 +3,9 @@ from __future__ import absolute_import
 from sentry import features
 from sentry.db.models.query import in_iexact
 from sentry.models import (
-    CommitFileChange, Group, GroupSubscriptionReason,
-    GroupCommitResolution, Release, ReleaseCommit,
-    Repository, User
+    CommitFileChange, Deploy, Environment, Group,
+    GroupSubscriptionReason, GroupCommitResolution,
+    Release, ReleaseCommit, Repository, User
 )
 from sentry.utils.http import absolute_uri
 
@@ -16,6 +16,12 @@ class ReleaseActivityEmail(ActivityEmail):
     def __init__(self, activity):
         super(ReleaseActivityEmail, self).__init__(activity)
         self.organization = self.project.organization
+
+        try:
+            self.deploy = Deploy.objects.get(id=activity.data['deploy_id'])
+        except Deploy.DoesNotExist:
+            self.deploy = None
+
         try:
             self.release = Release.objects.get(
                 organization_id=self.project.organization_id,
@@ -42,7 +48,7 @@ class ReleaseActivityEmail(ActivityEmail):
                 ).values('id', 'name')
             }
             for commit in self.commit_list:
-                repos[commit.repository_id].commits.append(commit)
+                repos[commit.repository_id]['commits'].append(commit)
 
             self.repos = repos.values()
 
@@ -52,7 +58,7 @@ class ReleaseActivityEmail(ActivityEmail):
             ])
 
     def should_email(self):
-        return bool(self.release)
+        return bool(self.release and self.deploy)
 
     def get_participants(self):
         project = self.project
@@ -98,6 +104,8 @@ class ReleaseActivityEmail(ActivityEmail):
             ).count() for p in projects
         ]
 
+        environment = Environment.objects.get(id=self.deploy.environment_id).name
+
         return {
             'projects': zip(projects, release_links, resolved_issue_counts),
             'project_count': len(projects),
@@ -106,6 +114,7 @@ class ReleaseActivityEmail(ActivityEmail):
             'file_count': file_count,
             'repos': self.repos,
             'release': self.release,
+            'environment': environment or 'Default Environment',
         }
 
     def get_subject(self):
diff --git a/src/sentry/templates/sentry/emails/activity/release.html b/src/sentry/templates/sentry/emails/activity/release.html
index 1625520580..8a393b73e2 100644
--- a/src/sentry/templates/sentry/emails/activity/release.html
+++ b/src/sentry/templates/sentry/emails/activity/release.html
@@ -7,8 +7,7 @@
 
 {% block activity %}
     <h2 style="margin-bottom: 10px">
-        <!-- TODO(jess) update these static values -->
-        Version {{ release.short_version }} was [deployed] to [production]
+        Version {{ release.short_version }} was [deployed] to [{{ environment }}]
     </h2>
     <p class="muted"><small><strong style="color: #72697d;">{{ release.date_added }}</strong> <span class="divider">&nbsp;</span>  {{ commit_count }} commits, {{ author_count }} authors, and {{ file_count }} files changed across {{ project_count }} projects</small></p>
 
diff --git a/src/sentry/web/frontend/debug/debug_new_release_email.py b/src/sentry/web/frontend/debug/debug_new_release_email.py
index 00372d25d3..49e93b3817 100644
--- a/src/sentry/web/frontend/debug/debug_new_release_email.py
+++ b/src/sentry/web/frontend/debug/debug_new_release_email.py
@@ -99,5 +99,6 @@ class DebugNewReleaseEmailView(View):
                 'commit_count': 4,
                 'author_count': 1,
                 'file_count': 5,
+                'environment': 'production',
             },
         ).render(request)
