commit fe67e5a9e2614ea8ec12c4d721065033811b3c26
Author: Ben Vinegar <benvinegar@users.noreply.github.com>
Date:   Fri Sep 9 13:09:48 2016 -0700

    Improved team assignment via invite/edit form (#4103)
    
    /cc @getsentry/infrastructure

diff --git a/src/sentry/web/forms/base_organization_member.py b/src/sentry/web/forms/base_organization_member.py
index a9b4f44f62..027d741a1f 100644
--- a/src/sentry/web/forms/base_organization_member.py
+++ b/src/sentry/web/forms/base_organization_member.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 
 from django import forms
+from django.db import transaction
 
 from sentry.models import (
     OrganizationMember,
@@ -38,13 +39,11 @@ class BaseOrganizationMemberForm(forms.ModelForm):
 
         self.fields['teams'].queryset = all_teams
 
+    @transaction.atomic
     def save_team_assignments(self, organization_member):
-        for team in self.cleaned_data['teams']:
-            OrganizationMemberTeam.objects.create_or_update(
-                team=team,
-                organizationmember=organization_member,
-            )
-
-        OrganizationMemberTeam.objects.filter(
-            organizationmember=organization_member,
-        ).exclude(team__in=self.cleaned_data['teams']).delete()
+        OrganizationMemberTeam.objects.filter(organizationmember=organization_member).delete()
+        OrganizationMemberTeam.objects.bulk_create([
+            OrganizationMemberTeam(team=team,
+                                   organizationmember=organization_member)
+            for team in self.cleaned_data['teams']
+        ])
diff --git a/tests/sentry/web/forms/test_base_organization_member.py b/tests/sentry/web/forms/test_base_organization_member.py
new file mode 100644
index 0000000000..c4b4e5574e
--- /dev/null
+++ b/tests/sentry/web/forms/test_base_organization_member.py
@@ -0,0 +1,40 @@
+from __future__ import absolute_import
+
+from sentry.web.forms.base_organization_member import BaseOrganizationMemberForm
+from sentry.testutils import TestCase
+
+from sentry.roles.manager import Role
+from sentry.models import (
+    Team,
+    OrganizationMemberTeam,
+)
+
+
+class BaseOrganizationMemberFormTest(TestCase):
+    def test_save_team_assignments(self):
+        organization = self.create_organization(
+            owner=self.create_user('owner@example.com'),
+        )
+        team1 = self.create_team(name='team1', organization=organization)
+        team2 = self.create_team(name='team2', organization=organization)
+        some_user = self.create_user('someuser@example.com')
+        user_org_membership = self.create_member(
+            teams=[team1],
+            user=some_user,
+            organization=organization
+        )
+
+        form = BaseOrganizationMemberForm(data={
+            'teams': [team2.id],
+            'role': 'member'
+        },
+            all_teams=Team.objects.filter(organization=organization),
+            allowed_roles=[Role(1, 'member', 'Member')]
+        )
+        assert form.is_valid()
+
+        form.save_team_assignments(user_org_membership)
+
+        assigned_teams = OrganizationMemberTeam.objects.filter(organizationmember=user_org_membership)
+        assert len(assigned_teams) == 1
+        assert assigned_teams[0].team_id == team2.id
