commit 8ac920d66cb9498d841d621ec8051ce7d74acbc7
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Fri Mar 31 16:00:17 2017 -0700

    migrations: Make sure we log useful errors on tricky migrations
    
    Refs GH-5035

diff --git a/src/sentry/south_migrations/0290_populate_release_project_new_groups.py b/src/sentry/south_migrations/0290_populate_release_project_new_groups.py
index 6ec9e2e351..3b05643f0e 100644
--- a/src/sentry/south_migrations/0290_populate_release_project_new_groups.py
+++ b/src/sentry/south_migrations/0290_populate_release_project_new_groups.py
@@ -10,9 +10,22 @@ from sentry.utils.query import RangeQuerySetWrapperWithProgressBar
 class Migration(DataMigration):
 
     def forwards(self, orm):
-        "Write your forwards methods here."
         db.commit_transaction()
+        try:
+            self._forwards(orm)
+        except Exception:
+            # Explicitly resume the transaction because
+            # South is going to try and roll it back, but when
+            # it can't find one, it'll error itself, masking
+            # the actual exception being raised
+            #
+            # See https://github.com/getsentry/sentry/issues/5035
+            db.start_transaction()
+            raise
+        db.start_transaction()
 
+    def _forwards(self, orm):
+        "Write your forwards methods here."
         for release in RangeQuerySetWrapperWithProgressBar(orm.Release.objects.exclude(new_groups=0)):
             projects = list(release.projects.values_list('id', flat=True))
             if len(projects) > 1:
@@ -36,8 +49,6 @@ class Migration(DataMigration):
                     project_id=projects[0]
                 ).update(new_groups=release.new_groups)
 
-        db.start_transaction()
-
     def backwards(self, orm):
         "Write your backwards methods here."
 
diff --git a/src/sentry/south_migrations/0302_merge_environments.py b/src/sentry/south_migrations/0302_merge_environments.py
index 2c0b93747c..26c6d43ab2 100644
--- a/src/sentry/south_migrations/0302_merge_environments.py
+++ b/src/sentry/south_migrations/0302_merge_environments.py
@@ -8,8 +8,22 @@ from django.db import IntegrityError, models, transaction
 class Migration(DataMigration):
 
     def forwards(self, orm):
-        "Write your forwards methods here."
         db.commit_transaction()
+        try:
+            self._forwards(orm)
+        except Exception:
+            # Explicitly resume the transaction because
+            # South is going to try and roll it back, but when
+            # it can't find one, it'll error itself, masking
+            # the actual exception being raised
+            #
+            # See https://github.com/getsentry/sentry/issues/5035
+            db.start_transaction()
+            raise
+        db.start_transaction()
+
+    def _forwards(self, orm):
+        "Write your forwards methods here."
         dupe_envs = orm.Environment.objects.values('name', 'organization_id')\
                                            .annotate(ecount=models.Count('id'))\
                                            .filter(ecount__gt=1)
@@ -77,8 +91,6 @@ class Migration(DataMigration):
                 id__in=[re.id for re in from_renvs],
             ).delete()
 
-        db.start_transaction()
-
     def backwards(self, orm):
         "Write your backwards methods here."
 
