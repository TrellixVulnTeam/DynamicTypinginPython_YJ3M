commit a4998cd9de87275b7d87034d80da6a554bffd1fe
Author: Chris Fuller <cfuller@sentry.io>
Date:   Thu Apr 23 13:19:12 2020 -0400

    fix(workflow): Bringing has_access into migration context (#18438)

diff --git a/src/sentry/migrations/0069_remove_tracked_superusers.py b/src/sentry/migrations/0069_remove_tracked_superusers.py
index e206496f01..f5e5231d25 100644
--- a/src/sentry/migrations/0069_remove_tracked_superusers.py
+++ b/src/sentry/migrations/0069_remove_tracked_superusers.py
@@ -4,19 +4,24 @@ from __future__ import unicode_literals
 
 from django.db import migrations
 
+def has_access(org, user, access=None):
+    queryset = org.member_set.filter(user=user)
+    if access is not None:
+        queryset = queryset.filter(type__lte=access)
+
+    return queryset.exists()
+
+
 def remove_tracked_superuser_views(apps, schema_editor):
     """
     We recently added code to only track alert views of people in the org + member of associated alert projects.
     This migration removes all of the views we've tracked before adding this change (i.e. superuser views of orgs we're not a part of).
     """
     IncidentSeen = apps.get_model("sentry", "IncidentSeen")
-    IncidentProject = apps.get_model("sentry", "IncidentProject")
     tracked_views = IncidentSeen.objects.all().select_related("user", "incident")
     for tracked_view in tracked_views:
-        tracked_user = tracked_view.user
-        tracked_incident = tracked_view.incident
-        is_org_member = tracked_incident.organization.has_access(tracked_user)
-        if not is_org_member:
+        org_member = has_access(tracked_view.incident.organization, tracked_view.user)
+        if not org_member:
             tracked_view.delete()
 
 
