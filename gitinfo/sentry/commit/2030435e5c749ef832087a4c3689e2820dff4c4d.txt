commit 2030435e5c749ef832087a4c3689e2820dff4c4d
Author: David Cramer <dcramer@gmail.com>
Date:   Wed May 7 01:23:04 2014 -0700

    Re-enable wall using new APIs

diff --git a/src/sentry/templates/sentry/wall.html b/src/sentry/templates/sentry/wall.html
index 5489994662..3f8c2f7fc5 100644
--- a/src/sentry/templates/sentry/wall.html
+++ b/src/sentry/templates/sentry/wall.html
@@ -23,7 +23,7 @@
     </div>
     <div class="container-fluid" id="chart">
         <div class="row-fluid">
-            <div class="chart" data-api-url="{% url 'sentry-api-chart' team.slug %}">
+            <div class="chart" data-api-url="{% url 'sentry-api-0-team-stats' team.id %}">
                 <span class="loading">{% trans "Loading historical data..." %}</span>
             </div>
         </div>
diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index ce8d8ba7e2..936754604f 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -26,6 +26,7 @@ from django.views.generic.base import View as BaseView
 from raven.contrib.django.models import client as Raven
 
 from sentry import app
+from sentry.app import tsdb
 from sentry.constants import (
     MEMBER_USER, STATUS_MUTED, STATUS_UNRESOLVED, STATUS_RESOLVED,
     EVENTS_PER_PAGE)
@@ -723,17 +724,28 @@ def get_stats(request, team=None, project=None):
         project_list = Project.objects.get_for_user(request.user, team=team)
 
     cutoff = datetime.timedelta(minutes=minutes)
-    cutoff_dt = timezone.now() - cutoff
+
+    end = timezone.now()
+    start = end - cutoff
 
     # TODO(dcramer): this is used in an unreleased feature. reimplement it using
     # new API and tsdb
+    results = tsdb.get_range(
+        model=tsdb.models.project,
+        keys=[p.id for p in project_list],
+        start=start,
+        end=end,
+    )
     num_events = 0
+    for project, points in results.iteritems():
+        num_events += sum(p[1] for p in points)
 
     # XXX: This is too slow if large amounts of groups are resolved
+    # TODO(dcramer); move this into tsdb
     num_resolved = Group.objects.filter(
         project__in=project_list,
         status=STATUS_RESOLVED,
-        resolved_at__gte=cutoff_dt,
+        resolved_at__gte=start,
     ).aggregate(t=Sum('times_seen'))['t'] or 0
 
     data = {
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index be98629ed8..8b3cbbe3e1 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -279,8 +279,8 @@ urlpatterns += patterns('',
         name='sentry-api-search-projects'),
 
     # TV dashboard
-    # url(r'^(?P<team_slug>[\w_-]+)/wall/$', groups.wall_display,
-    #     name='sentry-wall'),
+    url(r'^(?P<team_slug>[\w_-]+)/wall/$', groups.wall_display,
+        name='sentry-wall'),
 
     # Team-wide alerts
     url(r'^(?P<team_slug>[\w_-]+)/show/alerts/$', alerts.alert_list,
