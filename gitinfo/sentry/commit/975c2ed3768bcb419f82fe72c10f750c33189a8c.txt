commit 975c2ed3768bcb419f82fe72c10f750c33189a8c
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Oct 31 13:10:08 2016 -0700

    [sso/mfa] various auth improvements
    
    - remove social auth backends as normal auth providers
    - remove infinite redirect from 2fa + already auth'd state

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 73dd404044..6b1358366b 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -296,14 +296,17 @@ else:
     LOGIN_URL = reverse_lazy('sentry-login')
 
 AUTHENTICATION_BACKENDS = (
-    'social_auth.backends.github.GithubBackend',
-    'social_auth.backends.bitbucket.BitbucketBackend',
-    'social_auth.backends.trello.TrelloBackend',
     'sentry.utils.auth.EmailAuthBackend',
 )
 
 SOCIAL_AUTH_USER_MODEL = AUTH_USER_MODEL = 'sentry.User'
 
+SOCIAL_AUTH_AUTHENTICATION_BACKENDS = (
+    'social_auth.backends.github.GithubBackend',
+    'social_auth.backends.bitbucket.BitbucketBackend',
+    'social_auth.backends.trello.TrelloBackend',
+)
+
 SESSION_ENGINE = "django.contrib.sessions.backends.signed_cookies"
 SESSION_COOKIE_NAME = "sentrysid"
 SESSION_SERIALIZER = "django.contrib.sessions.serializers.PickleSerializer"
diff --git a/src/sentry/utils/auth.py b/src/sentry/utils/auth.py
index 2d1b1df90c..40d2f3c22c 100644
--- a/src/sentry/utils/auth.py
+++ b/src/sentry/utils/auth.py
@@ -214,6 +214,7 @@ def login(request, user, passed_2fa=None, after_2fa=None,
         request.session['_pending_2fa'] = [user.id, time(), organization_id]
         if after_2fa is not None:
             request.session['_after_2fa'] = after_2fa
+        request.session.modified = True
         return False
 
     # TODO(dcramer): this needs to be bound based on MFA options
diff --git a/src/sentry/web/frontend/twofactor.py b/src/sentry/web/frontend/twofactor.py
index cc038af00e..fffa78ad7d 100644
--- a/src/sentry/web/frontend/twofactor.py
+++ b/src/sentry/web/frontend/twofactor.py
@@ -99,7 +99,7 @@ class TwoFactorAuthView(BaseView):
 
     def handle(self, request):
         user = auth.get_pending_2fa_user(request)
-        if user is None or request.user.is_authenticated():
+        if user is None or not request.user.is_authenticated():
             return HttpResponseRedirect(auth.get_login_url())
 
         interfaces = Authenticator.objects.all_interfaces_for_user(user)
diff --git a/src/social_auth/backends/__init__.py b/src/social_auth/backends/__init__.py
index fa6b6c0459..3b99675f1f 100644
--- a/src/social_auth/backends/__init__.py
+++ b/src/social_auth/backends/__init__.py
@@ -718,7 +718,7 @@ def get_backends(force_load=False):
 
     if not BACKENDSCACHE or force_load:
         with _import_lock:
-            for auth_backend in setting('AUTHENTICATION_BACKENDS'):
+            for auth_backend in setting('SOCIAL_AUTH_AUTHENTICATION_BACKENDS'):
                 mod, cls_name = auth_backend.rsplit('.', 1)
                 module = __import__(mod, {}, {}, ['BACKENDS', cls_name])
                 backend = getattr(module, cls_name)
