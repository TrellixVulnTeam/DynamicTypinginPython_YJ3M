commit fed421b407063114186f5ebe9b2f1ee0ca612246
Author: 0x6a6f7368 <joshua.r.li.98@gmail.com>
Date:   Thu Jul 26 11:40:56 2018 -0700

    file: move deletefile outside of lock (#9202)

diff --git a/src/sentry/models/file.py b/src/sentry/models/file.py
index df69d8b460..77bef9a7ab 100644
--- a/src/sentry/models/file.py
+++ b/src/sentry/models/file.py
@@ -132,14 +132,24 @@ class FileBlob(Model):
     def delete(self, *args, **kwargs):
         lock = locks.get('fileblob:upload:{}'.format(self.checksum), duration=60 * 10)
         with TimedRetryPolicy(60)(lock.acquire):
-            if self.path:
-                self.deletefile(commit=False)
             super(FileBlob, self).delete(*args, **kwargs)
+        if self.path:
+            self.deletefile(commit=False)
 
     def deletefile(self, commit=False):
         assert self.path
 
-        delete_file_task.delay(self.path, self.checksum)
+        # Defer this by 1 minute just to make sure
+        # we avoid any transaction isolation where the
+        # FileBlob row might still be visible by the
+        # task before transaction is committed.
+        delete_file_task.apply_async(
+            kwargs={
+                'path': self.path,
+                'checksum': self.checksum,
+            },
+            countdown=60,
+        )
 
         self.path = None
 
