commit d15ae0d129913575ffb269759a34717fdfd855a4
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Fri Jan 18 13:39:53 2019 -0800

    perf(dashboard): Cancel in-flight requests on dashboard unmount (#11611)
    
    Since dashboard queries autorun and can be slow, we should cancel when
    navigating away from this page.

diff --git a/src/sentry/static/sentry/app/views/organizationDashboard/discoverQuery.jsx b/src/sentry/static/sentry/app/views/organizationDashboard/discoverQuery.jsx
index 32cc9f8174..20708f4e18 100644
--- a/src/sentry/static/sentry/app/views/organizationDashboard/discoverQuery.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDashboard/discoverQuery.jsx
@@ -44,6 +44,10 @@ class DiscoverQuery extends React.Component {
     this.fetchData();
   }
 
+  componentWillUnmount() {
+    this.queryBuilders.forEach(builder => builder.cancelRequests());
+  }
+
   createQueryBuilders() {
     const {organization, queries} = this.props;
     queries.forEach(query => {
diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/index.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/index.jsx
index 7cb02bbdf1..4e357abbc2 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/index.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/index.jsx
@@ -100,6 +100,7 @@ class OrganizationDiscoverContainer extends React.Component {
   }
 
   componentWillUnmount() {
+    this.queryBuilder.cancelRequests();
     document.body.classList.remove('body-discover');
   }
 
diff --git a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
index 5a6a4f4979..e32c223e2b 100644
--- a/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDiscover/queryBuilder.jsx
@@ -40,6 +40,7 @@ function applyDefaults(query) {
  * initialization.
  */
 export default function createQueryBuilder(initial = {}, organization) {
+  const api = new Client();
   let query = applyDefaults(initial);
   const defaultProjects = organization.projects
     .filter(projects => projects.isMember)
@@ -53,6 +54,7 @@ export default function createQueryBuilder(initial = {}, organization) {
     updateField,
     fetch,
     fetchWithoutLimit,
+    cancelRequests,
     getQueryByType,
     getColumns,
     load,
@@ -178,7 +180,6 @@ export default function createQueryBuilder(initial = {}, organization) {
    * @returns {Promise<Object|Error>}
    */
   function fetch(data = getExternal(), cursor = '0:0:1') {
-    const api = new Client();
     const limit = data.limit || 1000;
     const endpoint = `/organizations/${organization.slug}/discover/query/?per_page=${limit}&cursor=${cursor}`;
 
@@ -218,7 +219,6 @@ export default function createQueryBuilder(initial = {}, organization) {
    * @returns {Promise<Object|Error>}
    */
   function fetchWithoutLimit(data = getExternal()) {
-    const api = new Client();
     const endpoint = `/organizations/${organization.slug}/discover/query/`;
 
     // Reject immediately if no projects are available
@@ -241,6 +241,15 @@ export default function createQueryBuilder(initial = {}, organization) {
     });
   }
 
+  /**
+   * Cancels any in-flight API requests made via `fetch` or `fetchWithoutLimit`
+   *
+   * @returns {Void}
+   */
+  function cancelRequests() {
+    api.clear();
+  }
+
   /**
    * Get the actual query to be run for each visualization type
    *
