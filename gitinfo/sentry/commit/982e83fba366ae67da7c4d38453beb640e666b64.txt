commit 982e83fba366ae67da7c4d38453beb640e666b64
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Sat May 14 19:18:44 2016 +0200

    Show a hint that removing the last 2fa method also removes backup methods

diff --git a/src/sentry/templates/sentry/account/twofactor/remove.html b/src/sentry/templates/sentry/account/twofactor/remove.html
index f51aa3a313..c9eeb25868 100644
--- a/src/sentry/templates/sentry/account/twofactor/remove.html
+++ b/src/sentry/templates/sentry/account/twofactor/remove.html
@@ -4,6 +4,7 @@
 {% load sentry_helpers %}
 
 {% block twofactor_title %}{% trans "Remove Method:" %} {{ auth.name }}{% endblock %}
+{% block twofactor_backup_warning %}{% endblock %}
 {% block twofactor_body %}
   <p>
     Do you want to remove the method?  You will no longer be able to
@@ -11,6 +12,14 @@
     authenticator removes two-factor authentication.
   </p>
 
+  {% if removes_backups %}
+  <p>
+    Removing this authentication method will also automatically remove
+    backup methods such as recovery codes and disable two-factor
+    authentication.
+  </p>
+  {% endif %}
+
   <form action="" method="post" class="form-stacked">
     {% csrf_token %}
     <input type="hidden" name="remove" value="1">
diff --git a/src/sentry/templates/sentry/bases/twofactor_settings.html b/src/sentry/templates/sentry/bases/twofactor_settings.html
index 57e631005c..1104c49870 100644
--- a/src/sentry/templates/sentry/bases/twofactor_settings.html
+++ b/src/sentry/templates/sentry/bases/twofactor_settings.html
@@ -7,13 +7,15 @@
 
 {% block main %}
   <legend style="margin-top: 0;">{% block twofactor_title %}{% trans "Method:" %} {{ auth.name }}{% endblock %}</legend>
-  {% if is_missing_backup_interfaces %}
-    <div class="alert alert-warning">
-      <strong>Warning:</strong>
-      You do not have a backup authenticator enabled.
-      <a href="{% url 'sentry-account-settings-2fa-recovery' %}?enroll=yes">Click here to add recovery codes</a>.
-    </div>
-  {% endif %}
+  {% block twofactor_backup_warning %}
+    {% if is_missing_backup_interfaces %}
+      <div class="alert alert-warning">
+        <strong>Warning:</strong>
+        You do not have a backup authenticator enabled.
+        <a href="{% url 'sentry-account-settings-2fa-recovery' %}?enroll=yes">Click here to add recovery codes</a>.
+      </div>
+    {% endif %}
+  {% endblock %}
 
   {% block twofactor_body %}{% endblock %}
 {% endblock %}
diff --git a/src/sentry/web/frontend/accounts_twofactor.py b/src/sentry/web/frontend/accounts_twofactor.py
index 78748a56ef..ec619ff0a7 100644
--- a/src/sentry/web/frontend/accounts_twofactor.py
+++ b/src/sentry/web/frontend/accounts_twofactor.py
@@ -67,7 +67,17 @@ class TwoFactorSettingsView(BaseView):
         elif 'yes' in request.POST:
             self.delete_authenticator(interface)
             return HttpResponseRedirect(reverse('sentry-account-settings-2fa'))
+
+        all_interfaces = Authenticator.objects.all_interfaces_for_user(
+            request.user)
+        other_interfaces = [x for x in all_interfaces
+                            if x.interface_id != interface.interface_id]
+        backup_interfaces = [x for x in other_interfaces if x.backup_interface]
+        removes_backups = backup_interfaces and \
+            len(backup_interfaces) == len(other_interfaces)
+
         context = self.make_context(request, interface)
+        context['removes_backups'] = removes_backups
         return render_to_response('sentry/account/twofactor/remove.html',
                                   context, request)
 
