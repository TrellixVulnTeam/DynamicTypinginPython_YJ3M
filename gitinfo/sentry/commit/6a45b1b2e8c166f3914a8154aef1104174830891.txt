commit 6a45b1b2e8c166f3914a8154aef1104174830891
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Dec 13 14:08:43 2018 -0800

    ref(snuba): Add exception type for too many simultaneous queries (#11040)

diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index 6c0fd529fe..9ab356e94d 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -149,6 +149,20 @@ class QueryIllegalTypeOfArgument(QueryExecutionError):
     """
 
 
+class QueryTooManySimultaneous(QueryExecutionError):
+    """
+    Exception raised when a query is rejected due to too many simultaneous
+    queries being performed on the database.
+    """
+
+
+clickhouse_error_codes_map = {
+    43: QueryIllegalTypeOfArgument,
+    241: QueryMemoryLimitExceeded,
+    202: QueryTooManySimultaneous,
+}
+
+
 class QueryOutsideRetentionError(Exception):
     pass
 
@@ -419,12 +433,10 @@ def raw_query(start, end, groupby=None, conditions=None, filter_keys=None,
             elif error['type'] == 'schema':
                 raise SchemaValidationError(error['message'])
             elif error['type'] == 'clickhouse':
-                if error['code'] == 43:
-                    raise QueryIllegalTypeOfArgument(error['message'])
-                elif error['code'] == 241:
-                    raise QueryMemoryLimitExceeded(error['message'])
-                else:
-                    raise QueryExecutionError(error['message'])
+                raise clickhouse_error_codes_map.get(
+                    error['code'],
+                    QueryExecutionError,
+                )(error['message'])
             else:
                 raise SnubaError(error['message'])
         else:
