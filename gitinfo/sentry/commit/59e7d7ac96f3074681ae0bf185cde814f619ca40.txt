commit 59e7d7ac96f3074681ae0bf185cde814f619ca40
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Wed Jan 17 18:36:16 2018 -0800

    fix(releases): Handle long release versions when creating activity records
    
    fixes SENTRY-5QE

diff --git a/src/sentry/api/endpoints/organization_release_details.py b/src/sentry/api/endpoints/organization_release_details.py
index c92bc57ad6..0eeea2554b 100644
--- a/src/sentry/api/endpoints/organization_release_details.py
+++ b/src/sentry/api/endpoints/organization_release_details.py
@@ -182,7 +182,7 @@ class OrganizationReleaseDetailsEndpoint(OrganizationReleasesBaseEndpoint):
                 Activity.objects.create(
                     type=Activity.RELEASE,
                     project=project,
-                    ident=release.version,
+                    ident=Activity.get_version_ident(release.version),
                     data={'version': release.version},
                     datetime=release.date_released,
                 )
diff --git a/src/sentry/api/endpoints/organization_releases.py b/src/sentry/api/endpoints/organization_releases.py
index 1f667131bf..372058a8c0 100644
--- a/src/sentry/api/endpoints/organization_releases.py
+++ b/src/sentry/api/endpoints/organization_releases.py
@@ -170,7 +170,7 @@ class OrganizationReleasesEndpoint(OrganizationReleasesBaseEndpoint):
                     Activity.objects.create(
                         type=Activity.RELEASE,
                         project=project,
-                        ident=result['version'],
+                        ident=Activity.get_version_ident(result['version']),
                         data={'version': result['version']},
                         datetime=release.date_released,
                     )
diff --git a/src/sentry/api/endpoints/project_release_details.py b/src/sentry/api/endpoints/project_release_details.py
index 40fc27ccba..721bce10a8 100644
--- a/src/sentry/api/endpoints/project_release_details.py
+++ b/src/sentry/api/endpoints/project_release_details.py
@@ -111,7 +111,7 @@ class ProjectReleaseDetailsEndpoint(ProjectEndpoint):
             Activity.objects.create(
                 type=Activity.RELEASE,
                 project=project,
-                ident=release.version,
+                ident=Activity.get_version_ident(release.version),
                 data={'version': release.version},
                 datetime=release.date_released,
             )
diff --git a/src/sentry/api/endpoints/project_releases.py b/src/sentry/api/endpoints/project_releases.py
index 6c8a95ecd4..fa23a58e0c 100644
--- a/src/sentry/api/endpoints/project_releases.py
+++ b/src/sentry/api/endpoints/project_releases.py
@@ -141,7 +141,7 @@ class ProjectReleasesEndpoint(ProjectEndpoint):
                 Activity.objects.create(
                     type=Activity.RELEASE,
                     project=project,
-                    ident=result['version'],
+                    ident=Activity.get_version_ident(result['version']),
                     data={'version': result['version']},
                     datetime=release.date_released,
                 )
diff --git a/src/sentry/models/activity.py b/src/sentry/models/activity.py
index e82b2a83a0..b1a5c2f81b 100644
--- a/src/sentry/models/activity.py
+++ b/src/sentry/models/activity.py
@@ -85,6 +85,10 @@ class Activity(Model):
 
     __repr__ = sane_repr('project_id', 'group_id', 'event_id', 'user_id', 'type', 'ident')
 
+    @staticmethod
+    def get_version_ident(version):
+        return (version or '')[:64]
+
     def __init__(self, *args, **kwargs):
         super(Activity, self).__init__(*args, **kwargs)
         from sentry.models import Release
diff --git a/src/sentry/plugins/interfaces/releasehook.py b/src/sentry/plugins/interfaces/releasehook.py
index 66589bc224..9db5fef37b 100644
--- a/src/sentry/plugins/interfaces/releasehook.py
+++ b/src/sentry/plugins/interfaces/releasehook.py
@@ -88,7 +88,7 @@ class ReleaseHook(object):
         Activity.objects.create(
             type=Activity.RELEASE,
             project=self.project,
-            ident=version,
+            ident=Activity.get_version_ident(version),
             data={'version': version},
             datetime=values['date_released'],
         )
diff --git a/src/sentry/testutils/fixtures.py b/src/sentry/testutils/fixtures.py
index df9b79b886..ff10d91831 100644
--- a/src/sentry/testutils/fixtures.py
+++ b/src/sentry/testutils/fixtures.py
@@ -329,7 +329,7 @@ class Fixtures(object):
         Activity.objects.create(
             type=Activity.RELEASE,
             project=project,
-            ident=version,
+            ident=Activity.get_version_ident(version),
             user=user,
             data={'version': version},
         )
diff --git a/src/sentry/utils/apidocs.py b/src/sentry/utils/apidocs.py
index 402bbbf5de..1165264c30 100644
--- a/src/sentry/utils/apidocs.py
+++ b/src/sentry/utils/apidocs.py
@@ -317,7 +317,7 @@ class MockUtils(object):
         Activity.objects.create(
             type=Activity.RELEASE,
             project=project,
-            ident=version,
+            ident=Activity.get_version_ident(version),
             user=user,
             data={'version': version},
         )
diff --git a/tests/sentry/api/endpoints/test_organization_release_details.py b/tests/sentry/api/endpoints/test_organization_release_details.py
index b3fc6b84e3..a3225ffc4e 100644
--- a/tests/sentry/api/endpoints/test_organization_release_details.py
+++ b/tests/sentry/api/endpoints/test_organization_release_details.py
@@ -461,6 +461,52 @@ class UpdateReleaseDetailsTest(APITestCase):
         )
         assert activity.exists()
 
+    def test_activity_generation_long_release(self):
+        user = self.create_user(is_staff=False, is_superuser=False)
+        org = self.organization
+        org.flags.allow_joinleave = False
+        org.save()
+
+        team = self.create_team(organization=org)
+
+        project = self.create_project(teams=[team], organization=org)
+
+        release = Release.objects.create(
+            organization_id=org.id,
+            version='x' * 65,
+        )
+
+        release.add_project(project)
+
+        self.create_member(teams=[team], user=user, organization=org)
+
+        self.login_as(user=user)
+
+        url = reverse(
+            'sentry-api-0-organization-release-details',
+            kwargs={
+                'organization_slug': org.slug,
+                'version': release.version,
+            }
+        )
+        response = self.client.put(
+            url, data={
+                'dateReleased': datetime.utcnow().isoformat() + 'Z',
+            }
+        )
+
+        assert response.status_code == 200, (response.status_code, response.content)
+
+        release = Release.objects.get(id=release.id)
+        assert release.date_released
+
+        activity = Activity.objects.filter(
+            type=Activity.RELEASE,
+            project=project,
+            ident=release.version[:64],
+        )
+        assert activity.exists()
+
 
 class ReleaseDeleteTest(APITestCase):
     def test_simple(self):
diff --git a/tests/sentry/api/endpoints/test_organization_releases.py b/tests/sentry/api/endpoints/test_organization_releases.py
index 96f63bc6c2..09cfaf653c 100644
--- a/tests/sentry/api/endpoints/test_organization_releases.py
+++ b/tests/sentry/api/endpoints/test_organization_releases.py
@@ -334,6 +334,47 @@ class OrganizationReleaseCreateTest(APITestCase):
             type=Activity.RELEASE, project=project2, ident=release.version
         ).exists()
 
+    def test_activity_with_long_release(self):
+        user = self.create_user(is_staff=False, is_superuser=False)
+        org = self.create_organization()
+        org.flags.allow_joinleave = False
+        org.save()
+
+        team = self.create_team(organization=org)
+        project = self.create_project(name='foo', organization=org, teams=[team])
+        project2 = self.create_project(name='bar', organization=org, teams=[team])
+
+        self.create_member(teams=[team], user=user, organization=org)
+        self.login_as(user=user)
+
+        release = Release.objects.create(
+            version='x' * 65, date_released=datetime.utcnow(), organization=org
+        )
+        release.add_project(project)
+
+        url = reverse(
+            'sentry-api-0-organization-releases', kwargs={
+                'organization_slug': org.slug,
+            }
+        )
+
+        response = self.client.post(url, data={'version': 'x' * 65, 'projects': [project.slug]})
+        assert response.status_code == 208, response.content
+
+        response = self.client.post(
+            url, data={'version': 'x' * 65,
+                       'projects': [project.slug, project2.slug]}
+        )
+
+        # should be 201 because 1 project was added
+        assert response.status_code == 201, response.content
+        assert not Activity.objects.filter(
+            type=Activity.RELEASE, project=project, ident=release.version[:64]
+        ).exists()
+        assert Activity.objects.filter(
+            type=Activity.RELEASE, project=project2, ident=release.version[:64]
+        ).exists()
+
     def test_version_whitespace(self):
         user = self.create_user(is_staff=False, is_superuser=False)
         org = self.create_organization()
diff --git a/tests/sentry/api/endpoints/test_project_release_details.py b/tests/sentry/api/endpoints/test_project_release_details.py
index 167fea40d4..7bb7044007 100644
--- a/tests/sentry/api/endpoints/test_project_release_details.py
+++ b/tests/sentry/api/endpoints/test_project_release_details.py
@@ -152,6 +152,45 @@ class UpdateReleaseDetailsTest(APITestCase):
         )
         assert activity.exists()
 
+    def test_activity_generation_long_version(self):
+        self.login_as(user=self.user)
+
+        project = self.create_project(name='foo')
+        project2 = self.create_project(name='bar', organization=project.organization)
+
+        release = Release.objects.create(
+            organization_id=project.organization_id,
+            version='x' * 65,
+        )
+        release.add_project(project)
+        release.add_project(project2)
+
+        url = reverse(
+            'sentry-api-0-project-release-details',
+            kwargs={
+                'organization_slug': project.organization.slug,
+                'project_slug': project.slug,
+                'version': release.version,
+            }
+        )
+        response = self.client.put(
+            url, data={
+                'dateReleased': datetime.utcnow().isoformat() + 'Z',
+            }
+        )
+
+        assert response.status_code == 200, (response.status_code, response.content)
+
+        release = Release.objects.get(id=release.id)
+        assert release.date_released
+
+        activity = Activity.objects.filter(
+            type=Activity.RELEASE,
+            project=project,
+            ident=release.version[:64],
+        )
+        assert activity.exists()
+
 
 class ReleaseDeleteTest(APITestCase):
     def test_simple(self):
