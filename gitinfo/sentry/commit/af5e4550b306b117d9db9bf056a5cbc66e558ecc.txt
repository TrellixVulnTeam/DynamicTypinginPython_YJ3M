commit af5e4550b306b117d9db9bf056a5cbc66e558ecc
Author: David Cramer <dcramer@gmail.com>
Date:   Thu May 1 17:45:07 2014 -0300

    use tsdb backend for stats endpoints

diff --git a/src/sentry/api/endpoints/group_stats.py b/src/sentry/api/endpoints/group_stats.py
index ebc1c1c515..debeca1018 100644
--- a/src/sentry/api/endpoints/group_stats.py
+++ b/src/sentry/api/endpoints/group_stats.py
@@ -1,8 +1,12 @@
+from datetime import timedelta
+from django.utils import timezone
 from rest_framework.response import Response
 
+from sentry.app import tsdb
 from sentry.api.base import Endpoint
 from sentry.api.permissions import assert_perm
 from sentry.models import Group
+from sentry.tsdb.base import TSDBModel
 
 
 class GroupStatsEndpoint(Endpoint):
@@ -15,20 +19,9 @@ class GroupStatsEndpoint(Endpoint):
 
         days = min(int(request.GET.get('days', 1)), 30)
 
-        import random
-        import time
-        now = int(time.time())
-        if days == 1:
-            TICK = 60 * 60
-            NUM_TICKS = 24
-        else:
-            TICK = 60 * 60 * 24
-            NUM_TICKS = days
-        data = [(now - (n * TICK), random.randint(0, 500)) for n in range(NUM_TICKS + 1, 0, -1)]
-
-        # data = Group.objects.get_chart_data_for_group(
-        #     instances=[group],
-        #     max_days=min(int(request.GET.get('days', 1)), 30),
-        # )
+        end = timezone.now()
+        start = end - timedelta(days=days)
+
+        data = tsdb.get_range(TSDBModel.group, [group.id], start, end)[group.id]
 
         return Response(data)
diff --git a/src/sentry/api/endpoints/project_stats.py b/src/sentry/api/endpoints/project_stats.py
index 1e3bf8a575..db1c6dfa49 100644
--- a/src/sentry/api/endpoints/project_stats.py
+++ b/src/sentry/api/endpoints/project_stats.py
@@ -1,8 +1,12 @@
+from datetime import timedelta
+from django.utils import timezone
 from rest_framework.response import Response
 
+from sentry.app import tsdb
 from sentry.api.base import Endpoint
 from sentry.api.permissions import assert_perm
 from sentry.models import Project
+from sentry.tsdb.base import TSDBModel
 
 
 class ProjectStatsEndpoint(Endpoint):
@@ -15,20 +19,9 @@ class ProjectStatsEndpoint(Endpoint):
 
         days = min(int(request.GET.get('days', 1)), 30)
 
-        import random
-        import time
-        now = int(time.time())
-        if days == 1:
-            TICK = 60 * 60
-            NUM_TICKS = 24
-        else:
-            TICK = 60 * 60 * 24
-            NUM_TICKS = days
-        data = [(now - (n * TICK), random.randint(0, 500)) for n in range(NUM_TICKS, 0, -1)]
-
-        # data = Project.objects.get_chart_data(
-        #     instances=project,
-        #     max_days=min(int(request.GET.get('days', 1)), 30),
-        # )
+        end = timezone.now()
+        start = end - timedelta(days=1)
+
+        data = tsdb.get_range(TSDBModel.project, [project.id], start, end)[project.id]
 
         return Response(data)
diff --git a/src/sentry/api/endpoints/team_stats.py b/src/sentry/api/endpoints/team_stats.py
index 7d4c31c79c..9130f01a1f 100644
--- a/src/sentry/api/endpoints/team_stats.py
+++ b/src/sentry/api/endpoints/team_stats.py
@@ -1,8 +1,12 @@
+from datetime import timedelta
+from django.utils import timezone
 from rest_framework.response import Response
 
+from sentry.app import tsdb
 from sentry.api.base import Endpoint
 from sentry.api.permissions import assert_perm
 from sentry.models import Team, Project
+from sentry.tsdb.base import TSDBModel
 
 
 class TeamStatsEndpoint(Endpoint):
@@ -11,11 +15,13 @@ class TeamStatsEndpoint(Endpoint):
 
         assert_perm(team, request.user)
 
+        days = min(int(request.GET.get('days', 1)), 30)
+
         projects = Project.objects.get_for_user(request.user, team=team)
 
-        data = Project.objects.get_chart_data_for_group(
-            instances=projects,
-            max_days=min(int(request.GET.get('days', 1)), 30),
-        )
+        end = timezone.now()
+        start = end - timedelta(days=days)
+
+        data = tsdb.get_range(TSDBModel.project, [p.id for p in projects], start, end)
 
         return Response(data)
diff --git a/src/sentry/tsdb/dummy.py b/src/sentry/tsdb/dummy.py
index 3a844831a6..b8f3325101 100644
--- a/src/sentry/tsdb/dummy.py
+++ b/src/sentry/tsdb/dummy.py
@@ -18,4 +18,4 @@ class DummyTSDB(BaseTSDB):
         pass
 
     def get_range(self, model, keys, start, end, rollup=None):
-        return {}
+        return dict((k, []) for k in keys)
diff --git a/tests/sentry/api/endpoints/test_group_stats.py b/tests/sentry/api/endpoints/test_group_stats.py
index 874be6d646..def6b521c0 100644
--- a/tests/sentry/api/endpoints/test_group_stats.py
+++ b/tests/sentry/api/endpoints/test_group_stats.py
@@ -15,3 +15,4 @@ class GroupStatsTest(APITestCase):
         response = self.client.get(url, format='json')
 
         assert response.status_code == 200, response.content
+        assert type(response.data) == list
diff --git a/tests/sentry/api/endpoints/test_project_stats.py b/tests/sentry/api/endpoints/test_project_stats.py
index 4169c544f0..9752e42a56 100644
--- a/tests/sentry/api/endpoints/test_project_stats.py
+++ b/tests/sentry/api/endpoints/test_project_stats.py
@@ -15,3 +15,4 @@ class ProjectStatsTest(APITestCase):
         response = self.client.get(url, format='json')
 
         assert response.status_code == 200, response.content
+        assert type(response.data) == list
diff --git a/tests/sentry/api/endpoints/test_team_stats.py b/tests/sentry/api/endpoints/test_team_stats.py
index c4a1828558..71c7dd9862 100644
--- a/tests/sentry/api/endpoints/test_team_stats.py
+++ b/tests/sentry/api/endpoints/test_team_stats.py
@@ -17,3 +17,5 @@ class TeamStatsTest(APITestCase):
         response = self.client.get(url, format='json')
 
         assert response.status_code == 200, response.content
+        assert project_1.id in response.data
+        assert project_2.id in response.data
