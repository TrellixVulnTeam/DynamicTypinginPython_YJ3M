commit 5ea988fe04ea01f9251086842cc4fee8e23e92eb
Author: Davi Campos <arlocm@gmail.com>
Date:   Sun Aug 26 21:42:43 2012 -0300

    Save user language in UserOption and load setting on logon
    - Changing AccountSettingsForm to save language in UserOption.
    - Adding 'user_logged_in' signal to set user language on logon.

diff --git a/src/sentry/models.py b/src/sentry/models.py
index ff342901c2..2042dfc3bb 100644
--- a/src/sentry/models.py
+++ b/src/sentry/models.py
@@ -19,6 +19,7 @@ from indexer.models import BaseIndex
 from picklefield.fields import PickledObjectField
 
 from django.contrib.auth.models import User
+from django.contrib.auth.signals import user_logged_in
 from django.core.urlresolvers import reverse
 from django.db import models
 from django.db.models import F
@@ -846,6 +847,17 @@ def remove_key_for_team_member(instance, **kwargs):
             user=instance.user,
         ).delete()
 
+# Set user language if set
+def set_language_on_logon(request, user, **kwargs):
+    language = UserOption.objects.get_value(
+        user=user,
+        project=None,
+        key='language',
+        default=None,
+    )
+    if language and hasattr(request, 'session'):
+        request.session['django_language'] = language
+
 # Signal registration
 post_syncdb.connect(
     create_default_project,
@@ -882,6 +894,7 @@ pre_delete.connect(
     dispatch_uid="remove_key_for_team_member",
     weak=False,
 )
+user_logged_in.connect(set_language_on_logon)
 
 try:
     import south
diff --git a/src/sentry/web/forms/accounts.py b/src/sentry/web/forms/accounts.py
index dce60cf45e..fd799fcb7c 100644
--- a/src/sentry/web/forms/accounts.py
+++ b/src/sentry/web/forms/accounts.py
@@ -76,4 +76,13 @@ class AccountSettingsForm(forms.Form):
         self.user.email = self.cleaned_data['email']
         if commit:
             self.user.save()
+
+        # Save user language
+        UserOption.objects.set_value(
+            user=self.user,
+            project=None,
+            key='language',
+            value=self.cleaned_data['language'],
+        )
+
         return self.user
