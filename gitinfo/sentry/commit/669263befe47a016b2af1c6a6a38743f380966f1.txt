commit 669263befe47a016b2af1c6a6a38743f380966f1
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Feb 3 15:14:34 2015 -0800

    Correct project based endpoints

diff --git a/src/sentry/api/endpoints/project_releases.py b/src/sentry/api/endpoints/project_releases.py
index e7d5fd9628..f5726ba386 100644
--- a/src/sentry/api/endpoints/project_releases.py
+++ b/src/sentry/api/endpoints/project_releases.py
@@ -9,7 +9,7 @@ from sentry.models import Project, Release
 class ProjectReleasesEndpoint(Endpoint):
     doc_section = DocSection.RELEASES
 
-    def get(self, request, project_id):
+    def get(self, request, organization_slug, project_slug):
         """
         List a project's releases
 
@@ -19,7 +19,8 @@ class ProjectReleasesEndpoint(Endpoint):
 
         """
         project = Project.objects.get(
-            id=project_id,
+            organization__slug=organization_slug,
+            slug=project_slug,
         )
 
         assert_perm(project, request.user, request.auth)
diff --git a/src/sentry/api/endpoints/project_stats.py b/src/sentry/api/endpoints/project_stats.py
index 68344ce687..5ec8c422e5 100644
--- a/src/sentry/api/endpoints/project_stats.py
+++ b/src/sentry/api/endpoints/project_stats.py
@@ -11,7 +11,7 @@ from sentry.models import Project
 class ProjectStatsEndpoint(BaseStatsEndpoint):
     doc_section = DocSection.PROJECTS
 
-    def get(self, request, project_id):
+    def get(self, request, organization_slug, project_slug):
         """
         Retrieve event counts for a project
 
@@ -33,8 +33,9 @@ class ProjectStatsEndpoint(BaseStatsEndpoint):
         **Note:** resolution should not be used unless you're familiar with Sentry
         internals as it's restricted to pre-defined values.
         """
-        project = Project.objects.get_from_cache(
-            id=project_id,
+        project = Project.objects.get(
+            organization__slug=organization_slug,
+            slug=project_slug,
         )
 
         assert_perm(project, request.user, request.auth)
diff --git a/src/sentry/api/endpoints/project_tagkey_details.py b/src/sentry/api/endpoints/project_tagkey_details.py
index 3913de4d16..bf9de15ba3 100644
--- a/src/sentry/api/endpoints/project_tagkey_details.py
+++ b/src/sentry/api/endpoints/project_tagkey_details.py
@@ -11,7 +11,7 @@ from sentry.tasks.deletion import delete_tag_key
 
 
 class ProjectTagKeyDetailsEndpoint(Endpoint):
-    def delete(self, request, project_id, key):
+    def delete(self, request, organization_slug, project_slug, key):
         """
         Remove all occurances of the given tag key.
 
@@ -19,7 +19,8 @@ class ProjectTagKeyDetailsEndpoint(Endpoint):
 
         """
         project = Project.objects.get(
-            id=project_id,
+            organization__slug=organization_slug,
+            slug=project_slug,
         )
 
         tagkey = TagKey.objects.get(
diff --git a/src/sentry/api/urls.py b/src/sentry/api/urls.py
index e63bac6821..2598d7b840 100644
--- a/src/sentry/api/urls.py
+++ b/src/sentry/api/urls.py
@@ -95,13 +95,13 @@ urlpatterns = patterns(
     url(r'^projects/(?P<organization_slug>[^/]+)/(?P<project_slug>[^/]+)/members/$',
         ProjectMemberIndexEndpoint.as_view(),
         name='sentry-api-0-project-member-index'),
-    url(r'^projects/(?P<project_id>\d+)/releases/$',
+    url(r'^projects/(?P<organization_slug>[^/]+)/(?P<project_slug>[^/]+)/releases/$',
         ProjectReleasesEndpoint.as_view(),
         name='sentry-api-0-project-releases'),
-    url(r'^projects/(?P<project_id>\d+)/stats/$',
+    url(r'^projects/(?P<organization_slug>[^/]+)/(?P<project_slug>[^/]+)/stats/$',
         ProjectStatsEndpoint.as_view(),
         name='sentry-api-0-project-stats'),
-    url(r'^projects/(?P<project_id>\d+)/tags/(?P<key>[^/]+)/$',
+    url(r'^projects/(?P<organization_slug>[^/]+)/(?P<project_slug>[^/]+)/tags/(?P<key>[^/]+)/$',
         ProjectTagKeyDetailsEndpoint.as_view(),
         name='sentry-api-0-project-tagkey-details'),
 
diff --git a/tests/sentry/api/endpoints/test_project_details.py b/tests/sentry/api/endpoints/test_project_details.py
index c34e19ae00..4f04b556ff 100644
--- a/tests/sentry/api/endpoints/test_project_details.py
+++ b/tests/sentry/api/endpoints/test_project_details.py
@@ -12,7 +12,10 @@ class ProjectDetailsTest(APITestCase):
     def test_simple(self):
         project = self.project  # force creation
         self.login_as(user=self.user)
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
         response = self.client.get(url)
         assert response.status_code == 200
         assert response.data['id'] == str(project.id)
@@ -22,7 +25,10 @@ class ProjectUpdateTest(APITestCase):
     def test_simple(self):
         project = self.project  # force creation
         self.login_as(user=self.user)
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
         resp = self.client.put(url, data={
             'name': 'hello world',
             'slug': 'foobar',
@@ -40,7 +46,10 @@ class ProjectDeleteTest(APITestCase):
 
         self.login_as(user=self.user)
 
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
 
         with self.settings(SENTRY_PROJECT=0):
             response = self.client.delete(url)
@@ -58,7 +67,10 @@ class ProjectDeleteTest(APITestCase):
 
         self.login_as(user=self.user)
 
-        url = reverse('sentry-api-0-project-details', kwargs={'project_id': project.id})
+        url = reverse('sentry-api-0-project-details', kwargs={
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
 
         with self.settings(SENTRY_PROJECT=project.id):
             response = self.client.delete(url)
diff --git a/tests/sentry/api/endpoints/test_project_group_index.py b/tests/sentry/api/endpoints/test_project_group_index.py
index 7008e63f68..0d89c25f86 100644
--- a/tests/sentry/api/endpoints/test_project_group_index.py
+++ b/tests/sentry/api/endpoints/test_project_group_index.py
@@ -10,12 +10,15 @@ from sentry.testutils.helpers import parse_link_header
 
 class GroupListTest(APITestCase):
     def test_simple(self):
+        project = self.project
         self.create_group(checksum='a' * 32)
         self.create_group(checksum='b' * 32)
 
         self.login_as(user=self.user)
         url = reverse('sentry-api-0-project-group-index', kwargs={
-            'project_id': self.project.id})
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
         response = self.client.get(url + '?limit=1', format='json')
         assert response.status_code == 200
         # links come in {url: {...attrs}}, but we need {rel: {...attrs}}
@@ -30,6 +33,7 @@ class GroupListTest(APITestCase):
 
 class GroupUpdateTest(APITestCase):
     def test_global_status_update(self):
+        project = self.project
         group1 = self.create_group(checksum='a' * 32, status=GroupStatus.RESOLVED)
         group2 = self.create_group(checksum='b' * 32, status=GroupStatus.UNRESOLVED)
         group3 = self.create_group(checksum='c' * 32, status=GroupStatus.MUTED)
@@ -39,7 +43,9 @@ class GroupUpdateTest(APITestCase):
 
         self.login_as(user=self.user)
         url = reverse('sentry-api-0-project-group-index', kwargs={
-            'project_id': self.project.id})
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
         response = self.client.put(url, data={
             'status': 'resolved',
         }, format='json')
@@ -62,6 +68,7 @@ class GroupUpdateTest(APITestCase):
         assert new_group4.resolved_at is None
 
     def test_selective_status_update(self):
+        project = self.project
         group1 = self.create_group(checksum='a' * 32, status=GroupStatus.RESOLVED)
         group2 = self.create_group(checksum='b' * 32, status=GroupStatus.UNRESOLVED)
         group3 = self.create_group(checksum='c' * 32, status=GroupStatus.MUTED)
@@ -72,7 +79,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': project.organization.slug,
+                'project_slug': project.slug
             }),
             group1=group1,
             group2=group2,
@@ -99,6 +107,7 @@ class GroupUpdateTest(APITestCase):
         assert new_group4.status == GroupStatus.UNRESOLVED
 
     def test_set_bookmarked(self):
+        project = self.project
         group1 = self.create_group(checksum='a' * 32, status=GroupStatus.RESOLVED)
         group2 = self.create_group(checksum='b' * 32, status=GroupStatus.UNRESOLVED)
         group3 = self.create_group(checksum='c' * 32, status=GroupStatus.MUTED)
@@ -109,7 +118,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': project.organization.slug,
+                'project_slug': project.slug
             }),
             group1=group1,
             group2=group2,
@@ -134,6 +144,7 @@ class GroupUpdateTest(APITestCase):
 
     @patch('sentry.api.endpoints.project_group_index.merge_group')
     def test_merge(self, merge_group):
+        project = self.project
         group1 = self.create_group(checksum='a' * 32, times_seen=1)
         group2 = self.create_group(checksum='b' * 32, times_seen=50)
         group3 = self.create_group(checksum='c' * 32, times_seen=2)
@@ -142,7 +153,8 @@ class GroupUpdateTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&id={group3.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': project.organization.slug,
+                'project_slug': project.slug
             }),
             group1=group1,
             group2=group2,
@@ -160,15 +172,19 @@ class GroupUpdateTest(APITestCase):
 
 class GroupDeleteTest(APITestCase):
     def test_global_is_forbidden(self):
+        project = self.project
         self.login_as(user=self.user)
         url = reverse('sentry-api-0-project-group-index', kwargs={
-            'project_id': self.project.id})
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug
+        })
         response = self.client.delete(url, data={
             'status': 'resolved',
         }, format='json')
         assert response.status_code == 400
 
     def test_delete_by_id(self):
+        project = self.project
         group1 = self.create_group(checksum='a' * 32, status=GroupStatus.RESOLVED)
         group2 = self.create_group(checksum='b' * 32, status=GroupStatus.UNRESOLVED)
         group3 = self.create_group(checksum='c' * 32, status=GroupStatus.MUTED)
@@ -179,7 +195,8 @@ class GroupDeleteTest(APITestCase):
         self.login_as(user=self.user)
         url = '{url}?id={group1.id}&id={group2.id}&group4={group4.id}'.format(
             url=reverse('sentry-api-0-project-group-index', kwargs={
-                'project_id': self.project.id
+                'organization_slug': project.organization.slug,
+                'project_slug': project.slug
             }),
             group1=group1,
             group2=group2,
diff --git a/tests/sentry/api/endpoints/test_project_member_index.py b/tests/sentry/api/endpoints/test_project_member_index.py
index e5824d4546..938e7e0831 100644
--- a/tests/sentry/api/endpoints/test_project_member_index.py
+++ b/tests/sentry/api/endpoints/test_project_member_index.py
@@ -20,7 +20,8 @@ class ProjectMemberIndexTest(APITestCase):
         self.login_as(user=user_1)
 
         url = reverse('sentry-api-0-project-member-index', kwargs={
-            'project_id': project_1.id,
+            'organization_slug': project_1.organization.slug,
+            'project_slug': project_1.slug,
         })
         response = self.client.get(url)
         assert response.status_code == 200
diff --git a/tests/sentry/api/endpoints/test_project_releases.py b/tests/sentry/api/endpoints/test_project_releases.py
index a96c924fcb..3344a6135a 100644
--- a/tests/sentry/api/endpoints/test_project_releases.py
+++ b/tests/sentry/api/endpoints/test_project_releases.py
@@ -31,7 +31,8 @@ class ProjectReleasesTest(APITestCase):
         )
 
         url = reverse('sentry-api-0-project-releases', kwargs={
-            'project_id': project1.id,
+            'organization_slug': project1.organization.slug,
+            'project_slug': project1.slug,
         })
         response = self.client.get(url, format='json')
 
diff --git a/tests/sentry/api/endpoints/test_project_stats.py b/tests/sentry/api/endpoints/test_project_stats.py
index 8acdd133e4..e5d23d1401 100644
--- a/tests/sentry/api/endpoints/test_project_stats.py
+++ b/tests/sentry/api/endpoints/test_project_stats.py
@@ -17,7 +17,8 @@ class ProjectStatsTest(APITestCase):
         tsdb.incr(tsdb.models.project, project2.id, count=5)
 
         url = reverse('sentry-api-0-project-stats', kwargs={
-            'project_id': project1.id,
+            'organization_slug': project1.organization.slug,
+            'project_slug': project1.slug,
         })
         response = self.client.get(url, format='json')
 
diff --git a/tests/sentry/api/endpoints/test_project_tagkey_details.py b/tests/sentry/api/endpoints/test_project_tagkey_details.py
index aecb36a296..e15c06dd07 100644
--- a/tests/sentry/api/endpoints/test_project_tagkey_details.py
+++ b/tests/sentry/api/endpoints/test_project_tagkey_details.py
@@ -17,7 +17,8 @@ class ProjectTagKeyDeleteTest(APITestCase):
         self.login_as(user=self.user)
 
         url = reverse('sentry-api-0-project-tagkey-details', kwargs={
-            'project_id': project.id,
+            'organization_slug': project.organization.slug,
+            'project_slug': project.slug,
             'key': tagkey.key,
         })
 
