commit 7426ead07590223b0ed09871fc2197dc14831e85
Author: Burak Yigit Kaya <byk@sentry.io>
Date:   Wed Feb 26 21:59:14 2020 +0300

    build(storybook): Don't deploy on foreign PRs (#17315)

diff --git a/.travis.yml b/.travis.yml
index de85577638..6e0b577692 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -240,18 +240,9 @@ matrix:
         # travis pyenv will attempt to use .python-version, but the appropriate python version won't be installed.
         # since we don't need python here, we have to remove this.
         - rm .python-version
-        # Decrypt the credentials we added to the repo using the key we added with the Travis command line tool
-        - openssl aes-256-cbc -K $encrypted_020be61ef175_key -iv $encrypted_020be61ef175_iv -in .travis/storybook-credentials.tar.gz.enc -out credentials.tar.gz -d
-        # If the SDK is not already cached, download it and unpack it
-        - if [ ! -d ${HOME}/google-cloud-sdk ]; then curl https://sdk.cloud.google.com | bash; fi
-        - tar -xzf credentials.tar.gz
-        # Use the decrypted service account credentials to authenticate the command line tool
-        - gcloud auth activate-service-account --key-file client-secret.json
-      install:
-        - ./bin/yarn install --frozen-lockfile
-        - gcloud version
-      script: bash .travis/deploy-storybook.sh
-      after_success: skip
+      install: ./bin/yarn install --frozen-lockfile
+      script: ./bin/yarn run storybook-build
+      after_success: .travis/deploy-storybook.sh
       after_failure: skip
 
   allow_failures:
diff --git a/.travis/deploy-storybook.sh b/.travis/deploy-storybook.sh
old mode 100644
new mode 100755
index aa59811ae7..888179b1cb
--- a/.travis/deploy-storybook.sh
+++ b/.travis/deploy-storybook.sh
@@ -1,6 +1,20 @@
 #!/bin/bash
 set -eu
 
+if [[ "$TRAVIS_SECURE_ENV_VARS" == "false" ]]; then
+  echo "Secrets are not available, skipping actual deploy."
+  exit;
+fi
+
+# Decrypt the credentials we added to the repo using the key we added with the Travis command line tool
+openssl aes-256-cbc -K $encrypted_020be61ef175_key -iv $encrypted_020be61ef175_iv -in .travis/storybook-credentials.tar.gz.enc -out credentials.tar.gz -d
+# If the SDK is not already cached, download it and unpack it
+if [ ! -d ${HOME}/google-cloud-sdk ]; then curl https://sdk.cloud.google.com | bash; fi
+echo "gcloud version: $(gcloud version)"
+# Use the decrypted service account credentials to authenticate the command line tool
+tar -xzf credentials.tar.gz
+gcloud auth activate-service-account --key-file client-secret.json
+
 GS_BUCKET_NAME=sentryio-storybook
 DEPLOY_BRANCH=${TRAVIS_PULL_REQUEST_BRANCH:-$TRAVIS_BRANCH}
 echo "Build branch: ${DEPLOY_BRANCH}"
@@ -10,8 +24,6 @@ BRANCH_PROCESSED=$(echo "${DEPLOY_BRANCH}" | tr '[:upper:]./' '[:lower:]--' | tr
 BUCKET_DIR_NAME="branches/${BRANCH_PROCESSED}"
 echo "Bucket directory: ${BUCKET_DIR_NAME}"
 
-./bin/yarn run storybook-build
-
 # Upload the files
 gsutil cp .storybook-out/favicon.ico "gs://${GS_BUCKET_NAME}/favicon.ico"
 gsutil -m rsync -r -d .storybook-out/ "gs://${GS_BUCKET_NAME}/${BUCKET_DIR_NAME}"
