commit a01a024b0442bd4d64b3c2327935988f294c75a8
Author: ted kaemming <ted@kaemming.com>
Date:   Thu Nov 16 10:20:10 2017 -0800

    fix(unmerge): Include custom values in fingerprint generation (#6566)

diff --git a/src/sentry/tasks/unmerge.py b/src/sentry/tasks/unmerge.py
index aa4ff932e1..5c8807a8dd 100644
--- a/src/sentry/tasks/unmerge.py
+++ b/src/sentry/tasks/unmerge.py
@@ -10,7 +10,7 @@ from sentry import tagstore
 from sentry.app import tsdb
 from sentry.constants import DEFAULT_LOGGER_NAME, LOG_LEVELS_MAP
 from sentry.event_manager import (
-    ScoreClause, generate_culprit, get_hashes_for_event, md5_from_hash
+    ScoreClause, generate_culprit, get_fingerprint_for_event, get_hashes_from_fingerprint, md5_from_hash
 )
 from sentry.models import (
     Activity, Environment, Event, EventMapping, EventUser, Group, GroupHash, GroupRelease,
@@ -142,7 +142,10 @@ def get_group_backfill_attributes(caches, group, events):
 
 def get_fingerprint(event):
     # TODO: This *might* need to be protected from an IndexError?
-    primary_hash = get_hashes_for_event(event)[0]
+    primary_hash = get_hashes_from_fingerprint(
+        event,
+        get_fingerprint_for_event(event),
+    )[0]
     return md5_from_hash(primary_hash)
 
 
diff --git a/tests/sentry/tasks/test_unmerge.py b/tests/sentry/tasks/test_unmerge.py
index aa960c6b6b..9394ce23ae 100644
--- a/tests/sentry/tasks/test_unmerge.py
+++ b/tests/sentry/tasks/test_unmerge.py
@@ -1,6 +1,7 @@
 from __future__ import absolute_import
 
 import functools
+import hashlib
 import itertools
 import logging
 import uuid
@@ -33,6 +34,29 @@ from six.moves import xrange
 index = _make_index_backend(redis.clusters.get('default').get_local_client(0))
 
 
+def test_get_fingerprint():
+    assert get_fingerprint(
+        Event(
+            data={
+                'sentry.interfaces.Message': {
+                    'message': 'Hello world',
+                },
+            },
+        )
+    ) == hashlib.md5('Hello world').hexdigest()
+
+    assert get_fingerprint(
+        Event(
+            data={
+                'fingerprint': ['Not hello world'],
+                'sentry.interfaces.Message': {
+                    'message': 'Hello world',
+                },
+            },
+        )
+    ) == hashlib.md5('Not hello world').hexdigest()
+
+
 @patch('sentry.similarity.features.index', new=index)
 class UnmergeTestCase(TestCase):
     def test_get_group_creation_attributes(self):
