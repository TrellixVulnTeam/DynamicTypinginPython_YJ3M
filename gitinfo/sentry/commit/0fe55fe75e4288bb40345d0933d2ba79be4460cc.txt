commit 0fe55fe75e4288bb40345d0933d2ba79be4460cc
Author: Dan Fuller <dfuller@sentry.io>
Date:   Fri Feb 14 17:54:20 2020 -0800

    fix(subscriptions): More things to fix apm on the `QuerySubscriptionConsumer`
    
    We can't set data on a transaction. A span with transaction info becomes a transation, so moving
    things around.

diff --git a/src/sentry/snuba/query_subscription_consumer.py b/src/sentry/snuba/query_subscription_consumer.py
index ed96f1f3c8..2178aa013a 100644
--- a/src/sentry/snuba/query_subscription_consumer.py
+++ b/src/sentry/snuba/query_subscription_consumer.py
@@ -93,7 +93,14 @@ class QuerySubscriptionConsumer(object):
 
                 i = i + 1
 
-                self.handle_message(message)
+                with sentry_sdk.start_span(
+                    Span(
+                        op="handle_message",
+                        transaction="query_subscription_consumer_process_message",
+                        sampled=True,
+                    )
+                ):
+                    self.handle_message(message)
 
                 # Track latest completed message here, for use in `shutdown` handler.
                 self.offsets[message.partition()] = message.offset() + 1
@@ -186,13 +193,7 @@ class QuerySubscriptionConsumer(object):
             )
 
             callback = subscriber_registry[subscription.type]
-            with sentry_sdk.start_span(
-                Span(
-                    op="process_message",
-                    transaction="query_subscription_consumer_process_message",
-                    sampled=True,
-                )
-            ) as span, metrics.timer(
+            with sentry_sdk.start_span(op="process_message") as span, metrics.timer(
                 "snuba_query_subscriber.callback.duration", instance=subscription.type
             ):
                 span.set_data("payload", contents)
