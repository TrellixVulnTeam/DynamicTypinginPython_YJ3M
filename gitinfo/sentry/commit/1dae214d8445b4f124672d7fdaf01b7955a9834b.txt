commit 1dae214d8445b4f124672d7fdaf01b7955a9834b
Author: David Cramer <dcramer@gmail.com>
Date:   Fri Jul 29 22:53:51 2016 -0400

    Dont use TagValue (unindexed)

diff --git a/src/sentry/south_migrations/0268_fill_environment.py b/src/sentry/south_migrations/0268_fill_environment.py
index d605f35fb5..a36815575f 100644
--- a/src/sentry/south_migrations/0268_fill_environment.py
+++ b/src/sentry/south_migrations/0268_fill_environment.py
@@ -15,19 +15,6 @@ class Migration(DataMigration):
         Environment = orm['sentry.Environment']
         ReleaseEnvironment = orm['sentry.ReleaseEnvironment']
         GroupRelease = orm['sentry.GroupRelease']
-        TagValue = orm['sentry.TagValue']
-
-        queryset = TagValue.objects.filter(
-            key='environment',
-        )
-
-        environments = {}
-        for tag in RangeQuerySetWrapperWithProgressBar(queryset):
-            env, _ = Environment.objects.get_or_create(
-                project_id=tag.project_id,
-                name=tag.value,
-            )
-            environments[(tag.project_id, tag.value)] = env.id
 
         queryset = GroupRelease.objects.filter(
             # limit the scope of data, even though that means we might not
@@ -35,6 +22,14 @@ class Migration(DataMigration):
             last_seen__gte=timezone.now() - timedelta(days=1),
         )
 
+        environments = {}
+        for gr in RangeQuerySetWrapperWithProgressBar(queryset):
+            env, _ = Environment.objects.get_or_create(
+                project_id=gr.project_id,
+                name=gr.environment,
+            )
+            environments[(env.project_id, env.name)] = env.id
+
         for gr in RangeQuerySetWrapperWithProgressBar(queryset):
             env_id = environments.get((gr.project_id, gr.environment))
             if not env_id:
