commit 2df364e960e1a56b59d339396c4f12b702c5ffa1
Author: Mark Story <mark@mark-story.com>
Date:   Thu Apr 18 15:31:09 2019 -0400

    ref(ui) Consolidate dropdown menu styling (#12814)
    
    Make the 3 dropdowns that are visually similar on issue/event search
    share code.
    
    I've also made the buttons/search input 2px taller. This allows us to
    remove a bunch of custom CSS and use standard size buttons.
    
    Fixes SEN-484

diff --git a/docs-ui/components/dropdownControl.stories.js b/docs-ui/components/dropdownControl.stories.js
new file mode 100644
index 0000000000..a66c4aa818
--- /dev/null
+++ b/docs-ui/components/dropdownControl.stories.js
@@ -0,0 +1,57 @@
+import React from 'react';
+import {storiesOf} from '@storybook/react';
+import {withInfo} from '@storybook/addon-info';
+import {text, boolean} from '@storybook/addon-knobs';
+
+import DropdownControl from 'app/components/dropdownControl';
+import MenuItem from 'app/components/menuItem';
+
+storiesOf('UI|Dropdowns/DropdownControl', module)
+  .add(
+    'basic label + knobs',
+    withInfo('Using a string value for the button label')(() => {
+      const menuWidth = text('menuWidth', undefined);
+      const menuOffset = text('menuOffset', undefined);
+      const alwaysRenderMenu = boolean('alwaysRenderMenu', true);
+
+      return (
+        <div className="clearfix">
+          <DropdownControl
+            label="Open Me"
+            menuWidth={menuWidth}
+            menuOffset={menuOffset}
+            alwaysRenderMenu={alwaysRenderMenu}
+          >
+            <MenuItem href="">Item</MenuItem>
+            <MenuItem href="">Item</MenuItem>
+          </DropdownControl>
+        </div>
+      );
+    })
+  )
+  .add(
+    'element label',
+    withInfo('Element labels replace the button contents')(() => (
+      <div className="clearfix">
+        <DropdownControl label={<em>Slanty</em>}>
+          <MenuItem href="">Item</MenuItem>
+          <MenuItem href="">Item</MenuItem>
+        </DropdownControl>
+      </div>
+    ))
+  )
+  .add(
+    'custom button',
+    withInfo('button prop lets you replace the entire button.')(() => (
+      <div className="clearfix">
+        <DropdownControl
+          button={({isOpen, getActorProps}) => (
+            <button {...getActorProps()}>click me</button>
+          )}
+        >
+          <MenuItem href="">Item</MenuItem>
+          <MenuItem href="">Item</MenuItem>
+        </DropdownControl>
+      </div>
+    ))
+  );
diff --git a/src/sentry/static/sentry/app/components/dropdownButton.jsx b/src/sentry/static/sentry/app/components/dropdownButton.jsx
index 7dd52edfd4..d7fc0f2bae 100644
--- a/src/sentry/static/sentry/app/components/dropdownButton.jsx
+++ b/src/sentry/static/sentry/app/components/dropdownButton.jsx
@@ -37,7 +37,9 @@ const StyledButton = styled(
   position: relative;
   z-index: 2;
   box-shadow: ${p => (p.isOpen || p.disabled ? 'none' : p.theme.dropShadowLight)};
+  border-bottom-color: ${p => (p.isOpen ? 'transparent' : p.theme.borderDark)};
 
+  &:active,
   &:focus,
   &:hover {
     border-bottom-color: ${p => (p.isOpen ? 'transparent' : p.theme.borderDark)};
diff --git a/src/sentry/static/sentry/app/components/dropdownControl.jsx b/src/sentry/static/sentry/app/components/dropdownControl.jsx
new file mode 100644
index 0000000000..e0ba710fda
--- /dev/null
+++ b/src/sentry/static/sentry/app/components/dropdownControl.jsx
@@ -0,0 +1,108 @@
+import PropTypes from 'prop-types';
+import React from 'react';
+
+import styled from 'react-emotion';
+import DropdownButton from 'app/components/dropdownButton';
+import DropdownMenu from 'app/components/dropdownMenu';
+import space from 'app/styles/space';
+
+/*
+ * A higher level dropdown component that helps with building complete dropdowns
+ * including the button + menu options. Use the `button` or `label` prop to set
+ * the button content and `children` to provide menu options.
+ */
+class DropdownControl extends React.Component {
+  static propTypes = {
+    // String or element for the button contents.
+    label: PropTypes.oneOfType([PropTypes.string, PropTypes.element]),
+    // A closure that returns a styled button. Function will get {isOpen, getActorProps}
+    // as arguments. Use this if you need to style/replace the dropdown button.
+    button: PropTypes.func,
+    // Width of the menu. Defaults to 100% of the button width.
+    menuWidth: PropTypes.string,
+    // Height offset for the menu. Defaults to 39px as standard buttons are
+    // 40px tall
+    menuOffset: PropTypes.string,
+    // Should the menu contents always be rendered?  Defaults to true.
+    // Set to false to have menu contents removed from the DOM on close.
+    alwaysRenderMenu: PropTypes.bool,
+  };
+
+  static defaultProps = {
+    menuOffset: '39px',
+    alwaysRenderMenu: true,
+    menuWidth: '100%',
+  };
+
+  renderButton(isOpen, getActorProps) {
+    const {label, button} = this.props;
+    if (button) {
+      return button({isOpen, getActorProps});
+    }
+    return (
+      <StyledDropdownButton {...getActorProps({isStyled: true})} isOpen={isOpen}>
+        {label}
+      </StyledDropdownButton>
+    );
+  }
+
+  render() {
+    const {children, alwaysRenderMenu, menuOffset, menuWidth} = this.props;
+
+    return (
+      <Container>
+        <DropdownMenu alwaysRenderMenu={alwaysRenderMenu}>
+          {({isOpen, getMenuProps, getActorProps}) => {
+            return (
+              <React.Fragment>
+                {this.renderButton(isOpen, getActorProps)}
+                <MenuContainer
+                  {...getMenuProps({isStyled: true})}
+                  menuWidth={menuWidth}
+                  menuOffset={menuOffset}
+                  isOpen={isOpen}
+                >
+                  {children}
+                </MenuContainer>
+              </React.Fragment>
+            );
+          }}
+        </DropdownMenu>
+      </Container>
+    );
+  }
+}
+
+const Container = styled.div`
+  display: inline-block;
+  position: relative;
+`;
+
+const StyledDropdownButton = styled(
+  React.forwardRef((prop, ref) => <DropdownButton innerRef={ref} {...prop} />)
+)`
+  z-index: ${p => p.theme.zIndex.dropdownAutocomplete.actor};
+  white-space: nowrap;
+  font-weight: normal;
+`;
+
+const MenuContainer = styled.ul`
+  list-style: none;
+  width: ${p => p.menuWidth};
+
+  position: absolute;
+  top: ${p => p.menuOffset};
+  padding: 0 0 ${space(0.5)} 0;
+  margin: 0;
+  z-index: ${p => p.theme.zIndex.dropdownAutocomplete.menu};
+
+  background: ${p => p.theme.background};
+  border-radius: 0 0 ${p => p.theme.borderRadius} ${p => p.theme.borderRadius};
+  box-shadow: 0 1px 3px rgba(70, 82, 98, 0.25);
+  border: 1px solid ${p => p.theme.borderDark};
+  background-clip: padding-box;
+
+  display: ${p => (p.isOpen ? 'block' : 'none')};
+`;
+
+export default DropdownControl;
diff --git a/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx b/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx
index d6f5257e37..deda438e37 100644
--- a/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx
+++ b/src/sentry/static/sentry/app/components/smartSearchBar/index.jsx
@@ -816,8 +816,8 @@ const buttonBarWidth = 18 * 3 + 3 * 3;
 
 const ButtonBar = styled.div`
   position: absolute;
-  top: 10px;
-  right: ${space(1)};
+  top: ${space(1.5)};
+  right: ${space(1.5)};
   display: flex;
   justify-content: space-between;
   width: ${buttonBarWidth}px;
@@ -841,7 +841,8 @@ const StyledInput = styled.input`
   color: ${p => p.theme.foreground};
 
   font-size: ${p => p.theme.fontSizeMedium};
-  height: 38px;
+  /* match the height of buttons */
+  height: 40px;
   width: 100%;
 
   /* pad the right side of the input to accomodate the button bar */
diff --git a/src/sentry/static/sentry/app/views/stream/organizationSavedSearchSelector.jsx b/src/sentry/static/sentry/app/views/stream/organizationSavedSearchSelector.jsx
index 60dab1c7f9..92db24d2f6 100644
--- a/src/sentry/static/sentry/app/views/stream/organizationSavedSearchSelector.jsx
+++ b/src/sentry/static/sentry/app/views/stream/organizationSavedSearchSelector.jsx
@@ -7,7 +7,7 @@ import Access from 'app/components/acl/access';
 import Button from 'app/components/button';
 import Confirm from 'app/components/confirm';
 import DropdownButton from 'app/components/dropdownButton';
-import DropdownMenu from 'app/components/dropdownMenu';
+import DropdownControl from 'app/components/dropdownControl';
 import SentryTypes from 'app/sentryTypes';
 import space from 'app/styles/space';
 import overflowEllipsis from 'app/styles/overflowEllipsis';
@@ -80,23 +80,16 @@ export default class OrganizationSavedSearchSelector extends React.Component {
   render() {
     return (
       <Container>
-        <DropdownMenu alwaysRenderMenu={true}>
-          {({isOpen, getMenuProps, getActorProps}) => {
-            return (
-              <React.Fragment>
-                <StyledDropdownButton
-                  {...getActorProps({isStyled: true})}
-                  isOpen={isOpen}
-                >
-                  <ButtonTitle>{this.getTitle()}</ButtonTitle>
-                </StyledDropdownButton>
-                <MenuContainer {...getMenuProps({isStyled: true})} isOpen={isOpen}>
-                  {this.renderList()}
-                </MenuContainer>
-              </React.Fragment>
-            );
-          }}
-        </DropdownMenu>
+        <DropdownControl
+          menuWidth="375px"
+          button={({isOpen, getActorProps}) => (
+            <StyledDropdownButton {...getActorProps({isStyled: true})} isOpen={isOpen}>
+              <ButtonTitle>{this.getTitle()}</ButtonTitle>
+            </StyledDropdownButton>
+          )}
+        >
+          {this.renderList()}
+        </DropdownControl>
       </Container>
     );
   }
@@ -121,11 +114,6 @@ const StyledDropdownButton = styled(DropdownButton)`
   &:active {
     border-right: 0;
   }
-
-  /* Hack but search input, and sort dropdown are not standard size buttons */
-  & > span {
-    padding: 11px 16px;
-  }
 `;
 
 const ButtonTitle = styled.span`
@@ -182,26 +170,6 @@ const MenuItem = styled.li`
   }
 `;
 
-const MenuContainer = styled.ul`
-  list-style: none;
-  width: 375px;
-
-  position: absolute;
-  /* Buttons are 38px tall, this has to be -1 to get button overlapping the menu */
-  top: 37px;
-  padding: 0;
-  margin: 0;
-  z-index: ${p => p.theme.zIndex.dropdownAutocomplete.menu};
-
-  background: ${p => p.theme.background};
-  border-radius: 0 0 ${p => p.theme.borderRadius} ${p => p.theme.borderRadius};
-  box-shadow: 0 1px 3px rgba(70, 82, 98, 0.25);
-  border: 1px solid ${p => p.theme.borderDark};
-  background-clip: padding-box;
-
-  display: ${p => (p.isOpen ? 'block' : 'none')};
-`;
-
 const EmptyItem = styled.li`
   padding: 8px 10px 5px;
   font-style: italic;
diff --git a/src/sentry/static/sentry/app/views/stream/sortOptions.jsx b/src/sentry/static/sentry/app/views/stream/sortOptions.jsx
index dbb34809f2..2020654007 100644
--- a/src/sentry/static/sentry/app/views/stream/sortOptions.jsx
+++ b/src/sentry/static/sentry/app/views/stream/sortOptions.jsx
@@ -1,8 +1,7 @@
 import PropTypes from 'prop-types';
 import React from 'react';
 import styled from 'react-emotion';
-import DropdownButton from 'app/components/dropdownButton';
-import DropdownMenu from 'app/components/dropdownMenu';
+import DropdownControl from 'app/components/dropdownControl';
 import MenuItem from 'app/components/menuItem';
 import {t} from 'app/locale';
 import space from 'app/styles/space';
@@ -62,54 +61,31 @@ class SortOptions extends React.PureComponent {
   render() {
     return (
       <Container>
-        <DropdownMenu>
-          {({isOpen, getMenuProps, getActorProps}) => {
-            return (
-              <React.Fragment>
-                <StyledDropdownButton
-                  {...getActorProps({isStyled: true})}
-                  isOpen={isOpen}
-                >
-                  <em>{t('Sort by')}: &nbsp; </em>
-                  {this.getSortLabel(this.state.sortKey)}
-                </StyledDropdownButton>
-                <MenuContainer {...getMenuProps({isStyled: true})} isOpen={isOpen}>
-                  {this.getMenuItem('priority')}
-                  {this.getMenuItem('date')}
-                  {this.getMenuItem('new')}
-                  {this.getMenuItem('freq')}
-                </MenuContainer>
-              </React.Fragment>
-            );
-          }}
-        </DropdownMenu>
+        <DropdownControl
+          label={
+            <React.Fragment>
+              <LabelText>{t('Sort by')}: &nbsp; </LabelText>
+              {this.getSortLabel(this.state.sortKey)}
+            </React.Fragment>
+          }
+        >
+          {this.getMenuItem('priority')}
+          {this.getMenuItem('date')}
+          {this.getMenuItem('new')}
+          {this.getMenuItem('freq')}
+        </DropdownControl>
       </Container>
     );
   }
 }
 
 const Container = styled.div`
-  position: relative;
   margin-right: ${space(0.5)};
 `;
 
-const StyledDropdownButton = styled(
-  React.forwardRef((prop, ref) => <DropdownButton innerRef={ref} {...prop} />)
-)`
-  z-index: ${p => p.theme.zIndex.dropdownAutocomplete.actor};
-  white-space: nowrap;
-  font-weight: normal;
-
-  /* Hack but search input, and sort dropdown are not standard size buttons yet */
-  height: 38px;
-  & > span {
-    padding: 11px 16px;
-    font-size: ${p => p.theme.fontSizeMedium};
-  }
-  & em {
-    font-style: normal;
-    color: ${p => p.theme.gray2};
-  }
+const LabelText = styled.em`
+  font-style: normal;
+  color: ${p => p.theme.gray2};
 `;
 
 const StyledMenuItem = styled(MenuItem)`
@@ -129,24 +105,4 @@ const StyledMenuItem = styled(MenuItem)`
   }
 `;
 
-const MenuContainer = styled.ul`
-  list-style: none;
-  width: 100%;
-
-  position: absolute;
-  /* Buttons are 38px tall, this has to be -1 to get button overlapping the menu */
-  top: 37px;
-  padding: 0 0 ${space(0.5)} 0;
-  margin: 0;
-  z-index: ${p => p.theme.zIndex.dropdownAutocomplete.menu};
-
-  background: ${p => p.theme.background};
-  border-radius: 0 0 ${p => p.theme.borderRadius} ${p => p.theme.borderRadius};
-  box-shadow: 0 1px 3px rgba(70, 82, 98, 0.25);
-  border: 1px solid ${p => p.theme.borderDark};
-  background-clip: padding-box;
-
-  display: ${p => (p.isOpen ? 'block' : 'none')};
-`;
-
 export default SortOptions;
diff --git a/src/sentry/static/sentry/less/shared-components.less b/src/sentry/static/sentry/less/shared-components.less
index 6ee003c155..67ca9b5905 100644
--- a/src/sentry/static/sentry/less/shared-components.less
+++ b/src/sentry/static/sentry/less/shared-components.less
@@ -746,6 +746,8 @@ table.table.key-value {
   }
 
   .search-input {
+    // Match the height of buttons adjacent to the search input.
+    height: 40px;
     padding: 8px 24px 8px 37px;
     font-size: 14px;
     background: #fff;
diff --git a/src/sentry/static/sentry/less/stream.less b/src/sentry/static/sentry/less/stream.less
index 2d6ba65dff..0f55c36805 100644
--- a/src/sentry/static/sentry/less/stream.less
+++ b/src/sentry/static/sentry/less/stream.less
@@ -933,7 +933,7 @@
   .toggle-stream-sidebar {
     width: 50px;
     margin-left: 5px;
-    height: 38px;
+    height: 40px;
     text-align: center;
     padding: 8px;
 
diff --git a/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap b/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap
index 199a47d465..bcaa7e7c90 100644
--- a/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/organizationTeamProjects.spec.jsx.snap
@@ -178,19 +178,19 @@ exports[`OrganizationTeamProjects Should render 1`] = `
                                             size="xsmall"
                                           >
                                             <ForwardRef
-                                              className="css-qfyoa0-StyledButton e1yghndz1"
+                                              className="css-a2adl3-StyledButton e1yghndz1"
                                               isOpen={false}
                                               size="xsmall"
                                             >
                                               <Button
-                                                className="css-qfyoa0-StyledButton e1yghndz1"
+                                                className="css-a2adl3-StyledButton e1yghndz1"
                                                 disabled={false}
                                                 innerRef={null}
                                                 size="xsmall"
                                               >
                                                 <StyledButton
                                                   aria-disabled={false}
-                                                  className="css-qfyoa0-StyledButton e1yghndz1"
+                                                  className="css-a2adl3-StyledButton e1yghndz1"
                                                   disabled={false}
                                                   innerRef={null}
                                                   onClick={[Function]}
@@ -199,7 +199,7 @@ exports[`OrganizationTeamProjects Should render 1`] = `
                                                 >
                                                   <ForwardRef
                                                     aria-disabled={false}
-                                                    className="e1yghndz1 css-1momm09-StyledButton-getColors-StyledButton e12ma6z0"
+                                                    className="e1yghndz1 css-kt13z7-StyledButton-getColors-StyledButton e12ma6z0"
                                                     disabled={false}
                                                     onClick={[Function]}
                                                     role="button"
@@ -207,7 +207,7 @@ exports[`OrganizationTeamProjects Should render 1`] = `
                                                   >
                                                     <button
                                                       aria-disabled={false}
-                                                      className="e1yghndz1 css-1momm09-StyledButton-getColors-StyledButton e12ma6z0"
+                                                      className="e1yghndz1 css-kt13z7-StyledButton-getColors-StyledButton e12ma6z0"
                                                       onClick={[Function]}
                                                       role="button"
                                                       size="xsmall"
diff --git a/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap b/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap
index 3ae2670d37..97224a13cf 100644
--- a/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap
+++ b/tests/js/spec/views/inviteMember/__snapshots__/inviteMember.spec.jsx.snap
@@ -511,14 +511,14 @@ exports[`InviteMember should render roles when available and allowed, and handle
                                               >
                                                 <ForwardRef
                                                   aria-label="Add Team"
-                                                  className="css-t6oz6z-StyledButton e1yghndz1"
+                                                  className="css-13vimgs-StyledButton e1yghndz1"
                                                   disabled={true}
                                                   isOpen={false}
                                                   size="xsmall"
                                                 >
                                                   <Button
                                                     aria-label="Add Team"
-                                                    className="css-t6oz6z-StyledButton e1yghndz1"
+                                                    className="css-13vimgs-StyledButton e1yghndz1"
                                                     disabled={true}
                                                     innerRef={null}
                                                     size="xsmall"
@@ -526,7 +526,7 @@ exports[`InviteMember should render roles when available and allowed, and handle
                                                     <StyledButton
                                                       aria-disabled={true}
                                                       aria-label="Add Team"
-                                                      className="css-t6oz6z-StyledButton e1yghndz1"
+                                                      className="css-13vimgs-StyledButton e1yghndz1"
                                                       disabled={true}
                                                       href={null}
                                                       innerRef={null}
@@ -538,7 +538,7 @@ exports[`InviteMember should render roles when available and allowed, and handle
                                                       <ForwardRef
                                                         aria-disabled={true}
                                                         aria-label="Add Team"
-                                                        className="e1yghndz1 css-a1a4aj-StyledButton-getColors-StyledButton e12ma6z0"
+                                                        className="e1yghndz1 css-ovd92h-StyledButton-getColors-StyledButton e12ma6z0"
                                                         disabled={true}
                                                         href={null}
                                                         onClick={[Function]}
@@ -549,7 +549,7 @@ exports[`InviteMember should render roles when available and allowed, and handle
                                                         <button
                                                           aria-disabled={true}
                                                           aria-label="Add Team"
-                                                          className="e1yghndz1 css-a1a4aj-StyledButton-getColors-StyledButton e12ma6z0"
+                                                          className="e1yghndz1 css-ovd92h-StyledButton-getColors-StyledButton e12ma6z0"
                                                           href={null}
                                                           onClick={[Function]}
                                                           role="button"
diff --git a/tests/js/spec/views/organizationStream/overview.spec.jsx b/tests/js/spec/views/organizationStream/overview.spec.jsx
index c457a07cef..1df28a7af8 100644
--- a/tests/js/spec/views/organizationStream/overview.spec.jsx
+++ b/tests/js/spec/views/organizationStream/overview.spec.jsx
@@ -138,7 +138,7 @@ describe('OrganizationStream', function() {
 
     const getSearchBarValue = w =>
       w
-        .find('SmartSearchBarContainer input')
+        .find('SmartSearchBarContainer StyledInput')
         .prop('value')
         .trim();
 
