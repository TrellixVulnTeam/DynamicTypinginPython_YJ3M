commit 4486b70326fff96ab5148bb230c4287aa125e8a9
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Tue Feb 5 11:35:01 2019 +0100

    ref: Kill funcy (#11871)

diff --git a/requirements-base.txt b/requirements-base.txt
index 169a62bc83..89342e8ca8 100644
--- a/requirements-base.txt
+++ b/requirements-base.txt
@@ -18,7 +18,6 @@ email-reply-parser>=0.2.0,<0.3.0
 enum34>=1.1.6,<1.2.0
 exam>=0.5.1
 functools32>=3.2.3,<3.3
-funcy>=1.1<=1.2
 futures>=3.2.0,<4.0.0
 # broken on python3
 hiredis>=0.1.0,<0.2.0
diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index d11218633b..5ef6c59a6a 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -5,8 +5,6 @@ import six
 
 from collections import namedtuple
 from django.utils.functional import cached_property
-from funcy.seqs import flatten
-from funcy.types import is_list
 
 from parsimonious.exceptions import ParseError
 from parsimonious.grammar import Grammar, NodeVisitor
@@ -164,8 +162,19 @@ class SearchVisitor(NodeVisitor):
     def visit_search(self, node, children):
         # there is a list from search_term and one from raw_search, so flatten them.
         # Flatten each group in the list, since nodes can return multiple items
-        children = [child for group in children for child in flatten(group, follow=is_list)]
-        return filter(None, children)
+        #
+        # XXX(mitsuhiko): I do not comprehend why this is not just
+        # _flatten(children) but when I do that nothing works.  I only
+        # inherited this code.
+        def _flatten(seq):
+            for item in seq:
+                if isinstance(item, list):
+                    for sub in _flatten(item):
+                        yield sub
+                else:
+                    yield item
+        children = [child for group in children for child in _flatten(group)]
+        return filter(None, _flatten(children))
 
     def visit_search_term(self, node, children):
         _, search_term, _ = children
