commit 67e589802bb80ea6f0f5a61c94fe1404f22e87b8
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Aug 31 12:40:38 2015 -0700

    Add basic markdown support to comments (fixes GH-1793)

diff --git a/package.json b/package.json
index f374a779ab..a974831598 100644
--- a/package.json
+++ b/package.json
@@ -21,6 +21,7 @@
     "jquery": "^2.1.3",
     "json-loader": "^0.5.2",
     "less": "1.7.0",
+    "markdown": "^0.5.0",
     "moment": "^2.10.5",
     "moment-timezone": "^0.4.0",
     "node-libs-browser": "^0.5.2",
diff --git a/src/sentry/static/sentry/app/views/groupActivity/index.jsx b/src/sentry/static/sentry/app/views/groupActivity/index.jsx
index a8b8c8371d..ece26ef187 100644
--- a/src/sentry/static/sentry/app/views/groupActivity/index.jsx
+++ b/src/sentry/static/sentry/app/views/groupActivity/index.jsx
@@ -1,9 +1,9 @@
+import {markdown} from "markdown";
 import React from "react";
 import Gravatar from "../../components/gravatar";
 import GroupState from "../../mixins/groupState";
 import MemberListStore from "../../stores/memberListStore";
 import TimeSince from "../../components/timeSince";
-import utils from "../../utils";
 
 import NoteInput from "./noteInput";
 
@@ -68,14 +68,14 @@ var GroupActivity = React.createClass({
       var label = formatActivity(item);
 
       if (item.type === 'note') {
-        var noteBody = utils.nl2br(utils.urlize(utils.escape(item.data.text)));
+        var noteBody = markdown.toHTML(item.data.text);
         return (
           <li className="activity-note" key={itemIdx}>
             {avatar}
             <div className="activity-bubble">
               <TimeSince date={item.dateCreated} />
               <div className="activity-author">{authorName}</div>
-              <p dangerouslySetInnerHTML={{__html: noteBody}} />
+              <div dangerouslySetInnerHTML={{__html: noteBody}} />
             </div>
           </li>
         );
diff --git a/src/sentry/static/sentry/app/views/groupActivity/noteInput.jsx b/src/sentry/static/sentry/app/views/groupActivity/noteInput.jsx
index beef0da63a..829112d907 100644
--- a/src/sentry/static/sentry/app/views/groupActivity/noteInput.jsx
+++ b/src/sentry/static/sentry/app/views/groupActivity/noteInput.jsx
@@ -1,3 +1,4 @@
+import {markdown} from "markdown";
 import React from "react";
 import api from "../../api";
 import GroupStore from "../../stores/groupStore";
@@ -12,10 +13,19 @@ var NoteInput = React.createClass({
       loading: false,
       error: false,
       expanded: false,
+      preview: false,
       value: ''
     };
   },
 
+  toggleEdit() {
+    this.setState({preview: false});
+  },
+
+  togglePreview() {
+    this.setState({preview: true});
+  },
+
   onSubmit(e) {
     e.preventDefault();
 
@@ -40,6 +50,7 @@ var NoteInput = React.createClass({
       success: (data) => {
         this.setState({
           value: '',
+          preview: false,
           expanded: false,
           loading: false
         });
@@ -80,10 +91,23 @@ var NoteInput = React.createClass({
     return (
       <form className={classNames} onSubmit={this.onSubmit}>
         <div className="activity-notes">
-          <textarea placeholder="Add details or updates to this event"
-                    onChange={this.onChange}
-                    onFocus={this.expand} onBlur={this.maybeCollapse}
-                    value={this.state.value} />
+          <ul className="nav nav-tabs">
+            <li className={!this.state.preview ? "active" : ""}>
+              <a onClick={this.toggleEdit}>Edit</a>
+            </li>
+            <li className={this.state.preview ? "active" : ""}>
+              <a onClick={this.togglePreview}>Preview</a>
+            </li>
+          </ul>
+          {this.state.preview ?
+            <div className="note-preview"
+                 dangerouslySetInnerHTML={{__html: markdown.toHTML(this.state.value)}} />
+          :
+            <textarea placeholder="Add details or updates to this event"
+                      onChange={this.onChange}
+                      onFocus={this.expand} onBlur={this.maybeCollapse}
+                      value={this.state.value} />
+          }
           <div className="activity-actions">
             <button className="btn btn-default" type="submit"
                     disabled={this.state.loading}>Leave comment</button>
diff --git a/src/sentry/static/sentry/less/group-detail.less b/src/sentry/static/sentry/less/group-detail.less
index a15f3e9f92..d906ace1c9 100644
--- a/src/sentry/static/sentry/less/group-detail.less
+++ b/src/sentry/static/sentry/less/group-detail.less
@@ -349,23 +349,34 @@
   position: relative;
   margin-bottom: 0;
 
+  .activity-notes {
+    .nav {
+      padding: 5px 15px 0;
+      margin: 0 -10px 0 0;
+      border-bottom: 1px solid @trim;
+      > li a {
+        padding-bottom: 5px;
+      }
+    }
+  }
+
   .activity-field {
     .form-control();
-    padding: 0 10px 0 0;
+    padding: 0 10px 35px 0;
     margin: 0 0 15px;
     .transition(padding .2s ease-in-out);
 
-    textarea {
+    textarea, .note-preview {
       display: block;
       width: 100%;
-      max-height: 38px;
+      min-height: 38px;
+      max-height: 1000px;
       max-width: 100%;
       margin: 0;
       .transition(.2s ease-in-out all);
       border: 0;
       padding: 15px 0 0 17px;
-      margin-bottom: 10px;
-      overflow: hidden;
+      overflow: auto;
 
       .placeholder(lighten(@gray, 28));
 
@@ -374,6 +385,8 @@
       }
     }
 
+    textarea { margin-bottom: 10px; }
+
     .activity-actions {
       position: absolute;
       left: 0;
@@ -381,8 +394,6 @@
       right: 0;
       text-align: right;
       border-top: 1px solid @trim;
-      opacity: 0;
-      visibility: hidden;
       .transition(opacity .2s ease-in-out);
 
       .btn {
@@ -391,19 +402,6 @@
         border-radius: 0 0 2px;
       }
     }
-
-    &.expanded {
-      padding-bottom: 35px;
-
-      textarea {
-        max-height: 1000px;
-      }
-
-      .activity-actions {
-        opacity: 1;
-        visibility: visible;
-      }
-    }
   }
 
   > ul {
diff --git a/webpack.config.js b/webpack.config.js
index 4f8add4814..f5da17097d 100644
--- a/webpack.config.js
+++ b/webpack.config.js
@@ -16,6 +16,7 @@ var config = {
       "bootstrap/js/tooltip",
       "crypto-js/md5",
       "jquery",
+      "markdown",
       "moment",
       "raven-js",
       "react/addons",
