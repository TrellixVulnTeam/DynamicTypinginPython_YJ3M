commit c5eab91974669c7f699b754208b9ca0319c1745e
Author: Jess MacQueen <jessmacqueen@gmail.com>
Date:   Thu Jan 17 14:10:20 2019 -0800

    fix(event search): Correctly handle negative message search

diff --git a/src/sentry/api/event_search.py b/src/sentry/api/event_search.py
index e66217eaa6..bec050f15a 100644
--- a/src/sentry/api/event_search.py
+++ b/src/sentry/api/event_search.py
@@ -283,9 +283,13 @@ def get_snuba_query_args(query=None, params=None):
             kwargs['filter_keys'][snuba_name] = value
 
         elif snuba_name == 'message':
+            # https://clickhouse.yandex/docs/en/query_language/functions/string_search_functions/#position-haystack-needle
+            # positionCaseInsensitive returns 0 if not found and an index of 1 or more if found
+            # so we should flip the operator here
+            operator = '=' if _filter.operator == '!=' else '!='
             # make message search case insensitive
             kwargs['conditions'].append(
-                [['positionCaseInsensitive', ['message', "'%s'" % (value,)]], '!=', 0]
+                [['positionCaseInsensitive', ['message', "'%s'" % (value,)]], operator, 0]
             )
 
         else:
diff --git a/tests/sentry/api/test_event_search.py b/tests/sentry/api/test_event_search.py
index 33f00e4e3a..b25302bdc9 100644
--- a/tests/sentry/api/test_event_search.py
+++ b/tests/sentry/api/test_event_search.py
@@ -327,6 +327,16 @@ class EventSearchTest(TestCase):
             'conditions': [[['ifNull', ['tags[sentry:release]', "''"]], '=', '']]
         }
 
+    def test_get_snuba_query_args_message_negative(self):
+        assert get_snuba_query_args('!message:"post_process.process_error HTTPError 403"') == {
+            'filter_keys': {},
+            'conditions': [[
+                ['positionCaseInsensitive', ['message', "'post_process.process_error HTTPError 403'"]],
+                '=',
+                0,
+            ]]
+        }
+
     def test_convert_endpoint_params(self):
         assert convert_endpoint_params({
             'project_id': [1, 2, 3],
