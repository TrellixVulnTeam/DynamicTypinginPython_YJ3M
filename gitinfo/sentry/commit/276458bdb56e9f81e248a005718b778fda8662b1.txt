commit 276458bdb56e9f81e248a005718b778fda8662b1
Author: Lyn Nagara <lyn.nagara@gmail.com>
Date:   Tue May 1 15:16:54 2018 -0700

     feat(dashboard): Add recent activity chart to project card (#8259)

diff --git a/src/sentry/static/sentry/app/components/stackedBarChart.jsx b/src/sentry/static/sentry/app/components/stackedBarChart.jsx
index ebc6679575..b518d2413b 100644
--- a/src/sentry/static/sentry/app/components/stackedBarChart.jsx
+++ b/src/sentry/static/sentry/app/components/stackedBarChart.jsx
@@ -204,7 +204,7 @@ const StackedBarChart = createReactClass({
       10,
       this.state.series
         .map(s => Math.max(...s.data.map(p => p.y)))
-        .reduce((a, b) => a + b)
+        .reduce((a, b) => a + b, 0)
     );
   },
 
diff --git a/src/sentry/static/sentry/app/views/organizationDashboard/chart.jsx b/src/sentry/static/sentry/app/views/organizationDashboard/chart.jsx
new file mode 100644
index 0000000000..22ba408a7a
--- /dev/null
+++ b/src/sentry/static/sentry/app/views/organizationDashboard/chart.jsx
@@ -0,0 +1,41 @@
+import React from 'react';
+import PropTypes from 'prop-types';
+import styled from 'react-emotion';
+
+import BarChart from 'app/components/barChart';
+
+export default class Chart extends React.Component {
+  static propTypes = {
+    stats: PropTypes.array,
+  };
+
+  static defaultProps = {
+    stats: [],
+  };
+
+  render() {
+    const data = this.props.stats.map(d => ({x: d[0], y: d[1]}));
+
+    return (
+      <div>
+        <StyledBarChart points={data} label="events" height={80} />
+      </div>
+    );
+  }
+}
+
+const StyledBarChart = styled(BarChart)`
+  a {
+    background-color: rgba(175, 163, 187, 0.2);
+    &:not(:first-child) {
+      border-left: 2px solid white;
+    }
+    &:not(:last-child) {
+      border-right: 2px solid white;
+    }
+    > span {
+      left: 0;
+      right: 0;
+    }
+  }
+`;
diff --git a/src/sentry/static/sentry/app/views/organizationDashboard/index.jsx b/src/sentry/static/sentry/app/views/organizationDashboard/index.jsx
index 7fb01d1fe3..68acd5fb18 100644
--- a/src/sentry/static/sentry/app/views/organizationDashboard/index.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDashboard/index.jsx
@@ -4,6 +4,7 @@ import createReactClass from 'create-react-class';
 import {Flex, Box} from 'grid-emotion';
 import styled from 'react-emotion';
 
+import AsyncComponent from 'app/components/asyncComponent';
 import OrganizationState from 'app/mixins/organizationState';
 import OldDashboard from 'app/views/organizationDashboard/oldDashboard';
 import ProjectNav from 'app/views/organizationDashboard/projectNav';
@@ -14,7 +15,7 @@ import getProjectsByTeams from 'app/utils/getProjectsByTeams';
 import withTeams from 'app/utils/withTeams';
 import withProjects from 'app/utils/withProjects';
 
-class Dashboard extends React.Component {
+class Dashboard extends AsyncComponent {
   static propTypes = {
     teams: PropTypes.array,
     projects: PropTypes.array,
@@ -22,22 +23,32 @@ class Dashboard extends React.Component {
 
   componentWillMount() {
     $(document.body).addClass('org-dashboard');
+    super.componentWillMount();
   }
   componentWillUnmount() {
     $(document.body).removeClass('org-dashboard');
+    super.componentWillUnmount();
   }
 
-  render() {
-    const {projects, teams, params} = this.props;
+  getEndpoints() {
+    const {orgId} = this.props.params;
+    return [['projectsWithStats', `/organizations/${orgId}/projects/?statsPeriod=24h`]];
+  }
+
+  renderBody() {
+    const {teams, projects, params} = this.props;
     const {projectsByTeam} = getProjectsByTeams(teams, projects);
     const projectKeys = Object.keys(projectsByTeam);
 
+    const {projectsWithStats} = this.state;
+    const getStats = id => projectsWithStats.find(project => id === project.id).stats;
+
     return (
-      <Flex flex="1" direction="column">
-        <ProjectNav />
+      <React.Fragment>
         {projectKeys.map((slug, index) => {
+          const showBorder = index !== projectKeys.length - 1;
           return (
-            <TeamSection key={slug} showBorder={index !== projectKeys.length - 1}>
+            <TeamSection key={slug} showBorder={showBorder}>
               <TeamTitleBar justify="space-between" align="center">
                 <TeamName>{`#${slug}`}</TeamName>
                 <TeamMembers teamId={slug} orgId={params.orgId} />
@@ -49,7 +60,7 @@ class Dashboard extends React.Component {
                       key={project.id}
                       width={['100%', '50%', '33%', '25%']}
                     >
-                      <ProjectCard project={project} />
+                      <ProjectCard project={project} stats={getStats(project.id)} />
                     </ProjectCardWrapper>
                   );
                 })}
@@ -58,7 +69,7 @@ class Dashboard extends React.Component {
           );
         })}
         {!projectKeys.length && <EmptyState orgId={params.orgId} />}
-      </Flex>
+      </React.Fragment>
     );
   }
 }
@@ -94,7 +105,12 @@ const OrganizationDashboard = createReactClass({
     const hasNewDashboardFeature = this.getFeatures().has('dashboard');
 
     if (hasNewDashboardFeature) {
-      return <Dashboard {...this.props} />;
+      return (
+        <Flex flex="1" direction="column">
+          <ProjectNav />
+          <Dashboard {...this.props} />
+        </Flex>
+      );
     } else {
       return <OldDashboard {...this.props} />;
     }
diff --git a/src/sentry/static/sentry/app/views/organizationDashboard/projectCard.jsx b/src/sentry/static/sentry/app/views/organizationDashboard/projectCard.jsx
index 7867d4a1cf..fb7096f7f5 100644
--- a/src/sentry/static/sentry/app/views/organizationDashboard/projectCard.jsx
+++ b/src/sentry/static/sentry/app/views/organizationDashboard/projectCard.jsx
@@ -7,13 +7,16 @@ import {Flex} from 'grid-emotion';
 import SentryTypes from 'app/proptypes';
 import Link from 'app/components/link';
 import {Client} from 'app/api';
+
+import PlatformList from 'app/views/organizationDashboard/platformList';
+import Chart from 'app/views/organizationDashboard/chart';
 import {update} from 'app/actionCreators/projects';
 import overflowEllipsis from 'app/styles/overflowEllipsis';
-import PlatformList from 'app/views/organizationDashboard/platformList';
 
 class ProjectCard extends React.Component {
   static propTypes = {
     project: SentryTypes.Project.isRequired,
+    stats: PropTypes.array,
     params: PropTypes.object,
   };
 
@@ -30,7 +33,7 @@ class ProjectCard extends React.Component {
   };
 
   render() {
-    const {project, params} = this.props;
+    const {project, stats, params} = this.props;
 
     return (
       <StyledProjectCard>
@@ -44,6 +47,7 @@ class ProjectCard extends React.Component {
             onClick={this.toggleProjectBookmark}
           />
         </Flex>
+        <Chart stats={stats} />
         <PlatformList platforms={project.platforms} />
       </StyledProjectCard>
     );
diff --git a/tests/js/spec/views/organizationDashboard/__snapshots__/projectCard.spec.jsx.snap b/tests/js/spec/views/organizationDashboard/__snapshots__/projectCard.spec.jsx.snap
index 416e7bb8b9..aa1413270e 100644
--- a/tests/js/spec/views/organizationDashboard/__snapshots__/projectCard.spec.jsx.snap
+++ b/tests/js/spec/views/organizationDashboard/__snapshots__/projectCard.spec.jsx.snap
@@ -21,6 +21,18 @@ exports[`ProjectCard renders 1`] = `
       "teams": Array [],
     }
   }
+  stats={
+    Array [
+      Array [
+        1525042800,
+        1,
+      ],
+      Array [
+        1525046400,
+        2,
+      ],
+    ]
+  }
 >
   <StyledProjectCard>
     <div
@@ -79,6 +91,186 @@ exports[`ProjectCard renders 1`] = `
           </div>
         </Base>
       </Flex>
+      <Chart
+        stats={
+          Array [
+            Array [
+              1525042800,
+              1,
+            ],
+            Array [
+              1525046400,
+              2,
+            ],
+          ]
+        }
+      >
+        <div>
+          <StyledBarChart
+            height={80}
+            label="events"
+            points={
+              Array [
+                Object {
+                  "x": 1525042800,
+                  "y": 1,
+                },
+                Object {
+                  "x": 1525046400,
+                  "y": 2,
+                },
+              ]
+            }
+          >
+            <BarChart
+              className="css-fcxdqz-StyledBarChart e1wib7610"
+              height={80}
+              label="events"
+              points={
+                Array [
+                  Object {
+                    "x": 1525042800,
+                    "y": 1,
+                  },
+                  Object {
+                    "x": 1525046400,
+                    "y": 2,
+                  },
+                ]
+              }
+            >
+              <StackedBarChart
+                barClasses={
+                  Array [
+                    "chart-bar",
+                  ]
+                }
+                className="css-fcxdqz-StyledBarChart e1wib7610"
+                height={80}
+                label="events"
+                markers={Array []}
+                points={
+                  Array [
+                    Object {
+                      "x": 1525042800,
+                      "y": Array [
+                        1,
+                      ],
+                    },
+                    Object {
+                      "x": 1525046400,
+                      "y": Array [
+                        2,
+                      ],
+                    },
+                  ]
+                }
+                series={Array []}
+                width={null}
+              >
+                <figure
+                  className="css-fcxdqz-StyledBarChart e1wib7610 barchart"
+                  style={
+                    Object {
+                      "height": 80,
+                      "width": null,
+                    }
+                  }
+                >
+                  <span
+                    className="max-y"
+                  >
+                    <count
+                      value={10}
+                    >
+                      <span>
+                        10
+                      </span>
+                    </count>
+                  </span>
+                  <span
+                    className="min-y"
+                  >
+                    0
+                  </span>
+                  <span>
+                    <Tooltip
+                      key="1525042800"
+                      title="<div style=\\"width:130px\\"><div class=\\"time-label\\"><span>April 29, 2018<br />11:00 PM  &#8594; 11:59 PM</span></div></div><div class=\\"value-label\\">1 events</div>"
+                      tooltipOptions={
+                        Object {
+                          "html": true,
+                          "placement": "bottom",
+                        }
+                      }
+                    >
+                      <a
+                        className="tip chart-column"
+                        style={
+                          Object {
+                            "height": "100%",
+                            "width": "50%",
+                          }
+                        }
+                        title="<div style=\\"width:130px\\"><div class=\\"time-label\\"><span>April 29, 2018<br />11:00 PM  &#8594; 11:59 PM</span></div></div><div class=\\"value-label\\">1 events</div>"
+                      >
+                        <span
+                          className="chart-bar"
+                          key="0"
+                          style={
+                            Object {
+                              "backgroundColor": null,
+                              "bottom": "0%",
+                              "height": "9.9%",
+                            }
+                          }
+                        >
+                          1
+                        </span>
+                      </a>
+                    </Tooltip>
+                    <Tooltip
+                      key="1525046400"
+                      title="<div style=\\"width:130px\\"><div class=\\"time-label\\"><span>April 30, 2018<br />12:00 AM  &#8594; 12:59 AM</span></div></div><div class=\\"value-label\\">2 events</div>"
+                      tooltipOptions={
+                        Object {
+                          "html": true,
+                          "placement": "bottom",
+                        }
+                      }
+                    >
+                      <a
+                        className="tip chart-column"
+                        style={
+                          Object {
+                            "height": "100%",
+                            "width": "50%",
+                          }
+                        }
+                        title="<div style=\\"width:130px\\"><div class=\\"time-label\\"><span>April 30, 2018<br />12:00 AM  &#8594; 12:59 AM</span></div></div><div class=\\"value-label\\">2 events</div>"
+                      >
+                        <span
+                          className="chart-bar"
+                          key="0"
+                          style={
+                            Object {
+                              "backgroundColor": null,
+                              "bottom": "0%",
+                              "height": "19.8%",
+                            }
+                          }
+                        >
+                          2
+                        </span>
+                      </a>
+                    </Tooltip>
+                  </span>
+                </figure>
+              </StackedBarChart>
+            </BarChart>
+          </StyledBarChart>
+        </div>
+      </Chart>
       <PlatformList
         platforms={
           Array [
diff --git a/tests/js/spec/views/organizationDashboard/index.spec.jsx b/tests/js/spec/views/organizationDashboard/index.spec.jsx
index f70e7dd6cf..713ade94cd 100644
--- a/tests/js/spec/views/organizationDashboard/index.spec.jsx
+++ b/tests/js/spec/views/organizationDashboard/index.spec.jsx
@@ -1,18 +1,59 @@
 import React from 'react';
-import {mount} from 'enzyme';
+import {shallow} from 'enzyme';
 
 import {Dashboard} from 'app/views/organizationDashboard';
 
 describe('OrganizationDashboard', function() {
-  it('renders empty state', function() {
-    const teams = [TestStubs.Team()];
-    const projects = [];
-
-    const wrapper = mount(
-      <Dashboard teams={teams} projects={projects} params={{orgId: 'org-slug'}} />,
-      TestStubs.routerContext()
-    );
-    const emptyState = wrapper.find('EmptyState');
-    expect(emptyState).toHaveLength(1);
+  afterEach(function() {
+    MockApiClient.clearMockResponses();
+  });
+
+  describe('empty state', function() {
+    beforeEach(function() {
+      MockApiClient.addMockResponse({
+        url: '/organizations/org-slug/projects/?statsPeriod=24h',
+        body: [],
+      });
+    });
+
+    it('renders', function() {
+      const teams = [TestStubs.Team()];
+      const projects = [];
+
+      const wrapper = shallow(
+        <Dashboard teams={teams} projects={projects} params={{orgId: 'org-slug'}} />,
+        TestStubs.routerContext()
+      );
+      const emptyState = wrapper.find('EmptyState');
+      expect(emptyState).toHaveLength(1);
+    });
+  });
+
+  describe('with projects', function() {
+    beforeEach(function() {
+      MockApiClient.addMockResponse({
+        url: '/organizations/org-slug/projects/?statsPeriod=24h',
+        body: [
+          TestStubs.Project({
+            teams: [TestStubs.Team()],
+            stats: [[1517281200, 2], [1517310000, 1]],
+          }),
+        ],
+      });
+    });
+
+    it('renders project cards', function() {
+      const teams = [TestStubs.Team()];
+      const projects = [TestStubs.Project({teams})];
+
+      const wrapper = shallow(
+        <Dashboard teams={teams} projects={projects} params={{orgId: 'org-slug'}} />,
+        TestStubs.routerContext()
+      );
+      const emptyState = wrapper.find('EmptyState');
+      const projectCard = wrapper.find('ProjectCardWrapper');
+      expect(emptyState).toHaveLength(0);
+      expect(projectCard).toHaveLength(1);
+    });
   });
 });
diff --git a/tests/js/spec/views/organizationDashboard/projectCard.spec.jsx b/tests/js/spec/views/organizationDashboard/projectCard.spec.jsx
index 4b3f08a0c3..5ee68a4abd 100644
--- a/tests/js/spec/views/organizationDashboard/projectCard.spec.jsx
+++ b/tests/js/spec/views/organizationDashboard/projectCard.spec.jsx
@@ -10,6 +10,7 @@ describe('ProjectCard', function() {
       <ProjectCard
         project={TestStubs.Project({platforms: ['javascript']})}
         params={{orgId: 'org-slug'}}
+        stats={[[1525042800, 1], [1525046400, 2]]}
       />,
       TestStubs.routerContext()
     );
