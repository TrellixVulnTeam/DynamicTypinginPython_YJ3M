commit 0bacd2facf05abe234fd42ea3e003835070e78f9
Author: MeredithAnya <meredith.a.heller@gmail.com>
Date:   Mon Jul 30 13:31:52 2018 -0700

    feat(integrations): Add feature flag for GHE and new issue ui (#9211)
    
    * feat(integrations): Add feature flag for GHE and new issue ui
    
    * another flag check

diff --git a/src/sentry/api/endpoints/organization_config_integrations.py b/src/sentry/api/endpoints/organization_config_integrations.py
index e2fde061a5..ca9bcef686 100644
--- a/src/sentry/api/endpoints/organization_config_integrations.py
+++ b/src/sentry/api/endpoints/organization_config_integrations.py
@@ -12,6 +12,9 @@ from django.conf import settings
 
 class OrganizationConfigIntegrationsEndpoint(OrganizationEndpoint):
     def get(self, request, organization):
+        has_ghe = features.has('organizations:github-enterprise',
+                               organization,
+                               actor=request.user)
         has_catchall = features.has('organizations:internal-catchall',
                                     organization,
                                     actor=request.user)
@@ -21,8 +24,11 @@ class OrganizationConfigIntegrationsEndpoint(OrganizationEndpoint):
 
         providers = []
         for provider in integrations.all():
-            internal_integrations = {
-                i for i in settings.SENTRY_INTERNAL_INTEGRATIONS if i != 'github' or not has_github_apps}
+            internal_integrations = {i for i in settings.SENTRY_INTERNAL_INTEGRATIONS}
+            if has_ghe:
+                internal_integrations.remove('github_enterprise')
+            if has_github_apps:
+                internal_integrations.remove('github')
             if not has_catchall and provider.key in internal_integrations:
                 continue
 
diff --git a/src/sentry/api/endpoints/organization_repositories.py b/src/sentry/api/endpoints/organization_repositories.py
index 5dd3291d14..07c6474a83 100644
--- a/src/sentry/api/endpoints/organization_repositories.py
+++ b/src/sentry/api/endpoints/organization_repositories.py
@@ -73,7 +73,10 @@ class OrganizationRepositoriesEndpoint(OrganizationEndpoint):
             }, status=403)
 
         provider_id = request.DATA.get('provider')
-        if features.has('organizations:internal-catchall', organization, actor=request.user):
+        has_ghe = provider_id == 'integrations:github_enterprise' and features.has(
+            'organizations:github-enterprise', organization, actor=request.user)
+        if features.has('organizations:internal-catchall', organization,
+                        actor=request.user) or has_ghe:
             if provider_id is not None and provider_id.startswith('integrations:'):
                 try:
                     provider_cls = bindings.get('integration-repository.provider').get(provider_id)
diff --git a/src/sentry/api/serializers/models/organization.py b/src/sentry/api/serializers/models/organization.py
index 2a6842d1d2..7e68fac2af 100644
--- a/src/sentry/api/serializers/models/organization.py
+++ b/src/sentry/api/serializers/models/organization.py
@@ -121,6 +121,10 @@ class DetailedOrganizationSerializer(OrganizationSerializer):
             feature_list.append('repos')
         if features.has('organizations:internal-catchall', obj, actor=user):
             feature_list.append('internal-catchall')
+        if features.has('organizations:new-issue-ui', obj, actor=user):
+            feature_list.append('new-issue-ui')
+        if features.has('organizations:github-enterprise', obj, actor=user):
+            feature_list.append('github-enterprise')
         if features.has('organizations:suggested-commits', obj, actor=user):
             feature_list.append('suggested-commits')
         if features.has('organizations:new-teams', obj, actor=user):
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index bc981fd231..b206a62351 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -771,6 +771,8 @@ SENTRY_FEATURES = {
     'organizations:require-2fa': False,
     'organizations:environments': False,
     'organizations:internal-catchall': False,
+    'organizations:new-issue-ui': False,
+    'organizations:github-enterprise': False,
     'organizations:new-teams': True,
     'organizations:unreleased-changes': False,
     'organizations:suggested-commits': True,
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index 816057aaaa..1dfb1648e9 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -23,6 +23,8 @@ default_manager.add('organizations:new-settings', OrganizationFeature)  # NOQA
 default_manager.add('organizations:integrations-v3', OrganizationFeature)  # NOQA
 default_manager.add('organizations:require-2fa', OrganizationFeature)  # NOQA
 default_manager.add('organizations:internal-catchall', OrganizationFeature)  # NOQA
+default_manager.add('organizations:new-issue-ui', OrganizationFeature)  # NOQA
+default_manager.add('organizations:github-enterprise', OrganizationFeature)  # NOQA
 default_manager.add('organizations:new-teams', OrganizationFeature)  # NOQA
 default_manager.add('organizations:unreleased-changes', OrganizationFeature)  # NOQA
 default_manager.add('organizations:environments', OrganizationFeature)  # NOQA
diff --git a/src/sentry/static/sentry/app/components/group/sidebar.jsx b/src/sentry/static/sentry/app/components/group/sidebar.jsx
index 7f6577db26..061e189129 100644
--- a/src/sentry/static/sentry/app/components/group/sidebar.jsx
+++ b/src/sentry/static/sentry/app/components/group/sidebar.jsx
@@ -230,7 +230,7 @@ const GroupSidebar = createReactClass({
           group={this.props.group}
           allEnvironments={this.state.allEnvironmentsGroupData}
         />
-        <Feature feature={['internal-catchall']}>
+        <Feature feature={['new-issue-ui']}>
           <ExternalIssueList group={this.props.group} />
         </Feature>
 
diff --git a/src/sentry/static/sentry/app/views/groupDetails/actions.jsx b/src/sentry/static/sentry/app/views/groupDetails/actions.jsx
index 1ad8940637..cc9b8c32ab 100644
--- a/src/sentry/static/sentry/app/views/groupDetails/actions.jsx
+++ b/src/sentry/static/sentry/app/views/groupDetails/actions.jsx
@@ -270,7 +270,7 @@ const GroupDetailsActions = createReactClass({
           </div>
         )}
 
-        {group.pluginActions.length > 1 && !orgFeatures.has('internal-catchall') ? (
+        {group.pluginActions.length > 1 && !orgFeatures.has('new-issue-ui') ? (
           <div className="btn-group more">
             <DropdownLink className="btn btn-default btn-sm" title={t('More')}>
               {group.pluginActions.map((action, actionIdx) => {
@@ -284,7 +284,7 @@ const GroupDetailsActions = createReactClass({
           </div>
         ) : (
           group.pluginActions.length !== 0 &&
-          !orgFeatures.has('internal-catchall') &&
+          !orgFeatures.has('new-issue-ui') &&
           group.pluginActions.map((action, actionIdx) => {
             return (
               <div className="btn-group" key={actionIdx}>
@@ -296,7 +296,7 @@ const GroupDetailsActions = createReactClass({
           })
         )}
         {group.pluginIssues &&
-          !orgFeatures.has('internal-catchall') &&
+          !orgFeatures.has('new-issue-ui') &&
           group.pluginIssues.map(plugin => {
             return <IssuePluginActions key={plugin.slug} plugin={plugin} />;
           })}
diff --git a/tests/js/spec/components/group/__snapshots__/sidebar.spec.jsx.snap b/tests/js/spec/components/group/__snapshots__/sidebar.spec.jsx.snap
index b82a7f280b..6446f3f838 100644
--- a/tests/js/spec/components/group/__snapshots__/sidebar.spec.jsx.snap
+++ b/tests/js/spec/components/group/__snapshots__/sidebar.spec.jsx.snap
@@ -127,7 +127,7 @@ exports[`GroupSidebar renders with tags renders 1`] = `
   <FeatureContainer
     feature={
       Array [
-        "internal-catchall",
+        "new-issue-ui",
       ]
     }
   >
