commit c9a0dffdff745ef1a186d9fad68d5a823a677797
Author: Dan Fuller <dfuller@sentry.io>
Date:   Fri Feb 21 16:00:05 2020 -0800

    ref(snuba): Log when we retry a request to snuba due to a connection related error
    
    It'd be good to have insight into how often we're retrying various calls to Snuba.

diff --git a/src/sentry/utils/snuba.py b/src/sentry/utils/snuba.py
index 143f0c09ba..e7404fb908 100644
--- a/src/sentry/utils/snuba.py
+++ b/src/sentry/utils/snuba.py
@@ -16,6 +16,7 @@ import sentry_sdk
 
 from concurrent.futures import ThreadPoolExecutor
 from django.conf import settings
+from six.moves.urllib.parse import urlparse
 
 from sentry import quotas
 from sentry.models import (
@@ -204,6 +205,10 @@ class RetrySkipTimeout(urllib3.Retry):
         if error and isinstance(error, urllib3.exceptions.ReadTimeoutError):
             raise six.reraise(type(error), error, _stacktrace)
 
+        metrics.incr(
+            "snuba.client.retry",
+            tags={"method": method, "path": urlparse(url).path if url else None},
+        )
         return super(RetrySkipTimeout, self).increment(
             method=method,
             url=url,
