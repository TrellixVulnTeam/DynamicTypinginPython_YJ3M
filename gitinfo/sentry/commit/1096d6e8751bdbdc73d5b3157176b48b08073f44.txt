commit 1096d6e8751bdbdc73d5b3157176b48b08073f44
Author: King Chung Huang <kinghuang@mac.com>
Date:   Tue Oct 22 08:41:07 2019 -0600

    feat(gitlab): Add option to search for projects in subgroups (#15178)
    
    Add an installation option to include projects from subgroups of the
    specified group.
    
    When search a group for projects, set the include_subgroups flag from
    the installation metadata. If enabled, projects in subgroups of the
    group will be included in the search.

diff --git a/src/sentry/integrations/gitlab/client.py b/src/sentry/integrations/gitlab/client.py
index d9f378b129..3d706f54f0 100644
--- a/src/sentry/integrations/gitlab/client.py
+++ b/src/sentry/integrations/gitlab/client.py
@@ -129,7 +129,7 @@ class GitLabApiClient(ApiClient):
         # Really useful, because we often don't need most of the project information
         return self.get(
             GitLabApiClientPath.group_projects.format(group=group),
-            params={"search": query, "simple": simple},
+            params={"search": query, "simple": simple, "include_subgroups": self.metadata.get("include_subgroups", False)},
         )
 
     def get_project(self, project_id):
diff --git a/src/sentry/integrations/gitlab/integration.py b/src/sentry/integrations/gitlab/integration.py
index 0466c34ca4..58b02eadff 100644
--- a/src/sentry/integrations/gitlab/integration.py
+++ b/src/sentry/integrations/gitlab/integration.py
@@ -135,6 +135,15 @@ class InstallationForm(forms.Form):
         ),
         widget=forms.TextInput(attrs={"placeholder": _("my-group/my-subgroup")}),
     )
+    include_subgroups = forms.BooleanField(
+        label=_("Include Subgroups"),
+        help_text=_(
+            "Include projects in subgroups of the GitLab group."
+        ),
+        widget=forms.CheckboxInput(),
+        required=False,
+        initial=False,
+    )
     verify_ssl = forms.BooleanField(
         label=_("Verify SSL"),
         help_text=_(
@@ -268,6 +277,7 @@ class GitlabIntegrationProvider(IntegrationProvider):
                     "base_url": installation_data["url"],
                     "verify_ssl": installation_data["verify_ssl"],
                     "group": installation_data["group"],
+                    "include_subgroups": installation_data["include_subgroups"],
                     "error_message": e.message,
                     "error_status": e.code,
                 },
@@ -286,6 +296,7 @@ class GitlabIntegrationProvider(IntegrationProvider):
         oauth_data = get_oauth_data(data)
         user = get_user_info(data["access_token"], state["installation_data"])
         group = self.get_group_info(data["access_token"], state["installation_data"])
+        include_subgroups = state["installation_data"]["include_subgroups"]
         scopes = sorted(GitlabIdentityProvider.oauth_scopes)
         base_url = state["installation_data"]["url"]
 
@@ -314,6 +325,7 @@ class GitlabIntegrationProvider(IntegrationProvider):
                 "base_url": base_url,
                 "webhook_secret": secret.hexdigest(),
                 "group_id": group["id"],
+                "include_subgroups": include_subgroups,
             },
             "user_identity": {
                 "type": "gitlab",
diff --git a/tests/sentry/integrations/gitlab/test_integration.py b/tests/sentry/integrations/gitlab/test_integration.py
index 9381edbdc2..9bd1fbc105 100644
--- a/tests/sentry/integrations/gitlab/test_integration.py
+++ b/tests/sentry/integrations/gitlab/test_integration.py
@@ -28,6 +28,7 @@ class GitlabIntegrationTest(IntegrationTestCase):
         "verify_ssl": True,
         "client_id": "client_id",
         "client_secret": "client_secret",
+        "include_subgroups": True,
     }
 
     default_group_id = 4
@@ -122,6 +123,7 @@ class GitlabIntegrationTest(IntegrationTestCase):
             "base_url": "https://gitlab.example.com",
             "webhook_secret": "secret-token",
             "group_id": self.default_group_id,
+            "include_subgroups": True,
         }
         oi = OrganizationIntegration.objects.get(
             integration=integration, organization=self.organization
