commit 369d52e544b1d5574541989192eaf170bbc15844
Author: Jess MacQueen <macqueen@users.noreply.github.com>
Date:   Thu Jan 25 13:07:20 2018 -0800

    fix(discard): Add discarded issues to blacklisted count (#7051)

diff --git a/src/sentry/tasks/store.py b/src/sentry/tasks/store.py
index 90d7a16676..d4936cd607 100644
--- a/src/sentry/tasks/store.py
+++ b/src/sentry/tasks/store.py
@@ -331,23 +331,28 @@ def save_event(cache_key=None, data=None, start_time=None, event_id=None,
         manager = EventManager(data)
         manager.save(project_id)
     except HashDiscarded:
-        tsdb.incr(
-            tsdb.models.project_total_received_discarded,
-            project_id,
-            timestamp=to_datetime(start_time) if start_time is not None else None,
-        )
+        increment_list = [
+            (tsdb.models.project_total_received_discarded, project_id),
+        ]
 
         try:
             project = Project.objects.get_from_cache(id=project_id)
         except Project.DoesNotExist:
             pass
         else:
+            increment_list.extend([
+                (tsdb.models.project_total_blacklisted, project.id),
+                (tsdb.models.organization_total_blacklisted, project.organization_id),
+            ])
+
             project_key = None
             if data.get('key_id') is not None:
                 try:
                     project_key = ProjectKey.objects.get_from_cache(id=data['key_id'])
                 except ProjectKey.DoesNotExist:
                     pass
+                else:
+                    increment_list.append((tsdb.models.key_total_blacklisted, project_key.id))
 
             quotas.refund(
                 project,
@@ -355,6 +360,11 @@ def save_event(cache_key=None, data=None, start_time=None, event_id=None,
                 timestamp=start_time,
             )
 
+        tsdb.incr_multi(
+            increment_list,
+            timestamp=to_datetime(start_time) if start_time is not None else None,
+        )
+
     finally:
         if cache_key:
             default_cache.delete(cache_key)
diff --git a/tests/sentry/tasks/test_store.py b/tests/sentry/tasks/test_store.py
index 83e740d2ac..4cc4bff9e6 100644
--- a/tests/sentry/tasks/test_store.py
+++ b/tests/sentry/tasks/test_store.py
@@ -173,7 +173,7 @@ class StoreTasksTest(PluginTestCase):
             project_id=project.id
         )
 
-    @mock.patch.object(tsdb, 'incr')
+    @mock.patch.object(tsdb, 'incr_multi')
     @mock.patch.object(quotas, 'refund')
     def test_hash_discarded_raised(self, mock_refund, mock_incr):
         project = self.create_project()
@@ -193,8 +193,10 @@ class StoreTasksTest(PluginTestCase):
         mock_save.side_effect = HashDiscarded
         with mock.patch.object(EventManager, 'save', mock_save):
             save_event(data=data, start_time=now)
-            mock_incr.assert_called_with(
-                tsdb.models.project_total_received_discarded,
-                project.id,
+            mock_incr.assert_called_with([
+                (tsdb.models.project_total_received_discarded, project.id),
+                (tsdb.models.project_total_blacklisted, project.id),
+                (tsdb.models.organization_total_blacklisted, project.organization_id),
+            ],
                 timestamp=to_datetime(now),
             )
