commit 8217af56d6bd787a3ff970bc05d8735b3264dc0f
Author: Brett Hoerner <brett@bretthoerner.com>
Date:   Fri Mar 9 12:32:54 2018 -0600

    fix(tagstore): select_related in merge code when necessary so FK lookâ€¦ (#7546)

diff --git a/src/sentry/tagstore/v2/models/grouptagkey.py b/src/sentry/tagstore/v2/models/grouptagkey.py
index 127fb1bf92..a2aa12026a 100644
--- a/src/sentry/tagstore/v2/models/grouptagkey.py
+++ b/src/sentry/tagstore/v2/models/grouptagkey.py
@@ -49,6 +49,10 @@ class GroupTagKey(Model):
     def key(self, key):
         self._set_key = key
 
+    @staticmethod
+    def get_select_related_for_merge():
+        return ('_key', )
+
     def merge_counts(self, new_group):
         from sentry.tagstore.v2.models import GroupTagValue
 
diff --git a/src/sentry/tagstore/v2/models/grouptagvalue.py b/src/sentry/tagstore/v2/models/grouptagvalue.py
index bede1f6e65..668ed574b3 100644
--- a/src/sentry/tagstore/v2/models/grouptagvalue.py
+++ b/src/sentry/tagstore/v2/models/grouptagvalue.py
@@ -71,6 +71,10 @@ class GroupTagValue(Model):
             self.first_seen = self.last_seen
         super(GroupTagValue, self).save(*args, **kwargs)
 
+    @staticmethod
+    def get_select_related_for_merge():
+        return ('_key', '_value', )
+
     def merge_counts(self, new_group):
         try:
             with transaction.atomic(using=router.db_for_write(GroupTagValue)):
diff --git a/src/sentry/tasks/merge.py b/src/sentry/tasks/merge.py
index 13ebce936d..548e5848e0 100644
--- a/src/sentry/tasks/merge.py
+++ b/src/sentry/tasks/merge.py
@@ -316,6 +316,9 @@ def merge_objects(models, group, new_group, limit=1000, logger=None, transaction
         else:
             queryset = project_qs.filter(group_id=group.id)
 
+        if hasattr(model, 'get_select_related_for_merge'):
+            queryset = queryset.select_related(*model.get_select_related_for_merge())
+
         for obj in queryset[:limit]:
             try:
                 with transaction.atomic(using=router.db_for_write(model)):
