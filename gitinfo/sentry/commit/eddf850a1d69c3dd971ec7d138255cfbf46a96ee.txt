commit eddf850a1d69c3dd971ec7d138255cfbf46a96ee
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jul 5 16:07:09 2016 -0700

    Handle unicode subjects correctly
    
    This also changes the default Group/Event fixtures to have a unicode message.
    
    @getsentry/infrastructure

diff --git a/src/sentry/plugins/sentry_mail/activity/base.py b/src/sentry/plugins/sentry_mail/activity/base.py
index 7506aa3bf3..28541ca6d0 100644
--- a/src/sentry/plugins/sentry_mail/activity/base.py
+++ b/src/sentry/plugins/sentry_mail/activity/base.py
@@ -92,10 +92,10 @@ class ActivityEmail(object):
     def get_subject(self):
         group = self.group
 
-        return '[%s] %s: %s' % (
-            self.project.get_full_name().encode('utf-8'),
-            group.get_level_display().upper().encode('utf-8'),
-            group.message_short.encode('utf-8')
+        return u'[%s] %s: %s' % (
+            self.project.get_full_name(),
+            group.get_level_display().upper(),
+            group.message_short
         )
 
     def get_context(self):
@@ -223,10 +223,10 @@ class ActivityEmail(object):
 
         subject_prefix = self._get_subject_prefix()
 
-        subject = u'{}{}'.format(
+        subject = (u'{}{}'.format(
             subject_prefix,
             self.get_subject(),
-        )
+        )).encode('utf-8')
         template = self.get_template()
         html_template = self.get_html_template()
         email_type = self.get_email_type()
diff --git a/src/sentry/testutils/fixtures.py b/src/sentry/testutils/fixtures.py
index e27d5cb4e2..974ae4231e 100644
--- a/src/sentry/testutils/fixtures.py
+++ b/src/sentry/testutils/fixtures.py
@@ -1,3 +1,4 @@
+# -*- coding: utf-8 -*-
 """
 sentry.testutils.fixtures
 ~~~~~~~~~~~~~~~~~~~~~~~~~
@@ -135,11 +136,14 @@ class Fixtures(object):
 
     @fixture
     def group(self):
-        return self.create_group(message='Foo bar')
+        return self.create_group(message=u'こんにちは')
 
     @fixture
     def event(self):
-        return self.create_event(event_id='a' * 32)
+        return self.create_event(
+            event_id='a' * 32,
+            message=u'こんにちは',
+        )
 
     @fixture
     def activity(self):
diff --git a/tests/sentry/plugins/mail/tests.py b/tests/sentry/plugins/mail/tests.py
index 61099c24b0..ffc6025685 100644
--- a/tests/sentry/plugins/mail/tests.py
+++ b/tests/sentry/plugins/mail/tests.py
@@ -314,7 +314,7 @@ class MailPluginTest(TestCase):
 
         msg = mail.outbox[0]
 
-        assert msg.subject == 'Re: [Sentry] [foo Bar] ERROR: Foo bar'
+        assert msg.subject == 'Re: [Sentry] [foo Bar] ERROR: \xe3\x81\x93\xe3\x82\x93\xe3\x81\xab\xe3\x81\xa1\xe3\x81\xaf'
         assert msg.to == [self.user.email]
 
     def test_note(self):
@@ -339,5 +339,5 @@ class MailPluginTest(TestCase):
 
         msg = mail.outbox[0]
 
-        assert msg.subject == 'Re: [Sentry] [foo Bar] ERROR: Foo bar'
+        assert msg.subject == 'Re: [Sentry] [foo Bar] ERROR: \xe3\x81\x93\xe3\x82\x93\xe3\x81\xab\xe3\x81\xa1\xe3\x81\xaf'
         assert msg.to == [self.user.email]
