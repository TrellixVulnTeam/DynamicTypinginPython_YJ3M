commit e905334869af72025592de586b81650cb3468b8a
Author: David Cramer <dcramer@gmail.com>
Date:   Thu Dec 29 13:06:09 2011 -0800

    Declare queues when broker is instantiated

diff --git a/sentry/queue/client.py b/sentry/queue/client.py
index 23b2ad4198..887143126c 100644
--- a/sentry/queue/client.py
+++ b/sentry/queue/client.py
@@ -16,6 +16,9 @@ from sentry.queue.queues import task_queues, task_exchange
 class Broker(object):
     def __init__(self, config):
         self.connection = BrokerConnection(**config)
+        with producers[self.connection].acquire(block=False) as producer:
+            for queue in task_queues:
+                maybe_declare(queue, producer.channel)
 
     def delay(self, func, *args, **kwargs):
         payload = {
@@ -25,8 +28,6 @@ class Broker(object):
         }
 
         with producers[self.connection].acquire(block=False) as producer:
-            for queue in task_queues:
-                maybe_declare(queue, producer.channel)
             producer.publish(payload,
                 exchange=task_exchange,
                 serializer="pickle",
