commit 0e68935ab727936a802af5bbc207855703246d00
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Sat May 17 17:54:21 2014 -0700

    Swap pynliner for toronado

diff --git a/setup.py b/setup.py
index 4df2c7e567..5ff5bb149b 100755
--- a/setup.py
+++ b/setup.py
@@ -86,7 +86,6 @@ install_requires = [
     'logan>=0.5.8.2,<0.6.0',
     'nydus>=0.10.7,<0.11.0',
     'Pygments>=1.6.0,<1.7.0',
-    'pynliner>=0.4.0,<0.6.0',
     'python-dateutil>=1.5.0,<2.0.0',
     'python-memcached>=1.53,<2.0.0',
     'raven>=4.0.2',
@@ -94,6 +93,7 @@ install_requires = [
     'simplejson>=3.1.0,<3.4.0',
     'setproctitle>=1.1.7,<1.2.0',
     'South==0.8.2',
+    'toronado>=0.0.4,<0.1.0',
     'urllib3>=1.7.1,<1.8.0',
 ]
 
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index cc4e9f3ed3..75f8113c94 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -316,6 +316,9 @@ LOGGING = {
         'console': {
             'class': 'logging.StreamHandler'
         },
+        'null': {
+            'class': 'logging.NullHandler',
+        },
         'sentry': {
             'level': 'ERROR',
             'class': 'raven.contrib.django.handlers.SentryHandler',
@@ -352,6 +355,11 @@ LOGGING = {
             'handlers': ['console'],
             'propagate': False,
         },
+        'toronado.cssutils': {
+            'level': 'ERROR',
+            'handlers': ['null'],
+            'propagate': False,
+        },
     }
 }
 
diff --git a/src/sentry/templates/sentry/emails/base.html b/src/sentry/templates/sentry/emails/base.html
index 4f83d5fe6e..10e0a7a8ba 100644
--- a/src/sentry/templates/sentry/emails/base.html
+++ b/src/sentry/templates/sentry/emails/base.html
@@ -2,6 +2,7 @@
 <!DOCTYPE html>
 <html>
     <head>
+        <meta charset="utf-8" />
         <style type="text/css">
         body, .main {
             width: 100%;
diff --git a/src/sentry/utils/email.py b/src/sentry/utils/email.py
index c80107a3c3..850db66c39 100644
--- a/src/sentry/utils/email.py
+++ b/src/sentry/utils/email.py
@@ -14,7 +14,7 @@ from django.utils.encoding import force_bytes
 from django.utils.functional import cached_property
 
 from email.utils import parseaddr
-from pynliner import Pynliner
+import toronado
 
 from sentry.web.helpers import render_to_string
 
@@ -84,7 +84,7 @@ class MessageBuilder(object):
             html_body = self._html_body
 
         if html_body is not None:
-            return UnicodeSafePynliner().from_string(html_body).run()
+            return toronado.from_string(html_body)
 
     @cached_property
     def txt_body(self):
@@ -187,14 +187,3 @@ class MessageBuilder(object):
     def send_all(self, messages, fail_silently=False):
         connection = get_connection(fail_silently=fail_silently)
         return connection.send_messages(messages)
-
-
-class UnicodeSafePynliner(Pynliner):
-    def _get_output(self):
-        """
-        Generate Unicode string of `self.soup` and set it to `self.output`
-
-        Returns self.output
-        """
-        self.output = unicode(self.soup)
-        return self.output
diff --git a/tests/sentry/utils/email/tests.py b/tests/sentry/utils/email/tests.py
index d4a1ff5b97..1b0750daa0 100644
--- a/tests/sentry/utils/email/tests.py
+++ b/tests/sentry/utils/email/tests.py
@@ -24,7 +24,7 @@ class MessageBuilderTest(TestCase):
         assert out.body == 'hello world'
         assert len(out.alternatives) == 1
         assert out.alternatives[0] == (
-            '<b>hello world</b>',
+            '<html><body><b>hello world</b></body></html>',
             'text/html',
         )
 
@@ -46,7 +46,7 @@ class MessageBuilderTest(TestCase):
         assert out.body == 'hello world'
         assert len(out.alternatives) == 1
         assert out.alternatives[0] == (
-            '<b>hello world</b>',
+            '<html><body><b>hello world</b></body></html>',
             'text/html',
         )
 
@@ -103,7 +103,7 @@ class MessageBuilderTest(TestCase):
         assert out.body == 'hello world'
         assert len(out.alternatives) == 1
         assert out.alternatives[0] == (
-            '<b>hello world</b>',
+            '<html><body><b>hello world</b></body></html>',
             'text/html',
         )
 
@@ -128,6 +128,6 @@ class MessageBuilderTest(TestCase):
         assert out.body == 'hello world'
         assert len(out.alternatives) == 1
         assert out.alternatives[0] == (
-            '<b>hello world</b>',
+            '<html><body><b>hello world</b></body></html>',
             'text/html',
         )
