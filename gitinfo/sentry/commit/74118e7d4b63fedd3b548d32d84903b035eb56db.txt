commit 74118e7d4b63fedd3b548d32d84903b035eb56db
Author: josh <josh@jrl.ninja>
Date:   Mon Oct 14 17:16:47 2019 -0700

    py3(django): defer some model imports until after Django setup (part 1) (#15061)

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 9512ccdd45..57bf1f6fcf 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -315,15 +315,15 @@ INSTALLED_APPS = (
     "rest_framework",
     "sentry",
     "sentry.analytics",
-    "sentry.incidents",
+    "sentry.incidents.apps.Config",
     "sentry.discover",
     "sentry.analytics.events",
     "sentry.nodestore",
     "sentry.search",
     "sentry.snuba",
-    "sentry.lang.java",
-    "sentry.lang.javascript",
-    "sentry.lang.native",
+    "sentry.lang.java.apps.Config",
+    "sentry.lang.javascript.apps.Config",
+    "sentry.lang.native.apps.Config",
     "sentry.plugins.sentry_interface_types",
     "sentry.plugins.sentry_mail",
     "sentry.plugins.sentry_urls",
@@ -525,6 +525,7 @@ CELERY_CREATE_MISSING_QUEUES = True
 CELERY_REDIRECT_STDOUTS = False
 CELERYD_HIJACK_ROOT_LOGGER = False
 CELERY_IMPORTS = (
+    "sentry.discover.tasks",
     "sentry.incidents.tasks",
     "sentry.tasks.auth",
     "sentry.tasks.auto_resolve_issues",
diff --git a/src/sentry/discover/__init__.py b/src/sentry/discover/__init__.py
index 76dc99b8a2..c3961685ab 100644
--- a/src/sentry/discover/__init__.py
+++ b/src/sentry/discover/__init__.py
@@ -1,2 +1 @@
 from __future__ import absolute_import
-from . import tasks  # NOQA
diff --git a/src/sentry/incidents/__init__.py b/src/sentry/incidents/__init__.py
index 8e39f054c3..9418ba1d64 100644
--- a/src/sentry/incidents/__init__.py
+++ b/src/sentry/incidents/__init__.py
@@ -1,3 +1,2 @@
 from __future__ import absolute_import
 from . import events  # NOQA
-from . import receivers  # NOQA
diff --git a/src/sentry/incidents/apps.py b/src/sentry/incidents/apps.py
new file mode 100644
index 0000000000..2908d09c75
--- /dev/null
+++ b/src/sentry/incidents/apps.py
@@ -0,0 +1,10 @@
+from __future__ import absolute_import
+
+from django.apps import AppConfig
+
+
+class Config(AppConfig):
+    name = "sentry.incidents"
+
+    def ready(self):
+        from . import receivers  # noqa
diff --git a/src/sentry/lang/java/__init__.py b/src/sentry/lang/java/__init__.py
index 40dd8a87ec..c3961685ab 100644
--- a/src/sentry/lang/java/__init__.py
+++ b/src/sentry/lang/java/__init__.py
@@ -1,7 +1 @@
 from __future__ import absolute_import
-
-from sentry.plugins import register
-
-from .plugin import JavaPlugin
-
-register(JavaPlugin)
diff --git a/src/sentry/lang/java/apps.py b/src/sentry/lang/java/apps.py
new file mode 100644
index 0000000000..357c57d873
--- /dev/null
+++ b/src/sentry/lang/java/apps.py
@@ -0,0 +1,13 @@
+from __future__ import absolute_import
+
+from django.apps import AppConfig
+
+
+class Config(AppConfig):
+    name = "sentry.lang.java"
+
+    def ready(self):
+        from .plugin import JavaPlugin
+        from sentry.plugins import register
+
+        register(JavaPlugin)
diff --git a/src/sentry/lang/javascript/__init__.py b/src/sentry/lang/javascript/__init__.py
index e1b7abb6c8..c3961685ab 100644
--- a/src/sentry/lang/javascript/__init__.py
+++ b/src/sentry/lang/javascript/__init__.py
@@ -1,7 +1 @@
-from __future__ import absolute_import, print_function
-
-from sentry.plugins import register
-
-from .plugin import JavascriptPlugin
-
-register(JavascriptPlugin)
+from __future__ import absolute_import
diff --git a/src/sentry/lang/javascript/apps.py b/src/sentry/lang/javascript/apps.py
new file mode 100644
index 0000000000..42844708b3
--- /dev/null
+++ b/src/sentry/lang/javascript/apps.py
@@ -0,0 +1,13 @@
+from __future__ import absolute_import
+
+from django.apps import AppConfig
+
+
+class Config(AppConfig):
+    name = "sentry.lang.javascript"
+
+    def ready(self):
+        from .plugin import JavascriptPlugin
+        from sentry.plugins import register
+
+        register(JavascriptPlugin)
diff --git a/src/sentry/lang/native/__init__.py b/src/sentry/lang/native/__init__.py
index ac648c9613..c3961685ab 100644
--- a/src/sentry/lang/native/__init__.py
+++ b/src/sentry/lang/native/__init__.py
@@ -1,7 +1 @@
 from __future__ import absolute_import
-
-from sentry.plugins import register
-
-from .plugin import NativePlugin
-
-register(NativePlugin)
diff --git a/src/sentry/lang/native/apps.py b/src/sentry/lang/native/apps.py
new file mode 100644
index 0000000000..be044cd018
--- /dev/null
+++ b/src/sentry/lang/native/apps.py
@@ -0,0 +1,13 @@
+from __future__ import absolute_import
+
+from django.apps import AppConfig
+
+
+class Config(AppConfig):
+    name = "sentry.lang.native"
+
+    def ready(self):
+        from .plugin import NativePlugin
+        from sentry.plugins import register
+
+        register(NativePlugin)
diff --git a/src/sentry/options/store.py b/src/sentry/options/store.py
index a83931898a..32561c0439 100644
--- a/src/sentry/options/store.py
+++ b/src/sentry/options/store.py
@@ -10,7 +10,6 @@ from random import random
 from django.db.utils import ProgrammingError, OperationalError
 from django.utils import timezone
 from django.utils.functional import cached_property
-from sentry.db.models.query import create_or_update
 from sentry.utils.hashlib import md5_text
 
 Key = namedtuple("Key", ("name", "default", "type", "flags", "ttl", "grace", "cache_key"))
@@ -187,6 +186,8 @@ class OptionsStore(object):
         return self.set_cache(key, value)
 
     def set_store(self, key, value):
+        from sentry.db.models.query import create_or_update
+
         create_or_update(
             model=self.model, key=key.name, values={"value": value, "last_updated": timezone.now()}
         )
diff --git a/src/sentry/runner/initializer.py b/src/sentry/runner/initializer.py
index 586a0efdd5..b54287fbc1 100644
--- a/src/sentry/runner/initializer.py
+++ b/src/sentry/runner/initializer.py
@@ -202,7 +202,7 @@ def configure_structlog():
     Make structlog comply with all of our options.
     """
     from django.conf import settings
-    import logging
+    import logging.config
     import structlog
     from sentry import options
     from sentry.logging import LoggingFormat
diff --git a/src/sentry/utils/pytest/sentry.py b/src/sentry/utils/pytest/sentry.py
index 6df727e2b0..53b67e2e46 100644
--- a/src/sentry/utils/pytest/sentry.py
+++ b/src/sentry/utils/pytest/sentry.py
@@ -143,13 +143,14 @@ def pytest_configure(config):
     bootstrap_options(settings)
     configure_structlog()
     fix_south(settings)
-    monkeypatch_django_migrations()
 
     import django
 
     if hasattr(django, "setup"):
         django.setup()
 
+    monkeypatch_django_migrations()
+
     bind_cache_to_option_store()
 
     initialize_receivers()
diff --git a/src/social_auth/models.py b/src/social_auth/models.py
index 5a24c1d054..211e168d9b 100644
--- a/src/social_auth/models.py
+++ b/src/social_auth/models.py
@@ -7,7 +7,7 @@ import six
 from datetime import datetime, timedelta
 from django.conf import settings
 from django.db import models
-from django.db.models.loading import get_model
+from django.apps import apps
 
 from .fields import JSONField
 from .utils import setting
@@ -199,4 +199,4 @@ class UserSocialAuth(models.Model):
 
     @classmethod
     def user_model(cls):
-        return get_model(*AUTH_USER_MODEL.split("."))
+        return apps.get_model(*AUTH_USER_MODEL.split("."))
