commit e9c3bbe6432936f2e18a3345d103e1dd879d6673
Author: Evan Purkhiser <evanpurkhiser@gmail.com>
Date:   Wed Mar 20 10:50:51 2019 -0700

    perf: Avoid uncached feature checks on /store (#12464)

diff --git a/src/sentry/quotas/base.py b/src/sentry/quotas/base.py
index e1123b727b..51377c282f 100644
--- a/src/sentry/quotas/base.py
+++ b/src/sentry/quotas/base.py
@@ -13,6 +13,7 @@ from django.conf import settings
 
 from sentry import options
 from sentry.utils.services import Service
+from sentry.utils.cache import default_cache
 
 
 class RateLimit(object):
@@ -72,9 +73,19 @@ class Quota(Service):
     def get_key_quota(self, key):
         from sentry import features
 
-        if features.has('projects:rate-limits', key.project):
-            return key.rate_limit
-        return (0, 0)
+        # XXX(epurkhiser): Avoid excessive feature manager checks (which can be
+        # expensive depending on feature handlers) for project rate limits.
+        # This happens on /store.
+        cache_key = u'project:{}:rate-limits'.format(key.project.id)
+
+        rate_limit = default_cache.get(cache_key)
+        if rate_limit is None:
+            has_rate_limits = features.has('projects:rate-limits', key.project)
+            rate_limit = key.rate_limit if has_rate_limits else (0, 0)
+
+            default_cache.set(cache_key, rate_limit, 600)
+
+        return rate_limit
 
     def get_project_quota(self, project):
         from sentry.models import Organization, OrganizationOption
diff --git a/tests/sentry/quotas/test_base.py b/tests/sentry/quotas/test_base.py
index 63b6800452..6564201a14 100644
--- a/tests/sentry/quotas/test_base.py
+++ b/tests/sentry/quotas/test_base.py
@@ -37,6 +37,7 @@ class QuotaTest(TestCase):
         )
         assert self.backend.get_key_quota(key) == (60, 5)
 
+    def test_get_key_quota_empty(self):
         key = ProjectKey.objects.create(
             project=self.project, rate_limit_window=None, rate_limit_count=None
         )
