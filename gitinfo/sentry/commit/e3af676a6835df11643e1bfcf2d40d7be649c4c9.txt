commit e3af676a6835df11643e1bfcf2d40d7be649c4c9
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Tue Jun 21 13:46:55 2016 -0700

    Use a faster/more efficient JSONRenderer (#3553)
    
    Also fixes SENTRY-1FD

diff --git a/src/sentry/logging/handlers.py b/src/sentry/logging/handlers.py
index c842af3419..bd9419bdc6 100644
--- a/src/sentry/logging/handlers.py
+++ b/src/sentry/logging/handlers.py
@@ -5,12 +5,31 @@ sentry.logging.handlers
 :license: BSD, see LICENSE for more details.
 """
 
+from simplejson import JSONEncoder
 import logging
 
 from structlog import get_logger
+from structlog.processors import _json_fallback_handler
 
 logger = get_logger()
 
+_default_encoder = JSONEncoder(
+    separators=(',', ':'),
+    ignore_nan=True,
+    skipkeys=False,
+    ensure_ascii=True,
+    check_circular=True,
+    allow_nan=True,
+    indent=None,
+    encoding='utf-8',
+    default=_json_fallback_handler,
+).encode
+
+
+class JSONRenderer(object):
+    def __call__(self, logger, name, event_dict):
+        return _default_encoder(event_dict)
+
 
 class StructLogHandler(logging.StreamHandler):
     def emit(self, record):
diff --git a/src/sentry/runner/initializer.py b/src/sentry/runner/initializer.py
index 0849abe4b0..413b1fc3cc 100644
--- a/src/sentry/runner/initializer.py
+++ b/src/sentry/runner/initializer.py
@@ -182,12 +182,8 @@ def configure_structlog():
             )
         ])
     elif fmt == LoggingFormat.MACHINE:
-        from sentry.utils.json import dumps
-        kwargs['processors'].append(
-            structlog.processors.JSONRenderer(
-                serializer=dumps
-            )
-        )
+        from sentry.logging.handlers import JSONRenderer
+        kwargs['processors'].append(JSONRenderer())
 
     structlog.configure(**kwargs)
 
