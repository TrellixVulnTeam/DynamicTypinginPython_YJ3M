commit 5316fec0106449b1a5f6dc4d0777418d92585e80
Author: David Cramer <dcramer@gmail.com>
Date:   Sun Dec 15 19:57:14 2013 -0800

    Improved note emails + preview view

diff --git a/src/sentry/templates/sentry/emails/base.html b/src/sentry/templates/sentry/emails/base.html
index 6e92967f92..d9408202d2 100644
--- a/src/sentry/templates/sentry/emails/base.html
+++ b/src/sentry/templates/sentry/emails/base.html
@@ -33,6 +33,9 @@
             font-weight: normal;
             font-family: Menlo, Monaco, "Courier New", monospace;
         }
+        pre, blockquote {
+            margin-bottom: 30px;
+        }
         table {
             width: 100%;
         }
@@ -121,9 +124,6 @@
             min-width: 60px;
             color: #666;
         }
-        pre.message {
-            margin-bottom: 30px;
-        }
         .interface {
             margin-bottom: 30px;
         }
@@ -147,6 +147,82 @@
         .tag-list li strong {
             font-weight: 200;
         }
+
+        .event {
+            position: relative;
+            padding: 0 0 0 80px;
+            margin: 0 0 30px;
+            position: relative;
+            min-height: 60px; /* count height */
+        }
+
+        .event h3 {
+            padding: 0;
+            margin: 0;
+            font-size: 16px;
+            line-height: 20px;
+            font-weight: bold;
+            width: 85%;
+            white-space: nowrap;
+            overflow: hidden;
+            text-overflow: ellipsis;
+        }
+
+        .event h3 a {
+            color: #465262;
+        }
+        .event .count {
+            color: #fff;
+            position: absolute;
+            left: 0px;
+            width: 60px;
+            height: 60px;
+            border-radius: 60px;
+            -webkit-border-radius: 60px;
+            -moz-border-radius: 60px;
+            line-height: 60px;
+            background: #cfd3da;
+            text-align: center;
+            font-size: 17px;
+            font-weight: bold;
+            letter-spacing: -1px;
+            overflow: hidden;
+        }
+        .level-info .count { background: #2788ce; }
+        .level-warning .count { background: #f18500; }
+        .level-error .count { background: #f43f20; }
+        .level-fatal .count { background: #d20f2a; }
+        .event .count .span {
+            position: absolute;
+            left: 0;
+            right: 0;
+            height: 100%;
+            text-align: center;
+            line-height: inherit;
+            display: block;
+        }
+        .event .message {
+            color: #898f98;
+            margin: 3px 0;
+            font-size: 14px;
+            padding-right: 24px;
+            white-space: nowrap;
+            overflow: hidden;
+            text-overflow: ellipsis;
+        }
+        .event .message .tag {
+            float: right;
+        }
+        .event .meta {
+            color: #b6bcc2;
+            font-size: 12px;
+        }
+        .event .meta a {
+            color: inherit;
+        }
+        .event .tag {
+            margin-left: 10px;
+        }
         </style>
     </head>
     <body{% block bodyclass %}{% endblock %}>
diff --git a/src/sentry/templates/sentry/emails/new_note.html b/src/sentry/templates/sentry/emails/new_note.html
index 598f269b7d..d4cb11177b 100644
--- a/src/sentry/templates/sentry/emails/new_note.html
+++ b/src/sentry/templates/sentry/emails/new_note.html
@@ -1,17 +1,46 @@
 {% extends "sentry/emails/base.html" %}
 
 {% load i18n %}
+{% load sentry_helpers %}
+{% load sentry_plugins %}
 
 {% block header %}
-    <h1>Sentry <small>New Note</small></h1>
+    <a href="{{ link }}" class="btn">View on Sentry</a>
+    <h1>Sentry</h1>
 {% endblock %}
 
 {% block inner %}
-    <pre>{{ group.message_top }}</pre>
+    <div class="event level-{{ group.get_level_display }}">
+        <div class="count">
+            <span title="{{ group.times_seen }}">{{ group.times_seen|small_count }}</span>
+        </div>
+        <div class="details">
+            <h3>
+                <a href="{% url 'sentry-group' group.team.slug group.project.slug group.pk %}">
+                    {{ group.message_top }}
+                </a>
+            </h3>
+            <p class="message">
+                {{ group.error }}
+            </p>
+            <div class="meta">
+                <span class="last-seen pretty-date">{{ group.last_seen|timesince }}</span>
+                {% if group.avg_time_spent %}
+                    <span class="time-spent">{{ group.avg_time_spent|duration }}</span>
+                {% endif %}
+                <span class="tag tag-logger">
+                    <a href="{% url 'sentry-stream' group.team.slug group.project.slug %}?logger={{ group.logger }}">{{ group.logger }}</a>
+                </span>
+                {% with group.get_version as version %}
+                    {% if version %}
+                        <span class="tag tag-version">{{ version.0 }} {{ version.1 }}</span>
+                    {% endif %}
+                {% endwith %}
+            </div>
+        </div>
+    </div>
 
-    <p>A note was added by {{ author }}:</p>
+    <h2>New Note by <span class="highlight">{{ author }}</span></h2>
 
-    <blockquote>{{ text|urlize|linebreaks }}</blockquote>
-
-    <p><a href="{{ link }}">{{ link }}</a></p>
+    <blockquote class="note">{{ text|urlize|linebreaks }}</blockquote>
 {% endblock %}
diff --git a/src/sentry/templatetags/sentry_plugins.py b/src/sentry/templatetags/sentry_plugins.py
index 2087831077..840434ff6e 100644
--- a/src/sentry/templatetags/sentry_plugins.py
+++ b/src/sentry/templatetags/sentry_plugins.py
@@ -57,7 +57,7 @@ def get_widgets(group, request):
 
 
 @register.filter
-def get_tags(group, request):
+def get_tags(group, request=None):
     project = group.project
 
     tag_list = []
diff --git a/src/sentry/web/frontend/debug/mail.py b/src/sentry/web/frontend/debug/mail.py
index 2d428b467a..27e25b7e8e 100644
--- a/src/sentry/web/frontend/debug/mail.py
+++ b/src/sentry/web/frontend/debug/mail.py
@@ -1,7 +1,10 @@
+import logging
+
 from django.utils.safestring import mark_safe
 
-from sentry.models import Event, Group, Project, Team
+from sentry.models import Activity, Event, Group, Project, Team
 from sentry.utils.samples import load_data
+from sentry.web.decorators import login_required
 from sentry.web.helpers import render_to_response, render_to_string
 
 
@@ -19,26 +22,33 @@ class MailPreview(object):
         return render_to_string(self.html_template, self.context)
 
 
+@login_required
 def new_event(request):
     team = Team(
+        id=1,
         slug='example',
         name='Example',
     )
     project = Project(
+        id=1,
         slug='example',
         name='Example',
         team=team,
     )
     group = Group(
+        id=1,
         project=project,
         message='This is an example event.',
+        level=logging.ERROR,
     )
 
     event = Event(
+        id=1,
         project=project,
         group=group,
         message=group.message,
         data=load_data('python'),
+        level=logging.ERROR,
     )
 
     interface_list = []
@@ -63,3 +73,50 @@ def new_event(request):
     return render_to_response('sentry/debug/mail/preview.html', {
         'preview': preview,
     })
+
+
+@login_required
+def new_note(request):
+    team = Team(
+        id=1,
+        slug='example',
+        name='Example',
+    )
+    project = Project(
+        id=1,
+        slug='example',
+        name='Example',
+        team=team,
+    )
+    group = Group(
+        id=1,
+        project=project,
+        message='This is an example event.',
+    )
+    event = Event(
+        id=1,
+        project=project,
+        group=group,
+        message=group.message,
+        data=load_data('python'),
+    )
+    note = Activity(
+        group=event.group, event=event, project=event.project,
+        type=Activity.NOTE, user=request.user,
+        data={'text': 'This is an example note!'},
+    )
+
+    preview = MailPreview(
+        html_template='sentry/emails/new_note.html',
+        text_template='sentry/emails/new_note.txt',
+        context={
+            'text': note.data['text'],
+            'author': note.user,
+            'group': group,
+            'link': group.get_absolute_url(),
+        },
+    )
+
+    return render_to_response('sentry/debug/mail/preview.html', {
+        'preview': preview,
+    })
diff --git a/src/sentry/web/urls.py b/src/sentry/web/urls.py
index e23b42805f..77a410a885 100644
--- a/src/sentry/web/urls.py
+++ b/src/sentry/web/urls.py
@@ -55,6 +55,8 @@ if settings.DEBUG:
     urlpatterns += patterns('',
         url(r'^debug/mail/new-event/$',
             sentry.web.frontend.debug.mail.new_event),
+        url(r'^debug/mail/new-note/$',
+            sentry.web.frontend.debug.mail.new_note),
     )
 
 urlpatterns += patterns('',
