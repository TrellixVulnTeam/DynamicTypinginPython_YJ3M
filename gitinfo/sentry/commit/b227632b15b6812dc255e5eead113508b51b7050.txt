commit b227632b15b6812dc255e5eead113508b51b7050
Author: Chris Clark <christopherchristopherclark@gmail.com>
Date:   Thu May 16 11:13:07 2019 -0700

    fix(dropdown-autocomplete): resolve arrow-key regression caused by addition of react-virtualized (#12869)
    
    * crappy first version
    
    * cleanup
    
    * don't use setState
    
    * snapshots
    
    * whitespace
    
    * don't measure the array if the component isn't using virtualization. add comments

diff --git a/docs-ui/components/dropdownAutoComplete.stories.js b/docs-ui/components/dropdownAutoComplete.stories.js
index 3bf122b016..b7c618d4cc 100644
--- a/docs-ui/components/dropdownAutoComplete.stories.js
+++ b/docs-ui/components/dropdownAutoComplete.stories.js
@@ -34,6 +34,10 @@ const groupedItems = [
         value: 'other recent thing',
         label: 'other recent thing',
       },
+      {
+        value: 'yet another recent thing',
+        label: 'yet another recent thing',
+      },
     ],
   },
   {
diff --git a/src/sentry/static/sentry/app/components/autoComplete.jsx b/src/sentry/static/sentry/app/components/autoComplete.jsx
index 397cda11a8..5a84b2b79a 100644
--- a/src/sentry/static/sentry/app/components/autoComplete.jsx
+++ b/src/sentry/static/sentry/app/components/autoComplete.jsx
@@ -221,11 +221,14 @@ class AutoComplete extends React.Component {
   };
 
   moveHighlightedIndex = (step, e) => {
-    const listSize = this.items.size - 1;
     let newIndex = this.state.highlightedIndex + step;
 
+    // when this component is in virtualized mode, only a subset of items will be passed
+    // down, making the array length inaccurate. instead we manually pass the length as itemCount
+    const listSize = this.itemCount || this.items.size;
+
     // Make sure new index is within bounds
-    newIndex = Math.max(0, Math.min(newIndex, listSize));
+    newIndex = Math.max(0, Math.min(newIndex, listSize - 1));
 
     this.setState({
       highlightedIndex: newIndex,
@@ -298,10 +301,14 @@ class AutoComplete extends React.Component {
     };
   };
 
-  getMenuProps = menuProps => ({
-    ...menuProps,
-    onMouseDown: this.handleMenuMouseDown.bind(this, menuProps),
-  });
+  getMenuProps = menuProps => {
+    this.itemCount = menuProps.itemCount;
+
+    return {
+      ...menuProps,
+      onMouseDown: this.handleMenuMouseDown.bind(this, menuProps),
+    };
+  };
 
   render() {
     const {children, onMenuOpen} = this.props;
diff --git a/src/sentry/static/sentry/app/components/dropdownAutoCompleteMenu.jsx b/src/sentry/static/sentry/app/components/dropdownAutoCompleteMenu.jsx
index 1066f2eab1..f03f4110a3 100644
--- a/src/sentry/static/sentry/app/components/dropdownAutoCompleteMenu.jsx
+++ b/src/sentry/static/sentry/app/components/dropdownAutoCompleteMenu.jsx
@@ -380,6 +380,12 @@ class DropdownAutoCompleteMenu extends React.Component {
           // emptyHidesInput is set to true.
           const showInput = !hideInput && (hasItems || !emptyHidesInput);
 
+          // When virtualization is turned on, we need to pass in the number of
+          // selecteable items for arrow-key limits
+          const itemCount =
+            this.props.virtualizedHeight &&
+            autoCompleteResults.filter(i => !i.groupLabel).length;
+
           const renderedFooter =
             typeof menuFooter === 'function' ? menuFooter({actions}) : menuFooter;
 
@@ -404,6 +410,7 @@ class DropdownAutoCompleteMenu extends React.Component {
                     style,
                     isStyled: true,
                     css: this.props.css,
+                    itemCount,
                     blendCorner,
                     alignMenu,
                     menuWithArrow,
