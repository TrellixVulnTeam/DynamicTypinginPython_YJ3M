commit d86c3cb7611c1e6b2e74e1d2caf96a8f495d34ba
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Aug 22 12:45:17 2017 -0700

    releases: ensure latest release uses date_released when possible

diff --git a/src/sentry/api/endpoints/project_group_index.py b/src/sentry/api/endpoints/project_group_index.py
index b64972799d..a01adf7ec0 100644
--- a/src/sentry/api/endpoints/project_group_index.py
+++ b/src/sentry/api/endpoints/project_group_index.py
@@ -110,7 +110,9 @@ class StatusDetailsValidator(serializers.Serializer):
                 attrs[source] = Release.objects.filter(
                     projects=project,
                     organization_id=project.organization_id,
-                ).order_by('-date_added')[0]
+                ).extra(select={
+                    'sort': 'COALESCE(date_released, date_added)',
+                }).order_by('-sort')[0]
             except IndexError:
                 raise serializers.ValidationError(
                     'No release data present in the system to form a basis for \'Next Release\''
@@ -491,7 +493,9 @@ class ProjectGroupIndexEndpoint(ProjectEndpoint, EnvironmentMixin):
                 release = Release.objects.filter(
                     projects=project,
                     organization_id=project.organization_id,
-                ).order_by('-date_added')[0]
+                ).extra(select={
+                    'sort': 'COALESCE(date_released, date_added)',
+                }).order_by('-sort')[0]
                 activity_type = Activity.SET_RESOLVED_IN_RELEASE
                 activity_data = {
                     # no version yet
diff --git a/src/sentry/models/release.py b/src/sentry/models/release.py
index a4a092b0bd..0910172241 100644
--- a/src/sentry/models/release.py
+++ b/src/sentry/models/release.py
@@ -305,7 +305,9 @@ class Release(Model):
         prev_release = type(self).objects.filter(
             organization_id=self.organization_id,
             projects__in=self.projects.all(),
-        ).exclude(version=self.version).order_by('-date_added').first()
+        ).extra(select={
+            'sort': 'COALESCE(date_released, date_added)',
+        }).exclude(version=self.version).order_by('-sort').first()
 
         names = {r['repository'] for r in refs}
         repos = list(
