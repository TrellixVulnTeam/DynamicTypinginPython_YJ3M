commit 892baf5ad3fd9857e351b12b1d02d0a7dbdd39c9
Author: David Cramer <dcramer@gmail.com>
Date:   Tue Jan 27 18:31:22 2015 -0800

    Fix sample logic
    
    - Dont mutate last_seen before its tested
    - Ensure that mod on times_seen correctly checks against zero
    
    Fixes GH-1406

diff --git a/src/sentry/event_manager.py b/src/sentry/event_manager.py
index 469a7c9dab..46d7535140 100644
--- a/src/sentry/event_manager.py
+++ b/src/sentry/event_manager.py
@@ -77,7 +77,7 @@ else:
         silence_timedelta = event.datetime - group.last_seen
         silence = silence_timedelta.days * 86400 + silence_timedelta.seconds
 
-        if group.times_seen % count_limit(group.times_seen):
+        if group.times_seen % count_limit(group.times_seen) == 0:
             return False
 
         if group.times_seen % time_limit(silence):
@@ -446,19 +446,21 @@ class EventManager(object):
                 'time_spent_count': 1,
             })
 
-        if not is_new:
-            is_regression = self._process_existing_aggregate(group, event, kwargs)
-        else:
-            is_regression = False
-
         # Determine if we've sampled enough data to store this event
         if is_new:
             is_sample = False
+        # XXX(dcramer): it's important this gets called **before** the aggregate
+        # is processed as otherwise values like last_seen will get mutated
         elif not should_sample(group, event):
             is_sample = False
         else:
             is_sample = True
 
+        if not is_new:
+            is_regression = self._process_existing_aggregate(group, event, kwargs)
+        else:
+            is_regression = False
+
         tsdb.incr_multi([
             (tsdb.models.group, group.id),
             (tsdb.models.project, project.id),
