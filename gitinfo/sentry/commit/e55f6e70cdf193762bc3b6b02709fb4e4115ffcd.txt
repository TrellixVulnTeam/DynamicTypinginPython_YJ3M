commit e55f6e70cdf193762bc3b6b02709fb4e4115ffcd
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Wed Oct 14 15:26:14 2015 -0700

    Automatically tag CSP reports

diff --git a/src/sentry/coreapi.py b/src/sentry/coreapi.py
index 1d245aedae..e71c470c25 100644
--- a/src/sentry/coreapi.py
+++ b/src/sentry/coreapi.py
@@ -598,6 +598,7 @@ class CspApiHelper(ClientApiHelper):
             'project': project.id,
             'message': inst.get_message(),
             'culprit': inst.get_culprit(),
+            'tags': inst.get_tags(),
             inst.get_path(): inst.to_json(),
             # This is a bit weird, since we don't have nearly enough
             # information to create an Http interface, but
diff --git a/src/sentry/interfaces/csp.py b/src/sentry/interfaces/csp.py
index df1edfd1c6..c264d72e90 100644
--- a/src/sentry/interfaces/csp.py
+++ b/src/sentry/interfaces/csp.py
@@ -153,6 +153,12 @@ class Csp(Interface):
     def get_culprit(self):
         return self._normalize_directive(self.violated_directive)
 
+    def get_tags(self):
+        return (
+            ('effective-directive', self.effective_directive),
+            ('blocked-uri', _normalize_uri(self.blocked_uri)),
+        )
+
     def _normalize_directive(self, directive):
         bits = filter(None, directive.split(' '))
         return ' '.join([bits[0]] + map(self._normalize_value, bits[1:]))
diff --git a/tests/integration/fixtures/csp/chrome_blocked_asset_output.json b/tests/integration/fixtures/csp/chrome_blocked_asset_output.json
index 9b09e9d0fa..6f538b6636 100644
--- a/tests/integration/fixtures/csp/chrome_blocked_asset_output.json
+++ b/tests/integration/fixtures/csp/chrome_blocked_asset_output.json
@@ -1,5 +1,10 @@
 {
   "message": "Blocked 'style' from 'localhost:8000'",
+  "tags": {
+    "logger": "csp",
+    "effective-directive": "style-src",
+    "blocked-uri": "localhost:8000"
+  },
   "data": {
     "sentry.interfaces.User": {"ip_address": "127.0.0.1"},
     "sentry.interfaces.Csp": {
diff --git a/tests/integration/tests.py b/tests/integration/tests.py
index 107c30891f..50dd5de68c 100644
--- a/tests/integration/tests.py
+++ b/tests/integration/tests.py
@@ -416,7 +416,8 @@ class CspReportTest(TestCase):
         e = Event.objects.all()[0]
         Event.objects.bind_nodes([e], 'data')
         assert e.message == output['message']
-        assert e.get_tag('logger') == 'csp'
+        for key, value in output['tags'].iteritems():
+            assert e.get_tag(key) == value
         self.assertDictContainsSubset(output['data'], e.data.data, e.data.data)
 
     def assertReportRejected(self, input):
diff --git a/tests/sentry/coreapi/tests.py b/tests/sentry/coreapi/tests.py
index ba54371337..2418007a58 100644
--- a/tests/sentry/coreapi/tests.py
+++ b/tests/sentry/coreapi/tests.py
@@ -353,6 +353,7 @@ class CspApiHelperTest(BaseAPITest):
         assert result['project'] == self.project.id
         assert 'message' in result
         assert 'culprit' in result
+        assert 'tags' in result
         assert result['sentry.interfaces.User'] == {'ip_address': '69.69.69.69'}
         assert result['sentry.interfaces.Http'] == {
             'url': 'http://45.55.25.245:8123/csp',
diff --git a/tests/sentry/interfaces/test_csp.py b/tests/sentry/interfaces/test_csp.py
index 29788d4868..0c4284d12a 100644
--- a/tests/sentry/interfaces/test_csp.py
+++ b/tests/sentry/interfaces/test_csp.py
@@ -124,6 +124,12 @@ class CspTest(TestCase):
         ))
         assert result.get_hash() == ['img-src', 'ftp://example.com']
 
+    def test_get_tags(self):
+        assert self.interface.get_tags() == (
+            ('effective-directive', 'style-src'),
+            ('blocked-uri', 'example.com'),
+        )
+
     def test_get_message(self):
         result = Csp.to_python(dict(
             document_uri='http://example.com/foo',
