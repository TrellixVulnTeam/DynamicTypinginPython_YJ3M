commit 537cbcee6b190fb081a23a3e9efa3b4d2a958f0c
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Mon Nov 5 15:26:53 2018 +0100

    feat: Improved native group rendering and metadata extraction (#10413)

diff --git a/src/sentry/eventtypes/error.py b/src/sentry/eventtypes/error.py
index 580b40a332..0cab70e640 100644
--- a/src/sentry/eventtypes/error.py
+++ b/src/sentry/eventtypes/error.py
@@ -6,6 +6,18 @@ from sentry.utils.strings import truncatechars
 from .base import BaseEvent
 
 
+def get_crash_file(stacktrace):
+    default = None
+    for frame in reversed(stacktrace.get('frames') or ()):
+        fn = frame.get('filename') or frame.get('abs_path')
+        if fn:
+            if frame.get('in_app'):
+                return fn
+            if default is None:
+                default = fn
+    return default
+
+
 class ErrorEvent(BaseEvent):
     key = 'error'
 
@@ -16,11 +28,20 @@ class ErrorEvent(BaseEvent):
         exception = self.data['sentry.interfaces.Exception']['values'][-1]
 
         # in some situations clients are submitting non-string data for these
-        return {
+        rv = {
             'type': trim(exception.get('type', 'Error'), 128),
             'value': trim(exception.get('value', ''), 1024),
         }
 
+        # Attach crash location
+        stacktrace = exception.get('stacktrace')
+        if stacktrace:
+            fn = get_crash_file(stacktrace)
+            if fn is not None:
+                rv['filename'] = fn
+
+        return rv
+
     def to_string(self, metadata):
         if not metadata['value']:
             return metadata['type']
diff --git a/src/sentry/interfaces/stacktrace.py b/src/sentry/interfaces/stacktrace.py
index be7478152e..088aa9c6ca 100644
--- a/src/sentry/interfaces/stacktrace.py
+++ b/src/sentry/interfaces/stacktrace.py
@@ -585,7 +585,7 @@ class Frame(Interface):
         # not necessarily be the same platform).
         if self.platform is not None:
             platform = self.platform
-        if platform in ('objc', 'cocoa'):
+        if platform in ('objc', 'cocoa', 'native'):
             return self.function or '?'
         fileloc = self.module or self.filename
         if not fileloc:
diff --git a/src/sentry/lang/native/cfi.py b/src/sentry/lang/native/cfi.py
index da8cf327b0..af9627a658 100644
--- a/src/sentry/lang/native/cfi.py
+++ b/src/sentry/lang/native/cfi.py
@@ -68,7 +68,7 @@ class ThreadRef(object):
         return module, {
             'instruction_addr': '0x%x' % addr,
             'function': '<unknown>',  # Required by interface
-            'module': module.name if module else None,
+            'package': module.name if module else None,
             'trust': trust,
         }
 
diff --git a/src/sentry/lang/native/minidump.py b/src/sentry/lang/native/minidump.py
index 5d50890773..31af177ce3 100644
--- a/src/sentry/lang/native/minidump.py
+++ b/src/sentry/lang/native/minidump.py
@@ -40,8 +40,6 @@ def merge_minidump_event(data, minidump, cfi=None):
 
     data['platform'] = 'native'
     data['level'] = 'fatal' if state.crashed else 'info'
-    data['message'] = 'Assertion Error: %s' % state.assertion if state.assertion \
-        else 'Fatal Error: %s' % state.crash_reason
 
     if state.timestamp:
         data['timestamp'] = float(state.timestamp)
@@ -76,8 +74,10 @@ def merge_minidump_event(data, minidump, cfi=None):
     crashed_thread['crashed'] = True
 
     # Extract the crash reason and infos
+    exc_value = 'Assertion Error: %s' % state.assertion if state.assertion \
+        else 'Fatal Error: %s' % state.crash_reason
     data['exception'] = {
-        'value': data['message'],
+        'value': exc_value,
         'thread_id': crashed_thread['id'],
         'type': state.crash_reason,
         # Move stacktrace here from crashed_thread (mutating!)
@@ -106,6 +106,6 @@ def frames_from_minidump_thread(thread):
     return [{
         'instruction_addr': '0x%x' % frame.return_address,
         'function': '<unknown>',  # Required by interface
-        'module': frame.module.name if frame.module else None,
+        'package': frame.module.name if frame.module else None,
         'trust': frame.trust,
     } for frame in reversed(list(thread.frames()))]
diff --git a/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx b/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
index 702ba8bcd3..a34f524fef 100644
--- a/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
+++ b/src/sentry/static/sentry/app/components/eventOrGroupHeader.jsx
@@ -61,6 +61,12 @@ class EventOrGroupHeader extends React.Component {
     }
   }
 
+  getLocation() {
+    let {data} = this.props;
+    let {metadata} = data || {};
+    return metadata.filename || null;
+  }
+
   getTitle() {
     let {hideIcons, hideLevel, includeLink, orgId, projectId, data} = this.props;
     let {id, level, groupID} = data || {};
@@ -105,10 +111,12 @@ class EventOrGroupHeader extends React.Component {
     let {className} = this.props;
     let cx = classNames('event-issue-header', className);
     let message = this.getMessage();
+    let location = this.getLocation();
 
     return (
       <div className={cx}>
         <Title>{this.getTitle()}</Title>
+        {location && <Location>{location}</Location>}
         {message && <Message>{message}</Message>}
       </div>
     );
@@ -133,6 +141,23 @@ const Title = styled.div`
   }
 `;
 
+const LocationWrapper = styled.div`
+  ${truncateStyles};
+  direction: rtl;
+  text-align: left;
+  font-size: 14px;
+  margin: 0 0 5px;
+  color: ${p => p.theme.gray3};
+  span {
+    direction: ltr;
+  }
+`;
+
+function Location(props) {
+  let {children, ...rest} = props;
+  return <LocationWrapper{...rest}>in <span>{children}</span></LocationWrapper>;
+}
+
 const Message = styled.div`
   ${truncateStyles};
   font-size: 14px;
diff --git a/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap b/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap
index ed3900ec91..854d35b90b 100644
--- a/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap
+++ b/tests/js/spec/views/__snapshots__/groupSimilarView.spec.jsx.snap
@@ -745,7 +745,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                                             title="Error level: Error"
                                           >
                                             <div
-                                              className="tip css-hpn2f3-GroupLevel eex8od4"
+                                              className="tip css-hpn2f3-GroupLevel eex8od5"
                                               title="Error level: Error"
                                             />
                                           </GroupLevel>
@@ -826,7 +826,7 @@ exports[`Issues Similar View renders with mocked data 1`] = `
                               </Title>
                               <Message>
                                 <div
-                                  className="css-y5cfdn-Message-truncateStyles eex8od1"
+                                  className="css-y5cfdn-Message-truncateStyles eex8od2"
                                 >
                                   Cannot read property 'length' of undefined
                                 </div>
diff --git a/tests/sentry/lang/native/test_cfi.py b/tests/sentry/lang/native/test_cfi.py
index c9439f38fa..87a543ba2e 100644
--- a/tests/sentry/lang/native/test_cfi.py
+++ b/tests/sentry/lang/native/test_cfi.py
@@ -16,19 +16,19 @@ RAW_STACKTRACE = [
     {
         'function': '<unknown>',
         'instruction_addr': '0x7f51401e4800',
-        'module': u'/lib/x86_64-linux-gnu/libc-2.23.so',
+        'package': u'/lib/x86_64-linux-gnu/libc-2.23.so',
         'trust': 'scan',
     },
     {
         'function': '<unknown>',
         'instruction_addr': '0x7f514025002e',
-        'module': u'/lib/x86_64-linux-gnu/libc-2.23.so',
+        'package': u'/lib/x86_64-linux-gnu/libc-2.23.so',
         'trust': 'scan',
     },
     {
         'function': '<unknown>',
         'instruction_addr': '0x401d72',
-        'module': u'/work/linux/build/crash',
+        'package': u'/work/linux/build/crash',
         'trust': 'context',
     }
 ]
@@ -37,25 +37,25 @@ CFI_STACKTRACE = [
     {
         'function': "<unknown>",
         'instruction_addr': "0x7f5140cdc000",
-        'module': None,
+        'package': None,
         'trust': "scan",
     },
     {
         'function': "<unknown>",
         'instruction_addr': "0x7fff5aef1000",
-        'module': None,
+        'package': None,
         'trust': "scan",
     },
     {
         'function': "<unknown>",
         'instruction_addr': "0x7f514017d830",
-        'module': "/lib/x86_64-linux-gnu/libc-2.23.so",
+        'package': "/lib/x86_64-linux-gnu/libc-2.23.so",
         'trust': "cfi",
     },
     {
         'function': "<unknown>",
         'instruction_addr': "0x401d72",
-        'module': "/work/linux/build/crash",
+        'package': "/work/linux/build/crash",
         'trust': "context",
     },
 ]
diff --git a/tests/sentry/lang/native/test_minidump.py b/tests/sentry/lang/native/test_minidump.py
index 6f0bc90081..ac395e62cc 100644
--- a/tests/sentry/lang/native/test_minidump.py
+++ b/tests/sentry/lang/native/test_minidump.py
@@ -141,109 +141,109 @@ def test_minidump_linux():
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401dc0',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7f5140cdc000',
-                        'module': None,
+                        'package': None,
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x400040',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7fff5aef1000',
-                        'module': None,
+                        'package': None,
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401de9',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401dc0',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x414ca0',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401c70',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401dc0',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401c70',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7f514017d830',
-                        'module': u'/lib/x86_64-linux-gnu/libc-2.23.so',
+                        'package': u'/lib/x86_64-linux-gnu/libc-2.23.so',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x414c30',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401ec0',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7f5140cebac6',
-                        'module': u'/lib/x86_64-linux-gnu/ld-2.23.so',
+                        'package': u'/lib/x86_64-linux-gnu/ld-2.23.so',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x400000',
-                        'module': None,
+                        'package': None,
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7f51401e4800',
-                        'module': u'/lib/x86_64-linux-gnu/libc-2.23.so',
+                        'package': u'/lib/x86_64-linux-gnu/libc-2.23.so',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7f514025002e',
-                        'module': u'/lib/x86_64-linux-gnu/libc-2.23.so',
+                        'package': u'/lib/x86_64-linux-gnu/libc-2.23.so',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x401d72',
-                        'module': u'/work/linux/build/crash',
+                        'package': u'/work/linux/build/crash',
                         'trust': 'context',
                     }
                 ],
@@ -272,7 +272,6 @@ def test_minidump_linux():
             'value': u'Fatal Error: SIGSEGV'
         },
         'level': 'fatal',
-        'message': u'Fatal Error: SIGSEGV',
         'platform': 'native',
         'release': 'test-1.0.0',
         'threads': [
@@ -617,25 +616,25 @@ def test_minidump_macos():
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7fffe7eeb235',
-                        'module': u'/usr/lib/system/libdyld.dylib',
+                        'package': u'/usr/lib/system/libdyld.dylib',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7fffe7eeb235',
-                        'module': u'/usr/lib/system/libdyld.dylib',
+                        'package': u'/usr/lib/system/libdyld.dylib',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x109ba8c70',
-                        'module': u'/Users/travis/build/getsentry/breakpad-tools/macos/build/./crash',
+                        'package': u'/Users/travis/build/getsentry/breakpad-tools/macos/build/./crash',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x109ba8c15',
-                        'module': u'/Users/travis/build/getsentry/breakpad-tools/macos/build/./crash',
+                        'package': u'/Users/travis/build/getsentry/breakpad-tools/macos/build/./crash',
                         'trust': 'context',
                     }
                 ],
@@ -664,7 +663,6 @@ def test_minidump_macos():
             'value': u'Fatal Error: EXC_BAD_ACCESS / KERN_INVALID_ADDRESS'
         },
         'level': 'fatal',
-        'message': u'Fatal Error: EXC_BAD_ACCESS / KERN_INVALID_ADDRESS',
         'platform': 'native',
         'release': 'test-1.0.0',
         'threads': [
@@ -827,73 +825,73 @@ def test_minidump_windows():
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x771d0f44',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'fp',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x771d0f79',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'fp',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x750662c4',
-                        'module': u'C:\\Windows\\System32\\kernel32.dll',
+                        'package': u'C:\\Windows\\System32\\kernel32.dll',
                         'trust': 'fp',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x2a2d97',
-                        'module': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
+                        'package': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x2a3435',
-                        'module': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
+                        'package': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7584e9c0',
-                        'module': u'C:\\Windows\\System32\\rpcrt4.dll',
+                        'package': u'C:\\Windows\\System32\\rpcrt4.dll',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x75810000',
-                        'module': None,
+                        'package': None,
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x70b7ae40',
-                        'module': u'C:\\Windows\\System32\\dbgcore.dll',
+                        'package': u'C:\\Windows\\System32\\dbgcore.dll',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x70850000',
-                        'module': None,
+                        'package': None,
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x7584e9c0',
-                        'module': u'C:\\Windows\\System32\\rpcrt4.dll',
+                        'package': u'C:\\Windows\\System32\\rpcrt4.dll',
                         'trust': 'scan',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x2a28d0',
-                        'module': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
+                        'package': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
                         'trust': 'fp',
                     },
                     {
                         'function': '<unknown>',
                         'instruction_addr': '0x2a2a3d',
-                        'module': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
+                        'package': u'C:\\projects\\breakpad-tools\\windows\\Release\\crash.exe',
                         'trust': 'context',
                     }
                 ],
@@ -915,7 +913,6 @@ def test_minidump_windows():
             'value': u'Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE'
         },
         'level': 'fatal',
-        'message': u'Fatal Error: EXCEPTION_ACCESS_VIOLATION_WRITE',
         'platform': 'native',
         'release': 'test-1.0.0',
         'threads': [
@@ -930,25 +927,25 @@ def test_minidump_windows():
                     'frames': [{
                         'function': '<unknown>',
                         'instruction_addr': '0x771d0f44',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'fp',
                     },
                         {
                         'function': '<unknown>',
                         'instruction_addr': '0x771d0f79',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'fp',
                     },
                         {
                         'function': '<unknown>',
                         'instruction_addr': '0x750662c4',
-                        'module': u'C:\\Windows\\System32\\kernel32.dll',
+                        'package': u'C:\\Windows\\System32\\kernel32.dll',
                         'trust': 'fp',
                     },
                         {
                         'function': '<unknown>',
                         'instruction_addr': '0x771e016c',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'context',
                     }],
                     'registers': {
@@ -972,25 +969,25 @@ def test_minidump_windows():
                     'frames': [{
                         'function': '<unknown>',
                         'instruction_addr': '0x771d0f44',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'fp',
                     },
                         {
                         'function': '<unknown>',
                         'instruction_addr': '0x771d0f79',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'fp',
                     },
                         {
                         'function': '<unknown>',
                         'instruction_addr': '0x750662c4',
-                        'module': u'C:\\Windows\\System32\\kernel32.dll',
+                        'package': u'C:\\Windows\\System32\\kernel32.dll',
                         'trust': 'fp',
                     },
                         {
                         'function': '<unknown>',
                         'instruction_addr': '0x771e016c',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'context',
                     }],
                     'registers': {
@@ -1014,7 +1011,7 @@ def test_minidump_windows():
                     'frames': [{
                         'function': '<unknown>',
                         'instruction_addr': '0x771df3dc',
-                        'module': u'C:\\Windows\\System32\\ntdll.dll',
+                        'package': u'C:\\Windows\\System32\\ntdll.dll',
                         'trust': 'context',
                     }],
                     'registers': {
