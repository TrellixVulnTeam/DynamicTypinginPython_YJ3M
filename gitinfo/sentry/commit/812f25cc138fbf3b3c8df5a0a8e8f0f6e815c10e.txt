commit 812f25cc138fbf3b3c8df5a0a8e8f0f6e815c10e
Author: David Cramer <dcramer@gmail.com>
Date:   Sat Jul 26 16:08:25 2014 +0200

    Move clippy entirely into directive

diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index f50aea5b5b..b51660140c 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -479,7 +479,6 @@ SENTRY_STATIC_BUNDLES = {
         "sentry/dist/vendor-jquery.min.js": {
             "src": [
                 "sentry/vendor/jquery/jquery.min.js",
-                "sentry/scripts/lib/jquery.clippy.min.js",
                 "sentry/scripts/lib/jquery.cookie.js",
                 "sentry/vendor/jquery-flot/jquery.flot.js",
                 "sentry/scripts/lib/jquery.flot.dashes.js",
diff --git a/src/sentry/static/sentry/app/directives/clippy.js b/src/sentry/static/sentry/app/directives/clippy.js
index 22327358f1..b8aeca40fd 100644
--- a/src/sentry/static/sentry/app/directives/clippy.js
+++ b/src/sentry/static/sentry/app/directives/clippy.js
@@ -1,13 +1,74 @@
 (function(){
   'use strict';
 
+  var options = {
+    'width': 14,
+    'height': 14,
+    'color': '#ffffff'
+  };
+
+  function doesHaveFlash() {
+    try
+    {
+      var fo = new ActiveXObject('ShockwaveFlash.ShockwaveFlash');
+      if (fo)
+      {
+        return true;
+      }
+    }
+    catch(e)
+    {
+      if (navigator.mimeTypes ["application/x-shockwave-flash"] !== undefined)
+      {
+        return true;
+      }
+    }
+    return false;
+  }
+
   angular.module('sentry.directives.clippy', [])
     .directive('clippy', function(config) {
       return function(scope, element, attrs){
-        $(element).clippy({
-          clippy_path: config.mediaUrl + 'clippy.swf',
-          keep_text: true
+        if (!doesHaveFlash()) {
+          return;
+        }
+
+        var rawText = element.text(),
+            encodedText = encodeURIComponent(rawText),
+            clippyPath = config.mediaUrl + 'clippy.swf',
+            id = element.id;
+
+        var params = {
+            allowScriptAccess: "always",
+            quality: "high",
+            scale: "noscale",
+            bgcolor: options.color,
+            FlashVars: 'text=' + encodedText
+        };
+
+        var embedParams = angular.copy(params);
+        embedParams.src = clippyPath;
+        embedParams.width = options.width;
+        embedParams.height = options.height;
+
+        delete params.movie;
+
+        var obj = angular.element('<object/>').attr({
+          classid: 'clsid:d27cdb6e-ae6d-11cf-96b8-444553540000',
+          width: options.width,
+          height: options.height
+        });
+
+        angular.forEach(params, function(key, value){
+          obj.append(angular.element('<param/>').attr({
+            name: key,
+            value: value
+          }));
         });
+
+        obj.append(angular.element('<embed/>').attr(embedParams));
+
+        element.prepend(obj);
       };
     });
 }());
diff --git a/src/sentry/static/sentry/scripts/lib/jquery.clippy.min.js b/src/sentry/static/sentry/scripts/lib/jquery.clippy.min.js
deleted file mode 100644
index fcdf26fd35..0000000000
--- a/src/sentry/static/sentry/scripts/lib/jquery.clippy.min.js
+++ /dev/null
@@ -1 +0,0 @@
-(function(a){a.fn.clippy=function(b){_opts={width:"14",height:"14",color:"#ffffff",clippy_path:"clippy.swf",keep_text:false};b=a.extend(_opts,b);params={movie:b.clippy_path,allowScriptAccess:"always",quality:"high",scale:"noscale",bgcolor:b.color};embed_params=a.extend({},params,{width:b.width,height:b.height});embed_params.src=embed_params.movie;delete embed_params.movie;this.each(function(c,d){if(b.text&&b.text!=""){text=b.text}else{if(a(d).data("text")&&a(d).data("text")!=""){text=a(d).data("text")}else{text=a(d).html()}}text=encodeURIComponent(text);params.FlashVars="text="+text;embed_params.FlashVars="text="+text;dom=a("<object />").attr({classid:"clsid:d27cdb6e-ae6d-11cf-96b8-444553540000",width:b.width,height:b.height});a.each(params,function(e,f){dom.append(a("<param />").attr({name:e,value:f}))});embed=a("<embed />").attr(embed_params);dom.append(embed);if(b.keep_text){a(d).html(dom).append(decodeURIComponent(text))}else{a(d).html(dom)}})}})(jQuery);
