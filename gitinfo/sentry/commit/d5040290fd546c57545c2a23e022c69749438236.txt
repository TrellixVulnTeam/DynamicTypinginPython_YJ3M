commit d5040290fd546c57545c2a23e022c69749438236
Author: David Cramer <dcramer@gmail.com>
Date:   Mon Aug 10 15:18:26 2015 -0700

    Swap in custom AnonymousUser class

diff --git a/src/sentry/api/authentication.py b/src/sentry/api/authentication.py
index 9a40ba4289..fc9400baf2 100644
--- a/src/sentry/api/authentication.py
+++ b/src/sentry/api/authentication.py
@@ -1,12 +1,11 @@
 from __future__ import absolute_import
 
-from django.contrib.auth.models import AnonymousUser
 from django.utils.crypto import constant_time_compare
 from rest_framework.authentication import BasicAuthentication
 from rest_framework.exceptions import AuthenticationFailed
 
 from sentry.app import raven
-from sentry.models import ApiKey, ProjectKey
+from sentry.models import AnonymousUser, ApiKey, ProjectKey
 
 
 class QuietBasicAuthentication(BasicAuthentication):
diff --git a/src/sentry/api/endpoints/auth_index.py b/src/sentry/api/endpoints/auth_index.py
index cba49d66c3..ccbd70551f 100644
--- a/src/sentry/api/endpoints/auth_index.py
+++ b/src/sentry/api/endpoints/auth_index.py
@@ -6,6 +6,7 @@ from rest_framework.response import Response
 from sentry.api import client
 from sentry.api.authentication import QuietBasicAuthentication
 from sentry.api.base import DocSection, Endpoint
+from sentry.models import AnonymousUser
 
 
 class AuthIndexEndpoint(Endpoint):
@@ -50,4 +51,5 @@ class AuthIndexEndpoint(Endpoint):
 
         """
         logout(request._request)
+        request.user = AnonymousUser()
         return Response(status=204)
diff --git a/src/sentry/api/serializers/base.py b/src/sentry/api/serializers/base.py
index 8266ae9a28..2180ce5db8 100644
--- a/src/sentry/api/serializers/base.py
+++ b/src/sentry/api/serializers/base.py
@@ -1,6 +1,6 @@
 from __future__ import absolute_import
 
-from django.contrib.auth.models import AnonymousUser
+from sentry.models import AnonymousUser
 
 
 registry = {}
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 9450bad0dd..f884831df3 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -197,7 +197,7 @@ MIDDLEWARE_CLASSES = (
     'django.middleware.common.CommonMiddleware',
     'django.contrib.sessions.middleware.SessionMiddleware',
     'django.middleware.csrf.CsrfViewMiddleware',
-    'django.contrib.auth.middleware.AuthenticationMiddleware',
+    'sentry.middleware.auth.AuthenticationMiddleware',
     'sentry.middleware.sudo.SudoMiddleware',
     'sentry.middleware.locale.SentryLocaleMiddleware',
     'sentry.middleware.social_auth.SentrySocialAuthExceptionMiddleware',
diff --git a/src/sentry/middleware/auth.py b/src/sentry/middleware/auth.py
new file mode 100644
index 0000000000..c44cff3c3d
--- /dev/null
+++ b/src/sentry/middleware/auth.py
@@ -0,0 +1,13 @@
+from __future__ import absolute_import
+
+from django.contrib.auth import middleware
+
+from sentry.models import AnonymousUser
+
+
+class AuthenticationMiddleware(middleware.AuthenticationMiddleware):
+    def process_request(self, request):
+        super(AuthenticationMiddleware, self).process_request(request)
+        if not request.user.is_authenticated():
+            # swap in our custom class
+            request.user = AnonymousUser()
diff --git a/src/sentry/models/anonymoususer.py b/src/sentry/models/anonymoususer.py
new file mode 100644
index 0000000000..1874be7dfa
--- /dev/null
+++ b/src/sentry/models/anonymoususer.py
@@ -0,0 +1,8 @@
+from __future__ import absolute_import
+
+from django.contrib.auth.models import AnonymousUser as BaseAnonymousUser
+
+
+class AnonymousUser(BaseAnonymousUser):
+    def is_active_superuser(self):
+        return False
diff --git a/src/sentry/web/api.py b/src/sentry/web/api.py
index 60f0a33ef6..8cf27efc57 100644
--- a/src/sentry/web/api.py
+++ b/src/sentry/web/api.py
@@ -12,7 +12,6 @@ import traceback
 
 from datetime import timedelta
 from django.conf import settings
-from django.contrib.auth.models import AnonymousUser
 from django.core.cache import cache
 from django.core.urlresolvers import reverse
 from django.db.models import Sum, Q
@@ -31,7 +30,7 @@ from sentry.coreapi import (
 )
 from sentry.event_manager import EventManager
 from sentry.models import (
-    Group, GroupStatus, Project, TagValue, User
+    AnonymousUser, Group, GroupStatus, Project, TagValue, User
 )
 from sentry.signals import event_received
 from sentry.plugins import plugins
diff --git a/src/sentry/web/frontend/auth_logout.py b/src/sentry/web/frontend/auth_logout.py
index b1ee6c203b..60d138d22b 100644
--- a/src/sentry/web/frontend/auth_logout.py
+++ b/src/sentry/web/frontend/auth_logout.py
@@ -3,6 +3,7 @@ from __future__ import absolute_import, print_function
 from django.core.urlresolvers import reverse
 from django.contrib.auth import logout
 
+from sentry.models import AnonymousUser
 from sentry.web.frontend.base import BaseView
 
 
@@ -11,5 +12,6 @@ class AuthLogoutView(BaseView):
 
     def handle(self, request):
         logout(request)
+        request.user = AnonymousUser()
 
         return self.redirect(reverse('sentry'))
diff --git a/src/sentry/web/helpers.py b/src/sentry/web/helpers.py
index 091a8c26fd..c93c5b6d81 100644
--- a/src/sentry/web/helpers.py
+++ b/src/sentry/web/helpers.py
@@ -10,7 +10,6 @@ from __future__ import absolute_import, print_function
 import logging
 
 from django.conf import settings
-from django.contrib.auth.models import AnonymousUser
 from django.core.urlresolvers import reverse, resolve
 from django.http import HttpResponse
 from django.template import loader, RequestContext, Context
@@ -19,7 +18,7 @@ from django.utils.safestring import mark_safe
 from sentry import options
 from sentry.api.serializers.base import serialize
 from sentry.constants import EVENTS_PER_PAGE
-from sentry.models import Project, Team, ProjectOption
+from sentry.models import AnonymousUser, Project, Team, ProjectOption
 
 logger = logging.getLogger('sentry')
 
diff --git a/tests/sentry/auth/test_access.py b/tests/sentry/auth/test_access.py
index 6ad1fb5ebc..2c22ea5e85 100644
--- a/tests/sentry/auth/test_access.py
+++ b/tests/sentry/auth/test_access.py
@@ -3,7 +3,7 @@ from __future__ import absolute_import
 from mock import Mock
 
 from sentry.auth import access
-from sentry.models import AuthProvider
+from sentry.models import AnonymousUser, AuthProvider
 from sentry.testutils import TestCase
 
 
@@ -76,7 +76,6 @@ class FromUserTest(TestCase):
         assert result.sso_is_valid
 
     def test_anonymous_user(self):
-        from django.contrib.auth.models import AnonymousUser
         user = self.create_user()
         anon_user = AnonymousUser()
         organization = self.create_organization(owner=user)
diff --git a/tests/sentry/web/helpers/tests.py b/tests/sentry/web/helpers/tests.py
index 0122850ae7..f6b29daca6 100644
--- a/tests/sentry/web/helpers/tests.py
+++ b/tests/sentry/web/helpers/tests.py
@@ -4,7 +4,7 @@ from __future__ import absolute_import
 
 import mock
 
-from django.contrib.auth.models import AnonymousUser
+from sentry.models import AnonymousUser
 from sentry.web.helpers import group_is_public
 from sentry.testutils import TestCase
 
