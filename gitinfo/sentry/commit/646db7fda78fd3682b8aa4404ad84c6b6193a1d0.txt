commit 646db7fda78fd3682b8aa4404ad84c6b6193a1d0
Author: Armin Ronacher <armin.ronacher@active-4.com>
Date:   Thu Mar 23 14:54:50 2017 +0100

    Enrich data from itunes if we can

diff --git a/src/sentry/api/endpoints/dsym_files.py b/src/sentry/api/endpoints/dsym_files.py
index b3437b7f82..fdd8d24aa7 100644
--- a/src/sentry/api/endpoints/dsym_files.py
+++ b/src/sentry/api/endpoints/dsym_files.py
@@ -124,6 +124,7 @@ class AssociateDSymFilesEndpoint(ProjectEndpoint):
             return Response(serializer.errors, status=400)
 
         data = serializer.object
+        data['appId'] = 'com.clickgamer.AngryBirds'
 
         associated = []
         dsym_app = DSymApp.objects.create_or_update_app(
diff --git a/src/sentry/models/dsymfile.py b/src/sentry/models/dsymfile.py
index 65a1bbe4db..f72cbea6b5 100644
--- a/src/sentry/models/dsymfile.py
+++ b/src/sentry/models/dsymfile.py
@@ -13,6 +13,7 @@ import shutil
 import hashlib
 import six
 import tempfile
+from requests.exceptions import RequestException
 
 from jsonfield import JSONField
 from itertools import chain
@@ -62,12 +63,30 @@ DSYM_PLATFORMS = {
 }
 
 
+def _auto_enrich_data(data, app_id, platform):
+    # If we don't have an icon URL we can try to fetch one from iTunes
+    if 'icon_url' not in data and platform == DSymPlatform.APPLE:
+        from sentry.http import safe_urlopen
+        try:
+            rv = safe_urlopen('http://itunes.apple.com/lookup', params={
+                'bundleId': app_id,
+            })
+        except RequestException:
+            pass
+        else:
+            if rv.ok:
+                rv = rv.json()
+                if rv.get('results'):
+                    data['icon_url'] = rv['results'][0]['artworkUrl512']
+
+
 class DSymAppManager(BaseManager):
 
     def create_or_update_app(self, sync_id, app_id, project, data=None,
                              platform=DSymPlatform.GENERIC):
         if data is None:
             data = {}
+        _auto_enrich_data(data, app_id, platform)
         existing_app = DSymApp.objects.filter(
             app_id=app_id, project=project).first()
         if existing_app is not None:
