commit 9cffcf7dca5a69a5105c416736c6807f9a33d0df
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Thu Mar 31 10:54:02 2016 -0700

    Disable mail.* options when backend is not smtp based

diff --git a/src/sentry/api/endpoints/system_options.py b/src/sentry/api/endpoints/system_options.py
index 1945af9182..46a6bf0ebc 100644
--- a/src/sentry/api/endpoints/system_options.py
+++ b/src/sentry/api/endpoints/system_options.py
@@ -4,6 +4,7 @@ from rest_framework.response import Response
 
 import sentry
 from sentry import options
+from sentry.utils.email import get_mail_backend
 from sentry.api.base import Endpoint
 from sentry.api.permissions import SuperuserPermission
 
@@ -22,10 +23,26 @@ class SystemOptionsEndpoint(Endpoint):
         else:
             option_list = options.all()
 
+        # This is a fragile, hardcoded list of mail backends, but the likelihood of
+        # someone using something custom here is slim, and even if they did, the worst
+        # is they'd be prompted for SMTP information. These backends are guaranteed
+        # to not need SMTP information.
+        smtp_disabled = get_mail_backend() in (
+            'django.core.mail.backends.dummy.EmailBackend',
+            'django.core.mail.backends.console.EmailBackend',
+            'django.core.mail.backends.locmem.EmailBackend',
+            'django.core.mail.backends.filebased.EmailBackend',
+        )
+
         results = {}
         for k in option_list:
-            # TODO(mattrobenolt): Expose this as a property on Key.
-            diskPriority = bool(k.flags & options.FLAG_PRIORITIZE_DISK and settings.SENTRY_OPTIONS.get(k.name))
+            disabled, disabled_reason = False, None
+
+            if smtp_disabled and k.name[:5] == 'mail.':
+                disabled_reason, disabled = 'smtpDisabled', True
+            elif bool(k.flags & options.FLAG_PRIORITIZE_DISK and settings.SENTRY_OPTIONS.get(k.name)):
+                # TODO(mattrobenolt): Expose this as a property on Key.
+                disabled_reason, disabled = 'diskPriority', True
 
             # TODO(mattrobenolt): help, placeholder, title, type
             results[k.name] = {
@@ -33,9 +50,8 @@ class SystemOptionsEndpoint(Endpoint):
                 'field': {
                     'default': k.default(),
                     'required': bool(k.flags & options.FLAG_REQUIRED),
-                    # We're disabled if the disk has taken priority
-                    'disabled': diskPriority,
-                    'disabledReason': 'diskPriority' if diskPriority else None,
+                    'disabled': disabled,
+                    'disabledReason': disabled_reason,
                     'isSet': options.isset(k.name),
                     'allowEmpty': bool(k.flags & options.FLAG_ALLOW_EMPTY),
 
diff --git a/src/sentry/static/sentry/app/options.jsx b/src/sentry/static/sentry/app/options.jsx
index a1b21cef4d..6f48b725df 100644
--- a/src/sentry/static/sentry/app/options.jsx
+++ b/src/sentry/static/sentry/app/options.jsx
@@ -84,6 +84,7 @@ const definitionsMap = _.indexBy(definitions, 'key');
 
 const disabledReasons = {
   diskPriority: 'This setting is defined in config.yml and may not be changed via the web UI.',
+  smtpDisabled: 'SMTP mail has been disabled, so this option is unavailable',
 };
 
 export function getOption(option) {
