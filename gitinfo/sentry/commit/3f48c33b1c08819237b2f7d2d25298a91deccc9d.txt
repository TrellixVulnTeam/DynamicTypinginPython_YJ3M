commit 3f48c33b1c08819237b2f7d2d25298a91deccc9d
Author: Matt Robenolt <matt@ydekproductions.com>
Date:   Wed Aug 23 13:14:03 2017 -0700

    auth: add feature switch for SAML2

diff --git a/src/sentry/auth/providers/saml2.py b/src/sentry/auth/providers/saml2.py
index 8b610e2682..c56995c46d 100644
--- a/src/sentry/auth/providers/saml2.py
+++ b/src/sentry/auth/providers/saml2.py
@@ -14,7 +14,9 @@ from sentry.utils.auth import login, get_login_redirect
 
 try:
     from onelogin.saml2.auth import OneLogin_Saml2_Auth, OneLogin_Saml2_Settings
+    HAS_SAML2 = True
 except ImportError:
+    HAS_SAML2 = False
 
     def OneLogin_Saml2_Auth(*args, **kwargs):
         raise NotImplementedError('Missing SAML libraries')
diff --git a/src/sentry/conf/server.py b/src/sentry/conf/server.py
index 2fbcf2e2e8..85bc942ddb 100644
--- a/src/sentry/conf/server.py
+++ b/src/sentry/conf/server.py
@@ -712,6 +712,7 @@ SENTRY_FEATURES = {
     'organizations:api-keys': False,
     'organizations:create': True,
     'organizations:sso': True,
+    'organizations:saml2': False,
     'organizations:callsigns': True,
     'organizations:group-unmerge': False,
     'organizations:integrations-v3': False,
diff --git a/src/sentry/features/__init__.py b/src/sentry/features/__init__.py
index 6b3b9721dc..73962b9965 100644
--- a/src/sentry/features/__init__.py
+++ b/src/sentry/features/__init__.py
@@ -9,6 +9,7 @@ default_manager.add('auth:register')
 default_manager.add('organizations:api-keys', OrganizationFeature)  # NOQA
 default_manager.add('organizations:create')
 default_manager.add('organizations:sso', OrganizationFeature)  # NOQA
+default_manager.add('organizations:saml2', OrganizationFeature)  # NOQA
 default_manager.add('organizations:onboarding', OrganizationFeature)  # NOQA
 default_manager.add('organizations:callsigns', OrganizationFeature)  # NOQA
 default_manager.add('organizations:repos', OrganizationFeature)  # NOQA
diff --git a/src/sentry/web/frontend/organization_auth_settings.py b/src/sentry/web/frontend/organization_auth_settings.py
index 4ce8f850f8..c77e50bbbf 100644
--- a/src/sentry/web/frontend/organization_auth_settings.py
+++ b/src/sentry/web/frontend/organization_auth_settings.py
@@ -11,6 +11,7 @@ from django.utils.translation import ugettext_lazy as _
 from sentry import features, roles
 from sentry.auth import manager
 from sentry.auth.helper import AuthHelper
+from sentry.auth.providers.saml2 import SAML2Provider, HAS_SAML2
 from sentry.models import AuditLogEntryEvent, AuthProvider, OrganizationMember
 from sentry.plugins import Response
 from sentry.tasks.auth import email_missing_links
@@ -190,8 +191,18 @@ class OrganizationAuthSettingsView(OrganizationView):
             # render first time setup view
             return self.handle_provider_setup(request, organization, provider_key)
 
+        provider_list = []
+
+        for k, v in manager:
+            if issubclass(v, SAML2Provider):
+                if not HAS_SAML2:
+                    continue
+                if not features.has('organizations:saml2', organization, actor=request.user):
+                    continue
+            provider_list.append((k, v.name))
+
         context = {
-            'provider_list': [(k, v.name) for k, v in manager],
+            'provider_list': provider_list,
         }
 
         return self.respond('sentry/organization-auth-settings.html', context)
