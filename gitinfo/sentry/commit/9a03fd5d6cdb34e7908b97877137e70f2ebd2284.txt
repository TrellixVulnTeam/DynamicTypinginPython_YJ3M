commit 9a03fd5d6cdb34e7908b97877137e70f2ebd2284
Author: Daniel Griesser <daniel.griesser.86@gmail.com>
Date:   Wed May 23 10:16:45 2018 +0200

    feat: Add assertWriteQueries to test queries against a table (#8446)

diff --git a/requirements-test.txt b/requirements-test.txt
index 98b2c8d72f..3e8395933c 100644
--- a/requirements-test.txt
+++ b/requirements-test.txt
@@ -11,3 +11,4 @@ pytest-cov>=2.5.1,<2.6.0
 pytest-timeout==1.2.1
 pytest-xdist>=1.18.0,<1.19.0
 responses>=0.8.1,<0.9.0
+sqlparse==0.2.4
diff --git a/src/sentry/testutils/cases.py b/src/sentry/testutils/cases.py
index 4259bf8754..1b6c035ec9 100644
--- a/src/sentry/testutils/cases.py
+++ b/src/sentry/testutils/cases.py
@@ -33,8 +33,10 @@ from django.contrib.auth.models import AnonymousUser
 from django.core import signing
 from django.core.cache import cache
 from django.core.urlresolvers import reverse
+from django.db import connections, DEFAULT_DB_ALIAS
 from django.http import HttpRequest
 from django.test import TestCase, TransactionTestCase
+from django.test.utils import CaptureQueriesContext
 from django.utils import timezone
 from django.utils.importlib import import_module
 from exam import before, fixture, Exam
@@ -59,7 +61,9 @@ from sentry.utils import json
 from sentry.utils.auth import SSO_SESSION_KEY
 
 from .fixtures import Fixtures
-from .helpers import AuthProvider, Feature, get_auth_header, TaskRunner, override_options
+from .helpers import (
+    AuthProvider, Feature, get_auth_header, TaskRunner, override_options, parse_queries
+)
 
 DEFAULT_USER_AGENT = 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36'
 
@@ -308,6 +312,62 @@ class BaseTestCase(Fixtures, Exam):
             microsecond=0) == original_object.date_added.replace(microsecond=0)
         assert deleted_log.date_deleted >= deleted_log.date_created
 
+    def assertWriteQueries(self, queries, debug=False, *args, **kwargs):
+        func = kwargs.pop('func', None)
+        using = kwargs.pop("using", DEFAULT_DB_ALIAS)
+        conn = connections[using]
+
+        context = _AssertQueriesContext(self, queries, debug, conn)
+        if func is None:
+            return context
+
+        with context:
+            func(*args, **kwargs)
+
+
+class _AssertQueriesContext(CaptureQueriesContext):
+    def __init__(self, test_case, queries, debug, connection):
+        self.test_case = test_case
+        self.queries = queries
+        self.debug = debug
+        super(_AssertQueriesContext, self).__init__(connection)
+
+    def __exit__(self, exc_type, exc_value, traceback):
+        super(_AssertQueriesContext, self).__exit__(exc_type, exc_value, traceback)
+        if exc_type is not None:
+            return
+
+        parsed_queries = parse_queries(self.captured_queries)
+
+        if (self.debug):
+            import pprint
+            pprint.pprint("====================== Raw Queries ======================")
+            pprint.pprint(self.captured_queries)
+            pprint.pprint("====================== Table writes ======================")
+            pprint.pprint(parsed_queries)
+
+        for table, num in parsed_queries.items():
+            expected = self.queries.get(table, 0)
+            if expected == 0:
+                import pprint
+                pprint.pprint("WARNING: no query against %s emitted, add debug=True to see all the queries" % (
+                    table
+                ))
+            else:
+                self.test_case.assertTrue(
+                    num == expected, "%d write queries expected on `%s`, got %d, add debug=True to see all the queries" % (
+                        expected, table, num
+                    )
+                )
+
+        for table, num in self.queries.items():
+            executed = parsed_queries.get(table, None)
+            self.test_case.assertFalse(
+                executed is None, "no query against %s emitted, add debug=True to see all the queries" % (
+                    table
+                )
+            )
+
 
 class TestCase(BaseTestCase, TestCase):
     pass
diff --git a/src/sentry/testutils/helpers/__init__.py b/src/sentry/testutils/helpers/__init__.py
index da7e910641..f2f3433784 100644
--- a/src/sentry/testutils/helpers/__init__.py
+++ b/src/sentry/testutils/helpers/__init__.py
@@ -13,3 +13,4 @@ from .features import *  # NOQA
 from .link_header import *  # NOQA
 from .task_runner import *  # NOQA
 from .options import *  # NOQA
+from .query import *  # NOQA
diff --git a/src/sentry/testutils/helpers/query.py b/src/sentry/testutils/helpers/query.py
new file mode 100644
index 0000000000..9974787b97
--- /dev/null
+++ b/src/sentry/testutils/helpers/query.py
@@ -0,0 +1,36 @@
+from __future__ import absolute_import
+
+import sqlparse
+import re
+import ast
+
+from sqlparse.tokens import DML
+
+
+__all__ = ('parse_queries', )
+
+
+def parse_queries(captured_queries):
+    write_ops = ['INSERT', 'UPDATE', 'DELETE']
+
+    real_queries = {}
+
+    for query in captured_queries:
+        raw_sql = query['sql']
+        match = re.search(r"QUERY = (.+) - PARAMS", query['sql'])
+        if match:  # this is a sqlite query
+            raw_sql = ast.literal_eval(match.group(1))
+        parsed = sqlparse.parse(raw_sql)
+        for token in parsed[0].tokens:
+            if token.ttype is DML:
+                if token.value.upper() in write_ops:
+                    table_name = parsed[0].get_real_name()
+                    if parsed[0].get_real_name() == "*":  # DELETE * FROM ...
+                        table_name = parsed[0].get_name()
+                    # there is ` in mysql queries
+                    table_name = table_name.replace('`', '')
+                    if real_queries.get(table_name) is None:
+                        real_queries[table_name] = 0
+                    real_queries[table_name] += 1
+
+    return real_queries
diff --git a/tests/sentry/db/test_parse_query.py b/tests/sentry/db/test_parse_query.py
new file mode 100644
index 0000000000..4093bf069a
--- /dev/null
+++ b/tests/sentry/db/test_parse_query.py
@@ -0,0 +1,279 @@
+from __future__ import absolute_import
+
+from sentry.testutils import TestCase
+from sentry.testutils.helpers import parse_queries
+
+
+class ParseQuery(TestCase):
+    def test_parse_query(self):
+        result = parse_queries(
+            [
+                {u'sql': u'QUERY = u\'INSERT INTO "sentry_useremail" ("user_id", "email", "validation_hash", "date_hash_added", "is_verified") VALUES (%s, %s, %s, %s, %s)\' - PARAMS = (1, u\'admin@localhost\', u\'i0NlOcwzPKoObK8uNfg7mowTlOnvvlSI\', u\'2018-05-16 08:02:39.022342\', False)',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'INSERT INTO "sentry_email" ("email", "date_added") VALUES (%s, %s)\' - PARAMS = (u\'admin@localhost\', u\'2018-05-16 08:02:39.023101\')',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'UPDATE "sentry_useremail" SET "is_verified" = %s WHERE ("sentry_useremail"."user_id" = %s  AND "sentry_useremail"."email" = %s )\' - PARAMS = (True, 1, u\'admin@localhost\')',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'DELETE * FROM "sentry_organization"\' - PARAMS = (u\'baz\', u\'baz\', 0, u\'2018-05-16 08:02:39.025899\', u\'member\', 1)',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'INSERT INTO "sentry_organizationmember" ("organization_id", "user_id", "email", "role", "flags", "token", "date_added", "has_global_access", "type") VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s)\' - PARAMS = (2, 1, None, u\'owner\', 0, None, u\'2018-05-16 08:02:39.026919\', True, 50)',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'UPDATE "sentry_projectoptions" SET "value" = %s WHERE ("sentry_projectoptions"."project_id" = %s  AND "sentry_projectoptions"."key" = %s )\' - PARAMS = (u\'gAJYIAAAADgwNmQxZjQ1NThkZjExZTg5ZWExOGM4NTkwMGNhNWI3cQEu\', 2, u\'sentry:relay-rev\')',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'UPDATE "sentry_projectoptions" SET "value" = %s WHERE ("sentry_projectoptions"."project_id" = %s  AND "sentry_projectoptions"."key" = %s )\' - PARAMS = (u\'gAJjZGF0ZXRpbWUKZGF0ZXRpbWUKcQFVCgfiBRAIAicApBhjcHl0egpfVVRDCnECKVJxA4ZScQQu\', 2, u\'sentry:relay-rev-lastchange\')',
+                 u'time': u'0.000'},
+                {u'sql': u"QUERY = '\\n                insert or ignore into sentry_projectcounter\\n                  (project_id, value) values (%s, 0);\\n            ' - PARAMS = (2,)",
+                 u'time': u'0.000'},
+                {u'sql': u"QUERY = '\\n                select value from sentry_projectcounter\\n                 where project_id = %s\\n            ' - PARAMS = (2,)",
+                 u'time': u'0.000'},
+                {u'sql': u"QUERY = '\\n                    update sentry_projectcounter\\n                       set value = value + %s\\n                     where project_id = %s;\\n                ' - PARAMS = (1, 2)",
+                 u'time': u'0.000'},
+                {u'sql': u"QUERY = '\\n                    select changes();\\n                ' - PARAMS = ()",
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'INSERT INTO "sentry_groupedmessage" ("project_id", "logger", "level", "message", "view", "num_comments", "platform", "status", "times_seen", "last_seen", "first_seen", "first_release_id", "resolved_at", "active_at", "time_spent_total", "time_spent_count", "score", "is_public", "data", "short_id") VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)\' - PARAMS = (2, u\'\', 40, u\'hello http://example.com\', u\'http://example.com\', 0, u\'javascript\', 0, 1, u\'2018-05-16 08:02:39\', u\'2018-05-16 08:02:39\', None, None, u\'2018-05-16 08:02:39\', 0, 0, 1526457759, False, u\'eJwVykEKg0AMheF9LjKuCk4dx16gFxDcSmgiHYgYOrHg7c0s//e+jrSHOQhWW3/84fJnCqAR3n2K45ByTi+oc7BL2fenW+INTzGvoT07GxIaeifoSEcnVkwaz7B8WeQAnaDWxw3kwCAZ\', 1)',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'UPDATE "sentry_grouphash" SET "group_id" = %s WHERE ("sentry_grouphash"."id" IN (%s) AND NOT ("sentry_grouphash"."state" = %s  AND "sentry_grouphash"."state" IS NOT NULL))\' - PARAMS = (1, 1, 1)',
+                 u'time': u'0.000'},
+                {u'sql': u'QUERY = u\'UPDATE "sentry_userreport" SET "environment_id" = %s, "group_id" = %s WHERE ("sentry_userreport"."project_id" = %s  AND "sentry_userreport"."event_id" = %s )\' - PARAMS = (1, 1, 2, u\'45b41f6d313c442393aaa0293853d70f\')',
+                 u'time': u'0.000'}]
+        )
+
+        assert result == {
+            'sentry_email': 1,
+            'sentry_groupedmessage': 1,
+            'sentry_grouphash': 1,
+            'sentry_organization': 1,
+            'sentry_organizationmember': 1,
+            'sentry_projectcounter': 2,
+            'sentry_projectoptions': 2,
+            'sentry_useremail': 2,
+            'sentry_userreport': 1
+        }
+
+    def test_parse_mysql_queries(self):
+        result = parse_queries(
+            [{u'sql': u'SAVEPOINT `s47055674149248_x49`', u'time': u'0.000'},
+             {u'sql': u'RELEASE SAVEPOINT `s47055674149248_x49`', u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_rawevent`.`id`, `sentry_rawevent`.`project_id`, `sentry_rawevent`.`event_id`, `sentry_rawevent`.`datetime`, `sentry_rawevent`.`data` FROM `sentry_rawevent` WHERE (`sentry_rawevent`.`event_id` = '1fa6e7d1c2674273be07852952e1bafc'  AND `sentry_rawevent`.`project_id` = 815 )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_reprocessingreport`.`id`, `sentry_reprocessingreport`.`project_id`, `sentry_reprocessingreport`.`event_id`, `sentry_reprocessingreport`.`datetime` FROM `sentry_reprocessingreport` WHERE (`sentry_reprocessingreport`.`event_id` = '1fa6e7d1c2674273be07852952e1bafc'  AND `sentry_reprocessingreport`.`project_id` = 815 )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_message`.`id`, `sentry_message`.`group_id`, `sentry_message`.`message_id`, `sentry_message`.`project_id`, `sentry_message`.`message`, `sentry_message`.`platform`, `sentry_message`.`datetime`, `sentry_message`.`time_spent`, `sentry_message`.`data` FROM `sentry_message` WHERE (`sentry_message`.`message_id` = '1fa6e7d1c2674273be07852952e1bafc'  AND `sentry_message`.`project_id` = 815 )",
+              u'time': u'0.000'},
+             {u'sql': u'SAVEPOINT `s47055674149248_x50`', u'time': u'0.000'},
+             {u'sql': u"INSERT INTO `sentry_eventuser` (`project_id`, `hash`, `ident`, `email`, `username`, `name`, `ip_address`, `date_added`) VALUES (815, 'f528764d624db129b32c21fbca0cb8d6', NULL, NULL, NULL, NULL, '127.0.0.1', '2018-05-22 10:54:14')",
+              u'time': u'0.000'},
+             {u'sql': u'ROLLBACK TO SAVEPOINT `s47055674149248_x50`', u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_eventuser`.`id`, `sentry_eventuser`.`project_id`, `sentry_eventuser`.`hash`, `sentry_eventuser`.`ident`, `sentry_eventuser`.`email`, `sentry_eventuser`.`username`, `sentry_eventuser`.`name`, `sentry_eventuser`.`ip_address`, `sentry_eventuser`.`date_added` FROM `sentry_eventuser` WHERE (`sentry_eventuser`.`project_id` = 815  AND `sentry_eventuser`.`hash` = 'f528764d624db129b32c21fbca0cb8d6' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_grouphash`.`id`, `sentry_grouphash`.`project_id`, `sentry_grouphash`.`hash`, `sentry_grouphash`.`group_id`, `sentry_grouphash`.`group_tombstone_id`, `sentry_grouphash`.`state` FROM `sentry_grouphash` WHERE (`sentry_grouphash`.`project_id` = 815  AND `sentry_grouphash`.`hash` = '5d41402abc4b2a76b9719d911017c592' )",
+              u'time': u'0.000'},
+             {u'sql': u'SELECT `sentry_groupedmessage`.`id`, `sentry_groupedmessage`.`project_id`, `sentry_groupedmessage`.`logger`, `sentry_groupedmessage`.`level`, `sentry_groupedmessage`.`message`, `sentry_groupedmessage`.`view`, `sentry_groupedmessage`.`num_comments`, `sentry_groupedmessage`.`platform`, `sentry_groupedmessage`.`status`, `sentry_groupedmessage`.`times_seen`, `sentry_groupedmessage`.`last_seen`, `sentry_groupedmessage`.`first_seen`, `sentry_groupedmessage`.`first_release_id`, `sentry_groupedmessage`.`resolved_at`, `sentry_groupedmessage`.`active_at`, `sentry_groupedmessage`.`time_spent_total`, `sentry_groupedmessage`.`time_spent_count`, `sentry_groupedmessage`.`score`, `sentry_groupedmessage`.`is_public`, `sentry_groupedmessage`.`data`, `sentry_groupedmessage`.`short_id` FROM `sentry_groupedmessage` WHERE `sentry_groupedmessage`.`id` = 592 ',
+              u'time': u'0.001'},
+             {u'sql': u'SELECT `sentry_project`.`id`, `sentry_project`.`slug`, `sentry_project`.`name`, `sentry_project`.`forced_color`, `sentry_project`.`organization_id`, `sentry_project`.`public`, `sentry_project`.`date_added`, `sentry_project`.`status`, `sentry_project`.`first_event`, `sentry_project`.`flags`, `sentry_project`.`platform` FROM `sentry_project` WHERE `sentry_project`.`id` = 815 ',
+              u'time': u'0.000'},
+             {u'sql': u"UPDATE `sentry_groupedmessage` SET `times_seen` = `sentry_groupedmessage`.`times_seen` + 1, `score` = log(times_seen) * 600 + unix_timestamp(last_seen), `data` = 'eJwdyk0Kg0AMhuF9LjKuBH9mHC/gBQS3JZgUB1IanCj09k27fL/vaUg7WINgtcfJO5ebKYD2sHSxT3NOYxyhrsE+yr4PbomfeIl5/Z8XGxIaekdoSJMTKyY/PsF2sMgbNEOt7RfkkiAY', `last_seen` = '2018-05-22 10:54:14' WHERE `sentry_groupedmessage`.`id` = 592 ",
+              u'time': u'0.000'},
+             {u'sql': u'SAVEPOINT `s47055674149248_x51`', u'time': u'0.000'},
+             {u'sql': u'INSERT INTO `sentry_environmentproject` (`project_id`, `environment_id`, `is_hidden`) VALUES (815, 96, NULL)',
+              u'time': u'0.000'},
+             {u'sql': u'ROLLBACK TO SAVEPOINT `s47055674149248_x51`', u'time': u'0.000'},
+             {u'sql': u"UPDATE `sentry_userreport` SET `environment_id` = 96, `group_id` = 592 WHERE (`sentry_userreport`.`project_id` = 815  AND `sentry_userreport`.`event_id` = '1fa6e7d1c2674273be07852952e1bafc' )",
+              u'time': u'0.000'},
+             {u'sql': u'SAVEPOINT `s47055674149248_x52`', u'time': u'0.000'},
+             {u'sql': u"UPDATE `nodestore_node` SET `timestamp` = '2018-05-22 10:54:14', `data` = 'eJxtU01v2zAMvetX6BYX2BxLtmSnOxUDtgz92CFdcgxUm3G0OLEgK127ov99pOKmOxQBjJB8pKj3npLGCbaYON//hjpMmJPsphLqhg2LyQCH4J9TewjgN6aGIf01gEdMzpLGFdhm3do0jYdhwKzChJBlmuFPYKzZ8OGQW4SbFhBR0pwK2/bn1Iwtt9B1PXMii/3wFLzBghAEFpIWW3vYrB/BD7Y/UClnP+THC89DcIQoYjNtePQdJTSeg7XL6RSezN51kNb9HvMlzdmCaXA64SqWdE7M6CsztiQCPl+1eA4yJZhZ3vZ/bdeZqUoznqzsoen/DPzunutUfuGrnytdXPArh/NX8HBtw1TlZZprnlzP729vPvHO7oB/h3rXX/CvW9/vYSor4k9lWVpKvjAb4+3YhUdKZgyxUvd4x6dAK8qohiQ5+hirGGuM3ymSJbvDtoPZE8mSOH9btqLELHL94DFxUjijIblgLXYuJuedqIRUt3HCaWFK5diO/Rt7aME7jwJQtiDWciL95YU3sDHHLvDXVyppZkYdKSr/81yzo0wVj59ha91ZZHttScYiY60m1PvFCsGWZLgM/0YPjFcscrZcu34IKxu286gnJot4TQ812EdoCKbYN6GknlW6UAX1g/d9lL7QtH4RDRFMG1PRDQW6YTHp4BHISSpjYxMFggWnUKTkzWgq/9hoeBgiVUSebHt5PFGv0JrWXZ5fEuHKiOuH9HS75Vk7KlaxOGo3IpzCh3TSBx9ihjCNbk1a1HVM87OmVMSVh5a4jPTu4HltiR6dozJSRmXCs6PBmow2ikmhotoegmlMoHeqNUmnyTXBhi62VKyNrzn9By1kSX8=' WHERE `nodestore_node`.`id` = '9cwO83agTCqM5QNjewZF+g==' ",
+              u'time': u'0.000'},
+             {u'sql': u'SAVEPOINT `s47055674149248_x53`', u'time': u'0.000'},
+             {u'sql': u"INSERT INTO `nodestore_node` (`id`, `data`, `timestamp`) VALUES ('9cwO83agTCqM5QNjewZF+g==', 'eJxtU01v2zAMvetX6BYX2BxLtmSnOxUDtgz92CFdcgxUm3G0OLEgK127ov99pOKmOxQBjJB8pKj3npLGCbaYON//hjpMmJPsphLqhg2LyQCH4J9TewjgN6aGIf01gEdMzpLGFdhm3do0jYdhwKzChJBlmuFPYKzZ8OGQW4SbFhBR0pwK2/bn1Iwtt9B1PXMii/3wFLzBghAEFpIWW3vYrB/BD7Y/UClnP+THC89DcIQoYjNtePQdJTSeg7XL6RSezN51kNb9HvMlzdmCaXA64SqWdE7M6CsztiQCPl+1eA4yJZhZ3vZ/bdeZqUoznqzsoen/DPzunutUfuGrnytdXPArh/NX8HBtw1TlZZprnlzP729vPvHO7oB/h3rXX/CvW9/vYSor4k9lWVpKvjAb4+3YhUdKZgyxUvd4x6dAK8qohiQ5+hirGGuM3ymSJbvDtoPZE8mSOH9btqLELHL94DFxUjijIblgLXYuJuedqIRUt3HCaWFK5diO/Rt7aME7jwJQtiDWciL95YU3sDHHLvDXVyppZkYdKSr/81yzo0wVj59ha91ZZHttScYiY60m1PvFCsGWZLgM/0YPjFcscrZcu34IKxu286gnJot4TQ812EdoCKbYN6GknlW6UAX1g/d9lL7QtH4RDRFMG1PRDQW6YTHp4BHISSpjYxMFggWnUKTkzWgq/9hoeBgiVUSebHt5PFGv0JrWXZ5fEuHKiOuH9HS75Vk7KlaxOGo3IpzCh3TSBx9ihjCNbk1a1HVM87OmVMSVh5a4jPTu4HltiR6dozJSRmXCs6PBmow2ikmhotoegmlMoHeqNUmnyTXBhi62VKyNrzn9By1kSX8=', '2018-05-22 10:54:14')",
+              u'time': u'0.000'},
+             {u'sql': u'RELEASE SAVEPOINT `s47055674149248_x53`', u'time': u'0.000'},
+             {u'sql': u"INSERT INTO `sentry_message` (`group_id`, `message_id`, `project_id`, `message`, `platform`, `datetime`, `time_spent`, `data`) VALUES (592, '1fa6e7d1c2674273be07852952e1bafc', 815, 'hello http://example.com', 'javascript', '2018-05-22 10:54:14', NULL, 'eJzTSCkw5ApWz8tPSY3PTFHnKjAC8iyTy/0tjBPTQ5wLfU0D/bJSy6PctNNtbYHSxlzFegCVlg8K')",
+              u'time': u'0.000'},
+             {u'sql': u'RELEASE SAVEPOINT `s47055674149248_x52`', u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filterkey`.`id`, `sentry_filterkey`.`project_id`, `sentry_filterkey`.`key`, `sentry_filterkey`.`values_seen`, `sentry_filterkey`.`label`, `sentry_filterkey`.`status` FROM `sentry_filterkey` WHERE (`sentry_filterkey`.`project_id` = 815  AND `sentry_filterkey`.`key` = 'level' )",
+              u'time': u'0.001'},
+             {u'sql': u"SELECT `sentry_filtervalue`.`id`, `sentry_filtervalue`.`project_id`, `sentry_filtervalue`.`key`, `sentry_filtervalue`.`value`, `sentry_filtervalue`.`data`, `sentry_filtervalue`.`times_seen`, `sentry_filtervalue`.`last_seen`, `sentry_filtervalue`.`first_seen` FROM `sentry_filtervalue` WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'error'  AND `sentry_filtervalue`.`key` = 'level' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filterkey`.`id`, `sentry_filterkey`.`project_id`, `sentry_filterkey`.`key`, `sentry_filterkey`.`values_seen`, `sentry_filterkey`.`label`, `sentry_filterkey`.`status` FROM `sentry_filterkey` WHERE (`sentry_filterkey`.`project_id` = 815  AND `sentry_filterkey`.`key` = 'url' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filtervalue`.`id`, `sentry_filtervalue`.`project_id`, `sentry_filtervalue`.`key`, `sentry_filtervalue`.`value`, `sentry_filtervalue`.`data`, `sentry_filtervalue`.`times_seen`, `sentry_filtervalue`.`last_seen`, `sentry_filtervalue`.`first_seen` FROM `sentry_filtervalue` WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'http://example.com'  AND `sentry_filtervalue`.`key` = 'url' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filterkey`.`id`, `sentry_filterkey`.`project_id`, `sentry_filterkey`.`key`, `sentry_filterkey`.`values_seen`, `sentry_filterkey`.`label`, `sentry_filterkey`.`status` FROM `sentry_filterkey` WHERE (`sentry_filterkey`.`project_id` = 815  AND `sentry_filterkey`.`key` = 'sentry:user' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filtervalue`.`id`, `sentry_filtervalue`.`project_id`, `sentry_filtervalue`.`key`, `sentry_filtervalue`.`value`, `sentry_filtervalue`.`data`, `sentry_filtervalue`.`times_seen`, `sentry_filtervalue`.`last_seen`, `sentry_filtervalue`.`first_seen` FROM `sentry_filtervalue` WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'ip:127.0.0.1'  AND `sentry_filtervalue`.`key` = 'sentry:user' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filterkey`.`id`, `sentry_filterkey`.`project_id`, `sentry_filterkey`.`key`, `sentry_filterkey`.`values_seen`, `sentry_filterkey`.`label`, `sentry_filterkey`.`status` FROM `sentry_filterkey` WHERE (`sentry_filterkey`.`project_id` = 815  AND `sentry_filterkey`.`key` = 'os.name' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filtervalue`.`id`, `sentry_filtervalue`.`project_id`, `sentry_filtervalue`.`key`, `sentry_filtervalue`.`value`, `sentry_filtervalue`.`data`, `sentry_filtervalue`.`times_seen`, `sentry_filtervalue`.`last_seen`, `sentry_filtervalue`.`first_seen` FROM `sentry_filtervalue` WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'Windows 8'  AND `sentry_filtervalue`.`key` = 'os.name' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filterkey`.`id`, `sentry_filterkey`.`project_id`, `sentry_filterkey`.`key`, `sentry_filterkey`.`values_seen`, `sentry_filterkey`.`label`, `sentry_filterkey`.`status` FROM `sentry_filterkey` WHERE (`sentry_filterkey`.`project_id` = 815  AND `sentry_filterkey`.`key` = 'browser.name' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filtervalue`.`id`, `sentry_filtervalue`.`project_id`, `sentry_filtervalue`.`key`, `sentry_filtervalue`.`value`, `sentry_filtervalue`.`data`, `sentry_filtervalue`.`times_seen`, `sentry_filtervalue`.`last_seen`, `sentry_filtervalue`.`first_seen` FROM `sentry_filtervalue` WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'Chrome'  AND `sentry_filtervalue`.`key` = 'browser.name' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filterkey`.`id`, `sentry_filterkey`.`project_id`, `sentry_filterkey`.`key`, `sentry_filterkey`.`values_seen`, `sentry_filterkey`.`label`, `sentry_filterkey`.`status` FROM `sentry_filterkey` WHERE (`sentry_filterkey`.`project_id` = 815  AND `sentry_filterkey`.`key` = 'browser' )",
+              u'time': u'0.000'},
+             {u'sql': u"SELECT `sentry_filtervalue`.`id`, `sentry_filtervalue`.`project_id`, `sentry_filtervalue`.`key`, `sentry_filtervalue`.`value`, `sentry_filtervalue`.`data`, `sentry_filtervalue`.`times_seen`, `sentry_filtervalue`.`last_seen`, `sentry_filtervalue`.`first_seen` FROM `sentry_filtervalue` WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'Chrome 28.0.1500'  AND `sentry_filtervalue`.`key` = 'browser' )",
+              u'time': u'0.000'},
+             {u'sql': u'SAVEPOINT `s47055674149248_x54`', u'time': u'0.000'},
+             {u'sql': u"INSERT INTO `sentry_eventtag` (`project_id`, `group_id`, `event_id`, `key_id`, `value_id`, `date_added`) VALUES (815, 592, 373, 43, 42, '2018-05-22 10:54:14'), (815, 592, 373, 44, 43, '2018-05-22 10:54:14'), (815, 592, 373, 45, 44, '2018-05-22 10:54:14'), (815, 592, 373, 46, 45, '2018-05-22 10:54:14'), (815, 592, 373, 47, 46, '2018-05-22 10:54:14'), (815, 592, 373, 48, 47, '2018-05-22 10:54:14')",
+              u'time': u'0.000'},
+             {u'sql': u'RELEASE SAVEPOINT `s47055674149248_x54`', u'time': u'0.000'},
+             {u'sql': u"UPDATE `sentry_filtervalue` SET `times_seen` = `sentry_filtervalue`.`times_seen` + 1, `data` = NULL, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'error'  AND `sentry_filtervalue`.`key` = 'level' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_messagefiltervalue` SET `times_seen` = `sentry_messagefiltervalue`.`times_seen` + 1, `project_id` = 815, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_messagefiltervalue`.`group_id` = 592  AND `sentry_messagefiltervalue`.`value` = 'error'  AND `sentry_messagefiltervalue`.`key` = 'level' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_filtervalue` SET `times_seen` = `sentry_filtervalue`.`times_seen` + 1, `data` = NULL, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'http://example.com'  AND `sentry_filtervalue`.`key` = 'url' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_messagefiltervalue` SET `times_seen` = `sentry_messagefiltervalue`.`times_seen` + 1, `project_id` = 815, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_messagefiltervalue`.`group_id` = 592  AND `sentry_messagefiltervalue`.`value` = 'http://example.com'  AND `sentry_messagefiltervalue`.`key` = 'url' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_filtervalue` SET `times_seen` = `sentry_filtervalue`.`times_seen` + 1, `data` = NULL, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'ip:127.0.0.1'  AND `sentry_filtervalue`.`key` = 'sentry:user' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_messagefiltervalue` SET `times_seen` = `sentry_messagefiltervalue`.`times_seen` + 1, `project_id` = 815, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_messagefiltervalue`.`group_id` = 592  AND `sentry_messagefiltervalue`.`value` = 'ip:127.0.0.1'  AND `sentry_messagefiltervalue`.`key` = 'sentry:user' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_filtervalue` SET `times_seen` = `sentry_filtervalue`.`times_seen` + 1, `data` = NULL, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'Windows 8'  AND `sentry_filtervalue`.`key` = 'os.name' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_messagefiltervalue` SET `times_seen` = `sentry_messagefiltervalue`.`times_seen` + 1, `project_id` = 815, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_messagefiltervalue`.`group_id` = 592  AND `sentry_messagefiltervalue`.`value` = 'Windows 8'  AND `sentry_messagefiltervalue`.`key` = 'os.name' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_filtervalue` SET `times_seen` = `sentry_filtervalue`.`times_seen` + 1, `data` = NULL, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'Chrome'  AND `sentry_filtervalue`.`key` = 'browser.name' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_messagefiltervalue` SET `times_seen` = `sentry_messagefiltervalue`.`times_seen` + 1, `project_id` = 815, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_messagefiltervalue`.`group_id` = 592  AND `sentry_messagefiltervalue`.`value` = 'Chrome'  AND `sentry_messagefiltervalue`.`key` = 'browser.name' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_filtervalue` SET `times_seen` = `sentry_filtervalue`.`times_seen` + 1, `data` = NULL, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_filtervalue`.`project_id` = 815  AND `sentry_filtervalue`.`value` = 'Chrome 28.0.1500'  AND `sentry_filtervalue`.`key` = 'browser' )",
+              u'time': u'0.001'},
+             {u'sql': u"UPDATE `sentry_messagefiltervalue` SET `times_seen` = `sentry_messagefiltervalue`.`times_seen` + 1, `project_id` = 815, `last_seen` = '2018-05-22 10:54:14' WHERE (`sentry_messagefiltervalue`.`group_id` = 592  AND `sentry_messagefiltervalue`.`value` = 'Chrome 28.0.1500'  AND `sentry_messagefiltervalue`.`key` = 'browser' )",
+              u'time': u'0.001'},
+             {u'sql': u'SELECT `sentry_groupedmessage`.`id`, `sentry_groupedmessage`.`project_id`, `sentry_groupedmessage`.`logger`, `sentry_groupedmessage`.`level`, `sentry_groupedmessage`.`message`, `sentry_groupedmessage`.`view`, `sentry_groupedmessage`.`num_comments`, `sentry_groupedmessage`.`platform`, `sentry_groupedmessage`.`status`, `sentry_groupedmessage`.`times_seen`, `sentry_groupedmessage`.`last_seen`, `sentry_groupedmessage`.`first_seen`, `sentry_groupedmessage`.`first_release_id`, `sentry_groupedmessage`.`resolved_at`, `sentry_groupedmessage`.`active_at`, `sentry_groupedmessage`.`time_spent_total`, `sentry_groupedmessage`.`time_spent_count`, `sentry_groupedmessage`.`score`, `sentry_groupedmessage`.`is_public`, `sentry_groupedmessage`.`data`, `sentry_groupedmessage`.`short_id` FROM `sentry_groupedmessage` WHERE `sentry_groupedmessage`.`id` = 592 ',
+              u'time': u'0.001'},
+             {u'sql': u'SELECT `sentry_groupsnooze`.`id`, `sentry_groupsnooze`.`group_id`, `sentry_groupsnooze`.`until`, `sentry_groupsnooze`.`count`, `sentry_groupsnooze`.`window`, `sentry_groupsnooze`.`user_count`, `sentry_groupsnooze`.`user_window`, `sentry_groupsnooze`.`state`, `sentry_groupsnooze`.`actor_id` FROM `sentry_groupsnooze` WHERE `sentry_groupsnooze`.`group_id` = 592 ',
+              u'time': u'0.000'},
+             {u'sql': u'SELECT `sentry_grouprulestatus`.`id`, `sentry_grouprulestatus`.`project_id`, `sentry_grouprulestatus`.`rule_id`, `sentry_grouprulestatus`.`group_id`, `sentry_grouprulestatus`.`status`, `sentry_grouprulestatus`.`date_added`, `sentry_grouprulestatus`.`last_active` FROM `sentry_grouprulestatus` WHERE (`sentry_grouprulestatus`.`group_id` = 592  AND `sentry_grouprulestatus`.`rule_id` = 827 )',
+              u'time': u'0.001'},
+             {u'sql': u'SAVEPOINT `s47055674149248_x55`', u'time': u'0.000'},
+             {u'sql': u'RELEASE SAVEPOINT `s47055674149248_x55`', u'time': u'0.000'}]
+        )
+
+        assert result == {
+            'nodestore_node': 2,
+            'sentry_environmentproject': 1,
+            'sentry_eventtag': 1,
+            'sentry_eventuser': 1,
+            'sentry_filtervalue': 6,
+            'sentry_groupedmessage': 1,
+            'sentry_message': 1,
+            'sentry_messagefiltervalue': 6,
+            'sentry_userreport': 1
+        }
+
+    def test_parse_postgres_queries(self):
+        result = parse_queries([
+            {u'sql': u'SAVEPOINT "s47890194282880_x49"', u'time': u'0.000'},
+            {u'sql': u'RELEASE SAVEPOINT "s47890194282880_x49"', u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_rawevent"."id", "sentry_rawevent"."project_id", "sentry_rawevent"."event_id", "sentry_rawevent"."datetime", "sentry_rawevent"."data" FROM "sentry_rawevent" WHERE ("sentry_rawevent"."event_id" = \'1fba9e314001443b93285dc4411f1593\'  AND "sentry_rawevent"."project_id" = 864 )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_reprocessingreport"."id", "sentry_reprocessingreport"."project_id", "sentry_reprocessingreport"."event_id", "sentry_reprocessingreport"."datetime" FROM "sentry_reprocessingreport" WHERE ("sentry_reprocessingreport"."event_id" = \'1fba9e314001443b93285dc4411f1593\'  AND "sentry_reprocessingreport"."project_id" = 864 )',
+             u'time': u'0.001'},
+            {u'sql': u'SELECT "sentry_message"."id", "sentry_message"."group_id", "sentry_message"."message_id", "sentry_message"."project_id", "sentry_message"."message", "sentry_message"."platform", "sentry_message"."datetime", "sentry_message"."time_spent", "sentry_message"."data" FROM "sentry_message" WHERE ("sentry_message"."message_id" = \'1fba9e314001443b93285dc4411f1593\'  AND "sentry_message"."project_id" = 864 )',
+             u'time': u'0.001'},
+            {u'sql': u'SAVEPOINT "s47890194282880_x50"', u'time': u'0.000'},
+            {u'sql': u'INSERT INTO "sentry_eventuser" ("project_id", "hash", "ident", "email", "username", "name", "ip_address", "date_added") VALUES (864, \'f528764d624db129b32c21fbca0cb8d6\', NULL, NULL, NULL, NULL, \'127.0.0.1\', \'2018-05-22 09:12:12.357888+00:00\') RETURNING "sentry_eventuser"."id"',
+             u'time': u'0.000'},
+            {u'sql': u'ROLLBACK TO SAVEPOINT "s47890194282880_x50"', u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_eventuser"."id", "sentry_eventuser"."project_id", "sentry_eventuser"."hash", "sentry_eventuser"."ident", "sentry_eventuser"."email", "sentry_eventuser"."username", "sentry_eventuser"."name", "sentry_eventuser"."ip_address", "sentry_eventuser"."date_added" FROM "sentry_eventuser" WHERE ("sentry_eventuser"."project_id" = 864  AND "sentry_eventuser"."hash" = \'f528764d624db129b32c21fbca0cb8d6\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_grouphash"."id", "sentry_grouphash"."project_id", "sentry_grouphash"."hash", "sentry_grouphash"."group_id", "sentry_grouphash"."group_tombstone_id", "sentry_grouphash"."state" FROM "sentry_grouphash" WHERE ("sentry_grouphash"."project_id" = 864  AND "sentry_grouphash"."hash" = \'5d41402abc4b2a76b9719d911017c592\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_groupedmessage"."id", "sentry_groupedmessage"."project_id", "sentry_groupedmessage"."logger", "sentry_groupedmessage"."level", "sentry_groupedmessage"."message", "sentry_groupedmessage"."view", "sentry_groupedmessage"."num_comments", "sentry_groupedmessage"."platform", "sentry_groupedmessage"."status", "sentry_groupedmessage"."times_seen", "sentry_groupedmessage"."last_seen", "sentry_groupedmessage"."first_seen", "sentry_groupedmessage"."first_release_id", "sentry_groupedmessage"."resolved_at", "sentry_groupedmessage"."active_at", "sentry_groupedmessage"."time_spent_total", "sentry_groupedmessage"."time_spent_count", "sentry_groupedmessage"."score", "sentry_groupedmessage"."is_public", "sentry_groupedmessage"."data", "sentry_groupedmessage"."short_id" FROM "sentry_groupedmessage" WHERE "sentry_groupedmessage"."id" = 662 ',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_project"."id", "sentry_project"."slug", "sentry_project"."name", "sentry_project"."forced_color", "sentry_project"."organization_id", "sentry_project"."public", "sentry_project"."date_added", "sentry_project"."status", "sentry_project"."first_event", "sentry_project"."flags", "sentry_project"."platform" FROM "sentry_project" WHERE "sentry_project"."id" = 864 ',
+             u'time': u'0.000'},
+            {u'sql': u'UPDATE "sentry_groupedmessage" SET "times_seen" = "sentry_groupedmessage"."times_seen" + 1, "score" = 1526980332, "data" = \'eJwVyksKhEAMRdF5NlKORKv89QbcgOBUgokopOlgRcHddxze905BWsMUBLMtJ6983EwBNMJYt7H7DFVKEfIU7FH2Pbkl3vAS82re58uGhIbeLRSknRM7TF7ew7yzyA90gJzLP+FOIA0=\', "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE "sentry_groupedmessage"."id" = 662 ',
+             u'time': u'0.001'},
+            {u'sql': u'SAVEPOINT "s47890194282880_x51"', u'time': u'0.000'},
+            {u'sql': u'INSERT INTO "sentry_environmentproject" ("project_id", "environment_id", "is_hidden") VALUES (864, 165, NULL) RETURNING "sentry_environmentproject"."id"',
+             u'time': u'0.000'},
+            {u'sql': u'ROLLBACK TO SAVEPOINT "s47890194282880_x51"', u'time': u'0.000'},
+            {u'sql': u'UPDATE "sentry_userreport" SET "environment_id" = 165, "group_id" = 662 WHERE ("sentry_userreport"."project_id" = 864  AND "sentry_userreport"."event_id" = \'1fba9e314001443b93285dc4411f1593\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SAVEPOINT "s47890194282880_x52"', u'time': u'0.000'},
+            {u'sql': u'UPDATE "nodestore_node" SET "timestamp" = \'2018-05-22 09:12:12.374085+00:00\', "data" = \'eJxtU8Fu2zAMvesrfIsLbI4lS7KTnYoBW4qu7SFdcgxUm3G0OLEgq127ov8+UnHTSxHACMn3KOo9Km0cZ8uJ8/0fqMOEOcGuKi3ZsJwMcAz+JbPHAH5rahiy3wN4hBQsbZxElnUb0zQehgGzChNclFmOP46xZsOnTW4QblpAREl9KqQdzqkZW+2g63rmeB758By8wQLnBOaCBtt42G6ewA+2P1KpYFfi84EXIThCyEimCR99RwmN52BtPp3Cszm4DrK6P2C+pD47MA12J1zF0s7xGX1FzlYkwNfLFs9BoTgzq5v+n+06M1VZnqRre2z6v0Nye5/oTHxL1ndrLS+SS4f91/BwbcNUFWVW6CS9Xtzf/PqSdHYPyU+o9/1F8n3n+wNMRUX6qTzPSpEszdZ4O7LwSMGMIVXqHu/4HGhEEd0QZEcfYxVjjfGHRKJkt0g7mgOJLEjz92ErSsyi1g8eEyeHc2pScNYiczk5z0QllLqNHU4DU6pAOvK39tiCdx4NoKwk1QoS/fU1aWBrHruQvL1RSTMz+khR+bFyzZ4SVTx9hsy6syj2xpKLMmetJtTHvSRnK9q3HP/GFRhvKAu22rh+CGsbdotoJyZlvKWHGuwTNART7AdXQs+qvCgiH7zvo/NS0/Qy7kMwbUzFZZC4DMtJB09Ai6RyNpIo4Cw4hR6l73umis/3TElCqog8be388aS8ws20bn5+SIQrI64fstPtVmfrqFjF4mjdiHAK39HJHnyHOcI0Lmvaoq1jOjlbSkUceWhJyyjvHl42luTR+LBmyCEJXhz11bRmo5UUKqodIJjGBHqlWpNzmnYm2NBFSsXa+Jaz/zqNSI8=\' WHERE "nodestore_node"."id" = \'u9iv1Ih4RDqz5GtlwX3+TA==\' ',
+             u'time': u'0.000'},
+            {u'sql': u'SAVEPOINT "s47890194282880_x53"', u'time': u'0.000'},
+            {u'sql': u'INSERT INTO "nodestore_node" ("id", "data", "timestamp") VALUES (\'u9iv1Ih4RDqz5GtlwX3+TA==\', \'eJxtU8Fu2zAMvesrfIsLbI4lS7KTnYoBW4qu7SFdcgxUm3G0OLEgq127ov8+UnHTSxHACMn3KOo9Km0cZ8uJ8/0fqMOEOcGuKi3ZsJwMcAz+JbPHAH5rahiy3wN4hBQsbZxElnUb0zQehgGzChNclFmOP46xZsOnTW4QblpAREl9KqQdzqkZW+2g63rmeB758By8wQLnBOaCBtt42G6ewA+2P1KpYFfi84EXIThCyEimCR99RwmN52BtPp3Cszm4DrK6P2C+pD47MA12J1zF0s7xGX1FzlYkwNfLFs9BoTgzq5v+n+06M1VZnqRre2z6v0Nye5/oTHxL1ndrLS+SS4f91/BwbcNUFWVW6CS9Xtzf/PqSdHYPyU+o9/1F8n3n+wNMRUX6qTzPSpEszdZ4O7LwSMGMIVXqHu/4HGhEEd0QZEcfYxVjjfGHRKJkt0g7mgOJLEjz92ErSsyi1g8eEyeHc2pScNYiczk5z0QllLqNHU4DU6pAOvK39tiCdx4NoKwk1QoS/fU1aWBrHruQvL1RSTMz+khR+bFyzZ4SVTx9hsy6syj2xpKLMmetJtTHvSRnK9q3HP/GFRhvKAu22rh+CGsbdotoJyZlvKWHGuwTNART7AdXQs+qvCgiH7zvo/NS0/Qy7kMwbUzFZZC4DMtJB09Ai6RyNpIo4Cw4hR6l73umis/3TElCqog8be388aS8ws20bn5+SIQrI64fstPtVmfrqFjF4mjdiHAK39HJHnyHOcI0Lmvaoq1jOjlbSkUceWhJyyjvHl42luTR+LBmyCEJXhz11bRmo5UUKqodIJjGBHqlWpNzmnYm2NBFSsXa+Jaz/zqNSI8=\', \'2018-05-22 09:12:12.374085+00:00\')',
+             u'time': u'0.000'},
+            {u'sql': u'RELEASE SAVEPOINT "s47890194282880_x53"', u'time': u'0.000'},
+            {u'sql': u'INSERT INTO "sentry_message" ("group_id", "message_id", "project_id", "message", "platform", "datetime", "time_spent", "data") VALUES (662, \'1fba9e314001443b93285dc4411f1593\', 864, \'hello http://example.com\', \'javascript\', \'2018-05-22 09:12:12+00:00\', NULL, \'eJzTSCkw5ApWz8tPSY3PTFHnKjAC8kotM8sMPTNMglwKq0zdS3LKI4y1QxxtbYHSxlzFegCZxA8W\') RETURNING "sentry_message"."id"',
+             u'time': u'0.000'},
+            {u'sql': u'RELEASE SAVEPOINT "s47890194282880_x52"', u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filterkey"."id", "sentry_filterkey"."project_id", "sentry_filterkey"."key", "sentry_filterkey"."values_seen", "sentry_filterkey"."label", "sentry_filterkey"."status" FROM "sentry_filterkey" WHERE ("sentry_filterkey"."project_id" = 864  AND "sentry_filterkey"."key" = \'level\' )',
+             u'time': u'0.001'},
+            {u'sql': u'SELECT "sentry_filtervalue"."id", "sentry_filtervalue"."project_id", "sentry_filtervalue"."key", "sentry_filtervalue"."value", "sentry_filtervalue"."data", "sentry_filtervalue"."times_seen", "sentry_filtervalue"."last_seen", "sentry_filtervalue"."first_seen" FROM "sentry_filtervalue" WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'error\'  AND "sentry_filtervalue"."key" = \'level\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filterkey"."id", "sentry_filterkey"."project_id", "sentry_filterkey"."key", "sentry_filterkey"."values_seen", "sentry_filterkey"."label", "sentry_filterkey"."status" FROM "sentry_filterkey" WHERE ("sentry_filterkey"."project_id" = 864  AND "sentry_filterkey"."key" = \'url\' )',
+             u'time': u'0.001'},
+            {u'sql': u'SELECT "sentry_filtervalue"."id", "sentry_filtervalue"."project_id", "sentry_filtervalue"."key", "sentry_filtervalue"."value", "sentry_filtervalue"."data", "sentry_filtervalue"."times_seen", "sentry_filtervalue"."last_seen", "sentry_filtervalue"."first_seen" FROM "sentry_filtervalue" WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'http://example.com\'  AND "sentry_filtervalue"."key" = \'url\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filterkey"."id", "sentry_filterkey"."project_id", "sentry_filterkey"."key", "sentry_filterkey"."values_seen", "sentry_filterkey"."label", "sentry_filterkey"."status" FROM "sentry_filterkey" WHERE ("sentry_filterkey"."project_id" = 864  AND "sentry_filterkey"."key" = \'sentry:user\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filtervalue"."id", "sentry_filtervalue"."project_id", "sentry_filtervalue"."key", "sentry_filtervalue"."value", "sentry_filtervalue"."data", "sentry_filtervalue"."times_seen", "sentry_filtervalue"."last_seen", "sentry_filtervalue"."first_seen" FROM "sentry_filtervalue" WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'ip:127.0.0.1\'  AND "sentry_filtervalue"."key" = \'sentry:user\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filterkey"."id", "sentry_filterkey"."project_id", "sentry_filterkey"."key", "sentry_filterkey"."values_seen", "sentry_filterkey"."label", "sentry_filterkey"."status" FROM "sentry_filterkey" WHERE ("sentry_filterkey"."project_id" = 864  AND "sentry_filterkey"."key" = \'os.name\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filtervalue"."id", "sentry_filtervalue"."project_id", "sentry_filtervalue"."key", "sentry_filtervalue"."value", "sentry_filtervalue"."data", "sentry_filtervalue"."times_seen", "sentry_filtervalue"."last_seen", "sentry_filtervalue"."first_seen" FROM "sentry_filtervalue" WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'Windows 8\'  AND "sentry_filtervalue"."key" = \'os.name\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filterkey"."id", "sentry_filterkey"."project_id", "sentry_filterkey"."key", "sentry_filterkey"."values_seen", "sentry_filterkey"."label", "sentry_filterkey"."status" FROM "sentry_filterkey" WHERE ("sentry_filterkey"."project_id" = 864  AND "sentry_filterkey"."key" = \'browser.name\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filtervalue"."id", "sentry_filtervalue"."project_id", "sentry_filtervalue"."key", "sentry_filtervalue"."value", "sentry_filtervalue"."data", "sentry_filtervalue"."times_seen", "sentry_filtervalue"."last_seen", "sentry_filtervalue"."first_seen" FROM "sentry_filtervalue" WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'Chrome\'  AND "sentry_filtervalue"."key" = \'browser.name\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filterkey"."id", "sentry_filterkey"."project_id", "sentry_filterkey"."key", "sentry_filterkey"."values_seen", "sentry_filterkey"."label", "sentry_filterkey"."status" FROM "sentry_filterkey" WHERE ("sentry_filterkey"."project_id" = 864  AND "sentry_filterkey"."key" = \'browser\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_filtervalue"."id", "sentry_filtervalue"."project_id", "sentry_filtervalue"."key", "sentry_filtervalue"."value", "sentry_filtervalue"."data", "sentry_filtervalue"."times_seen", "sentry_filtervalue"."last_seen", "sentry_filtervalue"."first_seen" FROM "sentry_filtervalue" WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'Chrome 28.0.1500\'  AND "sentry_filtervalue"."key" = \'browser\' )',
+             u'time': u'0.000'},
+            {u'sql': u'SAVEPOINT "s47890194282880_x54"', u'time': u'0.000'},
+            {u'sql': u'INSERT INTO "sentry_eventtag" ("project_id", "group_id", "event_id", "key_id", "value_id", "date_added") VALUES (864, 662, 454, 108, 108, \'2018-05-22 09:12:12+00:00\'), (864, 662, 454, 109, 109, \'2018-05-22 09:12:12+00:00\'), (864, 662, 454, 110, 110, \'2018-05-22 09:12:12+00:00\'), (864, 662, 454, 111, 111, \'2018-05-22 09:12:12+00:00\'), (864, 662, 454, 112, 112, \'2018-05-22 09:12:12+00:00\'), (864, 662, 454, 113, 113, \'2018-05-22 09:12:12+00:00\')',
+             u'time': u'0.000'},
+            {u'sql': u'RELEASE SAVEPOINT "s47890194282880_x54"', u'time': u'0.000'},
+            {u'sql': u'UPDATE "sentry_filtervalue" SET "times_seen" = "sentry_filtervalue"."times_seen" + 1, "data" = NULL, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'error\'  AND "sentry_filtervalue"."key" = \'level\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_messagefiltervalue" SET "times_seen" = "sentry_messagefiltervalue"."times_seen" + 1, "project_id" = 864, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_messagefiltervalue"."group_id" = 662  AND "sentry_messagefiltervalue"."value" = \'error\'  AND "sentry_messagefiltervalue"."key" = \'level\' )',
+             u'time': u'0.000'},
+            {u'sql': u'UPDATE "sentry_filtervalue" SET "times_seen" = "sentry_filtervalue"."times_seen" + 1, "data" = NULL, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'http://example.com\'  AND "sentry_filtervalue"."key" = \'url\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_messagefiltervalue" SET "times_seen" = "sentry_messagefiltervalue"."times_seen" + 1, "project_id" = 864, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_messagefiltervalue"."group_id" = 662  AND "sentry_messagefiltervalue"."value" = \'http://example.com\'  AND "sentry_messagefiltervalue"."key" = \'url\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_filtervalue" SET "times_seen" = "sentry_filtervalue"."times_seen" + 1, "data" = NULL, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'ip:127.0.0.1\'  AND "sentry_filtervalue"."key" = \'sentry:user\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_messagefiltervalue" SET "times_seen" = "sentry_messagefiltervalue"."times_seen" + 1, "project_id" = 864, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_messagefiltervalue"."group_id" = 662  AND "sentry_messagefiltervalue"."value" = \'ip:127.0.0.1\'  AND "sentry_messagefiltervalue"."key" = \'sentry:user\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_filtervalue" SET "times_seen" = "sentry_filtervalue"."times_seen" + 1, "data" = NULL, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'Windows 8\'  AND "sentry_filtervalue"."key" = \'os.name\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_messagefiltervalue" SET "times_seen" = "sentry_messagefiltervalue"."times_seen" + 1, "project_id" = 864, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_messagefiltervalue"."group_id" = 662  AND "sentry_messagefiltervalue"."value" = \'Windows 8\'  AND "sentry_messagefiltervalue"."key" = \'os.name\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_filtervalue" SET "times_seen" = "sentry_filtervalue"."times_seen" + 1, "data" = NULL, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'Chrome\'  AND "sentry_filtervalue"."key" = \'browser.name\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_messagefiltervalue" SET "times_seen" = "sentry_messagefiltervalue"."times_seen" + 1, "project_id" = 864, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_messagefiltervalue"."group_id" = 662  AND "sentry_messagefiltervalue"."value" = \'Chrome\'  AND "sentry_messagefiltervalue"."key" = \'browser.name\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_filtervalue" SET "times_seen" = "sentry_filtervalue"."times_seen" + 1, "data" = NULL, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_filtervalue"."project_id" = 864  AND "sentry_filtervalue"."value" = \'Chrome 28.0.1500\'  AND "sentry_filtervalue"."key" = \'browser\' )',
+             u'time': u'0.001'},
+            {u'sql': u'UPDATE "sentry_messagefiltervalue" SET "times_seen" = "sentry_messagefiltervalue"."times_seen" + 1, "project_id" = 864, "last_seen" = \'2018-05-22 09:12:12+00:00\' WHERE ("sentry_messagefiltervalue"."group_id" = 662  AND "sentry_messagefiltervalue"."value" = \'Chrome 28.0.1500\'  AND "sentry_messagefiltervalue"."key" = \'browser\' )',
+             u'time': u'0.001'},
+            {u'sql': u'SELECT "sentry_groupedmessage"."id", "sentry_groupedmessage"."project_id", "sentry_groupedmessage"."logger", "sentry_groupedmessage"."level", "sentry_groupedmessage"."message", "sentry_groupedmessage"."view", "sentry_groupedmessage"."num_comments", "sentry_groupedmessage"."platform", "sentry_groupedmessage"."status", "sentry_groupedmessage"."times_seen", "sentry_groupedmessage"."last_seen", "sentry_groupedmessage"."first_seen", "sentry_groupedmessage"."first_release_id", "sentry_groupedmessage"."resolved_at", "sentry_groupedmessage"."active_at", "sentry_groupedmessage"."time_spent_total", "sentry_groupedmessage"."time_spent_count", "sentry_groupedmessage"."score", "sentry_groupedmessage"."is_public", "sentry_groupedmessage"."data", "sentry_groupedmessage"."short_id" FROM "sentry_groupedmessage" WHERE "sentry_groupedmessage"."id" = 662 ',
+             u'time': u'0.001'},
+            {u'sql': u'SELECT "sentry_groupsnooze"."id", "sentry_groupsnooze"."group_id", "sentry_groupsnooze"."until", "sentry_groupsnooze"."count", "sentry_groupsnooze"."window", "sentry_groupsnooze"."user_count", "sentry_groupsnooze"."user_window", "sentry_groupsnooze"."state", "sentry_groupsnooze"."actor_id" FROM "sentry_groupsnooze" WHERE "sentry_groupsnooze"."group_id" = 662 ',
+             u'time': u'0.000'},
+            {u'sql': u'SELECT "sentry_grouprulestatus"."id", "sentry_grouprulestatus"."project_id", "sentry_grouprulestatus"."rule_id", "sentry_grouprulestatus"."group_id", "sentry_grouprulestatus"."status", "sentry_grouprulestatus"."date_added", "sentry_grouprulestatus"."last_active" FROM "sentry_grouprulestatus" WHERE ("sentry_grouprulestatus"."group_id" = 662  AND "sentry_grouprulestatus"."rule_id" = 935 )',
+             u'time': u'0.000'},
+            {u'sql': u'SAVEPOINT "s47890194282880_x55"', u'time': u'0.000'},
+            {u'sql': u'RELEASE SAVEPOINT "s47890194282880_x55"', u'time': u'0.000'}]
+        )
+
+        assert result == {
+            'nodestore_node': 2,
+            'sentry_environmentproject': 1,
+            'sentry_eventtag': 1,
+            'sentry_eventuser': 1,
+            'sentry_filtervalue': 6,
+            'sentry_groupedmessage': 1,
+            'sentry_message': 1,
+            'sentry_messagefiltervalue': 6,
+            'sentry_userreport': 1
+        }
diff --git a/tests/sentry/lang/java/test_plugin.py b/tests/sentry/lang/java/test_plugin.py
index 8d67a4f81b..9672b3c2b6 100644
--- a/tests/sentry/lang/java/test_plugin.py
+++ b/tests/sentry/lang/java/test_plugin.py
@@ -1,10 +1,12 @@
 from __future__ import absolute_import
 
 import zipfile
+import pytest
 from six import BytesIO
 
-from django.core.files.uploadedfile import SimpleUploadedFile
+from django.conf import settings
 from django.core.urlresolvers import reverse
+from django.core.files.uploadedfile import SimpleUploadedFile
 
 from sentry.models import Event
 from sentry.testutils import TestCase
@@ -22,6 +24,10 @@ PROGUARD_BUG_SOURCE = b'x'
 
 
 class BasicResolvingIntegrationTest(TestCase):
+    @pytest.mark.skipif(
+        settings.SENTRY_TAGSTORE == 'sentry.tagstore.v2.V2TagStorage',
+        reason='Queries are completly different when using tagstore'
+    )
     def test_basic_resolving(self):
         url = reverse(
             'sentry-api-0-dsym-files',
@@ -42,7 +48,10 @@ class BasicResolvingIntegrationTest(TestCase):
         response = self.client.post(
             url, {
                 'file':
-                SimpleUploadedFile('symbols.zip', out.getvalue(), content_type='application/zip'),
+                SimpleUploadedFile(
+                    'symbols.zip',
+                    out.getvalue(),
+                    content_type='application/zip'),
             },
             format='multipart'
         )
@@ -90,10 +99,25 @@ class BasicResolvingIntegrationTest(TestCase):
             },
         }
 
-        resp = self._postWithHeader(event_data)
+        # We do a preflight post, because there are many queries polluting the array
+        # before the actual "processing" happens (like, auth_user)
+        self._postWithHeader(event_data)
+        with self.assertWriteQueries({
+            'nodestore_node': 2,
+            'sentry_environmentproject': 1,
+            'sentry_eventtag': 1,
+            'sentry_eventuser': 1,
+            'sentry_filtervalue': 2,
+            'sentry_groupedmessage': 1,
+            'sentry_message': 1,
+            'sentry_messagefiltervalue': 2,
+            'sentry_userip': 1,
+            'sentry_userreport': 1
+        }):
+            resp = self._postWithHeader(event_data)
         assert resp.status_code == 200
 
-        event = Event.objects.get()
+        event = Event.objects.first()
 
         bt = event.interfaces['sentry.interfaces.Exception'].values[0].stacktrace
         frames = bt.frames
diff --git a/tests/sentry/lang/javascript/test_plugin.py b/tests/sentry/lang/javascript/test_plugin.py
index 602922c67a..3adad1e3de 100644
--- a/tests/sentry/lang/javascript/test_plugin.py
+++ b/tests/sentry/lang/javascript/test_plugin.py
@@ -2,14 +2,17 @@
 
 from __future__ import absolute_import
 
-import responses
+import pytest
 import os.path
+import responses
 
 from mock import patch
+from django.conf import settings
 
 from sentry.models import Event, File, Release, ReleaseFile
 from sentry.testutils import TestCase
 
+
 BASE64_SOURCEMAP = 'data:application/json;base64,' + (
     '{"version":3,"file":"generated.js","sources":["/test.js"],"names":[],"mappings":"AAAA","sourcesContent":["console.log(\\"hello, World!\\")"]}'.
     encode('base64').replace('\n', '')
@@ -26,6 +29,10 @@ def load_fixture(name):
 
 
 class JavascriptIntegrationTest(TestCase):
+    @pytest.mark.skipif(
+        settings.SENTRY_TAGSTORE == 'sentry.tagstore.v2.V2TagStorage',
+        reason='Queries are completly different when using tagstore'
+    )
     def test_adds_contexts_without_device(self):
         data = {
             'message': 'hello',
@@ -42,10 +49,24 @@ class JavascriptIntegrationTest(TestCase):
             }
         }
 
-        resp = self._postWithHeader(data)
+        # We do a preflight post, because there are many queries polluting the array
+        # before the actual "processing" happens (like, auth_user)
+        self._postWithHeader(data)
+        with self.assertWriteQueries({
+            'nodestore_node': 2,
+            'sentry_environmentproject': 1,
+            'sentry_eventtag': 1,
+            'sentry_eventuser': 1,
+            'sentry_filtervalue': 6,
+            'sentry_groupedmessage': 1,
+            'sentry_message': 1,
+            'sentry_messagefiltervalue': 6,
+            'sentry_userreport': 1
+        }, debug=True):  # debug=True is for coverage
+            resp = self._postWithHeader(data)
         assert resp.status_code, 200
 
-        event = Event.objects.get()
+        event = Event.objects.first()
         contexts = event.interfaces['contexts'].to_json()
         assert contexts.get('os') == {
             'name': 'Windows 8',
diff --git a/tests/sentry/lang/native/test_plugin.py b/tests/sentry/lang/native/test_plugin.py
index ceac5a5568..6a50aa34ba 100644
--- a/tests/sentry/lang/native/test_plugin.py
+++ b/tests/sentry/lang/native/test_plugin.py
@@ -1,22 +1,28 @@
 from __future__ import absolute_import
 
 import os
+import pytest
 import zipfile
 from mock import patch
 from six import BytesIO
 
-from django.core.files.uploadedfile import SimpleUploadedFile
+from django.conf import settings
 from django.core.urlresolvers import reverse
+from django.core.files.uploadedfile import SimpleUploadedFile
 
-from sentry.models import Event, File, ProjectDSymFile
 from sentry.testutils import TestCase
 from sentry.lang.native.symbolizer import Symbolizer
+from sentry.models import Event, File, ProjectDSymFile
 
 from symbolic import parse_addr, Object, SymbolicError
 
 
 class BasicResolvingIntegrationTest(TestCase):
 
+    @pytest.mark.skipif(
+        settings.SENTRY_TAGSTORE == 'sentry.tagstore.v2.V2TagStorage',
+        reason='Queries are completly different when using tagstore'
+    )
     @patch('sentry.lang.native.symbolizer.Symbolizer._symbolize_app_frame')
     def test_frame_resolution(self, symbolize_frame):
         object_name = (
@@ -161,10 +167,25 @@ class BasicResolvingIntegrationTest(TestCase):
             }
         }
 
-        resp = self._postWithHeader(event_data)
+        # We do a preflight post, because there are many queries polluting the array
+        # before the actual "processing" happens (like, auth_user)
+        self._postWithHeader(event_data)
+        with self.assertWriteQueries({
+            'nodestore_node': 2,
+            'sentry_environmentproject': 1,
+            'sentry_eventtag': 1,
+            'sentry_eventuser': 1,
+            'sentry_filtervalue': 7,
+            'sentry_groupedmessage': 1,
+            'sentry_message': 1,
+            'sentry_messagefiltervalue': 7,
+            'sentry_userreport': 1
+        }):
+            resp = self._postWithHeader(event_data)
+
         assert resp.status_code == 200
 
-        event = Event.objects.get()
+        event = Event.objects.first()
 
         bt = event.interfaces['sentry.interfaces.Exception'].values[0].stacktrace
         frames = bt.frames
