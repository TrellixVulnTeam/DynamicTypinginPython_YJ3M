commit 5b6963dd61930e1384f9c744dfbf6b1e906f45eb
Author: David Cramer <dcramer@gmail.com>
Date:   Thu May 10 00:43:55 2012 -0500

    Change MessageFilterValue update query to use create_or_update

diff --git a/sentry/manager.py b/sentry/manager.py
index 0b7a3a8ef3..f33f7afac6 100644
--- a/sentry/manager.py
+++ b/sentry/manager.py
@@ -569,20 +569,15 @@ class GroupManager(BaseManager, ChartMixin):
                 value=value,
             )
 
-            affected = group.messagefiltervalue_set.filter(
+            group.messagefiltervalue_set.create_or_update(
                 project=project,
                 key=key,
                 value=value,
-            ).update(times_seen=F('times_seen') + 1, last_seen=date)
-            if not affected:
-                group.messagefiltervalue_set.create(
-                    project=project,
-                    key=key,
-                    value=value,
-                    times_seen=1,
+                defaults=dict(
+                    times_seen=F('times_seen') + 1,
                     last_seen=date,
-                    first_seen=date,
                 )
+            )
 
         return group, is_new, is_sample
 
diff --git a/sentry/models.py b/sentry/models.py
index b534a6f5d4..3629a6c4c5 100644
--- a/sentry/models.py
+++ b/sentry/models.py
@@ -603,6 +603,11 @@ class MessageFilterValue(Model):
         return u'group_id=%s, times_seen=%s, key=%s, value=%s' % (self.group_id, self.times_seen,
                                                                   self.key, self.value)
 
+    def save(self, *args, **kwargs):
+        if not self.first_seen:
+            self.first_seen = self.last_seen
+        super(MessageFilterValue, self).save(*args, **kwargs)
+
 
 class MessageCountByMinute(Model):
     """
