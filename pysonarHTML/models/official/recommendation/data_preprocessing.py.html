<html>
<head>
<meta charset="utf-8">
<title>/home/xxm/Desktop/EMSE/dataset/models/official/recommendation/data_preprocessing.py</title>
<style type='text/css'>
body { color: #666666; }
a {
    text-decoration: none; color: #5AA2A7;
    border: solid 1px rgba(255,255,255,0);
}
a.active {
    background: -webkit-linear-gradient(top,rgba(255, 255, 200, 0.35) 0,rgba(255, 255, 200, 0.55) 100%);
    border: solid 1px #E5E600;
}
table, th, td { border: 1px solid lightgrey; padding: 5px; corner: rounded; }
.builtin {color: #B17E41;}
.comment, .block-comment {color: #aaaaaa; font-style: italic;}
.constant {color: #888888;}
.decorator {color: #778899;}
.doc-string {color: #aaaaaa;}
.error {border-bottom: 1px solid red;}
.field-name {color: #2e8b57;}
.function {color: #4682b4;}
.identifier {color: #8b7765;}
.info {border-bottom: 1px dotted RoyalBlue;}
.keyword {color: #0000cd;}
.lineno {color: #cccccc;}
.number {color: #483d8b;}
.parameter {color: #777777;}
.string {color: #999999;}
.type-name {color: #4682b4;}
.warning {border-bottom: 1px solid orange; padding-bottom: 1px}
</style>
<script language="JavaScript" type="text/javascript">
var highlighted;

function highlight(xid)
{
    var elms = document.querySelectorAll('[xid="' + xid + '"]');
    for (k in elms) {
        v = elms[k]
        v.className = "active";
    }
    highlighted = xid;
}

function clearHighlight() {
    var elms = document.querySelectorAll('[xid="' + highlighted + '"]');
    for (k in elms) {
        v = elms[k]
        v.className = "";
    }
}

window.onload =
    function (e) {
        var tags = document.getElementsByTagName("A")
        for (var i = 0; i < tags.length; i++) {
            tags[i].onmouseover =
                function (e) {
                    clearHighlight();
                    var xid = e.toElement.getAttribute('xid');
                    highlight(xid);
                }
        }
    }</script>
</head>
<body>
<table width=100% border='1px solid gray'><tr><td valign='top'><ul>
<li><a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._EXPECTED_CACHE_KEYS', xid='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._EXPECTED_CACHE_KEYS'>_EXPECTED_CACHE_KEYS</a></li><li><a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe', xid='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe'>read_dataframe</a></li><li><a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort', xid='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort'>_filter_index_sort</a></li><li><a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline', xid='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline'>instantiate_pipeline</a></li></ul>
</td><td><pre><span class='lineno'>   1</span> # Copyright 2018 The TensorFlow Authors. All Rights Reserved.
<span class='lineno'>   2</span> #
<span class='lineno'>   3</span> # Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
<span class='lineno'>   4</span> # you may not use this file except in compliance with the License.
<span class='lineno'>   5</span> # You may obtain a copy of the License at
<span class='lineno'>   6</span> #
<span class='lineno'>   7</span> #     http://www.apache.org/licenses/LICENSE-2.0
<span class='lineno'>   8</span> #
<span class='lineno'>   9</span> # Unless required by applicable law or agreed to in writing, software
<span class='lineno'>  10</span> # distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
<span class='lineno'>  11</span> # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
<span class='lineno'>  12</span> # See the License for the specific language governing permissions and
<span class='lineno'>  13</span> # limitations under the License.
<span class='lineno'>  14</span> # ==============================================================================
<span class='lineno'>  15</span> &quot;&quot;&quot;Preprocess dataset and construct any necessary artifacts.&quot;&quot;&quot;
<span class='lineno'>  16</span> 
<span class='lineno'>  17</span> from __future__ import absolute_import
<span class='lineno'>  18</span> from __future__ import division
<span class='lineno'>  19</span> # from __future__ import google_type_annotations
<span class='lineno'>  20</span> from __future__ import print_function
<span class='lineno'>  21</span> 
<span class='lineno'>  22</span> import os
<span class='lineno'>  23</span> import pickle
<span class='lineno'>  24</span> import time
<span class='lineno'>  25</span> import timeit
<span class='lineno'>  26</span> 
<span class='lineno'>  27</span> # pylint: disable=wrong-import-order
<span class='lineno'>  28</span> from absl import logging
<span class='lineno'>  29</span> import numpy as np
<span class='lineno'>  30</span> import pandas as pd
<span class='lineno'>  31</span> import tensorflow as tf
<span class='lineno'>  32</span> import typing
<span class='lineno'>  33</span> from typing import Dict, Text, Tuple
<span class='lineno'>  34</span> # pylint: enable=wrong-import-order
<span class='lineno'>  35</span> 
<span class='lineno'>  36</span> from official.recommendation import constants as rconst
<span class='lineno'>  37</span> from official.recommendation import data_pipeline
<span class='lineno'>  38</span> from official.recommendation import movielens
<span class='lineno'>  39</span> 
<span class='lineno'>  40</span> 
<span class='lineno'>  41</span> <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._EXPECTED_CACHE_KEYS', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._EXPECTED_CACHE_KEYS', title='(?, ?, ?, ?, ?, ?)'>_EXPECTED_CACHE_KEYS</a> = (
<span class='lineno'>  42</span>     rconst.TRAIN_USER_KEY, rconst.TRAIN_ITEM_KEY, rconst.EVAL_USER_KEY,
<span class='lineno'>  43</span>     rconst.EVAL_ITEM_KEY, rconst.USER_MAP, rconst.ITEM_MAP)
<span class='lineno'>  44</span> 
<span class='lineno'>  45</span> 
<span class='lineno'>  46</span> def <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe', title='str -> (dict, dict, ?) / ? -> (dict, dict, ?)'>read_dataframe</a>(
<span class='lineno'>  47</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.raw_rating_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.raw_rating_path', title='str'>raw</a>_rating_path: Text
<span class='lineno'>  48</span> ) -&gt; Tuple[Dict[int, int], Dict[int, int], pd.DataFrame]:
<span class='lineno'>  49</span>   &quot;&quot;&quot;Read in data CSV, and output DataFrame for downstream processing.
<span class='lineno'>  50</span> 
<span class='lineno'>  51</span>   This function reads in the raw CSV of positive items, and performs three
<span class='lineno'>  52</span>   preprocessing transformations:
<span class='lineno'>  53</span> 
<span class='lineno'>  54</span>   1)  Filter out all users who have not rated at least a certain number
<span class='lineno'>  55</span>       of items. (Typically 20 items)
<span class='lineno'>  56</span> 
<span class='lineno'>  57</span>   2)  Zero index the users and items such that the largest user_id is
<span class='lineno'>  58</span>       `num_users - 1` and the largest item_id is `num_items - 1`
<span class='lineno'>  59</span> 
<span class='lineno'>  60</span>   3)  Sort the dataframe by user_id, with timestamp as a secondary sort key.
<span class='lineno'>  61</span>       This allows the dataframe to be sliced by user in-place, and for the last
<span class='lineno'>  62</span>       item to be selected simply by calling the `-1` index of a user&#39;s slice.
<span class='lineno'>  63</span> 
<span class='lineno'>  64</span>   Args:
<span class='lineno'>  65</span>     raw_rating_path: The path to the CSV which contains the raw dataset.
<span class='lineno'>  66</span> 
<span class='lineno'>  67</span>   Returns:
<span class='lineno'>  68</span>     A dict mapping raw user IDs to regularized user IDs, a dict mapping raw
<span class='lineno'>  69</span>     item IDs to regularized item IDs, and a filtered, zero-index remapped,
<span class='lineno'>  70</span>     sorted dataframe.
<span class='lineno'>  71</span>   &quot;&quot;&quot;
<span class='lineno'>  72</span>   with tf.io.gfile.GFile(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.raw_rating_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.raw_rating_path', title='str'>raw_rating_path</a>) as <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.f', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.f', title='?'>f</a>:
<span class='lineno'>  73</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a> = pd.read_csv(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.f', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.f', title='?'>f</a>)
<span class='lineno'>  74</span> 
<span class='lineno'>  75</span>   # Get the info of users who have more than 20 ratings on items
<span class='lineno'>  76</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.grouped', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.grouped', title='?'>grouped</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>.groupby(movielens.USER_COLUMN)
<span class='lineno'>  77</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.grouped', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.grouped', title='?'>grouped</a>.filter(
<span class='lineno'>  78</span>       lambda <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%80.x', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%80.x', title='?'>x: </a>len(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%80.x', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%80.x', title='?'>x</a>) &gt;= rconst.MIN_NUM_RATINGS)  # type: pd.DataFrame
<span class='lineno'>  79</span> 
<span class='lineno'>  80</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_users', title='?'>original_users</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.USER_COLUMN].unique()
<span class='lineno'>  81</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_items', title='?'>original_items</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.ITEM_COLUMN].unique()
<span class='lineno'>  82</span> 
<span class='lineno'>  83</span>   # Map the ids of user and item to 0 based index for following processing
<span class='lineno'>  84</span>   logging.info(&quot;Generating user_map and item_map...&quot;)
<span class='lineno'>  85</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user_map', title='dict'>user_map</a> = {<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user', title='?'>user</a>: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', title='?'>index</a> for <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', title='?'><a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', title='?'>index</a></a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user', title='?'><a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user', title='?'>user</a></a> in enumerate(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_users', title='?'>original_users</a>)}
<span class='lineno'>  86</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item_map', title='dict'>item_map</a> = {<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item', title='?'>item</a>: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', title='?'>index</a> for <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', title='?'><a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.index', title='?'>index</a></a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item', title='?'><a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item', title='?'>item</a></a> in enumerate(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_items', title='?'>original_items</a>)}
<span class='lineno'>  87</span> 
<span class='lineno'>  88</span>   <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.USER_COLUMN] = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.USER_COLUMN].apply(
<span class='lineno'>  89</span>       lambda <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%81.user', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%81.user', title='?'>use</a>r: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user_map', title='dict'>user_map</a>[<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%81.user', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%81.user', title='?'>user</a>])
<span class='lineno'>  90</span>   <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.ITEM_COLUMN] = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.ITEM_COLUMN].apply(
<span class='lineno'>  91</span>       lambda <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%82.item', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%82.item', title='?'>ite</a>m: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item_map', title='dict'>item_map</a>[<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%82.item', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.lambda%82.item', title='?'>item</a>])
<span class='lineno'>  92</span> 
<span class='lineno'>  93</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_users', title='int'>num_users</a> = len(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_users', title='?'>original_users</a>)
<span class='lineno'>  94</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_items', title='int'>num_items</a> = len(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.original_items', title='?'>original_items</a>)
<span class='lineno'>  95</span> 
<span class='lineno'>  96</span>   assert <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_users', title='int'>num_users</a> &lt;= np.iinfo(rconst.USER_DTYPE).max
<span class='lineno'>  97</span>   assert <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_items', title='int'>num_items</a> &lt;= np.iinfo(rconst.ITEM_DTYPE).max
<span class='lineno'>  98</span>   assert <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.USER_COLUMN].max() == <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_users', title='int'>num_users</a> - 1
<span class='lineno'>  99</span>   assert <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>[movielens.ITEM_COLUMN].max() == <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.num_items', title='int'>num_items</a> - 1
<span class='lineno'> 100</span> 
<span class='lineno'> 101</span>   # This sort is used to shard the dataframe by user, and later to select
<span class='lineno'> 102</span>   # the last item for a user to be used in validation.
<span class='lineno'> 103</span>   logging.info(&quot;Sorting by user, timestamp...&quot;)
<span class='lineno'> 104</span> 
<span class='lineno'> 105</span>   # This sort is equivalent to
<span class='lineno'> 106</span>   #   df.sort_values([movielens.USER_COLUMN, movielens.TIMESTAMP_COLUMN],
<span class='lineno'> 107</span>   #   inplace=True)
<span class='lineno'> 108</span>   # except that the order of items with the same user and timestamp are
<span class='lineno'> 109</span>   # sometimes different. For some reason, this sort results in a better
<span class='lineno'> 110</span>   # hit-rate during evaluation, matching the performance of the MLPerf
<span class='lineno'> 111</span>   # reference implementation.
<span class='lineno'> 112</span>   <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>.sort_values(by=movielens.TIMESTAMP_COLUMN, inplace=True)
<span class='lineno'> 113</span>   <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>.sort_values([movielens.USER_COLUMN, movielens.TIMESTAMP_COLUMN],
<span class='lineno'> 114</span>                  inplace=True,
<span class='lineno'> 115</span>                  kind=&quot;mergesort&quot;)
<span class='lineno'> 116</span> 
<span class='lineno'> 117</span>   # The dataframe does not reconstruct indices in the sort or filter steps.
<span class='lineno'> 118</span>   return <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.user_map', title='dict'>user_map</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.item_map', title='dict'>item_map</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe.df', title='?'>df</a>.reset_index()
<span class='lineno'> 119</span> 
<span class='lineno'> 120</span> 
<span class='lineno'> 121</span> def <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort', title='(str, str) -> (dict, ?) / (?, ?) -> (dict, ?)'>_filter_index_sort</a>(<a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.raw_rating_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.raw_rating_path', title='str'>raw</a>_rating_path: Text,
<span class='lineno'> 122</span>                        <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', title='str'>cac</a>he_path: Text) -&gt; Tuple[pd.DataFrame, bool]:
<span class='lineno'> 123</span>   &quot;&quot;&quot;Read in data CSV, and output structured data.
<span class='lineno'> 124</span> 
<span class='lineno'> 125</span>   This function reads in the raw CSV of positive items, and performs three
<span class='lineno'> 126</span>   preprocessing transformations:
<span class='lineno'> 127</span> 
<span class='lineno'> 128</span>   1)  Filter out all users who have not rated at least a certain number
<span class='lineno'> 129</span>       of items. (Typically 20 items)
<span class='lineno'> 130</span> 
<span class='lineno'> 131</span>   2)  Zero index the users and items such that the largest user_id is
<span class='lineno'> 132</span>       `num_users - 1` and the largest item_id is `num_items - 1`
<span class='lineno'> 133</span> 
<span class='lineno'> 134</span>   3)  Sort the dataframe by user_id, with timestamp as a secondary sort key.
<span class='lineno'> 135</span>       This allows the dataframe to be sliced by user in-place, and for the last
<span class='lineno'> 136</span>       item to be selected simply by calling the `-1` index of a user&#39;s slice.
<span class='lineno'> 137</span> 
<span class='lineno'> 138</span>   While all of these transformations are performed by Pandas (and are therefore
<span class='lineno'> 139</span>   single-threaded), they only take ~2 minutes, and the overhead to apply a
<span class='lineno'> 140</span>   MapReduce pattern to parallel process the dataset adds significant complexity
<span class='lineno'> 141</span>   for no computational gain. For a larger dataset parallelizing this
<span class='lineno'> 142</span>   preprocessing could yield speedups. (Also, this preprocessing step is only
<span class='lineno'> 143</span>   performed once for an entire run.
<span class='lineno'> 144</span> 
<span class='lineno'> 145</span>   Args:
<span class='lineno'> 146</span>     raw_rating_path: The path to the CSV which contains the raw dataset.
<span class='lineno'> 147</span>     cache_path: The path to the file where results of this function are saved.
<span class='lineno'> 148</span> 
<span class='lineno'> 149</span>   Returns:
<span class='lineno'> 150</span>     A filtered, zero-index remapped, sorted dataframe, a dict mapping raw user
<span class='lineno'> 151</span>     IDs to regularized user IDs, and a dict mapping raw item IDs to regularized
<span class='lineno'> 152</span>     item IDs.
<span class='lineno'> 153</span>   &quot;&quot;&quot;
<span class='lineno'> 154</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', title='?'>valid_cache</a> = tf.io.gfile.exists(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', title='str'>cache_path</a>)
<span class='lineno'> 155</span>   if <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', title='?'>valid_cache</a>:
<span class='lineno'> 156</span>     with tf.io.gfile.GFile(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', title='str'>cache_path</a>, &quot;rb&quot;) as <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', title='?'>f</a>:
<span class='lineno'> 157</span>       <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cached_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cached_data', title='?'>cached_data</a> = pickle.load(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', title='?'>f</a>)
<span class='lineno'> 158</span> 
<span class='lineno'> 159</span>     # (nnigania)disabled this check as the dataset is not expected to change
<span class='lineno'> 160</span>     # cache_age = time.time() - cached_data.get(&quot;create_time&quot;, 0)
<span class='lineno'> 161</span>     # if cache_age &gt; rconst.CACHE_INVALIDATION_SEC:
<span class='lineno'> 162</span>     #   valid_cache = False
<span class='lineno'> 163</span> 
<span class='lineno'> 164</span>     for <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.key', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.key', title='?'>key</a> in <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._EXPECTED_CACHE_KEYS', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._EXPECTED_CACHE_KEYS', title='(?, ?, ?, ?, ?, ?)'>_EXPECTED_CACHE_KEYS</a>:
<span class='lineno'> 165</span>       if <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.key', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.key', title='?'>key</a> not in <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cached_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cached_data', title='?'>cached_data</a>:
<span class='lineno'> 166</span>         <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', title='?'>valid_cache</a> = False
<span class='lineno'> 167</span> 
<span class='lineno'> 168</span>     if not <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', title='?'>valid_cache</a>:
<span class='lineno'> 169</span>       logging.info(&quot;Removing stale raw data cache file.&quot;)
<span class='lineno'> 170</span>       tf.io.gfile.remove(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', title='str'>cache_path</a>)
<span class='lineno'> 171</span> 
<span class='lineno'> 172</span>   if <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', title='?'>valid_cache</a>:
<span class='lineno'> 173</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', title='?'>data</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cached_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cached_data', title='?'>cached_data</a>
<span class='lineno'> 174</span>   else:
<span class='lineno'> 175</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.user_map', title='dict'>user_map</a>, <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.item_map', title='dict'>item_map</a>, <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.df', title='?'>df</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.read_dataframe', title='str -> (dict, dict, ?) / ? -> (dict, dict, ?)'>read_dataframe</a>(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.raw_rating_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.raw_rating_path', title='str'>raw_rating_path</a>)
<span class='lineno'> 176</span> 
<span class='lineno'> 177</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.grouped', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.grouped', title='?'>grouped</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.df', title='?'>df</a>.groupby(movielens.USER_COLUMN, group_keys=False)
<span class='lineno'> 178</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.eval_df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.eval_df', title='?'>eval_df</a>, <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.train_df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.train_df', title='?'>train_df</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.grouped', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.grouped', title='?'>grouped</a>.tail(1), <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.grouped', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.grouped', title='?'>grouped</a>.apply(lambda <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.lambda%83.x', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.lambda%83.x', title='?'>x: </a><a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.lambda%83.x', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.lambda%83.x', title='?'>x</a>.iloc[:-1])
<span class='lineno'> 179</span> 
<span class='lineno'> 180</span>     <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', title='dict'>data</a> = {
<span class='lineno'> 181</span>         rconst.TRAIN_USER_KEY: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.train_df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.train_df', title='?'>train_df</a>[movielens.USER_COLUMN]
<span class='lineno'> 182</span>                                .values.astype(rconst.USER_DTYPE),
<span class='lineno'> 183</span>         rconst.TRAIN_ITEM_KEY: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.train_df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.train_df', title='?'>train_df</a>[movielens.ITEM_COLUMN]
<span class='lineno'> 184</span>                                .values.astype(rconst.ITEM_DTYPE),
<span class='lineno'> 185</span>         rconst.EVAL_USER_KEY: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.eval_df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.eval_df', title='?'>eval_df</a>[movielens.USER_COLUMN]
<span class='lineno'> 186</span>                               .values.astype(rconst.USER_DTYPE),
<span class='lineno'> 187</span>         rconst.EVAL_ITEM_KEY: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.eval_df', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.eval_df', title='?'>eval_df</a>[movielens.ITEM_COLUMN]
<span class='lineno'> 188</span>                               .values.astype(rconst.ITEM_DTYPE),
<span class='lineno'> 189</span>         rconst.USER_MAP: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.user_map', title='dict'>user_map</a>,
<span class='lineno'> 190</span>         rconst.ITEM_MAP: <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.item_map', title='dict'>item_map</a>,
<span class='lineno'> 191</span>         &quot;create_time&quot;: time.time(),
<span class='lineno'> 192</span>     }
<span class='lineno'> 193</span> 
<span class='lineno'> 194</span>     logging.info(&quot;Writing raw data cache.&quot;)
<span class='lineno'> 195</span>     with tf.io.gfile.GFile(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.cache_path', title='str'>cache_path</a>, &quot;wb&quot;) as <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', title='?'>f</a>:
<span class='lineno'> 196</span>       pickle.dump(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', title='dict'>data</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.f', title='?'>f</a>, protocol=pickle.HIGHEST_PROTOCOL)
<span class='lineno'> 197</span> 
<span class='lineno'> 198</span>   # TODO(robieta): MLPerf cache clear.
<span class='lineno'> 199</span>   return <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.data', title='dict'>data</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort.valid_cache', title='?'>valid_cache</a>
<span class='lineno'> 200</span> 
<span class='lineno'> 201</span> 
<span class='lineno'> 202</span> def <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline', title='(?, ?, ?, None, ?, None, ?) -> (?, ?, ?)'>instantiate_pipeline</a>(<a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', title='?'>dat</a>aset,
<span class='lineno'> 203</span>                          <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.data_dir', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.data_dir', title='?'>dat</a>a_dir,
<span class='lineno'> 204</span>                          <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>par</a>ams,
<span class='lineno'> 205</span>                          <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.constructor_type', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.constructor_type', title='None'>con</a>structor_type=None,
<span class='lineno'> 206</span>                          <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.deterministic', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.deterministic', title='?'>det</a>erministic=False,
<span class='lineno'> 207</span>                          <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.epoch_dir', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.epoch_dir', title='None'>epo</a>ch_dir=None,
<span class='lineno'> 208</span>                          <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.generate_data_offline', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.generate_data_offline', title='?'>gen</a>erate_data_offline=False):
<span class='lineno'> 209</span>   # type: (str, str, dict, typing.Optional[str], bool, typing.Optional[str], bool) -&gt; (int, int, data_pipeline.BaseDataConstructor)
<span class='lineno'> 210</span>   &quot;&quot;&quot;Load and digest data CSV into a usable form.
<span class='lineno'> 211</span> 
<span class='lineno'> 212</span>   Args:
<span class='lineno'> 213</span>     dataset: The name of the dataset to be used.
<span class='lineno'> 214</span>     data_dir: The root directory of the dataset.
<span class='lineno'> 215</span>     params: dict of parameters for the run.
<span class='lineno'> 216</span>     constructor_type: The name of the constructor subclass that should be used
<span class='lineno'> 217</span>       for the input pipeline.
<span class='lineno'> 218</span>     deterministic: Tell the data constructor to produce deterministically.
<span class='lineno'> 219</span>     epoch_dir: Directory in which to store the training epochs.
<span class='lineno'> 220</span>     generate_data_offline: Boolean, whether current pipeline is done offline
<span class='lineno'> 221</span>       or while training.
<span class='lineno'> 222</span>   &quot;&quot;&quot;
<span class='lineno'> 223</span>   logging.info(&quot;Beginning data preprocessing.&quot;)
<span class='lineno'> 224</span> 
<span class='lineno'> 225</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.st', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.st', title='?'>st</a> = timeit.default_timer()
<span class='lineno'> 226</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_rating_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_rating_path', title='str'>raw_rating_path</a> = os.path.join(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.data_dir', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.data_dir', title='?'>data_dir</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', title='?'>dataset</a>, movielens.RATINGS_FILE)
<span class='lineno'> 227</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.cache_path', title='str'>cache_path</a> = os.path.join(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.data_dir', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.data_dir', title='?'>data_dir</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', title='?'>dataset</a>, rconst.RAW_CACHE_FILE)
<span class='lineno'> 228</span> 
<span class='lineno'> 229</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>, <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline._', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline._', title='?'>_</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing._filter_index_sort', title='(str, str) -> (dict, ?) / (?, ?) -> (dict, ?)'>_filter_index_sort</a>(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_rating_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_rating_path', title='str'>raw_rating_path</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.cache_path', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.cache_path', title='str'>cache_path</a>)
<span class='lineno'> 230</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.user_map', title='{dict | int}'>user_map</a>, <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.item_map', title='{dict | int}'>item_map</a> = <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>[&quot;user_map&quot;], <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>[&quot;item_map&quot;]
<span class='lineno'> 231</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', title='?'>num_users</a>, <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', title='?'>num_items</a> = movielens.DATASET_TO_NUM_USERS_AND_ITEMS[<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.dataset', title='?'>dataset</a>]
<span class='lineno'> 232</span> 
<span class='lineno'> 233</span>   if <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', title='?'>num_users</a> != len(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.user_map', title='{dict | int}'>user_map</a>):
<span class='lineno'> 234</span>     raise ValueError(&quot;Expected to find {} users, but found {}&quot;.format(
<span class='lineno'> 235</span>         num_users, len(user_map)))
<span class='lineno'> 236</span>   if <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', title='?'>num_items</a> != len(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.item_map', title='{dict | int}'>item_map</a>):
<span class='lineno'> 237</span>     raise ValueError(&quot;Expected to find {} items, but found {}&quot;.format(
<span class='lineno'> 238</span>         num_items, len(item_map)))
<span class='lineno'> 239</span> 
<span class='lineno'> 240</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.producer', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.producer', title='?'>producer</a> = data_pipeline.get_constructor(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.constructor_type', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.constructor_type', title='None'>constructor_type</a> or &quot;materialized&quot;)(
<span class='lineno'> 241</span>       maximum_number_epochs=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;train_epochs&quot;],
<span class='lineno'> 242</span>       num_users=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', title='?'>num_users</a>,
<span class='lineno'> 243</span>       num_items=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', title='?'>num_items</a>,
<span class='lineno'> 244</span>       user_map=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.user_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.user_map', title='{dict | int}'>user_map</a>,
<span class='lineno'> 245</span>       item_map=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.item_map', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.item_map', title='{dict | int}'>item_map</a>,
<span class='lineno'> 246</span>       train_pos_users=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>[rconst.TRAIN_USER_KEY],
<span class='lineno'> 247</span>       train_pos_items=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>[rconst.TRAIN_ITEM_KEY],
<span class='lineno'> 248</span>       train_batch_size=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;batch_size&quot;],
<span class='lineno'> 249</span>       batches_per_train_step=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;batches_per_step&quot;],
<span class='lineno'> 250</span>       num_train_negatives=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;num_neg&quot;],
<span class='lineno'> 251</span>       eval_pos_users=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>[rconst.EVAL_USER_KEY],
<span class='lineno'> 252</span>       eval_pos_items=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.raw_data', title='dict'>raw_data</a>[rconst.EVAL_ITEM_KEY],
<span class='lineno'> 253</span>       eval_batch_size=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;eval_batch_size&quot;],
<span class='lineno'> 254</span>       batches_per_eval_step=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;batches_per_step&quot;],
<span class='lineno'> 255</span>       stream_files=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.params', title='?'>params</a>[&quot;stream_files&quot;],
<span class='lineno'> 256</span>       deterministic=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.deterministic', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.deterministic', title='?'>deterministic</a>,
<span class='lineno'> 257</span>       epoch_dir=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.epoch_dir', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.epoch_dir', title='None'>epoch_dir</a>,
<span class='lineno'> 258</span>       create_data_offline=<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.generate_data_offline', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.generate_data_offline', title='?'>generate_data_offline</a>)
<span class='lineno'> 259</span> 
<span class='lineno'> 260</span>   <a name='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.run_time', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.run_time', title='?'>run_time</a> = timeit.default_timer() - <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.st', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.st', title='?'>st</a>
<span class='lineno'> 261</span>   logging.info(&quot;Data preprocessing complete. Time: {:.1f} sec.&quot;
<span class='lineno'> 262</span>                .format(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.run_time', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.run_time', title='?'>run_time</a>))
<span class='lineno'> 263</span> 
<span class='lineno'> 264</span>   print(<a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.producer', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.producer', title='?'>producer</a>)
<span class='lineno'> 265</span>   return <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_users', title='?'>num_users</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.num_items', title='?'>num_items</a>, <a href='#.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.producer', xid ='.home.xxm.Desktop.EMSE.dataset.models.official.recommendation.data_preprocessing.instantiate_pipeline.producer', title='?'>producer</a>
</pre></td></tr></table></body></html>